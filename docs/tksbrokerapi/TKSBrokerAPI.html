<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 12.0.2"/>
    <title>tksbrokerapi.TKSBrokerAPI API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--code);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../tksbrokerapi.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;tksbrokerapi</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



        <h2>API Documentation</h2>
            <ul class="memberlist">
            <li>
                    <a class="function" href="#NanoToFloat">NanoToFloat</a>
            </li>
            <li>
                    <a class="function" href="#FloatToNano">FloatToNano</a>
            </li>
            <li>
                    <a class="function" href="#GetDatesAsString">GetDatesAsString</a>
            </li>
            <li>
                    <a class="class" href="#TinkoffBrokerServer">TinkoffBrokerServer</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#TinkoffBrokerServer.__init__">TinkoffBrokerServer</a>
                        </li>
                        <li>
                                <a class="variable" href="#TinkoffBrokerServer.aliases">aliases</a>
                        </li>
                        <li>
                                <a class="variable" href="#TinkoffBrokerServer.ticker">ticker</a>
                        </li>
                        <li>
                                <a class="variable" href="#TinkoffBrokerServer.figi">figi</a>
                        </li>
                        <li>
                                <a class="variable" href="#TinkoffBrokerServer.depth">depth</a>
                        </li>
                        <li>
                                <a class="variable" href="#TinkoffBrokerServer.server">server</a>
                        </li>
                        <li>
                                <a class="variable" href="#TinkoffBrokerServer.timeout">timeout</a>
                        </li>
                        <li>
                                <a class="variable" href="#TinkoffBrokerServer.headers">headers</a>
                        </li>
                        <li>
                                <a class="variable" href="#TinkoffBrokerServer.body">body</a>
                        </li>
                        <li>
                                <a class="variable" href="#TinkoffBrokerServer.historyLength">historyLength</a>
                        </li>
                        <li>
                                <a class="variable" href="#TinkoffBrokerServer.historyInterval">historyInterval</a>
                        </li>
                        <li>
                                <a class="variable" href="#TinkoffBrokerServer.iList">iList</a>
                        </li>
                        <li>
                                <a class="variable" href="#TinkoffBrokerServer.instrumentsFile">instrumentsFile</a>
                        </li>
                        <li>
                                <a class="variable" href="#TinkoffBrokerServer.pricesFile">pricesFile</a>
                        </li>
                        <li>
                                <a class="variable" href="#TinkoffBrokerServer.overviewFile">overviewFile</a>
                        </li>
                        <li>
                                <a class="variable" href="#TinkoffBrokerServer.reportFile">reportFile</a>
                        </li>
                        <li>
                                <a class="variable" href="#TinkoffBrokerServer.historyFile">historyFile</a>
                        </li>
                        <li>
                                <a class="function" href="#TinkoffBrokerServer.SendAPIRequest">SendAPIRequest</a>
                        </li>
                        <li>
                                <a class="function" href="#TinkoffBrokerServer.Listing">Listing</a>
                        </li>
                        <li>
                                <a class="function" href="#TinkoffBrokerServer.ShowInstrumentInfo">ShowInstrumentInfo</a>
                        </li>
                        <li>
                                <a class="function" href="#TinkoffBrokerServer.SearchByTicker">SearchByTicker</a>
                        </li>
                        <li>
                                <a class="function" href="#TinkoffBrokerServer.SearchByFIGI">SearchByFIGI</a>
                        </li>
                        <li>
                                <a class="function" href="#TinkoffBrokerServer.GetCurrentPrices">GetCurrentPrices</a>
                        </li>
                        <li>
                                <a class="function" href="#TinkoffBrokerServer.ShowInstrumentsInfo">ShowInstrumentsInfo</a>
                        </li>
                        <li>
                                <a class="function" href="#TinkoffBrokerServer.GetListOfPrices">GetListOfPrices</a>
                        </li>
                        <li>
                                <a class="function" href="#TinkoffBrokerServer.RequestPortfolio">RequestPortfolio</a>
                        </li>
                        <li>
                                <a class="function" href="#TinkoffBrokerServer.RequestPositions">RequestPositions</a>
                        </li>
                        <li>
                                <a class="function" href="#TinkoffBrokerServer.RequestPendingOrders">RequestPendingOrders</a>
                        </li>
                        <li>
                                <a class="function" href="#TinkoffBrokerServer.RequestStopOrders">RequestStopOrders</a>
                        </li>
                        <li>
                                <a class="function" href="#TinkoffBrokerServer.Overview">Overview</a>
                        </li>
                        <li>
                                <a class="function" href="#TinkoffBrokerServer.Deals">Deals</a>
                        </li>
                        <li>
                                <a class="function" href="#TinkoffBrokerServer.History">History</a>
                        </li>
                        <li>
                                <a class="function" href="#TinkoffBrokerServer.Trade">Trade</a>
                        </li>
                        <li>
                                <a class="function" href="#TinkoffBrokerServer.Buy">Buy</a>
                        </li>
                        <li>
                                <a class="function" href="#TinkoffBrokerServer.Sell">Sell</a>
                        </li>
                        <li>
                                <a class="function" href="#TinkoffBrokerServer.CloseTrades">CloseTrades</a>
                        </li>
                        <li>
                                <a class="function" href="#TinkoffBrokerServer.CloseAllTrades">CloseAllTrades</a>
                        </li>
                        <li>
                                <a class="function" href="#TinkoffBrokerServer.Order">Order</a>
                        </li>
                        <li>
                                <a class="function" href="#TinkoffBrokerServer.BuyLimit">BuyLimit</a>
                        </li>
                        <li>
                                <a class="function" href="#TinkoffBrokerServer.BuyStop">BuyStop</a>
                        </li>
                        <li>
                                <a class="function" href="#TinkoffBrokerServer.SellLimit">SellLimit</a>
                        </li>
                        <li>
                                <a class="function" href="#TinkoffBrokerServer.SellStop">SellStop</a>
                        </li>
                        <li>
                                <a class="function" href="#TinkoffBrokerServer.CloseOrders">CloseOrders</a>
                        </li>
                        <li>
                                <a class="function" href="#TinkoffBrokerServer.CloseAllOrders">CloseAllOrders</a>
                        </li>
                        <li>
                                <a class="function" href="#TinkoffBrokerServer.CloseAll">CloseAll</a>
                        </li>
                        <li>
                                <a class="function" href="#TinkoffBrokerServer.ParseOrderParameters">ParseOrderParameters</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Args">Args</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Args.__init__">Args</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#ParseArgs">ParseArgs</a>
            </li>
            <li>
                    <a class="function" href="#Main">Main</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../tksbrokerapi.html">tksbrokerapi</a><wbr>.TKSBrokerAPI    </h1>

                        <div class="docstring"><p><strong>TKSBrokerAPI</strong> is a python API to work with some methods of Tinkoff Open API using REST protocol.
It can view history, orders and market information. Also, you can open orders and trades.</p>

<p>If you run this module as CLI program then it realizes simple logic: receiving a lot of options and execute one command.
<strong>See examples</strong>: <a href="https://tim55667757.github.io/TKSBrokerAPI/#Usage-examples">https://tim55667757.github.io/TKSBrokerAPI/#Usage-examples</a></p>

<p><strong>Used constants are in the TKSEnums module</strong>: <a href="https://tim55667757.github.io/TKSBrokerAPI/docs/tksbrokerapi/TKSEnums.html">https://tim55667757.github.io/TKSBrokerAPI/docs/tksbrokerapi/TKSEnums.html</a></p>

<p>About Tinkoff Invest API: <a href="https://tinkoff.github.io/investAPI/">https://tinkoff.github.io/investAPI/</a></p>

<p>Tinkoff Invest API documentation: <a href="https://tinkoff.github.io/investAPI/swagger-ui/">https://tinkoff.github.io/investAPI/swagger-ui/</a></p>
</div>

                        <input id="TKSBrokerAPI-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="TKSBrokerAPI-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#-1"><span class="linenos">   1</span></a><span class="c1"># -*- coding: utf-8 -*-</span>
</span><span id="L-2"><a href="#-2"><span class="linenos">   2</span></a><span class="c1"># Author: Timur Gilmullin</span>
</span><span id="L-3"><a href="#-3"><span class="linenos">   3</span></a>
</span><span id="L-4"><a href="#-4"><span class="linenos">   4</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-5"><a href="#-5"><span class="linenos">   5</span></a><span class="sd">**TKSBrokerAPI** is a python API to work with some methods of Tinkoff Open API using REST protocol.</span>
</span><span id="L-6"><a href="#-6"><span class="linenos">   6</span></a><span class="sd">It can view history, orders and market information. Also, you can open orders and trades.</span>
</span><span id="L-7"><a href="#-7"><span class="linenos">   7</span></a>
</span><span id="L-8"><a href="#-8"><span class="linenos">   8</span></a><span class="sd">If you run this module as CLI program then it realizes simple logic: receiving a lot of options and execute one command.</span>
</span><span id="L-9"><a href="#-9"><span class="linenos">   9</span></a><span class="sd">**See examples**: https://tim55667757.github.io/TKSBrokerAPI/#Usage-examples</span>
</span><span id="L-10"><a href="#-10"><span class="linenos">  10</span></a>
</span><span id="L-11"><a href="#-11"><span class="linenos">  11</span></a><span class="sd">**Used constants are in the TKSEnums module**: https://tim55667757.github.io/TKSBrokerAPI/docs/tksbrokerapi/TKSEnums.html</span>
</span><span id="L-12"><a href="#-12"><span class="linenos">  12</span></a>
</span><span id="L-13"><a href="#-13"><span class="linenos">  13</span></a><span class="sd">About Tinkoff Invest API: https://tinkoff.github.io/investAPI/</span>
</span><span id="L-14"><a href="#-14"><span class="linenos">  14</span></a>
</span><span id="L-15"><a href="#-15"><span class="linenos">  15</span></a><span class="sd">Tinkoff Invest API documentation: https://tinkoff.github.io/investAPI/swagger-ui/</span>
</span><span id="L-16"><a href="#-16"><span class="linenos">  16</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-17"><a href="#-17"><span class="linenos">  17</span></a>
</span><span id="L-18"><a href="#-18"><span class="linenos">  18</span></a><span class="c1"># Copyright (c) 2022 Gilmillin Timur Mansurovich</span>
</span><span id="L-19"><a href="#-19"><span class="linenos">  19</span></a><span class="c1">#</span>
</span><span id="L-20"><a href="#-20"><span class="linenos">  20</span></a><span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
</span><span id="L-21"><a href="#-21"><span class="linenos">  21</span></a><span class="c1"># you may not use this file except in compliance with the License.</span>
</span><span id="L-22"><a href="#-22"><span class="linenos">  22</span></a><span class="c1"># You may obtain a copy of the License at</span>
</span><span id="L-23"><a href="#-23"><span class="linenos">  23</span></a><span class="c1">#</span>
</span><span id="L-24"><a href="#-24"><span class="linenos">  24</span></a><span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
</span><span id="L-25"><a href="#-25"><span class="linenos">  25</span></a><span class="c1">#</span>
</span><span id="L-26"><a href="#-26"><span class="linenos">  26</span></a><span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
</span><span id="L-27"><a href="#-27"><span class="linenos">  27</span></a><span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
</span><span id="L-28"><a href="#-28"><span class="linenos">  28</span></a><span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
</span><span id="L-29"><a href="#-29"><span class="linenos">  29</span></a><span class="c1"># See the License for the specific language governing permissions and</span>
</span><span id="L-30"><a href="#-30"><span class="linenos">  30</span></a><span class="c1"># limitations under the License.</span>
</span><span id="L-31"><a href="#-31"><span class="linenos">  31</span></a>
</span><span id="L-32"><a href="#-32"><span class="linenos">  32</span></a>
</span><span id="L-33"><a href="#-33"><span class="linenos">  33</span></a><span class="kn">import</span> <span class="nn">sys</span>
</span><span id="L-34"><a href="#-34"><span class="linenos">  34</span></a><span class="kn">import</span> <span class="nn">os</span>
</span><span id="L-35"><a href="#-35"><span class="linenos">  35</span></a><span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">ArgumentParser</span>
</span><span id="L-36"><a href="#-36"><span class="linenos">  36</span></a>
</span><span id="L-37"><a href="#-37"><span class="linenos">  37</span></a><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
</span><span id="L-38"><a href="#-38"><span class="linenos">  38</span></a><span class="kn">from</span> <span class="nn">dateutil.tz</span> <span class="kn">import</span> <span class="n">tzlocal</span><span class="p">,</span> <span class="n">tzutc</span>
</span><span id="L-39"><a href="#-39"><span class="linenos">  39</span></a><span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
</span><span id="L-40"><a href="#-40"><span class="linenos">  40</span></a>
</span><span id="L-41"><a href="#-41"><span class="linenos">  41</span></a><span class="kn">import</span> <span class="nn">json</span>
</span><span id="L-42"><a href="#-42"><span class="linenos">  42</span></a><span class="kn">import</span> <span class="nn">requests</span>
</span><span id="L-43"><a href="#-43"><span class="linenos">  43</span></a><span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">quote</span>
</span><span id="L-44"><a href="#-44"><span class="linenos">  44</span></a><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">cpu_count</span>
</span><span id="L-45"><a href="#-45"><span class="linenos">  45</span></a><span class="kn">from</span> <span class="nn">multiprocessing.pool</span> <span class="kn">import</span> <span class="n">ThreadPool</span>
</span><span id="L-46"><a href="#-46"><span class="linenos">  46</span></a>
</span><span id="L-47"><a href="#-47"><span class="linenos">  47</span></a><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span><span id="L-48"><a href="#-48"><span class="linenos">  48</span></a>
</span><span id="L-49"><a href="#-49"><span class="linenos">  49</span></a><span class="kn">import</span> <span class="nn">UniLogger</span> <span class="k">as</span> <span class="nn">uLog</span>
</span><span id="L-50"><a href="#-50"><span class="linenos">  50</span></a><span class="kn">import</span> <span class="nn">traceback</span> <span class="k">as</span> <span class="nn">tb</span>
</span><span id="L-51"><a href="#-51"><span class="linenos">  51</span></a>
</span><span id="L-52"><a href="#-52"><span class="linenos">  52</span></a><span class="kn">from</span> <span class="nn">TKSEnums</span> <span class="kn">import</span> <span class="o">*</span>  <span class="c1"># a lot of constants from enums sections: https://tinkoff.github.io/investAPI/swagger-ui/</span>
</span><span id="L-53"><a href="#-53"><span class="linenos">  53</span></a>
</span><span id="L-54"><a href="#-54"><span class="linenos">  54</span></a>
</span><span id="L-55"><a href="#-55"><span class="linenos">  55</span></a><span class="c1"># --- Common technical parameters:</span>
</span><span id="L-56"><a href="#-56"><span class="linenos">  56</span></a>
</span><span id="L-57"><a href="#-57"><span class="linenos">  57</span></a><span class="n">uLogger</span> <span class="o">=</span> <span class="n">uLog</span><span class="o">.</span><span class="n">UniLogger</span>
</span><span id="L-58"><a href="#-58"><span class="linenos">  58</span></a><span class="n">uLogger</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># debug level by default</span>
</span><span id="L-59"><a href="#-59"><span class="linenos">  59</span></a><span class="n">uLogger</span><span class="o">.</span><span class="n">handlers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="mi">20</span>  <span class="c1"># info level by default for STDOUT</span>
</span><span id="L-60"><a href="#-60"><span class="linenos">  60</span></a>
</span><span id="L-61"><a href="#-61"><span class="linenos">  61</span></a><span class="n">CPU_COUNT</span> <span class="o">=</span> <span class="n">cpu_count</span><span class="p">()</span>  <span class="c1"># host&#39;s real CPU count</span>
</span><span id="L-62"><a href="#-62"><span class="linenos">  62</span></a><span class="n">CPU_USAGES</span> <span class="o">=</span> <span class="n">CPU_COUNT</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">CPU_COUNT</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">1</span>  <span class="c1"># how many CPUs will be used for parallel calculations</span>
</span><span id="L-63"><a href="#-63"><span class="linenos">  63</span></a><span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Host CPU count: [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">CPU_COUNT</span><span class="p">))</span>
</span><span id="L-64"><a href="#-64"><span class="linenos">  64</span></a>
</span><span id="L-65"><a href="#-65"><span class="linenos">  65</span></a><span class="c1"># --- Main constants:</span>
</span><span id="L-66"><a href="#-66"><span class="linenos">  66</span></a>
</span><span id="L-67"><a href="#-67"><span class="linenos">  67</span></a><span class="n">NANO</span> <span class="o">=</span> <span class="mf">0.000000001</span>  <span class="c1"># SI-constant nano = 10^-9</span>
</span><span id="L-68"><a href="#-68"><span class="linenos">  68</span></a>
</span><span id="L-69"><a href="#-69"><span class="linenos">  69</span></a>
</span><span id="L-70"><a href="#-70"><span class="linenos">  70</span></a><span class="k">def</span> <span class="nf">NanoToFloat</span><span class="p">(</span><span class="n">units</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">nano</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-71"><a href="#-71"><span class="linenos">  71</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-72"><a href="#-72"><span class="linenos">  72</span></a><span class="sd">    Convert number in nano-view mode with string parameter `units` and integer parameter `nano` to float view. Examples:</span>
</span><span id="L-73"><a href="#-73"><span class="linenos">  73</span></a>
</span><span id="L-74"><a href="#-74"><span class="linenos">  74</span></a><span class="sd">    `NanoToFloat(units=&quot;2&quot;, nano=500000000) -&gt; 2.5`</span>
</span><span id="L-75"><a href="#-75"><span class="linenos">  75</span></a>
</span><span id="L-76"><a href="#-76"><span class="linenos">  76</span></a><span class="sd">    `NanoToFloat(units=&quot;0&quot;, nano=50000000) -&gt; 0.05`</span>
</span><span id="L-77"><a href="#-77"><span class="linenos">  77</span></a>
</span><span id="L-78"><a href="#-78"><span class="linenos">  78</span></a><span class="sd">    :param units: integer string or integer parameter that represents the integer part of number</span>
</span><span id="L-79"><a href="#-79"><span class="linenos">  79</span></a><span class="sd">    :param nano: integer string or integer parameter that represents the fractional part of number</span>
</span><span id="L-80"><a href="#-80"><span class="linenos">  80</span></a><span class="sd">    :return: float view of number</span>
</span><span id="L-81"><a href="#-81"><span class="linenos">  81</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-82"><a href="#-82"><span class="linenos">  82</span></a>    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">units</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">nano</span><span class="p">)</span> <span class="o">*</span> <span class="n">NANO</span>
</span><span id="L-83"><a href="#-83"><span class="linenos">  83</span></a>
</span><span id="L-84"><a href="#-84"><span class="linenos">  84</span></a>
</span><span id="L-85"><a href="#-85"><span class="linenos">  85</span></a><span class="k">def</span> <span class="nf">FloatToNano</span><span class="p">(</span><span class="n">number</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="L-86"><a href="#-86"><span class="linenos">  86</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-87"><a href="#-87"><span class="linenos">  87</span></a><span class="sd">    Convert float number to nano-type view: dictionary with string `units` and integer `nano` parameters `{&quot;units&quot;: &quot;string&quot;, &quot;nano&quot;: integer}`. Examples:</span>
</span><span id="L-88"><a href="#-88"><span class="linenos">  88</span></a>
</span><span id="L-89"><a href="#-89"><span class="linenos">  89</span></a><span class="sd">    `FloatToNano(number=2.5) -&gt; {&quot;units&quot;: &quot;2&quot;, &quot;nano&quot;: 500000000}`</span>
</span><span id="L-90"><a href="#-90"><span class="linenos">  90</span></a>
</span><span id="L-91"><a href="#-91"><span class="linenos">  91</span></a><span class="sd">    `FloatToNano(number=0.05) -&gt; {&quot;units&quot;: &quot;0&quot;, &quot;nano&quot;: 50000000}`</span>
</span><span id="L-92"><a href="#-92"><span class="linenos">  92</span></a>
</span><span id="L-93"><a href="#-93"><span class="linenos">  93</span></a><span class="sd">    :param number: float number</span>
</span><span id="L-94"><a href="#-94"><span class="linenos">  94</span></a><span class="sd">    :return: nano-type view of number: `{&quot;units&quot;: &quot;string&quot;, &quot;nano&quot;: integer}`</span>
</span><span id="L-95"><a href="#-95"><span class="linenos">  95</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-96"><a href="#-96"><span class="linenos">  96</span></a>    <span class="n">splitByPoint</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">number</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
</span><span id="L-97"><a href="#-97"><span class="linenos">  97</span></a>    <span class="n">frac</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-98"><a href="#-98"><span class="linenos">  98</span></a>
</span><span id="L-99"><a href="#-99"><span class="linenos">  99</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">splitByPoint</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-100"><a href="#-100"><span class="linenos"> 100</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">splitByPoint</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mi">9</span><span class="p">:</span>
</span><span id="L-101"><a href="#-101"><span class="linenos"> 101</span></a>            <span class="n">frac</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-102"><a href="#-102"><span class="linenos"> 102</span></a>                <span class="nb">int</span><span class="p">(</span><span class="n">splitByPoint</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="L-103"><a href="#-103"><span class="linenos"> 103</span></a>                <span class="s2">&quot;0&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">9</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">splitByPoint</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span>
</span><span id="L-104"><a href="#-104"><span class="linenos"> 104</span></a>            <span class="p">))</span>
</span><span id="L-105"><a href="#-105"><span class="linenos"> 105</span></a>
</span><span id="L-106"><a href="#-106"><span class="linenos"> 106</span></a>    <span class="k">if</span> <span class="p">(</span><span class="n">number</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">frac</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="L-107"><a href="#-107"><span class="linenos"> 107</span></a>        <span class="n">frac</span> <span class="o">=</span> <span class="o">-</span><span class="n">frac</span>
</span><span id="L-108"><a href="#-108"><span class="linenos"> 108</span></a>
</span><span id="L-109"><a href="#-109"><span class="linenos"> 109</span></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">number</span><span class="p">)),</span> <span class="s2">&quot;nano&quot;</span><span class="p">:</span> <span class="n">frac</span><span class="p">}</span>
</span><span id="L-110"><a href="#-110"><span class="linenos"> 110</span></a>
</span><span id="L-111"><a href="#-111"><span class="linenos"> 111</span></a>
</span><span id="L-112"><a href="#-112"><span class="linenos"> 112</span></a><span class="k">def</span> <span class="nf">GetDatesAsString</span><span class="p">(</span><span class="n">start</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
</span><span id="L-113"><a href="#-113"><span class="linenos"> 113</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-114"><a href="#-114"><span class="linenos"> 114</span></a><span class="sd">    If `start=None`, `end=None` then return dates from yesterday to current time.</span>
</span><span id="L-115"><a href="#-115"><span class="linenos"> 115</span></a><span class="sd">    If `start=some_date_1`, `end=None` then return dates from `some_date_1` to current time.</span>
</span><span id="L-116"><a href="#-116"><span class="linenos"> 116</span></a><span class="sd">    If `start=some_date_1`, `end=some_date_2` then return dates from `some_date_1` to `some_date_2`.</span>
</span><span id="L-117"><a href="#-117"><span class="linenos"> 117</span></a><span class="sd">    Start day may be negative integer numbers: `-1`, `-2`, `-3` - how many days ago.</span>
</span><span id="L-118"><a href="#-118"><span class="linenos"> 118</span></a>
</span><span id="L-119"><a href="#-119"><span class="linenos"> 119</span></a><span class="sd">    Also, you can use keywords for start if `dateEnd=None`:</span>
</span><span id="L-120"><a href="#-120"><span class="linenos"> 120</span></a><span class="sd">    `today` (from 00:00:00 to current time),</span>
</span><span id="L-121"><a href="#-121"><span class="linenos"> 121</span></a><span class="sd">    `yesterday` (-1 day from 00:00:00 to 23:59:59),</span>
</span><span id="L-122"><a href="#-122"><span class="linenos"> 122</span></a><span class="sd">    `week` (-7 day from 00:00:00 to current date and time),</span>
</span><span id="L-123"><a href="#-123"><span class="linenos"> 123</span></a><span class="sd">    `month` (-30 day from 00:00:00 to current date and time),</span>
</span><span id="L-124"><a href="#-124"><span class="linenos"> 124</span></a><span class="sd">    `year` (-365 day from 00:00:00 to current date and time),</span>
</span><span id="L-125"><a href="#-125"><span class="linenos"> 125</span></a>
</span><span id="L-126"><a href="#-126"><span class="linenos"> 126</span></a><span class="sd">    User dates format must be like: `%Y-%m-%d`, e.g. `2020-02-03` (3 Feb, 2020).</span>
</span><span id="L-127"><a href="#-127"><span class="linenos"> 127</span></a>
</span><span id="L-128"><a href="#-128"><span class="linenos"> 128</span></a><span class="sd">    :return: tuple with 2 strings `(start, end)` dates in UTC ISO time format `%Y-%m-%dT%H:%M:%SZ` for OpenAPI.</span>
</span><span id="L-129"><a href="#-129"><span class="linenos"> 129</span></a><span class="sd">             Example: `(&quot;2022-06-01T00:00:00Z&quot;, &quot;2022-06-20T23:59:59Z&quot;)`</span>
</span><span id="L-130"><a href="#-130"><span class="linenos"> 130</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-131"><a href="#-131"><span class="linenos"> 131</span></a>    <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Input start day is [</span><span class="si">{}</span><span class="s2">] (UTC), end day is [</span><span class="si">{}</span><span class="s2">] (UTC)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>
</span><span id="L-132"><a href="#-132"><span class="linenos"> 132</span></a>    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tzutc</span><span class="p">())</span>
</span><span id="L-133"><a href="#-133"><span class="linenos"> 133</span></a>
</span><span id="L-134"><a href="#-134"><span class="linenos"> 134</span></a>    <span class="c1"># showing statistics between start of the current day and current time:</span>
</span><span id="L-135"><a href="#-135"><span class="linenos"> 135</span></a>    <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">start</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;today&quot;</span><span class="p">:</span>
</span><span id="L-136"><a href="#-136"><span class="linenos"> 136</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-137"><a href="#-137"><span class="linenos"> 137</span></a>        <span class="n">e</span> <span class="o">=</span> <span class="n">now</span>
</span><span id="L-138"><a href="#-138"><span class="linenos"> 138</span></a>
</span><span id="L-139"><a href="#-139"><span class="linenos"> 139</span></a>    <span class="c1"># from start of the last day to the end of the last day:</span>
</span><span id="L-140"><a href="#-140"><span class="linenos"> 140</span></a>    <span class="k">elif</span> <span class="n">start</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;yesterday&quot;</span><span class="p">:</span>
</span><span id="L-141"><a href="#-141"><span class="linenos"> 141</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-142"><a href="#-142"><span class="linenos"> 142</span></a>        <span class="n">e</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">23</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">59</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">59</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-143"><a href="#-143"><span class="linenos"> 143</span></a>
</span><span id="L-144"><a href="#-144"><span class="linenos"> 144</span></a>    <span class="c1"># week (-7 day from 00:00:00 to current date and time):</span>
</span><span id="L-145"><a href="#-145"><span class="linenos"> 145</span></a>    <span class="k">elif</span> <span class="n">start</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;week&quot;</span><span class="p">:</span>
</span><span id="L-146"><a href="#-146"><span class="linenos"> 146</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
</span><span id="L-147"><a href="#-147"><span class="linenos"> 147</span></a>        <span class="n">e</span> <span class="o">=</span> <span class="n">now</span>
</span><span id="L-148"><a href="#-148"><span class="linenos"> 148</span></a>
</span><span id="L-149"><a href="#-149"><span class="linenos"> 149</span></a>    <span class="c1"># month (-30 day from 00:00:00 to current date and time):</span>
</span><span id="L-150"><a href="#-150"><span class="linenos"> 150</span></a>    <span class="k">elif</span> <span class="n">start</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;month&quot;</span><span class="p">:</span>
</span><span id="L-151"><a href="#-151"><span class="linenos"> 151</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</span><span id="L-152"><a href="#-152"><span class="linenos"> 152</span></a>        <span class="n">e</span> <span class="o">=</span> <span class="n">now</span>
</span><span id="L-153"><a href="#-153"><span class="linenos"> 153</span></a>
</span><span id="L-154"><a href="#-154"><span class="linenos"> 154</span></a>    <span class="c1"># year (-365 day from 00:00:00 to current date and time):</span>
</span><span id="L-155"><a href="#-155"><span class="linenos"> 155</span></a>    <span class="k">elif</span> <span class="n">start</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;year&quot;</span><span class="p">:</span>
</span><span id="L-156"><a href="#-156"><span class="linenos"> 156</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">365</span><span class="p">)</span>
</span><span id="L-157"><a href="#-157"><span class="linenos"> 157</span></a>        <span class="n">e</span> <span class="o">=</span> <span class="n">now</span>
</span><span id="L-158"><a href="#-158"><span class="linenos"> 158</span></a>
</span><span id="L-159"><a href="#-159"><span class="linenos"> 159</span></a>    <span class="c1"># showing statistics from -N days ago to current date and time:</span>
</span><span id="L-160"><a href="#-160"><span class="linenos"> 160</span></a>    <span class="k">elif</span> <span class="n">start</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">start</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
</span><span id="L-161"><a href="#-161"><span class="linenos"> 161</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">start</span><span class="p">)))</span>
</span><span id="L-162"><a href="#-162"><span class="linenos"> 162</span></a>        <span class="n">e</span> <span class="o">=</span> <span class="n">now</span>
</span><span id="L-163"><a href="#-163"><span class="linenos"> 163</span></a>
</span><span id="L-164"><a href="#-164"><span class="linenos"> 164</span></a>    <span class="c1"># showing statistics between start day at 00:00:00 and the end day at 23:59:59:</span>
</span><span id="L-165"><a href="#-165"><span class="linenos"> 165</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-166"><a href="#-166"><span class="linenos"> 166</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">tzutc</span><span class="p">())</span>
</span><span id="L-167"><a href="#-167"><span class="linenos"> 167</span></a>        <span class="n">e</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">23</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">59</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">59</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">tzutc</span><span class="p">())</span> <span class="k">if</span> <span class="n">end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">now</span>
</span><span id="L-168"><a href="#-168"><span class="linenos"> 168</span></a>
</span><span id="L-169"><a href="#-169"><span class="linenos"> 169</span></a>    <span class="c1"># converting to UTC ISO time formatted with Z suffix for Tinkoff Open API:</span>
</span><span id="L-170"><a href="#-170"><span class="linenos"> 170</span></a>    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span>
</span><span id="L-171"><a href="#-171"><span class="linenos"> 171</span></a>    <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span>
</span><span id="L-172"><a href="#-172"><span class="linenos"> 172</span></a>
</span><span id="L-173"><a href="#-173"><span class="linenos"> 173</span></a>    <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Tinkoff Open API uses this start day (converted to UTC ISO format, with Z): [</span><span class="si">{}</span><span class="s2">], and the end day: [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
</span><span id="L-174"><a href="#-174"><span class="linenos"> 174</span></a>
</span><span id="L-175"><a href="#-175"><span class="linenos"> 175</span></a>    <span class="k">return</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span>
</span><span id="L-176"><a href="#-176"><span class="linenos"> 176</span></a>
</span><span id="L-177"><a href="#-177"><span class="linenos"> 177</span></a>
</span><span id="L-178"><a href="#-178"><span class="linenos"> 178</span></a><span class="k">class</span> <span class="nc">TinkoffBrokerServer</span><span class="p">:</span>
</span><span id="L-179"><a href="#-179"><span class="linenos"> 179</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-180"><a href="#-180"><span class="linenos"> 180</span></a><span class="sd">    This class implements methods to work with Tinkoff broker server.</span>
</span><span id="L-181"><a href="#-181"><span class="linenos"> 181</span></a>
</span><span id="L-182"><a href="#-182"><span class="linenos"> 182</span></a><span class="sd">    Examples to work with API: https://tinkoff.github.io/investAPI/swagger-ui/</span>
</span><span id="L-183"><a href="#-183"><span class="linenos"> 183</span></a>
</span><span id="L-184"><a href="#-184"><span class="linenos"> 184</span></a><span class="sd">    Where is `token`: https://tinkoff.github.io/investAPI/token/</span>
</span><span id="L-185"><a href="#-185"><span class="linenos"> 185</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-186"><a href="#-186"><span class="linenos"> 186</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">iList</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">accountId</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-187"><a href="#-187"><span class="linenos"> 187</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-188"><a href="#-188"><span class="linenos"> 188</span></a><span class="sd">        Main class init.</span>
</span><span id="L-189"><a href="#-189"><span class="linenos"> 189</span></a>
</span><span id="L-190"><a href="#-190"><span class="linenos"> 190</span></a><span class="sd">        :param token: Bearer token for Tinkoff Invest API. It can be set from environment variable `TKS_API_TOKEN`.</span>
</span><span id="L-191"><a href="#-191"><span class="linenos"> 191</span></a><span class="sd">        :param iList: dictionary of dictionaries with instrument&#39;s data.</span>
</span><span id="L-192"><a href="#-192"><span class="linenos"> 192</span></a><span class="sd">        :param accountId: string with user&#39;s numeric account ID in Tinkoff Broker. It can be found in broker&#39;s reports.</span>
</span><span id="L-193"><a href="#-193"><span class="linenos"> 193</span></a><span class="sd">                          Also, this variable can be set from environment variable `TKS_ACCOUNT_ID`.</span>
</span><span id="L-194"><a href="#-194"><span class="linenos"> 194</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-195"><a href="#-195"><span class="linenos"> 195</span></a>        <span class="k">if</span> <span class="n">token</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
</span><span id="L-196"><a href="#-196"><span class="linenos"> 196</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-197"><a href="#-197"><span class="linenos"> 197</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;TKS_API_TOKEN&quot;</span><span class="p">])</span>
</span><span id="L-198"><a href="#-198"><span class="linenos"> 198</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Bearer token for Tinkoff OpenApi set up from environment variable `TKS_API_TOKEN`. See https://tinkoff.github.io/investAPI/token/&quot;</span><span class="p">)</span>
</span><span id="L-199"><a href="#-199"><span class="linenos"> 199</span></a>
</span><span id="L-200"><a href="#-200"><span class="linenos"> 200</span></a>            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
</span><span id="L-201"><a href="#-201"><span class="linenos"> 201</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;`--token` key or environment variable `TKS_API_TOKEN` is required! See https://tinkoff.github.io/investAPI/token/&quot;</span><span class="p">)</span>
</span><span id="L-202"><a href="#-202"><span class="linenos"> 202</span></a>
</span><span id="L-203"><a href="#-203"><span class="linenos"> 203</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-204"><a href="#-204"><span class="linenos"> 204</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">token</span>  <span class="c1"># highly priority than environment variable &#39;TKS_API_TOKEN&#39;</span>
</span><span id="L-205"><a href="#-205"><span class="linenos"> 205</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Bearer token for Tinkoff OpenApi set up from class variable `token`&quot;</span><span class="p">)</span>
</span><span id="L-206"><a href="#-206"><span class="linenos"> 206</span></a>
</span><span id="L-207"><a href="#-207"><span class="linenos"> 207</span></a>        <span class="k">if</span> <span class="n">accountId</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">accountId</span><span class="p">:</span>
</span><span id="L-208"><a href="#-208"><span class="linenos"> 208</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-209"><a href="#-209"><span class="linenos"> 209</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">accountId</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;TKS_ACCOUNT_ID&quot;</span><span class="p">])</span>
</span><span id="L-210"><a href="#-210"><span class="linenos"> 210</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;String with user&#39;s numeric account ID in Tinkoff Broker set up from environment variable `TKS_ACCOUNT_ID`&quot;</span><span class="p">)</span>
</span><span id="L-211"><a href="#-211"><span class="linenos"> 211</span></a>
</span><span id="L-212"><a href="#-212"><span class="linenos"> 212</span></a>            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
</span><span id="L-213"><a href="#-213"><span class="linenos"> 213</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;`--account-id` key or environment variable `TKS_ACCOUNT_ID` undefined! Some of operations may be unavailable (overview, trading etc).&quot;</span><span class="p">)</span>
</span><span id="L-214"><a href="#-214"><span class="linenos"> 214</span></a>
</span><span id="L-215"><a href="#-215"><span class="linenos"> 215</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-216"><a href="#-216"><span class="linenos"> 216</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">accountId</span> <span class="o">=</span> <span class="n">accountId</span>  <span class="c1"># highly priority than environment variable &#39;TKS_ACCOUNT_ID&#39;</span>
</span><span id="L-217"><a href="#-217"><span class="linenos"> 217</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;String with user&#39;s numeric account ID in Tinkoff Broker set up from class variable `accountId`&quot;</span><span class="p">)</span>
</span><span id="L-218"><a href="#-218"><span class="linenos"> 218</span></a>
</span><span id="L-219"><a href="#-219"><span class="linenos"> 219</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">aliases</span> <span class="o">=</span> <span class="n">TKS_TICKER_ALIASES</span>
</span><span id="L-220"><a href="#-220"><span class="linenos"> 220</span></a>        <span class="sd">&quot;&quot;&quot;Some aliases instead official tickers. See `TKSEnums.TKS_TICKER_ALIASES`&quot;&quot;&quot;</span>
</span><span id="L-221"><a href="#-221"><span class="linenos"> 221</span></a>
</span><span id="L-222"><a href="#-222"><span class="linenos"> 222</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">aliasesKeys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aliases</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>  <span class="c1"># re-calc only first time at class init</span>
</span><span id="L-223"><a href="#-223"><span class="linenos"> 223</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">exclude</span> <span class="o">=</span> <span class="n">TKS_TICKERS_OR_FIGI_EXCLUDED</span>  <span class="c1"># some of tickets or FIGIs raised exception earlier when it sends to server, that is why we exclude there</span>
</span><span id="L-224"><a href="#-224"><span class="linenos"> 224</span></a>
</span><span id="L-225"><a href="#-225"><span class="linenos"> 225</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="L-226"><a href="#-226"><span class="linenos"> 226</span></a>        <span class="sd">&quot;&quot;&quot;String with ticker, e.g. `GOOGL`. Use alias for `USD000UTSTOM` simple as `USD`, `EUR_RUB__TOM` as `EUR` etc. More tickers aliases here: `TKSEnums.TKS_TICKER_ALIASES`.&quot;&quot;&quot;</span>
</span><span id="L-227"><a href="#-227"><span class="linenos"> 227</span></a>
</span><span id="L-228"><a href="#-228"><span class="linenos"> 228</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="L-229"><a href="#-229"><span class="linenos"> 229</span></a>        <span class="sd">&quot;&quot;&quot;String with FIGI, e.g. ticker `GOOGL` has FIGI `BBG009S39JX6`&quot;&quot;&quot;</span>
</span><span id="L-230"><a href="#-230"><span class="linenos"> 230</span></a>
</span><span id="L-231"><a href="#-231"><span class="linenos"> 231</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-232"><a href="#-232"><span class="linenos"> 232</span></a>        <span class="sd">&quot;&quot;&quot;Depth of Market (DOM) can be &gt;= 1. Default: 1. It used with `--price` key to showing DOM with current prices for givens ticker or FIGI.&quot;&quot;&quot;</span>
</span><span id="L-233"><a href="#-233"><span class="linenos"> 233</span></a>
</span><span id="L-234"><a href="#-234"><span class="linenos"> 234</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;https://invest-public-api.tinkoff.ru/rest&quot;</span>
</span><span id="L-235"><a href="#-235"><span class="linenos"> 235</span></a>        <span class="sd">&quot;&quot;&quot;Tinkoff REST API server for real trade operations. Default: https://invest-public-api.tinkoff.ru/rest</span>
</span><span id="L-236"><a href="#-236"><span class="linenos"> 236</span></a>
</span><span id="L-237"><a href="#-237"><span class="linenos"> 237</span></a><span class="sd">        See: https://tinkoff.github.io/investAPI/#tinkoff-invest-api_1</span>
</span><span id="L-238"><a href="#-238"><span class="linenos"> 238</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-239"><a href="#-239"><span class="linenos"> 239</span></a>
</span><span id="L-240"><a href="#-240"><span class="linenos"> 240</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Broker API server: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">))</span>
</span><span id="L-241"><a href="#-241"><span class="linenos"> 241</span></a>
</span><span id="L-242"><a href="#-242"><span class="linenos"> 242</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">15</span>
</span><span id="L-243"><a href="#-243"><span class="linenos"> 243</span></a>        <span class="sd">&quot;&quot;&quot;Server operations timeout in seconds. Default: 15&quot;&quot;&quot;</span>
</span><span id="L-244"><a href="#-244"><span class="linenos"> 244</span></a>
</span><span id="L-245"><a href="#-245"><span class="linenos"> 245</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span> <span class="s2">&quot;accept&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span> <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="s2">&quot;Bearer </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">)}</span>
</span><span id="L-246"><a href="#-246"><span class="linenos"> 246</span></a>        <span class="sd">&quot;&quot;&quot;Headers which send in every request to broker server. Default: `{&quot;Content-Type&quot;: &quot;application/json&quot;, &quot;accept&quot;: &quot;application/json&quot;, &quot;Authorization&quot;: &quot;Bearer {token}&quot;}`&quot;&quot;&quot;</span>
</span><span id="L-247"><a href="#-247"><span class="linenos"> 247</span></a>
</span><span id="L-248"><a href="#-248"><span class="linenos"> 248</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-249"><a href="#-249"><span class="linenos"> 249</span></a>        <span class="sd">&quot;&quot;&quot;Request body which send to broker server. Default: `None`&quot;&quot;&quot;</span>
</span><span id="L-250"><a href="#-250"><span class="linenos"> 250</span></a>
</span><span id="L-251"><a href="#-251"><span class="linenos"> 251</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">historyLength</span> <span class="o">=</span> <span class="mi">24</span>
</span><span id="L-252"><a href="#-252"><span class="linenos"> 252</span></a>        <span class="sd">&quot;&quot;&quot;How many candles returns if candles history request. For example, if `historyInterval=&quot;hour&quot;` and `historyLength=24` it means: &quot;give me last 24 hours&quot;. Must be &gt;=1. Default: 24&quot;&quot;&quot;</span>
</span><span id="L-253"><a href="#-253"><span class="linenos"> 253</span></a>
</span><span id="L-254"><a href="#-254"><span class="linenos"> 254</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">historyInterval</span> <span class="o">=</span> <span class="s2">&quot;hour&quot;</span>
</span><span id="L-255"><a href="#-255"><span class="linenos"> 255</span></a>        <span class="sd">&quot;&quot;&quot;Interval string for Tinkoff API (see: `TKSEnums.TKS_TIMEFRAMES`). Available values are `&quot;1min&quot;`, `&quot;2min&quot;`, `&quot;3min&quot;`, `&quot;5min&quot;`, `&quot;10min&quot;`, `&quot;15min&quot;`, `&quot;30min&quot;`, `&quot;hour&quot;`, `&quot;day&quot;`, `&quot;week&quot;`, `&quot;month&quot;`. Default: `&quot;hour&quot;`&quot;&quot;&quot;</span>
</span><span id="L-256"><a href="#-256"><span class="linenos"> 256</span></a>
</span><span id="L-257"><a href="#-257"><span class="linenos"> 257</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">iList</span> <span class="o">=</span> <span class="n">iList</span> <span class="k">if</span> <span class="n">iList</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">Listing</span><span class="p">()</span>
</span><span id="L-258"><a href="#-258"><span class="linenos"> 258</span></a>        <span class="sd">&quot;&quot;&quot;Dictionary with raw data about stocks, currencies, bonds, etfs and futures from broker server.</span>
</span><span id="L-259"><a href="#-259"><span class="linenos"> 259</span></a><span class="sd">        At first time, when class init, `Listing()` method auto-update this variable.</span>
</span><span id="L-260"><a href="#-260"><span class="linenos"> 260</span></a><span class="sd">        For future use, you can save this variable and substitute it in the `iList` to avoid permanent downloads from the server.</span>
</span><span id="L-261"><a href="#-261"><span class="linenos"> 261</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-262"><a href="#-262"><span class="linenos"> 262</span></a>
</span><span id="L-263"><a href="#-263"><span class="linenos"> 263</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pricesList</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># You can request all current prices with `ShowAllPrices()` method. WARNING! This is too long operation!</span>
</span><span id="L-264"><a href="#-264"><span class="linenos"> 264</span></a>
</span><span id="L-265"><a href="#-265"><span class="linenos"> 265</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">instrumentsFile</span> <span class="o">=</span> <span class="s2">&quot;instruments.md&quot;</span>
</span><span id="L-266"><a href="#-266"><span class="linenos"> 266</span></a>        <span class="sd">&quot;&quot;&quot;Filename where full broker&#39;s instruments list will be saved. Default: `&quot;instruments.md&quot;`&quot;&quot;&quot;</span>
</span><span id="L-267"><a href="#-267"><span class="linenos"> 267</span></a>
</span><span id="L-268"><a href="#-268"><span class="linenos"> 268</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pricesFile</span> <span class="o">=</span> <span class="s2">&quot;prices.md&quot;</span>
</span><span id="L-269"><a href="#-269"><span class="linenos"> 269</span></a>        <span class="sd">&quot;&quot;&quot;Filename where prices of selected instruments will be saved. Default: `&quot;prices.md&quot;`&quot;&quot;&quot;</span>
</span><span id="L-270"><a href="#-270"><span class="linenos"> 270</span></a>
</span><span id="L-271"><a href="#-271"><span class="linenos"> 271</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overviewFile</span> <span class="o">=</span> <span class="s2">&quot;overview.md&quot;</span>
</span><span id="L-272"><a href="#-272"><span class="linenos"> 272</span></a>        <span class="sd">&quot;&quot;&quot;Filename where current portfolio, open trades and orders will be saved. Default: `&quot;overview.md&quot;`&quot;&quot;&quot;</span>
</span><span id="L-273"><a href="#-273"><span class="linenos"> 273</span></a>
</span><span id="L-274"><a href="#-274"><span class="linenos"> 274</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reportFile</span> <span class="o">=</span> <span class="s2">&quot;report.md&quot;</span>
</span><span id="L-275"><a href="#-275"><span class="linenos"> 275</span></a>        <span class="sd">&quot;&quot;&quot;Filename where history of deals and trade statistics will be saved. Default: `&quot;report.md&quot;`&quot;&quot;&quot;</span>
</span><span id="L-276"><a href="#-276"><span class="linenos"> 276</span></a>
</span><span id="L-277"><a href="#-277"><span class="linenos"> 277</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">historyFile</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-278"><a href="#-278"><span class="linenos"> 278</span></a>        <span class="sd">&quot;&quot;&quot;Full path to .csv output file where history candles will be saved. Default: `None`, mean that returns only pandas dataframe.&quot;&quot;&quot;</span>
</span><span id="L-279"><a href="#-279"><span class="linenos"> 279</span></a>
</span><span id="L-280"><a href="#-280"><span class="linenos"> 280</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-281"><a href="#-281"><span class="linenos"> 281</span></a>    <span class="k">def</span> <span class="nf">_ParseJSON</span><span class="p">(</span><span class="n">rawData</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="L-282"><a href="#-282"><span class="linenos"> 282</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-283"><a href="#-283"><span class="linenos"> 283</span></a><span class="sd">        Parse JSON from response string.</span>
</span><span id="L-284"><a href="#-284"><span class="linenos"> 284</span></a>
</span><span id="L-285"><a href="#-285"><span class="linenos"> 285</span></a><span class="sd">        :param rawData: this is a string with JSON-formatted text.</span>
</span><span id="L-286"><a href="#-286"><span class="linenos"> 286</span></a><span class="sd">        :param debug: if `True` then print more debug information.</span>
</span><span id="L-287"><a href="#-287"><span class="linenos"> 287</span></a><span class="sd">        :return: JSON (dictionary), parsed from server response string.</span>
</span><span id="L-288"><a href="#-288"><span class="linenos"> 288</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-289"><a href="#-289"><span class="linenos"> 289</span></a>        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="L-290"><a href="#-290"><span class="linenos"> 290</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Raw text body:&quot;</span><span class="p">)</span>
</span><span id="L-291"><a href="#-291"><span class="linenos"> 291</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">rawData</span><span class="p">)</span>
</span><span id="L-292"><a href="#-292"><span class="linenos"> 292</span></a>
</span><span id="L-293"><a href="#-293"><span class="linenos"> 293</span></a>        <span class="n">responseJSON</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">rawData</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">rawData</span> <span class="k">else</span> <span class="p">{}</span>
</span><span id="L-294"><a href="#-294"><span class="linenos"> 294</span></a>
</span><span id="L-295"><a href="#-295"><span class="linenos"> 295</span></a>        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="L-296"><a href="#-296"><span class="linenos"> 296</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;JSON formatted:&quot;</span><span class="p">)</span>
</span><span id="L-297"><a href="#-297"><span class="linenos"> 297</span></a>            <span class="k">for</span> <span class="n">jsonLine</span> <span class="ow">in</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">responseJSON</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
</span><span id="L-298"><a href="#-298"><span class="linenos"> 298</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">jsonLine</span><span class="p">)</span>
</span><span id="L-299"><a href="#-299"><span class="linenos"> 299</span></a>
</span><span id="L-300"><a href="#-300"><span class="linenos"> 300</span></a>        <span class="k">return</span> <span class="n">responseJSON</span>
</span><span id="L-301"><a href="#-301"><span class="linenos"> 301</span></a>
</span><span id="L-302"><a href="#-302"><span class="linenos"> 302</span></a>    <span class="k">def</span> <span class="nf">SendAPIRequest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">reqType</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="n">retry</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">pause</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="L-303"><a href="#-303"><span class="linenos"> 303</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-304"><a href="#-304"><span class="linenos"> 304</span></a><span class="sd">        Send GET or POST request to broker server and receive JSON object.</span>
</span><span id="L-305"><a href="#-305"><span class="linenos"> 305</span></a>
</span><span id="L-306"><a href="#-306"><span class="linenos"> 306</span></a><span class="sd">        self.header: must be define with dictionary of headers.</span>
</span><span id="L-307"><a href="#-307"><span class="linenos"> 307</span></a><span class="sd">        self.body: if define then used as request body. None by default.</span>
</span><span id="L-308"><a href="#-308"><span class="linenos"> 308</span></a><span class="sd">        self.timeout: global request timeout, 15 seconds by default.</span>
</span><span id="L-309"><a href="#-309"><span class="linenos"> 309</span></a><span class="sd">        :param url: url with REST request.</span>
</span><span id="L-310"><a href="#-310"><span class="linenos"> 310</span></a><span class="sd">        :param reqType: send &quot;GET&quot; or &quot;POST&quot; request. &quot;GET&quot; by default.</span>
</span><span id="L-311"><a href="#-311"><span class="linenos"> 311</span></a><span class="sd">        :param retry: how many times retry after first request if an error occurred.</span>
</span><span id="L-312"><a href="#-312"><span class="linenos"> 312</span></a><span class="sd">        :param pause: sleep time in seconds between retries.</span>
</span><span id="L-313"><a href="#-313"><span class="linenos"> 313</span></a><span class="sd">        :param debug: if `True` then print more debug information.</span>
</span><span id="L-314"><a href="#-314"><span class="linenos"> 314</span></a><span class="sd">        :return: response JSON (dictionary) from broker.</span>
</span><span id="L-315"><a href="#-315"><span class="linenos"> 315</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-316"><a href="#-316"><span class="linenos"> 316</span></a>        <span class="k">if</span> <span class="n">reqType</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">):</span>
</span><span id="L-317"><a href="#-317"><span class="linenos"> 317</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;You can define request type: &#39;GET&#39; or &#39;POST&#39;!&quot;</span><span class="p">)</span>
</span><span id="L-318"><a href="#-318"><span class="linenos"> 318</span></a>
</span><span id="L-319"><a href="#-319"><span class="linenos"> 319</span></a>        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="L-320"><a href="#-320"><span class="linenos"> 320</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Request parameters:&quot;</span><span class="p">)</span>
</span><span id="L-321"><a href="#-321"><span class="linenos"> 321</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;    - REST API URL: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
</span><span id="L-322"><a href="#-322"><span class="linenos"> 322</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;    - request type: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reqType</span><span class="p">))</span>
</span><span id="L-323"><a href="#-323"><span class="linenos"> 323</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;    - headers: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="s2">&quot;*** request token ***&quot;</span><span class="p">)))</span>
</span><span id="L-324"><a href="#-324"><span class="linenos"> 324</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;    - body: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">))</span>
</span><span id="L-325"><a href="#-325"><span class="linenos"> 325</span></a>
</span><span id="L-326"><a href="#-326"><span class="linenos"> 326</span></a>        <span class="c1"># fast hack to avoid all operations with some tickers/FIGI</span>
</span><span id="L-327"><a href="#-327"><span class="linenos"> 327</span></a>        <span class="n">responseJSON</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-328"><a href="#-328"><span class="linenos"> 328</span></a>        <span class="n">oK</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-329"><a href="#-329"><span class="linenos"> 329</span></a>        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exclude</span><span class="p">:</span>
</span><span id="L-330"><a href="#-330"><span class="linenos"> 330</span></a>            <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">url</span><span class="p">:</span>
</span><span id="L-331"><a href="#-331"><span class="linenos"> 331</span></a>                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="L-332"><a href="#-332"><span class="linenos"> 332</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Do not execute operations with list of this tickers/FIGI: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exclude</span><span class="p">)))</span>
</span><span id="L-333"><a href="#-333"><span class="linenos"> 333</span></a>
</span><span id="L-334"><a href="#-334"><span class="linenos"> 334</span></a>                <span class="n">oK</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-335"><a href="#-335"><span class="linenos"> 335</span></a>                <span class="k">break</span>
</span><span id="L-336"><a href="#-336"><span class="linenos"> 336</span></a>
</span><span id="L-337"><a href="#-337"><span class="linenos"> 337</span></a>        <span class="k">if</span> <span class="n">oK</span><span class="p">:</span>
</span><span id="L-338"><a href="#-338"><span class="linenos"> 338</span></a>            <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-339"><a href="#-339"><span class="linenos"> 339</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-340"><a href="#-340"><span class="linenos"> 340</span></a>            <span class="n">errMsg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="L-341"><a href="#-341"><span class="linenos"> 341</span></a>
</span><span id="L-342"><a href="#-342"><span class="linenos"> 342</span></a>            <span class="k">while</span> <span class="ow">not</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">counter</span> <span class="o">&lt;=</span> <span class="n">retry</span><span class="p">:</span>
</span><span id="L-343"><a href="#-343"><span class="linenos"> 343</span></a>                <span class="k">if</span> <span class="n">reqType</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
</span><span id="L-344"><a href="#-344"><span class="linenos"> 344</span></a>                    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
</span><span id="L-345"><a href="#-345"><span class="linenos"> 345</span></a>
</span><span id="L-346"><a href="#-346"><span class="linenos"> 346</span></a>                <span class="k">if</span> <span class="n">reqType</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
</span><span id="L-347"><a href="#-347"><span class="linenos"> 347</span></a>                    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
</span><span id="L-348"><a href="#-348"><span class="linenos"> 348</span></a>
</span><span id="L-349"><a href="#-349"><span class="linenos"> 349</span></a>                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="L-350"><a href="#-350"><span class="linenos"> 350</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Response:&quot;</span><span class="p">)</span>
</span><span id="L-351"><a href="#-351"><span class="linenos"> 351</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;    - status code: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">))</span>
</span><span id="L-352"><a href="#-352"><span class="linenos"> 352</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;    - reason: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">reason</span><span class="p">))</span>
</span><span id="L-353"><a href="#-353"><span class="linenos"> 353</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;    - body length: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)))</span>
</span><span id="L-354"><a href="#-354"><span class="linenos"> 354</span></a>
</span><span id="L-355"><a href="#-355"><span class="linenos"> 355</span></a>                <span class="c1"># Error status codes: https://en.wikipedia.org/wiki/List_of_HTTP_status_codes</span>
</span><span id="L-356"><a href="#-356"><span class="linenos"> 356</span></a>                <span class="k">if</span> <span class="mi">400</span> <span class="o">&lt;=</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&lt;</span> <span class="mi">600</span><span class="p">:</span>
</span><span id="L-357"><a href="#-357"><span class="linenos"> 357</span></a>                    <span class="n">errMsg</span> <span class="o">=</span> <span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">] </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="L-358"><a href="#-358"><span class="linenos"> 358</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;    - not oK status code received: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">errMsg</span><span class="p">))</span>
</span><span id="L-359"><a href="#-359"><span class="linenos"> 359</span></a>                    <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-360"><a href="#-360"><span class="linenos"> 360</span></a>
</span><span id="L-361"><a href="#-361"><span class="linenos"> 361</span></a>                    <span class="k">if</span> <span class="n">counter</span> <span class="o">&lt;=</span> <span class="n">retry</span><span class="p">:</span>
</span><span id="L-362"><a href="#-362"><span class="linenos"> 362</span></a>                        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Retry: [</span><span class="si">{}</span><span class="s2">]. Wait until </span><span class="si">{}</span><span class="s2"> sec. and try again...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="n">pause</span><span class="p">))</span>
</span><span id="L-363"><a href="#-363"><span class="linenos"> 363</span></a>                        <span class="n">sleep</span><span class="p">(</span><span class="n">pause</span><span class="p">)</span>
</span><span id="L-364"><a href="#-364"><span class="linenos"> 364</span></a>
</span><span id="L-365"><a href="#-365"><span class="linenos"> 365</span></a>            <span class="n">responseJSON</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ParseJSON</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="L-366"><a href="#-366"><span class="linenos"> 366</span></a>
</span><span id="L-367"><a href="#-367"><span class="linenos"> 367</span></a>            <span class="k">if</span> <span class="n">errMsg</span><span class="p">:</span>
</span><span id="L-368"><a href="#-368"><span class="linenos"> 368</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Not `oK` status received from broker server!&quot;</span><span class="p">)</span>
</span><span id="L-369"><a href="#-369"><span class="linenos"> 369</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;    - message: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">errMsg</span><span class="p">))</span>
</span><span id="L-370"><a href="#-370"><span class="linenos"> 370</span></a>                <span class="c1"># raise Exception(&quot;Server returned an error! See full debug log. Also you can set debug=True in SendAPIRequest() and _ParseJSON() methods.&quot;)</span>
</span><span id="L-371"><a href="#-371"><span class="linenos"> 371</span></a>
</span><span id="L-372"><a href="#-372"><span class="linenos"> 372</span></a>        <span class="k">return</span> <span class="n">responseJSON</span>
</span><span id="L-373"><a href="#-373"><span class="linenos"> 373</span></a>
</span><span id="L-374"><a href="#-374"><span class="linenos"> 374</span></a>    <span class="k">def</span> <span class="nf">_IUpdater</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iType</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
</span><span id="L-375"><a href="#-375"><span class="linenos"> 375</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-376"><a href="#-376"><span class="linenos"> 376</span></a><span class="sd">        Request instrument by type from server. See available API methods for instruments:</span>
</span><span id="L-377"><a href="#-377"><span class="linenos"> 377</span></a><span class="sd">        Currencies: https://tinkoff.github.io/investAPI/swagger-ui/#/InstrumentsService/InstrumentsService_Currencies</span>
</span><span id="L-378"><a href="#-378"><span class="linenos"> 378</span></a><span class="sd">        Shares: https://tinkoff.github.io/investAPI/swagger-ui/#/InstrumentsService/InstrumentsService_Shares</span>
</span><span id="L-379"><a href="#-379"><span class="linenos"> 379</span></a><span class="sd">        Bonds: https://tinkoff.github.io/investAPI/swagger-ui/#/InstrumentsService/InstrumentsService_Bonds</span>
</span><span id="L-380"><a href="#-380"><span class="linenos"> 380</span></a><span class="sd">        Etfs: https://tinkoff.github.io/investAPI/swagger-ui/#/InstrumentsService/InstrumentsService_Etfs</span>
</span><span id="L-381"><a href="#-381"><span class="linenos"> 381</span></a><span class="sd">        Futures: https://tinkoff.github.io/investAPI/swagger-ui/#/InstrumentsService/InstrumentsService_Futures</span>
</span><span id="L-382"><a href="#-382"><span class="linenos"> 382</span></a>
</span><span id="L-383"><a href="#-383"><span class="linenos"> 383</span></a><span class="sd">        :param iType: type of the instrument, it must be one of supported types in TKS_INSTRUMENTS list.</span>
</span><span id="L-384"><a href="#-384"><span class="linenos"> 384</span></a><span class="sd">        :return: tuple with iType name and list of available instruments of current type for defined user token.</span>
</span><span id="L-385"><a href="#-385"><span class="linenos"> 385</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-386"><a href="#-386"><span class="linenos"> 386</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-387"><a href="#-387"><span class="linenos"> 387</span></a>
</span><span id="L-388"><a href="#-388"><span class="linenos"> 388</span></a>        <span class="k">if</span> <span class="n">iType</span> <span class="ow">in</span> <span class="n">TKS_INSTRUMENTS</span><span class="p">:</span>
</span><span id="L-389"><a href="#-389"><span class="linenos"> 389</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Requesting available [</span><span class="si">{}</span><span class="s2">] list. Wait, please...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iType</span><span class="p">))</span>
</span><span id="L-390"><a href="#-390"><span class="linenos"> 390</span></a>
</span><span id="L-391"><a href="#-391"><span class="linenos"> 391</span></a>            <span class="c1"># all instruments have the same body in API v2 requests:</span>
</span><span id="L-392"><a href="#-392"><span class="linenos"> 392</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="nb">str</span><span class="p">({</span><span class="s2">&quot;instrumentStatus&quot;</span><span class="p">:</span> <span class="s2">&quot;INSTRUMENT_STATUS_UNSPECIFIED&quot;</span><span class="p">})</span>  <span class="c1"># Enum: [INSTRUMENT_STATUS_UNSPECIFIED, INSTRUMENT_STATUS_BASE, INSTRUMENT_STATUS_ALL]</span>
</span><span id="L-393"><a href="#-393"><span class="linenos"> 393</span></a>            <span class="n">instrumentURL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;/tinkoff.public.invest.api.contract.v1.InstrumentsService/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iType</span><span class="p">)</span>
</span><span id="L-394"><a href="#-394"><span class="linenos"> 394</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SendAPIRequest</span><span class="p">(</span><span class="n">instrumentURL</span><span class="p">,</span> <span class="n">reqType</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s2">&quot;instruments&quot;</span><span class="p">]</span>
</span><span id="L-395"><a href="#-395"><span class="linenos"> 395</span></a>
</span><span id="L-396"><a href="#-396"><span class="linenos"> 396</span></a>        <span class="k">return</span> <span class="n">iType</span><span class="p">,</span> <span class="n">result</span>
</span><span id="L-397"><a href="#-397"><span class="linenos"> 397</span></a>
</span><span id="L-398"><a href="#-398"><span class="linenos"> 398</span></a>    <span class="k">def</span> <span class="nf">_IWrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-399"><a href="#-399"><span class="linenos"> 399</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-400"><a href="#-400"><span class="linenos"> 400</span></a><span class="sd">        Wrapper runs instrument&#39;s update method self._IUpdater().</span>
</span><span id="L-401"><a href="#-401"><span class="linenos"> 401</span></a><span class="sd">        It&#39;s a workaround for using multiprocessing with kwargs. See: https://stackoverflow.com/a/36799206</span>
</span><span id="L-402"><a href="#-402"><span class="linenos"> 402</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-403"><a href="#-403"><span class="linenos"> 403</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_IUpdater</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-404"><a href="#-404"><span class="linenos"> 404</span></a>
</span><span id="L-405"><a href="#-405"><span class="linenos"> 405</span></a>    <span class="k">def</span> <span class="nf">Listing</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="L-406"><a href="#-406"><span class="linenos"> 406</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-407"><a href="#-407"><span class="linenos"> 407</span></a><span class="sd">        Gets JSON with raw data about stocks, currencies, bonds, etfs and futures from broker server.</span>
</span><span id="L-408"><a href="#-408"><span class="linenos"> 408</span></a>
</span><span id="L-409"><a href="#-409"><span class="linenos"> 409</span></a><span class="sd">        :return: Dictionary with all available broker instruments: currencies, stocks, bonds, etfs and futures.</span>
</span><span id="L-410"><a href="#-410"><span class="linenos"> 410</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-411"><a href="#-411"><span class="linenos"> 411</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Requesting all available instruments from broker for current user token. Wait, please...&quot;</span><span class="p">)</span>
</span><span id="L-412"><a href="#-412"><span class="linenos"> 412</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;CPU usages for parallel requests: [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">CPU_USAGES</span><span class="p">))</span>
</span><span id="L-413"><a href="#-413"><span class="linenos"> 413</span></a>
</span><span id="L-414"><a href="#-414"><span class="linenos"> 414</span></a>        <span class="c1"># this parameters insert to requests: https://tinkoff.github.io/investAPI/swagger-ui/#/InstrumentsService</span>
</span><span id="L-415"><a href="#-415"><span class="linenos"> 415</span></a>        <span class="c1"># iType is type of instrument, it must be one of supported types in TKS_INSTRUMENTS list.</span>
</span><span id="L-416"><a href="#-416"><span class="linenos"> 416</span></a>        <span class="n">iParams</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;iType&quot;</span><span class="p">:</span> <span class="n">iType</span><span class="p">}</span> <span class="k">for</span> <span class="n">iType</span> <span class="ow">in</span> <span class="n">TKS_INSTRUMENTS</span><span class="p">]</span>
</span><span id="L-417"><a href="#-417"><span class="linenos"> 417</span></a>
</span><span id="L-418"><a href="#-418"><span class="linenos"> 418</span></a>        <span class="n">poolUpdater</span> <span class="o">=</span> <span class="n">ThreadPool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">CPU_USAGES</span><span class="p">)</span>  <span class="c1"># create pool for update instruments in parallel mode</span>
</span><span id="L-419"><a href="#-419"><span class="linenos"> 419</span></a>        <span class="n">listing</span> <span class="o">=</span> <span class="n">poolUpdater</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_IWrapper</span><span class="p">,</span> <span class="n">iParams</span><span class="p">)</span>  <span class="c1"># execute update operations</span>
</span><span id="L-420"><a href="#-420"><span class="linenos"> 420</span></a>        <span class="n">poolUpdater</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-421"><a href="#-421"><span class="linenos"> 421</span></a>
</span><span id="L-422"><a href="#-422"><span class="linenos"> 422</span></a>        <span class="c1"># Dictionary with all broker instruments: stocks, currencies, bonds, etfs and futures.</span>
</span><span id="L-423"><a href="#-423"><span class="linenos"> 423</span></a>        <span class="c1"># Next in this code: item[0] is &quot;iType&quot; and item[1] is list of available instruments from the result of _IUpdater() method</span>
</span><span id="L-424"><a href="#-424"><span class="linenos"> 424</span></a>        <span class="n">iList</span> <span class="o">=</span> <span class="p">{</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="p">{</span><span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">]:</span> <span class="n">instrument</span> <span class="k">for</span> <span class="n">instrument</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">listing</span><span class="p">}</span>
</span><span id="L-425"><a href="#-425"><span class="linenos"> 425</span></a>
</span><span id="L-426"><a href="#-426"><span class="linenos"> 426</span></a>        <span class="c1"># calculate minimum price increment (step) for all instruments and set up instrument&#39;s type:</span>
</span><span id="L-427"><a href="#-427"><span class="linenos"> 427</span></a>        <span class="k">for</span> <span class="n">iType</span> <span class="ow">in</span> <span class="n">iList</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-428"><a href="#-428"><span class="linenos"> 428</span></a>            <span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">]:</span>
</span><span id="L-429"><a href="#-429"><span class="linenos"> 429</span></a>                <span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">][</span><span class="n">ticker</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iType</span>
</span><span id="L-430"><a href="#-430"><span class="linenos"> 430</span></a>
</span><span id="L-431"><a href="#-431"><span class="linenos"> 431</span></a>                <span class="k">if</span> <span class="s2">&quot;minPriceIncrement&quot;</span> <span class="ow">in</span> <span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">][</span><span class="n">ticker</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-432"><a href="#-432"><span class="linenos"> 432</span></a>                    <span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">][</span><span class="n">ticker</span><span class="p">][</span><span class="s2">&quot;step&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span>
</span><span id="L-433"><a href="#-433"><span class="linenos"> 433</span></a>                        <span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">][</span><span class="n">ticker</span><span class="p">][</span><span class="s2">&quot;minPriceIncrement&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span>
</span><span id="L-434"><a href="#-434"><span class="linenos"> 434</span></a>                        <span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">][</span><span class="n">ticker</span><span class="p">][</span><span class="s2">&quot;minPriceIncrement&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">],</span>
</span><span id="L-435"><a href="#-435"><span class="linenos"> 435</span></a>                    <span class="p">)</span>
</span><span id="L-436"><a href="#-436"><span class="linenos"> 436</span></a>
</span><span id="L-437"><a href="#-437"><span class="linenos"> 437</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-438"><a href="#-438"><span class="linenos"> 438</span></a>                    <span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">][</span><span class="n">ticker</span><span class="p">][</span><span class="s2">&quot;step&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># hack to avoid empty value in some instruments, e.g. futures</span>
</span><span id="L-439"><a href="#-439"><span class="linenos"> 439</span></a>
</span><span id="L-440"><a href="#-440"><span class="linenos"> 440</span></a>        <span class="k">return</span> <span class="n">iList</span>
</span><span id="L-441"><a href="#-441"><span class="linenos"> 441</span></a>
</span><span id="L-442"><a href="#-442"><span class="linenos"> 442</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-443"><a href="#-443"><span class="linenos"> 443</span></a>    <span class="k">def</span> <span class="nf">ShowInstrumentInfo</span><span class="p">(</span><span class="n">iJSON</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">printInfo</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-444"><a href="#-444"><span class="linenos"> 444</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-445"><a href="#-445"><span class="linenos"> 445</span></a><span class="sd">        Show information about instrument defined by json and print in Markdown format.</span>
</span><span id="L-446"><a href="#-446"><span class="linenos"> 446</span></a>
</span><span id="L-447"><a href="#-447"><span class="linenos"> 447</span></a><span class="sd">        :param iJSON: json data of instrument, e.g. in code `iJSON = self.iList[&quot;Shares&quot;][self.ticker]`</span>
</span><span id="L-448"><a href="#-448"><span class="linenos"> 448</span></a><span class="sd">        :param printInfo: if `True` then also printing information about instrument and its current price.</span>
</span><span id="L-449"><a href="#-449"><span class="linenos"> 449</span></a><span class="sd">        :return: text in Markdown format with information about instrument.</span>
</span><span id="L-450"><a href="#-450"><span class="linenos"> 450</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-451"><a href="#-451"><span class="linenos"> 451</span></a>        <span class="n">infoText</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="L-452"><a href="#-452"><span class="linenos"> 452</span></a>        <span class="k">if</span> <span class="n">iJSON</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">iJSON</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">iJSON</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="L-453"><a href="#-453"><span class="linenos"> 453</span></a>            <span class="n">info</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-454"><a href="#-454"><span class="linenos"> 454</span></a>                <span class="s2">&quot;# Information is actual at: [</span><span class="si">{}</span><span class="s2">] (UTC)</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tzutc</span><span class="p">())</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M&quot;</span><span class="p">)),</span>
</span><span id="L-455"><a href="#-455"><span class="linenos"> 455</span></a>                <span class="s2">&quot;| Parameters                                              | Values</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-456"><a href="#-456"><span class="linenos"> 456</span></a>                <span class="s2">&quot;|---------------------------------------------------------|---------------------------------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-457"><a href="#-457"><span class="linenos"> 457</span></a>                <span class="s2">&quot;| Stock ticker:                                           | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">]),</span>
</span><span id="L-458"><a href="#-458"><span class="linenos"> 458</span></a>                <span class="s2">&quot;| Full name:                                              | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]),</span>
</span><span id="L-459"><a href="#-459"><span class="linenos"> 459</span></a>            <span class="p">]</span>
</span><span id="L-460"><a href="#-460"><span class="linenos"> 460</span></a>
</span><span id="L-461"><a href="#-461"><span class="linenos"> 461</span></a>            <span class="k">if</span> <span class="s2">&quot;sector&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;sector&quot;</span><span class="p">]:</span>
</span><span id="L-462"><a href="#-462"><span class="linenos"> 462</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Sector:                                                 | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;sector&quot;</span><span class="p">]))</span>
</span><span id="L-463"><a href="#-463"><span class="linenos"> 463</span></a>
</span><span id="L-464"><a href="#-464"><span class="linenos"> 464</span></a>            <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Country of instrument:                                  | </span><span class="si">{}{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-465"><a href="#-465"><span class="linenos"> 465</span></a>                <span class="s2">&quot;(</span><span class="si">{}</span><span class="s2">) &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;countryOfRisk&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;countryOfRisk&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;countryOfRisk&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-466"><a href="#-466"><span class="linenos"> 466</span></a>                <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;countryOfRiskName&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;countryOfRiskName&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;countryOfRiskName&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-467"><a href="#-467"><span class="linenos"> 467</span></a>            <span class="p">))</span>
</span><span id="L-468"><a href="#-468"><span class="linenos"> 468</span></a>
</span><span id="L-469"><a href="#-469"><span class="linenos"> 469</span></a>            <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span><span id="L-470"><a href="#-470"><span class="linenos"> 470</span></a>                <span class="s2">&quot;|                                                         |</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-471"><a href="#-471"><span class="linenos"> 471</span></a>                <span class="s2">&quot;| FIGI (Financial Instrument Global Identifier):          | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]),</span>
</span><span id="L-472"><a href="#-472"><span class="linenos"> 472</span></a>                <span class="s2">&quot;| Exchange:                                               | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;exchange&quot;</span><span class="p">]),</span>
</span><span id="L-473"><a href="#-473"><span class="linenos"> 473</span></a>            <span class="p">])</span>
</span><span id="L-474"><a href="#-474"><span class="linenos"> 474</span></a>
</span><span id="L-475"><a href="#-475"><span class="linenos"> 475</span></a>            <span class="k">if</span> <span class="s2">&quot;isin&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;isin&quot;</span><span class="p">]:</span>
</span><span id="L-476"><a href="#-476"><span class="linenos"> 476</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| ISIN (International Securities Identification Number):  | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;isin&quot;</span><span class="p">]))</span>
</span><span id="L-477"><a href="#-477"><span class="linenos"> 477</span></a>
</span><span id="L-478"><a href="#-478"><span class="linenos"> 478</span></a>            <span class="k">if</span> <span class="s2">&quot;classCode&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-479"><a href="#-479"><span class="linenos"> 479</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Class Code:                                             | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;classCode&quot;</span><span class="p">]))</span>
</span><span id="L-480"><a href="#-480"><span class="linenos"> 480</span></a>
</span><span id="L-481"><a href="#-481"><span class="linenos"> 481</span></a>            <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span><span id="L-482"><a href="#-482"><span class="linenos"> 482</span></a>                <span class="s2">&quot;|                                                         |</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-483"><a href="#-483"><span class="linenos"> 483</span></a>                <span class="s2">&quot;| Current broker security trading status:                 | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">TKS_TRADING_STATUSES</span><span class="p">[</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;tradingStatus&quot;</span><span class="p">]]),</span>
</span><span id="L-484"><a href="#-484"><span class="linenos"> 484</span></a>                <span class="s2">&quot;| Buy operations allowed:                                 | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Yes&quot;</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;buyAvailableFlag&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;No&quot;</span><span class="p">),</span>
</span><span id="L-485"><a href="#-485"><span class="linenos"> 485</span></a>                <span class="s2">&quot;| Sale operations allowed:                                | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Yes&quot;</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;sellAvailableFlag&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;No&quot;</span><span class="p">),</span>
</span><span id="L-486"><a href="#-486"><span class="linenos"> 486</span></a>                <span class="s2">&quot;| Short positions allowed:                                | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Yes&quot;</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;shortEnabledFlag&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;No&quot;</span><span class="p">),</span>
</span><span id="L-487"><a href="#-487"><span class="linenos"> 487</span></a>            <span class="p">])</span>
</span><span id="L-488"><a href="#-488"><span class="linenos"> 488</span></a>
</span><span id="L-489"><a href="#-489"><span class="linenos"> 489</span></a>            <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;|                                                         |</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-490"><a href="#-490"><span class="linenos"> 490</span></a>
</span><span id="L-491"><a href="#-491"><span class="linenos"> 491</span></a>            <span class="k">if</span> <span class="s2">&quot;type&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]:</span>
</span><span id="L-492"><a href="#-492"><span class="linenos"> 492</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Type of the instrument:                                 | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]))</span>
</span><span id="L-493"><a href="#-493"><span class="linenos"> 493</span></a>
</span><span id="L-494"><a href="#-494"><span class="linenos"> 494</span></a>            <span class="k">if</span> <span class="s2">&quot;futuresType&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;futuresType&quot;</span><span class="p">]:</span>
</span><span id="L-495"><a href="#-495"><span class="linenos"> 495</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Futures type:                                           | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;futuresType&quot;</span><span class="p">]))</span>
</span><span id="L-496"><a href="#-496"><span class="linenos"> 496</span></a>
</span><span id="L-497"><a href="#-497"><span class="linenos"> 497</span></a>            <span class="k">if</span> <span class="s2">&quot;ipoDate&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;ipoDate&quot;</span><span class="p">]:</span>
</span><span id="L-498"><a href="#-498"><span class="linenos"> 498</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| IPO date:                                               | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;ipoDate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
</span><span id="L-499"><a href="#-499"><span class="linenos"> 499</span></a>
</span><span id="L-500"><a href="#-500"><span class="linenos"> 500</span></a>            <span class="k">if</span> <span class="s2">&quot;releasedDate&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;releasedDate&quot;</span><span class="p">]:</span>
</span><span id="L-501"><a href="#-501"><span class="linenos"> 501</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Released date:                                          | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;releasedDate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
</span><span id="L-502"><a href="#-502"><span class="linenos"> 502</span></a>
</span><span id="L-503"><a href="#-503"><span class="linenos"> 503</span></a>            <span class="k">if</span> <span class="s2">&quot;rebalancingFreq&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;rebalancingFreq&quot;</span><span class="p">]:</span>
</span><span id="L-504"><a href="#-504"><span class="linenos"> 504</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Rebalancing frequency:                                  | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;rebalancingFreq&quot;</span><span class="p">]))</span>
</span><span id="L-505"><a href="#-505"><span class="linenos"> 505</span></a>
</span><span id="L-506"><a href="#-506"><span class="linenos"> 506</span></a>            <span class="k">if</span> <span class="s2">&quot;focusType&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;focusType&quot;</span><span class="p">]:</span>
</span><span id="L-507"><a href="#-507"><span class="linenos"> 507</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Focusing type:                                          | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;focusType&quot;</span><span class="p">]))</span>
</span><span id="L-508"><a href="#-508"><span class="linenos"> 508</span></a>
</span><span id="L-509"><a href="#-509"><span class="linenos"> 509</span></a>            <span class="k">if</span> <span class="s2">&quot;assetType&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;assetType&quot;</span><span class="p">]:</span>
</span><span id="L-510"><a href="#-510"><span class="linenos"> 510</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Asset type:                                             | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;assetType&quot;</span><span class="p">]))</span>
</span><span id="L-511"><a href="#-511"><span class="linenos"> 511</span></a>
</span><span id="L-512"><a href="#-512"><span class="linenos"> 512</span></a>            <span class="k">if</span> <span class="s2">&quot;basicAsset&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;basicAsset&quot;</span><span class="p">]:</span>
</span><span id="L-513"><a href="#-513"><span class="linenos"> 513</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Basic asset:                                            | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;basicAsset&quot;</span><span class="p">]))</span>
</span><span id="L-514"><a href="#-514"><span class="linenos"> 514</span></a>
</span><span id="L-515"><a href="#-515"><span class="linenos"> 515</span></a>            <span class="k">if</span> <span class="s2">&quot;basicAssetSize&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;basicAssetSize&quot;</span><span class="p">]:</span>
</span><span id="L-516"><a href="#-516"><span class="linenos"> 516</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Basic asset size:                                       | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">NanoToFloat</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;basicAssetSize&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">]),</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;basicAssetSize&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])))</span>
</span><span id="L-517"><a href="#-517"><span class="linenos"> 517</span></a>
</span><span id="L-518"><a href="#-518"><span class="linenos"> 518</span></a>            <span class="k">if</span> <span class="s2">&quot;isoCurrencyName&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;isoCurrencyName&quot;</span><span class="p">]:</span>
</span><span id="L-519"><a href="#-519"><span class="linenos"> 519</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| ISO currency name:                                      | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;isoCurrencyName&quot;</span><span class="p">]))</span>
</span><span id="L-520"><a href="#-520"><span class="linenos"> 520</span></a>
</span><span id="L-521"><a href="#-521"><span class="linenos"> 521</span></a>            <span class="k">if</span> <span class="s2">&quot;currency&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-522"><a href="#-522"><span class="linenos"> 522</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Payment currency:                                       | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">]))</span>
</span><span id="L-523"><a href="#-523"><span class="linenos"> 523</span></a>
</span><span id="L-524"><a href="#-524"><span class="linenos"> 524</span></a>            <span class="k">if</span> <span class="s2">&quot;firstTradeDate&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;firstTradeDate&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-525"><a href="#-525"><span class="linenos"> 525</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| First trade date:                                       | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;firstTradeDate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
</span><span id="L-526"><a href="#-526"><span class="linenos"> 526</span></a>
</span><span id="L-527"><a href="#-527"><span class="linenos"> 527</span></a>            <span class="k">if</span> <span class="s2">&quot;lastTradeDate&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;lastTradeDate&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-528"><a href="#-528"><span class="linenos"> 528</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Last trade date:                                        | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;lastTradeDate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
</span><span id="L-529"><a href="#-529"><span class="linenos"> 529</span></a>
</span><span id="L-530"><a href="#-530"><span class="linenos"> 530</span></a>            <span class="k">if</span> <span class="s2">&quot;expirationDate&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;expirationDate&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-531"><a href="#-531"><span class="linenos"> 531</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Date of expiration:                                     | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;expirationDate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
</span><span id="L-532"><a href="#-532"><span class="linenos"> 532</span></a>
</span><span id="L-533"><a href="#-533"><span class="linenos"> 533</span></a>            <span class="k">if</span> <span class="s2">&quot;stateRegDate&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;stateRegDate&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-534"><a href="#-534"><span class="linenos"> 534</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| State registration date:                                | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;stateRegDate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
</span><span id="L-535"><a href="#-535"><span class="linenos"> 535</span></a>
</span><span id="L-536"><a href="#-536"><span class="linenos"> 536</span></a>            <span class="k">if</span> <span class="s2">&quot;placementDate&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;placementDate&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-537"><a href="#-537"><span class="linenos"> 537</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Placement date:                                         | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;placementDate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
</span><span id="L-538"><a href="#-538"><span class="linenos"> 538</span></a>
</span><span id="L-539"><a href="#-539"><span class="linenos"> 539</span></a>            <span class="k">if</span> <span class="s2">&quot;maturityDate&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;maturityDate&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-540"><a href="#-540"><span class="linenos"> 540</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Maturity date:                                          | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;maturityDate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
</span><span id="L-541"><a href="#-541"><span class="linenos"> 541</span></a>
</span><span id="L-542"><a href="#-542"><span class="linenos"> 542</span></a>            <span class="k">if</span> <span class="s2">&quot;perpetualFlag&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;perpetualFlag&quot;</span><span class="p">]:</span>
</span><span id="L-543"><a href="#-543"><span class="linenos"> 543</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Perpetual bond:                                         | Yes</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-544"><a href="#-544"><span class="linenos"> 544</span></a>
</span><span id="L-545"><a href="#-545"><span class="linenos"> 545</span></a>            <span class="k">if</span> <span class="s2">&quot;otcFlag&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;otcFlag&quot;</span><span class="p">]:</span>
</span><span id="L-546"><a href="#-546"><span class="linenos"> 546</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Over-the-counter (OTC) securities:                      | Yes</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-547"><a href="#-547"><span class="linenos"> 547</span></a>
</span><span id="L-548"><a href="#-548"><span class="linenos"> 548</span></a>            <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Bond&quot;</span><span class="p">:</span>
</span><span id="L-549"><a href="#-549"><span class="linenos"> 549</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Bond issue (size / plan):                               | </span><span class="si">{}</span><span class="s2"> / </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;issueSize&quot;</span><span class="p">],</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;issueSizePlan&quot;</span><span class="p">]))</span>
</span><span id="L-550"><a href="#-550"><span class="linenos"> 550</span></a>
</span><span id="L-551"><a href="#-551"><span class="linenos"> 551</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Nominal price (100%):                                   | </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-552"><a href="#-552"><span class="linenos"> 552</span></a>                    <span class="n">NanoToFloat</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;nominal&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">]),</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;nominal&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">]),</span>
</span><span id="L-553"><a href="#-553"><span class="linenos"> 553</span></a>                    <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;nominal&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="L-554"><a href="#-554"><span class="linenos"> 554</span></a>                <span class="p">))</span>
</span><span id="L-555"><a href="#-555"><span class="linenos"> 555</span></a>
</span><span id="L-556"><a href="#-556"><span class="linenos"> 556</span></a>                <span class="k">if</span> <span class="s2">&quot;floatingCouponFlag&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-557"><a href="#-557"><span class="linenos"> 557</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Floating coupon:                                        | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Yes&quot;</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;floatingCouponFlag&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;No&quot;</span><span class="p">))</span>
</span><span id="L-558"><a href="#-558"><span class="linenos"> 558</span></a>
</span><span id="L-559"><a href="#-559"><span class="linenos"> 559</span></a>                <span class="k">if</span> <span class="s2">&quot;amortizationFlag&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-560"><a href="#-560"><span class="linenos"> 560</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Amortization:                                           | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Yes&quot;</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;amortizationFlag&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;No&quot;</span><span class="p">))</span>
</span><span id="L-561"><a href="#-561"><span class="linenos"> 561</span></a>
</span><span id="L-562"><a href="#-562"><span class="linenos"> 562</span></a>                <span class="k">if</span> <span class="s2">&quot;couponQuantityPerYear&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;couponQuantityPerYear&quot;</span><span class="p">]:</span>
</span><span id="L-563"><a href="#-563"><span class="linenos"> 563</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Number of coupon payments per year:                     | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;couponQuantityPerYear&quot;</span><span class="p">]))</span>
</span><span id="L-564"><a href="#-564"><span class="linenos"> 564</span></a>
</span><span id="L-565"><a href="#-565"><span class="linenos"> 565</span></a>                <span class="k">if</span> <span class="s2">&quot;aciValue&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;aciValue&quot;</span><span class="p">]:</span>
</span><span id="L-566"><a href="#-566"><span class="linenos"> 566</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Current ACI (Accrued Interest):                         | </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-567"><a href="#-567"><span class="linenos"> 567</span></a>                        <span class="n">NanoToFloat</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;aciValue&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">]),</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;aciValue&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">]),</span>
</span><span id="L-568"><a href="#-568"><span class="linenos"> 568</span></a>                        <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;aciValue&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span>
</span><span id="L-569"><a href="#-569"><span class="linenos"> 569</span></a>                    <span class="p">))</span>
</span><span id="L-570"><a href="#-570"><span class="linenos"> 570</span></a>
</span><span id="L-571"><a href="#-571"><span class="linenos"> 571</span></a>            <span class="k">if</span> <span class="s2">&quot;currentPrice&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-572"><a href="#-572"><span class="linenos"> 572</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;|                                                         |</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-573"><a href="#-573"><span class="linenos"> 573</span></a>
</span><span id="L-574"><a href="#-574"><span class="linenos"> 574</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span><span id="L-575"><a href="#-575"><span class="linenos"> 575</span></a>                    <span class="s2">&quot;| Previous close price of the instrument:                 | </span><span class="si">{}{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-576"><a href="#-576"><span class="linenos"> 576</span></a>                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;closePrice&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;closePrice&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span>
</span><span id="L-577"><a href="#-577"><span class="linenos"> 577</span></a>                        <span class="s2">&quot;</span><span class="si">% o</span><span class="s2">f nominal price&quot;</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Bond&quot;</span> <span class="k">else</span> <span class="s2">&quot; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;currency&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
</span><span id="L-578"><a href="#-578"><span class="linenos"> 578</span></a>                    <span class="p">),</span>
</span><span id="L-579"><a href="#-579"><span class="linenos"> 579</span></a>                    <span class="s2">&quot;| Last deal price of the instrument:                      | </span><span class="si">{}{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-580"><a href="#-580"><span class="linenos"> 580</span></a>                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span>
</span><span id="L-581"><a href="#-581"><span class="linenos"> 581</span></a>                        <span class="s2">&quot;</span><span class="si">% o</span><span class="s2">f nominal price&quot;</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Bond&quot;</span> <span class="k">else</span> <span class="s2">&quot; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;currency&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
</span><span id="L-582"><a href="#-582"><span class="linenos"> 582</span></a>                    <span class="p">),</span>
</span><span id="L-583"><a href="#-583"><span class="linenos"> 583</span></a>                    <span class="s2">&quot;| Changes between last deal price and last close  %       | </span><span class="si">{:.2f}</span><span class="s2">%</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;changes&quot;</span><span class="p">]),</span>
</span><span id="L-584"><a href="#-584"><span class="linenos"> 584</span></a>                    <span class="s2">&quot;| Current limit price, min / max:                         | </span><span class="si">{}{}</span><span class="s2"> / </span><span class="si">{}{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-585"><a href="#-585"><span class="linenos"> 585</span></a>                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;limitDown&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;limitDown&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span>
</span><span id="L-586"><a href="#-586"><span class="linenos"> 586</span></a>                        <span class="s2">&quot;%&quot;</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Bond&quot;</span> <span class="k">else</span> <span class="s2">&quot; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;currency&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
</span><span id="L-587"><a href="#-587"><span class="linenos"> 587</span></a>                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;limitUp&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;limitUp&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span>
</span><span id="L-588"><a href="#-588"><span class="linenos"> 588</span></a>                        <span class="s2">&quot;%&quot;</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Bond&quot;</span> <span class="k">else</span> <span class="s2">&quot; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;currency&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
</span><span id="L-589"><a href="#-589"><span class="linenos"> 589</span></a>                    <span class="p">),</span>
</span><span id="L-590"><a href="#-590"><span class="linenos"> 590</span></a>                    <span class="s2">&quot;| Actual price, sell / buy:                               | </span><span class="si">{}{}</span><span class="s2"> / </span><span class="si">{}{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-591"><a href="#-591"><span class="linenos"> 591</span></a>                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;sell&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;price&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;sell&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span>
</span><span id="L-592"><a href="#-592"><span class="linenos"> 592</span></a>                        <span class="s2">&quot;%&quot;</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Bond&quot;</span> <span class="k">else</span> <span class="s2">&quot; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;currency&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
</span><span id="L-593"><a href="#-593"><span class="linenos"> 593</span></a>                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;buy&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;price&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;buy&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span>
</span><span id="L-594"><a href="#-594"><span class="linenos"> 594</span></a>                        <span class="s2">&quot;%&quot;</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Bond&quot;</span> <span class="k">else</span><span class="s2">&quot; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;currency&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
</span><span id="L-595"><a href="#-595"><span class="linenos"> 595</span></a>                    <span class="p">),</span>
</span><span id="L-596"><a href="#-596"><span class="linenos"> 596</span></a>                <span class="p">])</span>
</span><span id="L-597"><a href="#-597"><span class="linenos"> 597</span></a>
</span><span id="L-598"><a href="#-598"><span class="linenos"> 598</span></a>            <span class="k">if</span> <span class="s2">&quot;lot&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-599"><a href="#-599"><span class="linenos"> 599</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Minimum lot to buy:                                     | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;lot&quot;</span><span class="p">]))</span>
</span><span id="L-600"><a href="#-600"><span class="linenos"> 600</span></a>
</span><span id="L-601"><a href="#-601"><span class="linenos"> 601</span></a>            <span class="k">if</span> <span class="s2">&quot;step&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-602"><a href="#-602"><span class="linenos"> 602</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Minimum price increment (step):                         | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">]))</span>
</span><span id="L-603"><a href="#-603"><span class="linenos"> 603</span></a>
</span><span id="L-604"><a href="#-604"><span class="linenos"> 604</span></a>            <span class="n">infoText</span> <span class="o">+=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
</span><span id="L-605"><a href="#-605"><span class="linenos"> 605</span></a>
</span><span id="L-606"><a href="#-606"><span class="linenos"> 606</span></a>            <span class="k">if</span> <span class="n">printInfo</span><span class="p">:</span>
</span><span id="L-607"><a href="#-607"><span class="linenos"> 607</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Information about instrument: ticker [</span><span class="si">{}</span><span class="s2">], FIGI [</span><span class="si">{}</span><span class="s2">]</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">],</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">],</span> <span class="n">infoText</span><span class="p">))</span>
</span><span id="L-608"><a href="#-608"><span class="linenos"> 608</span></a>
</span><span id="L-609"><a href="#-609"><span class="linenos"> 609</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-610"><a href="#-610"><span class="linenos"> 610</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Information about instrument: ticker [</span><span class="si">{}</span><span class="s2">], FIGI [</span><span class="si">{}</span><span class="s2">]</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">],</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">],</span> <span class="n">infoText</span><span class="p">))</span>
</span><span id="L-611"><a href="#-611"><span class="linenos"> 611</span></a>
</span><span id="L-612"><a href="#-612"><span class="linenos"> 612</span></a>        <span class="k">return</span> <span class="n">infoText</span>
</span><span id="L-613"><a href="#-613"><span class="linenos"> 613</span></a>
</span><span id="L-614"><a href="#-614"><span class="linenos"> 614</span></a>    <span class="k">def</span> <span class="nf">SearchByTicker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requestPrice</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">showInfo</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="L-615"><a href="#-615"><span class="linenos"> 615</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-616"><a href="#-616"><span class="linenos"> 616</span></a><span class="sd">        Search and return raw broker&#39;s information about instrument by it&#39;s ticker.</span>
</span><span id="L-617"><a href="#-617"><span class="linenos"> 617</span></a><span class="sd">        `ticker` must be define! If debug=True then print all debug messages.</span>
</span><span id="L-618"><a href="#-618"><span class="linenos"> 618</span></a>
</span><span id="L-619"><a href="#-619"><span class="linenos"> 619</span></a><span class="sd">        :param requestPrice: if `False` then do not request current price of instrument (because this is long operation).</span>
</span><span id="L-620"><a href="#-620"><span class="linenos"> 620</span></a><span class="sd">        :param showInfo: if `False` then do not run `ShowInstrumentInfo()` method and do not print info to the console.</span>
</span><span id="L-621"><a href="#-621"><span class="linenos"> 621</span></a><span class="sd">        :param debug: if `True` then print all debug console messages.</span>
</span><span id="L-622"><a href="#-622"><span class="linenos"> 622</span></a><span class="sd">        :return: JSON formatted data with information about instrument.</span>
</span><span id="L-623"><a href="#-623"><span class="linenos"> 623</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-624"><a href="#-624"><span class="linenos"> 624</span></a>        <span class="n">tickerJSON</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-625"><a href="#-625"><span class="linenos"> 625</span></a>        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="L-626"><a href="#-626"><span class="linenos"> 626</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Searching information about instrument by it&#39;s ticker [</span><span class="si">{}</span><span class="s2">] ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">))</span>
</span><span id="L-627"><a href="#-627"><span class="linenos"> 627</span></a>
</span><span id="L-628"><a href="#-628"><span class="linenos"> 628</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">:</span>
</span><span id="L-629"><a href="#-629"><span class="linenos"> 629</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;self.ticker variable is not be empty!&quot;</span><span class="p">)</span>
</span><span id="L-630"><a href="#-630"><span class="linenos"> 630</span></a>
</span><span id="L-631"><a href="#-631"><span class="linenos"> 631</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-632"><a href="#-632"><span class="linenos"> 632</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">:</span>
</span><span id="L-633"><a href="#-633"><span class="linenos"> 633</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">iList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Listing</span><span class="p">()</span>
</span><span id="L-634"><a href="#-634"><span class="linenos"> 634</span></a>
</span><span id="L-635"><a href="#-635"><span class="linenos"> 635</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Shares&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-636"><a href="#-636"><span class="linenos"> 636</span></a>                <span class="n">tickerJSON</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Shares&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">]</span>
</span><span id="L-637"><a href="#-637"><span class="linenos"> 637</span></a>                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="L-638"><a href="#-638"><span class="linenos"> 638</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Ticker [</span><span class="si">{}</span><span class="s2">] found in stocks list&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">))</span>
</span><span id="L-639"><a href="#-639"><span class="linenos"> 639</span></a>
</span><span id="L-640"><a href="#-640"><span class="linenos"> 640</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Currencies&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-641"><a href="#-641"><span class="linenos"> 641</span></a>                <span class="n">tickerJSON</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Currencies&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">]</span>
</span><span id="L-642"><a href="#-642"><span class="linenos"> 642</span></a>                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="L-643"><a href="#-643"><span class="linenos"> 643</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Ticker [</span><span class="si">{}</span><span class="s2">] found in currencies list&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">))</span>
</span><span id="L-644"><a href="#-644"><span class="linenos"> 644</span></a>
</span><span id="L-645"><a href="#-645"><span class="linenos"> 645</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Bonds&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-646"><a href="#-646"><span class="linenos"> 646</span></a>                <span class="n">tickerJSON</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Bonds&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">]</span>
</span><span id="L-647"><a href="#-647"><span class="linenos"> 647</span></a>                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="L-648"><a href="#-648"><span class="linenos"> 648</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Ticker [</span><span class="si">{}</span><span class="s2">] found in bonds list&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">))</span>
</span><span id="L-649"><a href="#-649"><span class="linenos"> 649</span></a>
</span><span id="L-650"><a href="#-650"><span class="linenos"> 650</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Etfs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-651"><a href="#-651"><span class="linenos"> 651</span></a>                <span class="n">tickerJSON</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Etfs&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">]</span>
</span><span id="L-652"><a href="#-652"><span class="linenos"> 652</span></a>                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="L-653"><a href="#-653"><span class="linenos"> 653</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Ticker [</span><span class="si">{}</span><span class="s2">] found in etfs list&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">))</span>
</span><span id="L-654"><a href="#-654"><span class="linenos"> 654</span></a>
</span><span id="L-655"><a href="#-655"><span class="linenos"> 655</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Futures&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-656"><a href="#-656"><span class="linenos"> 656</span></a>                <span class="n">tickerJSON</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Futures&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">]</span>
</span><span id="L-657"><a href="#-657"><span class="linenos"> 657</span></a>                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="L-658"><a href="#-658"><span class="linenos"> 658</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Ticker [</span><span class="si">{}</span><span class="s2">] found in futures list&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">))</span>
</span><span id="L-659"><a href="#-659"><span class="linenos"> 659</span></a>
</span><span id="L-660"><a href="#-660"><span class="linenos"> 660</span></a>        <span class="k">if</span> <span class="n">tickerJSON</span><span class="p">:</span>
</span><span id="L-661"><a href="#-661"><span class="linenos"> 661</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">=</span> <span class="n">tickerJSON</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]</span>
</span><span id="L-662"><a href="#-662"><span class="linenos"> 662</span></a>
</span><span id="L-663"><a href="#-663"><span class="linenos"> 663</span></a>            <span class="k">if</span> <span class="n">requestPrice</span><span class="p">:</span>
</span><span id="L-664"><a href="#-664"><span class="linenos"> 664</span></a>                <span class="n">tickerJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetCurrentPrices</span><span class="p">(</span><span class="n">showPrice</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-665"><a href="#-665"><span class="linenos"> 665</span></a>
</span><span id="L-666"><a href="#-666"><span class="linenos"> 666</span></a>                <span class="k">if</span> <span class="n">tickerJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;closePrice&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tickerJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;closePrice&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">tickerJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-667"><a href="#-667"><span class="linenos"> 667</span></a>                    <span class="n">tickerJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;changes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">tickerJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">tickerJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;closePrice&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="n">tickerJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;closePrice&quot;</span><span class="p">]</span>
</span><span id="L-668"><a href="#-668"><span class="linenos"> 668</span></a>
</span><span id="L-669"><a href="#-669"><span class="linenos"> 669</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-670"><a href="#-670"><span class="linenos"> 670</span></a>                    <span class="n">tickerJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;changes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-671"><a href="#-671"><span class="linenos"> 671</span></a>
</span><span id="L-672"><a href="#-672"><span class="linenos"> 672</span></a>            <span class="k">if</span> <span class="n">showInfo</span><span class="p">:</span>
</span><span id="L-673"><a href="#-673"><span class="linenos"> 673</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">ShowInstrumentInfo</span><span class="p">(</span><span class="n">iJSON</span><span class="o">=</span><span class="n">tickerJSON</span><span class="p">,</span> <span class="n">printInfo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># print info as Markdown text</span>
</span><span id="L-674"><a href="#-674"><span class="linenos"> 674</span></a>
</span><span id="L-675"><a href="#-675"><span class="linenos"> 675</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-676"><a href="#-676"><span class="linenos"> 676</span></a>            <span class="k">if</span> <span class="n">showInfo</span><span class="p">:</span>
</span><span id="L-677"><a href="#-677"><span class="linenos"> 677</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Ticker [</span><span class="si">{}</span><span class="s2">] not found in available broker instrument&#39;s list!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">))</span>
</span><span id="L-678"><a href="#-678"><span class="linenos"> 678</span></a>
</span><span id="L-679"><a href="#-679"><span class="linenos"> 679</span></a>        <span class="k">return</span> <span class="n">tickerJSON</span>
</span><span id="L-680"><a href="#-680"><span class="linenos"> 680</span></a>
</span><span id="L-681"><a href="#-681"><span class="linenos"> 681</span></a>    <span class="k">def</span> <span class="nf">SearchByFIGI</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requestPrice</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">showInfo</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="L-682"><a href="#-682"><span class="linenos"> 682</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-683"><a href="#-683"><span class="linenos"> 683</span></a><span class="sd">        Search and return raw broker&#39;s information about instrument by it&#39;s FIGI.</span>
</span><span id="L-684"><a href="#-684"><span class="linenos"> 684</span></a><span class="sd">        `figi` must be define! If debug=True then print all debug messages.</span>
</span><span id="L-685"><a href="#-685"><span class="linenos"> 685</span></a>
</span><span id="L-686"><a href="#-686"><span class="linenos"> 686</span></a><span class="sd">        :param requestPrice: if `False` then do not request current price of instrument (it&#39;s long operation).</span>
</span><span id="L-687"><a href="#-687"><span class="linenos"> 687</span></a><span class="sd">        :param showInfo: if `False` then do not run `ShowInstrumentInfo()` method and do not print info to the console.</span>
</span><span id="L-688"><a href="#-688"><span class="linenos"> 688</span></a><span class="sd">        :param debug: if `True` then print all debug console messages.</span>
</span><span id="L-689"><a href="#-689"><span class="linenos"> 689</span></a><span class="sd">        :return: JSON formatted data with information about instrument.</span>
</span><span id="L-690"><a href="#-690"><span class="linenos"> 690</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-691"><a href="#-691"><span class="linenos"> 691</span></a>        <span class="n">figiJSON</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-692"><a href="#-692"><span class="linenos"> 692</span></a>        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="L-693"><a href="#-693"><span class="linenos"> 693</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Searching information about instrument by it&#39;s FIGI [</span><span class="si">{}</span><span class="s2">] ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">))</span>
</span><span id="L-694"><a href="#-694"><span class="linenos"> 694</span></a>
</span><span id="L-695"><a href="#-695"><span class="linenos"> 695</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">:</span>
</span><span id="L-696"><a href="#-696"><span class="linenos"> 696</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;self.figi variable is not be empty!&quot;</span><span class="p">)</span>
</span><span id="L-697"><a href="#-697"><span class="linenos"> 697</span></a>
</span><span id="L-698"><a href="#-698"><span class="linenos"> 698</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-699"><a href="#-699"><span class="linenos"> 699</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">:</span>
</span><span id="L-700"><a href="#-700"><span class="linenos"> 700</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">iList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Listing</span><span class="p">()</span>
</span><span id="L-701"><a href="#-701"><span class="linenos"> 701</span></a>
</span><span id="L-702"><a href="#-702"><span class="linenos"> 702</span></a>            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Shares&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-703"><a href="#-703"><span class="linenos"> 703</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Shares&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">][</span><span class="s2">&quot;figi&quot;</span><span class="p">]:</span>
</span><span id="L-704"><a href="#-704"><span class="linenos"> 704</span></a>                    <span class="n">figiJSON</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Shares&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">]</span>
</span><span id="L-705"><a href="#-705"><span class="linenos"> 705</span></a>
</span><span id="L-706"><a href="#-706"><span class="linenos"> 706</span></a>                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="L-707"><a href="#-707"><span class="linenos"> 707</span></a>                        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;FIGI [</span><span class="si">{}</span><span class="s2">] found in stocks list&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">))</span>
</span><span id="L-708"><a href="#-708"><span class="linenos"> 708</span></a>
</span><span id="L-709"><a href="#-709"><span class="linenos"> 709</span></a>                    <span class="k">break</span>
</span><span id="L-710"><a href="#-710"><span class="linenos"> 710</span></a>
</span><span id="L-711"><a href="#-711"><span class="linenos"> 711</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">figiJSON</span><span class="p">:</span>
</span><span id="L-712"><a href="#-712"><span class="linenos"> 712</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Currencies&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-713"><a href="#-713"><span class="linenos"> 713</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Currencies&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">][</span><span class="s2">&quot;figi&quot;</span><span class="p">]:</span>
</span><span id="L-714"><a href="#-714"><span class="linenos"> 714</span></a>                        <span class="n">figiJSON</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Currencies&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">]</span>
</span><span id="L-715"><a href="#-715"><span class="linenos"> 715</span></a>
</span><span id="L-716"><a href="#-716"><span class="linenos"> 716</span></a>                        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="L-717"><a href="#-717"><span class="linenos"> 717</span></a>                            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;FIGI [</span><span class="si">{}</span><span class="s2">] found in currencies list&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">))</span>
</span><span id="L-718"><a href="#-718"><span class="linenos"> 718</span></a>
</span><span id="L-719"><a href="#-719"><span class="linenos"> 719</span></a>                        <span class="k">break</span>
</span><span id="L-720"><a href="#-720"><span class="linenos"> 720</span></a>
</span><span id="L-721"><a href="#-721"><span class="linenos"> 721</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">figiJSON</span><span class="p">:</span>
</span><span id="L-722"><a href="#-722"><span class="linenos"> 722</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Bonds&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-723"><a href="#-723"><span class="linenos"> 723</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Bonds&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">][</span><span class="s2">&quot;figi&quot;</span><span class="p">]:</span>
</span><span id="L-724"><a href="#-724"><span class="linenos"> 724</span></a>                        <span class="n">figiJSON</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Bonds&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">]</span>
</span><span id="L-725"><a href="#-725"><span class="linenos"> 725</span></a>
</span><span id="L-726"><a href="#-726"><span class="linenos"> 726</span></a>                        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="L-727"><a href="#-727"><span class="linenos"> 727</span></a>                            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;FIGI [</span><span class="si">{}</span><span class="s2">] found in bonds list&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">))</span>
</span><span id="L-728"><a href="#-728"><span class="linenos"> 728</span></a>
</span><span id="L-729"><a href="#-729"><span class="linenos"> 729</span></a>                        <span class="k">break</span>
</span><span id="L-730"><a href="#-730"><span class="linenos"> 730</span></a>
</span><span id="L-731"><a href="#-731"><span class="linenos"> 731</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">figiJSON</span><span class="p">:</span>
</span><span id="L-732"><a href="#-732"><span class="linenos"> 732</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Etfs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-733"><a href="#-733"><span class="linenos"> 733</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Etfs&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">][</span><span class="s2">&quot;figi&quot;</span><span class="p">]:</span>
</span><span id="L-734"><a href="#-734"><span class="linenos"> 734</span></a>                        <span class="n">figiJSON</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Etfs&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">]</span>
</span><span id="L-735"><a href="#-735"><span class="linenos"> 735</span></a>
</span><span id="L-736"><a href="#-736"><span class="linenos"> 736</span></a>                        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="L-737"><a href="#-737"><span class="linenos"> 737</span></a>                            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;FIGI [</span><span class="si">{}</span><span class="s2">] found in etfs list&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">))</span>
</span><span id="L-738"><a href="#-738"><span class="linenos"> 738</span></a>
</span><span id="L-739"><a href="#-739"><span class="linenos"> 739</span></a>                        <span class="k">break</span>
</span><span id="L-740"><a href="#-740"><span class="linenos"> 740</span></a>
</span><span id="L-741"><a href="#-741"><span class="linenos"> 741</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">figiJSON</span><span class="p">:</span>
</span><span id="L-742"><a href="#-742"><span class="linenos"> 742</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Futures&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-743"><a href="#-743"><span class="linenos"> 743</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Futures&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">][</span><span class="s2">&quot;figi&quot;</span><span class="p">]:</span>
</span><span id="L-744"><a href="#-744"><span class="linenos"> 744</span></a>                        <span class="n">figiJSON</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Futures&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">]</span>
</span><span id="L-745"><a href="#-745"><span class="linenos"> 745</span></a>
</span><span id="L-746"><a href="#-746"><span class="linenos"> 746</span></a>                        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="L-747"><a href="#-747"><span class="linenos"> 747</span></a>                            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;FIGI [</span><span class="si">{}</span><span class="s2">] found in futures list&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">))</span>
</span><span id="L-748"><a href="#-748"><span class="linenos"> 748</span></a>
</span><span id="L-749"><a href="#-749"><span class="linenos"> 749</span></a>                        <span class="k">break</span>
</span><span id="L-750"><a href="#-750"><span class="linenos"> 750</span></a>
</span><span id="L-751"><a href="#-751"><span class="linenos"> 751</span></a>        <span class="k">if</span> <span class="n">figiJSON</span><span class="p">:</span>
</span><span id="L-752"><a href="#-752"><span class="linenos"> 752</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">=</span> <span class="n">figiJSON</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]</span>
</span><span id="L-753"><a href="#-753"><span class="linenos"> 753</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">figiJSON</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">]</span>
</span><span id="L-754"><a href="#-754"><span class="linenos"> 754</span></a>
</span><span id="L-755"><a href="#-755"><span class="linenos"> 755</span></a>            <span class="k">if</span> <span class="n">requestPrice</span><span class="p">:</span>
</span><span id="L-756"><a href="#-756"><span class="linenos"> 756</span></a>                <span class="n">figiJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetCurrentPrices</span><span class="p">(</span><span class="n">showPrice</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-757"><a href="#-757"><span class="linenos"> 757</span></a>
</span><span id="L-758"><a href="#-758"><span class="linenos"> 758</span></a>                <span class="k">if</span> <span class="n">figiJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;closePrice&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">figiJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;closePrice&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">figiJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-759"><a href="#-759"><span class="linenos"> 759</span></a>                    <span class="n">figiJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;changes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">figiJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">figiJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;closePrice&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="n">figiJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;closePrice&quot;</span><span class="p">]</span>
</span><span id="L-760"><a href="#-760"><span class="linenos"> 760</span></a>
</span><span id="L-761"><a href="#-761"><span class="linenos"> 761</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-762"><a href="#-762"><span class="linenos"> 762</span></a>                    <span class="n">figiJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;changes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-763"><a href="#-763"><span class="linenos"> 763</span></a>
</span><span id="L-764"><a href="#-764"><span class="linenos"> 764</span></a>            <span class="k">if</span> <span class="n">showInfo</span><span class="p">:</span>
</span><span id="L-765"><a href="#-765"><span class="linenos"> 765</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">ShowInstrumentInfo</span><span class="p">(</span><span class="n">iJSON</span><span class="o">=</span><span class="n">figiJSON</span><span class="p">,</span> <span class="n">printInfo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># print info as Markdown text</span>
</span><span id="L-766"><a href="#-766"><span class="linenos"> 766</span></a>
</span><span id="L-767"><a href="#-767"><span class="linenos"> 767</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-768"><a href="#-768"><span class="linenos"> 768</span></a>            <span class="k">if</span> <span class="n">showInfo</span><span class="p">:</span>
</span><span id="L-769"><a href="#-769"><span class="linenos"> 769</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;FIGI [</span><span class="si">{}</span><span class="s2">] not found in available broker instrument&#39;s list!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">))</span>
</span><span id="L-770"><a href="#-770"><span class="linenos"> 770</span></a>
</span><span id="L-771"><a href="#-771"><span class="linenos"> 771</span></a>        <span class="k">return</span> <span class="n">figiJSON</span>
</span><span id="L-772"><a href="#-772"><span class="linenos"> 772</span></a>
</span><span id="L-773"><a href="#-773"><span class="linenos"> 773</span></a>    <span class="k">def</span> <span class="nf">GetCurrentPrices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">showPrice</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="L-774"><a href="#-774"><span class="linenos"> 774</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-775"><a href="#-775"><span class="linenos"> 775</span></a><span class="sd">        Get and show Depth of Market with current prices of the instrument. If an error occurred then returns an empty record:</span>
</span><span id="L-776"><a href="#-776"><span class="linenos"> 776</span></a><span class="sd">        `{&quot;buy&quot;: [], &quot;sell&quot;: [], &quot;limitUp&quot;: None, &quot;limitDown&quot;: None, &quot;lastPrice&quot;: None, &quot;closePrice&quot;: None}`.</span>
</span><span id="L-777"><a href="#-777"><span class="linenos"> 777</span></a>
</span><span id="L-778"><a href="#-778"><span class="linenos"> 778</span></a><span class="sd">        :param showPrice: if `True` then print DOM.</span>
</span><span id="L-779"><a href="#-779"><span class="linenos"> 779</span></a><span class="sd">        :return: dict with Depth of Market (DOM): `{&quot;buy&quot;: [{&quot;price&quot;: x1, &quot;quantity&quot;: y1, ...}], &quot;sell&quot;: [....]}` with list of current prices.</span>
</span><span id="L-780"><a href="#-780"><span class="linenos"> 780</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-781"><a href="#-781"><span class="linenos"> 781</span></a>        <span class="n">prices</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;buy&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;sell&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;limitUp&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;limitDown&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;lastPrice&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;closePrice&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
</span><span id="L-782"><a href="#-782"><span class="linenos"> 782</span></a>
</span><span id="L-783"><a href="#-783"><span class="linenos"> 783</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-784"><a href="#-784"><span class="linenos"> 784</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Depth of Market (DOM) must be &gt;=1!&quot;</span><span class="p">)</span>
</span><span id="L-785"><a href="#-785"><span class="linenos"> 785</span></a>
</span><span id="L-786"><a href="#-786"><span class="linenos"> 786</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">):</span>
</span><span id="L-787"><a href="#-787"><span class="linenos"> 787</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;self.ticker or self.figi variables must be defined!&quot;</span><span class="p">)</span>
</span><span id="L-788"><a href="#-788"><span class="linenos"> 788</span></a>
</span><span id="L-789"><a href="#-789"><span class="linenos"> 789</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">:</span>
</span><span id="L-790"><a href="#-790"><span class="linenos"> 790</span></a>            <span class="n">instrumentByTicker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SearchByTicker</span><span class="p">(</span><span class="n">requestPrice</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># WARNING! requestPrice=False to avoid recursion!</span>
</span><span id="L-791"><a href="#-791"><span class="linenos"> 791</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">=</span> <span class="n">instrumentByTicker</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">instrumentByTicker</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
</span><span id="L-792"><a href="#-792"><span class="linenos"> 792</span></a>
</span><span id="L-793"><a href="#-793"><span class="linenos"> 793</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">:</span>
</span><span id="L-794"><a href="#-794"><span class="linenos"> 794</span></a>            <span class="n">instrumentByFigi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SearchByFIGI</span><span class="p">(</span><span class="n">requestPrice</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># WARNING! requestPrice=False to avoid recursion!</span>
</span><span id="L-795"><a href="#-795"><span class="linenos"> 795</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">instrumentByFigi</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">instrumentByFigi</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
</span><span id="L-796"><a href="#-796"><span class="linenos"> 796</span></a>
</span><span id="L-797"><a href="#-797"><span class="linenos"> 797</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">:</span>
</span><span id="L-798"><a href="#-798"><span class="linenos"> 798</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Requesting current prices for instrument with ticker [</span><span class="si">{}</span><span class="s2">] and FIGI [</span><span class="si">{}</span><span class="s2">]...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">))</span>
</span><span id="L-799"><a href="#-799"><span class="linenos"> 799</span></a>
</span><span id="L-800"><a href="#-800"><span class="linenos"> 800</span></a>            <span class="c1"># REST API for request: https://tinkoff.github.io/investAPI/swagger-ui/#/MarketDataService/MarketDataService_GetOrderBook</span>
</span><span id="L-801"><a href="#-801"><span class="linenos"> 801</span></a>            <span class="n">priceURL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;/tinkoff.public.invest.api.contract.v1.MarketDataService/GetOrderBook&quot;</span>
</span><span id="L-802"><a href="#-802"><span class="linenos"> 802</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="nb">str</span><span class="p">({</span><span class="s2">&quot;figi&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">,</span> <span class="s2">&quot;depth&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">})</span>
</span><span id="L-803"><a href="#-803"><span class="linenos"> 803</span></a>            <span class="n">pricesResponse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SendAPIRequest</span><span class="p">(</span><span class="n">priceURL</span><span class="p">,</span> <span class="n">reqType</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">)</span>
</span><span id="L-804"><a href="#-804"><span class="linenos"> 804</span></a>
</span><span id="L-805"><a href="#-805"><span class="linenos"> 805</span></a>            <span class="k">if</span> <span class="n">pricesResponse</span><span class="p">:</span>
</span><span id="L-806"><a href="#-806"><span class="linenos"> 806</span></a>                <span class="c1"># list of dicts with sellers orders:</span>
</span><span id="L-807"><a href="#-807"><span class="linenos"> 807</span></a>                <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;buy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">]),</span> <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;quantity&quot;</span><span class="p">])}</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">pricesResponse</span><span class="p">[</span><span class="s2">&quot;asks&quot;</span><span class="p">]]</span>
</span><span id="L-808"><a href="#-808"><span class="linenos"> 808</span></a>
</span><span id="L-809"><a href="#-809"><span class="linenos"> 809</span></a>                <span class="c1"># list of dicts with buyers orders:</span>
</span><span id="L-810"><a href="#-810"><span class="linenos"> 810</span></a>                <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;sell&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">]),</span> <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;quantity&quot;</span><span class="p">])}</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">pricesResponse</span><span class="p">[</span><span class="s2">&quot;bids&quot;</span><span class="p">]]</span>
</span><span id="L-811"><a href="#-811"><span class="linenos"> 811</span></a>
</span><span id="L-812"><a href="#-812"><span class="linenos"> 812</span></a>                <span class="c1"># max price of instrument at this time:</span>
</span><span id="L-813"><a href="#-813"><span class="linenos"> 813</span></a>                <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;limitUp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">pricesResponse</span><span class="p">[</span><span class="s2">&quot;limitUp&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">pricesResponse</span><span class="p">[</span><span class="s2">&quot;limitUp&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;limitUp&quot;</span> <span class="ow">in</span> <span class="n">pricesResponse</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-814"><a href="#-814"><span class="linenos"> 814</span></a>
</span><span id="L-815"><a href="#-815"><span class="linenos"> 815</span></a>                <span class="c1"># min price of instrument at this time:</span>
</span><span id="L-816"><a href="#-816"><span class="linenos"> 816</span></a>                <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;limitDown&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">pricesResponse</span><span class="p">[</span><span class="s2">&quot;limitDown&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">pricesResponse</span><span class="p">[</span><span class="s2">&quot;limitDown&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;limitDown&quot;</span> <span class="ow">in</span> <span class="n">pricesResponse</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-817"><a href="#-817"><span class="linenos"> 817</span></a>
</span><span id="L-818"><a href="#-818"><span class="linenos"> 818</span></a>                <span class="c1"># last price of deal with instrument:</span>
</span><span id="L-819"><a href="#-819"><span class="linenos"> 819</span></a>                <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">pricesResponse</span><span class="p">[</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">pricesResponse</span><span class="p">[</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;lastPrice&quot;</span> <span class="ow">in</span> <span class="n">pricesResponse</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="L-820"><a href="#-820"><span class="linenos"> 820</span></a>
</span><span id="L-821"><a href="#-821"><span class="linenos"> 821</span></a>                <span class="c1"># last close price of instrument:</span>
</span><span id="L-822"><a href="#-822"><span class="linenos"> 822</span></a>                <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;closePrice&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">pricesResponse</span><span class="p">[</span><span class="s2">&quot;closePrice&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">pricesResponse</span><span class="p">[</span><span class="s2">&quot;closePrice&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;closePrice&quot;</span> <span class="ow">in</span> <span class="n">pricesResponse</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="L-823"><a href="#-823"><span class="linenos"> 823</span></a>
</span><span id="L-824"><a href="#-824"><span class="linenos"> 824</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-825"><a href="#-825"><span class="linenos"> 825</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Server return an empty or error response! See full log. Instrument: ticker [</span><span class="si">{}</span><span class="s2">], FIGI [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">))</span>
</span><span id="L-826"><a href="#-826"><span class="linenos"> 826</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Server response: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pricesResponse</span><span class="p">))</span>
</span><span id="L-827"><a href="#-827"><span class="linenos"> 827</span></a>
</span><span id="L-828"><a href="#-828"><span class="linenos"> 828</span></a>            <span class="k">if</span> <span class="n">showPrice</span><span class="p">:</span>
</span><span id="L-829"><a href="#-829"><span class="linenos"> 829</span></a>                <span class="k">if</span> <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;buy&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;sell&quot;</span><span class="p">]:</span>
</span><span id="L-830"><a href="#-830"><span class="linenos"> 830</span></a>                    <span class="n">info</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-831"><a href="#-831"><span class="linenos"> 831</span></a>                        <span class="s2">&quot;Orders book actual at [</span><span class="si">{}</span><span class="s2">] (UTC)</span><span class="se">\n</span><span class="s2">Ticker: [</span><span class="si">{}</span><span class="s2">], FIGI: [</span><span class="si">{}</span><span class="s2">], Depth of Market: [</span><span class="si">{}</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-832"><a href="#-832"><span class="linenos"> 832</span></a>                            <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tzutc</span><span class="p">())</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">),</span>
</span><span id="L-833"><a href="#-833"><span class="linenos"> 833</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span>
</span><span id="L-834"><a href="#-834"><span class="linenos"> 834</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">,</span>
</span><span id="L-835"><a href="#-835"><span class="linenos"> 835</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span>
</span><span id="L-836"><a href="#-836"><span class="linenos"> 836</span></a>                        <span class="p">),</span>
</span><span id="L-837"><a href="#-837"><span class="linenos"> 837</span></a>                        <span class="n">uLog</span><span class="o">.</span><span class="n">sepShort</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-838"><a href="#-838"><span class="linenos"> 838</span></a>                        <span class="s2">&quot; Orders of Buyers   | Orders of Sellers</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-839"><a href="#-839"><span class="linenos"> 839</span></a>                        <span class="n">uLog</span><span class="o">.</span><span class="n">sepShort</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-840"><a href="#-840"><span class="linenos"> 840</span></a>                        <span class="s2">&quot; Sell prices (vol.) | Buy prices (vol.)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-841"><a href="#-841"><span class="linenos"> 841</span></a>                        <span class="n">uLog</span><span class="o">.</span><span class="n">sepShort</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-842"><a href="#-842"><span class="linenos"> 842</span></a>                    <span class="p">]</span>
</span><span id="L-843"><a href="#-843"><span class="linenos"> 843</span></a>
</span><span id="L-844"><a href="#-844"><span class="linenos"> 844</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;buy&quot;</span><span class="p">]:</span>
</span><span id="L-845"><a href="#-845"><span class="linenos"> 845</span></a>                        <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;                    | No orders!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-846"><a href="#-846"><span class="linenos"> 846</span></a>                        <span class="n">sumBuy</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-847"><a href="#-847"><span class="linenos"> 847</span></a>
</span><span id="L-848"><a href="#-848"><span class="linenos"> 848</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-849"><a href="#-849"><span class="linenos"> 849</span></a>                        <span class="n">sumBuy</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;quantity&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;buy&quot;</span><span class="p">]])</span>
</span><span id="L-850"><a href="#-850"><span class="linenos"> 850</span></a>                        <span class="n">maxMinSorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">prices</span><span class="p">[</span><span class="s2">&quot;buy&quot;</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">k</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-851"><a href="#-851"><span class="linenos"> 851</span></a>                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">maxMinSorted</span><span class="p">:</span>
</span><span id="L-852"><a href="#-852"><span class="linenos"> 852</span></a>                            <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;                    | </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;quantity&quot;</span><span class="p">]))</span>
</span><span id="L-853"><a href="#-853"><span class="linenos"> 853</span></a>
</span><span id="L-854"><a href="#-854"><span class="linenos"> 854</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;sell&quot;</span><span class="p">]:</span>
</span><span id="L-855"><a href="#-855"><span class="linenos"> 855</span></a>                        <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;No orders!          |</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-856"><a href="#-856"><span class="linenos"> 856</span></a>                        <span class="n">sumSell</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-857"><a href="#-857"><span class="linenos"> 857</span></a>
</span><span id="L-858"><a href="#-858"><span class="linenos"> 858</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-859"><a href="#-859"><span class="linenos"> 859</span></a>                        <span class="n">sumSell</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;quantity&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;sell&quot;</span><span class="p">]])</span>
</span><span id="L-860"><a href="#-860"><span class="linenos"> 860</span></a>                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;sell&quot;</span><span class="p">]:</span>
</span><span id="L-861"><a href="#-861"><span class="linenos"> 861</span></a>                            <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:&gt;19}</span><span class="s2"> |</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;quantity&quot;</span><span class="p">])))</span>
</span><span id="L-862"><a href="#-862"><span class="linenos"> 862</span></a>
</span><span id="L-863"><a href="#-863"><span class="linenos"> 863</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span><span id="L-864"><a href="#-864"><span class="linenos"> 864</span></a>                        <span class="n">uLog</span><span class="o">.</span><span class="n">sepShort</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-865"><a href="#-865"><span class="linenos"> 865</span></a>                        <span class="s2">&quot;</span><span class="si">{:&gt;19}</span><span class="s2"> | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Total sell: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sumSell</span><span class="p">),</span> <span class="s2">&quot;Total buy: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sumBuy</span><span class="p">)),</span>
</span><span id="L-866"><a href="#-866"><span class="linenos"> 866</span></a>                        <span class="n">uLog</span><span class="o">.</span><span class="n">sepShort</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-867"><a href="#-867"><span class="linenos"> 867</span></a>                    <span class="p">])</span>
</span><span id="L-868"><a href="#-868"><span class="linenos"> 868</span></a>
</span><span id="L-869"><a href="#-869"><span class="linenos"> 869</span></a>                    <span class="n">infoText</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
</span><span id="L-870"><a href="#-870"><span class="linenos"> 870</span></a>
</span><span id="L-871"><a href="#-871"><span class="linenos"> 871</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Current prices in order book:</span><span class="se">\n\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">infoText</span><span class="p">))</span>
</span><span id="L-872"><a href="#-872"><span class="linenos"> 872</span></a>
</span><span id="L-873"><a href="#-873"><span class="linenos"> 873</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-874"><a href="#-874"><span class="linenos"> 874</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Orders book is empty at this time! Instrument: ticker [</span><span class="si">{}</span><span class="s2">], FIGI [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">))</span>
</span><span id="L-875"><a href="#-875"><span class="linenos"> 875</span></a>
</span><span id="L-876"><a href="#-876"><span class="linenos"> 876</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-877"><a href="#-877"><span class="linenos"> 877</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;FIGI is not defined!&quot;</span><span class="p">)</span>
</span><span id="L-878"><a href="#-878"><span class="linenos"> 878</span></a>
</span><span id="L-879"><a href="#-879"><span class="linenos"> 879</span></a>        <span class="k">return</span> <span class="n">prices</span>
</span><span id="L-880"><a href="#-880"><span class="linenos"> 880</span></a>
</span><span id="L-881"><a href="#-881"><span class="linenos"> 881</span></a>    <span class="k">def</span> <span class="nf">ShowInstrumentsInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">showInstruments</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-882"><a href="#-882"><span class="linenos"> 882</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-883"><a href="#-883"><span class="linenos"> 883</span></a><span class="sd">        This method get and show information about all available broker instruments.</span>
</span><span id="L-884"><a href="#-884"><span class="linenos"> 884</span></a><span class="sd">        If `instrumentsFile` string is not empty then also save information to this file.</span>
</span><span id="L-885"><a href="#-885"><span class="linenos"> 885</span></a>
</span><span id="L-886"><a href="#-886"><span class="linenos"> 886</span></a><span class="sd">        :param showInstruments: if `True` then print to console, if `False` - print only to file.</span>
</span><span id="L-887"><a href="#-887"><span class="linenos"> 887</span></a><span class="sd">        :return: multi-string with all available broker instruments</span>
</span><span id="L-888"><a href="#-888"><span class="linenos"> 888</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-889"><a href="#-889"><span class="linenos"> 889</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">:</span>
</span><span id="L-890"><a href="#-890"><span class="linenos"> 890</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">iList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Listing</span><span class="p">()</span>
</span><span id="L-891"><a href="#-891"><span class="linenos"> 891</span></a>
</span><span id="L-892"><a href="#-892"><span class="linenos"> 892</span></a>        <span class="n">info</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-893"><a href="#-893"><span class="linenos"> 893</span></a>            <span class="s2">&quot;# All available instruments from Tinkoff Broker server for current user token</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-894"><a href="#-894"><span class="linenos"> 894</span></a>            <span class="s2">&quot;* **Actual on date:** [</span><span class="si">{}</span><span class="s2">] (UTC)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tzutc</span><span class="p">())</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M&quot;</span><span class="p">)),</span>
</span><span id="L-895"><a href="#-895"><span class="linenos"> 895</span></a>        <span class="p">]</span>
</span><span id="L-896"><a href="#-896"><span class="linenos"> 896</span></a>
</span><span id="L-897"><a href="#-897"><span class="linenos"> 897</span></a>        <span class="c1"># add instruments count by type:</span>
</span><span id="L-898"><a href="#-898"><span class="linenos"> 898</span></a>        <span class="k">for</span> <span class="n">iType</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-899"><a href="#-899"><span class="linenos"> 899</span></a>            <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;* **</span><span class="si">{}</span><span class="s2">:** [</span><span class="si">{}</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iType</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">])))</span>
</span><span id="L-900"><a href="#-900"><span class="linenos"> 900</span></a>
</span><span id="L-901"><a href="#-901"><span class="linenos"> 901</span></a>        <span class="n">headerLine</span> <span class="o">=</span> <span class="s2">&quot;| Ticker       | Full name                                                      | FIGI         | Cur | Lot    | Step</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-902"><a href="#-902"><span class="linenos"> 902</span></a>        <span class="n">splitLine</span> <span class="o">=</span> <span class="s2">&quot;|--------------|----------------------------------------------------------------|--------------|-----|--------|---------</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-903"><a href="#-903"><span class="linenos"> 903</span></a>
</span><span id="L-904"><a href="#-904"><span class="linenos"> 904</span></a>        <span class="c1"># generate info tables with all instruments by type:</span>
</span><span id="L-905"><a href="#-905"><span class="linenos"> 905</span></a>        <span class="k">for</span> <span class="n">iType</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-906"><a href="#-906"><span class="linenos"> 906</span></a>            <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">## </span><span class="si">{}</span><span class="s2"> available. Total: [</span><span class="si">{}</span><span class="s2">]</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iType</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">])),</span> <span class="n">headerLine</span><span class="p">,</span> <span class="n">splitLine</span><span class="p">])</span>
</span><span id="L-907"><a href="#-907"><span class="linenos"> 907</span></a>
</span><span id="L-908"><a href="#-908"><span class="linenos"> 908</span></a>            <span class="k">for</span> <span class="n">instrument</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-909"><a href="#-909"><span class="linenos"> 909</span></a>                <span class="n">iName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">][</span><span class="n">instrument</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>  <span class="c1"># instrument&#39;s name</span>
</span><span id="L-910"><a href="#-910"><span class="linenos"> 910</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">iName</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">63</span><span class="p">:</span>
</span><span id="L-911"><a href="#-911"><span class="linenos"> 911</span></a>                    <span class="n">iName</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iName</span><span class="p">[:</span><span class="mi">60</span><span class="p">])</span>  <span class="c1"># right trim for a long string</span>
</span><span id="L-912"><a href="#-912"><span class="linenos"> 912</span></a>    
</span><span id="L-913"><a href="#-913"><span class="linenos"> 913</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| </span><span class="si">{:&lt;12}</span><span class="s2"> | </span><span class="si">{:&lt;63}</span><span class="s2">| </span><span class="si">{:&lt;13}</span><span class="s2">| </span><span class="si">{:&lt;4}</span><span class="s2">| </span><span class="si">{:&lt;7}</span><span class="s2">| </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-914"><a href="#-914"><span class="linenos"> 914</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">][</span><span class="n">instrument</span><span class="p">][</span><span class="s2">&quot;ticker&quot;</span><span class="p">],</span>
</span><span id="L-915"><a href="#-915"><span class="linenos"> 915</span></a>                    <span class="n">iName</span><span class="p">,</span>
</span><span id="L-916"><a href="#-916"><span class="linenos"> 916</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">][</span><span class="n">instrument</span><span class="p">][</span><span class="s2">&quot;figi&quot;</span><span class="p">],</span>
</span><span id="L-917"><a href="#-917"><span class="linenos"> 917</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">][</span><span class="n">instrument</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="L-918"><a href="#-918"><span class="linenos"> 918</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">][</span><span class="n">instrument</span><span class="p">][</span><span class="s2">&quot;lot&quot;</span><span class="p">],</span>
</span><span id="L-919"><a href="#-919"><span class="linenos"> 919</span></a>                    <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">][</span><span class="n">instrument</span><span class="p">][</span><span class="s2">&quot;step&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">),</span>
</span><span id="L-920"><a href="#-920"><span class="linenos"> 920</span></a>                <span class="p">))</span>
</span><span id="L-921"><a href="#-921"><span class="linenos"> 921</span></a>
</span><span id="L-922"><a href="#-922"><span class="linenos"> 922</span></a>        <span class="n">infoText</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
</span><span id="L-923"><a href="#-923"><span class="linenos"> 923</span></a>
</span><span id="L-924"><a href="#-924"><span class="linenos"> 924</span></a>        <span class="k">if</span> <span class="n">showInstruments</span><span class="p">:</span>
</span><span id="L-925"><a href="#-925"><span class="linenos"> 925</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">infoText</span><span class="p">)</span>
</span><span id="L-926"><a href="#-926"><span class="linenos"> 926</span></a>
</span><span id="L-927"><a href="#-927"><span class="linenos"> 927</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrumentsFile</span><span class="p">:</span>
</span><span id="L-928"><a href="#-928"><span class="linenos"> 928</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instrumentsFile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fH</span><span class="p">:</span>
</span><span id="L-929"><a href="#-929"><span class="linenos"> 929</span></a>                <span class="n">fH</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">infoText</span><span class="p">)</span>
</span><span id="L-930"><a href="#-930"><span class="linenos"> 930</span></a>
</span><span id="L-931"><a href="#-931"><span class="linenos"> 931</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;All available instruments are saved to file: [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instrumentsFile</span><span class="p">)))</span>
</span><span id="L-932"><a href="#-932"><span class="linenos"> 932</span></a>
</span><span id="L-933"><a href="#-933"><span class="linenos"> 933</span></a>        <span class="k">return</span> <span class="n">infoText</span>
</span><span id="L-934"><a href="#-934"><span class="linenos"> 934</span></a>
</span><span id="L-935"><a href="#-935"><span class="linenos"> 935</span></a>    <span class="k">def</span> <span class="nf">GetListOfPrices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instruments</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">showPrices</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="L-936"><a href="#-936"><span class="linenos"> 936</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-937"><a href="#-937"><span class="linenos"> 937</span></a><span class="sd">        This method get, maybe show and return prices of list of instruments. WARNING! This is potential long operation!</span>
</span><span id="L-938"><a href="#-938"><span class="linenos"> 938</span></a><span class="sd">        See limits: https://tinkoff.github.io/investAPI/limits/</span>
</span><span id="L-939"><a href="#-939"><span class="linenos"> 939</span></a><span class="sd">        If `pricesFile` string is not empty then also save information to this file.</span>
</span><span id="L-940"><a href="#-940"><span class="linenos"> 940</span></a>
</span><span id="L-941"><a href="#-941"><span class="linenos"> 941</span></a><span class="sd">        :param instruments: list of tickers or FIGIs.</span>
</span><span id="L-942"><a href="#-942"><span class="linenos"> 942</span></a><span class="sd">        :param showPrices: if `True` then print to console, if `False` - print only to file.</span>
</span><span id="L-943"><a href="#-943"><span class="linenos"> 943</span></a><span class="sd">        :return: list of instruments looks like this: `iList = [{some ticker info, &quot;currentPrice&quot;: {current prices}}, {...}, ...]`</span>
</span><span id="L-944"><a href="#-944"><span class="linenos"> 944</span></a><span class="sd">                 One item is dict returned by `SearchByTicker()` or `SearchByFIGI()` methods.</span>
</span><span id="L-945"><a href="#-945"><span class="linenos"> 945</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-946"><a href="#-946"><span class="linenos"> 946</span></a>        <span class="k">if</span> <span class="n">instruments</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">instruments</span><span class="p">:</span>
</span><span id="L-947"><a href="#-947"><span class="linenos"> 947</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;You must define some of tickers or FIGIs to request it&#39;s actual prices!&quot;</span><span class="p">)</span>
</span><span id="L-948"><a href="#-948"><span class="linenos"> 948</span></a>
</span><span id="L-949"><a href="#-949"><span class="linenos"> 949</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Requesting current prices of list of instruments from Tinkoff Broker server...&quot;</span><span class="p">)</span>
</span><span id="L-950"><a href="#-950"><span class="linenos"> 950</span></a>
</span><span id="L-951"><a href="#-951"><span class="linenos"> 951</span></a>        <span class="n">iList</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-952"><a href="#-952"><span class="linenos"> 952</span></a>        <span class="k">for</span> <span class="n">iName</span> <span class="ow">in</span> <span class="n">instruments</span><span class="p">:</span>
</span><span id="L-953"><a href="#-953"><span class="linenos"> 953</span></a>            <span class="k">if</span> <span class="n">iName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">aliases</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-954"><a href="#-954"><span class="linenos"> 954</span></a>                <span class="n">iList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iName</span><span class="p">)</span>
</span><span id="L-955"><a href="#-955"><span class="linenos"> 955</span></a>
</span><span id="L-956"><a href="#-956"><span class="linenos"> 956</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-957"><a href="#-957"><span class="linenos"> 957</span></a>                <span class="n">iList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aliases</span><span class="p">[</span><span class="n">iName</span><span class="p">])</span>
</span><span id="L-958"><a href="#-958"><span class="linenos"> 958</span></a>
</span><span id="L-959"><a href="#-959"><span class="linenos"> 959</span></a>        <span class="n">unique</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># create list with every figi only one time with the same order position:</span>
</span><span id="L-960"><a href="#-960"><span class="linenos"> 960</span></a>        <span class="n">tempNames</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">iList</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">item</span> <span class="ow">in</span> <span class="n">unique</span> <span class="ow">or</span> <span class="n">unique</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">))]</span>
</span><span id="L-961"><a href="#-961"><span class="linenos"> 961</span></a>
</span><span id="L-962"><a href="#-962"><span class="linenos"> 962</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Ordered input list of instruments without duplicates of names: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tempNames</span><span class="p">))</span>
</span><span id="L-963"><a href="#-963"><span class="linenos"> 963</span></a>
</span><span id="L-964"><a href="#-964"><span class="linenos"> 964</span></a>        <span class="n">iList</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># try to get info about all unique instruments:</span>
</span><span id="L-965"><a href="#-965"><span class="linenos"> 965</span></a>        <span class="k">for</span> <span class="n">iName</span> <span class="ow">in</span> <span class="n">tempNames</span><span class="p">:</span>
</span><span id="L-966"><a href="#-966"><span class="linenos"> 966</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">iName</span>
</span><span id="L-967"><a href="#-967"><span class="linenos"> 967</span></a>            <span class="n">iData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SearchByTicker</span><span class="p">(</span><span class="n">requestPrice</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-968"><a href="#-968"><span class="linenos"> 968</span></a>
</span><span id="L-969"><a href="#-969"><span class="linenos"> 969</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">iData</span><span class="p">:</span>
</span><span id="L-970"><a href="#-970"><span class="linenos"> 970</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="L-971"><a href="#-971"><span class="linenos"> 971</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">=</span> <span class="n">iName</span>
</span><span id="L-972"><a href="#-972"><span class="linenos"> 972</span></a>
</span><span id="L-973"><a href="#-973"><span class="linenos"> 973</span></a>                <span class="n">iData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SearchByFIGI</span><span class="p">(</span><span class="n">requestPrice</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-974"><a href="#-974"><span class="linenos"> 974</span></a>
</span><span id="L-975"><a href="#-975"><span class="linenos"> 975</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">iData</span><span class="p">:</span>
</span><span id="L-976"><a href="#-976"><span class="linenos"> 976</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="L-977"><a href="#-977"><span class="linenos"> 977</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Instrument [</span><span class="si">{}</span><span class="s2">] not in list of available instruments for current token!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iName</span><span class="p">))</span>
</span><span id="L-978"><a href="#-978"><span class="linenos"> 978</span></a>
</span><span id="L-979"><a href="#-979"><span class="linenos"> 979</span></a>            <span class="k">if</span> <span class="n">iData</span><span class="p">:</span>
</span><span id="L-980"><a href="#-980"><span class="linenos"> 980</span></a>                <span class="n">isUnique</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-981"><a href="#-981"><span class="linenos"> 981</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">iList</span><span class="p">:</span>
</span><span id="L-982"><a href="#-982"><span class="linenos"> 982</span></a>                    <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">iData</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">iData</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">]:</span>
</span><span id="L-983"><a href="#-983"><span class="linenos"> 983</span></a>                        <span class="n">isUnique</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-984"><a href="#-984"><span class="linenos"> 984</span></a>                        <span class="k">break</span>
</span><span id="L-985"><a href="#-985"><span class="linenos"> 985</span></a>
</span><span id="L-986"><a href="#-986"><span class="linenos"> 986</span></a>                <span class="k">if</span> <span class="n">isUnique</span><span class="p">:</span>
</span><span id="L-987"><a href="#-987"><span class="linenos"> 987</span></a>                    <span class="n">iList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iData</span><span class="p">)</span>
</span><span id="L-988"><a href="#-988"><span class="linenos"> 988</span></a>
</span><span id="L-989"><a href="#-989"><span class="linenos"> 989</span></a>        <span class="k">if</span> <span class="n">showPrices</span><span class="p">:</span>
</span><span id="L-990"><a href="#-990"><span class="linenos"> 990</span></a>            <span class="n">info</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-991"><a href="#-991"><span class="linenos"> 991</span></a>                <span class="s2">&quot;# Actual prices at: [</span><span class="si">{}</span><span class="s2"> UTC]</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tzutc</span><span class="p">())</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M&quot;</span><span class="p">)),</span>
</span><span id="L-992"><a href="#-992"><span class="linenos"> 992</span></a>                <span class="s2">&quot;| Ticker       | FIGI         | Type       | Prev. close | Last price  | Chg. %   | Day limits min/max  | Actual sell / buy   | Curr.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-993"><a href="#-993"><span class="linenos"> 993</span></a>                <span class="s2">&quot;|--------------|--------------|------------|-------------|-------------|----------|---------------------|---------------------|------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-994"><a href="#-994"><span class="linenos"> 994</span></a>            <span class="p">]</span>
</span><span id="L-995"><a href="#-995"><span class="linenos"> 995</span></a>
</span><span id="L-996"><a href="#-996"><span class="linenos"> 996</span></a>            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">iList</span><span class="p">:</span>
</span><span id="L-997"><a href="#-997"><span class="linenos"> 997</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| </span><span class="si">{:&lt;12}</span><span class="s2"> | </span><span class="si">{:&lt;12}</span><span class="s2"> | </span><span class="si">{:&lt;10}</span><span class="s2"> | </span><span class="si">{:&gt;11}</span><span class="s2"> | </span><span class="si">{:&gt;11}</span><span class="s2"> | </span><span class="si">{:&gt;7}</span><span class="s2">% | </span><span class="si">{:&gt;19}</span><span class="s2"> | </span><span class="si">{:&gt;19}</span><span class="s2"> | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-998"><a href="#-998"><span class="linenos"> 998</span></a>                    <span class="n">item</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">],</span>
</span><span id="L-999"><a href="#-999"><span class="linenos"> 999</span></a>                    <span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">],</span>
</span><span id="L-1000"><a href="#-1000"><span class="linenos">1000</span></a>                    <span class="n">item</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span>
</span><span id="L-1001"><a href="#-1001"><span class="linenos">1001</span></a>                    <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;closePrice&quot;</span><span class="p">])),</span>
</span><span id="L-1002"><a href="#-1002"><span class="linenos">1002</span></a>                    <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">])),</span>
</span><span id="L-1003"><a href="#-1003"><span class="linenos">1003</span></a>                    <span class="s2">&quot;</span><span class="si">{}{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;changes&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;changes&quot;</span><span class="p">])),</span>
</span><span id="L-1004"><a href="#-1004"><span class="linenos">1004</span></a>                    <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> / </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-1005"><a href="#-1005"><span class="linenos">1005</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;limitDown&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;limitDown&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span>
</span><span id="L-1006"><a href="#-1006"><span class="linenos">1006</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;limitUp&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;limitUp&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span>
</span><span id="L-1007"><a href="#-1007"><span class="linenos">1007</span></a>                    <span class="p">),</span>
</span><span id="L-1008"><a href="#-1008"><span class="linenos">1008</span></a>                    <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> / </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-1009"><a href="#-1009"><span class="linenos">1009</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;sell&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;price&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;sell&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span>
</span><span id="L-1010"><a href="#-1010"><span class="linenos">1010</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;buy&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;price&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;buy&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span>
</span><span id="L-1011"><a href="#-1011"><span class="linenos">1011</span></a>                    <span class="p">),</span>
</span><span id="L-1012"><a href="#-1012"><span class="linenos">1012</span></a>                    <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="L-1013"><a href="#-1013"><span class="linenos">1013</span></a>                <span class="p">))</span>
</span><span id="L-1014"><a href="#-1014"><span class="linenos">1014</span></a>
</span><span id="L-1015"><a href="#-1015"><span class="linenos">1015</span></a>            <span class="n">infoText</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
</span><span id="L-1016"><a href="#-1016"><span class="linenos">1016</span></a>
</span><span id="L-1017"><a href="#-1017"><span class="linenos">1017</span></a>            <span class="k">if</span> <span class="n">showPrices</span><span class="p">:</span>
</span><span id="L-1018"><a href="#-1018"><span class="linenos">1018</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Only unique instruments are shown:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">infoText</span><span class="p">))</span>
</span><span id="L-1019"><a href="#-1019"><span class="linenos">1019</span></a>
</span><span id="L-1020"><a href="#-1020"><span class="linenos">1020</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pricesFile</span><span class="p">:</span>
</span><span id="L-1021"><a href="#-1021"><span class="linenos">1021</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pricesFile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fH</span><span class="p">:</span>
</span><span id="L-1022"><a href="#-1022"><span class="linenos">1022</span></a>                    <span class="n">fH</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">infoText</span><span class="p">)</span>
</span><span id="L-1023"><a href="#-1023"><span class="linenos">1023</span></a>
</span><span id="L-1024"><a href="#-1024"><span class="linenos">1024</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Price list for all instruments saved to file: [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pricesFile</span><span class="p">)))</span>
</span><span id="L-1025"><a href="#-1025"><span class="linenos">1025</span></a>
</span><span id="L-1026"><a href="#-1026"><span class="linenos">1026</span></a>        <span class="k">return</span> <span class="n">iList</span>
</span><span id="L-1027"><a href="#-1027"><span class="linenos">1027</span></a>
</span><span id="L-1028"><a href="#-1028"><span class="linenos">1028</span></a>    <span class="k">def</span> <span class="nf">RequestPortfolio</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="L-1029"><a href="#-1029"><span class="linenos">1029</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1030"><a href="#-1030"><span class="linenos">1030</span></a><span class="sd">        Requesting current actual user&#39;s portfolio.</span>
</span><span id="L-1031"><a href="#-1031"><span class="linenos">1031</span></a><span class="sd">        REST API for user portfolio: https://tinkoff.github.io/investAPI/swagger-ui/#/OperationsService/OperationsService_GetPortfolio</span>
</span><span id="L-1032"><a href="#-1032"><span class="linenos">1032</span></a>
</span><span id="L-1033"><a href="#-1033"><span class="linenos">1033</span></a><span class="sd">        :return: dictionary with user&#39;s portfolio.</span>
</span><span id="L-1034"><a href="#-1034"><span class="linenos">1034</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1035"><a href="#-1035"><span class="linenos">1035</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Requesting current actual user&#39;s portfolio. Wait, please...&quot;</span><span class="p">)</span>
</span><span id="L-1036"><a href="#-1036"><span class="linenos">1036</span></a>
</span><span id="L-1037"><a href="#-1037"><span class="linenos">1037</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="nb">str</span><span class="p">({</span><span class="s2">&quot;accountId&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">accountId</span><span class="p">})</span>
</span><span id="L-1038"><a href="#-1038"><span class="linenos">1038</span></a>        <span class="n">portfolioURL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;/tinkoff.public.invest.api.contract.v1.OperationsService/GetPortfolio&quot;</span>
</span><span id="L-1039"><a href="#-1039"><span class="linenos">1039</span></a>        <span class="n">rawPortfolio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SendAPIRequest</span><span class="p">(</span><span class="n">portfolioURL</span><span class="p">,</span> <span class="n">reqType</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">)</span>
</span><span id="L-1040"><a href="#-1040"><span class="linenos">1040</span></a>
</span><span id="L-1041"><a href="#-1041"><span class="linenos">1041</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Records about user&#39;s portfolio successfully received&quot;</span><span class="p">)</span>
</span><span id="L-1042"><a href="#-1042"><span class="linenos">1042</span></a>
</span><span id="L-1043"><a href="#-1043"><span class="linenos">1043</span></a>        <span class="k">return</span> <span class="n">rawPortfolio</span>
</span><span id="L-1044"><a href="#-1044"><span class="linenos">1044</span></a>
</span><span id="L-1045"><a href="#-1045"><span class="linenos">1045</span></a>    <span class="k">def</span> <span class="nf">RequestPositions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="L-1046"><a href="#-1046"><span class="linenos">1046</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1047"><a href="#-1047"><span class="linenos">1047</span></a><span class="sd">        Requesting current open positions in currencies and instruments.</span>
</span><span id="L-1048"><a href="#-1048"><span class="linenos">1048</span></a><span class="sd">        REST API for open positions: https://tinkoff.github.io/investAPI/swagger-ui/#/OperationsService/OperationsService_GetPositions</span>
</span><span id="L-1049"><a href="#-1049"><span class="linenos">1049</span></a>
</span><span id="L-1050"><a href="#-1050"><span class="linenos">1050</span></a><span class="sd">        :return: dictionary with open positions by instruments.</span>
</span><span id="L-1051"><a href="#-1051"><span class="linenos">1051</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1052"><a href="#-1052"><span class="linenos">1052</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Requesting current open positions in currencies and instruments. Wait, please...&quot;</span><span class="p">)</span>
</span><span id="L-1053"><a href="#-1053"><span class="linenos">1053</span></a>
</span><span id="L-1054"><a href="#-1054"><span class="linenos">1054</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="nb">str</span><span class="p">({</span><span class="s2">&quot;accountId&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">accountId</span><span class="p">})</span>
</span><span id="L-1055"><a href="#-1055"><span class="linenos">1055</span></a>        <span class="n">positionsURL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;/tinkoff.public.invest.api.contract.v1.OperationsService/GetPositions&quot;</span>
</span><span id="L-1056"><a href="#-1056"><span class="linenos">1056</span></a>        <span class="n">rawPositions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SendAPIRequest</span><span class="p">(</span><span class="n">positionsURL</span><span class="p">,</span> <span class="n">reqType</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">)</span>
</span><span id="L-1057"><a href="#-1057"><span class="linenos">1057</span></a>
</span><span id="L-1058"><a href="#-1058"><span class="linenos">1058</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Records about current open positions successfully received&quot;</span><span class="p">)</span>
</span><span id="L-1059"><a href="#-1059"><span class="linenos">1059</span></a>
</span><span id="L-1060"><a href="#-1060"><span class="linenos">1060</span></a>        <span class="k">return</span> <span class="n">rawPositions</span>
</span><span id="L-1061"><a href="#-1061"><span class="linenos">1061</span></a>
</span><span id="L-1062"><a href="#-1062"><span class="linenos">1062</span></a>    <span class="k">def</span> <span class="nf">RequestPendingOrders</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="L-1063"><a href="#-1063"><span class="linenos">1063</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1064"><a href="#-1064"><span class="linenos">1064</span></a><span class="sd">        Requesting current actual pending orders.</span>
</span><span id="L-1065"><a href="#-1065"><span class="linenos">1065</span></a><span class="sd">        REST API for pending (market) orders: https://tinkoff.github.io/investAPI/swagger-ui/#/OrdersService/OrdersService_GetOrders</span>
</span><span id="L-1066"><a href="#-1066"><span class="linenos">1066</span></a>
</span><span id="L-1067"><a href="#-1067"><span class="linenos">1067</span></a><span class="sd">        :return: list of dictionaries with pending orders.</span>
</span><span id="L-1068"><a href="#-1068"><span class="linenos">1068</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1069"><a href="#-1069"><span class="linenos">1069</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Requesting current actual pending orders. Wait, please...&quot;</span><span class="p">)</span>
</span><span id="L-1070"><a href="#-1070"><span class="linenos">1070</span></a>
</span><span id="L-1071"><a href="#-1071"><span class="linenos">1071</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="nb">str</span><span class="p">({</span><span class="s2">&quot;accountId&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">accountId</span><span class="p">})</span>
</span><span id="L-1072"><a href="#-1072"><span class="linenos">1072</span></a>        <span class="n">ordersURL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;/tinkoff.public.invest.api.contract.v1.OrdersService/GetOrders&quot;</span>
</span><span id="L-1073"><a href="#-1073"><span class="linenos">1073</span></a>        <span class="n">rawOrders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SendAPIRequest</span><span class="p">(</span><span class="n">ordersURL</span><span class="p">,</span> <span class="n">reqType</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">)[</span><span class="s2">&quot;orders&quot;</span><span class="p">]</span>
</span><span id="L-1074"><a href="#-1074"><span class="linenos">1074</span></a>
</span><span id="L-1075"><a href="#-1075"><span class="linenos">1075</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">] records about pending orders successfully received&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rawOrders</span><span class="p">)))</span>
</span><span id="L-1076"><a href="#-1076"><span class="linenos">1076</span></a>
</span><span id="L-1077"><a href="#-1077"><span class="linenos">1077</span></a>        <span class="k">return</span> <span class="n">rawOrders</span>
</span><span id="L-1078"><a href="#-1078"><span class="linenos">1078</span></a>
</span><span id="L-1079"><a href="#-1079"><span class="linenos">1079</span></a>    <span class="k">def</span> <span class="nf">RequestStopOrders</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="L-1080"><a href="#-1080"><span class="linenos">1080</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1081"><a href="#-1081"><span class="linenos">1081</span></a><span class="sd">        Requesting current actual stop orders.</span>
</span><span id="L-1082"><a href="#-1082"><span class="linenos">1082</span></a><span class="sd">        REST API for opened stop-orders: https://tinkoff.github.io/investAPI/swagger-ui/#/StopOrdersService/StopOrdersService_GetStopOrders</span>
</span><span id="L-1083"><a href="#-1083"><span class="linenos">1083</span></a>
</span><span id="L-1084"><a href="#-1084"><span class="linenos">1084</span></a><span class="sd">        :return: list of dictionaries with stop orders.</span>
</span><span id="L-1085"><a href="#-1085"><span class="linenos">1085</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1086"><a href="#-1086"><span class="linenos">1086</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Requesting current actual stop orders. Wait, please...&quot;</span><span class="p">)</span>
</span><span id="L-1087"><a href="#-1087"><span class="linenos">1087</span></a>
</span><span id="L-1088"><a href="#-1088"><span class="linenos">1088</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="nb">str</span><span class="p">({</span><span class="s2">&quot;accountId&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">accountId</span><span class="p">})</span>
</span><span id="L-1089"><a href="#-1089"><span class="linenos">1089</span></a>        <span class="n">ordersURL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;/tinkoff.public.invest.api.contract.v1.StopOrdersService/GetStopOrders&quot;</span>
</span><span id="L-1090"><a href="#-1090"><span class="linenos">1090</span></a>        <span class="n">rawStopOrders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SendAPIRequest</span><span class="p">(</span><span class="n">ordersURL</span><span class="p">,</span> <span class="n">reqType</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">)[</span><span class="s2">&quot;stopOrders&quot;</span><span class="p">]</span>
</span><span id="L-1091"><a href="#-1091"><span class="linenos">1091</span></a>
</span><span id="L-1092"><a href="#-1092"><span class="linenos">1092</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">] records about stop orders successfully received&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rawStopOrders</span><span class="p">)))</span>
</span><span id="L-1093"><a href="#-1093"><span class="linenos">1093</span></a>
</span><span id="L-1094"><a href="#-1094"><span class="linenos">1094</span></a>        <span class="k">return</span> <span class="n">rawStopOrders</span>
</span><span id="L-1095"><a href="#-1095"><span class="linenos">1095</span></a>
</span><span id="L-1096"><a href="#-1096"><span class="linenos">1096</span></a>    <span class="k">def</span> <span class="nf">Overview</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">showStatistics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="L-1097"><a href="#-1097"><span class="linenos">1097</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1098"><a href="#-1098"><span class="linenos">1098</span></a><span class="sd">        Get portfolio: all open positions, orders and some statistics for defined accountId.</span>
</span><span id="L-1099"><a href="#-1099"><span class="linenos">1099</span></a><span class="sd">        If `overviewFile` is define then also save information to file.</span>
</span><span id="L-1100"><a href="#-1100"><span class="linenos">1100</span></a>
</span><span id="L-1101"><a href="#-1101"><span class="linenos">1101</span></a><span class="sd">        :param showStatistics: if `False` then only dictionary returns, if `True` then show more debug information.</span>
</span><span id="L-1102"><a href="#-1102"><span class="linenos">1102</span></a><span class="sd">        :return: dictionary with client&#39;s raw portfolio and some statistics.</span>
</span><span id="L-1103"><a href="#-1103"><span class="linenos">1103</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1104"><a href="#-1104"><span class="linenos">1104</span></a>        <span class="n">view</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1105"><a href="#-1105"><span class="linenos">1105</span></a>            <span class="s2">&quot;raw&quot;</span><span class="p">:</span> <span class="p">{</span>  <span class="c1"># --- raw portfolio responses from broker with user portfolio data:</span>
</span><span id="L-1106"><a href="#-1106"><span class="linenos">1106</span></a>                <span class="s2">&quot;headers&quot;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># list of dictionaries, response headers without &quot;positions&quot; section</span>
</span><span id="L-1107"><a href="#-1107"><span class="linenos">1107</span></a>                <span class="s2">&quot;Currencies&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># list of dictionaries, open trades with currencies from &quot;positions&quot; section</span>
</span><span id="L-1108"><a href="#-1108"><span class="linenos">1108</span></a>                <span class="s2">&quot;Shares&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># list of dictionaries, open trades with stocks from &quot;positions&quot; section</span>
</span><span id="L-1109"><a href="#-1109"><span class="linenos">1109</span></a>                <span class="s2">&quot;Bonds&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># list of dictionaries, open trades with bonds from &quot;positions&quot; section</span>
</span><span id="L-1110"><a href="#-1110"><span class="linenos">1110</span></a>                <span class="s2">&quot;Etfs&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># list of dictionaries, open trades with etfs from &quot;positions&quot; section</span>
</span><span id="L-1111"><a href="#-1111"><span class="linenos">1111</span></a>                <span class="s2">&quot;Futures&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># list of dictionaries, open trades with futures from &quot;positions&quot; section</span>
</span><span id="L-1112"><a href="#-1112"><span class="linenos">1112</span></a>                <span class="s2">&quot;positions&quot;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># raw response from broker: dictionary with current available or blocked currencies and instruments for client</span>
</span><span id="L-1113"><a href="#-1113"><span class="linenos">1113</span></a>                <span class="s2">&quot;orders&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># raw response from broker: list of dictionaries with all pending (market) orders</span>
</span><span id="L-1114"><a href="#-1114"><span class="linenos">1114</span></a>                <span class="s2">&quot;stopOrders&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># raw response from broker: list of dictionaries with all stop orders</span>
</span><span id="L-1115"><a href="#-1115"><span class="linenos">1115</span></a>                <span class="s2">&quot;currenciesCurrentPrices&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rub&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;currentPrice&quot;</span><span class="p">:</span> <span class="mf">1.</span><span class="p">}},</span>  <span class="c1"># dict with prices of all currencies in RUB</span>
</span><span id="L-1116"><a href="#-1116"><span class="linenos">1116</span></a>            <span class="p">},</span>
</span><span id="L-1117"><a href="#-1117"><span class="linenos">1117</span></a>            <span class="s2">&quot;stat&quot;</span><span class="p">:</span> <span class="p">{</span>  <span class="c1"># --- some statistics calculated using &quot;raw&quot; sections:</span>
</span><span id="L-1118"><a href="#-1118"><span class="linenos">1118</span></a>                <span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>  <span class="c1"># portfolio cost in RUB (Russian Rouble)</span>
</span><span id="L-1119"><a href="#-1119"><span class="linenos">1119</span></a>                <span class="s2">&quot;currentBlockedRUB&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>  <span class="c1"># blocked sum in Russian Rouble</span>
</span><span id="L-1120"><a href="#-1120"><span class="linenos">1120</span></a>                <span class="s2">&quot;totalChangesRUB&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>  <span class="c1"># changes for all open trades in RUB</span>
</span><span id="L-1121"><a href="#-1121"><span class="linenos">1121</span></a>                <span class="s2">&quot;totalChangesPercentRUB&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>  <span class="c1"># changes for all open trades in percents</span>
</span><span id="L-1122"><a href="#-1122"><span class="linenos">1122</span></a>                <span class="s2">&quot;allCurrenciesCostRUB&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>  <span class="c1"># costs of all currencies (include rubles) in RUB</span>
</span><span id="L-1123"><a href="#-1123"><span class="linenos">1123</span></a>                <span class="s2">&quot;availableRUB&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>  <span class="c1"># available rubles (without other currencies)</span>
</span><span id="L-1124"><a href="#-1124"><span class="linenos">1124</span></a>                <span class="s2">&quot;stocksCostRUB&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>  <span class="c1"># costs of all stocks in RUB</span>
</span><span id="L-1125"><a href="#-1125"><span class="linenos">1125</span></a>                <span class="s2">&quot;bondsCostRUB&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>  <span class="c1"># costs of all bonds in RUB</span>
</span><span id="L-1126"><a href="#-1126"><span class="linenos">1126</span></a>                <span class="s2">&quot;etfsCostRUB&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>  <span class="c1"># costs of all etfs in RUB</span>
</span><span id="L-1127"><a href="#-1127"><span class="linenos">1127</span></a>                <span class="s2">&quot;Currencies&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># list of dictionaries of all currencies statistics</span>
</span><span id="L-1128"><a href="#-1128"><span class="linenos">1128</span></a>                <span class="s2">&quot;Shares&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># list of dictionaries of all stocks statistics</span>
</span><span id="L-1129"><a href="#-1129"><span class="linenos">1129</span></a>                <span class="s2">&quot;Bonds&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># list of dictionaries of all bonds statistics</span>
</span><span id="L-1130"><a href="#-1130"><span class="linenos">1130</span></a>                <span class="s2">&quot;Etfs&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="c1"># list of dictionaries of all etfs statistics</span>
</span><span id="L-1131"><a href="#-1131"><span class="linenos">1131</span></a>                <span class="s2">&quot;Futures&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="c1"># list of dictionaries of all futures statistics</span>
</span><span id="L-1132"><a href="#-1132"><span class="linenos">1132</span></a>                <span class="s2">&quot;orders&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># list of dictionaries of all pending (market) orders and it&#39;s parameters</span>
</span><span id="L-1133"><a href="#-1133"><span class="linenos">1133</span></a>                <span class="s2">&quot;stopOrders&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># list of dictionaries of all stop orders and it&#39;s parameters</span>
</span><span id="L-1134"><a href="#-1134"><span class="linenos">1134</span></a>                <span class="s2">&quot;blockedCurrencies&quot;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># dict with blocked instruments and currencies, e.g. {&quot;rub&quot;: 1291.87, &quot;usd&quot;: 6.21}</span>
</span><span id="L-1135"><a href="#-1135"><span class="linenos">1135</span></a>                <span class="s2">&quot;blockedInstruments&quot;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># dict with blocked  by FIGI, e.g. {}</span>
</span><span id="L-1136"><a href="#-1136"><span class="linenos">1136</span></a>            <span class="p">},</span>
</span><span id="L-1137"><a href="#-1137"><span class="linenos">1137</span></a>            <span class="s2">&quot;analytics&quot;</span><span class="p">:{</span>  <span class="c1"># --- some analytics of portfolio:</span>
</span><span id="L-1138"><a href="#-1138"><span class="linenos">1138</span></a>                <span class="s2">&quot;distrByAssets&quot;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># portfolio distribution by assets</span>
</span><span id="L-1139"><a href="#-1139"><span class="linenos">1139</span></a>                <span class="s2">&quot;distrByCompanies&quot;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># portfolio distribution by companies</span>
</span><span id="L-1140"><a href="#-1140"><span class="linenos">1140</span></a>                <span class="s2">&quot;distrBySectors&quot;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># portfolio distribution by sectors</span>
</span><span id="L-1141"><a href="#-1141"><span class="linenos">1141</span></a>                <span class="s2">&quot;distrByCurrencies&quot;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># portfolio distribution by currencies</span>
</span><span id="L-1142"><a href="#-1142"><span class="linenos">1142</span></a>            <span class="p">}</span>
</span><span id="L-1143"><a href="#-1143"><span class="linenos">1143</span></a>        <span class="p">}</span>
</span><span id="L-1144"><a href="#-1144"><span class="linenos">1144</span></a>
</span><span id="L-1145"><a href="#-1145"><span class="linenos">1145</span></a>        <span class="k">if</span> <span class="n">showStatistics</span><span class="p">:</span>
</span><span id="L-1146"><a href="#-1146"><span class="linenos">1146</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Request portfolio of a client...&quot;</span><span class="p">)</span>
</span><span id="L-1147"><a href="#-1147"><span class="linenos">1147</span></a>
</span><span id="L-1148"><a href="#-1148"><span class="linenos">1148</span></a>        <span class="n">portfolioResponse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RequestPortfolio</span><span class="p">()</span>  <span class="c1"># current user&#39;s portfolio (dict)</span>
</span><span id="L-1149"><a href="#-1149"><span class="linenos">1149</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;positions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RequestPositions</span><span class="p">()</span>  <span class="c1"># current open positions by instruments (dict)</span>
</span><span id="L-1150"><a href="#-1150"><span class="linenos">1150</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;orders&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RequestPendingOrders</span><span class="p">()</span>  <span class="c1"># current actual pending orders (list)</span>
</span><span id="L-1151"><a href="#-1151"><span class="linenos">1151</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;stopOrders&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RequestStopOrders</span><span class="p">()</span>  <span class="c1"># current actual stop orders (list)</span>
</span><span id="L-1152"><a href="#-1152"><span class="linenos">1152</span></a>
</span><span id="L-1153"><a href="#-1153"><span class="linenos">1153</span></a>        <span class="c1"># save response headers without &quot;positions&quot; section:</span>
</span><span id="L-1154"><a href="#-1154"><span class="linenos">1154</span></a>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">portfolioResponse</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-1155"><a href="#-1155"><span class="linenos">1155</span></a>            <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;positions&quot;</span><span class="p">:</span>
</span><span id="L-1156"><a href="#-1156"><span class="linenos">1156</span></a>                <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;headers&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">portfolioResponse</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span id="L-1157"><a href="#-1157"><span class="linenos">1157</span></a>
</span><span id="L-1158"><a href="#-1158"><span class="linenos">1158</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1159"><a href="#-1159"><span class="linenos">1159</span></a>                <span class="k">continue</span>
</span><span id="L-1160"><a href="#-1160"><span class="linenos">1160</span></a>
</span><span id="L-1161"><a href="#-1161"><span class="linenos">1161</span></a>        <span class="c1"># Re-sorting and separating given raw instruments and currencies by type: https://tinkoff.github.io/investAPI/operations/#operation</span>
</span><span id="L-1162"><a href="#-1162"><span class="linenos">1162</span></a>        <span class="c1"># Type of instrument must be only one of supported types in TKS_INSTRUMENTS</span>
</span><span id="L-1163"><a href="#-1163"><span class="linenos">1163</span></a>        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">portfolioResponse</span><span class="p">[</span><span class="s2">&quot;positions&quot;</span><span class="p">]:</span>
</span><span id="L-1164"><a href="#-1164"><span class="linenos">1164</span></a>            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;currency&quot;</span><span class="p">:</span>
</span><span id="L-1165"><a href="#-1165"><span class="linenos">1165</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]</span>
</span><span id="L-1166"><a href="#-1166"><span class="linenos">1166</span></a>                <span class="n">curr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SearchByFIGI</span><span class="p">(</span><span class="n">requestPrice</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1167"><a href="#-1167"><span class="linenos">1167</span></a>
</span><span id="L-1168"><a href="#-1168"><span class="linenos">1168</span></a>                <span class="c1"># current price of currency in RUB:</span>
</span><span id="L-1169"><a href="#-1169"><span class="linenos">1169</span></a>                <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;currenciesCurrentPrices&quot;</span><span class="p">][</span><span class="n">curr</span><span class="p">[</span><span class="s2">&quot;nominal&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1170"><a href="#-1170"><span class="linenos">1170</span></a>                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">curr</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
</span><span id="L-1171"><a href="#-1171"><span class="linenos">1171</span></a>                    <span class="s2">&quot;currentPrice&quot;</span><span class="p">:</span> <span class="n">NanoToFloat</span><span class="p">(</span>
</span><span id="L-1172"><a href="#-1172"><span class="linenos">1172</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span>
</span><span id="L-1173"><a href="#-1173"><span class="linenos">1173</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">]</span>
</span><span id="L-1174"><a href="#-1174"><span class="linenos">1174</span></a>                    <span class="p">),</span>
</span><span id="L-1175"><a href="#-1175"><span class="linenos">1175</span></a>                <span class="p">}</span>
</span><span id="L-1176"><a href="#-1176"><span class="linenos">1176</span></a>
</span><span id="L-1177"><a href="#-1177"><span class="linenos">1177</span></a>                <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;Currencies&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span id="L-1178"><a href="#-1178"><span class="linenos">1178</span></a>
</span><span id="L-1179"><a href="#-1179"><span class="linenos">1179</span></a>            <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;share&quot;</span><span class="p">:</span>
</span><span id="L-1180"><a href="#-1180"><span class="linenos">1180</span></a>                <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;Shares&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span id="L-1181"><a href="#-1181"><span class="linenos">1181</span></a>
</span><span id="L-1182"><a href="#-1182"><span class="linenos">1182</span></a>            <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;bond&quot;</span><span class="p">:</span>
</span><span id="L-1183"><a href="#-1183"><span class="linenos">1183</span></a>                <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;Bonds&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span id="L-1184"><a href="#-1184"><span class="linenos">1184</span></a>
</span><span id="L-1185"><a href="#-1185"><span class="linenos">1185</span></a>            <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;etf&quot;</span><span class="p">:</span>
</span><span id="L-1186"><a href="#-1186"><span class="linenos">1186</span></a>                <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;Etfs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span id="L-1187"><a href="#-1187"><span class="linenos">1187</span></a>
</span><span id="L-1188"><a href="#-1188"><span class="linenos">1188</span></a>            <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;futures&quot;</span><span class="p">:</span>
</span><span id="L-1189"><a href="#-1189"><span class="linenos">1189</span></a>                <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;Futures&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span id="L-1190"><a href="#-1190"><span class="linenos">1190</span></a>
</span><span id="L-1191"><a href="#-1191"><span class="linenos">1191</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1192"><a href="#-1192"><span class="linenos">1192</span></a>                <span class="k">continue</span>
</span><span id="L-1193"><a href="#-1193"><span class="linenos">1193</span></a>
</span><span id="L-1194"><a href="#-1194"><span class="linenos">1194</span></a>        <span class="c1"># how many volume of currencies (by ISO currency name) are blocked:</span>
</span><span id="L-1195"><a href="#-1195"><span class="linenos">1195</span></a>        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;positions&quot;</span><span class="p">][</span><span class="s2">&quot;blocked&quot;</span><span class="p">]:</span>
</span><span id="L-1196"><a href="#-1196"><span class="linenos">1196</span></a>            <span class="n">blocked</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>
</span><span id="L-1197"><a href="#-1197"><span class="linenos">1197</span></a>            <span class="k">if</span> <span class="n">blocked</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1198"><a href="#-1198"><span class="linenos">1198</span></a>                <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;blockedCurrencies&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">blocked</span>
</span><span id="L-1199"><a href="#-1199"><span class="linenos">1199</span></a>
</span><span id="L-1200"><a href="#-1200"><span class="linenos">1200</span></a>        <span class="c1"># how many volume of instruments (by FIGI) are blocked:</span>
</span><span id="L-1201"><a href="#-1201"><span class="linenos">1201</span></a>        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;positions&quot;</span><span class="p">][</span><span class="s2">&quot;securities&quot;</span><span class="p">]:</span>
</span><span id="L-1202"><a href="#-1202"><span class="linenos">1202</span></a>            <span class="n">blocked</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;blocked&quot;</span><span class="p">])</span>
</span><span id="L-1203"><a href="#-1203"><span class="linenos">1203</span></a>            <span class="k">if</span> <span class="n">blocked</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1204"><a href="#-1204"><span class="linenos">1204</span></a>                <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;blockedInstruments&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">blocked</span>
</span><span id="L-1205"><a href="#-1205"><span class="linenos">1205</span></a>
</span><span id="L-1206"><a href="#-1206"><span class="linenos">1206</span></a>        <span class="n">allBlocked</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;blockedCurrencies&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;blockedInstruments&quot;</span><span class="p">]}</span>
</span><span id="L-1207"><a href="#-1207"><span class="linenos">1207</span></a>
</span><span id="L-1208"><a href="#-1208"><span class="linenos">1208</span></a>        <span class="k">if</span> <span class="s2">&quot;rub&quot;</span> <span class="ow">in</span> <span class="n">allBlocked</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-1209"><a href="#-1209"><span class="linenos">1209</span></a>            <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;currentBlockedRUB&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">allBlocked</span><span class="p">[</span><span class="s2">&quot;rub&quot;</span><span class="p">]</span>  <span class="c1"># blocked rubles</span>
</span><span id="L-1210"><a href="#-1210"><span class="linenos">1210</span></a>
</span><span id="L-1211"><a href="#-1211"><span class="linenos">1211</span></a>        <span class="c1"># --- saving current total amount in RUB of all currencies (with ruble), stocks, bonds, etfs, futures and currencies:</span>
</span><span id="L-1212"><a href="#-1212"><span class="linenos">1212</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;allCurrenciesCostRUB&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">portfolioResponse</span><span class="p">[</span><span class="s2">&quot;totalAmountCurrencies&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">portfolioResponse</span><span class="p">[</span><span class="s2">&quot;totalAmountCurrencies&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>
</span><span id="L-1213"><a href="#-1213"><span class="linenos">1213</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;stocksCostRUB&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">portfolioResponse</span><span class="p">[</span><span class="s2">&quot;totalAmountShares&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">portfolioResponse</span><span class="p">[</span><span class="s2">&quot;totalAmountShares&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>
</span><span id="L-1214"><a href="#-1214"><span class="linenos">1214</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;bondsCostRUB&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">portfolioResponse</span><span class="p">[</span><span class="s2">&quot;totalAmountBonds&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">portfolioResponse</span><span class="p">[</span><span class="s2">&quot;totalAmountBonds&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>
</span><span id="L-1215"><a href="#-1215"><span class="linenos">1215</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;etfsCostRUB&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">portfolioResponse</span><span class="p">[</span><span class="s2">&quot;totalAmountEtf&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">portfolioResponse</span><span class="p">[</span><span class="s2">&quot;totalAmountEtf&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>
</span><span id="L-1216"><a href="#-1216"><span class="linenos">1216</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;futuresCostRUB&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">portfolioResponse</span><span class="p">[</span><span class="s2">&quot;totalAmountFutures&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">portfolioResponse</span><span class="p">[</span><span class="s2">&quot;totalAmountFutures&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>
</span><span id="L-1217"><a href="#-1217"><span class="linenos">1217</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span>
</span><span id="L-1218"><a href="#-1218"><span class="linenos">1218</span></a>            <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;allCurrenciesCostRUB&quot;</span><span class="p">],</span>
</span><span id="L-1219"><a href="#-1219"><span class="linenos">1219</span></a>            <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;stocksCostRUB&quot;</span><span class="p">],</span>
</span><span id="L-1220"><a href="#-1220"><span class="linenos">1220</span></a>            <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;bondsCostRUB&quot;</span><span class="p">],</span>
</span><span id="L-1221"><a href="#-1221"><span class="linenos">1221</span></a>            <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;etfsCostRUB&quot;</span><span class="p">],</span>
</span><span id="L-1222"><a href="#-1222"><span class="linenos">1222</span></a>            <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;futuresCostRUB&quot;</span><span class="p">],</span>
</span><span id="L-1223"><a href="#-1223"><span class="linenos">1223</span></a>        <span class="p">])</span>
</span><span id="L-1224"><a href="#-1224"><span class="linenos">1224</span></a>
</span><span id="L-1225"><a href="#-1225"><span class="linenos">1225</span></a>        <span class="c1"># --- calculating some portfolio statistics:</span>
</span><span id="L-1226"><a href="#-1226"><span class="linenos">1226</span></a>        <span class="n">byComp</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># distribution by companies</span>
</span><span id="L-1227"><a href="#-1227"><span class="linenos">1227</span></a>        <span class="n">bySect</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># distribution by sectors</span>
</span><span id="L-1228"><a href="#-1228"><span class="linenos">1228</span></a>        <span class="n">byCurr</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># distribution by currencies (include RUB)</span>
</span><span id="L-1229"><a href="#-1229"><span class="linenos">1229</span></a>
</span><span id="L-1230"><a href="#-1230"><span class="linenos">1230</span></a>        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">portfolioResponse</span><span class="p">[</span><span class="s2">&quot;positions&quot;</span><span class="p">]:</span>
</span><span id="L-1231"><a href="#-1231"><span class="linenos">1231</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]</span>
</span><span id="L-1232"><a href="#-1232"><span class="linenos">1232</span></a>            <span class="n">instrument</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SearchByFIGI</span><span class="p">(</span><span class="n">requestPrice</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># full raw info about instrument by FIGI</span>
</span><span id="L-1233"><a href="#-1233"><span class="linenos">1233</span></a>
</span><span id="L-1234"><a href="#-1234"><span class="linenos">1234</span></a>            <span class="k">if</span> <span class="n">instrument</span><span class="p">:</span>
</span><span id="L-1235"><a href="#-1235"><span class="linenos">1235</span></a>                <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;currency&quot;</span> <span class="ow">and</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;nominal&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">allBlocked</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-1236"><a href="#-1236"><span class="linenos">1236</span></a>                    <span class="n">blocked</span> <span class="o">=</span> <span class="n">allBlocked</span><span class="p">[</span><span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;nominal&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span>  <span class="c1"># blocked volume of currency</span>
</span><span id="L-1237"><a href="#-1237"><span class="linenos">1237</span></a>
</span><span id="L-1238"><a href="#-1238"><span class="linenos">1238</span></a>                <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;currency&quot;</span> <span class="ow">and</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">allBlocked</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-1239"><a href="#-1239"><span class="linenos">1239</span></a>                    <span class="n">blocked</span> <span class="o">=</span> <span class="n">allBlocked</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]]</span>  <span class="c1"># blocked volume of other instruments</span>
</span><span id="L-1240"><a href="#-1240"><span class="linenos">1240</span></a>
</span><span id="L-1241"><a href="#-1241"><span class="linenos">1241</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1242"><a href="#-1242"><span class="linenos">1242</span></a>                    <span class="n">blocked</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1243"><a href="#-1243"><span class="linenos">1243</span></a>
</span><span id="L-1244"><a href="#-1244"><span class="linenos">1244</span></a>                <span class="n">volume</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;quantity&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;quantity&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>  <span class="c1"># available volume of instrument</span>
</span><span id="L-1245"><a href="#-1245"><span class="linenos">1245</span></a>                <span class="n">lots</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;quantityLots&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;quantityLots&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>  <span class="c1"># available volume in lots of instrument</span>
</span><span id="L-1246"><a href="#-1246"><span class="linenos">1246</span></a>                <span class="n">direction</span> <span class="o">=</span> <span class="s2">&quot;Long&quot;</span> <span class="k">if</span> <span class="n">lots</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;Short&quot;</span>  <span class="c1"># direction of an instrument&#39;s position: short or long</span>
</span><span id="L-1247"><a href="#-1247"><span class="linenos">1247</span></a>                <span class="n">curPrice</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>  <span class="c1"># current instrument&#39;s price</span>
</span><span id="L-1248"><a href="#-1248"><span class="linenos">1248</span></a>                <span class="n">average</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;averagePositionPriceFifo&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;averagePositionPriceFifo&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>  <span class="c1"># current average position price</span>
</span><span id="L-1249"><a href="#-1249"><span class="linenos">1249</span></a>                <span class="n">profit</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;expectedYield&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;expectedYield&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>  <span class="c1"># expected profit at current moment</span>
</span><span id="L-1250"><a href="#-1250"><span class="linenos">1250</span></a>                <span class="n">currency</span> <span class="o">=</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;share&quot;</span> <span class="ow">or</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;etf&quot;</span> <span class="ow">or</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;future&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;nominal&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span>  <span class="c1"># currency name rub, usd, eur etc.</span>
</span><span id="L-1251"><a href="#-1251"><span class="linenos">1251</span></a>                <span class="n">cost</span> <span class="o">=</span> <span class="p">(</span><span class="n">curPrice</span> <span class="o">+</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentNkd&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentNkd&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">]))</span> <span class="o">*</span> <span class="n">volume</span>  <span class="c1"># current cost of all volume of instrument in basic asset</span>
</span><span id="L-1252"><a href="#-1252"><span class="linenos">1252</span></a>                <span class="n">baseCurrencyName</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span>  <span class="c1"># name of base currency (rub)</span>
</span><span id="L-1253"><a href="#-1253"><span class="linenos">1253</span></a>                <span class="n">costRUB</span> <span class="o">=</span> <span class="n">cost</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;currency&quot;</span> <span class="k">else</span> <span class="n">cost</span> <span class="o">*</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;currenciesCurrentPrices&quot;</span><span class="p">][</span><span class="n">currency</span><span class="p">][</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">]</span>  <span class="c1"># cost in rubles</span>
</span><span id="L-1254"><a href="#-1254"><span class="linenos">1254</span></a>                <span class="n">percentCostRUB</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">costRUB</span> <span class="o">/</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.</span>  <span class="c1"># instrument&#39;s part in percent of full portfolio cost</span>
</span><span id="L-1255"><a href="#-1255"><span class="linenos">1255</span></a>
</span><span id="L-1256"><a href="#-1256"><span class="linenos">1256</span></a>                <span class="n">statData</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1257"><a href="#-1257"><span class="linenos">1257</span></a>                    <span class="s2">&quot;figi&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">],</span>  <span class="c1"># FIGI from REST API &quot;GetPortfolio&quot; method</span>
</span><span id="L-1258"><a href="#-1258"><span class="linenos">1258</span></a>                    <span class="s2">&quot;ticker&quot;</span><span class="p">:</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">],</span>  <span class="c1"># ticker by FIGI</span>
</span><span id="L-1259"><a href="#-1259"><span class="linenos">1259</span></a>                    <span class="s2">&quot;currency&quot;</span><span class="p">:</span> <span class="n">currency</span><span class="p">,</span>  <span class="c1"># currency name rub, usd, eur etc. for instrument price</span>
</span><span id="L-1260"><a href="#-1260"><span class="linenos">1260</span></a>                    <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="n">volume</span><span class="p">,</span>  <span class="c1"># available volume of instrument</span>
</span><span id="L-1261"><a href="#-1261"><span class="linenos">1261</span></a>                    <span class="s2">&quot;lots&quot;</span><span class="p">:</span> <span class="n">lots</span><span class="p">,</span>  <span class="c1"># volume in lots of instrument</span>
</span><span id="L-1262"><a href="#-1262"><span class="linenos">1262</span></a>                    <span class="s2">&quot;direction&quot;</span><span class="p">:</span> <span class="n">direction</span><span class="p">,</span>  <span class="c1"># direction of an instrument&#39;s position: short or long</span>
</span><span id="L-1263"><a href="#-1263"><span class="linenos">1263</span></a>                    <span class="s2">&quot;blocked&quot;</span><span class="p">:</span> <span class="n">blocked</span><span class="p">,</span>  <span class="c1"># blocked volume of currency or instrument</span>
</span><span id="L-1264"><a href="#-1264"><span class="linenos">1264</span></a>                    <span class="s2">&quot;currentPrice&quot;</span><span class="p">:</span> <span class="n">curPrice</span><span class="p">,</span>  <span class="c1"># current instrument&#39;s price in basic asset</span>
</span><span id="L-1265"><a href="#-1265"><span class="linenos">1265</span></a>                    <span class="s2">&quot;average&quot;</span><span class="p">:</span> <span class="n">average</span><span class="p">,</span>  <span class="c1"># current average position price</span>
</span><span id="L-1266"><a href="#-1266"><span class="linenos">1266</span></a>                    <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">cost</span><span class="p">,</span>  <span class="c1"># current cost of all volume of instrument in basic asset</span>
</span><span id="L-1267"><a href="#-1267"><span class="linenos">1267</span></a>                    <span class="s2">&quot;baseCurrencyName&quot;</span><span class="p">:</span> <span class="n">baseCurrencyName</span><span class="p">,</span>  <span class="c1"># name of base currency (rub)</span>
</span><span id="L-1268"><a href="#-1268"><span class="linenos">1268</span></a>                    <span class="s2">&quot;costRUB&quot;</span><span class="p">:</span> <span class="n">costRUB</span><span class="p">,</span>  <span class="c1"># cost of instrument in ruble</span>
</span><span id="L-1269"><a href="#-1269"><span class="linenos">1269</span></a>                    <span class="s2">&quot;percentCostRUB&quot;</span><span class="p">:</span> <span class="n">percentCostRUB</span><span class="p">,</span>  <span class="c1"># instrument&#39;s part in percent of full portfolio cost in RUB</span>
</span><span id="L-1270"><a href="#-1270"><span class="linenos">1270</span></a>                    <span class="s2">&quot;profit&quot;</span><span class="p">:</span> <span class="n">profit</span><span class="p">,</span>  <span class="c1"># expected profit at current moment</span>
</span><span id="L-1271"><a href="#-1271"><span class="linenos">1271</span></a>                    <span class="s2">&quot;percentProfit&quot;</span><span class="p">:</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">profit</span> <span class="o">/</span> <span class="p">(</span><span class="n">average</span> <span class="o">*</span> <span class="n">volume</span><span class="p">),</span>  <span class="c1"># expected percents of profit at current moment for this instrument</span>
</span><span id="L-1272"><a href="#-1272"><span class="linenos">1272</span></a>                    <span class="s2">&quot;sector&quot;</span><span class="p">:</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;sector&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;sector&quot;</span> <span class="ow">in</span> <span class="n">instrument</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;sector&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;other&quot;</span><span class="p">,</span>
</span><span id="L-1273"><a href="#-1273"><span class="linenos">1273</span></a>                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">instrument</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>  <span class="c1"># human-readable names of instruments</span>
</span><span id="L-1274"><a href="#-1274"><span class="linenos">1274</span></a>                    <span class="s2">&quot;isoCurrencyName&quot;</span><span class="p">:</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;isoCurrencyName&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;isoCurrencyName&quot;</span> <span class="ow">in</span> <span class="n">instrument</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>  <span class="c1"># ISO name for currencies only</span>
</span><span id="L-1275"><a href="#-1275"><span class="linenos">1275</span></a>                <span class="p">}</span>
</span><span id="L-1276"><a href="#-1276"><span class="linenos">1276</span></a>
</span><span id="L-1277"><a href="#-1277"><span class="linenos">1277</span></a>                <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;currency&quot;</span><span class="p">:</span>
</span><span id="L-1278"><a href="#-1278"><span class="linenos">1278</span></a>                    <span class="c1"># adding distribution by unique companies:</span>
</span><span id="L-1279"><a href="#-1279"><span class="linenos">1279</span></a>                    <span class="k">if</span> <span class="n">statData</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span>
</span><span id="L-1280"><a href="#-1280"><span class="linenos">1280</span></a>                        <span class="k">if</span> <span class="n">statData</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">byComp</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-1281"><a href="#-1281"><span class="linenos">1281</span></a>                            <span class="n">byComp</span><span class="p">[</span><span class="n">statData</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ticker&quot;</span><span class="p">:</span> <span class="n">statData</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">],</span> <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">costRUB</span><span class="p">,</span> <span class="s2">&quot;percent&quot;</span><span class="p">:</span> <span class="n">percentCostRUB</span><span class="p">}</span>
</span><span id="L-1282"><a href="#-1282"><span class="linenos">1282</span></a>
</span><span id="L-1283"><a href="#-1283"><span class="linenos">1283</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1284"><a href="#-1284"><span class="linenos">1284</span></a>                            <span class="n">byComp</span><span class="p">[</span><span class="n">statData</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]][</span><span class="s2">&quot;cost&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">costRUB</span>
</span><span id="L-1285"><a href="#-1285"><span class="linenos">1285</span></a>                            <span class="n">byComp</span><span class="p">[</span><span class="n">statData</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]][</span><span class="s2">&quot;percent&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">percentCostRUB</span>
</span><span id="L-1286"><a href="#-1286"><span class="linenos">1286</span></a>
</span><span id="L-1287"><a href="#-1287"><span class="linenos">1287</span></a>                    <span class="c1"># adding distribution by unique sectors:</span>
</span><span id="L-1288"><a href="#-1288"><span class="linenos">1288</span></a>                    <span class="k">if</span> <span class="n">statData</span><span class="p">[</span><span class="s2">&quot;sector&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bySect</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-1289"><a href="#-1289"><span class="linenos">1289</span></a>                        <span class="n">bySect</span><span class="p">[</span><span class="n">statData</span><span class="p">[</span><span class="s2">&quot;sector&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">costRUB</span><span class="p">,</span> <span class="s2">&quot;percent&quot;</span><span class="p">:</span> <span class="n">percentCostRUB</span><span class="p">}</span>
</span><span id="L-1290"><a href="#-1290"><span class="linenos">1290</span></a>
</span><span id="L-1291"><a href="#-1291"><span class="linenos">1291</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1292"><a href="#-1292"><span class="linenos">1292</span></a>                        <span class="n">bySect</span><span class="p">[</span><span class="n">statData</span><span class="p">[</span><span class="s2">&quot;sector&quot;</span><span class="p">]][</span><span class="s2">&quot;cost&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">costRUB</span>
</span><span id="L-1293"><a href="#-1293"><span class="linenos">1293</span></a>                        <span class="n">bySect</span><span class="p">[</span><span class="n">statData</span><span class="p">[</span><span class="s2">&quot;sector&quot;</span><span class="p">]][</span><span class="s2">&quot;percent&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">percentCostRUB</span>
</span><span id="L-1294"><a href="#-1294"><span class="linenos">1294</span></a>
</span><span id="L-1295"><a href="#-1295"><span class="linenos">1295</span></a>                <span class="c1"># adding distribution by unique currencies:</span>
</span><span id="L-1296"><a href="#-1296"><span class="linenos">1296</span></a>                <span class="k">if</span> <span class="n">currency</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">byCurr</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-1297"><a href="#-1297"><span class="linenos">1297</span></a>                    <span class="n">byCurr</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1298"><a href="#-1298"><span class="linenos">1298</span></a>                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;currenciesCurrentPrices&quot;</span><span class="p">][</span><span class="n">currency</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
</span><span id="L-1299"><a href="#-1299"><span class="linenos">1299</span></a>                        <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">costRUB</span><span class="p">,</span>
</span><span id="L-1300"><a href="#-1300"><span class="linenos">1300</span></a>                        <span class="s2">&quot;percent&quot;</span><span class="p">:</span> <span class="n">percentCostRUB</span>
</span><span id="L-1301"><a href="#-1301"><span class="linenos">1301</span></a>                    <span class="p">}</span>
</span><span id="L-1302"><a href="#-1302"><span class="linenos">1302</span></a>
</span><span id="L-1303"><a href="#-1303"><span class="linenos">1303</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1304"><a href="#-1304"><span class="linenos">1304</span></a>                    <span class="n">byCurr</span><span class="p">[</span><span class="n">currency</span><span class="p">][</span><span class="s2">&quot;cost&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">costRUB</span>
</span><span id="L-1305"><a href="#-1305"><span class="linenos">1305</span></a>                    <span class="n">byCurr</span><span class="p">[</span><span class="n">currency</span><span class="p">][</span><span class="s2">&quot;percent&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">percentCostRUB</span>
</span><span id="L-1306"><a href="#-1306"><span class="linenos">1306</span></a>
</span><span id="L-1307"><a href="#-1307"><span class="linenos">1307</span></a>                <span class="c1"># saving statistics for every instruments:</span>
</span><span id="L-1308"><a href="#-1308"><span class="linenos">1308</span></a>                <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;currency&quot;</span><span class="p">:</span>
</span><span id="L-1309"><a href="#-1309"><span class="linenos">1309</span></a>                    <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Currencies&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">statData</span><span class="p">)</span>
</span><span id="L-1310"><a href="#-1310"><span class="linenos">1310</span></a>
</span><span id="L-1311"><a href="#-1311"><span class="linenos">1311</span></a>                <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;share&quot;</span><span class="p">:</span>
</span><span id="L-1312"><a href="#-1312"><span class="linenos">1312</span></a>                    <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Shares&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">statData</span><span class="p">)</span>
</span><span id="L-1313"><a href="#-1313"><span class="linenos">1313</span></a>
</span><span id="L-1314"><a href="#-1314"><span class="linenos">1314</span></a>                <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;bond&quot;</span><span class="p">:</span>
</span><span id="L-1315"><a href="#-1315"><span class="linenos">1315</span></a>                    <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Bonds&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">statData</span><span class="p">)</span>
</span><span id="L-1316"><a href="#-1316"><span class="linenos">1316</span></a>
</span><span id="L-1317"><a href="#-1317"><span class="linenos">1317</span></a>                <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;etf&quot;</span><span class="p">:</span>
</span><span id="L-1318"><a href="#-1318"><span class="linenos">1318</span></a>                    <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Etfs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">statData</span><span class="p">)</span>
</span><span id="L-1319"><a href="#-1319"><span class="linenos">1319</span></a>
</span><span id="L-1320"><a href="#-1320"><span class="linenos">1320</span></a>                <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Futures&quot;</span><span class="p">:</span>
</span><span id="L-1321"><a href="#-1321"><span class="linenos">1321</span></a>                    <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Futures&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">statData</span><span class="p">)</span>
</span><span id="L-1322"><a href="#-1322"><span class="linenos">1322</span></a>
</span><span id="L-1323"><a href="#-1323"><span class="linenos">1323</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1324"><a href="#-1324"><span class="linenos">1324</span></a>                    <span class="k">continue</span>
</span><span id="L-1325"><a href="#-1325"><span class="linenos">1325</span></a>
</span><span id="L-1326"><a href="#-1326"><span class="linenos">1326</span></a>        <span class="c1"># total changes:</span>
</span><span id="L-1327"><a href="#-1327"><span class="linenos">1327</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;availableRUB&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;allCurrenciesCostRUB&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">([</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;cost&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Currencies&quot;</span><span class="p">]])</span>  <span class="c1"># available RUB without other currencies</span>
</span><span id="L-1328"><a href="#-1328"><span class="linenos">1328</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;totalChangesPercentRUB&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;headers&quot;</span><span class="p">][</span><span class="s2">&quot;expectedYield&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;headers&quot;</span><span class="p">][</span><span class="s2">&quot;expectedYield&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;expectedYield&quot;</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;headers&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="mf">0.</span>
</span><span id="L-1329"><a href="#-1329"><span class="linenos">1329</span></a>        <span class="n">startCost</span> <span class="o">=</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;totalChangesPercentRUB&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
</span><span id="L-1330"><a href="#-1330"><span class="linenos">1330</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;totalChangesRUB&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">startCost</span>
</span><span id="L-1331"><a href="#-1331"><span class="linenos">1331</span></a>
</span><span id="L-1332"><a href="#-1332"><span class="linenos">1332</span></a>        <span class="c1"># --- pending orders sector data:</span>
</span><span id="L-1333"><a href="#-1333"><span class="linenos">1333</span></a>        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;orders&quot;</span><span class="p">]:</span>
</span><span id="L-1334"><a href="#-1334"><span class="linenos">1334</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]</span>
</span><span id="L-1335"><a href="#-1335"><span class="linenos">1335</span></a>            <span class="n">instrument</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SearchByFIGI</span><span class="p">(</span><span class="n">requestPrice</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># full raw info about instrument by FIGI</span>
</span><span id="L-1336"><a href="#-1336"><span class="linenos">1336</span></a>
</span><span id="L-1337"><a href="#-1337"><span class="linenos">1337</span></a>            <span class="k">if</span> <span class="n">instrument</span><span class="p">:</span>
</span><span id="L-1338"><a href="#-1338"><span class="linenos">1338</span></a>                <span class="n">action</span> <span class="o">=</span> <span class="n">TKS_ORDER_DIRECTIONS</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;direction&quot;</span><span class="p">]]</span>
</span><span id="L-1339"><a href="#-1339"><span class="linenos">1339</span></a>                <span class="n">orderType</span> <span class="o">=</span> <span class="n">TKS_ORDER_TYPES</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;orderType&quot;</span><span class="p">]]</span>
</span><span id="L-1340"><a href="#-1340"><span class="linenos">1340</span></a>                <span class="n">orderState</span> <span class="o">=</span> <span class="n">TKS_ORDER_STATES</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;executionReportStatus&quot;</span><span class="p">]]</span>
</span><span id="L-1341"><a href="#-1341"><span class="linenos">1341</span></a>                <span class="n">orderDate</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;orderDate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># date in UTC format, e.g. &quot;2022-12-31T23:59:59.123456Z&quot;</span>
</span><span id="L-1342"><a href="#-1342"><span class="linenos">1342</span></a>
</span><span id="L-1343"><a href="#-1343"><span class="linenos">1343</span></a>                <span class="c1"># current instrument&#39;s price (last sellers order if buy, and last buyers order if sell):</span>
</span><span id="L-1344"><a href="#-1344"><span class="linenos">1344</span></a>                <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;direction&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ORDER_DIRECTION_BUY&quot;</span><span class="p">:</span>
</span><span id="L-1345"><a href="#-1345"><span class="linenos">1345</span></a>                    <span class="n">lastPrice</span> <span class="o">=</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;sell&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;price&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;sell&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span>
</span><span id="L-1346"><a href="#-1346"><span class="linenos">1346</span></a>
</span><span id="L-1347"><a href="#-1347"><span class="linenos">1347</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1348"><a href="#-1348"><span class="linenos">1348</span></a>                    <span class="n">lastPrice</span> <span class="o">=</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;buy&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;price&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;buy&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span>
</span><span id="L-1349"><a href="#-1349"><span class="linenos">1349</span></a>
</span><span id="L-1350"><a href="#-1350"><span class="linenos">1350</span></a>                <span class="c1"># requested price for order execution:</span>
</span><span id="L-1351"><a href="#-1351"><span class="linenos">1351</span></a>                <span class="n">target</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;initialSecurityPrice&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;initialSecurityPrice&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>
</span><span id="L-1352"><a href="#-1352"><span class="linenos">1352</span></a>
</span><span id="L-1353"><a href="#-1353"><span class="linenos">1353</span></a>                <span class="c1"># necessary changes in percent to reach target from current price:</span>
</span><span id="L-1354"><a href="#-1354"><span class="linenos">1354</span></a>                <span class="n">changes</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">lastPrice</span> <span class="o">-</span> <span class="n">target</span><span class="p">)</span> <span class="o">/</span> <span class="n">target</span> <span class="k">if</span> <span class="n">lastPrice</span> <span class="o">!=</span> <span class="s2">&quot;N/A&quot;</span> <span class="ow">and</span> <span class="n">target</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="L-1355"><a href="#-1355"><span class="linenos">1355</span></a>
</span><span id="L-1356"><a href="#-1356"><span class="linenos">1356</span></a>                <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;orders&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="L-1357"><a href="#-1357"><span class="linenos">1357</span></a>                    <span class="s2">&quot;orderID&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;orderId&quot;</span><span class="p">],</span>  <span class="c1"># orderId number parameter of current order</span>
</span><span id="L-1358"><a href="#-1358"><span class="linenos">1358</span></a>                    <span class="s2">&quot;figi&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">],</span>  <span class="c1"># FIGI identification</span>
</span><span id="L-1359"><a href="#-1359"><span class="linenos">1359</span></a>                    <span class="s2">&quot;ticker&quot;</span><span class="p">:</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">],</span>  <span class="c1"># ticker name by FIGI</span>
</span><span id="L-1360"><a href="#-1360"><span class="linenos">1360</span></a>                    <span class="s2">&quot;lotsRequested&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;lotsRequested&quot;</span><span class="p">],</span>  <span class="c1"># requested lots value</span>
</span><span id="L-1361"><a href="#-1361"><span class="linenos">1361</span></a>                    <span class="s2">&quot;lotsExecuted&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;lotsExecuted&quot;</span><span class="p">],</span>  <span class="c1"># how many lots are executed</span>
</span><span id="L-1362"><a href="#-1362"><span class="linenos">1362</span></a>                    <span class="s2">&quot;currentPrice&quot;</span><span class="p">:</span> <span class="n">lastPrice</span><span class="p">,</span>  <span class="c1"># current instrument&#39;s price for defined action</span>
</span><span id="L-1363"><a href="#-1363"><span class="linenos">1363</span></a>                    <span class="s2">&quot;targetPrice&quot;</span><span class="p">:</span> <span class="n">target</span><span class="p">,</span>  <span class="c1"># requested price for order execution in base currency</span>
</span><span id="L-1364"><a href="#-1364"><span class="linenos">1364</span></a>                    <span class="s2">&quot;baseCurrencyName&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;initialSecurityPrice&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>  <span class="c1"># name of base currency</span>
</span><span id="L-1365"><a href="#-1365"><span class="linenos">1365</span></a>                    <span class="s2">&quot;percentChanges&quot;</span><span class="p">:</span> <span class="n">changes</span><span class="p">,</span>  <span class="c1"># changes in percent to target from current price</span>
</span><span id="L-1366"><a href="#-1366"><span class="linenos">1366</span></a>                    <span class="s2">&quot;currency&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>  <span class="c1"># instrument&#39;s currency name</span>
</span><span id="L-1367"><a href="#-1367"><span class="linenos">1367</span></a>                    <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span>  <span class="c1"># sell / buy / Unknown from TKS_ORDER_DIRECTIONS</span>
</span><span id="L-1368"><a href="#-1368"><span class="linenos">1368</span></a>                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">orderType</span><span class="p">,</span>  <span class="c1"># type of order from TKS_ORDER_TYPES</span>
</span><span id="L-1369"><a href="#-1369"><span class="linenos">1369</span></a>                    <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">orderState</span><span class="p">,</span>  <span class="c1"># order status from TKS_ORDER_STATES</span>
</span><span id="L-1370"><a href="#-1370"><span class="linenos">1370</span></a>                    <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="n">orderDate</span><span class="p">,</span>  <span class="c1"># string with order date and time from UTC format (without nano seconds part)</span>
</span><span id="L-1371"><a href="#-1371"><span class="linenos">1371</span></a>                <span class="p">})</span>
</span><span id="L-1372"><a href="#-1372"><span class="linenos">1372</span></a>
</span><span id="L-1373"><a href="#-1373"><span class="linenos">1373</span></a>        <span class="c1"># --- stop orders sector data:</span>
</span><span id="L-1374"><a href="#-1374"><span class="linenos">1374</span></a>        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;stopOrders&quot;</span><span class="p">]:</span>
</span><span id="L-1375"><a href="#-1375"><span class="linenos">1375</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]</span>
</span><span id="L-1376"><a href="#-1376"><span class="linenos">1376</span></a>            <span class="n">instrument</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SearchByFIGI</span><span class="p">(</span><span class="n">requestPrice</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># full raw info about instrument by FIGI</span>
</span><span id="L-1377"><a href="#-1377"><span class="linenos">1377</span></a>
</span><span id="L-1378"><a href="#-1378"><span class="linenos">1378</span></a>            <span class="k">if</span> <span class="n">instrument</span><span class="p">:</span>
</span><span id="L-1379"><a href="#-1379"><span class="linenos">1379</span></a>                <span class="n">action</span> <span class="o">=</span> <span class="n">TKS_STOP_ORDER_DIRECTIONS</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;direction&quot;</span><span class="p">]]</span>
</span><span id="L-1380"><a href="#-1380"><span class="linenos">1380</span></a>                <span class="n">orderType</span> <span class="o">=</span> <span class="n">TKS_STOP_ORDER_TYPES</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;orderType&quot;</span><span class="p">]]</span>
</span><span id="L-1381"><a href="#-1381"><span class="linenos">1381</span></a>                <span class="n">createDate</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;createDate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># date in UTC format, e.g. &quot;2022-12-31T23:59:59.123456Z&quot;</span>
</span><span id="L-1382"><a href="#-1382"><span class="linenos">1382</span></a>
</span><span id="L-1383"><a href="#-1383"><span class="linenos">1383</span></a>                <span class="c1"># hack: server response can&#39;t contain &quot;expirationTime&quot; key if it is not &quot;Until date&quot; type of stop order</span>
</span><span id="L-1384"><a href="#-1384"><span class="linenos">1384</span></a>                <span class="k">if</span> <span class="s2">&quot;expirationTime&quot;</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-1385"><a href="#-1385"><span class="linenos">1385</span></a>                    <span class="n">expType</span> <span class="o">=</span> <span class="n">TKS_STOP_ORDER_EXPIRATION_TYPES</span><span class="p">[</span><span class="s2">&quot;STOP_ORDER_EXPIRATION_TYPE_GOOD_TILL_DATE&quot;</span><span class="p">]</span>
</span><span id="L-1386"><a href="#-1386"><span class="linenos">1386</span></a>                    <span class="n">expDate</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;expirationTime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1387"><a href="#-1387"><span class="linenos">1387</span></a>
</span><span id="L-1388"><a href="#-1388"><span class="linenos">1388</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1389"><a href="#-1389"><span class="linenos">1389</span></a>                    <span class="n">expType</span> <span class="o">=</span> <span class="n">TKS_STOP_ORDER_EXPIRATION_TYPES</span><span class="p">[</span><span class="s2">&quot;STOP_ORDER_EXPIRATION_TYPE_GOOD_TILL_CANCEL&quot;</span><span class="p">]</span>
</span><span id="L-1390"><a href="#-1390"><span class="linenos">1390</span></a>                    <span class="n">expDate</span> <span class="o">=</span> <span class="n">TKS_STOP_ORDER_EXPIRATION_TYPES</span><span class="p">[</span><span class="s2">&quot;STOP_ORDER_EXPIRATION_TYPE_UNSPECIFIED&quot;</span><span class="p">]</span>
</span><span id="L-1391"><a href="#-1391"><span class="linenos">1391</span></a>
</span><span id="L-1392"><a href="#-1392"><span class="linenos">1392</span></a>                <span class="c1"># current instrument&#39;s price (last sellers order if buy, and last buyers order if sell):</span>
</span><span id="L-1393"><a href="#-1393"><span class="linenos">1393</span></a>                <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;direction&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;STOP_ORDER_DIRECTION_BUY&quot;</span><span class="p">:</span>
</span><span id="L-1394"><a href="#-1394"><span class="linenos">1394</span></a>                    <span class="n">lastPrice</span> <span class="o">=</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;sell&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;price&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;sell&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span>
</span><span id="L-1395"><a href="#-1395"><span class="linenos">1395</span></a>
</span><span id="L-1396"><a href="#-1396"><span class="linenos">1396</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1397"><a href="#-1397"><span class="linenos">1397</span></a>                    <span class="n">lastPrice</span> <span class="o">=</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;buy&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;price&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;buy&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span>
</span><span id="L-1398"><a href="#-1398"><span class="linenos">1398</span></a>
</span><span id="L-1399"><a href="#-1399"><span class="linenos">1399</span></a>                <span class="c1"># requested price when stop-order executed:</span>
</span><span id="L-1400"><a href="#-1400"><span class="linenos">1400</span></a>                <span class="n">target</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;stopPrice&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;stopPrice&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>
</span><span id="L-1401"><a href="#-1401"><span class="linenos">1401</span></a>
</span><span id="L-1402"><a href="#-1402"><span class="linenos">1402</span></a>                <span class="c1"># price for limit-order, set up when stop-order executed:</span>
</span><span id="L-1403"><a href="#-1403"><span class="linenos">1403</span></a>                <span class="n">limit</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>
</span><span id="L-1404"><a href="#-1404"><span class="linenos">1404</span></a>
</span><span id="L-1405"><a href="#-1405"><span class="linenos">1405</span></a>                <span class="c1"># necessary changes in percent to reach target from current price:</span>
</span><span id="L-1406"><a href="#-1406"><span class="linenos">1406</span></a>                <span class="n">changes</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">lastPrice</span> <span class="o">-</span> <span class="n">target</span><span class="p">)</span> <span class="o">/</span> <span class="n">target</span> <span class="k">if</span> <span class="n">lastPrice</span> <span class="o">!=</span> <span class="s2">&quot;N/A&quot;</span> <span class="ow">and</span> <span class="n">target</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="L-1407"><a href="#-1407"><span class="linenos">1407</span></a>
</span><span id="L-1408"><a href="#-1408"><span class="linenos">1408</span></a>                <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;stopOrders&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="L-1409"><a href="#-1409"><span class="linenos">1409</span></a>                    <span class="s2">&quot;orderID&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;stopOrderId&quot;</span><span class="p">],</span>  <span class="c1"># stopOrderId number parameter of current stop-order</span>
</span><span id="L-1410"><a href="#-1410"><span class="linenos">1410</span></a>                    <span class="s2">&quot;figi&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">],</span>  <span class="c1"># FIGI identification</span>
</span><span id="L-1411"><a href="#-1411"><span class="linenos">1411</span></a>                    <span class="s2">&quot;ticker&quot;</span><span class="p">:</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">],</span>  <span class="c1"># ticker name by FIGI</span>
</span><span id="L-1412"><a href="#-1412"><span class="linenos">1412</span></a>                    <span class="s2">&quot;lotsRequested&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;lotsRequested&quot;</span><span class="p">],</span>  <span class="c1"># requested lots value</span>
</span><span id="L-1413"><a href="#-1413"><span class="linenos">1413</span></a>                    <span class="s2">&quot;currentPrice&quot;</span><span class="p">:</span> <span class="n">lastPrice</span><span class="p">,</span>  <span class="c1"># current instrument&#39;s price for defined action</span>
</span><span id="L-1414"><a href="#-1414"><span class="linenos">1414</span></a>                    <span class="s2">&quot;targetPrice&quot;</span><span class="p">:</span> <span class="n">target</span><span class="p">,</span>  <span class="c1"># requested price for stop-order execution in base currency</span>
</span><span id="L-1415"><a href="#-1415"><span class="linenos">1415</span></a>                    <span class="s2">&quot;limitPrice&quot;</span><span class="p">:</span> <span class="n">limit</span><span class="p">,</span>  <span class="c1"># price for limit-order, set up when stop-order executed, 0 if market order</span>
</span><span id="L-1416"><a href="#-1416"><span class="linenos">1416</span></a>                    <span class="s2">&quot;baseCurrencyName&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;stopPrice&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>  <span class="c1"># name of base currency</span>
</span><span id="L-1417"><a href="#-1417"><span class="linenos">1417</span></a>                    <span class="s2">&quot;percentChanges&quot;</span><span class="p">:</span> <span class="n">changes</span><span class="p">,</span>  <span class="c1"># changes in percent to target from current price</span>
</span><span id="L-1418"><a href="#-1418"><span class="linenos">1418</span></a>                    <span class="s2">&quot;currency&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>  <span class="c1"># instrument&#39;s currency name</span>
</span><span id="L-1419"><a href="#-1419"><span class="linenos">1419</span></a>                    <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span>  <span class="c1"># sell / buy / Unknown from TKS_STOP_ORDER_DIRECTIONS</span>
</span><span id="L-1420"><a href="#-1420"><span class="linenos">1420</span></a>                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">orderType</span><span class="p">,</span>  <span class="c1"># type of order from TKS_STOP_ORDER_TYPES</span>
</span><span id="L-1421"><a href="#-1421"><span class="linenos">1421</span></a>                    <span class="s2">&quot;expType&quot;</span><span class="p">:</span> <span class="n">expType</span><span class="p">,</span>  <span class="c1"># expiration type of stop-order from TKS_STOP_ORDER_EXPIRATION_TYPES</span>
</span><span id="L-1422"><a href="#-1422"><span class="linenos">1422</span></a>                    <span class="s2">&quot;createDate&quot;</span><span class="p">:</span> <span class="n">createDate</span><span class="p">,</span>  <span class="c1"># string with created order date and time from UTC format (without nano seconds part)</span>
</span><span id="L-1423"><a href="#-1423"><span class="linenos">1423</span></a>                    <span class="s2">&quot;expDate&quot;</span><span class="p">:</span> <span class="n">expDate</span><span class="p">,</span>  <span class="c1"># string with expiration order date and time from UTC format (without nano seconds part)</span>
</span><span id="L-1424"><a href="#-1424"><span class="linenos">1424</span></a>                <span class="p">})</span>
</span><span id="L-1425"><a href="#-1425"><span class="linenos">1425</span></a>
</span><span id="L-1426"><a href="#-1426"><span class="linenos">1426</span></a>        <span class="c1"># --- calculating data for analytics section:</span>
</span><span id="L-1427"><a href="#-1427"><span class="linenos">1427</span></a>        <span class="c1"># portfolio distribution by assets:</span>
</span><span id="L-1428"><a href="#-1428"><span class="linenos">1428</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByAssets&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1429"><a href="#-1429"><span class="linenos">1429</span></a>            <span class="s2">&quot;Ruble&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-1430"><a href="#-1430"><span class="linenos">1430</span></a>                <span class="s2">&quot;uniques&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-1431"><a href="#-1431"><span class="linenos">1431</span></a>                <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;availableRUB&quot;</span><span class="p">],</span>
</span><span id="L-1432"><a href="#-1432"><span class="linenos">1432</span></a>                <span class="s2">&quot;percent&quot;</span><span class="p">:</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;availableRUB&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="L-1433"><a href="#-1433"><span class="linenos">1433</span></a>            <span class="p">},</span>
</span><span id="L-1434"><a href="#-1434"><span class="linenos">1434</span></a>            <span class="s2">&quot;Currencies&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-1435"><a href="#-1435"><span class="linenos">1435</span></a>                <span class="s2">&quot;uniques&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Currencies&quot;</span><span class="p">]),</span>  <span class="c1"># all foreign currencies without RUB</span>
</span><span id="L-1436"><a href="#-1436"><span class="linenos">1436</span></a>                <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;allCurrenciesCostRUB&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;availableRUB&quot;</span><span class="p">],</span>
</span><span id="L-1437"><a href="#-1437"><span class="linenos">1437</span></a>                <span class="s2">&quot;percent&quot;</span><span class="p">:</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;allCurrenciesCostRUB&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;availableRUB&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="L-1438"><a href="#-1438"><span class="linenos">1438</span></a>            <span class="p">},</span>
</span><span id="L-1439"><a href="#-1439"><span class="linenos">1439</span></a>            <span class="s2">&quot;Shares&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-1440"><a href="#-1440"><span class="linenos">1440</span></a>                <span class="s2">&quot;uniques&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Shares&quot;</span><span class="p">]),</span>
</span><span id="L-1441"><a href="#-1441"><span class="linenos">1441</span></a>                <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;stocksCostRUB&quot;</span><span class="p">],</span>
</span><span id="L-1442"><a href="#-1442"><span class="linenos">1442</span></a>                <span class="s2">&quot;percent&quot;</span><span class="p">:</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;stocksCostRUB&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="L-1443"><a href="#-1443"><span class="linenos">1443</span></a>            <span class="p">},</span>
</span><span id="L-1444"><a href="#-1444"><span class="linenos">1444</span></a>            <span class="s2">&quot;Bonds&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-1445"><a href="#-1445"><span class="linenos">1445</span></a>                <span class="s2">&quot;uniques&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Bonds&quot;</span><span class="p">]),</span>
</span><span id="L-1446"><a href="#-1446"><span class="linenos">1446</span></a>                <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;bondsCostRUB&quot;</span><span class="p">],</span>
</span><span id="L-1447"><a href="#-1447"><span class="linenos">1447</span></a>                <span class="s2">&quot;percent&quot;</span><span class="p">:</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;bondsCostRUB&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="L-1448"><a href="#-1448"><span class="linenos">1448</span></a>            <span class="p">},</span>
</span><span id="L-1449"><a href="#-1449"><span class="linenos">1449</span></a>            <span class="s2">&quot;Etfs&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-1450"><a href="#-1450"><span class="linenos">1450</span></a>                <span class="s2">&quot;uniques&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Etfs&quot;</span><span class="p">]),</span>
</span><span id="L-1451"><a href="#-1451"><span class="linenos">1451</span></a>                <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;etfsCostRUB&quot;</span><span class="p">],</span>
</span><span id="L-1452"><a href="#-1452"><span class="linenos">1452</span></a>                <span class="s2">&quot;percent&quot;</span><span class="p">:</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;etfsCostRUB&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="L-1453"><a href="#-1453"><span class="linenos">1453</span></a>            <span class="p">},</span>
</span><span id="L-1454"><a href="#-1454"><span class="linenos">1454</span></a>            <span class="s2">&quot;Futures&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-1455"><a href="#-1455"><span class="linenos">1455</span></a>                <span class="s2">&quot;uniques&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Futures&quot;</span><span class="p">]),</span>
</span><span id="L-1456"><a href="#-1456"><span class="linenos">1456</span></a>                <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;futuresCostRUB&quot;</span><span class="p">],</span>
</span><span id="L-1457"><a href="#-1457"><span class="linenos">1457</span></a>                <span class="s2">&quot;percent&quot;</span><span class="p">:</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;futuresCostRUB&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="L-1458"><a href="#-1458"><span class="linenos">1458</span></a>            <span class="p">},</span>
</span><span id="L-1459"><a href="#-1459"><span class="linenos">1459</span></a>        <span class="p">}</span>
</span><span id="L-1460"><a href="#-1460"><span class="linenos">1460</span></a>
</span><span id="L-1461"><a href="#-1461"><span class="linenos">1461</span></a>        <span class="c1"># portfolio distribution by companies:</span>
</span><span id="L-1462"><a href="#-1462"><span class="linenos">1462</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCompanies&quot;</span><span class="p">][</span><span class="s2">&quot;All money cash&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1463"><a href="#-1463"><span class="linenos">1463</span></a>            <span class="s2">&quot;ticker&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-1464"><a href="#-1464"><span class="linenos">1464</span></a>            <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;allCurrenciesCostRUB&quot;</span><span class="p">],</span>
</span><span id="L-1465"><a href="#-1465"><span class="linenos">1465</span></a>            <span class="s2">&quot;percent&quot;</span><span class="p">:</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;allCurrenciesCostRUB&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="L-1466"><a href="#-1466"><span class="linenos">1466</span></a>        <span class="p">}</span>
</span><span id="L-1467"><a href="#-1467"><span class="linenos">1467</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCompanies&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">byComp</span><span class="p">)</span>
</span><span id="L-1468"><a href="#-1468"><span class="linenos">1468</span></a>
</span><span id="L-1469"><a href="#-1469"><span class="linenos">1469</span></a>        <span class="c1"># portfolio distribution by sectors:</span>
</span><span id="L-1470"><a href="#-1470"><span class="linenos">1470</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrBySectors&quot;</span><span class="p">][</span><span class="s2">&quot;All money cash&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1471"><a href="#-1471"><span class="linenos">1471</span></a>            <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCompanies&quot;</span><span class="p">][</span><span class="s2">&quot;All money cash&quot;</span><span class="p">][</span><span class="s2">&quot;cost&quot;</span><span class="p">],</span>
</span><span id="L-1472"><a href="#-1472"><span class="linenos">1472</span></a>            <span class="s2">&quot;percent&quot;</span><span class="p">:</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCompanies&quot;</span><span class="p">][</span><span class="s2">&quot;All money cash&quot;</span><span class="p">][</span><span class="s2">&quot;percent&quot;</span><span class="p">],</span>
</span><span id="L-1473"><a href="#-1473"><span class="linenos">1473</span></a>        <span class="p">}</span>
</span><span id="L-1474"><a href="#-1474"><span class="linenos">1474</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrBySectors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">bySect</span><span class="p">)</span>
</span><span id="L-1475"><a href="#-1475"><span class="linenos">1475</span></a>
</span><span id="L-1476"><a href="#-1476"><span class="linenos">1476</span></a>        <span class="c1"># portfolio distribution by currencies:</span>
</span><span id="L-1477"><a href="#-1477"><span class="linenos">1477</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCurrencies&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">byCurr</span><span class="p">)</span>
</span><span id="L-1478"><a href="#-1478"><span class="linenos">1478</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCurrencies&quot;</span><span class="p">][</span><span class="s2">&quot;rub&quot;</span><span class="p">][</span><span class="s2">&quot;cost&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByAssets&quot;</span><span class="p">][</span><span class="s2">&quot;Ruble&quot;</span><span class="p">][</span><span class="s2">&quot;cost&quot;</span><span class="p">]</span>
</span><span id="L-1479"><a href="#-1479"><span class="linenos">1479</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCurrencies&quot;</span><span class="p">][</span><span class="s2">&quot;rub&quot;</span><span class="p">][</span><span class="s2">&quot;percent&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByAssets&quot;</span><span class="p">][</span><span class="s2">&quot;Ruble&quot;</span><span class="p">][</span><span class="s2">&quot;percent&quot;</span><span class="p">]</span>
</span><span id="L-1480"><a href="#-1480"><span class="linenos">1480</span></a>
</span><span id="L-1481"><a href="#-1481"><span class="linenos">1481</span></a>        <span class="c1"># --- Prepare text statistics overview in human-readable:</span>
</span><span id="L-1482"><a href="#-1482"><span class="linenos">1482</span></a>        <span class="k">if</span> <span class="n">showStatistics</span><span class="p">:</span>
</span><span id="L-1483"><a href="#-1483"><span class="linenos">1483</span></a>            <span class="n">info</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-1484"><a href="#-1484"><span class="linenos">1484</span></a>                <span class="s2">&quot;# Client&#39;s portfolio</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-1485"><a href="#-1485"><span class="linenos">1485</span></a>                <span class="s2">&quot;* **Actual date:** [</span><span class="si">{}</span><span class="s2">] (UTC)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tzutc</span><span class="p">())</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)),</span>
</span><span id="L-1486"><a href="#-1486"><span class="linenos">1486</span></a>                <span class="s2">&quot;* **Portfolio cost:** </span><span class="si">{:.2f}</span><span class="s2"> RUB</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]),</span>
</span><span id="L-1487"><a href="#-1487"><span class="linenos">1487</span></a>                <span class="s2">&quot;* **Changes:** </span><span class="si">{}{:.2f}</span><span class="s2"> RUB (</span><span class="si">{}{:.2f}</span><span class="s2">%)</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-1488"><a href="#-1488"><span class="linenos">1488</span></a>                    <span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;totalChangesRUB&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-1489"><a href="#-1489"><span class="linenos">1489</span></a>                    <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;totalChangesRUB&quot;</span><span class="p">],</span>
</span><span id="L-1490"><a href="#-1490"><span class="linenos">1490</span></a>                    <span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;totalChangesPercentRUB&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-1491"><a href="#-1491"><span class="linenos">1491</span></a>                    <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;totalChangesPercentRUB&quot;</span><span class="p">],</span>
</span><span id="L-1492"><a href="#-1492"><span class="linenos">1492</span></a>                <span class="p">),</span>
</span><span id="L-1493"><a href="#-1493"><span class="linenos">1493</span></a>                <span class="s2">&quot;## Open positions</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-1494"><a href="#-1494"><span class="linenos">1494</span></a>                <span class="s2">&quot;| Ticker [FIGI]               | Volume (blocked)                | Lots     | Curr. price  | Avg. price   | Current volume cost | Profit (%)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-1495"><a href="#-1495"><span class="linenos">1495</span></a>                <span class="s2">&quot;|-----------------------------|---------------------------------|----------|--------------|--------------|---------------------|----------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-1496"><a href="#-1496"><span class="linenos">1496</span></a>                <span class="s2">&quot;| Ruble                       | </span><span class="si">{:&gt;31}</span><span class="s2"> |          |              |              |                     |</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-1497"><a href="#-1497"><span class="linenos">1497</span></a>                    <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2"> (</span><span class="si">{:.2f}</span><span class="s2">) rub&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-1498"><a href="#-1498"><span class="linenos">1498</span></a>                        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;availableRUB&quot;</span><span class="p">],</span>
</span><span id="L-1499"><a href="#-1499"><span class="linenos">1499</span></a>                        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;currentBlockedRUB&quot;</span><span class="p">],</span>
</span><span id="L-1500"><a href="#-1500"><span class="linenos">1500</span></a>                    <span class="p">)</span>
</span><span id="L-1501"><a href="#-1501"><span class="linenos">1501</span></a>                <span class="p">)</span>
</span><span id="L-1502"><a href="#-1502"><span class="linenos">1502</span></a>            <span class="p">]</span>
</span><span id="L-1503"><a href="#-1503"><span class="linenos">1503</span></a>
</span><span id="L-1504"><a href="#-1504"><span class="linenos">1504</span></a>            <span class="k">def</span> <span class="nf">_SplitStr</span><span class="p">(</span><span class="n">CostRUB</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">typeStr</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">noTradeStr</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="L-1505"><a href="#-1505"><span class="linenos">1505</span></a>                <span class="k">return</span> <span class="p">[</span>
</span><span id="L-1506"><a href="#-1506"><span class="linenos">1506</span></a>                    <span class="s2">&quot;|                             |                                 |          |              |              |                     |</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-1507"><a href="#-1507"><span class="linenos">1507</span></a>                    <span class="s2">&quot;| </span><span class="si">{:&lt;27}</span><span class="s2"> |                                 |          |              |              | </span><span class="si">{:&gt;19}</span><span class="s2"> |</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-1508"><a href="#-1508"><span class="linenos">1508</span></a>                        <span class="n">noTradeStr</span> <span class="k">if</span> <span class="n">noTradeStr</span> <span class="k">else</span> <span class="n">typeStr</span><span class="p">,</span>
</span><span id="L-1509"><a href="#-1509"><span class="linenos">1509</span></a>                        <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">noTradeStr</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2"> RUB&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">CostRUB</span><span class="p">),</span>
</span><span id="L-1510"><a href="#-1510"><span class="linenos">1510</span></a>                    <span class="p">),</span>
</span><span id="L-1511"><a href="#-1511"><span class="linenos">1511</span></a>                <span class="p">]</span>
</span><span id="L-1512"><a href="#-1512"><span class="linenos">1512</span></a>
</span><span id="L-1513"><a href="#-1513"><span class="linenos">1513</span></a>            <span class="k">def</span> <span class="nf">_InfoStr</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">showCurrencyName</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-1514"><a href="#-1514"><span class="linenos">1514</span></a>                <span class="k">return</span> <span class="s2">&quot;| </span><span class="si">{:&lt;27}</span><span class="s2"> | </span><span class="si">{:&gt;31}</span><span class="s2"> | </span><span class="si">{:&lt;8}</span><span class="s2"> | </span><span class="si">{:&gt;12}</span><span class="s2"> | </span><span class="si">{:&gt;12}</span><span class="s2"> | </span><span class="si">{:&gt;19}</span><span class="s2"> | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-1515"><a href="#-1515"><span class="linenos">1515</span></a>                    <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]),</span>
</span><span id="L-1516"><a href="#-1516"><span class="linenos">1516</span></a>                    <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2"> (</span><span class="si">{:.2f}</span><span class="s2">) </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-1517"><a href="#-1517"><span class="linenos">1517</span></a>                        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;volume&quot;</span><span class="p">],</span>
</span><span id="L-1518"><a href="#-1518"><span class="linenos">1518</span></a>                        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;blocked&quot;</span><span class="p">],</span>
</span><span id="L-1519"><a href="#-1519"><span class="linenos">1519</span></a>                        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="L-1520"><a href="#-1520"><span class="linenos">1520</span></a>                    <span class="p">)</span> <span class="k">if</span> <span class="n">showCurrencyName</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2"> (</span><span class="si">{:.0f}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-1521"><a href="#-1521"><span class="linenos">1521</span></a>                        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;volume&quot;</span><span class="p">],</span>
</span><span id="L-1522"><a href="#-1522"><span class="linenos">1522</span></a>                        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;blocked&quot;</span><span class="p">],</span>
</span><span id="L-1523"><a href="#-1523"><span class="linenos">1523</span></a>                    <span class="p">),</span>
</span><span id="L-1524"><a href="#-1524"><span class="linenos">1524</span></a>                    <span class="s2">&quot;</span><span class="si">{:.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;lots&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">showCurrencyName</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;lots&quot;</span><span class="p">]),</span>
</span><span id="L-1525"><a href="#-1525"><span class="linenos">1525</span></a>                    <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;baseCurrencyName&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;n/a&quot;</span><span class="p">,</span>
</span><span id="L-1526"><a href="#-1526"><span class="linenos">1526</span></a>                    <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;average&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;baseCurrencyName&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;average&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;n/a&quot;</span><span class="p">,</span>
</span><span id="L-1527"><a href="#-1527"><span class="linenos">1527</span></a>                    <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cost&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;baseCurrencyName&quot;</span><span class="p">]),</span>
</span><span id="L-1528"><a href="#-1528"><span class="linenos">1528</span></a>                    <span class="s2">&quot;</span><span class="si">{}{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}{:.2f}</span><span class="s2">%)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-1529"><a href="#-1529"><span class="linenos">1529</span></a>                        <span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;profit&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-1530"><a href="#-1530"><span class="linenos">1530</span></a>                        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;profit&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;baseCurrencyName&quot;</span><span class="p">],</span>
</span><span id="L-1531"><a href="#-1531"><span class="linenos">1531</span></a>                        <span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;percentProfit&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-1532"><a href="#-1532"><span class="linenos">1532</span></a>                        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;percentProfit&quot;</span><span class="p">],</span>
</span><span id="L-1533"><a href="#-1533"><span class="linenos">1533</span></a>                    <span class="p">),</span>
</span><span id="L-1534"><a href="#-1534"><span class="linenos">1534</span></a>                <span class="p">)</span>
</span><span id="L-1535"><a href="#-1535"><span class="linenos">1535</span></a>
</span><span id="L-1536"><a href="#-1536"><span class="linenos">1536</span></a>            <span class="c1"># --- Show currencies section:</span>
</span><span id="L-1537"><a href="#-1537"><span class="linenos">1537</span></a>            <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Currencies&quot;</span><span class="p">]:</span>
</span><span id="L-1538"><a href="#-1538"><span class="linenos">1538</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_SplitStr</span><span class="p">(</span><span class="n">CostRUB</span><span class="o">=</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByAssets&quot;</span><span class="p">][</span><span class="s2">&quot;Currencies&quot;</span><span class="p">][</span><span class="s2">&quot;cost&quot;</span><span class="p">],</span> <span class="n">typeStr</span><span class="o">=</span><span class="s2">&quot;**Currencies:**&quot;</span><span class="p">))</span>
</span><span id="L-1539"><a href="#-1539"><span class="linenos">1539</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Currencies&quot;</span><span class="p">]:</span>
</span><span id="L-1540"><a href="#-1540"><span class="linenos">1540</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_InfoStr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">showCurrencyName</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span><span id="L-1541"><a href="#-1541"><span class="linenos">1541</span></a>
</span><span id="L-1542"><a href="#-1542"><span class="linenos">1542</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1543"><a href="#-1543"><span class="linenos">1543</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_SplitStr</span><span class="p">(</span><span class="n">noTradeStr</span><span class="o">=</span><span class="s2">&quot;**Currencies:** no trades&quot;</span><span class="p">))</span>
</span><span id="L-1544"><a href="#-1544"><span class="linenos">1544</span></a>
</span><span id="L-1545"><a href="#-1545"><span class="linenos">1545</span></a>            <span class="c1"># --- Show stocks section:</span>
</span><span id="L-1546"><a href="#-1546"><span class="linenos">1546</span></a>            <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Shares&quot;</span><span class="p">]:</span>
</span><span id="L-1547"><a href="#-1547"><span class="linenos">1547</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_SplitStr</span><span class="p">(</span><span class="n">CostRUB</span><span class="o">=</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;stocksCostRUB&quot;</span><span class="p">],</span> <span class="n">typeStr</span><span class="o">=</span><span class="s2">&quot;**Stocks:**&quot;</span><span class="p">))</span>
</span><span id="L-1548"><a href="#-1548"><span class="linenos">1548</span></a>
</span><span id="L-1549"><a href="#-1549"><span class="linenos">1549</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Shares&quot;</span><span class="p">]:</span>
</span><span id="L-1550"><a href="#-1550"><span class="linenos">1550</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_InfoStr</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
</span><span id="L-1551"><a href="#-1551"><span class="linenos">1551</span></a>
</span><span id="L-1552"><a href="#-1552"><span class="linenos">1552</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1553"><a href="#-1553"><span class="linenos">1553</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_SplitStr</span><span class="p">(</span><span class="n">noTradeStr</span><span class="o">=</span><span class="s2">&quot;**Stocks:** no trades&quot;</span><span class="p">))</span>
</span><span id="L-1554"><a href="#-1554"><span class="linenos">1554</span></a>
</span><span id="L-1555"><a href="#-1555"><span class="linenos">1555</span></a>            <span class="c1"># --- Show bonds section:</span>
</span><span id="L-1556"><a href="#-1556"><span class="linenos">1556</span></a>            <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Bonds&quot;</span><span class="p">]:</span>
</span><span id="L-1557"><a href="#-1557"><span class="linenos">1557</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_SplitStr</span><span class="p">(</span><span class="n">CostRUB</span><span class="o">=</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;bondsCostRUB&quot;</span><span class="p">],</span> <span class="n">typeStr</span><span class="o">=</span><span class="s2">&quot;**Bonds:**&quot;</span><span class="p">))</span>
</span><span id="L-1558"><a href="#-1558"><span class="linenos">1558</span></a>
</span><span id="L-1559"><a href="#-1559"><span class="linenos">1559</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Bonds&quot;</span><span class="p">]:</span>
</span><span id="L-1560"><a href="#-1560"><span class="linenos">1560</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_InfoStr</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
</span><span id="L-1561"><a href="#-1561"><span class="linenos">1561</span></a>
</span><span id="L-1562"><a href="#-1562"><span class="linenos">1562</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1563"><a href="#-1563"><span class="linenos">1563</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_SplitStr</span><span class="p">(</span><span class="n">noTradeStr</span><span class="o">=</span><span class="s2">&quot;**Bonds:** no trades&quot;</span><span class="p">))</span>
</span><span id="L-1564"><a href="#-1564"><span class="linenos">1564</span></a>
</span><span id="L-1565"><a href="#-1565"><span class="linenos">1565</span></a>            <span class="c1"># --- Show etfs section:</span>
</span><span id="L-1566"><a href="#-1566"><span class="linenos">1566</span></a>            <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Etfs&quot;</span><span class="p">]:</span>
</span><span id="L-1567"><a href="#-1567"><span class="linenos">1567</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_SplitStr</span><span class="p">(</span><span class="n">CostRUB</span><span class="o">=</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;etfsCostRUB&quot;</span><span class="p">],</span> <span class="n">typeStr</span><span class="o">=</span><span class="s2">&quot;**Etfs:**&quot;</span><span class="p">))</span>
</span><span id="L-1568"><a href="#-1568"><span class="linenos">1568</span></a>
</span><span id="L-1569"><a href="#-1569"><span class="linenos">1569</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Etfs&quot;</span><span class="p">]:</span>
</span><span id="L-1570"><a href="#-1570"><span class="linenos">1570</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_InfoStr</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
</span><span id="L-1571"><a href="#-1571"><span class="linenos">1571</span></a>
</span><span id="L-1572"><a href="#-1572"><span class="linenos">1572</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1573"><a href="#-1573"><span class="linenos">1573</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_SplitStr</span><span class="p">(</span><span class="n">noTradeStr</span><span class="o">=</span><span class="s2">&quot;**Etfs:** no trades&quot;</span><span class="p">))</span>
</span><span id="L-1574"><a href="#-1574"><span class="linenos">1574</span></a>
</span><span id="L-1575"><a href="#-1575"><span class="linenos">1575</span></a>            <span class="c1"># --- Show futures section:</span>
</span><span id="L-1576"><a href="#-1576"><span class="linenos">1576</span></a>            <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Futures&quot;</span><span class="p">]:</span>
</span><span id="L-1577"><a href="#-1577"><span class="linenos">1577</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_SplitStr</span><span class="p">(</span><span class="n">CostRUB</span><span class="o">=</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;futuresCostRUB&quot;</span><span class="p">],</span> <span class="n">typeStr</span><span class="o">=</span><span class="s2">&quot;**Futures:**&quot;</span><span class="p">))</span>
</span><span id="L-1578"><a href="#-1578"><span class="linenos">1578</span></a>
</span><span id="L-1579"><a href="#-1579"><span class="linenos">1579</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Futures&quot;</span><span class="p">]:</span>
</span><span id="L-1580"><a href="#-1580"><span class="linenos">1580</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_InfoStr</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
</span><span id="L-1581"><a href="#-1581"><span class="linenos">1581</span></a>
</span><span id="L-1582"><a href="#-1582"><span class="linenos">1582</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1583"><a href="#-1583"><span class="linenos">1583</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_SplitStr</span><span class="p">(</span><span class="n">noTradeStr</span><span class="o">=</span><span class="s2">&quot;**Futures:** no trades&quot;</span><span class="p">))</span>
</span><span id="L-1584"><a href="#-1584"><span class="linenos">1584</span></a>
</span><span id="L-1585"><a href="#-1585"><span class="linenos">1585</span></a>            <span class="c1"># --- Show pending orders section:</span>
</span><span id="L-1586"><a href="#-1586"><span class="linenos">1586</span></a>            <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;orders&quot;</span><span class="p">]:</span>
</span><span id="L-1587"><a href="#-1587"><span class="linenos">1587</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span><span id="L-1588"><a href="#-1588"><span class="linenos">1588</span></a>                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">## Opened pending limit-orders: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;orders&quot;</span><span class="p">])),</span>
</span><span id="L-1589"><a href="#-1589"><span class="linenos">1589</span></a>                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">| Ticker [FIGI]               | Order ID       | Lots (exec.) | Current price (</span><span class="si">% d</span><span class="s2">elta) | Target price  | Action    | Type      | Create date (UTC)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-1590"><a href="#-1590"><span class="linenos">1590</span></a>                    <span class="s2">&quot;|-----------------------------|----------------|--------------|-------------------------|---------------|-----------|-----------|---------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-1591"><a href="#-1591"><span class="linenos">1591</span></a>                <span class="p">])</span>
</span><span id="L-1592"><a href="#-1592"><span class="linenos">1592</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;orders&quot;</span><span class="p">]:</span>
</span><span id="L-1593"><a href="#-1593"><span class="linenos">1593</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| </span><span class="si">{:&lt;27}</span><span class="s2"> | </span><span class="si">{:&lt;14}</span><span class="s2"> | </span><span class="si">{:&lt;12}</span><span class="s2"> | </span><span class="si">{:&gt;23}</span><span class="s2"> | </span><span class="si">{:&gt;13}</span><span class="s2"> | </span><span class="si">{:&lt;9}</span><span class="s2"> | </span><span class="si">{:&lt;9}</span><span class="s2"> | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-1594"><a href="#-1594"><span class="linenos">1594</span></a>                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]),</span>
</span><span id="L-1595"><a href="#-1595"><span class="linenos">1595</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;orderID&quot;</span><span class="p">],</span>
</span><span id="L-1596"><a href="#-1596"><span class="linenos">1596</span></a>                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;lotsRequested&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;lotsExecuted&quot;</span><span class="p">]),</span>
</span><span id="L-1597"><a href="#-1597"><span class="linenos">1597</span></a>                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}{:.2f}</span><span class="s2">%)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-1598"><a href="#-1598"><span class="linenos">1598</span></a>                            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">])),</span>
</span><span id="L-1599"><a href="#-1599"><span class="linenos">1599</span></a>                            <span class="n">item</span><span class="p">[</span><span class="s2">&quot;baseCurrencyName&quot;</span><span class="p">],</span>
</span><span id="L-1600"><a href="#-1600"><span class="linenos">1600</span></a>                            <span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;percentChanges&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-1601"><a href="#-1601"><span class="linenos">1601</span></a>                            <span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;percentChanges&quot;</span><span class="p">]),</span>
</span><span id="L-1602"><a href="#-1602"><span class="linenos">1602</span></a>                        <span class="p">),</span>
</span><span id="L-1603"><a href="#-1603"><span class="linenos">1603</span></a>                        <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;targetPrice&quot;</span><span class="p">]),</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;baseCurrencyName&quot;</span><span class="p">]),</span>
</span><span id="L-1604"><a href="#-1604"><span class="linenos">1604</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">],</span>
</span><span id="L-1605"><a href="#-1605"><span class="linenos">1605</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span>
</span><span id="L-1606"><a href="#-1606"><span class="linenos">1606</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">],</span>
</span><span id="L-1607"><a href="#-1607"><span class="linenos">1607</span></a>                    <span class="p">))</span>
</span><span id="L-1608"><a href="#-1608"><span class="linenos">1608</span></a>
</span><span id="L-1609"><a href="#-1609"><span class="linenos">1609</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1610"><a href="#-1610"><span class="linenos">1610</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">## Total pending limit-orders: 0</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1611"><a href="#-1611"><span class="linenos">1611</span></a>
</span><span id="L-1612"><a href="#-1612"><span class="linenos">1612</span></a>            <span class="c1"># --- Show stop orders section:</span>
</span><span id="L-1613"><a href="#-1613"><span class="linenos">1613</span></a>            <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;stopOrders&quot;</span><span class="p">]:</span>
</span><span id="L-1614"><a href="#-1614"><span class="linenos">1614</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span><span id="L-1615"><a href="#-1615"><span class="linenos">1615</span></a>                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">## Opened stop-orders: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;stopOrders&quot;</span><span class="p">])),</span>
</span><span id="L-1616"><a href="#-1616"><span class="linenos">1616</span></a>                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">| Ticker [FIGI]               | Stop order ID                        | Lots   | Current price (</span><span class="si">% d</span><span class="s2">elta) | Target price  | Limit price   | Action    | Type        | Expire type  | Create date (UTC)   | Expiration (UTC)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-1617"><a href="#-1617"><span class="linenos">1617</span></a>                    <span class="s2">&quot;|-----------------------------|--------------------------------------|--------|-------------------------|---------------|---------------|-----------|-------------|--------------|---------------------|---------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-1618"><a href="#-1618"><span class="linenos">1618</span></a>                <span class="p">])</span>
</span><span id="L-1619"><a href="#-1619"><span class="linenos">1619</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;stopOrders&quot;</span><span class="p">]:</span>
</span><span id="L-1620"><a href="#-1620"><span class="linenos">1620</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| </span><span class="si">{:&lt;27}</span><span class="s2"> | </span><span class="si">{:&lt;14}</span><span class="s2"> | </span><span class="si">{:&lt;6}</span><span class="s2"> | </span><span class="si">{:&gt;23}</span><span class="s2"> | </span><span class="si">{:&gt;13}</span><span class="s2"> | </span><span class="si">{:&gt;13}</span><span class="s2"> | </span><span class="si">{:&lt;9}</span><span class="s2"> | </span><span class="si">{:&lt;11}</span><span class="s2"> | </span><span class="si">{:&lt;12}</span><span class="s2"> | </span><span class="si">{:&lt;19}</span><span class="s2"> | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-1621"><a href="#-1621"><span class="linenos">1621</span></a>                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]),</span>
</span><span id="L-1622"><a href="#-1622"><span class="linenos">1622</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;orderID&quot;</span><span class="p">],</span>
</span><span id="L-1623"><a href="#-1623"><span class="linenos">1623</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;lotsRequested&quot;</span><span class="p">],</span>
</span><span id="L-1624"><a href="#-1624"><span class="linenos">1624</span></a>                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}{:.2f}</span><span class="s2">%)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-1625"><a href="#-1625"><span class="linenos">1625</span></a>                            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">])),</span>
</span><span id="L-1626"><a href="#-1626"><span class="linenos">1626</span></a>                            <span class="n">item</span><span class="p">[</span><span class="s2">&quot;baseCurrencyName&quot;</span><span class="p">],</span>
</span><span id="L-1627"><a href="#-1627"><span class="linenos">1627</span></a>                            <span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;percentChanges&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-1628"><a href="#-1628"><span class="linenos">1628</span></a>                            <span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;percentChanges&quot;</span><span class="p">]),</span>
</span><span id="L-1629"><a href="#-1629"><span class="linenos">1629</span></a>                        <span class="p">),</span>
</span><span id="L-1630"><a href="#-1630"><span class="linenos">1630</span></a>                        <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;targetPrice&quot;</span><span class="p">]),</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;baseCurrencyName&quot;</span><span class="p">]),</span>
</span><span id="L-1631"><a href="#-1631"><span class="linenos">1631</span></a>                        <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;limitPrice&quot;</span><span class="p">]),</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;baseCurrencyName&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;limitPrice&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;limitPrice&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;targetPrice&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="n">TKS_ORDER_TYPES</span><span class="p">[</span><span class="s2">&quot;ORDER_TYPE_MARKET&quot;</span><span class="p">],</span>
</span><span id="L-1632"><a href="#-1632"><span class="linenos">1632</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">],</span>
</span><span id="L-1633"><a href="#-1633"><span class="linenos">1633</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span>
</span><span id="L-1634"><a href="#-1634"><span class="linenos">1634</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;expType&quot;</span><span class="p">],</span>
</span><span id="L-1635"><a href="#-1635"><span class="linenos">1635</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;createDate&quot;</span><span class="p">],</span>
</span><span id="L-1636"><a href="#-1636"><span class="linenos">1636</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;expDate&quot;</span><span class="p">],</span>
</span><span id="L-1637"><a href="#-1637"><span class="linenos">1637</span></a>                    <span class="p">))</span>
</span><span id="L-1638"><a href="#-1638"><span class="linenos">1638</span></a>
</span><span id="L-1639"><a href="#-1639"><span class="linenos">1639</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1640"><a href="#-1640"><span class="linenos">1640</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">## Total stop-orders: 0</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1641"><a href="#-1641"><span class="linenos">1641</span></a>
</span><span id="L-1642"><a href="#-1642"><span class="linenos">1642</span></a>            <span class="c1"># -- Show analytics section:</span>
</span><span id="L-1643"><a href="#-1643"><span class="linenos">1643</span></a>            <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1644"><a href="#-1644"><span class="linenos">1644</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span><span id="L-1645"><a href="#-1645"><span class="linenos">1645</span></a>                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"># Analytics</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-1646"><a href="#-1646"><span class="linenos">1646</span></a>                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">* **Current total portfolio cost:** </span><span class="si">{:.2f}</span><span class="s2"> RUB</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]),</span>
</span><span id="L-1647"><a href="#-1647"><span class="linenos">1647</span></a>                    <span class="s2">&quot;* **Changes:** </span><span class="si">{}{:.2f}</span><span class="s2"> RUB (</span><span class="si">{}{:.2f}</span><span class="s2">%)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-1648"><a href="#-1648"><span class="linenos">1648</span></a>                        <span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;totalChangesRUB&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-1649"><a href="#-1649"><span class="linenos">1649</span></a>                        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;totalChangesRUB&quot;</span><span class="p">],</span>
</span><span id="L-1650"><a href="#-1650"><span class="linenos">1650</span></a>                        <span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;totalChangesPercentRUB&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-1651"><a href="#-1651"><span class="linenos">1651</span></a>                        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;totalChangesPercentRUB&quot;</span><span class="p">],</span>
</span><span id="L-1652"><a href="#-1652"><span class="linenos">1652</span></a>                    <span class="p">),</span>
</span><span id="L-1653"><a href="#-1653"><span class="linenos">1653</span></a>                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">## Portfolio distribution by assets</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-1654"><a href="#-1654"><span class="linenos">1654</span></a>                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">| Type       | Uniques | Percent | Current cost</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-1655"><a href="#-1655"><span class="linenos">1655</span></a>                    <span class="s2">&quot;|------------|---------|---------|-----------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-1656"><a href="#-1656"><span class="linenos">1656</span></a>                <span class="p">])</span>
</span><span id="L-1657"><a href="#-1657"><span class="linenos">1657</span></a>
</span><span id="L-1658"><a href="#-1658"><span class="linenos">1658</span></a>                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByAssets&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-1659"><a href="#-1659"><span class="linenos">1659</span></a>                    <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByAssets&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;cost&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1660"><a href="#-1660"><span class="linenos">1660</span></a>                        <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| </span><span class="si">{:&lt;10}</span><span class="s2"> | </span><span class="si">{:&lt;7}</span><span class="s2"> | </span><span class="si">{:&lt;7}</span><span class="s2"> | </span><span class="si">{:.2f}</span><span class="s2"> rub</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-1661"><a href="#-1661"><span class="linenos">1661</span></a>                            <span class="n">key</span><span class="p">,</span>
</span><span id="L-1662"><a href="#-1662"><span class="linenos">1662</span></a>                            <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByAssets&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;uniques&quot;</span><span class="p">],</span>
</span><span id="L-1663"><a href="#-1663"><span class="linenos">1663</span></a>                            <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByAssets&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;percent&quot;</span><span class="p">]),</span>
</span><span id="L-1664"><a href="#-1664"><span class="linenos">1664</span></a>                            <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByAssets&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;cost&quot;</span><span class="p">],</span>
</span><span id="L-1665"><a href="#-1665"><span class="linenos">1665</span></a>                        <span class="p">))</span>
</span><span id="L-1666"><a href="#-1666"><span class="linenos">1666</span></a>
</span><span id="L-1667"><a href="#-1667"><span class="linenos">1667</span></a>                <span class="n">maxLenNames</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">+</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">company</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCompanies&quot;</span><span class="p">][</span><span class="n">company</span><span class="p">][</span><span class="s2">&quot;ticker&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">company</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCompanies&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
</span><span id="L-1668"><a href="#-1668"><span class="linenos">1668</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span><span id="L-1669"><a href="#-1669"><span class="linenos">1669</span></a>                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">## Portfolio distribution by companies</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-1670"><a href="#-1670"><span class="linenos">1670</span></a>                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">| Company</span><span class="si">{}</span><span class="s2"> | Percent | Current cost</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxLenNames</span> <span class="o">-</span> <span class="mi">7</span><span class="p">)),</span>
</span><span id="L-1671"><a href="#-1671"><span class="linenos">1671</span></a>                    <span class="s2">&quot;|--------</span><span class="si">{}</span><span class="s2">-|---------|-----------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxLenNames</span> <span class="o">-</span> <span class="mi">7</span><span class="p">)),</span>
</span><span id="L-1672"><a href="#-1672"><span class="linenos">1672</span></a>                <span class="p">])</span>
</span><span id="L-1673"><a href="#-1673"><span class="linenos">1673</span></a>
</span><span id="L-1674"><a href="#-1674"><span class="linenos">1674</span></a>                <span class="k">for</span> <span class="n">company</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCompanies&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-1675"><a href="#-1675"><span class="linenos">1675</span></a>                    <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCompanies&quot;</span><span class="p">][</span><span class="n">company</span><span class="p">][</span><span class="s2">&quot;cost&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1676"><a href="#-1676"><span class="linenos">1676</span></a>                        <span class="n">nameLen</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">company</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCompanies&quot;</span><span class="p">][</span><span class="n">company</span><span class="p">][</span><span class="s2">&quot;ticker&quot;</span><span class="p">])</span>
</span><span id="L-1677"><a href="#-1677"><span class="linenos">1677</span></a>                        <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| </span><span class="si">{}</span><span class="s2"> | </span><span class="si">{:&lt;7}</span><span class="s2"> | </span><span class="si">{:.2f}</span><span class="s2"> rub</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-1678"><a href="#-1678"><span class="linenos">1678</span></a>                            <span class="s2">&quot;</span><span class="si">{}{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-1679"><a href="#-1679"><span class="linenos">1679</span></a>                                <span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">] &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCompanies&quot;</span><span class="p">][</span><span class="n">company</span><span class="p">][</span><span class="s2">&quot;ticker&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCompanies&quot;</span><span class="p">][</span><span class="n">company</span><span class="p">][</span><span class="s2">&quot;ticker&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-1680"><a href="#-1680"><span class="linenos">1680</span></a>                                <span class="n">company</span><span class="p">,</span>
</span><span id="L-1681"><a href="#-1681"><span class="linenos">1681</span></a>                                <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">nameLen</span> <span class="o">==</span> <span class="n">maxLenNames</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxLenNames</span> <span class="o">-</span> <span class="n">nameLen</span><span class="p">)</span> <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCompanies&quot;</span><span class="p">][</span><span class="n">company</span><span class="p">][</span><span class="s2">&quot;ticker&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxLenNames</span> <span class="o">-</span> <span class="n">nameLen</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)),</span>
</span><span id="L-1682"><a href="#-1682"><span class="linenos">1682</span></a>                            <span class="p">),</span>
</span><span id="L-1683"><a href="#-1683"><span class="linenos">1683</span></a>                            <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCompanies&quot;</span><span class="p">][</span><span class="n">company</span><span class="p">][</span><span class="s2">&quot;percent&quot;</span><span class="p">]),</span>
</span><span id="L-1684"><a href="#-1684"><span class="linenos">1684</span></a>                            <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCompanies&quot;</span><span class="p">][</span><span class="n">company</span><span class="p">][</span><span class="s2">&quot;cost&quot;</span><span class="p">],</span>
</span><span id="L-1685"><a href="#-1685"><span class="linenos">1685</span></a>                        <span class="p">))</span>
</span><span id="L-1686"><a href="#-1686"><span class="linenos">1686</span></a>
</span><span id="L-1687"><a href="#-1687"><span class="linenos">1687</span></a>                <span class="n">maxLenSectors</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">sector</span><span class="p">)</span> <span class="k">for</span> <span class="n">sector</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrBySectors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
</span><span id="L-1688"><a href="#-1688"><span class="linenos">1688</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span><span id="L-1689"><a href="#-1689"><span class="linenos">1689</span></a>                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">## Portfolio distribution by sectors</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-1690"><a href="#-1690"><span class="linenos">1690</span></a>                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">| Sector</span><span class="si">{}</span><span class="s2"> | Percent | Current cost</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxLenSectors</span> <span class="o">-</span> <span class="mi">6</span><span class="p">)),</span>
</span><span id="L-1691"><a href="#-1691"><span class="linenos">1691</span></a>                    <span class="s2">&quot;|-------</span><span class="si">{}</span><span class="s2">-|---------|-----------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxLenSectors</span> <span class="o">-</span> <span class="mi">6</span><span class="p">)),</span>
</span><span id="L-1692"><a href="#-1692"><span class="linenos">1692</span></a>                <span class="p">])</span>
</span><span id="L-1693"><a href="#-1693"><span class="linenos">1693</span></a>
</span><span id="L-1694"><a href="#-1694"><span class="linenos">1694</span></a>                <span class="k">for</span> <span class="n">sector</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrBySectors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-1695"><a href="#-1695"><span class="linenos">1695</span></a>                    <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrBySectors&quot;</span><span class="p">][</span><span class="n">sector</span><span class="p">][</span><span class="s2">&quot;cost&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1696"><a href="#-1696"><span class="linenos">1696</span></a>                        <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| </span><span class="si">{}{}</span><span class="s2"> | </span><span class="si">{:&lt;7}</span><span class="s2"> | </span><span class="si">{:.2f}</span><span class="s2"> rub</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-1697"><a href="#-1697"><span class="linenos">1697</span></a>                            <span class="n">sector</span><span class="p">,</span>
</span><span id="L-1698"><a href="#-1698"><span class="linenos">1698</span></a>                            <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sector</span><span class="p">)</span> <span class="o">==</span> <span class="n">maxLenSectors</span> <span class="k">else</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxLenSectors</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">sector</span><span class="p">)),</span>
</span><span id="L-1699"><a href="#-1699"><span class="linenos">1699</span></a>                            <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrBySectors&quot;</span><span class="p">][</span><span class="n">sector</span><span class="p">][</span><span class="s2">&quot;percent&quot;</span><span class="p">]),</span>
</span><span id="L-1700"><a href="#-1700"><span class="linenos">1700</span></a>                            <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrBySectors&quot;</span><span class="p">][</span><span class="n">sector</span><span class="p">][</span><span class="s2">&quot;cost&quot;</span><span class="p">],</span>
</span><span id="L-1701"><a href="#-1701"><span class="linenos">1701</span></a>                        <span class="p">))</span>
</span><span id="L-1702"><a href="#-1702"><span class="linenos">1702</span></a>
</span><span id="L-1703"><a href="#-1703"><span class="linenos">1703</span></a>                <span class="n">maxLenMoney</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">+</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">currency</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCurrencies&quot;</span><span class="p">][</span><span class="n">currency</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">currency</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCurrencies&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
</span><span id="L-1704"><a href="#-1704"><span class="linenos">1704</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span><span id="L-1705"><a href="#-1705"><span class="linenos">1705</span></a>                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">## Portfolio distribution by currencies</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-1706"><a href="#-1706"><span class="linenos">1706</span></a>                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">| Instruments currencies</span><span class="si">{}</span><span class="s2"> | Percent | Current cost</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxLenMoney</span> <span class="o">-</span> <span class="mi">22</span><span class="p">)),</span>
</span><span id="L-1707"><a href="#-1707"><span class="linenos">1707</span></a>                    <span class="s2">&quot;|-----------------------</span><span class="si">{}</span><span class="s2">-|---------|-----------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxLenMoney</span> <span class="o">-</span> <span class="mi">22</span><span class="p">)),</span>
</span><span id="L-1708"><a href="#-1708"><span class="linenos">1708</span></a>                <span class="p">])</span>
</span><span id="L-1709"><a href="#-1709"><span class="linenos">1709</span></a>
</span><span id="L-1710"><a href="#-1710"><span class="linenos">1710</span></a>                <span class="k">for</span> <span class="n">curr</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCurrencies&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-1711"><a href="#-1711"><span class="linenos">1711</span></a>                    <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCurrencies&quot;</span><span class="p">][</span><span class="n">curr</span><span class="p">][</span><span class="s2">&quot;cost&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1712"><a href="#-1712"><span class="linenos">1712</span></a>                        <span class="n">nameLen</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">curr</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCurrencies&quot;</span><span class="p">][</span><span class="n">curr</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
</span><span id="L-1713"><a href="#-1713"><span class="linenos">1713</span></a>                        <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| </span><span class="si">{}</span><span class="s2"> | </span><span class="si">{:&lt;7}</span><span class="s2"> | </span><span class="si">{:.2f}</span><span class="s2"> rub</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-1714"><a href="#-1714"><span class="linenos">1714</span></a>                            <span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">] </span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-1715"><a href="#-1715"><span class="linenos">1715</span></a>                                <span class="n">curr</span><span class="p">,</span>
</span><span id="L-1716"><a href="#-1716"><span class="linenos">1716</span></a>                                <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCurrencies&quot;</span><span class="p">][</span><span class="n">curr</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
</span><span id="L-1717"><a href="#-1717"><span class="linenos">1717</span></a>                                <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">nameLen</span> <span class="o">==</span> <span class="n">maxLenMoney</span> <span class="k">else</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxLenMoney</span> <span class="o">-</span> <span class="n">nameLen</span><span class="p">),</span>
</span><span id="L-1718"><a href="#-1718"><span class="linenos">1718</span></a>                            <span class="p">),</span>
</span><span id="L-1719"><a href="#-1719"><span class="linenos">1719</span></a>                            <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCurrencies&quot;</span><span class="p">][</span><span class="n">curr</span><span class="p">][</span><span class="s2">&quot;percent&quot;</span><span class="p">]),</span>
</span><span id="L-1720"><a href="#-1720"><span class="linenos">1720</span></a>                            <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCurrencies&quot;</span><span class="p">][</span><span class="n">curr</span><span class="p">][</span><span class="s2">&quot;cost&quot;</span><span class="p">],</span>
</span><span id="L-1721"><a href="#-1721"><span class="linenos">1721</span></a>                        <span class="p">))</span>
</span><span id="L-1722"><a href="#-1722"><span class="linenos">1722</span></a>
</span><span id="L-1723"><a href="#-1723"><span class="linenos">1723</span></a>            <span class="n">infoText</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
</span><span id="L-1724"><a href="#-1724"><span class="linenos">1724</span></a>
</span><span id="L-1725"><a href="#-1725"><span class="linenos">1725</span></a>            <span class="k">if</span> <span class="n">showStatistics</span><span class="p">:</span>
</span><span id="L-1726"><a href="#-1726"><span class="linenos">1726</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Statistics of client&#39;s portfolio:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">infoText</span><span class="p">))</span>
</span><span id="L-1727"><a href="#-1727"><span class="linenos">1727</span></a>
</span><span id="L-1728"><a href="#-1728"><span class="linenos">1728</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">overviewFile</span><span class="p">:</span>
</span><span id="L-1729"><a href="#-1729"><span class="linenos">1729</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overviewFile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fH</span><span class="p">:</span>
</span><span id="L-1730"><a href="#-1730"><span class="linenos">1730</span></a>                    <span class="n">fH</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">infoText</span><span class="p">)</span>
</span><span id="L-1731"><a href="#-1731"><span class="linenos">1731</span></a>
</span><span id="L-1732"><a href="#-1732"><span class="linenos">1732</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Client&#39;s portfolio is saved to file: [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overviewFile</span><span class="p">)))</span>
</span><span id="L-1733"><a href="#-1733"><span class="linenos">1733</span></a>
</span><span id="L-1734"><a href="#-1734"><span class="linenos">1734</span></a>        <span class="k">return</span> <span class="n">view</span>
</span><span id="L-1735"><a href="#-1735"><span class="linenos">1735</span></a>
</span><span id="L-1736"><a href="#-1736"><span class="linenos">1736</span></a>    <span class="k">def</span> <span class="nf">Deals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">printDeals</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
</span><span id="L-1737"><a href="#-1737"><span class="linenos">1737</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1738"><a href="#-1738"><span class="linenos">1738</span></a><span class="sd">        Returns history operations between two given dates.</span>
</span><span id="L-1739"><a href="#-1739"><span class="linenos">1739</span></a><span class="sd">        If `reportFile` string is not empty then also save human-readable report.</span>
</span><span id="L-1740"><a href="#-1740"><span class="linenos">1740</span></a><span class="sd">        Shows some statistical data of closed positions.</span>
</span><span id="L-1741"><a href="#-1741"><span class="linenos">1741</span></a>
</span><span id="L-1742"><a href="#-1742"><span class="linenos">1742</span></a><span class="sd">        :param start: see docstring in `GetDatesAsString()` method</span>
</span><span id="L-1743"><a href="#-1743"><span class="linenos">1743</span></a><span class="sd">        :param end: see docstring in `GetDatesAsString()` method</span>
</span><span id="L-1744"><a href="#-1744"><span class="linenos">1744</span></a><span class="sd">        :param printDeals: if `True` then also print all records to the console.</span>
</span><span id="L-1745"><a href="#-1745"><span class="linenos">1745</span></a><span class="sd">        :return: original list of dictionaries with history of deals records from API (&quot;operations&quot; key):</span>
</span><span id="L-1746"><a href="#-1746"><span class="linenos">1746</span></a><span class="sd">                 https://tinkoff.github.io/investAPI/swagger-ui/#/OperationsService/OperationsService_GetOperations</span>
</span><span id="L-1747"><a href="#-1747"><span class="linenos">1747</span></a><span class="sd">                 and dictionary with custom stats: operations in different currencies, withdrawals, incomes etc.</span>
</span><span id="L-1748"><a href="#-1748"><span class="linenos">1748</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1749"><a href="#-1749"><span class="linenos">1749</span></a>        <span class="n">startDate</span><span class="p">,</span> <span class="n">endDate</span> <span class="o">=</span> <span class="n">GetDatesAsString</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>  <span class="c1"># Example: (&quot;2000-01-01T00:00:00Z&quot;, &quot;2022-12-31T23:59:59Z&quot;)</span>
</span><span id="L-1750"><a href="#-1750"><span class="linenos">1750</span></a>
</span><span id="L-1751"><a href="#-1751"><span class="linenos">1751</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Requesting history of a client&#39;s operations. Wait, please...&quot;</span><span class="p">)</span>
</span><span id="L-1752"><a href="#-1752"><span class="linenos">1752</span></a>
</span><span id="L-1753"><a href="#-1753"><span class="linenos">1753</span></a>        <span class="c1"># REST API for request: https://tinkoff.github.io/investAPI/swagger-ui/#/OperationsService/OperationsService_GetOperations</span>
</span><span id="L-1754"><a href="#-1754"><span class="linenos">1754</span></a>        <span class="n">dealsURL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;/tinkoff.public.invest.api.contract.v1.OperationsService/GetOperations&quot;</span>
</span><span id="L-1755"><a href="#-1755"><span class="linenos">1755</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="nb">str</span><span class="p">({</span><span class="s2">&quot;accountId&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">accountId</span><span class="p">,</span> <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="n">startDate</span><span class="p">,</span> <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="n">endDate</span><span class="p">})</span>
</span><span id="L-1756"><a href="#-1756"><span class="linenos">1756</span></a>        <span class="n">ops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SendAPIRequest</span><span class="p">(</span><span class="n">dealsURL</span><span class="p">,</span> <span class="n">reqType</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">)[</span><span class="s2">&quot;operations&quot;</span><span class="p">]</span>  <span class="c1"># list of dict: operations returns by broker</span>
</span><span id="L-1757"><a href="#-1757"><span class="linenos">1757</span></a>        <span class="n">customStat</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># custom statistics in additional to responseJSON</span>
</span><span id="L-1758"><a href="#-1758"><span class="linenos">1758</span></a>
</span><span id="L-1759"><a href="#-1759"><span class="linenos">1759</span></a>        <span class="c1"># --- output report in human-readable format:</span>
</span><span id="L-1760"><a href="#-1760"><span class="linenos">1760</span></a>        <span class="k">if</span> <span class="n">printDeals</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">reportFile</span><span class="p">:</span>
</span><span id="L-1761"><a href="#-1761"><span class="linenos">1761</span></a>            <span class="n">splitLine1</span> <span class="o">=</span> <span class="s2">&quot;|                            |                               |                              |                      |</span><span class="se">\n</span><span class="s2">&quot;</span>  <span class="c1"># Summary section</span>
</span><span id="L-1762"><a href="#-1762"><span class="linenos">1762</span></a>            <span class="n">splitLine2</span> <span class="o">=</span> <span class="s2">&quot;|                     |              |              |            |           |                 |            |</span><span class="se">\n</span><span class="s2">&quot;</span>  <span class="c1"># Operations section</span>
</span><span id="L-1763"><a href="#-1763"><span class="linenos">1763</span></a>            <span class="n">nextDay</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="L-1764"><a href="#-1764"><span class="linenos">1764</span></a>
</span><span id="L-1765"><a href="#-1765"><span class="linenos">1765</span></a>            <span class="n">info</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;# Client&#39;s operations</span><span class="se">\n\n</span><span class="s2">* **Period:** from [</span><span class="si">{}</span><span class="s2">] to [</span><span class="si">{}</span><span class="s2">]</span><span class="se">\n\n</span><span class="s2">## Summary (operations executed only)</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">startDate</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">endDate</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])]</span>
</span><span id="L-1766"><a href="#-1766"><span class="linenos">1766</span></a>
</span><span id="L-1767"><a href="#-1767"><span class="linenos">1767</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ops</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1768"><a href="#-1768"><span class="linenos">1768</span></a>                <span class="n">customStat</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1769"><a href="#-1769"><span class="linenos">1769</span></a>                    <span class="s2">&quot;opsCount&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># total operations count</span>
</span><span id="L-1770"><a href="#-1770"><span class="linenos">1770</span></a>                    <span class="s2">&quot;buyCount&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># buy operations</span>
</span><span id="L-1771"><a href="#-1771"><span class="linenos">1771</span></a>                    <span class="s2">&quot;sellCount&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># sell operations</span>
</span><span id="L-1772"><a href="#-1772"><span class="linenos">1772</span></a>                    <span class="s2">&quot;buyTotal&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rub&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">},</span>  <span class="c1"># Buy sums in different currencies</span>
</span><span id="L-1773"><a href="#-1773"><span class="linenos">1773</span></a>                    <span class="s2">&quot;sellTotal&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rub&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">},</span>  <span class="c1"># Sell sums in different currencies</span>
</span><span id="L-1774"><a href="#-1774"><span class="linenos">1774</span></a>                    <span class="s2">&quot;payIn&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rub&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">},</span>  <span class="c1"># Deposit brokerage account</span>
</span><span id="L-1775"><a href="#-1775"><span class="linenos">1775</span></a>                    <span class="s2">&quot;payOut&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rub&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">},</span>  <span class="c1"># Withdrawals</span>
</span><span id="L-1776"><a href="#-1776"><span class="linenos">1776</span></a>                    <span class="s2">&quot;divs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rub&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">},</span>  <span class="c1"># Dividends income</span>
</span><span id="L-1777"><a href="#-1777"><span class="linenos">1777</span></a>                    <span class="s2">&quot;coupons&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rub&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">},</span>  <span class="c1"># Coupon&#39;s income</span>
</span><span id="L-1778"><a href="#-1778"><span class="linenos">1778</span></a>                    <span class="s2">&quot;brokerCom&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rub&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">},</span>  <span class="c1"># Service commissions</span>
</span><span id="L-1779"><a href="#-1779"><span class="linenos">1779</span></a>                    <span class="s2">&quot;serviceCom&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rub&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">},</span>  <span class="c1"># Service commissions</span>
</span><span id="L-1780"><a href="#-1780"><span class="linenos">1780</span></a>                    <span class="s2">&quot;marginCom&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rub&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">},</span>  <span class="c1"># Margin commissions</span>
</span><span id="L-1781"><a href="#-1781"><span class="linenos">1781</span></a>                    <span class="s2">&quot;allTaxes&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rub&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">},</span>  <span class="c1"># Sum of withholding taxes and corrections</span>
</span><span id="L-1782"><a href="#-1782"><span class="linenos">1782</span></a>                <span class="p">}</span>
</span><span id="L-1783"><a href="#-1783"><span class="linenos">1783</span></a>
</span><span id="L-1784"><a href="#-1784"><span class="linenos">1784</span></a>                <span class="c1"># --- calculating statistics depends on operations type in TKS_OPERATION_TYPES:</span>
</span><span id="L-1785"><a href="#-1785"><span class="linenos">1785</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">:</span>
</span><span id="L-1786"><a href="#-1786"><span class="linenos">1786</span></a>                    <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;OPERATION_STATE_EXECUTED&quot;</span><span class="p">:</span>
</span><span id="L-1787"><a href="#-1787"><span class="linenos">1787</span></a>                        <span class="n">payment</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>
</span><span id="L-1788"><a href="#-1788"><span class="linenos">1788</span></a>
</span><span id="L-1789"><a href="#-1789"><span class="linenos">1789</span></a>                        <span class="c1"># count buy operations:</span>
</span><span id="L-1790"><a href="#-1790"><span class="linenos">1790</span></a>                        <span class="k">if</span> <span class="s2">&quot;_BUY&quot;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;operationType&quot;</span><span class="p">]:</span>
</span><span id="L-1791"><a href="#-1791"><span class="linenos">1791</span></a>                            <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;buyCount&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-1792"><a href="#-1792"><span class="linenos">1792</span></a>
</span><span id="L-1793"><a href="#-1793"><span class="linenos">1793</span></a>                            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;buyTotal&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-1794"><a href="#-1794"><span class="linenos">1794</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;buyTotal&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">payment</span>
</span><span id="L-1795"><a href="#-1795"><span class="linenos">1795</span></a>
</span><span id="L-1796"><a href="#-1796"><span class="linenos">1796</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1797"><a href="#-1797"><span class="linenos">1797</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;buyTotal&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">payment</span>
</span><span id="L-1798"><a href="#-1798"><span class="linenos">1798</span></a>
</span><span id="L-1799"><a href="#-1799"><span class="linenos">1799</span></a>                        <span class="c1"># count sell operations:</span>
</span><span id="L-1800"><a href="#-1800"><span class="linenos">1800</span></a>                        <span class="k">elif</span> <span class="s2">&quot;_SELL&quot;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;operationType&quot;</span><span class="p">]:</span>
</span><span id="L-1801"><a href="#-1801"><span class="linenos">1801</span></a>                            <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;sellCount&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-1802"><a href="#-1802"><span class="linenos">1802</span></a>
</span><span id="L-1803"><a href="#-1803"><span class="linenos">1803</span></a>                            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;sellTotal&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-1804"><a href="#-1804"><span class="linenos">1804</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;sellTotal&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">payment</span>
</span><span id="L-1805"><a href="#-1805"><span class="linenos">1805</span></a>
</span><span id="L-1806"><a href="#-1806"><span class="linenos">1806</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1807"><a href="#-1807"><span class="linenos">1807</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;sellTotal&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">payment</span>
</span><span id="L-1808"><a href="#-1808"><span class="linenos">1808</span></a>
</span><span id="L-1809"><a href="#-1809"><span class="linenos">1809</span></a>                        <span class="c1"># count incoming operations:</span>
</span><span id="L-1810"><a href="#-1810"><span class="linenos">1810</span></a>                        <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;operationType&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;OPERATION_TYPE_INPUT&quot;</span><span class="p">]:</span>
</span><span id="L-1811"><a href="#-1811"><span class="linenos">1811</span></a>                            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;payIn&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-1812"><a href="#-1812"><span class="linenos">1812</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;payIn&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">payment</span>
</span><span id="L-1813"><a href="#-1813"><span class="linenos">1813</span></a>
</span><span id="L-1814"><a href="#-1814"><span class="linenos">1814</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1815"><a href="#-1815"><span class="linenos">1815</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;payIn&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">payment</span>
</span><span id="L-1816"><a href="#-1816"><span class="linenos">1816</span></a>
</span><span id="L-1817"><a href="#-1817"><span class="linenos">1817</span></a>                        <span class="c1"># count withdrawals operations:</span>
</span><span id="L-1818"><a href="#-1818"><span class="linenos">1818</span></a>                        <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;operationType&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;OPERATION_TYPE_OUTPUT&quot;</span><span class="p">]:</span>
</span><span id="L-1819"><a href="#-1819"><span class="linenos">1819</span></a>                            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;payOut&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-1820"><a href="#-1820"><span class="linenos">1820</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;payOut&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">payment</span>
</span><span id="L-1821"><a href="#-1821"><span class="linenos">1821</span></a>
</span><span id="L-1822"><a href="#-1822"><span class="linenos">1822</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1823"><a href="#-1823"><span class="linenos">1823</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;payOut&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">payment</span>
</span><span id="L-1824"><a href="#-1824"><span class="linenos">1824</span></a>
</span><span id="L-1825"><a href="#-1825"><span class="linenos">1825</span></a>                        <span class="c1"># count dividends income:</span>
</span><span id="L-1826"><a href="#-1826"><span class="linenos">1826</span></a>                        <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;operationType&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;OPERATION_TYPE_DIVIDEND&quot;</span><span class="p">,</span> <span class="s2">&quot;OPERATION_TYPE_DIVIDEND_TRANSFER&quot;</span><span class="p">,</span> <span class="s2">&quot;OPERATION_TYPE_DIV_EXT&quot;</span><span class="p">]:</span>
</span><span id="L-1827"><a href="#-1827"><span class="linenos">1827</span></a>                            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;divs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-1828"><a href="#-1828"><span class="linenos">1828</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;divs&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">payment</span>
</span><span id="L-1829"><a href="#-1829"><span class="linenos">1829</span></a>
</span><span id="L-1830"><a href="#-1830"><span class="linenos">1830</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1831"><a href="#-1831"><span class="linenos">1831</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;divs&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">payment</span>
</span><span id="L-1832"><a href="#-1832"><span class="linenos">1832</span></a>
</span><span id="L-1833"><a href="#-1833"><span class="linenos">1833</span></a>                        <span class="c1"># count coupon&#39;s income:</span>
</span><span id="L-1834"><a href="#-1834"><span class="linenos">1834</span></a>                        <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;operationType&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;OPERATION_TYPE_COUPON&quot;</span><span class="p">,</span> <span class="s2">&quot;OPERATION_TYPE_BOND_REPAYMENT_FULL&quot;</span><span class="p">,</span> <span class="s2">&quot;OPERATION_TYPE_BOND_REPAYMENT&quot;</span><span class="p">]:</span>
</span><span id="L-1835"><a href="#-1835"><span class="linenos">1835</span></a>                            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;coupons&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-1836"><a href="#-1836"><span class="linenos">1836</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;coupons&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">payment</span>
</span><span id="L-1837"><a href="#-1837"><span class="linenos">1837</span></a>
</span><span id="L-1838"><a href="#-1838"><span class="linenos">1838</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1839"><a href="#-1839"><span class="linenos">1839</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;coupons&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">payment</span>
</span><span id="L-1840"><a href="#-1840"><span class="linenos">1840</span></a>
</span><span id="L-1841"><a href="#-1841"><span class="linenos">1841</span></a>                        <span class="c1"># count broker commissions:</span>
</span><span id="L-1842"><a href="#-1842"><span class="linenos">1842</span></a>                        <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;operationType&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;OPERATION_TYPE_BROKER_FEE&quot;</span><span class="p">,</span> <span class="s2">&quot;OPERATION_TYPE_SUCCESS_FEE&quot;</span><span class="p">,</span> <span class="s2">&quot;OPERATION_TYPE_TRACK_MFEE&quot;</span><span class="p">,</span> <span class="s2">&quot;OPERATION_TYPE_TRACK_PFEE&quot;</span><span class="p">]:</span>
</span><span id="L-1843"><a href="#-1843"><span class="linenos">1843</span></a>                            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;brokerCom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-1844"><a href="#-1844"><span class="linenos">1844</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;brokerCom&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">payment</span>
</span><span id="L-1845"><a href="#-1845"><span class="linenos">1845</span></a>
</span><span id="L-1846"><a href="#-1846"><span class="linenos">1846</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1847"><a href="#-1847"><span class="linenos">1847</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;brokerCom&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">payment</span>
</span><span id="L-1848"><a href="#-1848"><span class="linenos">1848</span></a>
</span><span id="L-1849"><a href="#-1849"><span class="linenos">1849</span></a>                        <span class="c1"># count service commissions:</span>
</span><span id="L-1850"><a href="#-1850"><span class="linenos">1850</span></a>                        <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;operationType&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;OPERATION_TYPE_SERVICE_FEE&quot;</span><span class="p">]:</span>
</span><span id="L-1851"><a href="#-1851"><span class="linenos">1851</span></a>                            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;serviceCom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-1852"><a href="#-1852"><span class="linenos">1852</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;serviceCom&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">payment</span>
</span><span id="L-1853"><a href="#-1853"><span class="linenos">1853</span></a>
</span><span id="L-1854"><a href="#-1854"><span class="linenos">1854</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1855"><a href="#-1855"><span class="linenos">1855</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;serviceCom&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">payment</span>
</span><span id="L-1856"><a href="#-1856"><span class="linenos">1856</span></a>
</span><span id="L-1857"><a href="#-1857"><span class="linenos">1857</span></a>                        <span class="c1"># count margin commissions:</span>
</span><span id="L-1858"><a href="#-1858"><span class="linenos">1858</span></a>                        <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;operationType&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;OPERATION_TYPE_MARGIN_FEE&quot;</span><span class="p">]:</span>
</span><span id="L-1859"><a href="#-1859"><span class="linenos">1859</span></a>                            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;marginCom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-1860"><a href="#-1860"><span class="linenos">1860</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;marginCom&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">payment</span>
</span><span id="L-1861"><a href="#-1861"><span class="linenos">1861</span></a>
</span><span id="L-1862"><a href="#-1862"><span class="linenos">1862</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1863"><a href="#-1863"><span class="linenos">1863</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;marginCom&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">payment</span>
</span><span id="L-1864"><a href="#-1864"><span class="linenos">1864</span></a>
</span><span id="L-1865"><a href="#-1865"><span class="linenos">1865</span></a>                        <span class="c1"># count withholding taxes:</span>
</span><span id="L-1866"><a href="#-1866"><span class="linenos">1866</span></a>                        <span class="k">elif</span> <span class="s2">&quot;_TAX&quot;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;operationType&quot;</span><span class="p">]:</span>
</span><span id="L-1867"><a href="#-1867"><span class="linenos">1867</span></a>                            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;allTaxes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-1868"><a href="#-1868"><span class="linenos">1868</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;allTaxes&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">payment</span>
</span><span id="L-1869"><a href="#-1869"><span class="linenos">1869</span></a>
</span><span id="L-1870"><a href="#-1870"><span class="linenos">1870</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1871"><a href="#-1871"><span class="linenos">1871</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;allTaxes&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">payment</span>
</span><span id="L-1872"><a href="#-1872"><span class="linenos">1872</span></a>
</span><span id="L-1873"><a href="#-1873"><span class="linenos">1873</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1874"><a href="#-1874"><span class="linenos">1874</span></a>                            <span class="k">continue</span>
</span><span id="L-1875"><a href="#-1875"><span class="linenos">1875</span></a>
</span><span id="L-1876"><a href="#-1876"><span class="linenos">1876</span></a>                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;opsCount&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;buyCount&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;sellCount&quot;</span><span class="p">]</span>
</span><span id="L-1877"><a href="#-1877"><span class="linenos">1877</span></a>
</span><span id="L-1878"><a href="#-1878"><span class="linenos">1878</span></a>                <span class="c1"># --- view &quot;Actions&quot; lines:</span>
</span><span id="L-1879"><a href="#-1879"><span class="linenos">1879</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span><span id="L-1880"><a href="#-1880"><span class="linenos">1880</span></a>                    <span class="s2">&quot;| 1                          | 2                             | 3                            | 4                    | 5</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-1881"><a href="#-1881"><span class="linenos">1881</span></a>                    <span class="s2">&quot;|----------------------------|-------------------------------|------------------------------|----------------------|------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-1882"><a href="#-1882"><span class="linenos">1882</span></a>                    <span class="s2">&quot;| **Actions:**               | Operations executed: </span><span class="si">{:&lt;8}</span><span class="s2"> | Trading volumes:             |                      |</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;opsCount&quot;</span><span class="p">]),</span>
</span><span id="L-1883"><a href="#-1883"><span class="linenos">1883</span></a>                    <span class="s2">&quot;|                            |   Buy: </span><span class="si">{:&lt;22}</span><span class="s2"> | </span><span class="si">{:&lt;28}</span><span class="s2"> |                      |</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-1884"><a href="#-1884"><span class="linenos">1884</span></a>                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> (</span><span class="si">{:.1f}</span><span class="s2">%)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;buyCount&quot;</span><span class="p">],</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;buyCount&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;opsCount&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;opsCount&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="L-1885"><a href="#-1885"><span class="linenos">1885</span></a>                        <span class="s2">&quot;  rub, buy: </span><span class="si">{:&lt;16}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;buyTotal&quot;</span><span class="p">][</span><span class="s2">&quot;rub&quot;</span><span class="p">]))</span> <span class="k">if</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;buyTotal&quot;</span><span class="p">][</span><span class="s2">&quot;rub&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span>
</span><span id="L-1886"><a href="#-1886"><span class="linenos">1886</span></a>                    <span class="p">),</span>
</span><span id="L-1887"><a href="#-1887"><span class="linenos">1887</span></a>                    <span class="s2">&quot;|                            |   Sell: </span><span class="si">{:&lt;21}</span><span class="s2"> | </span><span class="si">{:&lt;28}</span><span class="s2"> |                      |</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-1888"><a href="#-1888"><span class="linenos">1888</span></a>                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> (</span><span class="si">{:.1f}</span><span class="s2">%)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;sellCount&quot;</span><span class="p">],</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;sellCount&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;opsCount&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;opsCount&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="L-1889"><a href="#-1889"><span class="linenos">1889</span></a>                        <span class="s2">&quot;  rub, sell: </span><span class="si">{:&lt;13}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;+</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;sellTotal&quot;</span><span class="p">][</span><span class="s2">&quot;rub&quot;</span><span class="p">]))</span> <span class="k">if</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;sellTotal&quot;</span><span class="p">][</span><span class="s2">&quot;rub&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span>
</span><span id="L-1890"><a href="#-1890"><span class="linenos">1890</span></a>                    <span class="p">),</span>
</span><span id="L-1891"><a href="#-1891"><span class="linenos">1891</span></a>                <span class="p">])</span>
</span><span id="L-1892"><a href="#-1892"><span class="linenos">1892</span></a>
</span><span id="L-1893"><a href="#-1893"><span class="linenos">1893</span></a>                <span class="n">opsKeys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;buyTotal&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;sellTotal&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))))</span>
</span><span id="L-1894"><a href="#-1894"><span class="linenos">1894</span></a>                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">opsKeys</span><span class="p">:</span>
</span><span id="L-1895"><a href="#-1895"><span class="linenos">1895</span></a>                    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;rub&quot;</span><span class="p">:</span>
</span><span id="L-1896"><a href="#-1896"><span class="linenos">1896</span></a>                        <span class="k">continue</span>
</span><span id="L-1897"><a href="#-1897"><span class="linenos">1897</span></a>
</span><span id="L-1898"><a href="#-1898"><span class="linenos">1898</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span><span id="L-1899"><a href="#-1899"><span class="linenos">1899</span></a>                        <span class="s2">&quot;|                            |                               | </span><span class="si">{:&lt;28}</span><span class="s2"> |                      |</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-1900"><a href="#-1900"><span class="linenos">1900</span></a>                            <span class="s2">&quot;  </span><span class="si">{}</span><span class="s2">, buy: </span><span class="si">{:&lt;16}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;buyTotal&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">])</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;buyTotal&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;buyTotal&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-1901"><a href="#-1901"><span class="linenos">1901</span></a>                        <span class="p">),</span>
</span><span id="L-1902"><a href="#-1902"><span class="linenos">1902</span></a>                        <span class="s2">&quot;|                            |                               | </span><span class="si">{:&lt;28}</span><span class="s2"> |                      |</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-1903"><a href="#-1903"><span class="linenos">1903</span></a>                            <span class="s2">&quot;  </span><span class="si">{}</span><span class="s2">, sell: </span><span class="si">{:&lt;13}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;+</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;sellTotal&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">])</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;sellTotal&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;sellTotal&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-1904"><a href="#-1904"><span class="linenos">1904</span></a>                        <span class="p">),</span>
</span><span id="L-1905"><a href="#-1905"><span class="linenos">1905</span></a>                    <span class="p">])</span>
</span><span id="L-1906"><a href="#-1906"><span class="linenos">1906</span></a>
</span><span id="L-1907"><a href="#-1907"><span class="linenos">1907</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">splitLine1</span><span class="p">)</span>
</span><span id="L-1908"><a href="#-1908"><span class="linenos">1908</span></a>
</span><span id="L-1909"><a href="#-1909"><span class="linenos">1909</span></a>                <span class="k">def</span> <span class="nf">_InfoStr</span><span class="p">(</span><span class="n">data1</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">data2</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">data3</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">data4</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">cur</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-1910"><a href="#-1910"><span class="linenos">1910</span></a>                    <span class="k">return</span> <span class="s2">&quot;|                            | </span><span class="si">{:&lt;29}</span><span class="s2"> | </span><span class="si">{:&lt;28}</span><span class="s2"> | </span><span class="si">{:&lt;20}</span><span class="s2"> | </span><span class="si">{:&lt;22}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-1911"><a href="#-1911"><span class="linenos">1911</span></a>                            <span class="s2">&quot;  </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="n">data1</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">data1</span><span class="p">[</span><span class="n">cur</span><span class="p">])</span> <span class="k">if</span> <span class="n">cur</span> <span class="ow">and</span> <span class="n">cur</span> <span class="ow">in</span> <span class="n">data1</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">data1</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span>
</span><span id="L-1912"><a href="#-1912"><span class="linenos">1912</span></a>                            <span class="s2">&quot;  </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="n">data2</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">data2</span><span class="p">[</span><span class="n">cur</span><span class="p">])</span> <span class="k">if</span> <span class="n">cur</span> <span class="ow">and</span> <span class="n">cur</span> <span class="ow">in</span> <span class="n">data2</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">data2</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span>
</span><span id="L-1913"><a href="#-1913"><span class="linenos">1913</span></a>                            <span class="s2">&quot;  </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="n">data3</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">data3</span><span class="p">[</span><span class="n">cur</span><span class="p">])</span> <span class="k">if</span> <span class="n">cur</span> <span class="ow">and</span> <span class="n">cur</span> <span class="ow">in</span> <span class="n">data3</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">data3</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span>
</span><span id="L-1914"><a href="#-1914"><span class="linenos">1914</span></a>                            <span class="s2">&quot;  </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="n">data4</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">data4</span><span class="p">[</span><span class="n">cur</span><span class="p">])</span> <span class="k">if</span> <span class="n">cur</span> <span class="ow">and</span> <span class="n">cur</span> <span class="ow">in</span> <span class="n">data4</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">data4</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span>
</span><span id="L-1915"><a href="#-1915"><span class="linenos">1915</span></a>                    <span class="p">)</span>
</span><span id="L-1916"><a href="#-1916"><span class="linenos">1916</span></a>
</span><span id="L-1917"><a href="#-1917"><span class="linenos">1917</span></a>                <span class="c1"># --- view &quot;Payments&quot; lines:</span>
</span><span id="L-1918"><a href="#-1918"><span class="linenos">1918</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| **Payments:**              | Deposit on broker account:    | Withdrawals:                 | Dividends income:    | Coupons income:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1919"><a href="#-1919"><span class="linenos">1919</span></a>                <span class="n">paymentsKeys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;payIn&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;payOut&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;divs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;coupons&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))))</span>
</span><span id="L-1920"><a href="#-1920"><span class="linenos">1920</span></a>
</span><span id="L-1921"><a href="#-1921"><span class="linenos">1921</span></a>                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">paymentsKeys</span><span class="p">:</span>
</span><span id="L-1922"><a href="#-1922"><span class="linenos">1922</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_InfoStr</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;payIn&quot;</span><span class="p">],</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;payOut&quot;</span><span class="p">],</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;divs&quot;</span><span class="p">],</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;coupons&quot;</span><span class="p">],</span> <span class="n">key</span><span class="p">))</span>
</span><span id="L-1923"><a href="#-1923"><span class="linenos">1923</span></a>
</span><span id="L-1924"><a href="#-1924"><span class="linenos">1924</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">splitLine1</span><span class="p">)</span>
</span><span id="L-1925"><a href="#-1925"><span class="linenos">1925</span></a>
</span><span id="L-1926"><a href="#-1926"><span class="linenos">1926</span></a>                <span class="c1"># --- view &quot;Commissions and taxes&quot; lines:</span>
</span><span id="L-1927"><a href="#-1927"><span class="linenos">1927</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| **Commissions and taxes:** | Broker commissions:           | Service commissions:         | Margin commissions:  | All taxes/corrections:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1928"><a href="#-1928"><span class="linenos">1928</span></a>                <span class="n">comKeys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;brokerCom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;serviceCom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;marginCom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;allTaxes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))))</span>
</span><span id="L-1929"><a href="#-1929"><span class="linenos">1929</span></a>
</span><span id="L-1930"><a href="#-1930"><span class="linenos">1930</span></a>                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">comKeys</span><span class="p">:</span>
</span><span id="L-1931"><a href="#-1931"><span class="linenos">1931</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_InfoStr</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;brokerCom&quot;</span><span class="p">],</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;serviceCom&quot;</span><span class="p">],</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;marginCom&quot;</span><span class="p">],</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;allTaxes&quot;</span><span class="p">],</span> <span class="n">key</span><span class="p">))</span>
</span><span id="L-1932"><a href="#-1932"><span class="linenos">1932</span></a>
</span><span id="L-1933"><a href="#-1933"><span class="linenos">1933</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">splitLine1</span><span class="p">)</span>
</span><span id="L-1934"><a href="#-1934"><span class="linenos">1934</span></a>
</span><span id="L-1935"><a href="#-1935"><span class="linenos">1935</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span><span id="L-1936"><a href="#-1936"><span class="linenos">1936</span></a>                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">## All operations</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-1937"><a href="#-1937"><span class="linenos">1937</span></a>                    <span class="s2">&quot;| Date and time       | FIGI         | Ticker       | Asset      | Value     | Payment         | Status     | Operation type</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-1938"><a href="#-1938"><span class="linenos">1938</span></a>                    <span class="s2">&quot;|---------------------|--------------|--------------|------------|-----------|-----------------|------------|--------------------------------------------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-1939"><a href="#-1939"><span class="linenos">1939</span></a>                <span class="p">])</span>
</span><span id="L-1940"><a href="#-1940"><span class="linenos">1940</span></a>
</span><span id="L-1941"><a href="#-1941"><span class="linenos">1941</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1942"><a href="#-1942"><span class="linenos">1942</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Broker returned no operations during this period</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1943"><a href="#-1943"><span class="linenos">1943</span></a>
</span><span id="L-1944"><a href="#-1944"><span class="linenos">1944</span></a>            <span class="c1"># --- view &quot;Operations&quot; section:</span>
</span><span id="L-1945"><a href="#-1945"><span class="linenos">1945</span></a>            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">:</span>
</span><span id="L-1946"><a href="#-1946"><span class="linenos">1946</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
</span><span id="L-1947"><a href="#-1947"><span class="linenos">1947</span></a>                <span class="n">payment</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>
</span><span id="L-1948"><a href="#-1948"><span class="linenos">1948</span></a>                <span class="n">instrument</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SearchByFIGI</span><span class="p">(</span><span class="n">requestPrice</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="k">else</span> <span class="p">{}</span>
</span><span id="L-1949"><a href="#-1949"><span class="linenos">1949</span></a>
</span><span id="L-1950"><a href="#-1950"><span class="linenos">1950</span></a>                <span class="c1"># group of deals during one day:</span>
</span><span id="L-1951"><a href="#-1951"><span class="linenos">1951</span></a>                <span class="k">if</span> <span class="n">nextDay</span> <span class="ow">and</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">nextDay</span><span class="p">:</span>
</span><span id="L-1952"><a href="#-1952"><span class="linenos">1952</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">splitLine2</span><span class="p">)</span>
</span><span id="L-1953"><a href="#-1953"><span class="linenos">1953</span></a>                    <span class="n">nextDay</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="L-1954"><a href="#-1954"><span class="linenos">1954</span></a>
</span><span id="L-1955"><a href="#-1955"><span class="linenos">1955</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1956"><a href="#-1956"><span class="linenos">1956</span></a>                    <span class="n">nextDay</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># saving current day for splitting</span>
</span><span id="L-1957"><a href="#-1957"><span class="linenos">1957</span></a>
</span><span id="L-1958"><a href="#-1958"><span class="linenos">1958</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| </span><span class="si">{:&lt;19}</span><span class="s2"> | </span><span class="si">{:&lt;12}</span><span class="s2"> | </span><span class="si">{:&lt;12}</span><span class="s2"> | </span><span class="si">{:&lt;10}</span><span class="s2"> | </span><span class="si">{:&lt;9}</span><span class="s2"> | </span><span class="si">{:&gt;15}</span><span class="s2"> | </span><span class="si">{:&lt;10}</span><span class="s2"> | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-1959"><a href="#-1959"><span class="linenos">1959</span></a>                    <span class="n">item</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="L-1960"><a href="#-1960"><span class="linenos">1960</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-1961"><a href="#-1961"><span class="linenos">1961</span></a>                    <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">instrument</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-1962"><a href="#-1962"><span class="linenos">1962</span></a>                    <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">instrument</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-1963"><a href="#-1963"><span class="linenos">1963</span></a>                    <span class="n">item</span><span class="p">[</span><span class="s2">&quot;quantity&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;quantity&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-1964"><a href="#-1964"><span class="linenos">1964</span></a>                    <span class="s2">&quot;</span><span class="si">{}{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="n">payment</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">payment</span><span class="p">,</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">payment</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-1965"><a href="#-1965"><span class="linenos">1965</span></a>                    <span class="n">TKS_OPERATION_STATES</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]],</span>
</span><span id="L-1966"><a href="#-1966"><span class="linenos">1966</span></a>                    <span class="n">TKS_OPERATION_TYPES</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;operationType&quot;</span><span class="p">]],</span>
</span><span id="L-1967"><a href="#-1967"><span class="linenos">1967</span></a>                <span class="p">))</span>
</span><span id="L-1968"><a href="#-1968"><span class="linenos">1968</span></a>
</span><span id="L-1969"><a href="#-1969"><span class="linenos">1969</span></a>            <span class="n">infoText</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
</span><span id="L-1970"><a href="#-1970"><span class="linenos">1970</span></a>
</span><span id="L-1971"><a href="#-1971"><span class="linenos">1971</span></a>            <span class="k">if</span> <span class="n">printDeals</span><span class="p">:</span>
</span><span id="L-1972"><a href="#-1972"><span class="linenos">1972</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">infoText</span><span class="p">)</span>
</span><span id="L-1973"><a href="#-1973"><span class="linenos">1973</span></a>
</span><span id="L-1974"><a href="#-1974"><span class="linenos">1974</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reportFile</span><span class="p">:</span>
</span><span id="L-1975"><a href="#-1975"><span class="linenos">1975</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reportFile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fH</span><span class="p">:</span>
</span><span id="L-1976"><a href="#-1976"><span class="linenos">1976</span></a>                    <span class="n">fH</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">infoText</span><span class="p">)</span>
</span><span id="L-1977"><a href="#-1977"><span class="linenos">1977</span></a>
</span><span id="L-1978"><a href="#-1978"><span class="linenos">1978</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;History of a client&#39;s operations are saved to file: [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reportFile</span><span class="p">)))</span>
</span><span id="L-1979"><a href="#-1979"><span class="linenos">1979</span></a>
</span><span id="L-1980"><a href="#-1980"><span class="linenos">1980</span></a>        <span class="k">return</span> <span class="n">ops</span><span class="p">,</span> <span class="n">customStat</span>
</span><span id="L-1981"><a href="#-1981"><span class="linenos">1981</span></a>
</span><span id="L-1982"><a href="#-1982"><span class="linenos">1982</span></a>    <span class="k">def</span> <span class="nf">History</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">onlyMissing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="L-1983"><a href="#-1983"><span class="linenos">1983</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1984"><a href="#-1984"><span class="linenos">1984</span></a><span class="sd">        This method returns last history candles of the current instrument defined by `ticker`.</span>
</span><span id="L-1985"><a href="#-1985"><span class="linenos">1985</span></a><span class="sd">        If `historyFile` is not None then method save history to this file, otherwise return only pandas dataframe.</span>
</span><span id="L-1986"><a href="#-1986"><span class="linenos">1986</span></a><span class="sd">        `historyLength` define how many candles returns from past to current date.</span>
</span><span id="L-1987"><a href="#-1987"><span class="linenos">1987</span></a><span class="sd">        `historyInterval` define candle interval. Available values are strings: `&quot;1min&quot;`, `&quot;2min&quot;`, `&quot;3min&quot;`, `&quot;5min&quot;`,</span>
</span><span id="L-1988"><a href="#-1988"><span class="linenos">1988</span></a><span class="sd">        `&quot;10min&quot;`, `&quot;15min&quot;`, `&quot;30min&quot;`, `&quot;hour&quot;`, `&quot;day&quot;`, `&quot;week&quot;`, `&quot;month&quot;`. Default: `&quot;hour&quot;`.</span>
</span><span id="L-1989"><a href="#-1989"><span class="linenos">1989</span></a><span class="sd">        Maximum requested history date in the past: `1970.01.02 03:45`</span>
</span><span id="L-1990"><a href="#-1990"><span class="linenos">1990</span></a>
</span><span id="L-1991"><a href="#-1991"><span class="linenos">1991</span></a><span class="sd">        :param onlyMissing: if history file define then add only last missing candles, do not request all history length. False by default.</span>
</span><span id="L-1992"><a href="#-1992"><span class="linenos">1992</span></a><span class="sd">                            WARNING! History appends only from last candle to current time with replace last candle! Intervals must be similar!</span>
</span><span id="L-1993"><a href="#-1993"><span class="linenos">1993</span></a><span class="sd">        :return: pandas dataframe with stock history. Columns: `date`, `time`, `open`, `high`, `low`, `close`, `volume`.</span>
</span><span id="L-1994"><a href="#-1994"><span class="linenos">1994</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1995"><a href="#-1995"><span class="linenos">1995</span></a>        <span class="n">history</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># empty pandas object for history</span>
</span><span id="L-1996"><a href="#-1996"><span class="linenos">1996</span></a>        <span class="c1"># TODO: update history to work with api v2</span>
</span><span id="L-1997"><a href="#-1997"><span class="linenos">1997</span></a>        <span class="c1"># if self.historyLength &lt; 1:</span>
</span><span id="L-1998"><a href="#-1998"><span class="linenos">1998</span></a>        <span class="c1">#     raise Exception(&quot;History length parameter must be &gt;=1!&quot;)</span>
</span><span id="L-1999"><a href="#-1999"><span class="linenos">1999</span></a>        <span class="c1">#</span>
</span><span id="L-2000"><a href="#-2000"><span class="linenos">2000</span></a>        <span class="c1"># if self.historyInterval not in TKS_TIMEFRAMES.keys():</span>
</span><span id="L-2001"><a href="#-2001"><span class="linenos">2001</span></a>        <span class="c1">#     raise Exception(&quot;Interval parameter must be string with available values: 1min, 2min, 3min, 5min, 10min, 15min, 30min, hour, day, week, month.&quot;)</span>
</span><span id="L-2002"><a href="#-2002"><span class="linenos">2002</span></a>        <span class="c1">#</span>
</span><span id="L-2003"><a href="#-2003"><span class="linenos">2003</span></a>        <span class="c1"># if not (self.ticker or self.figi):</span>
</span><span id="L-2004"><a href="#-2004"><span class="linenos">2004</span></a>        <span class="c1">#     raise Exception(&quot;self.ticker or self.figi variables must be defined!&quot;)</span>
</span><span id="L-2005"><a href="#-2005"><span class="linenos">2005</span></a>        <span class="c1">#</span>
</span><span id="L-2006"><a href="#-2006"><span class="linenos">2006</span></a>        <span class="c1"># if self.ticker and not self.figi:</span>
</span><span id="L-2007"><a href="#-2007"><span class="linenos">2007</span></a>        <span class="c1">#     instrumentByTicker = self.SearchByTicker(requestPrice=False, debug=False)</span>
</span><span id="L-2008"><a href="#-2008"><span class="linenos">2008</span></a>        <span class="c1">#     self.figi = instrumentByTicker[&quot;figi&quot;] if instrumentByTicker else &quot;&quot;</span>
</span><span id="L-2009"><a href="#-2009"><span class="linenos">2009</span></a>        <span class="c1">#</span>
</span><span id="L-2010"><a href="#-2010"><span class="linenos">2010</span></a>        <span class="c1"># endDate = datetime.now(tzutc())  # current time for request history</span>
</span><span id="L-2011"><a href="#-2011"><span class="linenos">2011</span></a>        <span class="c1"># tempOld = None  # pandas object for old history, if --only-missing key present</span>
</span><span id="L-2012"><a href="#-2012"><span class="linenos">2012</span></a>        <span class="c1"># lastTime = None  # datetime object of last old candle in file</span>
</span><span id="L-2013"><a href="#-2013"><span class="linenos">2013</span></a>        <span class="c1"># minStartDate = datetime.strptime(&quot;1970.01.02 03:45&quot;, &quot;%Y.%m.%d %H:%M&quot;).astimezone(tzutc())  # Maximum requested history date in the past</span>
</span><span id="L-2014"><a href="#-2014"><span class="linenos">2014</span></a>        <span class="c1">#</span>
</span><span id="L-2015"><a href="#-2015"><span class="linenos">2015</span></a>        <span class="c1"># # get old history saved earlier in file:</span>
</span><span id="L-2016"><a href="#-2016"><span class="linenos">2016</span></a>        <span class="c1"># if onlyMissing and self.historyFile and os.path.exists(self.historyFile):</span>
</span><span id="L-2017"><a href="#-2017"><span class="linenos">2017</span></a>        <span class="c1">#     uLogger.debug(&quot;--only-missing key present, so auto decreasing --length value...&quot;)</span>
</span><span id="L-2018"><a href="#-2018"><span class="linenos">2018</span></a>        <span class="c1">#     uLogger.debug(&quot;Only append missing last history candles at the end of the file [{}]&quot;.format(os.path.abspath(self.historyFile)))</span>
</span><span id="L-2019"><a href="#-2019"><span class="linenos">2019</span></a>        <span class="c1">#</span>
</span><span id="L-2020"><a href="#-2020"><span class="linenos">2020</span></a>        <span class="c1">#     tempOld = pd.read_csv(self.historyFile, sep=&quot;,&quot;, header=None, names=[&quot;date&quot;, &quot;time&quot;, &quot;open&quot;, &quot;high&quot;, &quot;low&quot;, &quot;close&quot;, &quot;volume&quot;])</span>
</span><span id="L-2021"><a href="#-2021"><span class="linenos">2021</span></a>        <span class="c1">#</span>
</span><span id="L-2022"><a href="#-2022"><span class="linenos">2022</span></a>        <span class="c1">#     tempOld[&quot;date&quot;] = pd.to_datetime(tempOld[&quot;date&quot;])  # load date &quot;as is&quot;</span>
</span><span id="L-2023"><a href="#-2023"><span class="linenos">2023</span></a>        <span class="c1">#     tempOld[&quot;date&quot;] = tempOld[&quot;date&quot;].dt.strftime(&quot;%Y.%m.%d&quot;)  # convert date to string</span>
</span><span id="L-2024"><a href="#-2024"><span class="linenos">2024</span></a>        <span class="c1">#     tempOld[&quot;time&quot;] = pd.to_datetime(tempOld[&quot;time&quot;])  # load time &quot;as is&quot;</span>
</span><span id="L-2025"><a href="#-2025"><span class="linenos">2025</span></a>        <span class="c1">#     tempOld[&quot;time&quot;] = tempOld[&quot;time&quot;].dt.strftime(&quot;%H:%M&quot;)  # convert time to string</span>
</span><span id="L-2026"><a href="#-2026"><span class="linenos">2026</span></a>        <span class="c1">#</span>
</span><span id="L-2027"><a href="#-2027"><span class="linenos">2027</span></a>        <span class="c1">#     # get last datetime object from last string in file or minus 1 delta if file is empty:</span>
</span><span id="L-2028"><a href="#-2028"><span class="linenos">2028</span></a>        <span class="c1">#     if len(tempOld) &gt; 0:</span>
</span><span id="L-2029"><a href="#-2029"><span class="linenos">2029</span></a>        <span class="c1">#         lastTime = datetime.strptime(tempOld.date.iloc[-1] + &quot; &quot; + tempOld.time.iloc[-1], &quot;%Y.%m.%d %H:%M&quot;).astimezone(tzutc())</span>
</span><span id="L-2030"><a href="#-2030"><span class="linenos">2030</span></a>        <span class="c1">#</span>
</span><span id="L-2031"><a href="#-2031"><span class="linenos">2031</span></a>        <span class="c1">#     else:</span>
</span><span id="L-2032"><a href="#-2032"><span class="linenos">2032</span></a>        <span class="c1">#         lastTime = endDate - timedelta(minutes=TKS_TIMEFRAMES[self.historyInterval][&quot;minutes&quot;])</span>
</span><span id="L-2033"><a href="#-2033"><span class="linenos">2033</span></a>        <span class="c1">#         uLogger.warning(&quot;No history in file, set last date to request at [{}]&quot;.format(lastTime))</span>
</span><span id="L-2034"><a href="#-2034"><span class="linenos">2034</span></a>        <span class="c1">#</span>
</span><span id="L-2035"><a href="#-2035"><span class="linenos">2035</span></a>        <span class="c1">#     delta = endDate - lastTime  # current time minus last time in file</span>
</span><span id="L-2036"><a href="#-2036"><span class="linenos">2036</span></a>        <span class="c1">#     deltaMinutes = delta.days * 1440 + delta.seconds // 60  # minutes between last datetime and current datetime</span>
</span><span id="L-2037"><a href="#-2037"><span class="linenos">2037</span></a>        <span class="c1">#</span>
</span><span id="L-2038"><a href="#-2038"><span class="linenos">2038</span></a>        <span class="c1">#     # calculate new (decreased) history length to download:</span>
</span><span id="L-2039"><a href="#-2039"><span class="linenos">2039</span></a>        <span class="c1">#     self.historyLength = deltaMinutes // TKS_TIMEFRAMES[self.historyInterval][&quot;minutes&quot;]</span>
</span><span id="L-2040"><a href="#-2040"><span class="linenos">2040</span></a>        <span class="c1">#     if deltaMinutes % TKS_TIMEFRAMES[self.historyInterval][&quot;minutes&quot;] &gt; 0:</span>
</span><span id="L-2041"><a href="#-2041"><span class="linenos">2041</span></a>        <span class="c1">#         self.historyLength += 1  # to avoid fraction time</span>
</span><span id="L-2042"><a href="#-2042"><span class="linenos">2042</span></a>        <span class="c1">#</span>
</span><span id="L-2043"><a href="#-2043"><span class="linenos">2043</span></a>        <span class="c1">#     tempOld = tempOld[:-1]  # always remove last old candle because it may be incompletely at the current time</span>
</span><span id="L-2044"><a href="#-2044"><span class="linenos">2044</span></a>        <span class="c1">#</span>
</span><span id="L-2045"><a href="#-2045"><span class="linenos">2045</span></a>        <span class="c1"># if self.figi:</span>
</span><span id="L-2046"><a href="#-2046"><span class="linenos">2046</span></a>        <span class="c1">#     blocks = 1 if self.historyLength &lt;= TKS_TIMEFRAMES[self.historyInterval][&quot;maxCandles&quot;] else 1 + self.historyLength // TKS_TIMEFRAMES[self.historyInterval][&quot;maxCandles&quot;]</span>
</span><span id="L-2047"><a href="#-2047"><span class="linenos">2047</span></a>        <span class="c1">#     responseJSONs = []  # raw history blocks</span>
</span><span id="L-2048"><a href="#-2048"><span class="linenos">2048</span></a>        <span class="c1">#</span>
</span><span id="L-2049"><a href="#-2049"><span class="linenos">2049</span></a>        <span class="c1">#     uLogger.debug(&quot;Request last history from Tinkoff Broker server for ticker [{}], FIGI [{}]...&quot;.format(self.ticker, self.figi))</span>
</span><span id="L-2050"><a href="#-2050"><span class="linenos">2050</span></a>        <span class="c1">#</span>
</span><span id="L-2051"><a href="#-2051"><span class="linenos">2051</span></a>        <span class="c1">#     uLogger.debug(&quot;Requested history length: [{}], interval: [{}]&quot;.format(self.historyLength, self.historyInterval))</span>
</span><span id="L-2052"><a href="#-2052"><span class="linenos">2052</span></a>        <span class="c1">#     uLogger.debug(&quot;User requested time period is about from [{}] to [{}]&quot;.format(</span>
</span><span id="L-2053"><a href="#-2053"><span class="linenos">2053</span></a>        <span class="c1">#         (endDate - timedelta(minutes=TKS_TIMEFRAMES[self.historyInterval][&quot;minutes&quot;] * self.historyLength)).strftime(&quot;%Y-%m-%d %H:%M:%S&quot;),</span>
</span><span id="L-2054"><a href="#-2054"><span class="linenos">2054</span></a>        <span class="c1">#         endDate.strftime(&quot;%Y-%m-%d %H:%M:%S&quot;),</span>
</span><span id="L-2055"><a href="#-2055"><span class="linenos">2055</span></a>        <span class="c1">#     ))</span>
</span><span id="L-2056"><a href="#-2056"><span class="linenos">2056</span></a>        <span class="c1">#</span>
</span><span id="L-2057"><a href="#-2057"><span class="linenos">2057</span></a>        <span class="c1">#     uLogger.debug(&quot;Blocks count: [{}], max candles in block for this interval: [{}]&quot;.format(blocks, TKS_TIMEFRAMES[self.historyInterval][&quot;maxCandles&quot;]))</span>
</span><span id="L-2058"><a href="#-2058"><span class="linenos">2058</span></a>        <span class="c1">#</span>
</span><span id="L-2059"><a href="#-2059"><span class="linenos">2059</span></a>        <span class="c1">#     oldFlag = False</span>
</span><span id="L-2060"><a href="#-2060"><span class="linenos">2060</span></a>        <span class="c1">#     for item in range(blocks):</span>
</span><span id="L-2061"><a href="#-2061"><span class="linenos">2061</span></a>        <span class="c1">#         tail = self.historyLength % TKS_TIMEFRAMES[self.historyInterval][&quot;maxCandles&quot;] if item + 1 == blocks else TKS_TIMEFRAMES[self.historyInterval][&quot;maxCandles&quot;]</span>
</span><span id="L-2062"><a href="#-2062"><span class="linenos">2062</span></a>        <span class="c1">#         startDate = endDate - timedelta(minutes=TKS_TIMEFRAMES[self.historyInterval][&quot;minutes&quot;] * tail)</span>
</span><span id="L-2063"><a href="#-2063"><span class="linenos">2063</span></a>        <span class="c1">#</span>
</span><span id="L-2064"><a href="#-2064"><span class="linenos">2064</span></a>        <span class="c1">#         if startDate &lt; minStartDate:</span>
</span><span id="L-2065"><a href="#-2065"><span class="linenos">2065</span></a>        <span class="c1">#             startDate = minStartDate  # set minimum date in the past if delta is too long</span>
</span><span id="L-2066"><a href="#-2066"><span class="linenos">2066</span></a>        <span class="c1">#             uLogger.debug(&quot;Date in the past is too old for request. Set start time to [{}]&quot;.format(minStartDate.strftime(&quot;%Y-%m-%d %H:%M:%S&quot;)))</span>
</span><span id="L-2067"><a href="#-2067"><span class="linenos">2067</span></a>        <span class="c1">#             oldFlag = True</span>
</span><span id="L-2068"><a href="#-2068"><span class="linenos">2068</span></a>        <span class="c1">#</span>
</span><span id="L-2069"><a href="#-2069"><span class="linenos">2069</span></a>        <span class="c1">#         uLogger.debug(&quot;Block time period: from [{}] to [{}] ({}/{})&quot;.format(</span>
</span><span id="L-2070"><a href="#-2070"><span class="linenos">2070</span></a>        <span class="c1">#             startDate.strftime(&quot;%Y-%m-%d %H:%M:%S&quot;),</span>
</span><span id="L-2071"><a href="#-2071"><span class="linenos">2071</span></a>        <span class="c1">#             endDate.strftime(&quot;%Y-%m-%d %H:%M:%S&quot;),</span>
</span><span id="L-2072"><a href="#-2072"><span class="linenos">2072</span></a>        <span class="c1">#             item + 1,</span>
</span><span id="L-2073"><a href="#-2073"><span class="linenos">2073</span></a>        <span class="c1">#             blocks,</span>
</span><span id="L-2074"><a href="#-2074"><span class="linenos">2074</span></a>        <span class="c1">#         ))</span>
</span><span id="L-2075"><a href="#-2075"><span class="linenos">2075</span></a>        <span class="c1">#</span>
</span><span id="L-2076"><a href="#-2076"><span class="linenos">2076</span></a>        <span class="c1">#         historyURL = self.server + r&quot;/market/candles?figi={}&amp;from={}&amp;to={}&amp;interval={}&quot;.format(</span>
</span><span id="L-2077"><a href="#-2077"><span class="linenos">2077</span></a>        <span class="c1">#             self.figi,</span>
</span><span id="L-2078"><a href="#-2078"><span class="linenos">2078</span></a>        <span class="c1">#             quote(startDate.isoformat()),</span>
</span><span id="L-2079"><a href="#-2079"><span class="linenos">2079</span></a>        <span class="c1">#             quote(endDate.isoformat()),</span>
</span><span id="L-2080"><a href="#-2080"><span class="linenos">2080</span></a>        <span class="c1">#             self.historyInterval,</span>
</span><span id="L-2081"><a href="#-2081"><span class="linenos">2081</span></a>        <span class="c1">#         )</span>
</span><span id="L-2082"><a href="#-2082"><span class="linenos">2082</span></a>        <span class="c1">#         responseJSON = self.SendAPIRequest(historyURL, debug=False)[&quot;payload&quot;][&quot;candles&quot;]</span>
</span><span id="L-2083"><a href="#-2083"><span class="linenos">2083</span></a>        <span class="c1">#</span>
</span><span id="L-2084"><a href="#-2084"><span class="linenos">2084</span></a>        <span class="c1">#         responseJSONs = responseJSON + responseJSONs  # add more old history behind newest dates</span>
</span><span id="L-2085"><a href="#-2085"><span class="linenos">2085</span></a>        <span class="c1">#         endDate = startDate</span>
</span><span id="L-2086"><a href="#-2086"><span class="linenos">2086</span></a>        <span class="c1">#</span>
</span><span id="L-2087"><a href="#-2087"><span class="linenos">2087</span></a>        <span class="c1">#         if oldFlag: break</span>
</span><span id="L-2088"><a href="#-2088"><span class="linenos">2088</span></a>        <span class="c1">#</span>
</span><span id="L-2089"><a href="#-2089"><span class="linenos">2089</span></a>        <span class="c1">#     if responseJSONs:</span>
</span><span id="L-2090"><a href="#-2090"><span class="linenos">2090</span></a>        <span class="c1">#         tempHistory = pd.DataFrame(</span>
</span><span id="L-2091"><a href="#-2091"><span class="linenos">2091</span></a>        <span class="c1">#             data={</span>
</span><span id="L-2092"><a href="#-2092"><span class="linenos">2092</span></a>        <span class="c1">#                 &quot;date&quot;: [pd.to_datetime(item[&quot;time&quot;]).astimezone(tzutc()) for item in responseJSONs],</span>
</span><span id="L-2093"><a href="#-2093"><span class="linenos">2093</span></a>        <span class="c1">#                 &quot;time&quot;: [pd.to_datetime(item[&quot;time&quot;]).astimezone(tzutc()) for item in responseJSONs],</span>
</span><span id="L-2094"><a href="#-2094"><span class="linenos">2094</span></a>        <span class="c1">#                 &quot;open&quot;: [item[&quot;o&quot;] for item in responseJSONs],</span>
</span><span id="L-2095"><a href="#-2095"><span class="linenos">2095</span></a>        <span class="c1">#                 &quot;high&quot;: [item[&quot;h&quot;] for item in responseJSONs],</span>
</span><span id="L-2096"><a href="#-2096"><span class="linenos">2096</span></a>        <span class="c1">#                 &quot;low&quot;: [item[&quot;l&quot;] for item in responseJSONs],</span>
</span><span id="L-2097"><a href="#-2097"><span class="linenos">2097</span></a>        <span class="c1">#                 &quot;close&quot;: [item[&quot;c&quot;] for item in responseJSONs],</span>
</span><span id="L-2098"><a href="#-2098"><span class="linenos">2098</span></a>        <span class="c1">#                 &quot;volume&quot;: [item[&quot;v&quot;] for item in responseJSONs],</span>
</span><span id="L-2099"><a href="#-2099"><span class="linenos">2099</span></a>        <span class="c1">#             },</span>
</span><span id="L-2100"><a href="#-2100"><span class="linenos">2100</span></a>        <span class="c1">#             index=range(len(responseJSONs)),</span>
</span><span id="L-2101"><a href="#-2101"><span class="linenos">2101</span></a>        <span class="c1">#             columns=[&quot;date&quot;, &quot;time&quot;, &quot;open&quot;, &quot;high&quot;, &quot;low&quot;, &quot;close&quot;, &quot;volume&quot;],</span>
</span><span id="L-2102"><a href="#-2102"><span class="linenos">2102</span></a>        <span class="c1">#         )</span>
</span><span id="L-2103"><a href="#-2103"><span class="linenos">2103</span></a>        <span class="c1">#         tempHistory[&quot;date&quot;] = tempHistory[&quot;date&quot;].dt.strftime(&quot;%Y.%m.%d&quot;)</span>
</span><span id="L-2104"><a href="#-2104"><span class="linenos">2104</span></a>        <span class="c1">#         tempHistory[&quot;time&quot;] = tempHistory[&quot;time&quot;].dt.strftime(&quot;%H:%M&quot;)</span>
</span><span id="L-2105"><a href="#-2105"><span class="linenos">2105</span></a>        <span class="c1">#</span>
</span><span id="L-2106"><a href="#-2106"><span class="linenos">2106</span></a>        <span class="c1">#         # append only newest candles to old history if --only-missing key present:</span>
</span><span id="L-2107"><a href="#-2107"><span class="linenos">2107</span></a>        <span class="c1">#         if onlyMissing and tempOld is not None and lastTime is not None:</span>
</span><span id="L-2108"><a href="#-2108"><span class="linenos">2108</span></a>        <span class="c1">#             indx = 0  # find start index in given from server tempHistory data:</span>
</span><span id="L-2109"><a href="#-2109"><span class="linenos">2109</span></a>        <span class="c1">#             for i, item in tempHistory.iterrows():</span>
</span><span id="L-2110"><a href="#-2110"><span class="linenos">2110</span></a>        <span class="c1">#                 curTime = datetime.strptime(item[&quot;date&quot;] + &quot; &quot; + item[&quot;time&quot;], &quot;%Y.%m.%d %H:%M&quot;).astimezone(tzutc())</span>
</span><span id="L-2111"><a href="#-2111"><span class="linenos">2111</span></a>        <span class="c1">#                 if curTime == lastTime:</span>
</span><span id="L-2112"><a href="#-2112"><span class="linenos">2112</span></a>        <span class="c1">#                     uLogger.debug(&quot;History candles will be updated starting from the candle with date: [{}]&quot;.format(curTime.strftime(&quot;%Y-%m-%d %H:%M:%S&quot;)))</span>
</span><span id="L-2113"><a href="#-2113"><span class="linenos">2113</span></a>        <span class="c1">#                     indx = i</span>
</span><span id="L-2114"><a href="#-2114"><span class="linenos">2114</span></a>        <span class="c1">#                     break</span>
</span><span id="L-2115"><a href="#-2115"><span class="linenos">2115</span></a>        <span class="c1">#</span>
</span><span id="L-2116"><a href="#-2116"><span class="linenos">2116</span></a>        <span class="c1">#             history = tempOld.append(tempHistory[indx:], ignore_index=True)</span>
</span><span id="L-2117"><a href="#-2117"><span class="linenos">2117</span></a>        <span class="c1">#</span>
</span><span id="L-2118"><a href="#-2118"><span class="linenos">2118</span></a>        <span class="c1">#         else:</span>
</span><span id="L-2119"><a href="#-2119"><span class="linenos">2119</span></a>        <span class="c1">#             history = tempHistory  # if no --only-missing key then load full data from server</span>
</span><span id="L-2120"><a href="#-2120"><span class="linenos">2120</span></a>        <span class="c1">#</span>
</span><span id="L-2121"><a href="#-2121"><span class="linenos">2121</span></a>        <span class="c1">#         uLogger.debug(&quot;Showing last 3 rows of candles history:&quot;)</span>
</span><span id="L-2122"><a href="#-2122"><span class="linenos">2122</span></a>        <span class="c1">#         for line in pd.DataFrame.to_string(</span>
</span><span id="L-2123"><a href="#-2123"><span class="linenos">2123</span></a>        <span class="c1">#                 history[[&quot;date&quot;, &quot;time&quot;, &quot;open&quot;, &quot;high&quot;, &quot;low&quot;, &quot;close&quot;, &quot;volume&quot;]][-3:],</span>
</span><span id="L-2124"><a href="#-2124"><span class="linenos">2124</span></a>        <span class="c1">#                 max_cols=20,</span>
</span><span id="L-2125"><a href="#-2125"><span class="linenos">2125</span></a>        <span class="c1">#         ).split(&quot;\n&quot;):</span>
</span><span id="L-2126"><a href="#-2126"><span class="linenos">2126</span></a>        <span class="c1">#             uLogger.debug(line)</span>
</span><span id="L-2127"><a href="#-2127"><span class="linenos">2127</span></a>        <span class="c1">#</span>
</span><span id="L-2128"><a href="#-2128"><span class="linenos">2128</span></a>        <span class="c1">#     if self.historyFile is not None:</span>
</span><span id="L-2129"><a href="#-2129"><span class="linenos">2129</span></a>        <span class="c1">#         if history is not None:</span>
</span><span id="L-2130"><a href="#-2130"><span class="linenos">2130</span></a>        <span class="c1">#             history.to_csv(self.historyFile, sep=&quot;,&quot;, index=False, header=False)</span>
</span><span id="L-2131"><a href="#-2131"><span class="linenos">2131</span></a>        <span class="c1">#             uLogger.info(&quot;Ticker [{}], FIGI [{}], tf: [{}], history saved: [{}]&quot;.format(</span>
</span><span id="L-2132"><a href="#-2132"><span class="linenos">2132</span></a>        <span class="c1">#                 self.ticker,</span>
</span><span id="L-2133"><a href="#-2133"><span class="linenos">2133</span></a>        <span class="c1">#                 self.figi,</span>
</span><span id="L-2134"><a href="#-2134"><span class="linenos">2134</span></a>        <span class="c1">#                 self.historyInterval,</span>
</span><span id="L-2135"><a href="#-2135"><span class="linenos">2135</span></a>        <span class="c1">#                 os.path.abspath(self.historyFile),</span>
</span><span id="L-2136"><a href="#-2136"><span class="linenos">2136</span></a>        <span class="c1">#             ))</span>
</span><span id="L-2137"><a href="#-2137"><span class="linenos">2137</span></a>        <span class="c1">#</span>
</span><span id="L-2138"><a href="#-2138"><span class="linenos">2138</span></a>        <span class="c1">#         else:</span>
</span><span id="L-2139"><a href="#-2139"><span class="linenos">2139</span></a>        <span class="c1">#             uLogger.warning(&quot;Empty history received! File NOT updated: [{}]&quot;.format(os.path.abspath(self.historyFile)))</span>
</span><span id="L-2140"><a href="#-2140"><span class="linenos">2140</span></a>        <span class="c1">#</span>
</span><span id="L-2141"><a href="#-2141"><span class="linenos">2141</span></a>        <span class="c1">#     else:</span>
</span><span id="L-2142"><a href="#-2142"><span class="linenos">2142</span></a>        <span class="c1">#         uLogger.debug(&quot;--output key is not defined. Parsed history file not saved to .csv-file, only pandas dataframe returns.&quot;)</span>
</span><span id="L-2143"><a href="#-2143"><span class="linenos">2143</span></a>
</span><span id="L-2144"><a href="#-2144"><span class="linenos">2144</span></a>        <span class="k">return</span> <span class="n">history</span>
</span><span id="L-2145"><a href="#-2145"><span class="linenos">2145</span></a>
</span><span id="L-2146"><a href="#-2146"><span class="linenos">2146</span></a>    <span class="k">def</span> <span class="nf">Trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">lots</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">sl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">expDate</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Undefined&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="L-2147"><a href="#-2147"><span class="linenos">2147</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2148"><a href="#-2148"><span class="linenos">2148</span></a><span class="sd">        Universal method to create market order and make deal at the current price. Returns JSON data with response.</span>
</span><span id="L-2149"><a href="#-2149"><span class="linenos">2149</span></a><span class="sd">        If `tp` or `sl` &gt; 0, then in additional will opens stop-orders with &quot;TP&quot; and &quot;SL&quot; flags for `stopType` parameter.</span>
</span><span id="L-2150"><a href="#-2150"><span class="linenos">2150</span></a>
</span><span id="L-2151"><a href="#-2151"><span class="linenos">2151</span></a><span class="sd">        See also: `Order()` docstring. More simple methods than `Trade()` are `Buy()` and `Sell()`.</span>
</span><span id="L-2152"><a href="#-2152"><span class="linenos">2152</span></a>
</span><span id="L-2153"><a href="#-2153"><span class="linenos">2153</span></a><span class="sd">        :param operation: string &quot;Buy&quot; or &quot;Sell&quot;.</span>
</span><span id="L-2154"><a href="#-2154"><span class="linenos">2154</span></a><span class="sd">        :param lots: volume, integer count of lots &gt;= 1.</span>
</span><span id="L-2155"><a href="#-2155"><span class="linenos">2155</span></a><span class="sd">        :param tp: float &gt; 0, target price for stop-order with &quot;TP&quot; type. It used as take profit parameter `targetPrice` in `self.Order()`.</span>
</span><span id="L-2156"><a href="#-2156"><span class="linenos">2156</span></a><span class="sd">        :param sl: float &gt; 0, target price for stop-order with &quot;SL&quot; type. It used as stop loss parameter `targetPrice` in `self.Order()`.</span>
</span><span id="L-2157"><a href="#-2157"><span class="linenos">2157</span></a><span class="sd">        :param expDate: string &quot;Undefined&quot; by default or local date in future,</span>
</span><span id="L-2158"><a href="#-2158"><span class="linenos">2158</span></a><span class="sd">                        it is a string with format `%Y-%m-%d %H:%M:%S`.</span>
</span><span id="L-2159"><a href="#-2159"><span class="linenos">2159</span></a><span class="sd">        :return: JSON with response from broker server.</span>
</span><span id="L-2160"><a href="#-2160"><span class="linenos">2160</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2161"><a href="#-2161"><span class="linenos">2161</span></a>        <span class="k">if</span> <span class="n">operation</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">operation</span> <span class="ow">or</span> <span class="n">operation</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Buy&quot;</span><span class="p">,</span> <span class="s2">&quot;Sell&quot;</span><span class="p">):</span>
</span><span id="L-2162"><a href="#-2162"><span class="linenos">2162</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;You must define operation type only one of them: `Buy` or `Sell`!&quot;</span><span class="p">)</span>
</span><span id="L-2163"><a href="#-2163"><span class="linenos">2163</span></a>
</span><span id="L-2164"><a href="#-2164"><span class="linenos">2164</span></a>        <span class="k">if</span> <span class="n">lots</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">lots</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-2165"><a href="#-2165"><span class="linenos">2165</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;You must define trade volume &gt; 0: integer count of lots! For current operation lots reset to 1.&quot;</span><span class="p">)</span>
</span><span id="L-2166"><a href="#-2166"><span class="linenos">2166</span></a>            <span class="n">lots</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-2167"><a href="#-2167"><span class="linenos">2167</span></a>
</span><span id="L-2168"><a href="#-2168"><span class="linenos">2168</span></a>        <span class="k">if</span> <span class="n">tp</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">tp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-2169"><a href="#-2169"><span class="linenos">2169</span></a>            <span class="n">tp</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-2170"><a href="#-2170"><span class="linenos">2170</span></a>
</span><span id="L-2171"><a href="#-2171"><span class="linenos">2171</span></a>        <span class="k">if</span> <span class="n">sl</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">sl</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-2172"><a href="#-2172"><span class="linenos">2172</span></a>            <span class="n">sl</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-2173"><a href="#-2173"><span class="linenos">2173</span></a>
</span><span id="L-2174"><a href="#-2174"><span class="linenos">2174</span></a>        <span class="k">if</span> <span class="n">expDate</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">expDate</span><span class="p">:</span>
</span><span id="L-2175"><a href="#-2175"><span class="linenos">2175</span></a>            <span class="n">expDate</span> <span class="o">=</span> <span class="s2">&quot;Undefined&quot;</span>
</span><span id="L-2176"><a href="#-2176"><span class="linenos">2176</span></a>
</span><span id="L-2177"><a href="#-2177"><span class="linenos">2177</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">):</span>
</span><span id="L-2178"><a href="#-2178"><span class="linenos">2178</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;`self.ticker` or `self.figi` variables must be defined!&quot;</span><span class="p">)</span>
</span><span id="L-2179"><a href="#-2179"><span class="linenos">2179</span></a>
</span><span id="L-2180"><a href="#-2180"><span class="linenos">2180</span></a>        <span class="n">instrument</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SearchByTicker</span><span class="p">(</span><span class="n">requestPrice</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">SearchByFIGI</span><span class="p">(</span><span class="n">requestPrice</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-2181"><a href="#-2181"><span class="linenos">2181</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">]</span>
</span><span id="L-2182"><a href="#-2182"><span class="linenos">2182</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">=</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]</span>
</span><span id="L-2183"><a href="#-2183"><span class="linenos">2183</span></a>
</span><span id="L-2184"><a href="#-2184"><span class="linenos">2184</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Opening [</span><span class="si">{}</span><span class="s2">] market order: ticker [</span><span class="si">{}</span><span class="s2">], FIGI [</span><span class="si">{}</span><span class="s2">], lots [</span><span class="si">{}</span><span class="s2">], TP [</span><span class="si">{:.4f}</span><span class="s2">], SL [</span><span class="si">{:.4f}</span><span class="s2">], expiration date of TP/SL orders [</span><span class="si">{}</span><span class="s2">]. Wait, please...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">,</span> <span class="n">lots</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">sl</span><span class="p">,</span> <span class="n">expDate</span><span class="p">))</span>
</span><span id="L-2185"><a href="#-2185"><span class="linenos">2185</span></a>
</span><span id="L-2186"><a href="#-2186"><span class="linenos">2186</span></a>        <span class="n">openTradeURL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;/tinkoff.public.invest.api.contract.v1.OrdersService/PostOrder&quot;</span>
</span><span id="L-2187"><a href="#-2187"><span class="linenos">2187</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="nb">str</span><span class="p">({</span>
</span><span id="L-2188"><a href="#-2188"><span class="linenos">2188</span></a>            <span class="s2">&quot;figi&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">,</span>
</span><span id="L-2189"><a href="#-2189"><span class="linenos">2189</span></a>            <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">lots</span><span class="p">),</span>
</span><span id="L-2190"><a href="#-2190"><span class="linenos">2190</span></a>            <span class="s2">&quot;direction&quot;</span><span class="p">:</span> <span class="s2">&quot;ORDER_DIRECTION_BUY&quot;</span> <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;Buy&quot;</span> <span class="k">else</span> <span class="s2">&quot;ORDER_DIRECTION_SELL&quot;</span><span class="p">,</span>  <span class="c1"># see: TKS_ORDER_DIRECTIONS</span>
</span><span id="L-2191"><a href="#-2191"><span class="linenos">2191</span></a>            <span class="s2">&quot;accountId&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">accountId</span><span class="p">),</span>
</span><span id="L-2192"><a href="#-2192"><span class="linenos">2192</span></a>            <span class="s2">&quot;orderType&quot;</span><span class="p">:</span> <span class="s2">&quot;ORDER_TYPE_MARKET&quot;</span><span class="p">,</span>  <span class="c1"># see: TKS_ORDER_TYPES</span>
</span><span id="L-2193"><a href="#-2193"><span class="linenos">2193</span></a>        <span class="p">})</span>
</span><span id="L-2194"><a href="#-2194"><span class="linenos">2194</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SendAPIRequest</span><span class="p">(</span><span class="n">openTradeURL</span><span class="p">,</span> <span class="n">reqType</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="n">retry</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-2195"><a href="#-2195"><span class="linenos">2195</span></a>
</span><span id="L-2196"><a href="#-2196"><span class="linenos">2196</span></a>        <span class="k">if</span> <span class="s2">&quot;orderId&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-2197"><a href="#-2197"><span class="linenos">2197</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">] market order [</span><span class="si">{}</span><span class="s2">] was executed: ticker [</span><span class="si">{}</span><span class="s2">], FIGI [</span><span class="si">{}</span><span class="s2">], lots [</span><span class="si">{}</span><span class="s2">]. Total order price: [</span><span class="si">{:.4f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">] (with commission: [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">]). Average price of lot: [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-2198"><a href="#-2198"><span class="linenos">2198</span></a>                <span class="n">operation</span><span class="p">,</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;orderId&quot;</span><span class="p">],</span>
</span><span id="L-2199"><a href="#-2199"><span class="linenos">2199</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">,</span> <span class="n">lots</span><span class="p">,</span>
</span><span id="L-2200"><a href="#-2200"><span class="linenos">2200</span></a>                <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;totalOrderAmount&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;totalOrderAmount&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">]),</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;totalOrderAmount&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="L-2201"><a href="#-2201"><span class="linenos">2201</span></a>                <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;initialCommission&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;initialCommission&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">]),</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;initialCommission&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="L-2202"><a href="#-2202"><span class="linenos">2202</span></a>                <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;executedOrderPrice&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;executedOrderPrice&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">]),</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;executedOrderPrice&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="L-2203"><a href="#-2203"><span class="linenos">2203</span></a>            <span class="p">))</span>
</span><span id="L-2204"><a href="#-2204"><span class="linenos">2204</span></a>
</span><span id="L-2205"><a href="#-2205"><span class="linenos">2205</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2206"><a href="#-2206"><span class="linenos">2206</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Not `oK` status received! Market order not created. See full debug log or try again and open order later.&quot;</span><span class="p">)</span>
</span><span id="L-2207"><a href="#-2207"><span class="linenos">2207</span></a>
</span><span id="L-2208"><a href="#-2208"><span class="linenos">2208</span></a>        <span class="k">if</span> <span class="n">tp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-2209"><a href="#-2209"><span class="linenos">2209</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Order</span><span class="p">(</span><span class="n">operation</span><span class="o">=</span><span class="s2">&quot;Sell&quot;</span> <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;Buy&quot;</span> <span class="k">else</span> <span class="s2">&quot;Buy&quot;</span><span class="p">,</span> <span class="n">orderType</span><span class="o">=</span><span class="s2">&quot;Stop&quot;</span><span class="p">,</span> <span class="n">lots</span><span class="o">=</span><span class="n">lots</span><span class="p">,</span> <span class="n">targetPrice</span><span class="o">=</span><span class="n">tp</span><span class="p">,</span> <span class="n">limitPrice</span><span class="o">=</span><span class="n">tp</span><span class="p">,</span> <span class="n">stopType</span><span class="o">=</span><span class="s2">&quot;TP&quot;</span><span class="p">,</span> <span class="n">expDate</span><span class="o">=</span><span class="n">expDate</span><span class="p">)</span>
</span><span id="L-2210"><a href="#-2210"><span class="linenos">2210</span></a>
</span><span id="L-2211"><a href="#-2211"><span class="linenos">2211</span></a>        <span class="k">if</span> <span class="n">sl</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-2212"><a href="#-2212"><span class="linenos">2212</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Order</span><span class="p">(</span><span class="n">operation</span><span class="o">=</span><span class="s2">&quot;Sell&quot;</span> <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;Buy&quot;</span> <span class="k">else</span> <span class="s2">&quot;Buy&quot;</span><span class="p">,</span> <span class="n">orderType</span><span class="o">=</span><span class="s2">&quot;Stop&quot;</span><span class="p">,</span> <span class="n">lots</span><span class="o">=</span><span class="n">lots</span><span class="p">,</span> <span class="n">targetPrice</span><span class="o">=</span><span class="n">sl</span><span class="p">,</span> <span class="n">limitPrice</span><span class="o">=</span><span class="n">sl</span><span class="p">,</span> <span class="n">stopType</span><span class="o">=</span><span class="s2">&quot;SL&quot;</span><span class="p">,</span> <span class="n">expDate</span><span class="o">=</span><span class="n">expDate</span><span class="p">)</span>
</span><span id="L-2213"><a href="#-2213"><span class="linenos">2213</span></a>
</span><span id="L-2214"><a href="#-2214"><span class="linenos">2214</span></a>        <span class="k">return</span> <span class="n">response</span>
</span><span id="L-2215"><a href="#-2215"><span class="linenos">2215</span></a>
</span><span id="L-2216"><a href="#-2216"><span class="linenos">2216</span></a>    <span class="k">def</span> <span class="nf">Buy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lots</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">sl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">expDate</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Undefined&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="L-2217"><a href="#-2217"><span class="linenos">2217</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2218"><a href="#-2218"><span class="linenos">2218</span></a><span class="sd">        More simple method than `Trade()`. Create `Buy` market order and make deal at the current price. Returns JSON data with response.</span>
</span><span id="L-2219"><a href="#-2219"><span class="linenos">2219</span></a><span class="sd">        If `tp` or `sl` &gt; 0, then in additional will opens stop-orders with &quot;TP&quot; and &quot;SL&quot; flags for `stopType` parameter.</span>
</span><span id="L-2220"><a href="#-2220"><span class="linenos">2220</span></a>
</span><span id="L-2221"><a href="#-2221"><span class="linenos">2221</span></a><span class="sd">        See also: `Order()` and `Trade()` docstrings.</span>
</span><span id="L-2222"><a href="#-2222"><span class="linenos">2222</span></a>
</span><span id="L-2223"><a href="#-2223"><span class="linenos">2223</span></a><span class="sd">        :param lots: volume, integer count of lots &gt;= 1.</span>
</span><span id="L-2224"><a href="#-2224"><span class="linenos">2224</span></a><span class="sd">        :param tp: float &gt; 0, take profit price of stop-order.</span>
</span><span id="L-2225"><a href="#-2225"><span class="linenos">2225</span></a><span class="sd">        :param sl: float &gt; 0, stop loss price of stop-order.</span>
</span><span id="L-2226"><a href="#-2226"><span class="linenos">2226</span></a><span class="sd">        :param expDate: it&#39;s a local date in future.</span>
</span><span id="L-2227"><a href="#-2227"><span class="linenos">2227</span></a><span class="sd">                        String has a format like this: `%Y-%m-%d %H:%M:%S`.</span>
</span><span id="L-2228"><a href="#-2228"><span class="linenos">2228</span></a><span class="sd">        :return: JSON with response from broker server.</span>
</span><span id="L-2229"><a href="#-2229"><span class="linenos">2229</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2230"><a href="#-2230"><span class="linenos">2230</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Trade</span><span class="p">(</span><span class="n">operation</span><span class="o">=</span><span class="s2">&quot;Buy&quot;</span><span class="p">,</span> <span class="n">lots</span><span class="o">=</span><span class="n">lots</span><span class="p">,</span> <span class="n">tp</span><span class="o">=</span><span class="n">tp</span><span class="p">,</span> <span class="n">sl</span><span class="o">=</span><span class="n">sl</span><span class="p">,</span> <span class="n">expDate</span><span class="o">=</span><span class="n">expDate</span><span class="p">)</span>
</span><span id="L-2231"><a href="#-2231"><span class="linenos">2231</span></a>
</span><span id="L-2232"><a href="#-2232"><span class="linenos">2232</span></a>    <span class="k">def</span> <span class="nf">Sell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lots</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">sl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">expDate</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Undefined&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="L-2233"><a href="#-2233"><span class="linenos">2233</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2234"><a href="#-2234"><span class="linenos">2234</span></a><span class="sd">        More simple method than `Trade()`. Create `Sell` market order and make deal at the current price. Returns JSON data with response.</span>
</span><span id="L-2235"><a href="#-2235"><span class="linenos">2235</span></a><span class="sd">        If `tp` or `sl` &gt; 0, then in additional will opens stop-orders with &quot;TP&quot; and &quot;SL&quot; flags for `stopType` parameter.</span>
</span><span id="L-2236"><a href="#-2236"><span class="linenos">2236</span></a>
</span><span id="L-2237"><a href="#-2237"><span class="linenos">2237</span></a><span class="sd">        See also: `Order()` and `Trade()` docstrings.</span>
</span><span id="L-2238"><a href="#-2238"><span class="linenos">2238</span></a>
</span><span id="L-2239"><a href="#-2239"><span class="linenos">2239</span></a><span class="sd">        :param lots: volume, integer count of lots &gt;= 1.</span>
</span><span id="L-2240"><a href="#-2240"><span class="linenos">2240</span></a><span class="sd">        :param tp: float &gt; 0, take profit price of stop-order.</span>
</span><span id="L-2241"><a href="#-2241"><span class="linenos">2241</span></a><span class="sd">        :param sl: float &gt; 0, stop loss price of stop-order.</span>
</span><span id="L-2242"><a href="#-2242"><span class="linenos">2242</span></a><span class="sd">        :param expDate: it&#39;s a local date in future.</span>
</span><span id="L-2243"><a href="#-2243"><span class="linenos">2243</span></a><span class="sd">                        String has a format like this: `%Y-%m-%d %H:%M:%S`.</span>
</span><span id="L-2244"><a href="#-2244"><span class="linenos">2244</span></a><span class="sd">        :return: JSON with response from broker server.</span>
</span><span id="L-2245"><a href="#-2245"><span class="linenos">2245</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2246"><a href="#-2246"><span class="linenos">2246</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Trade</span><span class="p">(</span><span class="n">operation</span><span class="o">=</span><span class="s2">&quot;Sell&quot;</span><span class="p">,</span> <span class="n">lots</span><span class="o">=</span><span class="n">lots</span><span class="p">,</span> <span class="n">tp</span><span class="o">=</span><span class="n">tp</span><span class="p">,</span> <span class="n">sl</span><span class="o">=</span><span class="n">sl</span><span class="p">,</span> <span class="n">expDate</span><span class="o">=</span><span class="n">expDate</span><span class="p">)</span>
</span><span id="L-2247"><a href="#-2247"><span class="linenos">2247</span></a>
</span><span id="L-2248"><a href="#-2248"><span class="linenos">2248</span></a>    <span class="k">def</span> <span class="nf">CloseTrades</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tickers</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">overview</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2249"><a href="#-2249"><span class="linenos">2249</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2250"><a href="#-2250"><span class="linenos">2250</span></a><span class="sd">        Close position of given instruments.</span>
</span><span id="L-2251"><a href="#-2251"><span class="linenos">2251</span></a>
</span><span id="L-2252"><a href="#-2252"><span class="linenos">2252</span></a><span class="sd">        :param tickers: tickers list of instruments that must be closed.</span>
</span><span id="L-2253"><a href="#-2253"><span class="linenos">2253</span></a><span class="sd">        :param overview: pre-received dictionary with open trades, returned by `Overview()` method.</span>
</span><span id="L-2254"><a href="#-2254"><span class="linenos">2254</span></a><span class="sd">                         This avoids unnecessary downloading data from the server.</span>
</span><span id="L-2255"><a href="#-2255"><span class="linenos">2255</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2256"><a href="#-2256"><span class="linenos">2256</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">tickers</span><span class="p">:</span>
</span><span id="L-2257"><a href="#-2257"><span class="linenos">2257</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Tickers list empty, nothing to close.&quot;</span><span class="p">)</span>
</span><span id="L-2258"><a href="#-2258"><span class="linenos">2258</span></a>
</span><span id="L-2259"><a href="#-2259"><span class="linenos">2259</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2260"><a href="#-2260"><span class="linenos">2260</span></a>            <span class="k">if</span> <span class="n">overview</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">overview</span><span class="p">:</span>
</span><span id="L-2261"><a href="#-2261"><span class="linenos">2261</span></a>                <span class="n">overview</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Overview</span><span class="p">(</span><span class="n">showStatistics</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-2262"><a href="#-2262"><span class="linenos">2262</span></a>
</span><span id="L-2263"><a href="#-2263"><span class="linenos">2263</span></a>            <span class="n">allOpenedTickers</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">iType</span> <span class="ow">in</span> <span class="n">TKS_INSTRUMENTS</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">overview</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="n">iType</span><span class="p">]]</span>
</span><span id="L-2264"><a href="#-2264"><span class="linenos">2264</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;All opened instruments by it&#39;s tickers names: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">allOpenedTickers</span><span class="p">))</span>
</span><span id="L-2265"><a href="#-2265"><span class="linenos">2265</span></a>
</span><span id="L-2266"><a href="#-2266"><span class="linenos">2266</span></a>            <span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">tickers</span><span class="p">:</span>
</span><span id="L-2267"><a href="#-2267"><span class="linenos">2267</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">allOpenedTickers</span><span class="p">:</span>
</span><span id="L-2268"><a href="#-2268"><span class="linenos">2268</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Instrument with ticker [</span><span class="si">{}</span><span class="s2">] not in open positions list!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ticker</span><span class="p">))</span>
</span><span id="L-2269"><a href="#-2269"><span class="linenos">2269</span></a>                    <span class="k">continue</span>
</span><span id="L-2270"><a href="#-2270"><span class="linenos">2270</span></a>
</span><span id="L-2271"><a href="#-2271"><span class="linenos">2271</span></a>                <span class="c1"># search open trade info about instrument by ticker:</span>
</span><span id="L-2272"><a href="#-2272"><span class="linenos">2272</span></a>                <span class="n">instrument</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-2273"><a href="#-2273"><span class="linenos">2273</span></a>                <span class="k">for</span> <span class="n">iType</span> <span class="ow">in</span> <span class="n">TKS_INSTRUMENTS</span><span class="p">:</span>
</span><span id="L-2274"><a href="#-2274"><span class="linenos">2274</span></a>                    <span class="k">if</span> <span class="n">instrument</span><span class="p">:</span>
</span><span id="L-2275"><a href="#-2275"><span class="linenos">2275</span></a>                        <span class="k">break</span>
</span><span id="L-2276"><a href="#-2276"><span class="linenos">2276</span></a>
</span><span id="L-2277"><a href="#-2277"><span class="linenos">2277</span></a>                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">overview</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="n">iType</span><span class="p">]:</span>
</span><span id="L-2278"><a href="#-2278"><span class="linenos">2278</span></a>                        <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ticker</span><span class="p">:</span>
</span><span id="L-2279"><a href="#-2279"><span class="linenos">2279</span></a>                            <span class="n">instrument</span> <span class="o">=</span> <span class="n">item</span>
</span><span id="L-2280"><a href="#-2280"><span class="linenos">2280</span></a>                            <span class="k">break</span>
</span><span id="L-2281"><a href="#-2281"><span class="linenos">2281</span></a>
</span><span id="L-2282"><a href="#-2282"><span class="linenos">2282</span></a>                <span class="k">if</span> <span class="n">instrument</span><span class="p">:</span>
</span><span id="L-2283"><a href="#-2283"><span class="linenos">2283</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">ticker</span>
</span><span id="L-2284"><a href="#-2284"><span class="linenos">2284</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">=</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]</span>
</span><span id="L-2285"><a href="#-2285"><span class="linenos">2285</span></a>
</span><span id="L-2286"><a href="#-2286"><span class="linenos">2286</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Closing trade of instrument: ticker [</span><span class="si">{}</span><span class="s2">], FIGI[</span><span class="si">{}</span><span class="s2">], lots [</span><span class="si">{}</span><span class="s2">]</span><span class="si">{}</span><span class="s2">. Wait, please...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-2287"><a href="#-2287"><span class="linenos">2287</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span>
</span><span id="L-2288"><a href="#-2288"><span class="linenos">2288</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">,</span>
</span><span id="L-2289"><a href="#-2289"><span class="linenos">2289</span></a>                        <span class="nb">int</span><span class="p">(</span><span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;volume&quot;</span><span class="p">]),</span>
</span><span id="L-2290"><a href="#-2290"><span class="linenos">2290</span></a>                        <span class="s2">&quot;, blocked [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;blocked&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;blocked&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-2291"><a href="#-2291"><span class="linenos">2291</span></a>                    <span class="p">))</span>
</span><span id="L-2292"><a href="#-2292"><span class="linenos">2292</span></a>
</span><span id="L-2293"><a href="#-2293"><span class="linenos">2293</span></a>                    <span class="n">tradeLots</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;lots&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;blocked&quot;</span><span class="p">]</span>  <span class="c1"># available volumes in lots for close operation</span>
</span><span id="L-2294"><a href="#-2294"><span class="linenos">2294</span></a>
</span><span id="L-2295"><a href="#-2295"><span class="linenos">2295</span></a>                    <span class="k">if</span> <span class="n">tradeLots</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-2296"><a href="#-2296"><span class="linenos">2296</span></a>                        <span class="k">if</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;blocked&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-2297"><a href="#-2297"><span class="linenos">2297</span></a>                            <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Just for your information: there are [</span><span class="si">{}</span><span class="s2">] lots blocked for instrument [</span><span class="si">{}</span><span class="s2">]! Available only [</span><span class="si">{}</span><span class="s2">] lots to closing trade.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-2298"><a href="#-2298"><span class="linenos">2298</span></a>                                <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;blocked&quot;</span><span class="p">],</span>
</span><span id="L-2299"><a href="#-2299"><span class="linenos">2299</span></a>                                <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span>
</span><span id="L-2300"><a href="#-2300"><span class="linenos">2300</span></a>                                <span class="n">tradeLots</span><span class="p">,</span>
</span><span id="L-2301"><a href="#-2301"><span class="linenos">2301</span></a>                            <span class="p">))</span>
</span><span id="L-2302"><a href="#-2302"><span class="linenos">2302</span></a>
</span><span id="L-2303"><a href="#-2303"><span class="linenos">2303</span></a>                        <span class="c1"># if direction is &quot;Long&quot; then we need sell, if direction is &quot;Short&quot; then we need buy:</span>
</span><span id="L-2304"><a href="#-2304"><span class="linenos">2304</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">Trade</span><span class="p">(</span><span class="n">operation</span><span class="o">=</span><span class="s2">&quot;Sell&quot;</span> <span class="k">if</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;direction&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Long&quot;</span> <span class="k">else</span> <span class="s2">&quot;Buy&quot;</span><span class="p">,</span> <span class="n">lots</span><span class="o">=</span><span class="n">tradeLots</span><span class="p">)</span>
</span><span id="L-2305"><a href="#-2305"><span class="linenos">2305</span></a>
</span><span id="L-2306"><a href="#-2306"><span class="linenos">2306</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-2307"><a href="#-2307"><span class="linenos">2307</span></a>                        <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;There are no available lots for instrument [</span><span class="si">{}</span><span class="s2">] to closing trade at this moment! Try again later or cancel some orders.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">))</span>
</span><span id="L-2308"><a href="#-2308"><span class="linenos">2308</span></a>
</span><span id="L-2309"><a href="#-2309"><span class="linenos">2309</span></a>    <span class="k">def</span> <span class="nf">CloseAllTrades</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iType</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">overview</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2310"><a href="#-2310"><span class="linenos">2310</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2311"><a href="#-2311"><span class="linenos">2311</span></a><span class="sd">        Close all positions of given instruments with defined type.</span>
</span><span id="L-2312"><a href="#-2312"><span class="linenos">2312</span></a>
</span><span id="L-2313"><a href="#-2313"><span class="linenos">2313</span></a><span class="sd">        :param iType: type of the instruments that be closed, it must be one of supported types in TKS_INSTRUMENTS list.</span>
</span><span id="L-2314"><a href="#-2314"><span class="linenos">2314</span></a><span class="sd">        :param overview: pre-received dictionary with open trades, returned by `Overview()` method.</span>
</span><span id="L-2315"><a href="#-2315"><span class="linenos">2315</span></a><span class="sd">                         This avoids unnecessary downloading data from the server.</span>
</span><span id="L-2316"><a href="#-2316"><span class="linenos">2316</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2317"><a href="#-2317"><span class="linenos">2317</span></a>        <span class="k">if</span> <span class="n">iType</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">TKS_INSTRUMENTS</span><span class="p">:</span>
</span><span id="L-2318"><a href="#-2318"><span class="linenos">2318</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Type of the instrument must be one of supported types: </span><span class="si">{}</span><span class="s2">. Given: [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TKS_INSTRUMENTS</span><span class="p">),</span> <span class="n">iType</span><span class="p">))</span>
</span><span id="L-2319"><a href="#-2319"><span class="linenos">2319</span></a>
</span><span id="L-2320"><a href="#-2320"><span class="linenos">2320</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2321"><a href="#-2321"><span class="linenos">2321</span></a>            <span class="k">if</span> <span class="n">overview</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">overview</span><span class="p">:</span>
</span><span id="L-2322"><a href="#-2322"><span class="linenos">2322</span></a>                <span class="n">overview</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Overview</span><span class="p">(</span><span class="n">showStatistics</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-2323"><a href="#-2323"><span class="linenos">2323</span></a>
</span><span id="L-2324"><a href="#-2324"><span class="linenos">2324</span></a>            <span class="n">tickers</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">overview</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="n">iType</span><span class="p">]]</span>
</span><span id="L-2325"><a href="#-2325"><span class="linenos">2325</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Instrument tickers with type [</span><span class="si">{}</span><span class="s2">] that will be closed: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iType</span><span class="p">,</span> <span class="n">tickers</span><span class="p">))</span>
</span><span id="L-2326"><a href="#-2326"><span class="linenos">2326</span></a>
</span><span id="L-2327"><a href="#-2327"><span class="linenos">2327</span></a>            <span class="k">if</span> <span class="n">tickers</span> <span class="ow">and</span> <span class="n">overview</span><span class="p">:</span>
</span><span id="L-2328"><a href="#-2328"><span class="linenos">2328</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">CloseTrades</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">overview</span><span class="p">)</span>
</span><span id="L-2329"><a href="#-2329"><span class="linenos">2329</span></a>
</span><span id="L-2330"><a href="#-2330"><span class="linenos">2330</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-2331"><a href="#-2331"><span class="linenos">2331</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Instrument tickers with type [</span><span class="si">{}</span><span class="s2">] not found, nothing to close.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iType</span><span class="p">))</span>
</span><span id="L-2332"><a href="#-2332"><span class="linenos">2332</span></a>
</span><span id="L-2333"><a href="#-2333"><span class="linenos">2333</span></a>    <span class="k">def</span> <span class="nf">Order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">orderType</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">lots</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">targetPrice</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">limitPrice</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">stopType</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Limit&quot;</span><span class="p">,</span> <span class="n">expDate</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Undefined&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="L-2334"><a href="#-2334"><span class="linenos">2334</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2335"><a href="#-2335"><span class="linenos">2335</span></a><span class="sd">        Universal method to create market or limit orders with all available parameters.</span>
</span><span id="L-2336"><a href="#-2336"><span class="linenos">2336</span></a><span class="sd">        See more simple methods: `BuyLimit()`, `BuyStop()`, `SellLimit()`, `SellStop()`.</span>
</span><span id="L-2337"><a href="#-2337"><span class="linenos">2337</span></a>
</span><span id="L-2338"><a href="#-2338"><span class="linenos">2338</span></a><span class="sd">        If orderType is &quot;Limit&quot; then create pending limit-order below current price if operation is &quot;Buy&quot; and above</span>
</span><span id="L-2339"><a href="#-2339"><span class="linenos">2339</span></a><span class="sd">        current price if operation is &quot;Sell&quot;. A limit order has no expiration date, it lasts until the end of the trading day.</span>
</span><span id="L-2340"><a href="#-2340"><span class="linenos">2340</span></a>
</span><span id="L-2341"><a href="#-2341"><span class="linenos">2341</span></a><span class="sd">        Warning! If you try to create limit-order above current price if &quot;Buy&quot; or below current price if &quot;Sell&quot;</span>
</span><span id="L-2342"><a href="#-2342"><span class="linenos">2342</span></a><span class="sd">        then broker immediately open market order as you can do simple --buy or --sell operations!</span>
</span><span id="L-2343"><a href="#-2343"><span class="linenos">2343</span></a>
</span><span id="L-2344"><a href="#-2344"><span class="linenos">2344</span></a><span class="sd">        If orderType is &quot;Stop&quot; then creates stop-order with any direction &quot;Buy&quot; or &quot;Sell&quot;.</span>
</span><span id="L-2345"><a href="#-2345"><span class="linenos">2345</span></a><span class="sd">        When current price will go up or down to target price value then broker opens a limit order.</span>
</span><span id="L-2346"><a href="#-2346"><span class="linenos">2346</span></a><span class="sd">        Stop-order is opened with unlimited expiration date by default, or you can define expiration date with expDate parameter.</span>
</span><span id="L-2347"><a href="#-2347"><span class="linenos">2347</span></a>
</span><span id="L-2348"><a href="#-2348"><span class="linenos">2348</span></a><span class="sd">        Only one attempt and no retry for opens order. If network issue occurred you can create new request.</span>
</span><span id="L-2349"><a href="#-2349"><span class="linenos">2349</span></a>
</span><span id="L-2350"><a href="#-2350"><span class="linenos">2350</span></a><span class="sd">        :param operation: string &quot;Buy&quot; or &quot;Sell&quot;.</span>
</span><span id="L-2351"><a href="#-2351"><span class="linenos">2351</span></a><span class="sd">        :param orderType: string &quot;Limit&quot; or &quot;Stop&quot;.</span>
</span><span id="L-2352"><a href="#-2352"><span class="linenos">2352</span></a><span class="sd">        :param lots: volume, integer count of lots &gt;= 1.</span>
</span><span id="L-2353"><a href="#-2353"><span class="linenos">2353</span></a><span class="sd">        :param targetPrice: target price &gt; 0. This is open trade price for limit order.</span>
</span><span id="L-2354"><a href="#-2354"><span class="linenos">2354</span></a><span class="sd">        :param limitPrice: limit price &gt;= 0. This parameter only makes sense for stop-order. If limitPrice = 0, then it set as targetPrice.</span>
</span><span id="L-2355"><a href="#-2355"><span class="linenos">2355</span></a><span class="sd">                           Broker will creates limit-order with price equal to limitPrice, when current price goes to target price of stop-order.</span>
</span><span id="L-2356"><a href="#-2356"><span class="linenos">2356</span></a><span class="sd">        :param stopType: string &quot;Limit&quot; by default. This parameter only makes sense for stop-order. There are 3 stop-order types</span>
</span><span id="L-2357"><a href="#-2357"><span class="linenos">2357</span></a><span class="sd">                         &quot;SL&quot;, &quot;TP&quot;, &quot;Limit&quot; for &quot;Stop loss&quot;, &quot;Take profit&quot; and &quot;Stop limit&quot; types accordingly.</span>
</span><span id="L-2358"><a href="#-2358"><span class="linenos">2358</span></a><span class="sd">                         Stop loss order always executed by market price.</span>
</span><span id="L-2359"><a href="#-2359"><span class="linenos">2359</span></a><span class="sd">        :param expDate: string &quot;Undefined&quot; by default or local date in future.</span>
</span><span id="L-2360"><a href="#-2360"><span class="linenos">2360</span></a><span class="sd">                        String has a format like this: `%Y-%m-%d %H:%M:%S`.</span>
</span><span id="L-2361"><a href="#-2361"><span class="linenos">2361</span></a><span class="sd">                        This date is converting to UTC format for server. This parameter only makes sense for stop-order.</span>
</span><span id="L-2362"><a href="#-2362"><span class="linenos">2362</span></a><span class="sd">                        A limit order has no expiration date, it lasts until the end of the trading day.</span>
</span><span id="L-2363"><a href="#-2363"><span class="linenos">2363</span></a><span class="sd">        :return: JSON with response from broker server.</span>
</span><span id="L-2364"><a href="#-2364"><span class="linenos">2364</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2365"><a href="#-2365"><span class="linenos">2365</span></a>        <span class="k">if</span> <span class="n">operation</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">operation</span> <span class="ow">or</span> <span class="n">operation</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Buy&quot;</span><span class="p">,</span> <span class="s2">&quot;Sell&quot;</span><span class="p">):</span>
</span><span id="L-2366"><a href="#-2366"><span class="linenos">2366</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;You must define operation type only one of them: `Buy` or `Sell`!&quot;</span><span class="p">)</span>
</span><span id="L-2367"><a href="#-2367"><span class="linenos">2367</span></a>
</span><span id="L-2368"><a href="#-2368"><span class="linenos">2368</span></a>        <span class="k">if</span> <span class="n">orderType</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">orderType</span> <span class="ow">or</span> <span class="n">orderType</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Limit&quot;</span><span class="p">,</span> <span class="s2">&quot;Stop&quot;</span><span class="p">):</span>
</span><span id="L-2369"><a href="#-2369"><span class="linenos">2369</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;You must define order type only one of them: `Limit` or `Stop`!&quot;</span><span class="p">)</span>
</span><span id="L-2370"><a href="#-2370"><span class="linenos">2370</span></a>
</span><span id="L-2371"><a href="#-2371"><span class="linenos">2371</span></a>        <span class="k">if</span> <span class="n">lots</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">lots</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-2372"><a href="#-2372"><span class="linenos">2372</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;You must define trade volume &gt; 0: integer count of lots!&quot;</span><span class="p">)</span>
</span><span id="L-2373"><a href="#-2373"><span class="linenos">2373</span></a>
</span><span id="L-2374"><a href="#-2374"><span class="linenos">2374</span></a>        <span class="k">if</span> <span class="n">targetPrice</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">targetPrice</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-2375"><a href="#-2375"><span class="linenos">2375</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Target price for limit-order must be greater than 0!&quot;</span><span class="p">)</span>
</span><span id="L-2376"><a href="#-2376"><span class="linenos">2376</span></a>
</span><span id="L-2377"><a href="#-2377"><span class="linenos">2377</span></a>        <span class="k">if</span> <span class="n">limitPrice</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">limitPrice</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-2378"><a href="#-2378"><span class="linenos">2378</span></a>            <span class="n">limitPrice</span> <span class="o">=</span> <span class="n">targetPrice</span>
</span><span id="L-2379"><a href="#-2379"><span class="linenos">2379</span></a>
</span><span id="L-2380"><a href="#-2380"><span class="linenos">2380</span></a>        <span class="k">if</span> <span class="n">stopType</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">stopType</span> <span class="ow">or</span> <span class="n">stopType</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;SL&quot;</span><span class="p">,</span> <span class="s2">&quot;TP&quot;</span><span class="p">,</span> <span class="s2">&quot;Limit&quot;</span><span class="p">):</span>
</span><span id="L-2381"><a href="#-2381"><span class="linenos">2381</span></a>            <span class="n">stopType</span> <span class="o">=</span> <span class="s2">&quot;Limit&quot;</span>
</span><span id="L-2382"><a href="#-2382"><span class="linenos">2382</span></a>
</span><span id="L-2383"><a href="#-2383"><span class="linenos">2383</span></a>        <span class="k">if</span> <span class="n">expDate</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">expDate</span><span class="p">:</span>
</span><span id="L-2384"><a href="#-2384"><span class="linenos">2384</span></a>            <span class="n">expDate</span> <span class="o">=</span> <span class="s2">&quot;Undefined&quot;</span>
</span><span id="L-2385"><a href="#-2385"><span class="linenos">2385</span></a>
</span><span id="L-2386"><a href="#-2386"><span class="linenos">2386</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">):</span>
</span><span id="L-2387"><a href="#-2387"><span class="linenos">2387</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;`self.ticker` or `self.figi` variables must be defined!&quot;</span><span class="p">)</span>
</span><span id="L-2388"><a href="#-2388"><span class="linenos">2388</span></a>
</span><span id="L-2389"><a href="#-2389"><span class="linenos">2389</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-2390"><a href="#-2390"><span class="linenos">2390</span></a>        <span class="n">instrument</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SearchByTicker</span><span class="p">(</span><span class="n">requestPrice</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">SearchByFIGI</span><span class="p">(</span><span class="n">requestPrice</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-2391"><a href="#-2391"><span class="linenos">2391</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">]</span>
</span><span id="L-2392"><a href="#-2392"><span class="linenos">2392</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">=</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]</span>
</span><span id="L-2393"><a href="#-2393"><span class="linenos">2393</span></a>
</span><span id="L-2394"><a href="#-2394"><span class="linenos">2394</span></a>        <span class="k">if</span> <span class="n">orderType</span> <span class="o">==</span> <span class="s2">&quot;Limit&quot;</span><span class="p">:</span>
</span><span id="L-2395"><a href="#-2395"><span class="linenos">2395</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="L-2396"><a href="#-2396"><span class="linenos">2396</span></a>                <span class="s2">&quot;Creating pending limit-order: ticker [</span><span class="si">{}</span><span class="s2">], FIGI [</span><span class="si">{}</span><span class="s2">], action [</span><span class="si">{}</span><span class="s2">], lots [</span><span class="si">{}</span><span class="s2">] and the target price [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">]. Wait, please...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-2397"><a href="#-2397"><span class="linenos">2397</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">,</span>
</span><span id="L-2398"><a href="#-2398"><span class="linenos">2398</span></a>                    <span class="n">operation</span><span class="p">,</span> <span class="n">lots</span><span class="p">,</span> <span class="n">targetPrice</span><span class="p">,</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="L-2399"><a href="#-2399"><span class="linenos">2399</span></a>                <span class="p">))</span>
</span><span id="L-2400"><a href="#-2400"><span class="linenos">2400</span></a>
</span><span id="L-2401"><a href="#-2401"><span class="linenos">2401</span></a>            <span class="n">openOrderURL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;/tinkoff.public.invest.api.contract.v1.OrdersService/PostOrder&quot;</span>
</span><span id="L-2402"><a href="#-2402"><span class="linenos">2402</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="nb">str</span><span class="p">({</span>
</span><span id="L-2403"><a href="#-2403"><span class="linenos">2403</span></a>                <span class="s2">&quot;figi&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">,</span>
</span><span id="L-2404"><a href="#-2404"><span class="linenos">2404</span></a>                <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">lots</span><span class="p">),</span>
</span><span id="L-2405"><a href="#-2405"><span class="linenos">2405</span></a>                <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="n">FloatToNano</span><span class="p">(</span><span class="n">targetPrice</span><span class="p">),</span>
</span><span id="L-2406"><a href="#-2406"><span class="linenos">2406</span></a>                <span class="s2">&quot;direction&quot;</span><span class="p">:</span> <span class="s2">&quot;ORDER_DIRECTION_BUY&quot;</span> <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;Buy&quot;</span> <span class="k">else</span> <span class="s2">&quot;ORDER_DIRECTION_SELL&quot;</span><span class="p">,</span>  <span class="c1"># see: TKS_ORDER_DIRECTIONS</span>
</span><span id="L-2407"><a href="#-2407"><span class="linenos">2407</span></a>                <span class="s2">&quot;accountId&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">accountId</span><span class="p">),</span>
</span><span id="L-2408"><a href="#-2408"><span class="linenos">2408</span></a>                <span class="s2">&quot;orderType&quot;</span><span class="p">:</span> <span class="s2">&quot;ORDER_TYPE_LIMIT&quot;</span><span class="p">,</span>  <span class="c1"># see: TKS_ORDER_TYPES</span>
</span><span id="L-2409"><a href="#-2409"><span class="linenos">2409</span></a>            <span class="p">})</span>
</span><span id="L-2410"><a href="#-2410"><span class="linenos">2410</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SendAPIRequest</span><span class="p">(</span><span class="n">openOrderURL</span><span class="p">,</span> <span class="n">reqType</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="n">retry</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-2411"><a href="#-2411"><span class="linenos">2411</span></a>
</span><span id="L-2412"><a href="#-2412"><span class="linenos">2412</span></a>            <span class="k">if</span> <span class="s2">&quot;orderId&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-2413"><a href="#-2413"><span class="linenos">2413</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="L-2414"><a href="#-2414"><span class="linenos">2414</span></a>                    <span class="s2">&quot;Limit-order [</span><span class="si">{}</span><span class="s2">] was created: ticker [</span><span class="si">{}</span><span class="s2">], FIGI [</span><span class="si">{}</span><span class="s2">], action [</span><span class="si">{}</span><span class="s2">], lots [</span><span class="si">{}</span><span class="s2">], target price [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-2415"><a href="#-2415"><span class="linenos">2415</span></a>                        <span class="n">response</span><span class="p">[</span><span class="s2">&quot;orderId&quot;</span><span class="p">],</span>
</span><span id="L-2416"><a href="#-2416"><span class="linenos">2416</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">,</span>
</span><span id="L-2417"><a href="#-2417"><span class="linenos">2417</span></a>                        <span class="n">operation</span><span class="p">,</span> <span class="n">lots</span><span class="p">,</span> <span class="n">targetPrice</span><span class="p">,</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="L-2418"><a href="#-2418"><span class="linenos">2418</span></a>                    <span class="p">))</span>
</span><span id="L-2419"><a href="#-2419"><span class="linenos">2419</span></a>
</span><span id="L-2420"><a href="#-2420"><span class="linenos">2420</span></a>                <span class="k">if</span> <span class="s2">&quot;lastPrice&quot;</span> <span class="ow">in</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">]:</span>
</span><span id="L-2421"><a href="#-2421"><span class="linenos">2421</span></a>                    <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;Buy&quot;</span> <span class="ow">and</span> <span class="n">targetPrice</span> <span class="o">&gt;</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">]:</span>
</span><span id="L-2422"><a href="#-2422"><span class="linenos">2422</span></a>                        <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Your order was executed as a market order, not as a limit order! Comment: because your target price [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">] was higher than current price [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">] broker immediately opened `Buy` market order, such as if you did simple `--buy` operation.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-2423"><a href="#-2423"><span class="linenos">2423</span></a>                            <span class="n">targetPrice</span><span class="p">,</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="L-2424"><a href="#-2424"><span class="linenos">2424</span></a>                            <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">],</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="L-2425"><a href="#-2425"><span class="linenos">2425</span></a>                        <span class="p">))</span>
</span><span id="L-2426"><a href="#-2426"><span class="linenos">2426</span></a>
</span><span id="L-2427"><a href="#-2427"><span class="linenos">2427</span></a>                    <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;Sell&quot;</span> <span class="ow">and</span> <span class="n">targetPrice</span> <span class="o">&lt;</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">]:</span>
</span><span id="L-2428"><a href="#-2428"><span class="linenos">2428</span></a>                        <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Your order was executed as a market order, not as a limit order! Comment: because your target price [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">] was lower than current price [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">] broker immediately opened `Sell` market order, such as if you did simple `--sell` operation.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-2429"><a href="#-2429"><span class="linenos">2429</span></a>                            <span class="n">targetPrice</span><span class="p">,</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="L-2430"><a href="#-2430"><span class="linenos">2430</span></a>                            <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">],</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="L-2431"><a href="#-2431"><span class="linenos">2431</span></a>                        <span class="p">))</span>
</span><span id="L-2432"><a href="#-2432"><span class="linenos">2432</span></a>
</span><span id="L-2433"><a href="#-2433"><span class="linenos">2433</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-2434"><a href="#-2434"><span class="linenos">2434</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Not `oK` status received! Limit order not opened. See full debug log or try again and open order later.&quot;</span><span class="p">)</span>
</span><span id="L-2435"><a href="#-2435"><span class="linenos">2435</span></a>
</span><span id="L-2436"><a href="#-2436"><span class="linenos">2436</span></a>        <span class="k">if</span> <span class="n">orderType</span> <span class="o">==</span> <span class="s2">&quot;Stop&quot;</span><span class="p">:</span>
</span><span id="L-2437"><a href="#-2437"><span class="linenos">2437</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="L-2438"><a href="#-2438"><span class="linenos">2438</span></a>                <span class="s2">&quot;Creating stop-order: ticker [</span><span class="si">{}</span><span class="s2">], FIGI [</span><span class="si">{}</span><span class="s2">], action [</span><span class="si">{}</span><span class="s2">], lots [</span><span class="si">{}</span><span class="s2">], target price [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">], limit price [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">], stop-order type [</span><span class="si">{}</span><span class="s2">] and local expiration date [</span><span class="si">{}</span><span class="s2">]. Wait, please...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-2439"><a href="#-2439"><span class="linenos">2439</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">,</span>
</span><span id="L-2440"><a href="#-2440"><span class="linenos">2440</span></a>                    <span class="n">operation</span><span class="p">,</span> <span class="n">lots</span><span class="p">,</span>
</span><span id="L-2441"><a href="#-2441"><span class="linenos">2441</span></a>                    <span class="n">targetPrice</span><span class="p">,</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="L-2442"><a href="#-2442"><span class="linenos">2442</span></a>                    <span class="n">limitPrice</span><span class="p">,</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="L-2443"><a href="#-2443"><span class="linenos">2443</span></a>                    <span class="n">stopType</span><span class="p">,</span> <span class="n">expDate</span><span class="p">,</span>
</span><span id="L-2444"><a href="#-2444"><span class="linenos">2444</span></a>                <span class="p">))</span>
</span><span id="L-2445"><a href="#-2445"><span class="linenos">2445</span></a>
</span><span id="L-2446"><a href="#-2446"><span class="linenos">2446</span></a>            <span class="n">openOrderURL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;/tinkoff.public.invest.api.contract.v1.StopOrdersService/PostStopOrder&quot;</span>
</span><span id="L-2447"><a href="#-2447"><span class="linenos">2447</span></a>            <span class="n">expDateUTC</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">expDate</span> <span class="o">==</span> <span class="s2">&quot;Undefined&quot;</span> <span class="k">else</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">expDate</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">tzlocal</span><span class="p">())</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">tzutc</span><span class="p">())</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S.</span><span class="si">%f</span><span class="s2">Z&quot;</span><span class="p">)</span>
</span><span id="L-2448"><a href="#-2448"><span class="linenos">2448</span></a>            <span class="n">stopOrderType</span> <span class="o">=</span> <span class="s2">&quot;STOP_ORDER_TYPE_STOP_LOSS&quot;</span> <span class="k">if</span> <span class="n">stopType</span> <span class="o">==</span> <span class="s2">&quot;SL&quot;</span> <span class="k">else</span> <span class="s2">&quot;STOP_ORDER_TYPE_TAKE_PROFIT&quot;</span> <span class="k">if</span> <span class="n">stopType</span> <span class="o">==</span> <span class="s2">&quot;TP&quot;</span> <span class="k">else</span> <span class="s2">&quot;STOP_ORDER_TYPE_STOP_LIMIT&quot;</span>
</span><span id="L-2449"><a href="#-2449"><span class="linenos">2449</span></a>
</span><span id="L-2450"><a href="#-2450"><span class="linenos">2450</span></a>            <span class="n">body</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-2451"><a href="#-2451"><span class="linenos">2451</span></a>                <span class="s2">&quot;figi&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">,</span>
</span><span id="L-2452"><a href="#-2452"><span class="linenos">2452</span></a>                <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">lots</span><span class="p">),</span>
</span><span id="L-2453"><a href="#-2453"><span class="linenos">2453</span></a>                <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="n">FloatToNano</span><span class="p">(</span><span class="n">limitPrice</span><span class="p">),</span>
</span><span id="L-2454"><a href="#-2454"><span class="linenos">2454</span></a>                <span class="s2">&quot;stopPrice&quot;</span><span class="p">:</span> <span class="n">FloatToNano</span><span class="p">(</span><span class="n">targetPrice</span><span class="p">),</span>
</span><span id="L-2455"><a href="#-2455"><span class="linenos">2455</span></a>                <span class="s2">&quot;direction&quot;</span><span class="p">:</span> <span class="s2">&quot;STOP_ORDER_DIRECTION_BUY&quot;</span> <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;Buy&quot;</span> <span class="k">else</span> <span class="s2">&quot;STOP_ORDER_DIRECTION_SELL&quot;</span><span class="p">,</span>  <span class="c1"># see: TKS_STOP_ORDER_DIRECTIONS</span>
</span><span id="L-2456"><a href="#-2456"><span class="linenos">2456</span></a>                <span class="s2">&quot;accountId&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">accountId</span><span class="p">),</span>
</span><span id="L-2457"><a href="#-2457"><span class="linenos">2457</span></a>                <span class="s2">&quot;expirationType&quot;</span><span class="p">:</span> <span class="s2">&quot;STOP_ORDER_EXPIRATION_TYPE_GOOD_TILL_DATE&quot;</span> <span class="k">if</span> <span class="n">expDateUTC</span> <span class="k">else</span> <span class="s2">&quot;STOP_ORDER_EXPIRATION_TYPE_GOOD_TILL_CANCEL&quot;</span><span class="p">,</span>  <span class="c1"># see: TKS_STOP_ORDER_EXPIRATION_TYPES</span>
</span><span id="L-2458"><a href="#-2458"><span class="linenos">2458</span></a>                <span class="s2">&quot;stopOrderType&quot;</span><span class="p">:</span> <span class="n">stopOrderType</span><span class="p">,</span>  <span class="c1"># see: TKS_STOP_ORDER_TYPES</span>
</span><span id="L-2459"><a href="#-2459"><span class="linenos">2459</span></a>            <span class="p">}</span>
</span><span id="L-2460"><a href="#-2460"><span class="linenos">2460</span></a>
</span><span id="L-2461"><a href="#-2461"><span class="linenos">2461</span></a>            <span class="k">if</span> <span class="n">expDateUTC</span><span class="p">:</span>
</span><span id="L-2462"><a href="#-2462"><span class="linenos">2462</span></a>                <span class="n">body</span><span class="p">[</span><span class="s2">&quot;expireDate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">expDateUTC</span>
</span><span id="L-2463"><a href="#-2463"><span class="linenos">2463</span></a>
</span><span id="L-2464"><a href="#-2464"><span class="linenos">2464</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
</span><span id="L-2465"><a href="#-2465"><span class="linenos">2465</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SendAPIRequest</span><span class="p">(</span><span class="n">openOrderURL</span><span class="p">,</span> <span class="n">reqType</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="n">retry</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-2466"><a href="#-2466"><span class="linenos">2466</span></a>
</span><span id="L-2467"><a href="#-2467"><span class="linenos">2467</span></a>            <span class="k">if</span> <span class="s2">&quot;stopOrderId&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-2468"><a href="#-2468"><span class="linenos">2468</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="L-2469"><a href="#-2469"><span class="linenos">2469</span></a>                    <span class="s2">&quot;Stop-order [</span><span class="si">{}</span><span class="s2">] was created: ticker [</span><span class="si">{}</span><span class="s2">], FIGI [</span><span class="si">{}</span><span class="s2">], action [</span><span class="si">{}</span><span class="s2">], lots [</span><span class="si">{}</span><span class="s2">], target price [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">], limit price [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">], stop-order type [</span><span class="si">{}</span><span class="s2">] and expiration date in UTC [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-2470"><a href="#-2470"><span class="linenos">2470</span></a>                    <span class="n">response</span><span class="p">[</span><span class="s2">&quot;stopOrderId&quot;</span><span class="p">],</span>
</span><span id="L-2471"><a href="#-2471"><span class="linenos">2471</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">,</span>
</span><span id="L-2472"><a href="#-2472"><span class="linenos">2472</span></a>                    <span class="n">operation</span><span class="p">,</span> <span class="n">lots</span><span class="p">,</span>
</span><span id="L-2473"><a href="#-2473"><span class="linenos">2473</span></a>                    <span class="n">targetPrice</span><span class="p">,</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="L-2474"><a href="#-2474"><span class="linenos">2474</span></a>                    <span class="n">limitPrice</span><span class="p">,</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="L-2475"><a href="#-2475"><span class="linenos">2475</span></a>                    <span class="n">TKS_STOP_ORDER_TYPES</span><span class="p">[</span><span class="n">stopOrderType</span><span class="p">],</span>
</span><span id="L-2476"><a href="#-2476"><span class="linenos">2476</span></a>                    <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">expDateUTC</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S.</span><span class="si">%f</span><span class="s2">Z&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">tzutc</span><span class="p">())</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">tzutc</span><span class="p">())</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">expDateUTC</span> <span class="k">else</span> <span class="n">TKS_STOP_ORDER_EXPIRATION_TYPES</span><span class="p">[</span><span class="s2">&quot;STOP_ORDER_EXPIRATION_TYPE_UNSPECIFIED&quot;</span><span class="p">],</span>
</span><span id="L-2477"><a href="#-2477"><span class="linenos">2477</span></a>                <span class="p">))</span>
</span><span id="L-2478"><a href="#-2478"><span class="linenos">2478</span></a>
</span><span id="L-2479"><a href="#-2479"><span class="linenos">2479</span></a>                <span class="k">if</span> <span class="s2">&quot;lastPrice&quot;</span> <span class="ow">in</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">]:</span>
</span><span id="L-2480"><a href="#-2480"><span class="linenos">2480</span></a>                    <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;Buy&quot;</span> <span class="ow">and</span> <span class="n">targetPrice</span> <span class="o">&lt;</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">stopType</span> <span class="o">!=</span> <span class="s2">&quot;TP&quot;</span><span class="p">:</span>
</span><span id="L-2481"><a href="#-2481"><span class="linenos">2481</span></a>                        <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;The broker will cancel this order after some time. Comment: you placed the wrong stop order because the target buy price [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">] is lower than the current price [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">]. Also try to set up order type as `TP` if you want to place stop order at that price.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-2482"><a href="#-2482"><span class="linenos">2482</span></a>                            <span class="n">targetPrice</span><span class="p">,</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="L-2483"><a href="#-2483"><span class="linenos">2483</span></a>                            <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">],</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="L-2484"><a href="#-2484"><span class="linenos">2484</span></a>                        <span class="p">))</span>
</span><span id="L-2485"><a href="#-2485"><span class="linenos">2485</span></a>
</span><span id="L-2486"><a href="#-2486"><span class="linenos">2486</span></a>                    <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;Sell&quot;</span> <span class="ow">and</span> <span class="n">targetPrice</span> <span class="o">&gt;</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">stopType</span> <span class="o">!=</span> <span class="s2">&quot;TP&quot;</span><span class="p">:</span>
</span><span id="L-2487"><a href="#-2487"><span class="linenos">2487</span></a>                        <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;The broker will cancel this order after some time. Comment: you placed the wrong stop order because the target sell price [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">] is higher than the current price [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">]. Also try to set up order type as `TP` if you want to place stop order at that price.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-2488"><a href="#-2488"><span class="linenos">2488</span></a>                            <span class="n">targetPrice</span><span class="p">,</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="L-2489"><a href="#-2489"><span class="linenos">2489</span></a>                            <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">],</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="L-2490"><a href="#-2490"><span class="linenos">2490</span></a>                        <span class="p">))</span>
</span><span id="L-2491"><a href="#-2491"><span class="linenos">2491</span></a>
</span><span id="L-2492"><a href="#-2492"><span class="linenos">2492</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-2493"><a href="#-2493"><span class="linenos">2493</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Not `oK` status received! Stop order not opened. See full debug log or try again and open order later.&quot;</span><span class="p">)</span>
</span><span id="L-2494"><a href="#-2494"><span class="linenos">2494</span></a>
</span><span id="L-2495"><a href="#-2495"><span class="linenos">2495</span></a>        <span class="k">return</span> <span class="n">response</span>
</span><span id="L-2496"><a href="#-2496"><span class="linenos">2496</span></a>
</span><span id="L-2497"><a href="#-2497"><span class="linenos">2497</span></a>    <span class="k">def</span> <span class="nf">BuyLimit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lots</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">targetPrice</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="L-2498"><a href="#-2498"><span class="linenos">2498</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2499"><a href="#-2499"><span class="linenos">2499</span></a><span class="sd">        Create pending `Buy` limit-order (below current price). You must specify only 2 parameters:</span>
</span><span id="L-2500"><a href="#-2500"><span class="linenos">2500</span></a><span class="sd">        `lots` and `target price` to open buy limit-order. If you try to create buy limit-order above current price then</span>
</span><span id="L-2501"><a href="#-2501"><span class="linenos">2501</span></a><span class="sd">        broker immediately open `Buy` market order, such as if you do simple `--buy` operation!</span>
</span><span id="L-2502"><a href="#-2502"><span class="linenos">2502</span></a><span class="sd">        See also: `Order()` docstring.</span>
</span><span id="L-2503"><a href="#-2503"><span class="linenos">2503</span></a>
</span><span id="L-2504"><a href="#-2504"><span class="linenos">2504</span></a><span class="sd">        :param lots: volume, integer count of lots &gt;= 1.</span>
</span><span id="L-2505"><a href="#-2505"><span class="linenos">2505</span></a><span class="sd">        :param targetPrice: target price &gt; 0. This is open trade price for limit order.</span>
</span><span id="L-2506"><a href="#-2506"><span class="linenos">2506</span></a><span class="sd">        :return: JSON with response from broker server.</span>
</span><span id="L-2507"><a href="#-2507"><span class="linenos">2507</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2508"><a href="#-2508"><span class="linenos">2508</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Order</span><span class="p">(</span><span class="n">operation</span><span class="o">=</span><span class="s2">&quot;Buy&quot;</span><span class="p">,</span> <span class="n">orderType</span><span class="o">=</span><span class="s2">&quot;Limit&quot;</span><span class="p">,</span> <span class="n">lots</span><span class="o">=</span><span class="n">lots</span><span class="p">,</span> <span class="n">targetPrice</span><span class="o">=</span><span class="n">targetPrice</span><span class="p">)</span>
</span><span id="L-2509"><a href="#-2509"><span class="linenos">2509</span></a>
</span><span id="L-2510"><a href="#-2510"><span class="linenos">2510</span></a>    <span class="k">def</span> <span class="nf">BuyStop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lots</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">targetPrice</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">limitPrice</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">stopType</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Limit&quot;</span><span class="p">,</span> <span class="n">expDate</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Undefined&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="L-2511"><a href="#-2511"><span class="linenos">2511</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2512"><a href="#-2512"><span class="linenos">2512</span></a><span class="sd">        Create `Buy` stop-order. You must specify at least 2 parameters: `lots` `target price` to open buy stop-order.</span>
</span><span id="L-2513"><a href="#-2513"><span class="linenos">2513</span></a><span class="sd">        In additional you can specify 3 parameters for buy stop-order: `limit price` &gt;=0, `stop type` = Limit|SL|TP,</span>
</span><span id="L-2514"><a href="#-2514"><span class="linenos">2514</span></a><span class="sd">        `expiration date` = Undefined|`%%Y-%%m-%%d %%H:%%M:%%S`. When current price will go up or down to</span>
</span><span id="L-2515"><a href="#-2515"><span class="linenos">2515</span></a><span class="sd">        target price value then broker opens a limit order. See also: `Order()` docstring.</span>
</span><span id="L-2516"><a href="#-2516"><span class="linenos">2516</span></a>
</span><span id="L-2517"><a href="#-2517"><span class="linenos">2517</span></a><span class="sd">        :param lots: volume, integer count of lots &gt;= 1.</span>
</span><span id="L-2518"><a href="#-2518"><span class="linenos">2518</span></a><span class="sd">        :param targetPrice: target price &gt; 0. This is trigger price for buy stop-order.</span>
</span><span id="L-2519"><a href="#-2519"><span class="linenos">2519</span></a><span class="sd">        :param limitPrice: limit price &gt;= 0 (limitPrice = targetPrice if limitPrice is 0). Broker will creates limit-order</span>
</span><span id="L-2520"><a href="#-2520"><span class="linenos">2520</span></a><span class="sd">                           with price equal to limitPrice, when current price goes to target price of buy stop-order.</span>
</span><span id="L-2521"><a href="#-2521"><span class="linenos">2521</span></a><span class="sd">        :param stopType: string &quot;Limit&quot; by default. There are 3 stop-order types &quot;SL&quot;, &quot;TP&quot;, &quot;Limit&quot;</span>
</span><span id="L-2522"><a href="#-2522"><span class="linenos">2522</span></a><span class="sd">                         for &quot;Stop loss&quot;, &quot;Take profit&quot; and &quot;Stop limit&quot; types accordingly.</span>
</span><span id="L-2523"><a href="#-2523"><span class="linenos">2523</span></a><span class="sd">        :param expDate: string &quot;Undefined&quot; by default or local date in future.</span>
</span><span id="L-2524"><a href="#-2524"><span class="linenos">2524</span></a><span class="sd">                        String has a format like this: `%Y-%m-%d %H:%M:%S`.</span>
</span><span id="L-2525"><a href="#-2525"><span class="linenos">2525</span></a><span class="sd">                        This date is converting to UTC format for server.</span>
</span><span id="L-2526"><a href="#-2526"><span class="linenos">2526</span></a><span class="sd">        :return: JSON with response from broker server.</span>
</span><span id="L-2527"><a href="#-2527"><span class="linenos">2527</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2528"><a href="#-2528"><span class="linenos">2528</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Order</span><span class="p">(</span><span class="n">operation</span><span class="o">=</span><span class="s2">&quot;Buy&quot;</span><span class="p">,</span> <span class="n">orderType</span><span class="o">=</span><span class="s2">&quot;Stop&quot;</span><span class="p">,</span> <span class="n">lots</span><span class="o">=</span><span class="n">lots</span><span class="p">,</span> <span class="n">targetPrice</span><span class="o">=</span><span class="n">targetPrice</span><span class="p">,</span> <span class="n">limitPrice</span><span class="o">=</span><span class="n">limitPrice</span><span class="p">,</span> <span class="n">stopType</span><span class="o">=</span><span class="n">stopType</span><span class="p">,</span> <span class="n">expDate</span><span class="o">=</span><span class="n">expDate</span><span class="p">)</span>
</span><span id="L-2529"><a href="#-2529"><span class="linenos">2529</span></a>
</span><span id="L-2530"><a href="#-2530"><span class="linenos">2530</span></a>    <span class="k">def</span> <span class="nf">SellLimit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lots</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">targetPrice</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="L-2531"><a href="#-2531"><span class="linenos">2531</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2532"><a href="#-2532"><span class="linenos">2532</span></a><span class="sd">        Create pending `Sell` limit-order (above current price). You must specify only 2 parameters:</span>
</span><span id="L-2533"><a href="#-2533"><span class="linenos">2533</span></a><span class="sd">        `lots` and `target price` to open sell limit-order. If you try to create sell limit-order below current price then</span>
</span><span id="L-2534"><a href="#-2534"><span class="linenos">2534</span></a><span class="sd">        broker immediately open `Sell` market order, such as if you do simple `--sell` operation!</span>
</span><span id="L-2535"><a href="#-2535"><span class="linenos">2535</span></a><span class="sd">        See also: `Order()` docstring.</span>
</span><span id="L-2536"><a href="#-2536"><span class="linenos">2536</span></a>
</span><span id="L-2537"><a href="#-2537"><span class="linenos">2537</span></a><span class="sd">        :param lots: volume, integer count of lots &gt;= 1.</span>
</span><span id="L-2538"><a href="#-2538"><span class="linenos">2538</span></a><span class="sd">        :param targetPrice: target price &gt; 0. This is open trade price for limit order.</span>
</span><span id="L-2539"><a href="#-2539"><span class="linenos">2539</span></a><span class="sd">        :return: JSON with response from broker server.</span>
</span><span id="L-2540"><a href="#-2540"><span class="linenos">2540</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2541"><a href="#-2541"><span class="linenos">2541</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Order</span><span class="p">(</span><span class="n">operation</span><span class="o">=</span><span class="s2">&quot;Sell&quot;</span><span class="p">,</span> <span class="n">orderType</span><span class="o">=</span><span class="s2">&quot;Limit&quot;</span><span class="p">,</span> <span class="n">lots</span><span class="o">=</span><span class="n">lots</span><span class="p">,</span> <span class="n">targetPrice</span><span class="o">=</span><span class="n">targetPrice</span><span class="p">)</span>
</span><span id="L-2542"><a href="#-2542"><span class="linenos">2542</span></a>
</span><span id="L-2543"><a href="#-2543"><span class="linenos">2543</span></a>    <span class="k">def</span> <span class="nf">SellStop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lots</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">targetPrice</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">limitPrice</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">stopType</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Limit&quot;</span><span class="p">,</span> <span class="n">expDate</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Undefined&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="L-2544"><a href="#-2544"><span class="linenos">2544</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2545"><a href="#-2545"><span class="linenos">2545</span></a><span class="sd">        Create `Sell` stop-order. You must specify at least 2 parameters: `lots` `target price` to open sell stop-order.</span>
</span><span id="L-2546"><a href="#-2546"><span class="linenos">2546</span></a><span class="sd">        In additional you can specify 3 parameters for sell stop-order: `limit price` &gt;=0, `stop type` = Limit|SL|TP,</span>
</span><span id="L-2547"><a href="#-2547"><span class="linenos">2547</span></a><span class="sd">        `expiration date` = Undefined|`%%Y-%%m-%%d %%H:%%M:%%S`. When current price will go up or down to</span>
</span><span id="L-2548"><a href="#-2548"><span class="linenos">2548</span></a><span class="sd">        target price value then broker opens a limit order. See also: `Order()` docstring.</span>
</span><span id="L-2549"><a href="#-2549"><span class="linenos">2549</span></a>
</span><span id="L-2550"><a href="#-2550"><span class="linenos">2550</span></a><span class="sd">        :param lots: volume, integer count of lots &gt;= 1.</span>
</span><span id="L-2551"><a href="#-2551"><span class="linenos">2551</span></a><span class="sd">        :param targetPrice: target price &gt; 0. This is trigger price for sell stop-order.</span>
</span><span id="L-2552"><a href="#-2552"><span class="linenos">2552</span></a><span class="sd">        :param limitPrice: limit price &gt;= 0 (limitPrice = targetPrice if limitPrice is 0). Broker will creates limit-order</span>
</span><span id="L-2553"><a href="#-2553"><span class="linenos">2553</span></a><span class="sd">                           with price equal to limitPrice, when current price goes to target price of sell stop-order.</span>
</span><span id="L-2554"><a href="#-2554"><span class="linenos">2554</span></a><span class="sd">        :param stopType: string &quot;Limit&quot; by default. There are 3 stop-order types &quot;SL&quot;, &quot;TP&quot;, &quot;Limit&quot;</span>
</span><span id="L-2555"><a href="#-2555"><span class="linenos">2555</span></a><span class="sd">                         for &quot;Stop loss&quot;, &quot;Take profit&quot; and &quot;Stop limit&quot; types accordingly.</span>
</span><span id="L-2556"><a href="#-2556"><span class="linenos">2556</span></a><span class="sd">        :param expDate: string &quot;Undefined&quot; by default or local date in future.</span>
</span><span id="L-2557"><a href="#-2557"><span class="linenos">2557</span></a><span class="sd">                        String has a format like this: `%Y-%m-%d %H:%M:%S`.</span>
</span><span id="L-2558"><a href="#-2558"><span class="linenos">2558</span></a><span class="sd">                        This date is converting to UTC format for server.</span>
</span><span id="L-2559"><a href="#-2559"><span class="linenos">2559</span></a><span class="sd">        :return: JSON with response from broker server.</span>
</span><span id="L-2560"><a href="#-2560"><span class="linenos">2560</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2561"><a href="#-2561"><span class="linenos">2561</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Order</span><span class="p">(</span><span class="n">operation</span><span class="o">=</span><span class="s2">&quot;Sell&quot;</span><span class="p">,</span> <span class="n">orderType</span><span class="o">=</span><span class="s2">&quot;Stop&quot;</span><span class="p">,</span> <span class="n">lots</span><span class="o">=</span><span class="n">lots</span><span class="p">,</span> <span class="n">targetPrice</span><span class="o">=</span><span class="n">targetPrice</span><span class="p">,</span> <span class="n">limitPrice</span><span class="o">=</span><span class="n">limitPrice</span><span class="p">,</span> <span class="n">stopType</span><span class="o">=</span><span class="n">stopType</span><span class="p">,</span> <span class="n">expDate</span><span class="o">=</span><span class="n">expDate</span><span class="p">)</span>
</span><span id="L-2562"><a href="#-2562"><span class="linenos">2562</span></a>
</span><span id="L-2563"><a href="#-2563"><span class="linenos">2563</span></a>    <span class="k">def</span> <span class="nf">CloseOrders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orderIDs</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">allOrdersIDs</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">allStopOrdersIDs</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2564"><a href="#-2564"><span class="linenos">2564</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2565"><a href="#-2565"><span class="linenos">2565</span></a><span class="sd">        Cancel order or list of orders by its `orderId` or `stopOrderId`.</span>
</span><span id="L-2566"><a href="#-2566"><span class="linenos">2566</span></a>
</span><span id="L-2567"><a href="#-2567"><span class="linenos">2567</span></a><span class="sd">        :param orderIDs: list of integers with `orderId` or `stopOrderId`.</span>
</span><span id="L-2568"><a href="#-2568"><span class="linenos">2568</span></a><span class="sd">        :param allOrdersIDs: pre-received lists of all active pending orders.</span>
</span><span id="L-2569"><a href="#-2569"><span class="linenos">2569</span></a><span class="sd">                             This avoids unnecessary downloading data from the server.</span>
</span><span id="L-2570"><a href="#-2570"><span class="linenos">2570</span></a><span class="sd">        :param allStopOrdersIDs: pre-received lists of all active stop orders.</span>
</span><span id="L-2571"><a href="#-2571"><span class="linenos">2571</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2572"><a href="#-2572"><span class="linenos">2572</span></a>        <span class="k">if</span> <span class="n">orderIDs</span><span class="p">:</span>
</span><span id="L-2573"><a href="#-2573"><span class="linenos">2573</span></a>            <span class="k">if</span> <span class="n">allOrdersIDs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">allOrdersIDs</span><span class="p">:</span>
</span><span id="L-2574"><a href="#-2574"><span class="linenos">2574</span></a>                <span class="n">rawOrders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RequestPendingOrders</span><span class="p">()</span>
</span><span id="L-2575"><a href="#-2575"><span class="linenos">2575</span></a>                <span class="n">allOrdersIDs</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;orderId&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">rawOrders</span><span class="p">]</span>  <span class="c1"># all pending orders ID</span>
</span><span id="L-2576"><a href="#-2576"><span class="linenos">2576</span></a>
</span><span id="L-2577"><a href="#-2577"><span class="linenos">2577</span></a>            <span class="k">if</span> <span class="n">allStopOrdersIDs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">allStopOrdersIDs</span><span class="p">:</span>
</span><span id="L-2578"><a href="#-2578"><span class="linenos">2578</span></a>                <span class="n">rawStopOrders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RequestStopOrders</span><span class="p">()</span>
</span><span id="L-2579"><a href="#-2579"><span class="linenos">2579</span></a>                <span class="n">allStopOrdersIDs</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;stopOrderId&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">rawStopOrders</span><span class="p">]</span>  <span class="c1"># all stop orders ID</span>
</span><span id="L-2580"><a href="#-2580"><span class="linenos">2580</span></a>
</span><span id="L-2581"><a href="#-2581"><span class="linenos">2581</span></a>            <span class="k">for</span> <span class="n">orderID</span> <span class="ow">in</span> <span class="n">orderIDs</span><span class="p">:</span>
</span><span id="L-2582"><a href="#-2582"><span class="linenos">2582</span></a>                <span class="n">idInPendingOrders</span> <span class="o">=</span> <span class="n">orderID</span> <span class="ow">in</span> <span class="n">allOrdersIDs</span>
</span><span id="L-2583"><a href="#-2583"><span class="linenos">2583</span></a>                <span class="n">idInStopOrders</span> <span class="o">=</span> <span class="n">orderID</span> <span class="ow">in</span> <span class="n">allStopOrdersIDs</span>
</span><span id="L-2584"><a href="#-2584"><span class="linenos">2584</span></a>
</span><span id="L-2585"><a href="#-2585"><span class="linenos">2585</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">idInPendingOrders</span> <span class="ow">or</span> <span class="n">idInStopOrders</span><span class="p">):</span>
</span><span id="L-2586"><a href="#-2586"><span class="linenos">2586</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Order not found by ID: [</span><span class="si">{}</span><span class="s2">]. Maybe cancelled already? Check it with `--overview` key.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">orderID</span><span class="p">))</span>
</span><span id="L-2587"><a href="#-2587"><span class="linenos">2587</span></a>                    <span class="k">continue</span>
</span><span id="L-2588"><a href="#-2588"><span class="linenos">2588</span></a>
</span><span id="L-2589"><a href="#-2589"><span class="linenos">2589</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-2590"><a href="#-2590"><span class="linenos">2590</span></a>                    <span class="k">if</span> <span class="n">idInPendingOrders</span><span class="p">:</span>
</span><span id="L-2591"><a href="#-2591"><span class="linenos">2591</span></a>                        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Cancelling pending order with ID: [</span><span class="si">{}</span><span class="s2">]. Wait, please...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">orderID</span><span class="p">))</span>
</span><span id="L-2592"><a href="#-2592"><span class="linenos">2592</span></a>
</span><span id="L-2593"><a href="#-2593"><span class="linenos">2593</span></a>                        <span class="c1"># REST API for request: https://tinkoff.github.io/investAPI/swagger-ui/#/OrdersService/OrdersService_CancelOrder</span>
</span><span id="L-2594"><a href="#-2594"><span class="linenos">2594</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="nb">str</span><span class="p">({</span><span class="s2">&quot;accountId&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">accountId</span><span class="p">,</span> <span class="s2">&quot;orderId&quot;</span><span class="p">:</span> <span class="n">orderID</span><span class="p">})</span>
</span><span id="L-2595"><a href="#-2595"><span class="linenos">2595</span></a>                        <span class="n">closeURL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;/tinkoff.public.invest.api.contract.v1.OrdersService/CancelOrder&quot;</span>
</span><span id="L-2596"><a href="#-2596"><span class="linenos">2596</span></a>                        <span class="n">responseJSON</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SendAPIRequest</span><span class="p">(</span><span class="n">closeURL</span><span class="p">,</span> <span class="n">reqType</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">)</span>
</span><span id="L-2597"><a href="#-2597"><span class="linenos">2597</span></a>
</span><span id="L-2598"><a href="#-2598"><span class="linenos">2598</span></a>                        <span class="k">if</span> <span class="n">responseJSON</span> <span class="ow">and</span> <span class="s2">&quot;time&quot;</span> <span class="ow">in</span> <span class="n">responseJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">responseJSON</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]:</span>
</span><span id="L-2599"><a href="#-2599"><span class="linenos">2599</span></a>                            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Success time marker received from server: [</span><span class="si">{}</span><span class="s2">] (UTC)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">responseJSON</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]))</span>
</span><span id="L-2600"><a href="#-2600"><span class="linenos">2600</span></a>                            <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Pending order with ID [</span><span class="si">{}</span><span class="s2">] successfully cancel&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">orderID</span><span class="p">))</span>
</span><span id="L-2601"><a href="#-2601"><span class="linenos">2601</span></a>
</span><span id="L-2602"><a href="#-2602"><span class="linenos">2602</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2603"><a href="#-2603"><span class="linenos">2603</span></a>                            <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unknown issue occurred when cancelling pending order with ID: [</span><span class="si">{}</span><span class="s2">]. Check ID and try again.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">orderID</span><span class="p">))</span>
</span><span id="L-2604"><a href="#-2604"><span class="linenos">2604</span></a>
</span><span id="L-2605"><a href="#-2605"><span class="linenos">2605</span></a>                    <span class="k">elif</span> <span class="n">idInStopOrders</span><span class="p">:</span>
</span><span id="L-2606"><a href="#-2606"><span class="linenos">2606</span></a>                        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Cancelling stop order with ID: [</span><span class="si">{}</span><span class="s2">]. Wait, please...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">orderID</span><span class="p">))</span>
</span><span id="L-2607"><a href="#-2607"><span class="linenos">2607</span></a>
</span><span id="L-2608"><a href="#-2608"><span class="linenos">2608</span></a>                        <span class="c1"># REST API for request: https://tinkoff.github.io/investAPI/swagger-ui/#/StopOrdersService/StopOrdersService_CancelStopOrder</span>
</span><span id="L-2609"><a href="#-2609"><span class="linenos">2609</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="nb">str</span><span class="p">({</span><span class="s2">&quot;accountId&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">accountId</span><span class="p">,</span> <span class="s2">&quot;stopOrderId&quot;</span><span class="p">:</span> <span class="n">orderID</span><span class="p">})</span>
</span><span id="L-2610"><a href="#-2610"><span class="linenos">2610</span></a>                        <span class="n">closeURL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;/tinkoff.public.invest.api.contract.v1.StopOrdersService/CancelStopOrder&quot;</span>
</span><span id="L-2611"><a href="#-2611"><span class="linenos">2611</span></a>                        <span class="n">responseJSON</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SendAPIRequest</span><span class="p">(</span><span class="n">closeURL</span><span class="p">,</span> <span class="n">reqType</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">)</span>
</span><span id="L-2612"><a href="#-2612"><span class="linenos">2612</span></a>
</span><span id="L-2613"><a href="#-2613"><span class="linenos">2613</span></a>                        <span class="k">if</span> <span class="n">responseJSON</span> <span class="ow">and</span> <span class="s2">&quot;time&quot;</span> <span class="ow">in</span> <span class="n">responseJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">responseJSON</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]:</span>
</span><span id="L-2614"><a href="#-2614"><span class="linenos">2614</span></a>                            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Success time marker received from server: [</span><span class="si">{}</span><span class="s2">] (UTC)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">responseJSON</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]))</span>
</span><span id="L-2615"><a href="#-2615"><span class="linenos">2615</span></a>                            <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Stop order with ID [</span><span class="si">{}</span><span class="s2">] successfully cancel&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">orderID</span><span class="p">))</span>
</span><span id="L-2616"><a href="#-2616"><span class="linenos">2616</span></a>
</span><span id="L-2617"><a href="#-2617"><span class="linenos">2617</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2618"><a href="#-2618"><span class="linenos">2618</span></a>                            <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unknown issue occurred when cancelling stop order with ID: [</span><span class="si">{}</span><span class="s2">]. Check ID and try again.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">orderID</span><span class="p">))</span>
</span><span id="L-2619"><a href="#-2619"><span class="linenos">2619</span></a>
</span><span id="L-2620"><a href="#-2620"><span class="linenos">2620</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-2621"><a href="#-2621"><span class="linenos">2621</span></a>                        <span class="k">continue</span>
</span><span id="L-2622"><a href="#-2622"><span class="linenos">2622</span></a>
</span><span id="L-2623"><a href="#-2623"><span class="linenos">2623</span></a>    <span class="k">def</span> <span class="nf">CloseAllOrders</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2624"><a href="#-2624"><span class="linenos">2624</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2625"><a href="#-2625"><span class="linenos">2625</span></a><span class="sd">        Gets a list of open pending and stop orders and cancel it all.</span>
</span><span id="L-2626"><a href="#-2626"><span class="linenos">2626</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2627"><a href="#-2627"><span class="linenos">2627</span></a>        <span class="n">rawOrders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RequestPendingOrders</span><span class="p">()</span>
</span><span id="L-2628"><a href="#-2628"><span class="linenos">2628</span></a>        <span class="n">allOrdersIDs</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;orderId&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">rawOrders</span><span class="p">]</span>  <span class="c1"># all pending orders ID</span>
</span><span id="L-2629"><a href="#-2629"><span class="linenos">2629</span></a>        <span class="n">lenOrders</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">allOrdersIDs</span><span class="p">)</span>
</span><span id="L-2630"><a href="#-2630"><span class="linenos">2630</span></a>
</span><span id="L-2631"><a href="#-2631"><span class="linenos">2631</span></a>        <span class="n">rawStopOrders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RequestStopOrders</span><span class="p">()</span>
</span><span id="L-2632"><a href="#-2632"><span class="linenos">2632</span></a>        <span class="n">allStopOrdersIDs</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;stopOrderId&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">rawStopOrders</span><span class="p">]</span>  <span class="c1"># all stop orders ID</span>
</span><span id="L-2633"><a href="#-2633"><span class="linenos">2633</span></a>        <span class="n">lenSOrders</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">allStopOrdersIDs</span><span class="p">)</span>
</span><span id="L-2634"><a href="#-2634"><span class="linenos">2634</span></a>
</span><span id="L-2635"><a href="#-2635"><span class="linenos">2635</span></a>        <span class="k">if</span> <span class="n">lenOrders</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">lenSOrders</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-2636"><a href="#-2636"><span class="linenos">2636</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Found: [</span><span class="si">{}</span><span class="s2">] opened pending and [</span><span class="si">{}</span><span class="s2">] stop orders. Let&#39;s trying to cancel it all. Wait, please...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lenOrders</span><span class="p">,</span> <span class="n">lenSOrders</span><span class="p">))</span>
</span><span id="L-2637"><a href="#-2637"><span class="linenos">2637</span></a>
</span><span id="L-2638"><a href="#-2638"><span class="linenos">2638</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">CloseOrders</span><span class="p">(</span><span class="n">allOrdersIDs</span> <span class="o">+</span> <span class="n">allStopOrdersIDs</span><span class="p">,</span> <span class="n">allOrdersIDs</span><span class="p">,</span> <span class="n">allStopOrdersIDs</span><span class="p">)</span>
</span><span id="L-2639"><a href="#-2639"><span class="linenos">2639</span></a>
</span><span id="L-2640"><a href="#-2640"><span class="linenos">2640</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2641"><a href="#-2641"><span class="linenos">2641</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Orders not found, nothing to cancel.&quot;</span><span class="p">)</span>
</span><span id="L-2642"><a href="#-2642"><span class="linenos">2642</span></a>
</span><span id="L-2643"><a href="#-2643"><span class="linenos">2643</span></a>    <span class="k">def</span> <span class="nf">CloseAll</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2644"><a href="#-2644"><span class="linenos">2644</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2645"><a href="#-2645"><span class="linenos">2645</span></a><span class="sd">        Close all available (not blocked) opened trades and orders.</span>
</span><span id="L-2646"><a href="#-2646"><span class="linenos">2646</span></a>
</span><span id="L-2647"><a href="#-2647"><span class="linenos">2647</span></a><span class="sd">        Also you can select one or more keywords case insensitive:</span>
</span><span id="L-2648"><a href="#-2648"><span class="linenos">2648</span></a><span class="sd">        `orders`, `shares`, `bonds`, `etfs` and `futures` from `TKS_INSTRUMENTS` enum to specify trades type.</span>
</span><span id="L-2649"><a href="#-2649"><span class="linenos">2649</span></a>
</span><span id="L-2650"><a href="#-2650"><span class="linenos">2650</span></a><span class="sd">        Currency positions you must closes manually using buy or sell operations, `CloseTrades()` or `CloseAllTrades()` methods.</span>
</span><span id="L-2651"><a href="#-2651"><span class="linenos">2651</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2652"><a href="#-2652"><span class="linenos">2652</span></a>        <span class="n">overview</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Overview</span><span class="p">(</span><span class="n">showStatistics</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># get all open trades info</span>
</span><span id="L-2653"><a href="#-2653"><span class="linenos">2653</span></a>
</span><span id="L-2654"><a href="#-2654"><span class="linenos">2654</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-2655"><a href="#-2655"><span class="linenos">2655</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Closing all available (not blocked) opened trades and orders. Currency positions you must closes manually using buy or sell operations! Wait, please...&quot;</span><span class="p">)</span>
</span><span id="L-2656"><a href="#-2656"><span class="linenos">2656</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">CloseAllOrders</span><span class="p">()</span>  <span class="c1"># close all pending and stop orders</span>
</span><span id="L-2657"><a href="#-2657"><span class="linenos">2657</span></a>
</span><span id="L-2658"><a href="#-2658"><span class="linenos">2658</span></a>            <span class="k">for</span> <span class="n">iType</span> <span class="ow">in</span> <span class="n">TKS_INSTRUMENTS</span><span class="p">:</span>
</span><span id="L-2659"><a href="#-2659"><span class="linenos">2659</span></a>                <span class="k">if</span> <span class="n">iType</span> <span class="o">!=</span> <span class="s2">&quot;Currencies&quot;</span><span class="p">:</span>
</span><span id="L-2660"><a href="#-2660"><span class="linenos">2660</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">CloseAllTrades</span><span class="p">(</span><span class="n">iType</span><span class="p">,</span> <span class="n">overview</span><span class="p">)</span>  <span class="c1"># close all positions of instruments with same type without currencies</span>
</span><span id="L-2661"><a href="#-2661"><span class="linenos">2661</span></a>
</span><span id="L-2662"><a href="#-2662"><span class="linenos">2662</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2663"><a href="#-2663"><span class="linenos">2663</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Closing all available </span><span class="si">{}</span><span class="s2">. Currency positions you must closes manually using buy or sell operations! Wait, please...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)))</span>
</span><span id="L-2664"><a href="#-2664"><span class="linenos">2664</span></a>            <span class="n">lowerArgs</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>
</span><span id="L-2665"><a href="#-2665"><span class="linenos">2665</span></a>
</span><span id="L-2666"><a href="#-2666"><span class="linenos">2666</span></a>            <span class="k">if</span> <span class="s2">&quot;orders&quot;</span> <span class="ow">in</span> <span class="n">lowerArgs</span><span class="p">:</span>
</span><span id="L-2667"><a href="#-2667"><span class="linenos">2667</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">CloseAllOrders</span><span class="p">()</span>  <span class="c1"># close all pending and stop orders</span>
</span><span id="L-2668"><a href="#-2668"><span class="linenos">2668</span></a>
</span><span id="L-2669"><a href="#-2669"><span class="linenos">2669</span></a>            <span class="k">for</span> <span class="n">iType</span> <span class="ow">in</span> <span class="n">TKS_INSTRUMENTS</span><span class="p">:</span>
</span><span id="L-2670"><a href="#-2670"><span class="linenos">2670</span></a>                <span class="k">if</span> <span class="n">iType</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">lowerArgs</span> <span class="ow">and</span> <span class="n">iType</span> <span class="o">!=</span> <span class="s2">&quot;Currencies&quot;</span><span class="p">:</span>
</span><span id="L-2671"><a href="#-2671"><span class="linenos">2671</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">CloseAllTrades</span><span class="p">(</span><span class="n">iType</span><span class="p">,</span> <span class="n">overview</span><span class="p">)</span>  <span class="c1"># close all positions of instruments with same type without currencies</span>
</span><span id="L-2672"><a href="#-2672"><span class="linenos">2672</span></a>
</span><span id="L-2673"><a href="#-2673"><span class="linenos">2673</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-2674"><a href="#-2674"><span class="linenos">2674</span></a>    <span class="k">def</span> <span class="nf">ParseOrderParameters</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="o">**</span><span class="n">inputParameters</span><span class="p">):</span>
</span><span id="L-2675"><a href="#-2675"><span class="linenos">2675</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2676"><a href="#-2676"><span class="linenos">2676</span></a><span class="sd">        Parse input dictionary of strings with order parameters and return dictionary with parameters to open all orders.</span>
</span><span id="L-2677"><a href="#-2677"><span class="linenos">2677</span></a>
</span><span id="L-2678"><a href="#-2678"><span class="linenos">2678</span></a><span class="sd">        :param operation: string &quot;Buy&quot; or &quot;Sell&quot;.</span>
</span><span id="L-2679"><a href="#-2679"><span class="linenos">2679</span></a><span class="sd">        :param inputParameters: this is dict of strings that looks like this</span>
</span><span id="L-2680"><a href="#-2680"><span class="linenos">2680</span></a><span class="sd">               `{&quot;lots&quot;: &quot;L_int,...&quot;, &quot;prices&quot;: &quot;P_float,...&quot;}` where</span>
</span><span id="L-2681"><a href="#-2681"><span class="linenos">2681</span></a><span class="sd">               &quot;lots&quot; key: one or more lot values (integer numbers) to open with every limit-order</span>
</span><span id="L-2682"><a href="#-2682"><span class="linenos">2682</span></a><span class="sd">               &quot;prices&quot; key: one or more prices to open limit-orders</span>
</span><span id="L-2683"><a href="#-2683"><span class="linenos">2683</span></a><span class="sd">               Counts of values in lots and prices lists must be equals!</span>
</span><span id="L-2684"><a href="#-2684"><span class="linenos">2684</span></a><span class="sd">        :return: list of dictionaries with all lots and prices to open orders that looks like this `[{&quot;lot&quot;: lots_1, &quot;price&quot;: price_1}, {...}, ...]`</span>
</span><span id="L-2685"><a href="#-2685"><span class="linenos">2685</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2686"><a href="#-2686"><span class="linenos">2686</span></a>        <span class="c1"># TODO: update order grid work with api v2</span>
</span><span id="L-2687"><a href="#-2687"><span class="linenos">2687</span></a>        <span class="k">pass</span>
</span><span id="L-2688"><a href="#-2688"><span class="linenos">2688</span></a>        <span class="c1"># uLogger.debug(&quot;Input parameters: {}&quot;.format(inputParameters))</span>
</span><span id="L-2689"><a href="#-2689"><span class="linenos">2689</span></a>        <span class="c1">#</span>
</span><span id="L-2690"><a href="#-2690"><span class="linenos">2690</span></a>        <span class="c1"># if operation is None or not operation or operation not in (&quot;Buy&quot;, &quot;Sell&quot;):</span>
</span><span id="L-2691"><a href="#-2691"><span class="linenos">2691</span></a>        <span class="c1">#     raise Exception(&quot;You must define operation type: &#39;Buy&#39; or &#39;Sell&#39;!&quot;)</span>
</span><span id="L-2692"><a href="#-2692"><span class="linenos">2692</span></a>        <span class="c1">#</span>
</span><span id="L-2693"><a href="#-2693"><span class="linenos">2693</span></a>        <span class="c1"># if &quot;l&quot; in inputParameters.keys():</span>
</span><span id="L-2694"><a href="#-2694"><span class="linenos">2694</span></a>        <span class="c1">#     inputParameters[&quot;lots&quot;] = inputParameters.pop(&quot;l&quot;)</span>
</span><span id="L-2695"><a href="#-2695"><span class="linenos">2695</span></a>        <span class="c1">#</span>
</span><span id="L-2696"><a href="#-2696"><span class="linenos">2696</span></a>        <span class="c1"># if &quot;p&quot; in inputParameters.keys():</span>
</span><span id="L-2697"><a href="#-2697"><span class="linenos">2697</span></a>        <span class="c1">#     inputParameters[&quot;prices&quot;] = inputParameters.pop(&quot;p&quot;)</span>
</span><span id="L-2698"><a href="#-2698"><span class="linenos">2698</span></a>        <span class="c1">#</span>
</span><span id="L-2699"><a href="#-2699"><span class="linenos">2699</span></a>        <span class="c1"># if &quot;lots&quot; not in inputParameters.keys() or &quot;prices&quot; not in inputParameters.keys():</span>
</span><span id="L-2700"><a href="#-2700"><span class="linenos">2700</span></a>        <span class="c1">#     raise Exception(&quot;Both of &#39;lots&#39; and &#39;prices&#39; keys must be define to open grid orders!&quot;)</span>
</span><span id="L-2701"><a href="#-2701"><span class="linenos">2701</span></a>        <span class="c1">#</span>
</span><span id="L-2702"><a href="#-2702"><span class="linenos">2702</span></a>        <span class="c1"># lots = [int(item.strip()) for item in inputParameters[&quot;lots&quot;].split(&quot;,&quot;)]</span>
</span><span id="L-2703"><a href="#-2703"><span class="linenos">2703</span></a>        <span class="c1"># prices = [float(item.strip()) for item in inputParameters[&quot;prices&quot;].split(&quot;,&quot;)]</span>
</span><span id="L-2704"><a href="#-2704"><span class="linenos">2704</span></a>        <span class="c1">#</span>
</span><span id="L-2705"><a href="#-2705"><span class="linenos">2705</span></a>        <span class="c1"># if len(lots) != len(prices):</span>
</span><span id="L-2706"><a href="#-2706"><span class="linenos">2706</span></a>        <span class="c1">#     raise Exception(&quot;&#39;lots&#39; and &#39;prices&#39; lists must have equal length of values!&quot;)</span>
</span><span id="L-2707"><a href="#-2707"><span class="linenos">2707</span></a>        <span class="c1">#</span>
</span><span id="L-2708"><a href="#-2708"><span class="linenos">2708</span></a>        <span class="c1"># uLogger.debug(&quot;Extracted parameters for orders:&quot;)</span>
</span><span id="L-2709"><a href="#-2709"><span class="linenos">2709</span></a>        <span class="c1"># uLogger.debug(&quot;lots = {}&quot;.format(lots))</span>
</span><span id="L-2710"><a href="#-2710"><span class="linenos">2710</span></a>        <span class="c1"># uLogger.debug(&quot;prices = {}&quot;.format(prices))</span>
</span><span id="L-2711"><a href="#-2711"><span class="linenos">2711</span></a>        <span class="c1">#</span>
</span><span id="L-2712"><a href="#-2712"><span class="linenos">2712</span></a>        <span class="c1"># # list of dictionaries with order&#39;s parameters: [{&quot;lot&quot;: lots_1, &quot;price&quot;: price_1}, {...}, ...]</span>
</span><span id="L-2713"><a href="#-2713"><span class="linenos">2713</span></a>        <span class="c1"># result = [{&quot;lot&quot;: lots[item], &quot;price&quot;: prices[item]} for item in range(len(prices))]</span>
</span><span id="L-2714"><a href="#-2714"><span class="linenos">2714</span></a>        <span class="c1"># uLogger.debug(&quot;Order parameters: {}&quot;.format(result))</span>
</span><span id="L-2715"><a href="#-2715"><span class="linenos">2715</span></a>        <span class="c1">#</span>
</span><span id="L-2716"><a href="#-2716"><span class="linenos">2716</span></a>        <span class="c1"># return result</span>
</span><span id="L-2717"><a href="#-2717"><span class="linenos">2717</span></a>
</span><span id="L-2718"><a href="#-2718"><span class="linenos">2718</span></a>
</span><span id="L-2719"><a href="#-2719"><span class="linenos">2719</span></a><span class="k">class</span> <span class="nc">Args</span><span class="p">:</span>
</span><span id="L-2720"><a href="#-2720"><span class="linenos">2720</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2721"><a href="#-2721"><span class="linenos">2721</span></a><span class="sd">    If `Main()` function is imported as module, then this class used to convert arguments from **kwargs as object.</span>
</span><span id="L-2722"><a href="#-2722"><span class="linenos">2722</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-2723"><a href="#-2723"><span class="linenos">2723</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-2724"><a href="#-2724"><span class="linenos">2724</span></a>        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-2725"><a href="#-2725"><span class="linenos">2725</span></a>
</span><span id="L-2726"><a href="#-2726"><span class="linenos">2726</span></a>    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
</span><span id="L-2727"><a href="#-2727"><span class="linenos">2727</span></a>        <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-2728"><a href="#-2728"><span class="linenos">2728</span></a>
</span><span id="L-2729"><a href="#-2729"><span class="linenos">2729</span></a>
</span><span id="L-2730"><a href="#-2730"><span class="linenos">2730</span></a><span class="k">def</span> <span class="nf">ParseArgs</span><span class="p">():</span>
</span><span id="L-2731"><a href="#-2731"><span class="linenos">2731</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2732"><a href="#-2732"><span class="linenos">2732</span></a><span class="sd">    Function get and parse command line keys. See examples: https://tim55667757.github.io/TKSBrokerAPI/</span>
</span><span id="L-2733"><a href="#-2733"><span class="linenos">2733</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-2734"><a href="#-2734"><span class="linenos">2734</span></a>    <span class="n">parser</span> <span class="o">=</span> <span class="n">ArgumentParser</span><span class="p">()</span>  <span class="c1"># command-line string parser</span>
</span><span id="L-2735"><a href="#-2735"><span class="linenos">2735</span></a>
</span><span id="L-2736"><a href="#-2736"><span class="linenos">2736</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;TKSBrokerAPI is a python API to work with some methods of Tinkoff Open API using REST protocol. It can view history, orders and market information. Also, you can open orders and trades. See examples: https://tim55667757.github.io/TKSBrokerAPI/#Usage-examples&quot;</span>
</span><span id="L-2737"><a href="#-2737"><span class="linenos">2737</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">usage</span> <span class="o">=</span> <span class="s2">&quot;python TKSBrokerAPI.py [some options] [one command]&quot;</span>
</span><span id="L-2738"><a href="#-2738"><span class="linenos">2738</span></a>
</span><span id="L-2739"><a href="#-2739"><span class="linenos">2739</span></a>    <span class="c1"># --- options:</span>
</span><span id="L-2740"><a href="#-2740"><span class="linenos">2740</span></a>
</span><span id="L-2741"><a href="#-2741"><span class="linenos">2741</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--token&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Option: Tinkoff service&#39;s api key. If not set then used environment variable `TKS_API_TOKEN`. See how to use: https://tinkoff.github.io/investAPI/token/&quot;</span><span class="p">)</span>
</span><span id="L-2742"><a href="#-2742"><span class="linenos">2742</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--account-id&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Option: string with an user numeric account ID in Tinkoff Broker. It can be found in any broker&#39;s reports (see the contract number). Also, this variable can be set from environment variable `TKS_ACCOUNT_ID`.&quot;</span><span class="p">)</span>
</span><span id="L-2743"><a href="#-2743"><span class="linenos">2743</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--ticker&quot;</span><span class="p">,</span> <span class="s2">&quot;-t&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Option: instrument&#39;s ticker, e.g. `IBM`, `YNDX`, `GOOGL` etc. Use alias for `USD000UTSTOM` simple as `USD`, `EUR_RUB__TOM` as `EUR`.&quot;</span><span class="p">)</span>
</span><span id="L-2744"><a href="#-2744"><span class="linenos">2744</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--figi&quot;</span><span class="p">,</span> <span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Option: instrument&#39;s FIGI, e.g. `BBG006L8G4H1` (for `YNDX`).&quot;</span><span class="p">)</span>
</span><span id="L-2745"><a href="#-2745"><span class="linenos">2745</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--depth&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Option: Depth of Market (DOM) can be &gt;=1, 1 by default.&quot;</span><span class="p">)</span>
</span><span id="L-2746"><a href="#-2746"><span class="linenos">2746</span></a>
</span><span id="L-2747"><a href="#-2747"><span class="linenos">2747</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--output&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Option: replace default paths to output files for some commands. If None then used default files.&quot;</span><span class="p">)</span>
</span><span id="L-2748"><a href="#-2748"><span class="linenos">2748</span></a>
</span><span id="L-2749"><a href="#-2749"><span class="linenos">2749</span></a>    <span class="c1"># parser.add_argument(&quot;--length&quot;, type=int, default=24, help=&quot;Option: how many last candles returns for history. Used only with --history key.&quot;)</span>
</span><span id="L-2750"><a href="#-2750"><span class="linenos">2750</span></a>    <span class="c1"># parser.add_argument(&quot;--interval&quot;, type=str, default=&quot;60&quot;, help=&quot;Option: available values are 1min, 2min, 3min, 5min, 10min, 15min, 30min, hour, day, week, month. Used only with --history key. This is time period used in &#39;interval&#39; api parameter. Default: --interval=60 that means 60 min for every history candles.&quot;)</span>
</span><span id="L-2751"><a href="#-2751"><span class="linenos">2751</span></a>    <span class="c1"># parser.add_argument(&quot;--only-missing&quot;, action=&quot;store_true&quot;, default=False, help=&quot;Option: if history file define by --output key then add only last missing candles, do not request all history length. False by default.&quot;)</span>
</span><span id="L-2752"><a href="#-2752"><span class="linenos">2752</span></a>
</span><span id="L-2753"><a href="#-2753"><span class="linenos">2753</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--debug-level&quot;</span><span class="p">,</span> <span class="s2">&quot;--verbosity&quot;</span><span class="p">,</span> <span class="s2">&quot;-v&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Option: showing STDOUT messages of minimal debug level, e.g. 10 = DEBUG, 20 = INFO, 30 = WARNING, 40 = ERROR, 50 = CRITICAL. INFO (20) by default.&quot;</span><span class="p">)</span>
</span><span id="L-2754"><a href="#-2754"><span class="linenos">2754</span></a>
</span><span id="L-2755"><a href="#-2755"><span class="linenos">2755</span></a>    <span class="c1"># --- commands:</span>
</span><span id="L-2756"><a href="#-2756"><span class="linenos">2756</span></a>
</span><span id="L-2757"><a href="#-2757"><span class="linenos">2757</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--list&quot;</span><span class="p">,</span> <span class="s2">&quot;-l&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Action: get and print all available instruments and some information from broker server. Also, you can define --output key to save list of instruments to file, default: instruments.md.&quot;</span><span class="p">)</span>
</span><span id="L-2758"><a href="#-2758"><span class="linenos">2758</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--info&quot;</span><span class="p">,</span> <span class="s2">&quot;-i&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Action: get information from broker server about instrument by it&#39;s ticker or FIGI. `--ticker` key or `--figi` key must be defined!&quot;</span><span class="p">)</span>
</span><span id="L-2759"><a href="#-2759"><span class="linenos">2759</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--price&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Action: show actual price list for current instrument. Also, you can use --depth key. `--ticker` key or `--figi` key must be defined!&quot;</span><span class="p">)</span>
</span><span id="L-2760"><a href="#-2760"><span class="linenos">2760</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--prices&quot;</span><span class="p">,</span> <span class="s2">&quot;-p&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Action: get and print current prices for list of given instruments (by it&#39;s tickers or by FIGIs. WARNING! This is too long operation if you request a lot of instruments! Also, you can define --output key to save list of prices to file, default: prices.md.&quot;</span><span class="p">)</span>
</span><span id="L-2761"><a href="#-2761"><span class="linenos">2761</span></a>
</span><span id="L-2762"><a href="#-2762"><span class="linenos">2762</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--overview&quot;</span><span class="p">,</span> <span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Action: show all open positions, orders and some statistics. Also, you can define --output key to save this information to file, default: overview.md.&quot;</span><span class="p">)</span>
</span><span id="L-2763"><a href="#-2763"><span class="linenos">2763</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--deals&quot;</span><span class="p">,</span> <span class="s2">&quot;-d&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Action: show all deals between two given dates. Start day may be an integer number: -1, -2, -3 days ago. Also, you can use keywords: `today`, `yesterday` (-1), `week` (-7), `month` (-30), `year` (-365). Dates format must be: `</span><span class="si">%%</span><span class="s2">Y-</span><span class="si">%%</span><span class="s2">m-</span><span class="si">%%</span><span class="s2">d`, e.g. 2020-02-03. Also, you can define `--output` key to save all deals to file, default: report.md.&quot;</span><span class="p">)</span>
</span><span id="L-2764"><a href="#-2764"><span class="linenos">2764</span></a>    <span class="c1"># parser.add_argument(&quot;--history&quot;, action=&quot;store_true&quot;, help=&quot;Action: get last (--length) history candles from past to current time with (--interval) values. Also, you can define --output key to save history candles to .csv-file.&quot;)</span>
</span><span id="L-2765"><a href="#-2765"><span class="linenos">2765</span></a>
</span><span id="L-2766"><a href="#-2766"><span class="linenos">2766</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--trade&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Action: universal action to open market position for defined ticker or FIGI. You must specify 1-5 parameters: [direction `Buy` or `Sell`] [lots, &gt;= 1] [take profit, &gt;= 0] [stop loss, &gt;= 0] [expiration date for TP/SL orders, Undefined|`</span><span class="si">%%</span><span class="s2">Y-</span><span class="si">%%</span><span class="s2">m-</span><span class="si">%%</span><span class="s2">d </span><span class="si">%%</span><span class="s2">H:</span><span class="si">%%</span><span class="s2">M:</span><span class="si">%%</span><span class="s2">S`]. See examples in readme.&quot;</span><span class="p">)</span>
</span><span id="L-2767"><a href="#-2767"><span class="linenos">2767</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--buy&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Action: immediately open BUY market position at the current price for defined ticker or FIGI. You must specify 0-4 parameters: [lots, &gt;= 1] [take profit, &gt;= 0] [stop loss, &gt;= 0] [expiration date for TP/SL orders, Undefined|`</span><span class="si">%%</span><span class="s2">Y-</span><span class="si">%%</span><span class="s2">m-</span><span class="si">%%</span><span class="s2">d </span><span class="si">%%</span><span class="s2">H:</span><span class="si">%%</span><span class="s2">M:</span><span class="si">%%</span><span class="s2">S`].&quot;</span><span class="p">)</span>
</span><span id="L-2768"><a href="#-2768"><span class="linenos">2768</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--sell&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Action: immediately open SELL market position at the current price for defined ticker or FIGI. You must specify 0-4 parameters: [lots, &gt;= 1] [take profit, &gt;= 0] [stop loss, &gt;= 0] [expiration date for TP/SL orders, Undefined|`</span><span class="si">%%</span><span class="s2">Y-</span><span class="si">%%</span><span class="s2">m-</span><span class="si">%%</span><span class="s2">d </span><span class="si">%%</span><span class="s2">H:</span><span class="si">%%</span><span class="s2">M:</span><span class="si">%%</span><span class="s2">S`].&quot;</span><span class="p">)</span>
</span><span id="L-2769"><a href="#-2769"><span class="linenos">2769</span></a>
</span><span id="L-2770"><a href="#-2770"><span class="linenos">2770</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--order&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Action: universal action to open limit or stop-order in any directions. You must specify 4-7 parameters: [direction `Buy` or `Sell`] [order type `Limit` or `Stop`] [lots] [target price] [maybe for stop-order: [limit price, &gt;= 0] [stop type, Limit|SL|TP] [expiration date, Undefined|`</span><span class="si">%%</span><span class="s2">Y-</span><span class="si">%%</span><span class="s2">m-</span><span class="si">%%</span><span class="s2">d </span><span class="si">%%</span><span class="s2">H:</span><span class="si">%%</span><span class="s2">M:</span><span class="si">%%</span><span class="s2">S`]]. See examples in readme.&quot;</span><span class="p">)</span>
</span><span id="L-2771"><a href="#-2771"><span class="linenos">2771</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--buy-limit&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Action: open pending BUY limit-order (below current price). You must specify only 2 parameters: [lots] [target price] to open BUY limit-order. If you try to create `Buy` limit-order above current price then broker immediately open `Buy` market order, such as if you do simple `--buy` operation!&quot;</span><span class="p">)</span>
</span><span id="L-2772"><a href="#-2772"><span class="linenos">2772</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--sell-limit&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Action: open pending SELL limit-order (above current price). You must specify only 2 parameters: [lots] [target price] to open SELL limit-order. If you try to create `Sell` limit-order below current price then broker immediately open `Sell` market order, such as if you do simple `--sell` operation!&quot;</span><span class="p">)</span>
</span><span id="L-2773"><a href="#-2773"><span class="linenos">2773</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--buy-stop&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Action: open BUY stop-order. You must specify at least 2 parameters: [lots] [target price] to open BUY stop-order. In additional you can specify 3 parameters for stop-order: [limit price, &gt;= 0] [stop type, Limit|SL|TP] [expiration date, Undefined|`</span><span class="si">%%</span><span class="s2">Y-</span><span class="si">%%</span><span class="s2">m-</span><span class="si">%%</span><span class="s2">d </span><span class="si">%%</span><span class="s2">H:</span><span class="si">%%</span><span class="s2">M:</span><span class="si">%%</span><span class="s2">S`]. When current price will go up or down to target price value then broker opens a limit order. Stop loss order always executed by market price.&quot;</span><span class="p">)</span>
</span><span id="L-2774"><a href="#-2774"><span class="linenos">2774</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--sell-stop&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Action: open SELL stop-order. You must specify at least 2 parameters: [lots] [target price] to open SELL stop-order. In additional you can specify 3 parameters for stop-order: [limit price, &gt;= 0] [stop type, Limit|SL|TP] [expiration date, Undefined|`</span><span class="si">%%</span><span class="s2">Y-</span><span class="si">%%</span><span class="s2">m-</span><span class="si">%%</span><span class="s2">d </span><span class="si">%%</span><span class="s2">H:</span><span class="si">%%</span><span class="s2">M:</span><span class="si">%%</span><span class="s2">S`]. When current price will go up or down to target price value then broker opens a limit order. Stop loss order always executed by market price.&quot;</span><span class="p">)</span>
</span><span id="L-2775"><a href="#-2775"><span class="linenos">2775</span></a>    <span class="c1"># parser.add_argument(&quot;--buy-limit-order-grid&quot;, type=str, nargs=&quot;*&quot;, help=&quot;Action: open grid of pending BUY limit-orders (below current price). Parameters format: l(ots)=[L_int,...] p(rices)=[P_float,...]. Counts of values in lots and prices lists must be equals!&quot;)</span>
</span><span id="L-2776"><a href="#-2776"><span class="linenos">2776</span></a>    <span class="c1"># parser.add_argument(&quot;--sell-limit-order-grid&quot;, type=str, nargs=&quot;*&quot;, help=&quot;Action: open grid of pending SELL limit-orders (above current price). Parameters format: l(ots)=[L_int,...] p(rices)=[P_float,...]. Counts of values in lots and prices lists must be equals!&quot;)</span>
</span><span id="L-2777"><a href="#-2777"><span class="linenos">2777</span></a>
</span><span id="L-2778"><a href="#-2778"><span class="linenos">2778</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--close-order&quot;</span><span class="p">,</span> <span class="s2">&quot;--cancel-order&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Action: close only one order by it&#39;s `orderId` or `stopOrderId`. You can find out the meaning of these IDs using the key `--overview`&quot;</span><span class="p">)</span>
</span><span id="L-2779"><a href="#-2779"><span class="linenos">2779</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--close-orders&quot;</span><span class="p">,</span> <span class="s2">&quot;--cancel-orders&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Action: close one or list of orders by it&#39;s `orderId` or `stopOrderId`. You can find out the meaning of these IDs using the key `--overview`&quot;</span><span class="p">)</span>
</span><span id="L-2780"><a href="#-2780"><span class="linenos">2780</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--close-trade&quot;</span><span class="p">,</span> <span class="s2">&quot;--cancel-trade&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Action: close only one position for instrument defined by `--ticker` key, including for currencies tickers.&quot;</span><span class="p">)</span>
</span><span id="L-2781"><a href="#-2781"><span class="linenos">2781</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--close-trades&quot;</span><span class="p">,</span> <span class="s2">&quot;--cancel-trades&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Action: close positions for list of tickers, including for currencies tickers.&quot;</span><span class="p">)</span>
</span><span id="L-2782"><a href="#-2782"><span class="linenos">2782</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--close-all&quot;</span><span class="p">,</span> <span class="s2">&quot;--cancel-all&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Action: close all available (not blocked) opened trades and orders, excluding for currencies. Also you can select one or more keywords case insensitive to specify trades type: `orders`, `shares`, `bonds`, `etfs` and `futures`, but not `currencies`. Currency positions you must closes manually using `--buy`, `--sell`, `--close-trade` or `--close-trades` operations.&quot;</span><span class="p">)</span>
</span><span id="L-2783"><a href="#-2783"><span class="linenos">2783</span></a>
</span><span id="L-2784"><a href="#-2784"><span class="linenos">2784</span></a>    <span class="n">cmdArgs</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</span><span id="L-2785"><a href="#-2785"><span class="linenos">2785</span></a>    <span class="k">return</span> <span class="n">cmdArgs</span>
</span><span id="L-2786"><a href="#-2786"><span class="linenos">2786</span></a>
</span><span id="L-2787"><a href="#-2787"><span class="linenos">2787</span></a>
</span><span id="L-2788"><a href="#-2788"><span class="linenos">2788</span></a><span class="k">def</span> <span class="nf">Main</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-2789"><a href="#-2789"><span class="linenos">2789</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2790"><a href="#-2790"><span class="linenos">2790</span></a><span class="sd">    Main function for work with Tinkoff Open API service. It realize simple logic: get a lot of options and execute one command.</span>
</span><span id="L-2791"><a href="#-2791"><span class="linenos">2791</span></a>
</span><span id="L-2792"><a href="#-2792"><span class="linenos">2792</span></a><span class="sd">    See examples: https://tim55667757.github.io/TKSBrokerAPI/</span>
</span><span id="L-2793"><a href="#-2793"><span class="linenos">2793</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-2794"><a href="#-2794"><span class="linenos">2794</span></a>    <span class="n">args</span> <span class="o">=</span> <span class="n">Args</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">if</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="n">ParseArgs</span><span class="p">()</span>  <span class="c1"># get and parse command-line parameters or use **kwarg parameters</span>
</span><span id="L-2795"><a href="#-2795"><span class="linenos">2795</span></a>
</span><span id="L-2796"><a href="#-2796"><span class="linenos">2796</span></a>    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">debug_level</span><span class="p">:</span>
</span><span id="L-2797"><a href="#-2797"><span class="linenos">2797</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># always debug level by default</span>
</span><span id="L-2798"><a href="#-2798"><span class="linenos">2798</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">handlers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">debug_level</span>  <span class="c1"># level for STDOUT</span>
</span><span id="L-2799"><a href="#-2799"><span class="linenos">2799</span></a>
</span><span id="L-2800"><a href="#-2800"><span class="linenos">2800</span></a>    <span class="n">exitCode</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-2801"><a href="#-2801"><span class="linenos">2801</span></a>    <span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tzutc</span><span class="p">())</span>
</span><span id="L-2802"><a href="#-2802"><span class="linenos">2802</span></a>    <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TKSBrokerAPI module started at: [</span><span class="si">{}</span><span class="s2">] (UTC), it is [</span><span class="si">{}</span><span class="s2">] local time&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-2803"><a href="#-2803"><span class="linenos">2803</span></a>        <span class="n">start</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">),</span>
</span><span id="L-2804"><a href="#-2804"><span class="linenos">2804</span></a>        <span class="n">start</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">tzlocal</span><span class="p">())</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">),</span>
</span><span id="L-2805"><a href="#-2805"><span class="linenos">2805</span></a>    <span class="p">))</span>
</span><span id="L-2806"><a href="#-2806"><span class="linenos">2806</span></a>
</span><span id="L-2807"><a href="#-2807"><span class="linenos">2807</span></a>    <span class="n">instruments</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;instruments&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="kc">None</span>  <span class="c1"># try to decrease requests to server count if class init many times</span>
</span><span id="L-2808"><a href="#-2808"><span class="linenos">2808</span></a>    <span class="n">server</span> <span class="o">=</span> <span class="n">TinkoffBrokerServer</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="n">iList</span><span class="o">=</span><span class="n">instruments</span><span class="p">)</span>  <span class="c1"># Init class for trading with Tinkoff Broker</span>
</span><span id="L-2809"><a href="#-2809"><span class="linenos">2809</span></a>
</span><span id="L-2810"><a href="#-2810"><span class="linenos">2810</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-2811"><a href="#-2811"><span class="linenos">2811</span></a>        <span class="c1"># --- set some options:</span>
</span><span id="L-2812"><a href="#-2812"><span class="linenos">2812</span></a>
</span><span id="L-2813"><a href="#-2813"><span class="linenos">2813</span></a>        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">account_id</span><span class="p">:</span>
</span><span id="L-2814"><a href="#-2814"><span class="linenos">2814</span></a>            <span class="n">server</span><span class="o">.</span><span class="n">accountId</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">account_id</span>
</span><span id="L-2815"><a href="#-2815"><span class="linenos">2815</span></a>
</span><span id="L-2816"><a href="#-2816"><span class="linenos">2816</span></a>        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">ticker</span><span class="p">:</span>
</span><span id="L-2817"><a href="#-2817"><span class="linenos">2817</span></a>            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">ticker</span> <span class="ow">in</span> <span class="n">server</span><span class="o">.</span><span class="n">aliasesKeys</span><span class="p">:</span>
</span><span id="L-2818"><a href="#-2818"><span class="linenos">2818</span></a>                <span class="n">server</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">aliases</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">ticker</span><span class="p">]</span>  <span class="c1"># Replace some tickers with it&#39;s aliases</span>
</span><span id="L-2819"><a href="#-2819"><span class="linenos">2819</span></a>
</span><span id="L-2820"><a href="#-2820"><span class="linenos">2820</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-2821"><a href="#-2821"><span class="linenos">2821</span></a>                <span class="n">server</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">ticker</span>
</span><span id="L-2822"><a href="#-2822"><span class="linenos">2822</span></a>
</span><span id="L-2823"><a href="#-2823"><span class="linenos">2823</span></a>        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">figi</span><span class="p">:</span>
</span><span id="L-2824"><a href="#-2824"><span class="linenos">2824</span></a>            <span class="n">server</span><span class="o">.</span><span class="n">figi</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">figi</span>
</span><span id="L-2825"><a href="#-2825"><span class="linenos">2825</span></a>
</span><span id="L-2826"><a href="#-2826"><span class="linenos">2826</span></a>        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">depth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2827"><a href="#-2827"><span class="linenos">2827</span></a>            <span class="n">server</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">depth</span>
</span><span id="L-2828"><a href="#-2828"><span class="linenos">2828</span></a>
</span><span id="L-2829"><a href="#-2829"><span class="linenos">2829</span></a>        <span class="c1"># if args.length is not None:</span>
</span><span id="L-2830"><a href="#-2830"><span class="linenos">2830</span></a>        <span class="c1">#     server.historyLength = args.length</span>
</span><span id="L-2831"><a href="#-2831"><span class="linenos">2831</span></a>        <span class="c1">#</span>
</span><span id="L-2832"><a href="#-2832"><span class="linenos">2832</span></a>        <span class="c1"># if args.interval is not None:</span>
</span><span id="L-2833"><a href="#-2833"><span class="linenos">2833</span></a>        <span class="c1">#     server.historyInterval = args.interval</span>
</span><span id="L-2834"><a href="#-2834"><span class="linenos">2834</span></a>
</span><span id="L-2835"><a href="#-2835"><span class="linenos">2835</span></a>        <span class="c1"># --- do one of commands:</span>
</span><span id="L-2836"><a href="#-2836"><span class="linenos">2836</span></a>
</span><span id="L-2837"><a href="#-2837"><span class="linenos">2837</span></a>        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">info</span><span class="p">:</span>
</span><span id="L-2838"><a href="#-2838"><span class="linenos">2838</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">ticker</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">figi</span><span class="p">):</span>
</span><span id="L-2839"><a href="#-2839"><span class="linenos">2839</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;`--ticker` key or `--figi` key is required for this operation!&quot;</span><span class="p">)</span>
</span><span id="L-2840"><a href="#-2840"><span class="linenos">2840</span></a>
</span><span id="L-2841"><a href="#-2841"><span class="linenos">2841</span></a>            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">ticker</span><span class="p">:</span>
</span><span id="L-2842"><a href="#-2842"><span class="linenos">2842</span></a>                <span class="n">server</span><span class="o">.</span><span class="n">SearchByTicker</span><span class="p">(</span><span class="n">requestPrice</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">showInfo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># show info and current prices by ticker name</span>
</span><span id="L-2843"><a href="#-2843"><span class="linenos">2843</span></a>
</span><span id="L-2844"><a href="#-2844"><span class="linenos">2844</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-2845"><a href="#-2845"><span class="linenos">2845</span></a>                <span class="n">server</span><span class="o">.</span><span class="n">SearchByFIGI</span><span class="p">(</span><span class="n">requestPrice</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">showInfo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># show info and current prices by FIGI id</span>
</span><span id="L-2846"><a href="#-2846"><span class="linenos">2846</span></a>
</span><span id="L-2847"><a href="#-2847"><span class="linenos">2847</span></a>        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">list</span><span class="p">:</span>
</span><span id="L-2848"><a href="#-2848"><span class="linenos">2848</span></a>            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2849"><a href="#-2849"><span class="linenos">2849</span></a>                <span class="n">server</span><span class="o">.</span><span class="n">instrumentsFile</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">output</span>
</span><span id="L-2850"><a href="#-2850"><span class="linenos">2850</span></a>
</span><span id="L-2851"><a href="#-2851"><span class="linenos">2851</span></a>            <span class="n">server</span><span class="o">.</span><span class="n">ShowInstrumentsInfo</span><span class="p">(</span><span class="n">showInstruments</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2852"><a href="#-2852"><span class="linenos">2852</span></a>
</span><span id="L-2853"><a href="#-2853"><span class="linenos">2853</span></a>        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">price</span><span class="p">:</span>
</span><span id="L-2854"><a href="#-2854"><span class="linenos">2854</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">ticker</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">figi</span><span class="p">):</span>
</span><span id="L-2855"><a href="#-2855"><span class="linenos">2855</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;`--ticker` key or `--figi` key is required for this operation!&quot;</span><span class="p">)</span>
</span><span id="L-2856"><a href="#-2856"><span class="linenos">2856</span></a>
</span><span id="L-2857"><a href="#-2857"><span class="linenos">2857</span></a>            <span class="n">server</span><span class="o">.</span><span class="n">GetCurrentPrices</span><span class="p">(</span><span class="n">showPrice</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2858"><a href="#-2858"><span class="linenos">2858</span></a>
</span><span id="L-2859"><a href="#-2859"><span class="linenos">2859</span></a>        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">prices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2860"><a href="#-2860"><span class="linenos">2860</span></a>            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2861"><a href="#-2861"><span class="linenos">2861</span></a>                <span class="n">server</span><span class="o">.</span><span class="n">pricesFile</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">output</span>
</span><span id="L-2862"><a href="#-2862"><span class="linenos">2862</span></a>
</span><span id="L-2863"><a href="#-2863"><span class="linenos">2863</span></a>            <span class="n">server</span><span class="o">.</span><span class="n">GetListOfPrices</span><span class="p">(</span><span class="n">instruments</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">prices</span><span class="p">,</span> <span class="n">showPrices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># WARNING: too long wait for a lot of instruments prices</span>
</span><span id="L-2864"><a href="#-2864"><span class="linenos">2864</span></a>
</span><span id="L-2865"><a href="#-2865"><span class="linenos">2865</span></a>        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">overview</span><span class="p">:</span>
</span><span id="L-2866"><a href="#-2866"><span class="linenos">2866</span></a>            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2867"><a href="#-2867"><span class="linenos">2867</span></a>                <span class="n">server</span><span class="o">.</span><span class="n">overviewFile</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">output</span>
</span><span id="L-2868"><a href="#-2868"><span class="linenos">2868</span></a>
</span><span id="L-2869"><a href="#-2869"><span class="linenos">2869</span></a>            <span class="n">server</span><span class="o">.</span><span class="n">Overview</span><span class="p">(</span><span class="n">showStatistics</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2870"><a href="#-2870"><span class="linenos">2870</span></a>
</span><span id="L-2871"><a href="#-2871"><span class="linenos">2871</span></a>        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">deals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2872"><a href="#-2872"><span class="linenos">2872</span></a>            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2873"><a href="#-2873"><span class="linenos">2873</span></a>                <span class="n">server</span><span class="o">.</span><span class="n">reportFile</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">output</span>
</span><span id="L-2874"><a href="#-2874"><span class="linenos">2874</span></a>
</span><span id="L-2875"><a href="#-2875"><span class="linenos">2875</span></a>            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">deals</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="L-2876"><a href="#-2876"><span class="linenos">2876</span></a>                <span class="n">server</span><span class="o">.</span><span class="n">Deals</span><span class="p">(</span>
</span><span id="L-2877"><a href="#-2877"><span class="linenos">2877</span></a>                    <span class="n">start</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">deals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">deals</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-2878"><a href="#-2878"><span class="linenos">2878</span></a>                    <span class="n">end</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">deals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">deals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-2879"><a href="#-2879"><span class="linenos">2879</span></a>                    <span class="n">printDeals</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-2880"><a href="#-2880"><span class="linenos">2880</span></a>                <span class="p">)</span>
</span><span id="L-2881"><a href="#-2881"><span class="linenos">2881</span></a>
</span><span id="L-2882"><a href="#-2882"><span class="linenos">2882</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-2883"><a href="#-2883"><span class="linenos">2883</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;You must specify 0-2 parameters: [DATE_START] [DATE_END]&quot;</span><span class="p">)</span>
</span><span id="L-2884"><a href="#-2884"><span class="linenos">2884</span></a>
</span><span id="L-2885"><a href="#-2885"><span class="linenos">2885</span></a>        <span class="c1"># TODO: implement history download and view</span>
</span><span id="L-2886"><a href="#-2886"><span class="linenos">2886</span></a>        <span class="c1"># elif args.history:</span>
</span><span id="L-2887"><a href="#-2887"><span class="linenos">2887</span></a>        <span class="c1">#     if args.output is not None:</span>
</span><span id="L-2888"><a href="#-2888"><span class="linenos">2888</span></a>        <span class="c1">#         server.historyFile = args.output</span>
</span><span id="L-2889"><a href="#-2889"><span class="linenos">2889</span></a>        <span class="c1">#</span>
</span><span id="L-2890"><a href="#-2890"><span class="linenos">2890</span></a>        <span class="c1">#     server.History(onlyMissing=args.only_missing)</span>
</span><span id="L-2891"><a href="#-2891"><span class="linenos">2891</span></a>
</span><span id="L-2892"><a href="#-2892"><span class="linenos">2892</span></a>        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">trade</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2893"><a href="#-2893"><span class="linenos">2893</span></a>            <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">trade</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="L-2894"><a href="#-2894"><span class="linenos">2894</span></a>                <span class="n">server</span><span class="o">.</span><span class="n">Trade</span><span class="p">(</span>
</span><span id="L-2895"><a href="#-2895"><span class="linenos">2895</span></a>                    <span class="n">operation</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">trade</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="L-2896"><a href="#-2896"><span class="linenos">2896</span></a>                    <span class="n">lots</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">trade</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">trade</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-2897"><a href="#-2897"><span class="linenos">2897</span></a>                    <span class="n">tp</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">trade</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">trade</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="k">else</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="L-2898"><a href="#-2898"><span class="linenos">2898</span></a>                    <span class="n">sl</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">trade</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">trade</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="k">else</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="L-2899"><a href="#-2899"><span class="linenos">2899</span></a>                    <span class="n">expDate</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">trade</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">trade</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span> <span class="k">else</span> <span class="s2">&quot;Undefined&quot;</span><span class="p">,</span>
</span><span id="L-2900"><a href="#-2900"><span class="linenos">2900</span></a>                <span class="p">)</span>
</span><span id="L-2901"><a href="#-2901"><span class="linenos">2901</span></a>
</span><span id="L-2902"><a href="#-2902"><span class="linenos">2902</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-2903"><a href="#-2903"><span class="linenos">2903</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;You must specify 1-5 parameters to open trade: [direction `Buy` or `Sell`] [lots, &gt;= 1] [take profit, &gt;= 0] [stop loss, &gt;= 0] [expiration date for TP/SL orders, Undefined|`%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S`]. See: `python TKSBrokerAPI.py --help`&quot;</span><span class="p">)</span>
</span><span id="L-2904"><a href="#-2904"><span class="linenos">2904</span></a>
</span><span id="L-2905"><a href="#-2905"><span class="linenos">2905</span></a>        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">buy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2906"><a href="#-2906"><span class="linenos">2906</span></a>            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">buy</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="L-2907"><a href="#-2907"><span class="linenos">2907</span></a>                <span class="n">server</span><span class="o">.</span><span class="n">Buy</span><span class="p">(</span>
</span><span id="L-2908"><a href="#-2908"><span class="linenos">2908</span></a>                    <span class="n">lots</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">buy</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">buy</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-2909"><a href="#-2909"><span class="linenos">2909</span></a>                    <span class="n">tp</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">buy</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">buy</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="k">else</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="L-2910"><a href="#-2910"><span class="linenos">2910</span></a>                    <span class="n">sl</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">buy</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">buy</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="k">else</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="L-2911"><a href="#-2911"><span class="linenos">2911</span></a>                    <span class="n">expDate</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">buy</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">buy</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span> <span class="k">else</span> <span class="s2">&quot;Undefined&quot;</span><span class="p">,</span>
</span><span id="L-2912"><a href="#-2912"><span class="linenos">2912</span></a>                <span class="p">)</span>
</span><span id="L-2913"><a href="#-2913"><span class="linenos">2913</span></a>
</span><span id="L-2914"><a href="#-2914"><span class="linenos">2914</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-2915"><a href="#-2915"><span class="linenos">2915</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;You must specify 0-4 parameters to open buy position: [lots, &gt;= 1] [take profit, &gt;= 0] [stop loss, &gt;= 0] [expiration date for TP/SL orders, Undefined|`%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S`]. See: `python TKSBrokerAPI.py --help`&quot;</span><span class="p">)</span>
</span><span id="L-2916"><a href="#-2916"><span class="linenos">2916</span></a>
</span><span id="L-2917"><a href="#-2917"><span class="linenos">2917</span></a>        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">sell</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2918"><a href="#-2918"><span class="linenos">2918</span></a>            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sell</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="L-2919"><a href="#-2919"><span class="linenos">2919</span></a>                <span class="n">server</span><span class="o">.</span><span class="n">Sell</span><span class="p">(</span>
</span><span id="L-2920"><a href="#-2920"><span class="linenos">2920</span></a>                    <span class="n">lots</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sell</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sell</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-2921"><a href="#-2921"><span class="linenos">2921</span></a>                    <span class="n">tp</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sell</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sell</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="k">else</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="L-2922"><a href="#-2922"><span class="linenos">2922</span></a>                    <span class="n">sl</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sell</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sell</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="k">else</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="L-2923"><a href="#-2923"><span class="linenos">2923</span></a>                    <span class="n">expDate</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">sell</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sell</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span> <span class="k">else</span> <span class="s2">&quot;Undefined&quot;</span><span class="p">,</span>
</span><span id="L-2924"><a href="#-2924"><span class="linenos">2924</span></a>                <span class="p">)</span>
</span><span id="L-2925"><a href="#-2925"><span class="linenos">2925</span></a>
</span><span id="L-2926"><a href="#-2926"><span class="linenos">2926</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-2927"><a href="#-2927"><span class="linenos">2927</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;You must specify 0-4 parameters to open sell position: [lots, &gt;= 1] [take profit, &gt;= 0] [stop loss, &gt;= 0] [expiration date for TP/SL orders, Undefined|`%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S`]. See: `python TKSBrokerAPI.py --help`&quot;</span><span class="p">)</span>
</span><span id="L-2928"><a href="#-2928"><span class="linenos">2928</span></a>
</span><span id="L-2929"><a href="#-2929"><span class="linenos">2929</span></a>        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">order</span><span class="p">:</span>
</span><span id="L-2930"><a href="#-2930"><span class="linenos">2930</span></a>            <span class="k">if</span> <span class="mi">4</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">order</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">:</span>
</span><span id="L-2931"><a href="#-2931"><span class="linenos">2931</span></a>                <span class="n">server</span><span class="o">.</span><span class="n">Order</span><span class="p">(</span>
</span><span id="L-2932"><a href="#-2932"><span class="linenos">2932</span></a>                    <span class="n">operation</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">order</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="L-2933"><a href="#-2933"><span class="linenos">2933</span></a>                    <span class="n">orderType</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">order</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="L-2934"><a href="#-2934"><span class="linenos">2934</span></a>                    <span class="n">lots</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">order</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
</span><span id="L-2935"><a href="#-2935"><span class="linenos">2935</span></a>                    <span class="n">targetPrice</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">order</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
</span><span id="L-2936"><a href="#-2936"><span class="linenos">2936</span></a>                    <span class="n">limitPrice</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">order</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">order</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">5</span> <span class="k">else</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="L-2937"><a href="#-2937"><span class="linenos">2937</span></a>                    <span class="n">stopType</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">order</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">order</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">6</span> <span class="k">else</span> <span class="s2">&quot;Limit&quot;</span><span class="p">,</span>
</span><span id="L-2938"><a href="#-2938"><span class="linenos">2938</span></a>                    <span class="n">expDate</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">order</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">order</span><span class="p">)</span> <span class="o">==</span> <span class="mi">7</span> <span class="k">else</span> <span class="s2">&quot;Undefined&quot;</span><span class="p">,</span>
</span><span id="L-2939"><a href="#-2939"><span class="linenos">2939</span></a>                <span class="p">)</span>
</span><span id="L-2940"><a href="#-2940"><span class="linenos">2940</span></a>
</span><span id="L-2941"><a href="#-2941"><span class="linenos">2941</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-2942"><a href="#-2942"><span class="linenos">2942</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;You must specify 4-7 parameters to open order: [direction `Buy` or `Sell`] [order type `Limit` or `Stop`] [lots] [target price] [maybe for stop-order: [limit price, &gt;= 0] [stop type, Limit|SL|TP] [expiration date, Undefined|`%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S`]]. See: `python TKSBrokerAPI.py --help`&quot;</span><span class="p">)</span>
</span><span id="L-2943"><a href="#-2943"><span class="linenos">2943</span></a>
</span><span id="L-2944"><a href="#-2944"><span class="linenos">2944</span></a>        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">buy_limit</span><span class="p">:</span>
</span><span id="L-2945"><a href="#-2945"><span class="linenos">2945</span></a>            <span class="n">server</span><span class="o">.</span><span class="n">BuyLimit</span><span class="p">(</span><span class="n">lots</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">buy_limit</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">targetPrice</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">buy_limit</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-2946"><a href="#-2946"><span class="linenos">2946</span></a>
</span><span id="L-2947"><a href="#-2947"><span class="linenos">2947</span></a>        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">sell_limit</span><span class="p">:</span>
</span><span id="L-2948"><a href="#-2948"><span class="linenos">2948</span></a>            <span class="n">server</span><span class="o">.</span><span class="n">SellLimit</span><span class="p">(</span><span class="n">lots</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sell_limit</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">targetPrice</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">sell_limit</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-2949"><a href="#-2949"><span class="linenos">2949</span></a>
</span><span id="L-2950"><a href="#-2950"><span class="linenos">2950</span></a>        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">buy_stop</span><span class="p">:</span>
</span><span id="L-2951"><a href="#-2951"><span class="linenos">2951</span></a>            <span class="k">if</span> <span class="mi">2</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">buy_stop</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">:</span>
</span><span id="L-2952"><a href="#-2952"><span class="linenos">2952</span></a>                <span class="n">server</span><span class="o">.</span><span class="n">BuyStop</span><span class="p">(</span>
</span><span id="L-2953"><a href="#-2953"><span class="linenos">2953</span></a>                    <span class="n">lots</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">buy_stop</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="L-2954"><a href="#-2954"><span class="linenos">2954</span></a>                    <span class="n">targetPrice</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">buy_stop</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="L-2955"><a href="#-2955"><span class="linenos">2955</span></a>                    <span class="n">limitPrice</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">buy_stop</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">buy_stop</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="k">else</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="L-2956"><a href="#-2956"><span class="linenos">2956</span></a>                    <span class="n">stopType</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">buy_stop</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">buy_stop</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="k">else</span> <span class="s2">&quot;Limit&quot;</span><span class="p">,</span>
</span><span id="L-2957"><a href="#-2957"><span class="linenos">2957</span></a>                    <span class="n">expDate</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">buy_stop</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">buy_stop</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span> <span class="k">else</span> <span class="s2">&quot;Undefined&quot;</span><span class="p">,</span>
</span><span id="L-2958"><a href="#-2958"><span class="linenos">2958</span></a>                <span class="p">)</span>
</span><span id="L-2959"><a href="#-2959"><span class="linenos">2959</span></a>
</span><span id="L-2960"><a href="#-2960"><span class="linenos">2960</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-2961"><a href="#-2961"><span class="linenos">2961</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;You must specify 2-5 parameters for buy stop-order: [lots] [target price] [limit price, &gt;= 0] [stop type, Limit|SL|TP] [expiration date, Undefined|`%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S`]. See: `python TKSBrokerAPI.py --help`&quot;</span><span class="p">)</span>
</span><span id="L-2962"><a href="#-2962"><span class="linenos">2962</span></a>
</span><span id="L-2963"><a href="#-2963"><span class="linenos">2963</span></a>        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">sell_stop</span><span class="p">:</span>
</span><span id="L-2964"><a href="#-2964"><span class="linenos">2964</span></a>            <span class="k">if</span> <span class="mi">2</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sell_stop</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">:</span>
</span><span id="L-2965"><a href="#-2965"><span class="linenos">2965</span></a>                <span class="n">server</span><span class="o">.</span><span class="n">SellStop</span><span class="p">(</span>
</span><span id="L-2966"><a href="#-2966"><span class="linenos">2966</span></a>                    <span class="n">lots</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sell_stop</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="L-2967"><a href="#-2967"><span class="linenos">2967</span></a>                    <span class="n">targetPrice</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sell_stop</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="L-2968"><a href="#-2968"><span class="linenos">2968</span></a>                    <span class="n">limitPrice</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sell_stop</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sell_stop</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="k">else</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="L-2969"><a href="#-2969"><span class="linenos">2969</span></a>                    <span class="n">stopType</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">sell_stop</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sell_stop</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="k">else</span> <span class="s2">&quot;Limit&quot;</span><span class="p">,</span>
</span><span id="L-2970"><a href="#-2970"><span class="linenos">2970</span></a>                    <span class="n">expDate</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">sell_stop</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sell_stop</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span> <span class="k">else</span> <span class="s2">&quot;Undefined&quot;</span><span class="p">,</span>
</span><span id="L-2971"><a href="#-2971"><span class="linenos">2971</span></a>                <span class="p">)</span>
</span><span id="L-2972"><a href="#-2972"><span class="linenos">2972</span></a>
</span><span id="L-2973"><a href="#-2973"><span class="linenos">2973</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-2974"><a href="#-2974"><span class="linenos">2974</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;You must specify 2-5 parameters for sell stop-order: [lots] [target price] [limit price, &gt;= 0] [stop type, Limit|SL|TP] [expiration date, Undefined|`%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S`]. See: python TKSBrokerAPI.py --help&quot;</span><span class="p">)</span>
</span><span id="L-2975"><a href="#-2975"><span class="linenos">2975</span></a>
</span><span id="L-2976"><a href="#-2976"><span class="linenos">2976</span></a>        <span class="c1"># elif args.buy_order_grid is not None:</span>
</span><span id="L-2977"><a href="#-2977"><span class="linenos">2977</span></a>        <span class="c1">#     # TODO: update order grid work with api v2</span>
</span><span id="L-2978"><a href="#-2978"><span class="linenos">2978</span></a>        <span class="c1">#     if len(args.buy_order_grid) == 2:</span>
</span><span id="L-2979"><a href="#-2979"><span class="linenos">2979</span></a>        <span class="c1">#         orderParams = server.ParseOrderParameters(operation=&quot;Buy&quot;, **dict(kw.split(&#39;=&#39;) for kw in args.buy_order_grid))</span>
</span><span id="L-2980"><a href="#-2980"><span class="linenos">2980</span></a>        <span class="c1">#</span>
</span><span id="L-2981"><a href="#-2981"><span class="linenos">2981</span></a>        <span class="c1">#         for order in orderParams:</span>
</span><span id="L-2982"><a href="#-2982"><span class="linenos">2982</span></a>        <span class="c1">#             server.Order(operation=&quot;Buy&quot;, lots=order[&quot;lot&quot;], price=order[&quot;price&quot;])</span>
</span><span id="L-2983"><a href="#-2983"><span class="linenos">2983</span></a>        <span class="c1">#</span>
</span><span id="L-2984"><a href="#-2984"><span class="linenos">2984</span></a>        <span class="c1">#     else:</span>
</span><span id="L-2985"><a href="#-2985"><span class="linenos">2985</span></a>        <span class="c1">#         uLogger.error(&quot;To open grid of pending BUY limit-orders (below current price) you must specified 2 parameters: l(ots)=[L_int,...] p(rices)=[P_float,...]. See: `python TKSBrokerAPI.py --help`&quot;)</span>
</span><span id="L-2986"><a href="#-2986"><span class="linenos">2986</span></a>        <span class="c1">#</span>
</span><span id="L-2987"><a href="#-2987"><span class="linenos">2987</span></a>        <span class="c1"># elif args.sell_order_grid is not None:</span>
</span><span id="L-2988"><a href="#-2988"><span class="linenos">2988</span></a>        <span class="c1">#     # TODO: update order grid work with api v2</span>
</span><span id="L-2989"><a href="#-2989"><span class="linenos">2989</span></a>        <span class="c1">#     if len(args.sell_order_grid) &gt;= 2:</span>
</span><span id="L-2990"><a href="#-2990"><span class="linenos">2990</span></a>        <span class="c1">#         orderParams = server.ParseOrderParameters(operation=&quot;Sell&quot;, **dict(kw.split(&#39;=&#39;) for kw in args.sell_order_grid))</span>
</span><span id="L-2991"><a href="#-2991"><span class="linenos">2991</span></a>        <span class="c1">#</span>
</span><span id="L-2992"><a href="#-2992"><span class="linenos">2992</span></a>        <span class="c1">#         for order in orderParams:</span>
</span><span id="L-2993"><a href="#-2993"><span class="linenos">2993</span></a>        <span class="c1">#             server.Order(operation=&quot;Sell&quot;, lots=order[&quot;lot&quot;], price=order[&quot;price&quot;])</span>
</span><span id="L-2994"><a href="#-2994"><span class="linenos">2994</span></a>        <span class="c1">#</span>
</span><span id="L-2995"><a href="#-2995"><span class="linenos">2995</span></a>        <span class="c1">#     else:</span>
</span><span id="L-2996"><a href="#-2996"><span class="linenos">2996</span></a>        <span class="c1">#         uLogger.error(&quot;To open grid of pending SELL limit-orders (above current price) you must specified 2 parameters: l(ots)=[L_int,...] p(rices)=[P_float,...]. See: `python TKSBrokerAPI.py --help`&quot;)</span>
</span><span id="L-2997"><a href="#-2997"><span class="linenos">2997</span></a>
</span><span id="L-2998"><a href="#-2998"><span class="linenos">2998</span></a>        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">close_order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2999"><a href="#-2999"><span class="linenos">2999</span></a>            <span class="n">server</span><span class="o">.</span><span class="n">CloseOrders</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">close_order</span><span class="p">)</span>  <span class="c1"># close only one order</span>
</span><span id="L-3000"><a href="#-3000"><span class="linenos">3000</span></a>
</span><span id="L-3001"><a href="#-3001"><span class="linenos">3001</span></a>        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">close_orders</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-3002"><a href="#-3002"><span class="linenos">3002</span></a>            <span class="n">server</span><span class="o">.</span><span class="n">CloseOrders</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">close_orders</span><span class="p">)</span>  <span class="c1"># close list of orders</span>
</span><span id="L-3003"><a href="#-3003"><span class="linenos">3003</span></a>
</span><span id="L-3004"><a href="#-3004"><span class="linenos">3004</span></a>        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">close_trade</span><span class="p">:</span>
</span><span id="L-3005"><a href="#-3005"><span class="linenos">3005</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">ticker</span><span class="p">:</span>
</span><span id="L-3006"><a href="#-3006"><span class="linenos">3006</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;`--ticker` key is required for this operation!&quot;</span><span class="p">)</span>
</span><span id="L-3007"><a href="#-3007"><span class="linenos">3007</span></a>
</span><span id="L-3008"><a href="#-3008"><span class="linenos">3008</span></a>            <span class="n">server</span><span class="o">.</span><span class="n">CloseTrades</span><span class="p">([</span><span class="n">args</span><span class="o">.</span><span class="n">ticker</span><span class="p">])</span>  <span class="c1"># close only one trade</span>
</span><span id="L-3009"><a href="#-3009"><span class="linenos">3009</span></a>
</span><span id="L-3010"><a href="#-3010"><span class="linenos">3010</span></a>        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">close_trades</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-3011"><a href="#-3011"><span class="linenos">3011</span></a>            <span class="n">server</span><span class="o">.</span><span class="n">CloseTrades</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">close_trades</span><span class="p">)</span>  <span class="c1"># close trades for list of tickers</span>
</span><span id="L-3012"><a href="#-3012"><span class="linenos">3012</span></a>
</span><span id="L-3013"><a href="#-3013"><span class="linenos">3013</span></a>        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">close_all</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-3014"><a href="#-3014"><span class="linenos">3014</span></a>            <span class="n">server</span><span class="o">.</span><span class="n">CloseAll</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="o">.</span><span class="n">close_all</span><span class="p">)</span>
</span><span id="L-3015"><a href="#-3015"><span class="linenos">3015</span></a>
</span><span id="L-3016"><a href="#-3016"><span class="linenos">3016</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-3017"><a href="#-3017"><span class="linenos">3017</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;There is no command to execute! One of the possible commands must be selected. See: `python TKSBrokerAPI.py --help`&quot;</span><span class="p">)</span>
</span><span id="L-3018"><a href="#-3018"><span class="linenos">3018</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;There is no command to execute!&quot;</span><span class="p">)</span>
</span><span id="L-3019"><a href="#-3019"><span class="linenos">3019</span></a>
</span><span id="L-3020"><a href="#-3020"><span class="linenos">3020</span></a>    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="L-3021"><a href="#-3021"><span class="linenos">3021</span></a>        <span class="n">exc</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-3022"><a href="#-3022"><span class="linenos">3022</span></a>
</span><span id="L-3023"><a href="#-3023"><span class="linenos">3023</span></a>        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">exc</span><span class="p">:</span>
</span><span id="L-3024"><a href="#-3024"><span class="linenos">3024</span></a>            <span class="k">if</span> <span class="n">line</span><span class="p">:</span>
</span><span id="L-3025"><a href="#-3025"><span class="linenos">3025</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span id="L-3026"><a href="#-3026"><span class="linenos">3026</span></a>
</span><span id="L-3027"><a href="#-3027"><span class="linenos">3027</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Unknown error occurred, open a ticket for this issue, please! https://github.com/Tim55667757/TKSBrokerAPI/issues&quot;</span><span class="p">)</span>
</span><span id="L-3028"><a href="#-3028"><span class="linenos">3028</span></a>        <span class="n">exitCode</span> <span class="o">=</span> <span class="mi">255</span>  <span class="c1"># unknown error occurred, must be open a ticket for this issue</span>
</span><span id="L-3029"><a href="#-3029"><span class="linenos">3029</span></a>
</span><span id="L-3030"><a href="#-3030"><span class="linenos">3030</span></a>    <span class="k">finally</span><span class="p">:</span>
</span><span id="L-3031"><a href="#-3031"><span class="linenos">3031</span></a>        <span class="n">finish</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tzutc</span><span class="p">())</span>
</span><span id="L-3032"><a href="#-3032"><span class="linenos">3032</span></a>
</span><span id="L-3033"><a href="#-3033"><span class="linenos">3033</span></a>        <span class="k">if</span> <span class="n">exitCode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-3034"><a href="#-3034"><span class="linenos">3034</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;All operations with Tinkoff Server using Open API are finished success (summary code is 0).&quot;</span><span class="p">)</span>
</span><span id="L-3035"><a href="#-3035"><span class="linenos">3035</span></a>
</span><span id="L-3036"><a href="#-3036"><span class="linenos">3036</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-3037"><a href="#-3037"><span class="linenos">3037</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;TKSBrokerAPI module returns an error! See full debug log with key in run command `--debug-level 10`. Summary code: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exitCode</span><span class="p">))</span>
</span><span id="L-3038"><a href="#-3038"><span class="linenos">3038</span></a>
</span><span id="L-3039"><a href="#-3039"><span class="linenos">3039</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TKSBrokerAPI module work duration: [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finish</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
</span><span id="L-3040"><a href="#-3040"><span class="linenos">3040</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TKSBrokerAPI module finished: [</span><span class="si">{}</span><span class="s2">] (UTC), it is [</span><span class="si">{}</span><span class="s2">] local time&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-3041"><a href="#-3041"><span class="linenos">3041</span></a>            <span class="n">finish</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">),</span>
</span><span id="L-3042"><a href="#-3042"><span class="linenos">3042</span></a>            <span class="n">finish</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">tzlocal</span><span class="p">())</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">),</span>
</span><span id="L-3043"><a href="#-3043"><span class="linenos">3043</span></a>        <span class="p">))</span>
</span><span id="L-3044"><a href="#-3044"><span class="linenos">3044</span></a>
</span><span id="L-3045"><a href="#-3045"><span class="linenos">3045</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">:</span>
</span><span id="L-3046"><a href="#-3046"><span class="linenos">3046</span></a>            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">exitCode</span><span class="p">)</span>
</span><span id="L-3047"><a href="#-3047"><span class="linenos">3047</span></a>
</span><span id="L-3048"><a href="#-3048"><span class="linenos">3048</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-3049"><a href="#-3049"><span class="linenos">3049</span></a>            <span class="k">return</span> <span class="n">exitCode</span>
</span><span id="L-3050"><a href="#-3050"><span class="linenos">3050</span></a>
</span><span id="L-3051"><a href="#-3051"><span class="linenos">3051</span></a>
</span><span id="L-3052"><a href="#-3052"><span class="linenos">3052</span></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
</span><span id="L-3053"><a href="#-3053"><span class="linenos">3053</span></a>    <span class="n">Main</span><span class="p">()</span>
</span></pre></div>


            </section>
                <section id="NanoToFloat">
                            <input id="NanoToFloat-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">NanoToFloat</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">units</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">nano</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="NanoToFloat-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NanoToFloat"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NanoToFloat-71"><a href="#-71"><span class="linenos">71</span></a><span class="k">def</span> <span class="nf">NanoToFloat</span><span class="p">(</span><span class="n">units</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">nano</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="NanoToFloat-72"><a href="#-72"><span class="linenos">72</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="NanoToFloat-73"><a href="#-73"><span class="linenos">73</span></a><span class="sd">    Convert number in nano-view mode with string parameter `units` and integer parameter `nano` to float view. Examples:</span>
</span><span id="NanoToFloat-74"><a href="#-74"><span class="linenos">74</span></a>
</span><span id="NanoToFloat-75"><a href="#-75"><span class="linenos">75</span></a><span class="sd">    `NanoToFloat(units=&quot;2&quot;, nano=500000000) -&gt; 2.5`</span>
</span><span id="NanoToFloat-76"><a href="#-76"><span class="linenos">76</span></a>
</span><span id="NanoToFloat-77"><a href="#-77"><span class="linenos">77</span></a><span class="sd">    `NanoToFloat(units=&quot;0&quot;, nano=50000000) -&gt; 0.05`</span>
</span><span id="NanoToFloat-78"><a href="#-78"><span class="linenos">78</span></a>
</span><span id="NanoToFloat-79"><a href="#-79"><span class="linenos">79</span></a><span class="sd">    :param units: integer string or integer parameter that represents the integer part of number</span>
</span><span id="NanoToFloat-80"><a href="#-80"><span class="linenos">80</span></a><span class="sd">    :param nano: integer string or integer parameter that represents the fractional part of number</span>
</span><span id="NanoToFloat-81"><a href="#-81"><span class="linenos">81</span></a><span class="sd">    :return: float view of number</span>
</span><span id="NanoToFloat-82"><a href="#-82"><span class="linenos">82</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="NanoToFloat-83"><a href="#-83"><span class="linenos">83</span></a>    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">units</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">nano</span><span class="p">)</span> <span class="o">*</span> <span class="n">NANO</span>
</span></pre></div>


            <div class="docstring"><p>Convert number in nano-view mode with string parameter <code>units</code> and integer parameter <code>nano</code> to float view. Examples:</p>

<p><code>NanoToFloat(units="2", nano=500000000) -&gt; 2.5</code></p>

<p><code>NanoToFloat(units="0", nano=50000000) -&gt; 0.05</code></p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>units</strong>:  integer string or integer parameter that represents the integer part of number</li>
<li><strong>nano</strong>:  integer string or integer parameter that represents the fractional part of number</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>float view of number</p>
</blockquote>
</div>


                </section>
                <section id="FloatToNano">
                            <input id="FloatToNano-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">FloatToNano</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">number</span><span class="p">:</span> <span class="nb">float</span></span><span class="return-annotation">) -> <span class="nb">dict</span>:</span></span>

                <label class="view-source-button" for="FloatToNano-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FloatToNano"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FloatToNano-86"><a href="#-86"><span class="linenos"> 86</span></a><span class="k">def</span> <span class="nf">FloatToNano</span><span class="p">(</span><span class="n">number</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="FloatToNano-87"><a href="#-87"><span class="linenos"> 87</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="FloatToNano-88"><a href="#-88"><span class="linenos"> 88</span></a><span class="sd">    Convert float number to nano-type view: dictionary with string `units` and integer `nano` parameters `{&quot;units&quot;: &quot;string&quot;, &quot;nano&quot;: integer}`. Examples:</span>
</span><span id="FloatToNano-89"><a href="#-89"><span class="linenos"> 89</span></a>
</span><span id="FloatToNano-90"><a href="#-90"><span class="linenos"> 90</span></a><span class="sd">    `FloatToNano(number=2.5) -&gt; {&quot;units&quot;: &quot;2&quot;, &quot;nano&quot;: 500000000}`</span>
</span><span id="FloatToNano-91"><a href="#-91"><span class="linenos"> 91</span></a>
</span><span id="FloatToNano-92"><a href="#-92"><span class="linenos"> 92</span></a><span class="sd">    `FloatToNano(number=0.05) -&gt; {&quot;units&quot;: &quot;0&quot;, &quot;nano&quot;: 50000000}`</span>
</span><span id="FloatToNano-93"><a href="#-93"><span class="linenos"> 93</span></a>
</span><span id="FloatToNano-94"><a href="#-94"><span class="linenos"> 94</span></a><span class="sd">    :param number: float number</span>
</span><span id="FloatToNano-95"><a href="#-95"><span class="linenos"> 95</span></a><span class="sd">    :return: nano-type view of number: `{&quot;units&quot;: &quot;string&quot;, &quot;nano&quot;: integer}`</span>
</span><span id="FloatToNano-96"><a href="#-96"><span class="linenos"> 96</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="FloatToNano-97"><a href="#-97"><span class="linenos"> 97</span></a>    <span class="n">splitByPoint</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">number</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
</span><span id="FloatToNano-98"><a href="#-98"><span class="linenos"> 98</span></a>    <span class="n">frac</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="FloatToNano-99"><a href="#-99"><span class="linenos"> 99</span></a>
</span><span id="FloatToNano-100"><a href="#-100"><span class="linenos">100</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">splitByPoint</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="FloatToNano-101"><a href="#-101"><span class="linenos">101</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">splitByPoint</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mi">9</span><span class="p">:</span>
</span><span id="FloatToNano-102"><a href="#-102"><span class="linenos">102</span></a>            <span class="n">frac</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="FloatToNano-103"><a href="#-103"><span class="linenos">103</span></a>                <span class="nb">int</span><span class="p">(</span><span class="n">splitByPoint</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="FloatToNano-104"><a href="#-104"><span class="linenos">104</span></a>                <span class="s2">&quot;0&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">9</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">splitByPoint</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span>
</span><span id="FloatToNano-105"><a href="#-105"><span class="linenos">105</span></a>            <span class="p">))</span>
</span><span id="FloatToNano-106"><a href="#-106"><span class="linenos">106</span></a>
</span><span id="FloatToNano-107"><a href="#-107"><span class="linenos">107</span></a>    <span class="k">if</span> <span class="p">(</span><span class="n">number</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">frac</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="FloatToNano-108"><a href="#-108"><span class="linenos">108</span></a>        <span class="n">frac</span> <span class="o">=</span> <span class="o">-</span><span class="n">frac</span>
</span><span id="FloatToNano-109"><a href="#-109"><span class="linenos">109</span></a>
</span><span id="FloatToNano-110"><a href="#-110"><span class="linenos">110</span></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">number</span><span class="p">)),</span> <span class="s2">&quot;nano&quot;</span><span class="p">:</span> <span class="n">frac</span><span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Convert float number to nano-type view: dictionary with string <code>units</code> and integer <code>nano</code> parameters <code>{"units": "string", "nano": integer}</code>. Examples:</p>

<p><code>FloatToNano(number=2.5) -&gt; {"units": "2", "nano": 500000000}</code></p>

<p><code>FloatToNano(number=0.05) -&gt; {"units": "0", "nano": 50000000}</code></p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>number</strong>:  float number</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>nano-type view of number: <code>{"units": "string", "nano": integer}</code></p>
</blockquote>
</div>


                </section>
                <section id="GetDatesAsString">
                            <input id="GetDatesAsString-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">GetDatesAsString</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">start</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>, </span><span class="param"><span class="n">end</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="nb">tuple</span>:</span></span>

                <label class="view-source-button" for="GetDatesAsString-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GetDatesAsString"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GetDatesAsString-113"><a href="#-113"><span class="linenos">113</span></a><span class="k">def</span> <span class="nf">GetDatesAsString</span><span class="p">(</span><span class="n">start</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
</span><span id="GetDatesAsString-114"><a href="#-114"><span class="linenos">114</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="GetDatesAsString-115"><a href="#-115"><span class="linenos">115</span></a><span class="sd">    If `start=None`, `end=None` then return dates from yesterday to current time.</span>
</span><span id="GetDatesAsString-116"><a href="#-116"><span class="linenos">116</span></a><span class="sd">    If `start=some_date_1`, `end=None` then return dates from `some_date_1` to current time.</span>
</span><span id="GetDatesAsString-117"><a href="#-117"><span class="linenos">117</span></a><span class="sd">    If `start=some_date_1`, `end=some_date_2` then return dates from `some_date_1` to `some_date_2`.</span>
</span><span id="GetDatesAsString-118"><a href="#-118"><span class="linenos">118</span></a><span class="sd">    Start day may be negative integer numbers: `-1`, `-2`, `-3` - how many days ago.</span>
</span><span id="GetDatesAsString-119"><a href="#-119"><span class="linenos">119</span></a>
</span><span id="GetDatesAsString-120"><a href="#-120"><span class="linenos">120</span></a><span class="sd">    Also, you can use keywords for start if `dateEnd=None`:</span>
</span><span id="GetDatesAsString-121"><a href="#-121"><span class="linenos">121</span></a><span class="sd">    `today` (from 00:00:00 to current time),</span>
</span><span id="GetDatesAsString-122"><a href="#-122"><span class="linenos">122</span></a><span class="sd">    `yesterday` (-1 day from 00:00:00 to 23:59:59),</span>
</span><span id="GetDatesAsString-123"><a href="#-123"><span class="linenos">123</span></a><span class="sd">    `week` (-7 day from 00:00:00 to current date and time),</span>
</span><span id="GetDatesAsString-124"><a href="#-124"><span class="linenos">124</span></a><span class="sd">    `month` (-30 day from 00:00:00 to current date and time),</span>
</span><span id="GetDatesAsString-125"><a href="#-125"><span class="linenos">125</span></a><span class="sd">    `year` (-365 day from 00:00:00 to current date and time),</span>
</span><span id="GetDatesAsString-126"><a href="#-126"><span class="linenos">126</span></a>
</span><span id="GetDatesAsString-127"><a href="#-127"><span class="linenos">127</span></a><span class="sd">    User dates format must be like: `%Y-%m-%d`, e.g. `2020-02-03` (3 Feb, 2020).</span>
</span><span id="GetDatesAsString-128"><a href="#-128"><span class="linenos">128</span></a>
</span><span id="GetDatesAsString-129"><a href="#-129"><span class="linenos">129</span></a><span class="sd">    :return: tuple with 2 strings `(start, end)` dates in UTC ISO time format `%Y-%m-%dT%H:%M:%SZ` for OpenAPI.</span>
</span><span id="GetDatesAsString-130"><a href="#-130"><span class="linenos">130</span></a><span class="sd">             Example: `(&quot;2022-06-01T00:00:00Z&quot;, &quot;2022-06-20T23:59:59Z&quot;)`</span>
</span><span id="GetDatesAsString-131"><a href="#-131"><span class="linenos">131</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="GetDatesAsString-132"><a href="#-132"><span class="linenos">132</span></a>    <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Input start day is [</span><span class="si">{}</span><span class="s2">] (UTC), end day is [</span><span class="si">{}</span><span class="s2">] (UTC)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>
</span><span id="GetDatesAsString-133"><a href="#-133"><span class="linenos">133</span></a>    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tzutc</span><span class="p">())</span>
</span><span id="GetDatesAsString-134"><a href="#-134"><span class="linenos">134</span></a>
</span><span id="GetDatesAsString-135"><a href="#-135"><span class="linenos">135</span></a>    <span class="c1"># showing statistics between start of the current day and current time:</span>
</span><span id="GetDatesAsString-136"><a href="#-136"><span class="linenos">136</span></a>    <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">start</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;today&quot;</span><span class="p">:</span>
</span><span id="GetDatesAsString-137"><a href="#-137"><span class="linenos">137</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="GetDatesAsString-138"><a href="#-138"><span class="linenos">138</span></a>        <span class="n">e</span> <span class="o">=</span> <span class="n">now</span>
</span><span id="GetDatesAsString-139"><a href="#-139"><span class="linenos">139</span></a>
</span><span id="GetDatesAsString-140"><a href="#-140"><span class="linenos">140</span></a>    <span class="c1"># from start of the last day to the end of the last day:</span>
</span><span id="GetDatesAsString-141"><a href="#-141"><span class="linenos">141</span></a>    <span class="k">elif</span> <span class="n">start</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;yesterday&quot;</span><span class="p">:</span>
</span><span id="GetDatesAsString-142"><a href="#-142"><span class="linenos">142</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="GetDatesAsString-143"><a href="#-143"><span class="linenos">143</span></a>        <span class="n">e</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">23</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">59</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">59</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="GetDatesAsString-144"><a href="#-144"><span class="linenos">144</span></a>
</span><span id="GetDatesAsString-145"><a href="#-145"><span class="linenos">145</span></a>    <span class="c1"># week (-7 day from 00:00:00 to current date and time):</span>
</span><span id="GetDatesAsString-146"><a href="#-146"><span class="linenos">146</span></a>    <span class="k">elif</span> <span class="n">start</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;week&quot;</span><span class="p">:</span>
</span><span id="GetDatesAsString-147"><a href="#-147"><span class="linenos">147</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
</span><span id="GetDatesAsString-148"><a href="#-148"><span class="linenos">148</span></a>        <span class="n">e</span> <span class="o">=</span> <span class="n">now</span>
</span><span id="GetDatesAsString-149"><a href="#-149"><span class="linenos">149</span></a>
</span><span id="GetDatesAsString-150"><a href="#-150"><span class="linenos">150</span></a>    <span class="c1"># month (-30 day from 00:00:00 to current date and time):</span>
</span><span id="GetDatesAsString-151"><a href="#-151"><span class="linenos">151</span></a>    <span class="k">elif</span> <span class="n">start</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;month&quot;</span><span class="p">:</span>
</span><span id="GetDatesAsString-152"><a href="#-152"><span class="linenos">152</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</span><span id="GetDatesAsString-153"><a href="#-153"><span class="linenos">153</span></a>        <span class="n">e</span> <span class="o">=</span> <span class="n">now</span>
</span><span id="GetDatesAsString-154"><a href="#-154"><span class="linenos">154</span></a>
</span><span id="GetDatesAsString-155"><a href="#-155"><span class="linenos">155</span></a>    <span class="c1"># year (-365 day from 00:00:00 to current date and time):</span>
</span><span id="GetDatesAsString-156"><a href="#-156"><span class="linenos">156</span></a>    <span class="k">elif</span> <span class="n">start</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;year&quot;</span><span class="p">:</span>
</span><span id="GetDatesAsString-157"><a href="#-157"><span class="linenos">157</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">365</span><span class="p">)</span>
</span><span id="GetDatesAsString-158"><a href="#-158"><span class="linenos">158</span></a>        <span class="n">e</span> <span class="o">=</span> <span class="n">now</span>
</span><span id="GetDatesAsString-159"><a href="#-159"><span class="linenos">159</span></a>
</span><span id="GetDatesAsString-160"><a href="#-160"><span class="linenos">160</span></a>    <span class="c1"># showing statistics from -N days ago to current date and time:</span>
</span><span id="GetDatesAsString-161"><a href="#-161"><span class="linenos">161</span></a>    <span class="k">elif</span> <span class="n">start</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">start</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
</span><span id="GetDatesAsString-162"><a href="#-162"><span class="linenos">162</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">start</span><span class="p">)))</span>
</span><span id="GetDatesAsString-163"><a href="#-163"><span class="linenos">163</span></a>        <span class="n">e</span> <span class="o">=</span> <span class="n">now</span>
</span><span id="GetDatesAsString-164"><a href="#-164"><span class="linenos">164</span></a>
</span><span id="GetDatesAsString-165"><a href="#-165"><span class="linenos">165</span></a>    <span class="c1"># showing statistics between start day at 00:00:00 and the end day at 23:59:59:</span>
</span><span id="GetDatesAsString-166"><a href="#-166"><span class="linenos">166</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="GetDatesAsString-167"><a href="#-167"><span class="linenos">167</span></a>        <span class="n">s</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">tzutc</span><span class="p">())</span>
</span><span id="GetDatesAsString-168"><a href="#-168"><span class="linenos">168</span></a>        <span class="n">e</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">23</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">59</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">59</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">tzutc</span><span class="p">())</span> <span class="k">if</span> <span class="n">end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">now</span>
</span><span id="GetDatesAsString-169"><a href="#-169"><span class="linenos">169</span></a>
</span><span id="GetDatesAsString-170"><a href="#-170"><span class="linenos">170</span></a>    <span class="c1"># converting to UTC ISO time formatted with Z suffix for Tinkoff Open API:</span>
</span><span id="GetDatesAsString-171"><a href="#-171"><span class="linenos">171</span></a>    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span>
</span><span id="GetDatesAsString-172"><a href="#-172"><span class="linenos">172</span></a>    <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span>
</span><span id="GetDatesAsString-173"><a href="#-173"><span class="linenos">173</span></a>
</span><span id="GetDatesAsString-174"><a href="#-174"><span class="linenos">174</span></a>    <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Tinkoff Open API uses this start day (converted to UTC ISO format, with Z): [</span><span class="si">{}</span><span class="s2">], and the end day: [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
</span><span id="GetDatesAsString-175"><a href="#-175"><span class="linenos">175</span></a>
</span><span id="GetDatesAsString-176"><a href="#-176"><span class="linenos">176</span></a>    <span class="k">return</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span>
</span></pre></div>


            <div class="docstring"><p>If <code>start=None</code>, <code>end=None</code> then return dates from yesterday to current time.
If <code>start=some_date_1</code>, <code>end=None</code> then return dates from <code>some_date_1</code> to current time.
If <code>start=some_date_1</code>, <code>end=some_date_2</code> then return dates from <code>some_date_1</code> to <code>some_date_2</code>.
Start day may be negative integer numbers: <code>-1</code>, <code>-2</code>, <code>-3</code> - how many days ago.</p>

<p>Also, you can use keywords for start if <code>dateEnd=None</code>:
<code>today</code> (from 00:00:00 to current time),
<code>yesterday</code> (-1 day from 00:00:00 to 23:59:59),
<code>week</code> (-7 day from 00:00:00 to current date and time),
<code>month</code> (-30 day from 00:00:00 to current date and time),
<code>year</code> (-365 day from 00:00:00 to current date and time),</p>

<p>User dates format must be like: <code>%Y-%m-%d</code>, e.g. <code>2020-02-03</code> (3 Feb, 2020).</p>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>tuple with 2 strings <code>(start, end)</code> dates in UTC ISO time format <code>%Y-%m-%dT%H:%M:%SZ</code> for OpenAPI.
           Example: <code>("2022-06-01T00:00:00Z", "2022-06-20T23:59:59Z")</code></p>
</blockquote>
</div>


                </section>
                <section id="TinkoffBrokerServer">
                            <input id="TinkoffBrokerServer-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">TinkoffBrokerServer</span>:

                <label class="view-source-button" for="TinkoffBrokerServer-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TinkoffBrokerServer"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TinkoffBrokerServer-179"><a href="#-179"><span class="linenos"> 179</span></a><span class="k">class</span> <span class="nc">TinkoffBrokerServer</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-180"><a href="#-180"><span class="linenos"> 180</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-181"><a href="#-181"><span class="linenos"> 181</span></a><span class="sd">    This class implements methods to work with Tinkoff broker server.</span>
</span><span id="TinkoffBrokerServer-182"><a href="#-182"><span class="linenos"> 182</span></a>
</span><span id="TinkoffBrokerServer-183"><a href="#-183"><span class="linenos"> 183</span></a><span class="sd">    Examples to work with API: https://tinkoff.github.io/investAPI/swagger-ui/</span>
</span><span id="TinkoffBrokerServer-184"><a href="#-184"><span class="linenos"> 184</span></a>
</span><span id="TinkoffBrokerServer-185"><a href="#-185"><span class="linenos"> 185</span></a><span class="sd">    Where is `token`: https://tinkoff.github.io/investAPI/token/</span>
</span><span id="TinkoffBrokerServer-186"><a href="#-186"><span class="linenos"> 186</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-187"><a href="#-187"><span class="linenos"> 187</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">iList</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">accountId</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-188"><a href="#-188"><span class="linenos"> 188</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-189"><a href="#-189"><span class="linenos"> 189</span></a><span class="sd">        Main class init.</span>
</span><span id="TinkoffBrokerServer-190"><a href="#-190"><span class="linenos"> 190</span></a>
</span><span id="TinkoffBrokerServer-191"><a href="#-191"><span class="linenos"> 191</span></a><span class="sd">        :param token: Bearer token for Tinkoff Invest API. It can be set from environment variable `TKS_API_TOKEN`.</span>
</span><span id="TinkoffBrokerServer-192"><a href="#-192"><span class="linenos"> 192</span></a><span class="sd">        :param iList: dictionary of dictionaries with instrument&#39;s data.</span>
</span><span id="TinkoffBrokerServer-193"><a href="#-193"><span class="linenos"> 193</span></a><span class="sd">        :param accountId: string with user&#39;s numeric account ID in Tinkoff Broker. It can be found in broker&#39;s reports.</span>
</span><span id="TinkoffBrokerServer-194"><a href="#-194"><span class="linenos"> 194</span></a><span class="sd">                          Also, this variable can be set from environment variable `TKS_ACCOUNT_ID`.</span>
</span><span id="TinkoffBrokerServer-195"><a href="#-195"><span class="linenos"> 195</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-196"><a href="#-196"><span class="linenos"> 196</span></a>        <span class="k">if</span> <span class="n">token</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-197"><a href="#-197"><span class="linenos"> 197</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-198"><a href="#-198"><span class="linenos"> 198</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;TKS_API_TOKEN&quot;</span><span class="p">])</span>
</span><span id="TinkoffBrokerServer-199"><a href="#-199"><span class="linenos"> 199</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Bearer token for Tinkoff OpenApi set up from environment variable `TKS_API_TOKEN`. See https://tinkoff.github.io/investAPI/token/&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-200"><a href="#-200"><span class="linenos"> 200</span></a>
</span><span id="TinkoffBrokerServer-201"><a href="#-201"><span class="linenos"> 201</span></a>            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-202"><a href="#-202"><span class="linenos"> 202</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;`--token` key or environment variable `TKS_API_TOKEN` is required! See https://tinkoff.github.io/investAPI/token/&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-203"><a href="#-203"><span class="linenos"> 203</span></a>
</span><span id="TinkoffBrokerServer-204"><a href="#-204"><span class="linenos"> 204</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-205"><a href="#-205"><span class="linenos"> 205</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">token</span>  <span class="c1"># highly priority than environment variable &#39;TKS_API_TOKEN&#39;</span>
</span><span id="TinkoffBrokerServer-206"><a href="#-206"><span class="linenos"> 206</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Bearer token for Tinkoff OpenApi set up from class variable `token`&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-207"><a href="#-207"><span class="linenos"> 207</span></a>
</span><span id="TinkoffBrokerServer-208"><a href="#-208"><span class="linenos"> 208</span></a>        <span class="k">if</span> <span class="n">accountId</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">accountId</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-209"><a href="#-209"><span class="linenos"> 209</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-210"><a href="#-210"><span class="linenos"> 210</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">accountId</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;TKS_ACCOUNT_ID&quot;</span><span class="p">])</span>
</span><span id="TinkoffBrokerServer-211"><a href="#-211"><span class="linenos"> 211</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;String with user&#39;s numeric account ID in Tinkoff Broker set up from environment variable `TKS_ACCOUNT_ID`&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-212"><a href="#-212"><span class="linenos"> 212</span></a>
</span><span id="TinkoffBrokerServer-213"><a href="#-213"><span class="linenos"> 213</span></a>            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-214"><a href="#-214"><span class="linenos"> 214</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;`--account-id` key or environment variable `TKS_ACCOUNT_ID` undefined! Some of operations may be unavailable (overview, trading etc).&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-215"><a href="#-215"><span class="linenos"> 215</span></a>
</span><span id="TinkoffBrokerServer-216"><a href="#-216"><span class="linenos"> 216</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-217"><a href="#-217"><span class="linenos"> 217</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">accountId</span> <span class="o">=</span> <span class="n">accountId</span>  <span class="c1"># highly priority than environment variable &#39;TKS_ACCOUNT_ID&#39;</span>
</span><span id="TinkoffBrokerServer-218"><a href="#-218"><span class="linenos"> 218</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;String with user&#39;s numeric account ID in Tinkoff Broker set up from class variable `accountId`&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-219"><a href="#-219"><span class="linenos"> 219</span></a>
</span><span id="TinkoffBrokerServer-220"><a href="#-220"><span class="linenos"> 220</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">aliases</span> <span class="o">=</span> <span class="n">TKS_TICKER_ALIASES</span>
</span><span id="TinkoffBrokerServer-221"><a href="#-221"><span class="linenos"> 221</span></a>        <span class="sd">&quot;&quot;&quot;Some aliases instead official tickers. See `TKSEnums.TKS_TICKER_ALIASES`&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-222"><a href="#-222"><span class="linenos"> 222</span></a>
</span><span id="TinkoffBrokerServer-223"><a href="#-223"><span class="linenos"> 223</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">aliasesKeys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aliases</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>  <span class="c1"># re-calc only first time at class init</span>
</span><span id="TinkoffBrokerServer-224"><a href="#-224"><span class="linenos"> 224</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">exclude</span> <span class="o">=</span> <span class="n">TKS_TICKERS_OR_FIGI_EXCLUDED</span>  <span class="c1"># some of tickets or FIGIs raised exception earlier when it sends to server, that is why we exclude there</span>
</span><span id="TinkoffBrokerServer-225"><a href="#-225"><span class="linenos"> 225</span></a>
</span><span id="TinkoffBrokerServer-226"><a href="#-226"><span class="linenos"> 226</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-227"><a href="#-227"><span class="linenos"> 227</span></a>        <span class="sd">&quot;&quot;&quot;String with ticker, e.g. `GOOGL`. Use alias for `USD000UTSTOM` simple as `USD`, `EUR_RUB__TOM` as `EUR` etc. More tickers aliases here: `TKSEnums.TKS_TICKER_ALIASES`.&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-228"><a href="#-228"><span class="linenos"> 228</span></a>
</span><span id="TinkoffBrokerServer-229"><a href="#-229"><span class="linenos"> 229</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-230"><a href="#-230"><span class="linenos"> 230</span></a>        <span class="sd">&quot;&quot;&quot;String with FIGI, e.g. ticker `GOOGL` has FIGI `BBG009S39JX6`&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-231"><a href="#-231"><span class="linenos"> 231</span></a>
</span><span id="TinkoffBrokerServer-232"><a href="#-232"><span class="linenos"> 232</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="TinkoffBrokerServer-233"><a href="#-233"><span class="linenos"> 233</span></a>        <span class="sd">&quot;&quot;&quot;Depth of Market (DOM) can be &gt;= 1. Default: 1. It used with `--price` key to showing DOM with current prices for givens ticker or FIGI.&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-234"><a href="#-234"><span class="linenos"> 234</span></a>
</span><span id="TinkoffBrokerServer-235"><a href="#-235"><span class="linenos"> 235</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;https://invest-public-api.tinkoff.ru/rest&quot;</span>
</span><span id="TinkoffBrokerServer-236"><a href="#-236"><span class="linenos"> 236</span></a>        <span class="sd">&quot;&quot;&quot;Tinkoff REST API server for real trade operations. Default: https://invest-public-api.tinkoff.ru/rest</span>
</span><span id="TinkoffBrokerServer-237"><a href="#-237"><span class="linenos"> 237</span></a>
</span><span id="TinkoffBrokerServer-238"><a href="#-238"><span class="linenos"> 238</span></a><span class="sd">        See: https://tinkoff.github.io/investAPI/#tinkoff-invest-api_1</span>
</span><span id="TinkoffBrokerServer-239"><a href="#-239"><span class="linenos"> 239</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-240"><a href="#-240"><span class="linenos"> 240</span></a>
</span><span id="TinkoffBrokerServer-241"><a href="#-241"><span class="linenos"> 241</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Broker API server: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-242"><a href="#-242"><span class="linenos"> 242</span></a>
</span><span id="TinkoffBrokerServer-243"><a href="#-243"><span class="linenos"> 243</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">15</span>
</span><span id="TinkoffBrokerServer-244"><a href="#-244"><span class="linenos"> 244</span></a>        <span class="sd">&quot;&quot;&quot;Server operations timeout in seconds. Default: 15&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-245"><a href="#-245"><span class="linenos"> 245</span></a>
</span><span id="TinkoffBrokerServer-246"><a href="#-246"><span class="linenos"> 246</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span> <span class="s2">&quot;accept&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span> <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="s2">&quot;Bearer </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">)}</span>
</span><span id="TinkoffBrokerServer-247"><a href="#-247"><span class="linenos"> 247</span></a>        <span class="sd">&quot;&quot;&quot;Headers which send in every request to broker server. Default: `{&quot;Content-Type&quot;: &quot;application/json&quot;, &quot;accept&quot;: &quot;application/json&quot;, &quot;Authorization&quot;: &quot;Bearer {token}&quot;}`&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-248"><a href="#-248"><span class="linenos"> 248</span></a>
</span><span id="TinkoffBrokerServer-249"><a href="#-249"><span class="linenos"> 249</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="TinkoffBrokerServer-250"><a href="#-250"><span class="linenos"> 250</span></a>        <span class="sd">&quot;&quot;&quot;Request body which send to broker server. Default: `None`&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-251"><a href="#-251"><span class="linenos"> 251</span></a>
</span><span id="TinkoffBrokerServer-252"><a href="#-252"><span class="linenos"> 252</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">historyLength</span> <span class="o">=</span> <span class="mi">24</span>
</span><span id="TinkoffBrokerServer-253"><a href="#-253"><span class="linenos"> 253</span></a>        <span class="sd">&quot;&quot;&quot;How many candles returns if candles history request. For example, if `historyInterval=&quot;hour&quot;` and `historyLength=24` it means: &quot;give me last 24 hours&quot;. Must be &gt;=1. Default: 24&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-254"><a href="#-254"><span class="linenos"> 254</span></a>
</span><span id="TinkoffBrokerServer-255"><a href="#-255"><span class="linenos"> 255</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">historyInterval</span> <span class="o">=</span> <span class="s2">&quot;hour&quot;</span>
</span><span id="TinkoffBrokerServer-256"><a href="#-256"><span class="linenos"> 256</span></a>        <span class="sd">&quot;&quot;&quot;Interval string for Tinkoff API (see: `TKSEnums.TKS_TIMEFRAMES`). Available values are `&quot;1min&quot;`, `&quot;2min&quot;`, `&quot;3min&quot;`, `&quot;5min&quot;`, `&quot;10min&quot;`, `&quot;15min&quot;`, `&quot;30min&quot;`, `&quot;hour&quot;`, `&quot;day&quot;`, `&quot;week&quot;`, `&quot;month&quot;`. Default: `&quot;hour&quot;`&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-257"><a href="#-257"><span class="linenos"> 257</span></a>
</span><span id="TinkoffBrokerServer-258"><a href="#-258"><span class="linenos"> 258</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">iList</span> <span class="o">=</span> <span class="n">iList</span> <span class="k">if</span> <span class="n">iList</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">Listing</span><span class="p">()</span>
</span><span id="TinkoffBrokerServer-259"><a href="#-259"><span class="linenos"> 259</span></a>        <span class="sd">&quot;&quot;&quot;Dictionary with raw data about stocks, currencies, bonds, etfs and futures from broker server.</span>
</span><span id="TinkoffBrokerServer-260"><a href="#-260"><span class="linenos"> 260</span></a><span class="sd">        At first time, when class init, `Listing()` method auto-update this variable.</span>
</span><span id="TinkoffBrokerServer-261"><a href="#-261"><span class="linenos"> 261</span></a><span class="sd">        For future use, you can save this variable and substitute it in the `iList` to avoid permanent downloads from the server.</span>
</span><span id="TinkoffBrokerServer-262"><a href="#-262"><span class="linenos"> 262</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-263"><a href="#-263"><span class="linenos"> 263</span></a>
</span><span id="TinkoffBrokerServer-264"><a href="#-264"><span class="linenos"> 264</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pricesList</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># You can request all current prices with `ShowAllPrices()` method. WARNING! This is too long operation!</span>
</span><span id="TinkoffBrokerServer-265"><a href="#-265"><span class="linenos"> 265</span></a>
</span><span id="TinkoffBrokerServer-266"><a href="#-266"><span class="linenos"> 266</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">instrumentsFile</span> <span class="o">=</span> <span class="s2">&quot;instruments.md&quot;</span>
</span><span id="TinkoffBrokerServer-267"><a href="#-267"><span class="linenos"> 267</span></a>        <span class="sd">&quot;&quot;&quot;Filename where full broker&#39;s instruments list will be saved. Default: `&quot;instruments.md&quot;`&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-268"><a href="#-268"><span class="linenos"> 268</span></a>
</span><span id="TinkoffBrokerServer-269"><a href="#-269"><span class="linenos"> 269</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pricesFile</span> <span class="o">=</span> <span class="s2">&quot;prices.md&quot;</span>
</span><span id="TinkoffBrokerServer-270"><a href="#-270"><span class="linenos"> 270</span></a>        <span class="sd">&quot;&quot;&quot;Filename where prices of selected instruments will be saved. Default: `&quot;prices.md&quot;`&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-271"><a href="#-271"><span class="linenos"> 271</span></a>
</span><span id="TinkoffBrokerServer-272"><a href="#-272"><span class="linenos"> 272</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overviewFile</span> <span class="o">=</span> <span class="s2">&quot;overview.md&quot;</span>
</span><span id="TinkoffBrokerServer-273"><a href="#-273"><span class="linenos"> 273</span></a>        <span class="sd">&quot;&quot;&quot;Filename where current portfolio, open trades and orders will be saved. Default: `&quot;overview.md&quot;`&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-274"><a href="#-274"><span class="linenos"> 274</span></a>
</span><span id="TinkoffBrokerServer-275"><a href="#-275"><span class="linenos"> 275</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reportFile</span> <span class="o">=</span> <span class="s2">&quot;report.md&quot;</span>
</span><span id="TinkoffBrokerServer-276"><a href="#-276"><span class="linenos"> 276</span></a>        <span class="sd">&quot;&quot;&quot;Filename where history of deals and trade statistics will be saved. Default: `&quot;report.md&quot;`&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-277"><a href="#-277"><span class="linenos"> 277</span></a>
</span><span id="TinkoffBrokerServer-278"><a href="#-278"><span class="linenos"> 278</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">historyFile</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="TinkoffBrokerServer-279"><a href="#-279"><span class="linenos"> 279</span></a>        <span class="sd">&quot;&quot;&quot;Full path to .csv output file where history candles will be saved. Default: `None`, mean that returns only pandas dataframe.&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-280"><a href="#-280"><span class="linenos"> 280</span></a>
</span><span id="TinkoffBrokerServer-281"><a href="#-281"><span class="linenos"> 281</span></a>    <span class="nd">@staticmethod</span>
</span><span id="TinkoffBrokerServer-282"><a href="#-282"><span class="linenos"> 282</span></a>    <span class="k">def</span> <span class="nf">_ParseJSON</span><span class="p">(</span><span class="n">rawData</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-283"><a href="#-283"><span class="linenos"> 283</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-284"><a href="#-284"><span class="linenos"> 284</span></a><span class="sd">        Parse JSON from response string.</span>
</span><span id="TinkoffBrokerServer-285"><a href="#-285"><span class="linenos"> 285</span></a>
</span><span id="TinkoffBrokerServer-286"><a href="#-286"><span class="linenos"> 286</span></a><span class="sd">        :param rawData: this is a string with JSON-formatted text.</span>
</span><span id="TinkoffBrokerServer-287"><a href="#-287"><span class="linenos"> 287</span></a><span class="sd">        :param debug: if `True` then print more debug information.</span>
</span><span id="TinkoffBrokerServer-288"><a href="#-288"><span class="linenos"> 288</span></a><span class="sd">        :return: JSON (dictionary), parsed from server response string.</span>
</span><span id="TinkoffBrokerServer-289"><a href="#-289"><span class="linenos"> 289</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-290"><a href="#-290"><span class="linenos"> 290</span></a>        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-291"><a href="#-291"><span class="linenos"> 291</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Raw text body:&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-292"><a href="#-292"><span class="linenos"> 292</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">rawData</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-293"><a href="#-293"><span class="linenos"> 293</span></a>
</span><span id="TinkoffBrokerServer-294"><a href="#-294"><span class="linenos"> 294</span></a>        <span class="n">responseJSON</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">rawData</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">rawData</span> <span class="k">else</span> <span class="p">{}</span>
</span><span id="TinkoffBrokerServer-295"><a href="#-295"><span class="linenos"> 295</span></a>
</span><span id="TinkoffBrokerServer-296"><a href="#-296"><span class="linenos"> 296</span></a>        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-297"><a href="#-297"><span class="linenos"> 297</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;JSON formatted:&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-298"><a href="#-298"><span class="linenos"> 298</span></a>            <span class="k">for</span> <span class="n">jsonLine</span> <span class="ow">in</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">responseJSON</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
</span><span id="TinkoffBrokerServer-299"><a href="#-299"><span class="linenos"> 299</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">jsonLine</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-300"><a href="#-300"><span class="linenos"> 300</span></a>
</span><span id="TinkoffBrokerServer-301"><a href="#-301"><span class="linenos"> 301</span></a>        <span class="k">return</span> <span class="n">responseJSON</span>
</span><span id="TinkoffBrokerServer-302"><a href="#-302"><span class="linenos"> 302</span></a>
</span><span id="TinkoffBrokerServer-303"><a href="#-303"><span class="linenos"> 303</span></a>    <span class="k">def</span> <span class="nf">SendAPIRequest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">reqType</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="n">retry</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">pause</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-304"><a href="#-304"><span class="linenos"> 304</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-305"><a href="#-305"><span class="linenos"> 305</span></a><span class="sd">        Send GET or POST request to broker server and receive JSON object.</span>
</span><span id="TinkoffBrokerServer-306"><a href="#-306"><span class="linenos"> 306</span></a>
</span><span id="TinkoffBrokerServer-307"><a href="#-307"><span class="linenos"> 307</span></a><span class="sd">        self.header: must be define with dictionary of headers.</span>
</span><span id="TinkoffBrokerServer-308"><a href="#-308"><span class="linenos"> 308</span></a><span class="sd">        self.body: if define then used as request body. None by default.</span>
</span><span id="TinkoffBrokerServer-309"><a href="#-309"><span class="linenos"> 309</span></a><span class="sd">        self.timeout: global request timeout, 15 seconds by default.</span>
</span><span id="TinkoffBrokerServer-310"><a href="#-310"><span class="linenos"> 310</span></a><span class="sd">        :param url: url with REST request.</span>
</span><span id="TinkoffBrokerServer-311"><a href="#-311"><span class="linenos"> 311</span></a><span class="sd">        :param reqType: send &quot;GET&quot; or &quot;POST&quot; request. &quot;GET&quot; by default.</span>
</span><span id="TinkoffBrokerServer-312"><a href="#-312"><span class="linenos"> 312</span></a><span class="sd">        :param retry: how many times retry after first request if an error occurred.</span>
</span><span id="TinkoffBrokerServer-313"><a href="#-313"><span class="linenos"> 313</span></a><span class="sd">        :param pause: sleep time in seconds between retries.</span>
</span><span id="TinkoffBrokerServer-314"><a href="#-314"><span class="linenos"> 314</span></a><span class="sd">        :param debug: if `True` then print more debug information.</span>
</span><span id="TinkoffBrokerServer-315"><a href="#-315"><span class="linenos"> 315</span></a><span class="sd">        :return: response JSON (dictionary) from broker.</span>
</span><span id="TinkoffBrokerServer-316"><a href="#-316"><span class="linenos"> 316</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-317"><a href="#-317"><span class="linenos"> 317</span></a>        <span class="k">if</span> <span class="n">reqType</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">):</span>
</span><span id="TinkoffBrokerServer-318"><a href="#-318"><span class="linenos"> 318</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;You can define request type: &#39;GET&#39; or &#39;POST&#39;!&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-319"><a href="#-319"><span class="linenos"> 319</span></a>
</span><span id="TinkoffBrokerServer-320"><a href="#-320"><span class="linenos"> 320</span></a>        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-321"><a href="#-321"><span class="linenos"> 321</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Request parameters:&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-322"><a href="#-322"><span class="linenos"> 322</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;    - REST API URL: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-323"><a href="#-323"><span class="linenos"> 323</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;    - request type: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reqType</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-324"><a href="#-324"><span class="linenos"> 324</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;    - headers: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="s2">&quot;*** request token ***&quot;</span><span class="p">)))</span>
</span><span id="TinkoffBrokerServer-325"><a href="#-325"><span class="linenos"> 325</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;    - body: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-326"><a href="#-326"><span class="linenos"> 326</span></a>
</span><span id="TinkoffBrokerServer-327"><a href="#-327"><span class="linenos"> 327</span></a>        <span class="c1"># fast hack to avoid all operations with some tickers/FIGI</span>
</span><span id="TinkoffBrokerServer-328"><a href="#-328"><span class="linenos"> 328</span></a>        <span class="n">responseJSON</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="TinkoffBrokerServer-329"><a href="#-329"><span class="linenos"> 329</span></a>        <span class="n">oK</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="TinkoffBrokerServer-330"><a href="#-330"><span class="linenos"> 330</span></a>        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exclude</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-331"><a href="#-331"><span class="linenos"> 331</span></a>            <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">url</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-332"><a href="#-332"><span class="linenos"> 332</span></a>                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-333"><a href="#-333"><span class="linenos"> 333</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Do not execute operations with list of this tickers/FIGI: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exclude</span><span class="p">)))</span>
</span><span id="TinkoffBrokerServer-334"><a href="#-334"><span class="linenos"> 334</span></a>
</span><span id="TinkoffBrokerServer-335"><a href="#-335"><span class="linenos"> 335</span></a>                <span class="n">oK</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="TinkoffBrokerServer-336"><a href="#-336"><span class="linenos"> 336</span></a>                <span class="k">break</span>
</span><span id="TinkoffBrokerServer-337"><a href="#-337"><span class="linenos"> 337</span></a>
</span><span id="TinkoffBrokerServer-338"><a href="#-338"><span class="linenos"> 338</span></a>        <span class="k">if</span> <span class="n">oK</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-339"><a href="#-339"><span class="linenos"> 339</span></a>            <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="TinkoffBrokerServer-340"><a href="#-340"><span class="linenos"> 340</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="TinkoffBrokerServer-341"><a href="#-341"><span class="linenos"> 341</span></a>            <span class="n">errMsg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-342"><a href="#-342"><span class="linenos"> 342</span></a>
</span><span id="TinkoffBrokerServer-343"><a href="#-343"><span class="linenos"> 343</span></a>            <span class="k">while</span> <span class="ow">not</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">counter</span> <span class="o">&lt;=</span> <span class="n">retry</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-344"><a href="#-344"><span class="linenos"> 344</span></a>                <span class="k">if</span> <span class="n">reqType</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-345"><a href="#-345"><span class="linenos"> 345</span></a>                    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-346"><a href="#-346"><span class="linenos"> 346</span></a>
</span><span id="TinkoffBrokerServer-347"><a href="#-347"><span class="linenos"> 347</span></a>                <span class="k">if</span> <span class="n">reqType</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-348"><a href="#-348"><span class="linenos"> 348</span></a>                    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-349"><a href="#-349"><span class="linenos"> 349</span></a>
</span><span id="TinkoffBrokerServer-350"><a href="#-350"><span class="linenos"> 350</span></a>                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-351"><a href="#-351"><span class="linenos"> 351</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Response:&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-352"><a href="#-352"><span class="linenos"> 352</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;    - status code: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-353"><a href="#-353"><span class="linenos"> 353</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;    - reason: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">reason</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-354"><a href="#-354"><span class="linenos"> 354</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;    - body length: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)))</span>
</span><span id="TinkoffBrokerServer-355"><a href="#-355"><span class="linenos"> 355</span></a>
</span><span id="TinkoffBrokerServer-356"><a href="#-356"><span class="linenos"> 356</span></a>                <span class="c1"># Error status codes: https://en.wikipedia.org/wiki/List_of_HTTP_status_codes</span>
</span><span id="TinkoffBrokerServer-357"><a href="#-357"><span class="linenos"> 357</span></a>                <span class="k">if</span> <span class="mi">400</span> <span class="o">&lt;=</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&lt;</span> <span class="mi">600</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-358"><a href="#-358"><span class="linenos"> 358</span></a>                    <span class="n">errMsg</span> <span class="o">=</span> <span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">] </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-359"><a href="#-359"><span class="linenos"> 359</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;    - not oK status code received: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">errMsg</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-360"><a href="#-360"><span class="linenos"> 360</span></a>                    <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="TinkoffBrokerServer-361"><a href="#-361"><span class="linenos"> 361</span></a>
</span><span id="TinkoffBrokerServer-362"><a href="#-362"><span class="linenos"> 362</span></a>                    <span class="k">if</span> <span class="n">counter</span> <span class="o">&lt;=</span> <span class="n">retry</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-363"><a href="#-363"><span class="linenos"> 363</span></a>                        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Retry: [</span><span class="si">{}</span><span class="s2">]. Wait until </span><span class="si">{}</span><span class="s2"> sec. and try again...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="n">pause</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-364"><a href="#-364"><span class="linenos"> 364</span></a>                        <span class="n">sleep</span><span class="p">(</span><span class="n">pause</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-365"><a href="#-365"><span class="linenos"> 365</span></a>
</span><span id="TinkoffBrokerServer-366"><a href="#-366"><span class="linenos"> 366</span></a>            <span class="n">responseJSON</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ParseJSON</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-367"><a href="#-367"><span class="linenos"> 367</span></a>
</span><span id="TinkoffBrokerServer-368"><a href="#-368"><span class="linenos"> 368</span></a>            <span class="k">if</span> <span class="n">errMsg</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-369"><a href="#-369"><span class="linenos"> 369</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Not `oK` status received from broker server!&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-370"><a href="#-370"><span class="linenos"> 370</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;    - message: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">errMsg</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-371"><a href="#-371"><span class="linenos"> 371</span></a>                <span class="c1"># raise Exception(&quot;Server returned an error! See full debug log. Also you can set debug=True in SendAPIRequest() and _ParseJSON() methods.&quot;)</span>
</span><span id="TinkoffBrokerServer-372"><a href="#-372"><span class="linenos"> 372</span></a>
</span><span id="TinkoffBrokerServer-373"><a href="#-373"><span class="linenos"> 373</span></a>        <span class="k">return</span> <span class="n">responseJSON</span>
</span><span id="TinkoffBrokerServer-374"><a href="#-374"><span class="linenos"> 374</span></a>
</span><span id="TinkoffBrokerServer-375"><a href="#-375"><span class="linenos"> 375</span></a>    <span class="k">def</span> <span class="nf">_IUpdater</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iType</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-376"><a href="#-376"><span class="linenos"> 376</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-377"><a href="#-377"><span class="linenos"> 377</span></a><span class="sd">        Request instrument by type from server. See available API methods for instruments:</span>
</span><span id="TinkoffBrokerServer-378"><a href="#-378"><span class="linenos"> 378</span></a><span class="sd">        Currencies: https://tinkoff.github.io/investAPI/swagger-ui/#/InstrumentsService/InstrumentsService_Currencies</span>
</span><span id="TinkoffBrokerServer-379"><a href="#-379"><span class="linenos"> 379</span></a><span class="sd">        Shares: https://tinkoff.github.io/investAPI/swagger-ui/#/InstrumentsService/InstrumentsService_Shares</span>
</span><span id="TinkoffBrokerServer-380"><a href="#-380"><span class="linenos"> 380</span></a><span class="sd">        Bonds: https://tinkoff.github.io/investAPI/swagger-ui/#/InstrumentsService/InstrumentsService_Bonds</span>
</span><span id="TinkoffBrokerServer-381"><a href="#-381"><span class="linenos"> 381</span></a><span class="sd">        Etfs: https://tinkoff.github.io/investAPI/swagger-ui/#/InstrumentsService/InstrumentsService_Etfs</span>
</span><span id="TinkoffBrokerServer-382"><a href="#-382"><span class="linenos"> 382</span></a><span class="sd">        Futures: https://tinkoff.github.io/investAPI/swagger-ui/#/InstrumentsService/InstrumentsService_Futures</span>
</span><span id="TinkoffBrokerServer-383"><a href="#-383"><span class="linenos"> 383</span></a>
</span><span id="TinkoffBrokerServer-384"><a href="#-384"><span class="linenos"> 384</span></a><span class="sd">        :param iType: type of the instrument, it must be one of supported types in TKS_INSTRUMENTS list.</span>
</span><span id="TinkoffBrokerServer-385"><a href="#-385"><span class="linenos"> 385</span></a><span class="sd">        :return: tuple with iType name and list of available instruments of current type for defined user token.</span>
</span><span id="TinkoffBrokerServer-386"><a href="#-386"><span class="linenos"> 386</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-387"><a href="#-387"><span class="linenos"> 387</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="TinkoffBrokerServer-388"><a href="#-388"><span class="linenos"> 388</span></a>
</span><span id="TinkoffBrokerServer-389"><a href="#-389"><span class="linenos"> 389</span></a>        <span class="k">if</span> <span class="n">iType</span> <span class="ow">in</span> <span class="n">TKS_INSTRUMENTS</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-390"><a href="#-390"><span class="linenos"> 390</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Requesting available [</span><span class="si">{}</span><span class="s2">] list. Wait, please...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iType</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-391"><a href="#-391"><span class="linenos"> 391</span></a>
</span><span id="TinkoffBrokerServer-392"><a href="#-392"><span class="linenos"> 392</span></a>            <span class="c1"># all instruments have the same body in API v2 requests:</span>
</span><span id="TinkoffBrokerServer-393"><a href="#-393"><span class="linenos"> 393</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="nb">str</span><span class="p">({</span><span class="s2">&quot;instrumentStatus&quot;</span><span class="p">:</span> <span class="s2">&quot;INSTRUMENT_STATUS_UNSPECIFIED&quot;</span><span class="p">})</span>  <span class="c1"># Enum: [INSTRUMENT_STATUS_UNSPECIFIED, INSTRUMENT_STATUS_BASE, INSTRUMENT_STATUS_ALL]</span>
</span><span id="TinkoffBrokerServer-394"><a href="#-394"><span class="linenos"> 394</span></a>            <span class="n">instrumentURL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;/tinkoff.public.invest.api.contract.v1.InstrumentsService/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iType</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-395"><a href="#-395"><span class="linenos"> 395</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SendAPIRequest</span><span class="p">(</span><span class="n">instrumentURL</span><span class="p">,</span> <span class="n">reqType</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s2">&quot;instruments&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer-396"><a href="#-396"><span class="linenos"> 396</span></a>
</span><span id="TinkoffBrokerServer-397"><a href="#-397"><span class="linenos"> 397</span></a>        <span class="k">return</span> <span class="n">iType</span><span class="p">,</span> <span class="n">result</span>
</span><span id="TinkoffBrokerServer-398"><a href="#-398"><span class="linenos"> 398</span></a>
</span><span id="TinkoffBrokerServer-399"><a href="#-399"><span class="linenos"> 399</span></a>    <span class="k">def</span> <span class="nf">_IWrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
</span><span id="TinkoffBrokerServer-400"><a href="#-400"><span class="linenos"> 400</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-401"><a href="#-401"><span class="linenos"> 401</span></a><span class="sd">        Wrapper runs instrument&#39;s update method self._IUpdater().</span>
</span><span id="TinkoffBrokerServer-402"><a href="#-402"><span class="linenos"> 402</span></a><span class="sd">        It&#39;s a workaround for using multiprocessing with kwargs. See: https://stackoverflow.com/a/36799206</span>
</span><span id="TinkoffBrokerServer-403"><a href="#-403"><span class="linenos"> 403</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-404"><a href="#-404"><span class="linenos"> 404</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_IUpdater</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-405"><a href="#-405"><span class="linenos"> 405</span></a>
</span><span id="TinkoffBrokerServer-406"><a href="#-406"><span class="linenos"> 406</span></a>    <span class="k">def</span> <span class="nf">Listing</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-407"><a href="#-407"><span class="linenos"> 407</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-408"><a href="#-408"><span class="linenos"> 408</span></a><span class="sd">        Gets JSON with raw data about stocks, currencies, bonds, etfs and futures from broker server.</span>
</span><span id="TinkoffBrokerServer-409"><a href="#-409"><span class="linenos"> 409</span></a>
</span><span id="TinkoffBrokerServer-410"><a href="#-410"><span class="linenos"> 410</span></a><span class="sd">        :return: Dictionary with all available broker instruments: currencies, stocks, bonds, etfs and futures.</span>
</span><span id="TinkoffBrokerServer-411"><a href="#-411"><span class="linenos"> 411</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-412"><a href="#-412"><span class="linenos"> 412</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Requesting all available instruments from broker for current user token. Wait, please...&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-413"><a href="#-413"><span class="linenos"> 413</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;CPU usages for parallel requests: [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">CPU_USAGES</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-414"><a href="#-414"><span class="linenos"> 414</span></a>
</span><span id="TinkoffBrokerServer-415"><a href="#-415"><span class="linenos"> 415</span></a>        <span class="c1"># this parameters insert to requests: https://tinkoff.github.io/investAPI/swagger-ui/#/InstrumentsService</span>
</span><span id="TinkoffBrokerServer-416"><a href="#-416"><span class="linenos"> 416</span></a>        <span class="c1"># iType is type of instrument, it must be one of supported types in TKS_INSTRUMENTS list.</span>
</span><span id="TinkoffBrokerServer-417"><a href="#-417"><span class="linenos"> 417</span></a>        <span class="n">iParams</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;iType&quot;</span><span class="p">:</span> <span class="n">iType</span><span class="p">}</span> <span class="k">for</span> <span class="n">iType</span> <span class="ow">in</span> <span class="n">TKS_INSTRUMENTS</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer-418"><a href="#-418"><span class="linenos"> 418</span></a>
</span><span id="TinkoffBrokerServer-419"><a href="#-419"><span class="linenos"> 419</span></a>        <span class="n">poolUpdater</span> <span class="o">=</span> <span class="n">ThreadPool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">CPU_USAGES</span><span class="p">)</span>  <span class="c1"># create pool for update instruments in parallel mode</span>
</span><span id="TinkoffBrokerServer-420"><a href="#-420"><span class="linenos"> 420</span></a>        <span class="n">listing</span> <span class="o">=</span> <span class="n">poolUpdater</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_IWrapper</span><span class="p">,</span> <span class="n">iParams</span><span class="p">)</span>  <span class="c1"># execute update operations</span>
</span><span id="TinkoffBrokerServer-421"><a href="#-421"><span class="linenos"> 421</span></a>        <span class="n">poolUpdater</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="TinkoffBrokerServer-422"><a href="#-422"><span class="linenos"> 422</span></a>
</span><span id="TinkoffBrokerServer-423"><a href="#-423"><span class="linenos"> 423</span></a>        <span class="c1"># Dictionary with all broker instruments: stocks, currencies, bonds, etfs and futures.</span>
</span><span id="TinkoffBrokerServer-424"><a href="#-424"><span class="linenos"> 424</span></a>        <span class="c1"># Next in this code: item[0] is &quot;iType&quot; and item[1] is list of available instruments from the result of _IUpdater() method</span>
</span><span id="TinkoffBrokerServer-425"><a href="#-425"><span class="linenos"> 425</span></a>        <span class="n">iList</span> <span class="o">=</span> <span class="p">{</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="p">{</span><span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">]:</span> <span class="n">instrument</span> <span class="k">for</span> <span class="n">instrument</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">listing</span><span class="p">}</span>
</span><span id="TinkoffBrokerServer-426"><a href="#-426"><span class="linenos"> 426</span></a>
</span><span id="TinkoffBrokerServer-427"><a href="#-427"><span class="linenos"> 427</span></a>        <span class="c1"># calculate minimum price increment (step) for all instruments and set up instrument&#39;s type:</span>
</span><span id="TinkoffBrokerServer-428"><a href="#-428"><span class="linenos"> 428</span></a>        <span class="k">for</span> <span class="n">iType</span> <span class="ow">in</span> <span class="n">iList</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-429"><a href="#-429"><span class="linenos"> 429</span></a>            <span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-430"><a href="#-430"><span class="linenos"> 430</span></a>                <span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">][</span><span class="n">ticker</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iType</span>
</span><span id="TinkoffBrokerServer-431"><a href="#-431"><span class="linenos"> 431</span></a>
</span><span id="TinkoffBrokerServer-432"><a href="#-432"><span class="linenos"> 432</span></a>                <span class="k">if</span> <span class="s2">&quot;minPriceIncrement&quot;</span> <span class="ow">in</span> <span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">][</span><span class="n">ticker</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-433"><a href="#-433"><span class="linenos"> 433</span></a>                    <span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">][</span><span class="n">ticker</span><span class="p">][</span><span class="s2">&quot;step&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-434"><a href="#-434"><span class="linenos"> 434</span></a>                        <span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">][</span><span class="n">ticker</span><span class="p">][</span><span class="s2">&quot;minPriceIncrement&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-435"><a href="#-435"><span class="linenos"> 435</span></a>                        <span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">][</span><span class="n">ticker</span><span class="p">][</span><span class="s2">&quot;minPriceIncrement&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-436"><a href="#-436"><span class="linenos"> 436</span></a>                    <span class="p">)</span>
</span><span id="TinkoffBrokerServer-437"><a href="#-437"><span class="linenos"> 437</span></a>
</span><span id="TinkoffBrokerServer-438"><a href="#-438"><span class="linenos"> 438</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-439"><a href="#-439"><span class="linenos"> 439</span></a>                    <span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">][</span><span class="n">ticker</span><span class="p">][</span><span class="s2">&quot;step&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># hack to avoid empty value in some instruments, e.g. futures</span>
</span><span id="TinkoffBrokerServer-440"><a href="#-440"><span class="linenos"> 440</span></a>
</span><span id="TinkoffBrokerServer-441"><a href="#-441"><span class="linenos"> 441</span></a>        <span class="k">return</span> <span class="n">iList</span>
</span><span id="TinkoffBrokerServer-442"><a href="#-442"><span class="linenos"> 442</span></a>
</span><span id="TinkoffBrokerServer-443"><a href="#-443"><span class="linenos"> 443</span></a>    <span class="nd">@staticmethod</span>
</span><span id="TinkoffBrokerServer-444"><a href="#-444"><span class="linenos"> 444</span></a>    <span class="k">def</span> <span class="nf">ShowInstrumentInfo</span><span class="p">(</span><span class="n">iJSON</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">printInfo</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-445"><a href="#-445"><span class="linenos"> 445</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-446"><a href="#-446"><span class="linenos"> 446</span></a><span class="sd">        Show information about instrument defined by json and print in Markdown format.</span>
</span><span id="TinkoffBrokerServer-447"><a href="#-447"><span class="linenos"> 447</span></a>
</span><span id="TinkoffBrokerServer-448"><a href="#-448"><span class="linenos"> 448</span></a><span class="sd">        :param iJSON: json data of instrument, e.g. in code `iJSON = self.iList[&quot;Shares&quot;][self.ticker]`</span>
</span><span id="TinkoffBrokerServer-449"><a href="#-449"><span class="linenos"> 449</span></a><span class="sd">        :param printInfo: if `True` then also printing information about instrument and its current price.</span>
</span><span id="TinkoffBrokerServer-450"><a href="#-450"><span class="linenos"> 450</span></a><span class="sd">        :return: text in Markdown format with information about instrument.</span>
</span><span id="TinkoffBrokerServer-451"><a href="#-451"><span class="linenos"> 451</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-452"><a href="#-452"><span class="linenos"> 452</span></a>        <span class="n">infoText</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-453"><a href="#-453"><span class="linenos"> 453</span></a>        <span class="k">if</span> <span class="n">iJSON</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">iJSON</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">iJSON</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="TinkoffBrokerServer-454"><a href="#-454"><span class="linenos"> 454</span></a>            <span class="n">info</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="TinkoffBrokerServer-455"><a href="#-455"><span class="linenos"> 455</span></a>                <span class="s2">&quot;# Information is actual at: [</span><span class="si">{}</span><span class="s2">] (UTC)</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tzutc</span><span class="p">())</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M&quot;</span><span class="p">)),</span>
</span><span id="TinkoffBrokerServer-456"><a href="#-456"><span class="linenos"> 456</span></a>                <span class="s2">&quot;| Parameters                                              | Values</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-457"><a href="#-457"><span class="linenos"> 457</span></a>                <span class="s2">&quot;|---------------------------------------------------------|---------------------------------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-458"><a href="#-458"><span class="linenos"> 458</span></a>                <span class="s2">&quot;| Stock ticker:                                           | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer-459"><a href="#-459"><span class="linenos"> 459</span></a>                <span class="s2">&quot;| Full name:                                              | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer-460"><a href="#-460"><span class="linenos"> 460</span></a>            <span class="p">]</span>
</span><span id="TinkoffBrokerServer-461"><a href="#-461"><span class="linenos"> 461</span></a>
</span><span id="TinkoffBrokerServer-462"><a href="#-462"><span class="linenos"> 462</span></a>            <span class="k">if</span> <span class="s2">&quot;sector&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;sector&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-463"><a href="#-463"><span class="linenos"> 463</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Sector:                                                 | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;sector&quot;</span><span class="p">]))</span>
</span><span id="TinkoffBrokerServer-464"><a href="#-464"><span class="linenos"> 464</span></a>
</span><span id="TinkoffBrokerServer-465"><a href="#-465"><span class="linenos"> 465</span></a>            <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Country of instrument:                                  | </span><span class="si">{}{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-466"><a href="#-466"><span class="linenos"> 466</span></a>                <span class="s2">&quot;(</span><span class="si">{}</span><span class="s2">) &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;countryOfRisk&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;countryOfRisk&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;countryOfRisk&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-467"><a href="#-467"><span class="linenos"> 467</span></a>                <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;countryOfRiskName&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;countryOfRiskName&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;countryOfRiskName&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-468"><a href="#-468"><span class="linenos"> 468</span></a>            <span class="p">))</span>
</span><span id="TinkoffBrokerServer-469"><a href="#-469"><span class="linenos"> 469</span></a>
</span><span id="TinkoffBrokerServer-470"><a href="#-470"><span class="linenos"> 470</span></a>            <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span><span id="TinkoffBrokerServer-471"><a href="#-471"><span class="linenos"> 471</span></a>                <span class="s2">&quot;|                                                         |</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-472"><a href="#-472"><span class="linenos"> 472</span></a>                <span class="s2">&quot;| FIGI (Financial Instrument Global Identifier):          | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer-473"><a href="#-473"><span class="linenos"> 473</span></a>                <span class="s2">&quot;| Exchange:                                               | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;exchange&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer-474"><a href="#-474"><span class="linenos"> 474</span></a>            <span class="p">])</span>
</span><span id="TinkoffBrokerServer-475"><a href="#-475"><span class="linenos"> 475</span></a>
</span><span id="TinkoffBrokerServer-476"><a href="#-476"><span class="linenos"> 476</span></a>            <span class="k">if</span> <span class="s2">&quot;isin&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;isin&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-477"><a href="#-477"><span class="linenos"> 477</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| ISIN (International Securities Identification Number):  | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;isin&quot;</span><span class="p">]))</span>
</span><span id="TinkoffBrokerServer-478"><a href="#-478"><span class="linenos"> 478</span></a>
</span><span id="TinkoffBrokerServer-479"><a href="#-479"><span class="linenos"> 479</span></a>            <span class="k">if</span> <span class="s2">&quot;classCode&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-480"><a href="#-480"><span class="linenos"> 480</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Class Code:                                             | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;classCode&quot;</span><span class="p">]))</span>
</span><span id="TinkoffBrokerServer-481"><a href="#-481"><span class="linenos"> 481</span></a>
</span><span id="TinkoffBrokerServer-482"><a href="#-482"><span class="linenos"> 482</span></a>            <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span><span id="TinkoffBrokerServer-483"><a href="#-483"><span class="linenos"> 483</span></a>                <span class="s2">&quot;|                                                         |</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-484"><a href="#-484"><span class="linenos"> 484</span></a>                <span class="s2">&quot;| Current broker security trading status:                 | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">TKS_TRADING_STATUSES</span><span class="p">[</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;tradingStatus&quot;</span><span class="p">]]),</span>
</span><span id="TinkoffBrokerServer-485"><a href="#-485"><span class="linenos"> 485</span></a>                <span class="s2">&quot;| Buy operations allowed:                                 | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Yes&quot;</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;buyAvailableFlag&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;No&quot;</span><span class="p">),</span>
</span><span id="TinkoffBrokerServer-486"><a href="#-486"><span class="linenos"> 486</span></a>                <span class="s2">&quot;| Sale operations allowed:                                | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Yes&quot;</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;sellAvailableFlag&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;No&quot;</span><span class="p">),</span>
</span><span id="TinkoffBrokerServer-487"><a href="#-487"><span class="linenos"> 487</span></a>                <span class="s2">&quot;| Short positions allowed:                                | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Yes&quot;</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;shortEnabledFlag&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;No&quot;</span><span class="p">),</span>
</span><span id="TinkoffBrokerServer-488"><a href="#-488"><span class="linenos"> 488</span></a>            <span class="p">])</span>
</span><span id="TinkoffBrokerServer-489"><a href="#-489"><span class="linenos"> 489</span></a>
</span><span id="TinkoffBrokerServer-490"><a href="#-490"><span class="linenos"> 490</span></a>            <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;|                                                         |</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-491"><a href="#-491"><span class="linenos"> 491</span></a>
</span><span id="TinkoffBrokerServer-492"><a href="#-492"><span class="linenos"> 492</span></a>            <span class="k">if</span> <span class="s2">&quot;type&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-493"><a href="#-493"><span class="linenos"> 493</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Type of the instrument:                                 | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]))</span>
</span><span id="TinkoffBrokerServer-494"><a href="#-494"><span class="linenos"> 494</span></a>
</span><span id="TinkoffBrokerServer-495"><a href="#-495"><span class="linenos"> 495</span></a>            <span class="k">if</span> <span class="s2">&quot;futuresType&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;futuresType&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-496"><a href="#-496"><span class="linenos"> 496</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Futures type:                                           | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;futuresType&quot;</span><span class="p">]))</span>
</span><span id="TinkoffBrokerServer-497"><a href="#-497"><span class="linenos"> 497</span></a>
</span><span id="TinkoffBrokerServer-498"><a href="#-498"><span class="linenos"> 498</span></a>            <span class="k">if</span> <span class="s2">&quot;ipoDate&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;ipoDate&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-499"><a href="#-499"><span class="linenos"> 499</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| IPO date:                                               | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;ipoDate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
</span><span id="TinkoffBrokerServer-500"><a href="#-500"><span class="linenos"> 500</span></a>
</span><span id="TinkoffBrokerServer-501"><a href="#-501"><span class="linenos"> 501</span></a>            <span class="k">if</span> <span class="s2">&quot;releasedDate&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;releasedDate&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-502"><a href="#-502"><span class="linenos"> 502</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Released date:                                          | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;releasedDate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
</span><span id="TinkoffBrokerServer-503"><a href="#-503"><span class="linenos"> 503</span></a>
</span><span id="TinkoffBrokerServer-504"><a href="#-504"><span class="linenos"> 504</span></a>            <span class="k">if</span> <span class="s2">&quot;rebalancingFreq&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;rebalancingFreq&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-505"><a href="#-505"><span class="linenos"> 505</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Rebalancing frequency:                                  | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;rebalancingFreq&quot;</span><span class="p">]))</span>
</span><span id="TinkoffBrokerServer-506"><a href="#-506"><span class="linenos"> 506</span></a>
</span><span id="TinkoffBrokerServer-507"><a href="#-507"><span class="linenos"> 507</span></a>            <span class="k">if</span> <span class="s2">&quot;focusType&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;focusType&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-508"><a href="#-508"><span class="linenos"> 508</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Focusing type:                                          | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;focusType&quot;</span><span class="p">]))</span>
</span><span id="TinkoffBrokerServer-509"><a href="#-509"><span class="linenos"> 509</span></a>
</span><span id="TinkoffBrokerServer-510"><a href="#-510"><span class="linenos"> 510</span></a>            <span class="k">if</span> <span class="s2">&quot;assetType&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;assetType&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-511"><a href="#-511"><span class="linenos"> 511</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Asset type:                                             | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;assetType&quot;</span><span class="p">]))</span>
</span><span id="TinkoffBrokerServer-512"><a href="#-512"><span class="linenos"> 512</span></a>
</span><span id="TinkoffBrokerServer-513"><a href="#-513"><span class="linenos"> 513</span></a>            <span class="k">if</span> <span class="s2">&quot;basicAsset&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;basicAsset&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-514"><a href="#-514"><span class="linenos"> 514</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Basic asset:                                            | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;basicAsset&quot;</span><span class="p">]))</span>
</span><span id="TinkoffBrokerServer-515"><a href="#-515"><span class="linenos"> 515</span></a>
</span><span id="TinkoffBrokerServer-516"><a href="#-516"><span class="linenos"> 516</span></a>            <span class="k">if</span> <span class="s2">&quot;basicAssetSize&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;basicAssetSize&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-517"><a href="#-517"><span class="linenos"> 517</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Basic asset size:                                       | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">NanoToFloat</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;basicAssetSize&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">]),</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;basicAssetSize&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])))</span>
</span><span id="TinkoffBrokerServer-518"><a href="#-518"><span class="linenos"> 518</span></a>
</span><span id="TinkoffBrokerServer-519"><a href="#-519"><span class="linenos"> 519</span></a>            <span class="k">if</span> <span class="s2">&quot;isoCurrencyName&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;isoCurrencyName&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-520"><a href="#-520"><span class="linenos"> 520</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| ISO currency name:                                      | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;isoCurrencyName&quot;</span><span class="p">]))</span>
</span><span id="TinkoffBrokerServer-521"><a href="#-521"><span class="linenos"> 521</span></a>
</span><span id="TinkoffBrokerServer-522"><a href="#-522"><span class="linenos"> 522</span></a>            <span class="k">if</span> <span class="s2">&quot;currency&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-523"><a href="#-523"><span class="linenos"> 523</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Payment currency:                                       | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">]))</span>
</span><span id="TinkoffBrokerServer-524"><a href="#-524"><span class="linenos"> 524</span></a>
</span><span id="TinkoffBrokerServer-525"><a href="#-525"><span class="linenos"> 525</span></a>            <span class="k">if</span> <span class="s2">&quot;firstTradeDate&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;firstTradeDate&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-526"><a href="#-526"><span class="linenos"> 526</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| First trade date:                                       | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;firstTradeDate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
</span><span id="TinkoffBrokerServer-527"><a href="#-527"><span class="linenos"> 527</span></a>
</span><span id="TinkoffBrokerServer-528"><a href="#-528"><span class="linenos"> 528</span></a>            <span class="k">if</span> <span class="s2">&quot;lastTradeDate&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;lastTradeDate&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-529"><a href="#-529"><span class="linenos"> 529</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Last trade date:                                        | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;lastTradeDate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
</span><span id="TinkoffBrokerServer-530"><a href="#-530"><span class="linenos"> 530</span></a>
</span><span id="TinkoffBrokerServer-531"><a href="#-531"><span class="linenos"> 531</span></a>            <span class="k">if</span> <span class="s2">&quot;expirationDate&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;expirationDate&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-532"><a href="#-532"><span class="linenos"> 532</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Date of expiration:                                     | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;expirationDate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
</span><span id="TinkoffBrokerServer-533"><a href="#-533"><span class="linenos"> 533</span></a>
</span><span id="TinkoffBrokerServer-534"><a href="#-534"><span class="linenos"> 534</span></a>            <span class="k">if</span> <span class="s2">&quot;stateRegDate&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;stateRegDate&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-535"><a href="#-535"><span class="linenos"> 535</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| State registration date:                                | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;stateRegDate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
</span><span id="TinkoffBrokerServer-536"><a href="#-536"><span class="linenos"> 536</span></a>
</span><span id="TinkoffBrokerServer-537"><a href="#-537"><span class="linenos"> 537</span></a>            <span class="k">if</span> <span class="s2">&quot;placementDate&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;placementDate&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-538"><a href="#-538"><span class="linenos"> 538</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Placement date:                                         | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;placementDate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
</span><span id="TinkoffBrokerServer-539"><a href="#-539"><span class="linenos"> 539</span></a>
</span><span id="TinkoffBrokerServer-540"><a href="#-540"><span class="linenos"> 540</span></a>            <span class="k">if</span> <span class="s2">&quot;maturityDate&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;maturityDate&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-541"><a href="#-541"><span class="linenos"> 541</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Maturity date:                                          | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;maturityDate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
</span><span id="TinkoffBrokerServer-542"><a href="#-542"><span class="linenos"> 542</span></a>
</span><span id="TinkoffBrokerServer-543"><a href="#-543"><span class="linenos"> 543</span></a>            <span class="k">if</span> <span class="s2">&quot;perpetualFlag&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;perpetualFlag&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-544"><a href="#-544"><span class="linenos"> 544</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Perpetual bond:                                         | Yes</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-545"><a href="#-545"><span class="linenos"> 545</span></a>
</span><span id="TinkoffBrokerServer-546"><a href="#-546"><span class="linenos"> 546</span></a>            <span class="k">if</span> <span class="s2">&quot;otcFlag&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;otcFlag&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-547"><a href="#-547"><span class="linenos"> 547</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Over-the-counter (OTC) securities:                      | Yes</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-548"><a href="#-548"><span class="linenos"> 548</span></a>
</span><span id="TinkoffBrokerServer-549"><a href="#-549"><span class="linenos"> 549</span></a>            <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Bond&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-550"><a href="#-550"><span class="linenos"> 550</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Bond issue (size / plan):                               | </span><span class="si">{}</span><span class="s2"> / </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;issueSize&quot;</span><span class="p">],</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;issueSizePlan&quot;</span><span class="p">]))</span>
</span><span id="TinkoffBrokerServer-551"><a href="#-551"><span class="linenos"> 551</span></a>
</span><span id="TinkoffBrokerServer-552"><a href="#-552"><span class="linenos"> 552</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Nominal price (100%):                                   | </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-553"><a href="#-553"><span class="linenos"> 553</span></a>                    <span class="n">NanoToFloat</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;nominal&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">]),</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;nominal&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer-554"><a href="#-554"><span class="linenos"> 554</span></a>                    <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;nominal&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-555"><a href="#-555"><span class="linenos"> 555</span></a>                <span class="p">))</span>
</span><span id="TinkoffBrokerServer-556"><a href="#-556"><span class="linenos"> 556</span></a>
</span><span id="TinkoffBrokerServer-557"><a href="#-557"><span class="linenos"> 557</span></a>                <span class="k">if</span> <span class="s2">&quot;floatingCouponFlag&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-558"><a href="#-558"><span class="linenos"> 558</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Floating coupon:                                        | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Yes&quot;</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;floatingCouponFlag&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;No&quot;</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-559"><a href="#-559"><span class="linenos"> 559</span></a>
</span><span id="TinkoffBrokerServer-560"><a href="#-560"><span class="linenos"> 560</span></a>                <span class="k">if</span> <span class="s2">&quot;amortizationFlag&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-561"><a href="#-561"><span class="linenos"> 561</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Amortization:                                           | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Yes&quot;</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;amortizationFlag&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;No&quot;</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-562"><a href="#-562"><span class="linenos"> 562</span></a>
</span><span id="TinkoffBrokerServer-563"><a href="#-563"><span class="linenos"> 563</span></a>                <span class="k">if</span> <span class="s2">&quot;couponQuantityPerYear&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;couponQuantityPerYear&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-564"><a href="#-564"><span class="linenos"> 564</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Number of coupon payments per year:                     | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;couponQuantityPerYear&quot;</span><span class="p">]))</span>
</span><span id="TinkoffBrokerServer-565"><a href="#-565"><span class="linenos"> 565</span></a>
</span><span id="TinkoffBrokerServer-566"><a href="#-566"><span class="linenos"> 566</span></a>                <span class="k">if</span> <span class="s2">&quot;aciValue&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;aciValue&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-567"><a href="#-567"><span class="linenos"> 567</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Current ACI (Accrued Interest):                         | </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-568"><a href="#-568"><span class="linenos"> 568</span></a>                        <span class="n">NanoToFloat</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;aciValue&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">]),</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;aciValue&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer-569"><a href="#-569"><span class="linenos"> 569</span></a>                        <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;aciValue&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer-570"><a href="#-570"><span class="linenos"> 570</span></a>                    <span class="p">))</span>
</span><span id="TinkoffBrokerServer-571"><a href="#-571"><span class="linenos"> 571</span></a>
</span><span id="TinkoffBrokerServer-572"><a href="#-572"><span class="linenos"> 572</span></a>            <span class="k">if</span> <span class="s2">&quot;currentPrice&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-573"><a href="#-573"><span class="linenos"> 573</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;|                                                         |</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-574"><a href="#-574"><span class="linenos"> 574</span></a>
</span><span id="TinkoffBrokerServer-575"><a href="#-575"><span class="linenos"> 575</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span><span id="TinkoffBrokerServer-576"><a href="#-576"><span class="linenos"> 576</span></a>                    <span class="s2">&quot;| Previous close price of the instrument:                 | </span><span class="si">{}{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-577"><a href="#-577"><span class="linenos"> 577</span></a>                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;closePrice&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;closePrice&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-578"><a href="#-578"><span class="linenos"> 578</span></a>                        <span class="s2">&quot;</span><span class="si">% o</span><span class="s2">f nominal price&quot;</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Bond&quot;</span> <span class="k">else</span> <span class="s2">&quot; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;currency&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
</span><span id="TinkoffBrokerServer-579"><a href="#-579"><span class="linenos"> 579</span></a>                    <span class="p">),</span>
</span><span id="TinkoffBrokerServer-580"><a href="#-580"><span class="linenos"> 580</span></a>                    <span class="s2">&quot;| Last deal price of the instrument:                      | </span><span class="si">{}{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-581"><a href="#-581"><span class="linenos"> 581</span></a>                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-582"><a href="#-582"><span class="linenos"> 582</span></a>                        <span class="s2">&quot;</span><span class="si">% o</span><span class="s2">f nominal price&quot;</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Bond&quot;</span> <span class="k">else</span> <span class="s2">&quot; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;currency&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
</span><span id="TinkoffBrokerServer-583"><a href="#-583"><span class="linenos"> 583</span></a>                    <span class="p">),</span>
</span><span id="TinkoffBrokerServer-584"><a href="#-584"><span class="linenos"> 584</span></a>                    <span class="s2">&quot;| Changes between last deal price and last close  %       | </span><span class="si">{:.2f}</span><span class="s2">%</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;changes&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer-585"><a href="#-585"><span class="linenos"> 585</span></a>                    <span class="s2">&quot;| Current limit price, min / max:                         | </span><span class="si">{}{}</span><span class="s2"> / </span><span class="si">{}{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-586"><a href="#-586"><span class="linenos"> 586</span></a>                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;limitDown&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;limitDown&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-587"><a href="#-587"><span class="linenos"> 587</span></a>                        <span class="s2">&quot;%&quot;</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Bond&quot;</span> <span class="k">else</span> <span class="s2">&quot; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;currency&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
</span><span id="TinkoffBrokerServer-588"><a href="#-588"><span class="linenos"> 588</span></a>                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;limitUp&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;limitUp&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-589"><a href="#-589"><span class="linenos"> 589</span></a>                        <span class="s2">&quot;%&quot;</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Bond&quot;</span> <span class="k">else</span> <span class="s2">&quot; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;currency&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
</span><span id="TinkoffBrokerServer-590"><a href="#-590"><span class="linenos"> 590</span></a>                    <span class="p">),</span>
</span><span id="TinkoffBrokerServer-591"><a href="#-591"><span class="linenos"> 591</span></a>                    <span class="s2">&quot;| Actual price, sell / buy:                               | </span><span class="si">{}{}</span><span class="s2"> / </span><span class="si">{}{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-592"><a href="#-592"><span class="linenos"> 592</span></a>                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;sell&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;price&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;sell&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-593"><a href="#-593"><span class="linenos"> 593</span></a>                        <span class="s2">&quot;%&quot;</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Bond&quot;</span> <span class="k">else</span> <span class="s2">&quot; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;currency&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
</span><span id="TinkoffBrokerServer-594"><a href="#-594"><span class="linenos"> 594</span></a>                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;buy&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;price&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;buy&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-595"><a href="#-595"><span class="linenos"> 595</span></a>                        <span class="s2">&quot;%&quot;</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Bond&quot;</span> <span class="k">else</span><span class="s2">&quot; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;currency&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
</span><span id="TinkoffBrokerServer-596"><a href="#-596"><span class="linenos"> 596</span></a>                    <span class="p">),</span>
</span><span id="TinkoffBrokerServer-597"><a href="#-597"><span class="linenos"> 597</span></a>                <span class="p">])</span>
</span><span id="TinkoffBrokerServer-598"><a href="#-598"><span class="linenos"> 598</span></a>
</span><span id="TinkoffBrokerServer-599"><a href="#-599"><span class="linenos"> 599</span></a>            <span class="k">if</span> <span class="s2">&quot;lot&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-600"><a href="#-600"><span class="linenos"> 600</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Minimum lot to buy:                                     | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;lot&quot;</span><span class="p">]))</span>
</span><span id="TinkoffBrokerServer-601"><a href="#-601"><span class="linenos"> 601</span></a>
</span><span id="TinkoffBrokerServer-602"><a href="#-602"><span class="linenos"> 602</span></a>            <span class="k">if</span> <span class="s2">&quot;step&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-603"><a href="#-603"><span class="linenos"> 603</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Minimum price increment (step):                         | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">]))</span>
</span><span id="TinkoffBrokerServer-604"><a href="#-604"><span class="linenos"> 604</span></a>
</span><span id="TinkoffBrokerServer-605"><a href="#-605"><span class="linenos"> 605</span></a>            <span class="n">infoText</span> <span class="o">+=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-606"><a href="#-606"><span class="linenos"> 606</span></a>
</span><span id="TinkoffBrokerServer-607"><a href="#-607"><span class="linenos"> 607</span></a>            <span class="k">if</span> <span class="n">printInfo</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-608"><a href="#-608"><span class="linenos"> 608</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Information about instrument: ticker [</span><span class="si">{}</span><span class="s2">], FIGI [</span><span class="si">{}</span><span class="s2">]</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">],</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">],</span> <span class="n">infoText</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-609"><a href="#-609"><span class="linenos"> 609</span></a>
</span><span id="TinkoffBrokerServer-610"><a href="#-610"><span class="linenos"> 610</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-611"><a href="#-611"><span class="linenos"> 611</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Information about instrument: ticker [</span><span class="si">{}</span><span class="s2">], FIGI [</span><span class="si">{}</span><span class="s2">]</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">],</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">],</span> <span class="n">infoText</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-612"><a href="#-612"><span class="linenos"> 612</span></a>
</span><span id="TinkoffBrokerServer-613"><a href="#-613"><span class="linenos"> 613</span></a>        <span class="k">return</span> <span class="n">infoText</span>
</span><span id="TinkoffBrokerServer-614"><a href="#-614"><span class="linenos"> 614</span></a>
</span><span id="TinkoffBrokerServer-615"><a href="#-615"><span class="linenos"> 615</span></a>    <span class="k">def</span> <span class="nf">SearchByTicker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requestPrice</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">showInfo</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-616"><a href="#-616"><span class="linenos"> 616</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-617"><a href="#-617"><span class="linenos"> 617</span></a><span class="sd">        Search and return raw broker&#39;s information about instrument by it&#39;s ticker.</span>
</span><span id="TinkoffBrokerServer-618"><a href="#-618"><span class="linenos"> 618</span></a><span class="sd">        `ticker` must be define! If debug=True then print all debug messages.</span>
</span><span id="TinkoffBrokerServer-619"><a href="#-619"><span class="linenos"> 619</span></a>
</span><span id="TinkoffBrokerServer-620"><a href="#-620"><span class="linenos"> 620</span></a><span class="sd">        :param requestPrice: if `False` then do not request current price of instrument (because this is long operation).</span>
</span><span id="TinkoffBrokerServer-621"><a href="#-621"><span class="linenos"> 621</span></a><span class="sd">        :param showInfo: if `False` then do not run `ShowInstrumentInfo()` method and do not print info to the console.</span>
</span><span id="TinkoffBrokerServer-622"><a href="#-622"><span class="linenos"> 622</span></a><span class="sd">        :param debug: if `True` then print all debug console messages.</span>
</span><span id="TinkoffBrokerServer-623"><a href="#-623"><span class="linenos"> 623</span></a><span class="sd">        :return: JSON formatted data with information about instrument.</span>
</span><span id="TinkoffBrokerServer-624"><a href="#-624"><span class="linenos"> 624</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-625"><a href="#-625"><span class="linenos"> 625</span></a>        <span class="n">tickerJSON</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="TinkoffBrokerServer-626"><a href="#-626"><span class="linenos"> 626</span></a>        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-627"><a href="#-627"><span class="linenos"> 627</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Searching information about instrument by it&#39;s ticker [</span><span class="si">{}</span><span class="s2">] ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-628"><a href="#-628"><span class="linenos"> 628</span></a>
</span><span id="TinkoffBrokerServer-629"><a href="#-629"><span class="linenos"> 629</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-630"><a href="#-630"><span class="linenos"> 630</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;self.ticker variable is not be empty!&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-631"><a href="#-631"><span class="linenos"> 631</span></a>
</span><span id="TinkoffBrokerServer-632"><a href="#-632"><span class="linenos"> 632</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-633"><a href="#-633"><span class="linenos"> 633</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-634"><a href="#-634"><span class="linenos"> 634</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">iList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Listing</span><span class="p">()</span>
</span><span id="TinkoffBrokerServer-635"><a href="#-635"><span class="linenos"> 635</span></a>
</span><span id="TinkoffBrokerServer-636"><a href="#-636"><span class="linenos"> 636</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Shares&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-637"><a href="#-637"><span class="linenos"> 637</span></a>                <span class="n">tickerJSON</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Shares&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer-638"><a href="#-638"><span class="linenos"> 638</span></a>                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-639"><a href="#-639"><span class="linenos"> 639</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Ticker [</span><span class="si">{}</span><span class="s2">] found in stocks list&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-640"><a href="#-640"><span class="linenos"> 640</span></a>
</span><span id="TinkoffBrokerServer-641"><a href="#-641"><span class="linenos"> 641</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Currencies&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-642"><a href="#-642"><span class="linenos"> 642</span></a>                <span class="n">tickerJSON</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Currencies&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer-643"><a href="#-643"><span class="linenos"> 643</span></a>                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-644"><a href="#-644"><span class="linenos"> 644</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Ticker [</span><span class="si">{}</span><span class="s2">] found in currencies list&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-645"><a href="#-645"><span class="linenos"> 645</span></a>
</span><span id="TinkoffBrokerServer-646"><a href="#-646"><span class="linenos"> 646</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Bonds&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-647"><a href="#-647"><span class="linenos"> 647</span></a>                <span class="n">tickerJSON</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Bonds&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer-648"><a href="#-648"><span class="linenos"> 648</span></a>                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-649"><a href="#-649"><span class="linenos"> 649</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Ticker [</span><span class="si">{}</span><span class="s2">] found in bonds list&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-650"><a href="#-650"><span class="linenos"> 650</span></a>
</span><span id="TinkoffBrokerServer-651"><a href="#-651"><span class="linenos"> 651</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Etfs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-652"><a href="#-652"><span class="linenos"> 652</span></a>                <span class="n">tickerJSON</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Etfs&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer-653"><a href="#-653"><span class="linenos"> 653</span></a>                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-654"><a href="#-654"><span class="linenos"> 654</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Ticker [</span><span class="si">{}</span><span class="s2">] found in etfs list&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-655"><a href="#-655"><span class="linenos"> 655</span></a>
</span><span id="TinkoffBrokerServer-656"><a href="#-656"><span class="linenos"> 656</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Futures&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-657"><a href="#-657"><span class="linenos"> 657</span></a>                <span class="n">tickerJSON</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Futures&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer-658"><a href="#-658"><span class="linenos"> 658</span></a>                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-659"><a href="#-659"><span class="linenos"> 659</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Ticker [</span><span class="si">{}</span><span class="s2">] found in futures list&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-660"><a href="#-660"><span class="linenos"> 660</span></a>
</span><span id="TinkoffBrokerServer-661"><a href="#-661"><span class="linenos"> 661</span></a>        <span class="k">if</span> <span class="n">tickerJSON</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-662"><a href="#-662"><span class="linenos"> 662</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">=</span> <span class="n">tickerJSON</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer-663"><a href="#-663"><span class="linenos"> 663</span></a>
</span><span id="TinkoffBrokerServer-664"><a href="#-664"><span class="linenos"> 664</span></a>            <span class="k">if</span> <span class="n">requestPrice</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-665"><a href="#-665"><span class="linenos"> 665</span></a>                <span class="n">tickerJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetCurrentPrices</span><span class="p">(</span><span class="n">showPrice</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-666"><a href="#-666"><span class="linenos"> 666</span></a>
</span><span id="TinkoffBrokerServer-667"><a href="#-667"><span class="linenos"> 667</span></a>                <span class="k">if</span> <span class="n">tickerJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;closePrice&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tickerJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;closePrice&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">tickerJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-668"><a href="#-668"><span class="linenos"> 668</span></a>                    <span class="n">tickerJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;changes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">tickerJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">tickerJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;closePrice&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="n">tickerJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;closePrice&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer-669"><a href="#-669"><span class="linenos"> 669</span></a>
</span><span id="TinkoffBrokerServer-670"><a href="#-670"><span class="linenos"> 670</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-671"><a href="#-671"><span class="linenos"> 671</span></a>                    <span class="n">tickerJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;changes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="TinkoffBrokerServer-672"><a href="#-672"><span class="linenos"> 672</span></a>
</span><span id="TinkoffBrokerServer-673"><a href="#-673"><span class="linenos"> 673</span></a>            <span class="k">if</span> <span class="n">showInfo</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-674"><a href="#-674"><span class="linenos"> 674</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">ShowInstrumentInfo</span><span class="p">(</span><span class="n">iJSON</span><span class="o">=</span><span class="n">tickerJSON</span><span class="p">,</span> <span class="n">printInfo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># print info as Markdown text</span>
</span><span id="TinkoffBrokerServer-675"><a href="#-675"><span class="linenos"> 675</span></a>
</span><span id="TinkoffBrokerServer-676"><a href="#-676"><span class="linenos"> 676</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-677"><a href="#-677"><span class="linenos"> 677</span></a>            <span class="k">if</span> <span class="n">showInfo</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-678"><a href="#-678"><span class="linenos"> 678</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Ticker [</span><span class="si">{}</span><span class="s2">] not found in available broker instrument&#39;s list!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-679"><a href="#-679"><span class="linenos"> 679</span></a>
</span><span id="TinkoffBrokerServer-680"><a href="#-680"><span class="linenos"> 680</span></a>        <span class="k">return</span> <span class="n">tickerJSON</span>
</span><span id="TinkoffBrokerServer-681"><a href="#-681"><span class="linenos"> 681</span></a>
</span><span id="TinkoffBrokerServer-682"><a href="#-682"><span class="linenos"> 682</span></a>    <span class="k">def</span> <span class="nf">SearchByFIGI</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requestPrice</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">showInfo</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-683"><a href="#-683"><span class="linenos"> 683</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-684"><a href="#-684"><span class="linenos"> 684</span></a><span class="sd">        Search and return raw broker&#39;s information about instrument by it&#39;s FIGI.</span>
</span><span id="TinkoffBrokerServer-685"><a href="#-685"><span class="linenos"> 685</span></a><span class="sd">        `figi` must be define! If debug=True then print all debug messages.</span>
</span><span id="TinkoffBrokerServer-686"><a href="#-686"><span class="linenos"> 686</span></a>
</span><span id="TinkoffBrokerServer-687"><a href="#-687"><span class="linenos"> 687</span></a><span class="sd">        :param requestPrice: if `False` then do not request current price of instrument (it&#39;s long operation).</span>
</span><span id="TinkoffBrokerServer-688"><a href="#-688"><span class="linenos"> 688</span></a><span class="sd">        :param showInfo: if `False` then do not run `ShowInstrumentInfo()` method and do not print info to the console.</span>
</span><span id="TinkoffBrokerServer-689"><a href="#-689"><span class="linenos"> 689</span></a><span class="sd">        :param debug: if `True` then print all debug console messages.</span>
</span><span id="TinkoffBrokerServer-690"><a href="#-690"><span class="linenos"> 690</span></a><span class="sd">        :return: JSON formatted data with information about instrument.</span>
</span><span id="TinkoffBrokerServer-691"><a href="#-691"><span class="linenos"> 691</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-692"><a href="#-692"><span class="linenos"> 692</span></a>        <span class="n">figiJSON</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="TinkoffBrokerServer-693"><a href="#-693"><span class="linenos"> 693</span></a>        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-694"><a href="#-694"><span class="linenos"> 694</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Searching information about instrument by it&#39;s FIGI [</span><span class="si">{}</span><span class="s2">] ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-695"><a href="#-695"><span class="linenos"> 695</span></a>
</span><span id="TinkoffBrokerServer-696"><a href="#-696"><span class="linenos"> 696</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-697"><a href="#-697"><span class="linenos"> 697</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;self.figi variable is not be empty!&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-698"><a href="#-698"><span class="linenos"> 698</span></a>
</span><span id="TinkoffBrokerServer-699"><a href="#-699"><span class="linenos"> 699</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-700"><a href="#-700"><span class="linenos"> 700</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-701"><a href="#-701"><span class="linenos"> 701</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">iList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Listing</span><span class="p">()</span>
</span><span id="TinkoffBrokerServer-702"><a href="#-702"><span class="linenos"> 702</span></a>
</span><span id="TinkoffBrokerServer-703"><a href="#-703"><span class="linenos"> 703</span></a>            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Shares&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-704"><a href="#-704"><span class="linenos"> 704</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Shares&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">][</span><span class="s2">&quot;figi&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-705"><a href="#-705"><span class="linenos"> 705</span></a>                    <span class="n">figiJSON</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Shares&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer-706"><a href="#-706"><span class="linenos"> 706</span></a>
</span><span id="TinkoffBrokerServer-707"><a href="#-707"><span class="linenos"> 707</span></a>                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-708"><a href="#-708"><span class="linenos"> 708</span></a>                        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;FIGI [</span><span class="si">{}</span><span class="s2">] found in stocks list&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-709"><a href="#-709"><span class="linenos"> 709</span></a>
</span><span id="TinkoffBrokerServer-710"><a href="#-710"><span class="linenos"> 710</span></a>                    <span class="k">break</span>
</span><span id="TinkoffBrokerServer-711"><a href="#-711"><span class="linenos"> 711</span></a>
</span><span id="TinkoffBrokerServer-712"><a href="#-712"><span class="linenos"> 712</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">figiJSON</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-713"><a href="#-713"><span class="linenos"> 713</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Currencies&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-714"><a href="#-714"><span class="linenos"> 714</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Currencies&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">][</span><span class="s2">&quot;figi&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-715"><a href="#-715"><span class="linenos"> 715</span></a>                        <span class="n">figiJSON</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Currencies&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer-716"><a href="#-716"><span class="linenos"> 716</span></a>
</span><span id="TinkoffBrokerServer-717"><a href="#-717"><span class="linenos"> 717</span></a>                        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-718"><a href="#-718"><span class="linenos"> 718</span></a>                            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;FIGI [</span><span class="si">{}</span><span class="s2">] found in currencies list&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-719"><a href="#-719"><span class="linenos"> 719</span></a>
</span><span id="TinkoffBrokerServer-720"><a href="#-720"><span class="linenos"> 720</span></a>                        <span class="k">break</span>
</span><span id="TinkoffBrokerServer-721"><a href="#-721"><span class="linenos"> 721</span></a>
</span><span id="TinkoffBrokerServer-722"><a href="#-722"><span class="linenos"> 722</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">figiJSON</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-723"><a href="#-723"><span class="linenos"> 723</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Bonds&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-724"><a href="#-724"><span class="linenos"> 724</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Bonds&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">][</span><span class="s2">&quot;figi&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-725"><a href="#-725"><span class="linenos"> 725</span></a>                        <span class="n">figiJSON</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Bonds&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer-726"><a href="#-726"><span class="linenos"> 726</span></a>
</span><span id="TinkoffBrokerServer-727"><a href="#-727"><span class="linenos"> 727</span></a>                        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-728"><a href="#-728"><span class="linenos"> 728</span></a>                            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;FIGI [</span><span class="si">{}</span><span class="s2">] found in bonds list&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-729"><a href="#-729"><span class="linenos"> 729</span></a>
</span><span id="TinkoffBrokerServer-730"><a href="#-730"><span class="linenos"> 730</span></a>                        <span class="k">break</span>
</span><span id="TinkoffBrokerServer-731"><a href="#-731"><span class="linenos"> 731</span></a>
</span><span id="TinkoffBrokerServer-732"><a href="#-732"><span class="linenos"> 732</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">figiJSON</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-733"><a href="#-733"><span class="linenos"> 733</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Etfs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-734"><a href="#-734"><span class="linenos"> 734</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Etfs&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">][</span><span class="s2">&quot;figi&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-735"><a href="#-735"><span class="linenos"> 735</span></a>                        <span class="n">figiJSON</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Etfs&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer-736"><a href="#-736"><span class="linenos"> 736</span></a>
</span><span id="TinkoffBrokerServer-737"><a href="#-737"><span class="linenos"> 737</span></a>                        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-738"><a href="#-738"><span class="linenos"> 738</span></a>                            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;FIGI [</span><span class="si">{}</span><span class="s2">] found in etfs list&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-739"><a href="#-739"><span class="linenos"> 739</span></a>
</span><span id="TinkoffBrokerServer-740"><a href="#-740"><span class="linenos"> 740</span></a>                        <span class="k">break</span>
</span><span id="TinkoffBrokerServer-741"><a href="#-741"><span class="linenos"> 741</span></a>
</span><span id="TinkoffBrokerServer-742"><a href="#-742"><span class="linenos"> 742</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">figiJSON</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-743"><a href="#-743"><span class="linenos"> 743</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Futures&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-744"><a href="#-744"><span class="linenos"> 744</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Futures&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">][</span><span class="s2">&quot;figi&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-745"><a href="#-745"><span class="linenos"> 745</span></a>                        <span class="n">figiJSON</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Futures&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer-746"><a href="#-746"><span class="linenos"> 746</span></a>
</span><span id="TinkoffBrokerServer-747"><a href="#-747"><span class="linenos"> 747</span></a>                        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-748"><a href="#-748"><span class="linenos"> 748</span></a>                            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;FIGI [</span><span class="si">{}</span><span class="s2">] found in futures list&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-749"><a href="#-749"><span class="linenos"> 749</span></a>
</span><span id="TinkoffBrokerServer-750"><a href="#-750"><span class="linenos"> 750</span></a>                        <span class="k">break</span>
</span><span id="TinkoffBrokerServer-751"><a href="#-751"><span class="linenos"> 751</span></a>
</span><span id="TinkoffBrokerServer-752"><a href="#-752"><span class="linenos"> 752</span></a>        <span class="k">if</span> <span class="n">figiJSON</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-753"><a href="#-753"><span class="linenos"> 753</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">=</span> <span class="n">figiJSON</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer-754"><a href="#-754"><span class="linenos"> 754</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">figiJSON</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer-755"><a href="#-755"><span class="linenos"> 755</span></a>
</span><span id="TinkoffBrokerServer-756"><a href="#-756"><span class="linenos"> 756</span></a>            <span class="k">if</span> <span class="n">requestPrice</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-757"><a href="#-757"><span class="linenos"> 757</span></a>                <span class="n">figiJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetCurrentPrices</span><span class="p">(</span><span class="n">showPrice</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-758"><a href="#-758"><span class="linenos"> 758</span></a>
</span><span id="TinkoffBrokerServer-759"><a href="#-759"><span class="linenos"> 759</span></a>                <span class="k">if</span> <span class="n">figiJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;closePrice&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">figiJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;closePrice&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">figiJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-760"><a href="#-760"><span class="linenos"> 760</span></a>                    <span class="n">figiJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;changes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">figiJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">figiJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;closePrice&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="n">figiJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;closePrice&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer-761"><a href="#-761"><span class="linenos"> 761</span></a>
</span><span id="TinkoffBrokerServer-762"><a href="#-762"><span class="linenos"> 762</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-763"><a href="#-763"><span class="linenos"> 763</span></a>                    <span class="n">figiJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;changes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="TinkoffBrokerServer-764"><a href="#-764"><span class="linenos"> 764</span></a>
</span><span id="TinkoffBrokerServer-765"><a href="#-765"><span class="linenos"> 765</span></a>            <span class="k">if</span> <span class="n">showInfo</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-766"><a href="#-766"><span class="linenos"> 766</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">ShowInstrumentInfo</span><span class="p">(</span><span class="n">iJSON</span><span class="o">=</span><span class="n">figiJSON</span><span class="p">,</span> <span class="n">printInfo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># print info as Markdown text</span>
</span><span id="TinkoffBrokerServer-767"><a href="#-767"><span class="linenos"> 767</span></a>
</span><span id="TinkoffBrokerServer-768"><a href="#-768"><span class="linenos"> 768</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-769"><a href="#-769"><span class="linenos"> 769</span></a>            <span class="k">if</span> <span class="n">showInfo</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-770"><a href="#-770"><span class="linenos"> 770</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;FIGI [</span><span class="si">{}</span><span class="s2">] not found in available broker instrument&#39;s list!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-771"><a href="#-771"><span class="linenos"> 771</span></a>
</span><span id="TinkoffBrokerServer-772"><a href="#-772"><span class="linenos"> 772</span></a>        <span class="k">return</span> <span class="n">figiJSON</span>
</span><span id="TinkoffBrokerServer-773"><a href="#-773"><span class="linenos"> 773</span></a>
</span><span id="TinkoffBrokerServer-774"><a href="#-774"><span class="linenos"> 774</span></a>    <span class="k">def</span> <span class="nf">GetCurrentPrices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">showPrice</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-775"><a href="#-775"><span class="linenos"> 775</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-776"><a href="#-776"><span class="linenos"> 776</span></a><span class="sd">        Get and show Depth of Market with current prices of the instrument. If an error occurred then returns an empty record:</span>
</span><span id="TinkoffBrokerServer-777"><a href="#-777"><span class="linenos"> 777</span></a><span class="sd">        `{&quot;buy&quot;: [], &quot;sell&quot;: [], &quot;limitUp&quot;: None, &quot;limitDown&quot;: None, &quot;lastPrice&quot;: None, &quot;closePrice&quot;: None}`.</span>
</span><span id="TinkoffBrokerServer-778"><a href="#-778"><span class="linenos"> 778</span></a>
</span><span id="TinkoffBrokerServer-779"><a href="#-779"><span class="linenos"> 779</span></a><span class="sd">        :param showPrice: if `True` then print DOM.</span>
</span><span id="TinkoffBrokerServer-780"><a href="#-780"><span class="linenos"> 780</span></a><span class="sd">        :return: dict with Depth of Market (DOM): `{&quot;buy&quot;: [{&quot;price&quot;: x1, &quot;quantity&quot;: y1, ...}], &quot;sell&quot;: [....]}` with list of current prices.</span>
</span><span id="TinkoffBrokerServer-781"><a href="#-781"><span class="linenos"> 781</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-782"><a href="#-782"><span class="linenos"> 782</span></a>        <span class="n">prices</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;buy&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;sell&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;limitUp&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;limitDown&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;lastPrice&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;closePrice&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
</span><span id="TinkoffBrokerServer-783"><a href="#-783"><span class="linenos"> 783</span></a>
</span><span id="TinkoffBrokerServer-784"><a href="#-784"><span class="linenos"> 784</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-785"><a href="#-785"><span class="linenos"> 785</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Depth of Market (DOM) must be &gt;=1!&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-786"><a href="#-786"><span class="linenos"> 786</span></a>
</span><span id="TinkoffBrokerServer-787"><a href="#-787"><span class="linenos"> 787</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">):</span>
</span><span id="TinkoffBrokerServer-788"><a href="#-788"><span class="linenos"> 788</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;self.ticker or self.figi variables must be defined!&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-789"><a href="#-789"><span class="linenos"> 789</span></a>
</span><span id="TinkoffBrokerServer-790"><a href="#-790"><span class="linenos"> 790</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-791"><a href="#-791"><span class="linenos"> 791</span></a>            <span class="n">instrumentByTicker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SearchByTicker</span><span class="p">(</span><span class="n">requestPrice</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># WARNING! requestPrice=False to avoid recursion!</span>
</span><span id="TinkoffBrokerServer-792"><a href="#-792"><span class="linenos"> 792</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">=</span> <span class="n">instrumentByTicker</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">instrumentByTicker</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-793"><a href="#-793"><span class="linenos"> 793</span></a>
</span><span id="TinkoffBrokerServer-794"><a href="#-794"><span class="linenos"> 794</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-795"><a href="#-795"><span class="linenos"> 795</span></a>            <span class="n">instrumentByFigi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SearchByFIGI</span><span class="p">(</span><span class="n">requestPrice</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># WARNING! requestPrice=False to avoid recursion!</span>
</span><span id="TinkoffBrokerServer-796"><a href="#-796"><span class="linenos"> 796</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">instrumentByFigi</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">instrumentByFigi</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-797"><a href="#-797"><span class="linenos"> 797</span></a>
</span><span id="TinkoffBrokerServer-798"><a href="#-798"><span class="linenos"> 798</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-799"><a href="#-799"><span class="linenos"> 799</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Requesting current prices for instrument with ticker [</span><span class="si">{}</span><span class="s2">] and FIGI [</span><span class="si">{}</span><span class="s2">]...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-800"><a href="#-800"><span class="linenos"> 800</span></a>
</span><span id="TinkoffBrokerServer-801"><a href="#-801"><span class="linenos"> 801</span></a>            <span class="c1"># REST API for request: https://tinkoff.github.io/investAPI/swagger-ui/#/MarketDataService/MarketDataService_GetOrderBook</span>
</span><span id="TinkoffBrokerServer-802"><a href="#-802"><span class="linenos"> 802</span></a>            <span class="n">priceURL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;/tinkoff.public.invest.api.contract.v1.MarketDataService/GetOrderBook&quot;</span>
</span><span id="TinkoffBrokerServer-803"><a href="#-803"><span class="linenos"> 803</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="nb">str</span><span class="p">({</span><span class="s2">&quot;figi&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">,</span> <span class="s2">&quot;depth&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">})</span>
</span><span id="TinkoffBrokerServer-804"><a href="#-804"><span class="linenos"> 804</span></a>            <span class="n">pricesResponse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SendAPIRequest</span><span class="p">(</span><span class="n">priceURL</span><span class="p">,</span> <span class="n">reqType</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-805"><a href="#-805"><span class="linenos"> 805</span></a>
</span><span id="TinkoffBrokerServer-806"><a href="#-806"><span class="linenos"> 806</span></a>            <span class="k">if</span> <span class="n">pricesResponse</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-807"><a href="#-807"><span class="linenos"> 807</span></a>                <span class="c1"># list of dicts with sellers orders:</span>
</span><span id="TinkoffBrokerServer-808"><a href="#-808"><span class="linenos"> 808</span></a>                <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;buy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">]),</span> <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;quantity&quot;</span><span class="p">])}</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">pricesResponse</span><span class="p">[</span><span class="s2">&quot;asks&quot;</span><span class="p">]]</span>
</span><span id="TinkoffBrokerServer-809"><a href="#-809"><span class="linenos"> 809</span></a>
</span><span id="TinkoffBrokerServer-810"><a href="#-810"><span class="linenos"> 810</span></a>                <span class="c1"># list of dicts with buyers orders:</span>
</span><span id="TinkoffBrokerServer-811"><a href="#-811"><span class="linenos"> 811</span></a>                <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;sell&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">]),</span> <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;quantity&quot;</span><span class="p">])}</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">pricesResponse</span><span class="p">[</span><span class="s2">&quot;bids&quot;</span><span class="p">]]</span>
</span><span id="TinkoffBrokerServer-812"><a href="#-812"><span class="linenos"> 812</span></a>
</span><span id="TinkoffBrokerServer-813"><a href="#-813"><span class="linenos"> 813</span></a>                <span class="c1"># max price of instrument at this time:</span>
</span><span id="TinkoffBrokerServer-814"><a href="#-814"><span class="linenos"> 814</span></a>                <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;limitUp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">pricesResponse</span><span class="p">[</span><span class="s2">&quot;limitUp&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">pricesResponse</span><span class="p">[</span><span class="s2">&quot;limitUp&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;limitUp&quot;</span> <span class="ow">in</span> <span class="n">pricesResponse</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="TinkoffBrokerServer-815"><a href="#-815"><span class="linenos"> 815</span></a>
</span><span id="TinkoffBrokerServer-816"><a href="#-816"><span class="linenos"> 816</span></a>                <span class="c1"># min price of instrument at this time:</span>
</span><span id="TinkoffBrokerServer-817"><a href="#-817"><span class="linenos"> 817</span></a>                <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;limitDown&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">pricesResponse</span><span class="p">[</span><span class="s2">&quot;limitDown&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">pricesResponse</span><span class="p">[</span><span class="s2">&quot;limitDown&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;limitDown&quot;</span> <span class="ow">in</span> <span class="n">pricesResponse</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="TinkoffBrokerServer-818"><a href="#-818"><span class="linenos"> 818</span></a>
</span><span id="TinkoffBrokerServer-819"><a href="#-819"><span class="linenos"> 819</span></a>                <span class="c1"># last price of deal with instrument:</span>
</span><span id="TinkoffBrokerServer-820"><a href="#-820"><span class="linenos"> 820</span></a>                <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">pricesResponse</span><span class="p">[</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">pricesResponse</span><span class="p">[</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;lastPrice&quot;</span> <span class="ow">in</span> <span class="n">pricesResponse</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="TinkoffBrokerServer-821"><a href="#-821"><span class="linenos"> 821</span></a>
</span><span id="TinkoffBrokerServer-822"><a href="#-822"><span class="linenos"> 822</span></a>                <span class="c1"># last close price of instrument:</span>
</span><span id="TinkoffBrokerServer-823"><a href="#-823"><span class="linenos"> 823</span></a>                <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;closePrice&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">pricesResponse</span><span class="p">[</span><span class="s2">&quot;closePrice&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">pricesResponse</span><span class="p">[</span><span class="s2">&quot;closePrice&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;closePrice&quot;</span> <span class="ow">in</span> <span class="n">pricesResponse</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="TinkoffBrokerServer-824"><a href="#-824"><span class="linenos"> 824</span></a>
</span><span id="TinkoffBrokerServer-825"><a href="#-825"><span class="linenos"> 825</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-826"><a href="#-826"><span class="linenos"> 826</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Server return an empty or error response! See full log. Instrument: ticker [</span><span class="si">{}</span><span class="s2">], FIGI [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-827"><a href="#-827"><span class="linenos"> 827</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Server response: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pricesResponse</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-828"><a href="#-828"><span class="linenos"> 828</span></a>
</span><span id="TinkoffBrokerServer-829"><a href="#-829"><span class="linenos"> 829</span></a>            <span class="k">if</span> <span class="n">showPrice</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-830"><a href="#-830"><span class="linenos"> 830</span></a>                <span class="k">if</span> <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;buy&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;sell&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-831"><a href="#-831"><span class="linenos"> 831</span></a>                    <span class="n">info</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="TinkoffBrokerServer-832"><a href="#-832"><span class="linenos"> 832</span></a>                        <span class="s2">&quot;Orders book actual at [</span><span class="si">{}</span><span class="s2">] (UTC)</span><span class="se">\n</span><span class="s2">Ticker: [</span><span class="si">{}</span><span class="s2">], FIGI: [</span><span class="si">{}</span><span class="s2">], Depth of Market: [</span><span class="si">{}</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-833"><a href="#-833"><span class="linenos"> 833</span></a>                            <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tzutc</span><span class="p">())</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">),</span>
</span><span id="TinkoffBrokerServer-834"><a href="#-834"><span class="linenos"> 834</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-835"><a href="#-835"><span class="linenos"> 835</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-836"><a href="#-836"><span class="linenos"> 836</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-837"><a href="#-837"><span class="linenos"> 837</span></a>                        <span class="p">),</span>
</span><span id="TinkoffBrokerServer-838"><a href="#-838"><span class="linenos"> 838</span></a>                        <span class="n">uLog</span><span class="o">.</span><span class="n">sepShort</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-839"><a href="#-839"><span class="linenos"> 839</span></a>                        <span class="s2">&quot; Orders of Buyers   | Orders of Sellers</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-840"><a href="#-840"><span class="linenos"> 840</span></a>                        <span class="n">uLog</span><span class="o">.</span><span class="n">sepShort</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-841"><a href="#-841"><span class="linenos"> 841</span></a>                        <span class="s2">&quot; Sell prices (vol.) | Buy prices (vol.)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-842"><a href="#-842"><span class="linenos"> 842</span></a>                        <span class="n">uLog</span><span class="o">.</span><span class="n">sepShort</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-843"><a href="#-843"><span class="linenos"> 843</span></a>                    <span class="p">]</span>
</span><span id="TinkoffBrokerServer-844"><a href="#-844"><span class="linenos"> 844</span></a>
</span><span id="TinkoffBrokerServer-845"><a href="#-845"><span class="linenos"> 845</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;buy&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-846"><a href="#-846"><span class="linenos"> 846</span></a>                        <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;                    | No orders!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-847"><a href="#-847"><span class="linenos"> 847</span></a>                        <span class="n">sumBuy</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="TinkoffBrokerServer-848"><a href="#-848"><span class="linenos"> 848</span></a>
</span><span id="TinkoffBrokerServer-849"><a href="#-849"><span class="linenos"> 849</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-850"><a href="#-850"><span class="linenos"> 850</span></a>                        <span class="n">sumBuy</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;quantity&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;buy&quot;</span><span class="p">]])</span>
</span><span id="TinkoffBrokerServer-851"><a href="#-851"><span class="linenos"> 851</span></a>                        <span class="n">maxMinSorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">prices</span><span class="p">[</span><span class="s2">&quot;buy&quot;</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">k</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-852"><a href="#-852"><span class="linenos"> 852</span></a>                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">maxMinSorted</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-853"><a href="#-853"><span class="linenos"> 853</span></a>                            <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;                    | </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;quantity&quot;</span><span class="p">]))</span>
</span><span id="TinkoffBrokerServer-854"><a href="#-854"><span class="linenos"> 854</span></a>
</span><span id="TinkoffBrokerServer-855"><a href="#-855"><span class="linenos"> 855</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;sell&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-856"><a href="#-856"><span class="linenos"> 856</span></a>                        <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;No orders!          |</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-857"><a href="#-857"><span class="linenos"> 857</span></a>                        <span class="n">sumSell</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="TinkoffBrokerServer-858"><a href="#-858"><span class="linenos"> 858</span></a>
</span><span id="TinkoffBrokerServer-859"><a href="#-859"><span class="linenos"> 859</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-860"><a href="#-860"><span class="linenos"> 860</span></a>                        <span class="n">sumSell</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;quantity&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;sell&quot;</span><span class="p">]])</span>
</span><span id="TinkoffBrokerServer-861"><a href="#-861"><span class="linenos"> 861</span></a>                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;sell&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-862"><a href="#-862"><span class="linenos"> 862</span></a>                            <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:&gt;19}</span><span class="s2"> |</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;quantity&quot;</span><span class="p">])))</span>
</span><span id="TinkoffBrokerServer-863"><a href="#-863"><span class="linenos"> 863</span></a>
</span><span id="TinkoffBrokerServer-864"><a href="#-864"><span class="linenos"> 864</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span><span id="TinkoffBrokerServer-865"><a href="#-865"><span class="linenos"> 865</span></a>                        <span class="n">uLog</span><span class="o">.</span><span class="n">sepShort</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-866"><a href="#-866"><span class="linenos"> 866</span></a>                        <span class="s2">&quot;</span><span class="si">{:&gt;19}</span><span class="s2"> | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Total sell: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sumSell</span><span class="p">),</span> <span class="s2">&quot;Total buy: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sumBuy</span><span class="p">)),</span>
</span><span id="TinkoffBrokerServer-867"><a href="#-867"><span class="linenos"> 867</span></a>                        <span class="n">uLog</span><span class="o">.</span><span class="n">sepShort</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-868"><a href="#-868"><span class="linenos"> 868</span></a>                    <span class="p">])</span>
</span><span id="TinkoffBrokerServer-869"><a href="#-869"><span class="linenos"> 869</span></a>
</span><span id="TinkoffBrokerServer-870"><a href="#-870"><span class="linenos"> 870</span></a>                    <span class="n">infoText</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-871"><a href="#-871"><span class="linenos"> 871</span></a>
</span><span id="TinkoffBrokerServer-872"><a href="#-872"><span class="linenos"> 872</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Current prices in order book:</span><span class="se">\n\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">infoText</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-873"><a href="#-873"><span class="linenos"> 873</span></a>
</span><span id="TinkoffBrokerServer-874"><a href="#-874"><span class="linenos"> 874</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-875"><a href="#-875"><span class="linenos"> 875</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Orders book is empty at this time! Instrument: ticker [</span><span class="si">{}</span><span class="s2">], FIGI [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-876"><a href="#-876"><span class="linenos"> 876</span></a>
</span><span id="TinkoffBrokerServer-877"><a href="#-877"><span class="linenos"> 877</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-878"><a href="#-878"><span class="linenos"> 878</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;FIGI is not defined!&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-879"><a href="#-879"><span class="linenos"> 879</span></a>
</span><span id="TinkoffBrokerServer-880"><a href="#-880"><span class="linenos"> 880</span></a>        <span class="k">return</span> <span class="n">prices</span>
</span><span id="TinkoffBrokerServer-881"><a href="#-881"><span class="linenos"> 881</span></a>
</span><span id="TinkoffBrokerServer-882"><a href="#-882"><span class="linenos"> 882</span></a>    <span class="k">def</span> <span class="nf">ShowInstrumentsInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">showInstruments</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-883"><a href="#-883"><span class="linenos"> 883</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-884"><a href="#-884"><span class="linenos"> 884</span></a><span class="sd">        This method get and show information about all available broker instruments.</span>
</span><span id="TinkoffBrokerServer-885"><a href="#-885"><span class="linenos"> 885</span></a><span class="sd">        If `instrumentsFile` string is not empty then also save information to this file.</span>
</span><span id="TinkoffBrokerServer-886"><a href="#-886"><span class="linenos"> 886</span></a>
</span><span id="TinkoffBrokerServer-887"><a href="#-887"><span class="linenos"> 887</span></a><span class="sd">        :param showInstruments: if `True` then print to console, if `False` - print only to file.</span>
</span><span id="TinkoffBrokerServer-888"><a href="#-888"><span class="linenos"> 888</span></a><span class="sd">        :return: multi-string with all available broker instruments</span>
</span><span id="TinkoffBrokerServer-889"><a href="#-889"><span class="linenos"> 889</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-890"><a href="#-890"><span class="linenos"> 890</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-891"><a href="#-891"><span class="linenos"> 891</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">iList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Listing</span><span class="p">()</span>
</span><span id="TinkoffBrokerServer-892"><a href="#-892"><span class="linenos"> 892</span></a>
</span><span id="TinkoffBrokerServer-893"><a href="#-893"><span class="linenos"> 893</span></a>        <span class="n">info</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="TinkoffBrokerServer-894"><a href="#-894"><span class="linenos"> 894</span></a>            <span class="s2">&quot;# All available instruments from Tinkoff Broker server for current user token</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-895"><a href="#-895"><span class="linenos"> 895</span></a>            <span class="s2">&quot;* **Actual on date:** [</span><span class="si">{}</span><span class="s2">] (UTC)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tzutc</span><span class="p">())</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M&quot;</span><span class="p">)),</span>
</span><span id="TinkoffBrokerServer-896"><a href="#-896"><span class="linenos"> 896</span></a>        <span class="p">]</span>
</span><span id="TinkoffBrokerServer-897"><a href="#-897"><span class="linenos"> 897</span></a>
</span><span id="TinkoffBrokerServer-898"><a href="#-898"><span class="linenos"> 898</span></a>        <span class="c1"># add instruments count by type:</span>
</span><span id="TinkoffBrokerServer-899"><a href="#-899"><span class="linenos"> 899</span></a>        <span class="k">for</span> <span class="n">iType</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-900"><a href="#-900"><span class="linenos"> 900</span></a>            <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;* **</span><span class="si">{}</span><span class="s2">:** [</span><span class="si">{}</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iType</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">])))</span>
</span><span id="TinkoffBrokerServer-901"><a href="#-901"><span class="linenos"> 901</span></a>
</span><span id="TinkoffBrokerServer-902"><a href="#-902"><span class="linenos"> 902</span></a>        <span class="n">headerLine</span> <span class="o">=</span> <span class="s2">&quot;| Ticker       | Full name                                                      | FIGI         | Cur | Lot    | Step</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="TinkoffBrokerServer-903"><a href="#-903"><span class="linenos"> 903</span></a>        <span class="n">splitLine</span> <span class="o">=</span> <span class="s2">&quot;|--------------|----------------------------------------------------------------|--------------|-----|--------|---------</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="TinkoffBrokerServer-904"><a href="#-904"><span class="linenos"> 904</span></a>
</span><span id="TinkoffBrokerServer-905"><a href="#-905"><span class="linenos"> 905</span></a>        <span class="c1"># generate info tables with all instruments by type:</span>
</span><span id="TinkoffBrokerServer-906"><a href="#-906"><span class="linenos"> 906</span></a>        <span class="k">for</span> <span class="n">iType</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-907"><a href="#-907"><span class="linenos"> 907</span></a>            <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">## </span><span class="si">{}</span><span class="s2"> available. Total: [</span><span class="si">{}</span><span class="s2">]</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iType</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">])),</span> <span class="n">headerLine</span><span class="p">,</span> <span class="n">splitLine</span><span class="p">])</span>
</span><span id="TinkoffBrokerServer-908"><a href="#-908"><span class="linenos"> 908</span></a>
</span><span id="TinkoffBrokerServer-909"><a href="#-909"><span class="linenos"> 909</span></a>            <span class="k">for</span> <span class="n">instrument</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-910"><a href="#-910"><span class="linenos"> 910</span></a>                <span class="n">iName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">][</span><span class="n">instrument</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>  <span class="c1"># instrument&#39;s name</span>
</span><span id="TinkoffBrokerServer-911"><a href="#-911"><span class="linenos"> 911</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">iName</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">63</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-912"><a href="#-912"><span class="linenos"> 912</span></a>                    <span class="n">iName</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iName</span><span class="p">[:</span><span class="mi">60</span><span class="p">])</span>  <span class="c1"># right trim for a long string</span>
</span><span id="TinkoffBrokerServer-913"><a href="#-913"><span class="linenos"> 913</span></a>    
</span><span id="TinkoffBrokerServer-914"><a href="#-914"><span class="linenos"> 914</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| </span><span class="si">{:&lt;12}</span><span class="s2"> | </span><span class="si">{:&lt;63}</span><span class="s2">| </span><span class="si">{:&lt;13}</span><span class="s2">| </span><span class="si">{:&lt;4}</span><span class="s2">| </span><span class="si">{:&lt;7}</span><span class="s2">| </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-915"><a href="#-915"><span class="linenos"> 915</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">][</span><span class="n">instrument</span><span class="p">][</span><span class="s2">&quot;ticker&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-916"><a href="#-916"><span class="linenos"> 916</span></a>                    <span class="n">iName</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-917"><a href="#-917"><span class="linenos"> 917</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">][</span><span class="n">instrument</span><span class="p">][</span><span class="s2">&quot;figi&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-918"><a href="#-918"><span class="linenos"> 918</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">][</span><span class="n">instrument</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-919"><a href="#-919"><span class="linenos"> 919</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">][</span><span class="n">instrument</span><span class="p">][</span><span class="s2">&quot;lot&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-920"><a href="#-920"><span class="linenos"> 920</span></a>                    <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">][</span><span class="n">instrument</span><span class="p">][</span><span class="s2">&quot;step&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">),</span>
</span><span id="TinkoffBrokerServer-921"><a href="#-921"><span class="linenos"> 921</span></a>                <span class="p">))</span>
</span><span id="TinkoffBrokerServer-922"><a href="#-922"><span class="linenos"> 922</span></a>
</span><span id="TinkoffBrokerServer-923"><a href="#-923"><span class="linenos"> 923</span></a>        <span class="n">infoText</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-924"><a href="#-924"><span class="linenos"> 924</span></a>
</span><span id="TinkoffBrokerServer-925"><a href="#-925"><span class="linenos"> 925</span></a>        <span class="k">if</span> <span class="n">showInstruments</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-926"><a href="#-926"><span class="linenos"> 926</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">infoText</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-927"><a href="#-927"><span class="linenos"> 927</span></a>
</span><span id="TinkoffBrokerServer-928"><a href="#-928"><span class="linenos"> 928</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrumentsFile</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-929"><a href="#-929"><span class="linenos"> 929</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instrumentsFile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fH</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-930"><a href="#-930"><span class="linenos"> 930</span></a>                <span class="n">fH</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">infoText</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-931"><a href="#-931"><span class="linenos"> 931</span></a>
</span><span id="TinkoffBrokerServer-932"><a href="#-932"><span class="linenos"> 932</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;All available instruments are saved to file: [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instrumentsFile</span><span class="p">)))</span>
</span><span id="TinkoffBrokerServer-933"><a href="#-933"><span class="linenos"> 933</span></a>
</span><span id="TinkoffBrokerServer-934"><a href="#-934"><span class="linenos"> 934</span></a>        <span class="k">return</span> <span class="n">infoText</span>
</span><span id="TinkoffBrokerServer-935"><a href="#-935"><span class="linenos"> 935</span></a>
</span><span id="TinkoffBrokerServer-936"><a href="#-936"><span class="linenos"> 936</span></a>    <span class="k">def</span> <span class="nf">GetListOfPrices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instruments</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">showPrices</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-937"><a href="#-937"><span class="linenos"> 937</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-938"><a href="#-938"><span class="linenos"> 938</span></a><span class="sd">        This method get, maybe show and return prices of list of instruments. WARNING! This is potential long operation!</span>
</span><span id="TinkoffBrokerServer-939"><a href="#-939"><span class="linenos"> 939</span></a><span class="sd">        See limits: https://tinkoff.github.io/investAPI/limits/</span>
</span><span id="TinkoffBrokerServer-940"><a href="#-940"><span class="linenos"> 940</span></a><span class="sd">        If `pricesFile` string is not empty then also save information to this file.</span>
</span><span id="TinkoffBrokerServer-941"><a href="#-941"><span class="linenos"> 941</span></a>
</span><span id="TinkoffBrokerServer-942"><a href="#-942"><span class="linenos"> 942</span></a><span class="sd">        :param instruments: list of tickers or FIGIs.</span>
</span><span id="TinkoffBrokerServer-943"><a href="#-943"><span class="linenos"> 943</span></a><span class="sd">        :param showPrices: if `True` then print to console, if `False` - print only to file.</span>
</span><span id="TinkoffBrokerServer-944"><a href="#-944"><span class="linenos"> 944</span></a><span class="sd">        :return: list of instruments looks like this: `iList = [{some ticker info, &quot;currentPrice&quot;: {current prices}}, {...}, ...]`</span>
</span><span id="TinkoffBrokerServer-945"><a href="#-945"><span class="linenos"> 945</span></a><span class="sd">                 One item is dict returned by `SearchByTicker()` or `SearchByFIGI()` methods.</span>
</span><span id="TinkoffBrokerServer-946"><a href="#-946"><span class="linenos"> 946</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-947"><a href="#-947"><span class="linenos"> 947</span></a>        <span class="k">if</span> <span class="n">instruments</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">instruments</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-948"><a href="#-948"><span class="linenos"> 948</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;You must define some of tickers or FIGIs to request it&#39;s actual prices!&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-949"><a href="#-949"><span class="linenos"> 949</span></a>
</span><span id="TinkoffBrokerServer-950"><a href="#-950"><span class="linenos"> 950</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Requesting current prices of list of instruments from Tinkoff Broker server...&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-951"><a href="#-951"><span class="linenos"> 951</span></a>
</span><span id="TinkoffBrokerServer-952"><a href="#-952"><span class="linenos"> 952</span></a>        <span class="n">iList</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="TinkoffBrokerServer-953"><a href="#-953"><span class="linenos"> 953</span></a>        <span class="k">for</span> <span class="n">iName</span> <span class="ow">in</span> <span class="n">instruments</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-954"><a href="#-954"><span class="linenos"> 954</span></a>            <span class="k">if</span> <span class="n">iName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">aliases</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-955"><a href="#-955"><span class="linenos"> 955</span></a>                <span class="n">iList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iName</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-956"><a href="#-956"><span class="linenos"> 956</span></a>
</span><span id="TinkoffBrokerServer-957"><a href="#-957"><span class="linenos"> 957</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-958"><a href="#-958"><span class="linenos"> 958</span></a>                <span class="n">iList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aliases</span><span class="p">[</span><span class="n">iName</span><span class="p">])</span>
</span><span id="TinkoffBrokerServer-959"><a href="#-959"><span class="linenos"> 959</span></a>
</span><span id="TinkoffBrokerServer-960"><a href="#-960"><span class="linenos"> 960</span></a>        <span class="n">unique</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># create list with every figi only one time with the same order position:</span>
</span><span id="TinkoffBrokerServer-961"><a href="#-961"><span class="linenos"> 961</span></a>        <span class="n">tempNames</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">iList</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">item</span> <span class="ow">in</span> <span class="n">unique</span> <span class="ow">or</span> <span class="n">unique</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">))]</span>
</span><span id="TinkoffBrokerServer-962"><a href="#-962"><span class="linenos"> 962</span></a>
</span><span id="TinkoffBrokerServer-963"><a href="#-963"><span class="linenos"> 963</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Ordered input list of instruments without duplicates of names: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tempNames</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-964"><a href="#-964"><span class="linenos"> 964</span></a>
</span><span id="TinkoffBrokerServer-965"><a href="#-965"><span class="linenos"> 965</span></a>        <span class="n">iList</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># try to get info about all unique instruments:</span>
</span><span id="TinkoffBrokerServer-966"><a href="#-966"><span class="linenos"> 966</span></a>        <span class="k">for</span> <span class="n">iName</span> <span class="ow">in</span> <span class="n">tempNames</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-967"><a href="#-967"><span class="linenos"> 967</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">iName</span>
</span><span id="TinkoffBrokerServer-968"><a href="#-968"><span class="linenos"> 968</span></a>            <span class="n">iData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SearchByTicker</span><span class="p">(</span><span class="n">requestPrice</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-969"><a href="#-969"><span class="linenos"> 969</span></a>
</span><span id="TinkoffBrokerServer-970"><a href="#-970"><span class="linenos"> 970</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">iData</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-971"><a href="#-971"><span class="linenos"> 971</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-972"><a href="#-972"><span class="linenos"> 972</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">=</span> <span class="n">iName</span>
</span><span id="TinkoffBrokerServer-973"><a href="#-973"><span class="linenos"> 973</span></a>
</span><span id="TinkoffBrokerServer-974"><a href="#-974"><span class="linenos"> 974</span></a>                <span class="n">iData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SearchByFIGI</span><span class="p">(</span><span class="n">requestPrice</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-975"><a href="#-975"><span class="linenos"> 975</span></a>
</span><span id="TinkoffBrokerServer-976"><a href="#-976"><span class="linenos"> 976</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">iData</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-977"><a href="#-977"><span class="linenos"> 977</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-978"><a href="#-978"><span class="linenos"> 978</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Instrument [</span><span class="si">{}</span><span class="s2">] not in list of available instruments for current token!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iName</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-979"><a href="#-979"><span class="linenos"> 979</span></a>
</span><span id="TinkoffBrokerServer-980"><a href="#-980"><span class="linenos"> 980</span></a>            <span class="k">if</span> <span class="n">iData</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-981"><a href="#-981"><span class="linenos"> 981</span></a>                <span class="n">isUnique</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="TinkoffBrokerServer-982"><a href="#-982"><span class="linenos"> 982</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">iList</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-983"><a href="#-983"><span class="linenos"> 983</span></a>                    <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">iData</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">iData</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-984"><a href="#-984"><span class="linenos"> 984</span></a>                        <span class="n">isUnique</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="TinkoffBrokerServer-985"><a href="#-985"><span class="linenos"> 985</span></a>                        <span class="k">break</span>
</span><span id="TinkoffBrokerServer-986"><a href="#-986"><span class="linenos"> 986</span></a>
</span><span id="TinkoffBrokerServer-987"><a href="#-987"><span class="linenos"> 987</span></a>                <span class="k">if</span> <span class="n">isUnique</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-988"><a href="#-988"><span class="linenos"> 988</span></a>                    <span class="n">iList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iData</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-989"><a href="#-989"><span class="linenos"> 989</span></a>
</span><span id="TinkoffBrokerServer-990"><a href="#-990"><span class="linenos"> 990</span></a>        <span class="k">if</span> <span class="n">showPrices</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-991"><a href="#-991"><span class="linenos"> 991</span></a>            <span class="n">info</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="TinkoffBrokerServer-992"><a href="#-992"><span class="linenos"> 992</span></a>                <span class="s2">&quot;# Actual prices at: [</span><span class="si">{}</span><span class="s2"> UTC]</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tzutc</span><span class="p">())</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M&quot;</span><span class="p">)),</span>
</span><span id="TinkoffBrokerServer-993"><a href="#-993"><span class="linenos"> 993</span></a>                <span class="s2">&quot;| Ticker       | FIGI         | Type       | Prev. close | Last price  | Chg. %   | Day limits min/max  | Actual sell / buy   | Curr.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-994"><a href="#-994"><span class="linenos"> 994</span></a>                <span class="s2">&quot;|--------------|--------------|------------|-------------|-------------|----------|---------------------|---------------------|------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-995"><a href="#-995"><span class="linenos"> 995</span></a>            <span class="p">]</span>
</span><span id="TinkoffBrokerServer-996"><a href="#-996"><span class="linenos"> 996</span></a>
</span><span id="TinkoffBrokerServer-997"><a href="#-997"><span class="linenos"> 997</span></a>            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">iList</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-998"><a href="#-998"><span class="linenos"> 998</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| </span><span class="si">{:&lt;12}</span><span class="s2"> | </span><span class="si">{:&lt;12}</span><span class="s2"> | </span><span class="si">{:&lt;10}</span><span class="s2"> | </span><span class="si">{:&gt;11}</span><span class="s2"> | </span><span class="si">{:&gt;11}</span><span class="s2"> | </span><span class="si">{:&gt;7}</span><span class="s2">% | </span><span class="si">{:&gt;19}</span><span class="s2"> | </span><span class="si">{:&gt;19}</span><span class="s2"> | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-999"><a href="#-999"><span class="linenos"> 999</span></a>                    <span class="n">item</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1000"><a href="#-1000"><span class="linenos">1000</span></a>                    <span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1001"><a href="#-1001"><span class="linenos">1001</span></a>                    <span class="n">item</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1002"><a href="#-1002"><span class="linenos">1002</span></a>                    <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;closePrice&quot;</span><span class="p">])),</span>
</span><span id="TinkoffBrokerServer-1003"><a href="#-1003"><span class="linenos">1003</span></a>                    <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">])),</span>
</span><span id="TinkoffBrokerServer-1004"><a href="#-1004"><span class="linenos">1004</span></a>                    <span class="s2">&quot;</span><span class="si">{}{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;changes&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;changes&quot;</span><span class="p">])),</span>
</span><span id="TinkoffBrokerServer-1005"><a href="#-1005"><span class="linenos">1005</span></a>                    <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> / </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-1006"><a href="#-1006"><span class="linenos">1006</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;limitDown&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;limitDown&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1007"><a href="#-1007"><span class="linenos">1007</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;limitUp&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;limitUp&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1008"><a href="#-1008"><span class="linenos">1008</span></a>                    <span class="p">),</span>
</span><span id="TinkoffBrokerServer-1009"><a href="#-1009"><span class="linenos">1009</span></a>                    <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> / </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-1010"><a href="#-1010"><span class="linenos">1010</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;sell&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;price&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;sell&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1011"><a href="#-1011"><span class="linenos">1011</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;buy&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;price&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;buy&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1012"><a href="#-1012"><span class="linenos">1012</span></a>                    <span class="p">),</span>
</span><span id="TinkoffBrokerServer-1013"><a href="#-1013"><span class="linenos">1013</span></a>                    <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1014"><a href="#-1014"><span class="linenos">1014</span></a>                <span class="p">))</span>
</span><span id="TinkoffBrokerServer-1015"><a href="#-1015"><span class="linenos">1015</span></a>
</span><span id="TinkoffBrokerServer-1016"><a href="#-1016"><span class="linenos">1016</span></a>            <span class="n">infoText</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-1017"><a href="#-1017"><span class="linenos">1017</span></a>
</span><span id="TinkoffBrokerServer-1018"><a href="#-1018"><span class="linenos">1018</span></a>            <span class="k">if</span> <span class="n">showPrices</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1019"><a href="#-1019"><span class="linenos">1019</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Only unique instruments are shown:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">infoText</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-1020"><a href="#-1020"><span class="linenos">1020</span></a>
</span><span id="TinkoffBrokerServer-1021"><a href="#-1021"><span class="linenos">1021</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pricesFile</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1022"><a href="#-1022"><span class="linenos">1022</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pricesFile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fH</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1023"><a href="#-1023"><span class="linenos">1023</span></a>                    <span class="n">fH</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">infoText</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-1024"><a href="#-1024"><span class="linenos">1024</span></a>
</span><span id="TinkoffBrokerServer-1025"><a href="#-1025"><span class="linenos">1025</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Price list for all instruments saved to file: [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pricesFile</span><span class="p">)))</span>
</span><span id="TinkoffBrokerServer-1026"><a href="#-1026"><span class="linenos">1026</span></a>
</span><span id="TinkoffBrokerServer-1027"><a href="#-1027"><span class="linenos">1027</span></a>        <span class="k">return</span> <span class="n">iList</span>
</span><span id="TinkoffBrokerServer-1028"><a href="#-1028"><span class="linenos">1028</span></a>
</span><span id="TinkoffBrokerServer-1029"><a href="#-1029"><span class="linenos">1029</span></a>    <span class="k">def</span> <span class="nf">RequestPortfolio</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1030"><a href="#-1030"><span class="linenos">1030</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-1031"><a href="#-1031"><span class="linenos">1031</span></a><span class="sd">        Requesting current actual user&#39;s portfolio.</span>
</span><span id="TinkoffBrokerServer-1032"><a href="#-1032"><span class="linenos">1032</span></a><span class="sd">        REST API for user portfolio: https://tinkoff.github.io/investAPI/swagger-ui/#/OperationsService/OperationsService_GetPortfolio</span>
</span><span id="TinkoffBrokerServer-1033"><a href="#-1033"><span class="linenos">1033</span></a>
</span><span id="TinkoffBrokerServer-1034"><a href="#-1034"><span class="linenos">1034</span></a><span class="sd">        :return: dictionary with user&#39;s portfolio.</span>
</span><span id="TinkoffBrokerServer-1035"><a href="#-1035"><span class="linenos">1035</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-1036"><a href="#-1036"><span class="linenos">1036</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Requesting current actual user&#39;s portfolio. Wait, please...&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-1037"><a href="#-1037"><span class="linenos">1037</span></a>
</span><span id="TinkoffBrokerServer-1038"><a href="#-1038"><span class="linenos">1038</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="nb">str</span><span class="p">({</span><span class="s2">&quot;accountId&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">accountId</span><span class="p">})</span>
</span><span id="TinkoffBrokerServer-1039"><a href="#-1039"><span class="linenos">1039</span></a>        <span class="n">portfolioURL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;/tinkoff.public.invest.api.contract.v1.OperationsService/GetPortfolio&quot;</span>
</span><span id="TinkoffBrokerServer-1040"><a href="#-1040"><span class="linenos">1040</span></a>        <span class="n">rawPortfolio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SendAPIRequest</span><span class="p">(</span><span class="n">portfolioURL</span><span class="p">,</span> <span class="n">reqType</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-1041"><a href="#-1041"><span class="linenos">1041</span></a>
</span><span id="TinkoffBrokerServer-1042"><a href="#-1042"><span class="linenos">1042</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Records about user&#39;s portfolio successfully received&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-1043"><a href="#-1043"><span class="linenos">1043</span></a>
</span><span id="TinkoffBrokerServer-1044"><a href="#-1044"><span class="linenos">1044</span></a>        <span class="k">return</span> <span class="n">rawPortfolio</span>
</span><span id="TinkoffBrokerServer-1045"><a href="#-1045"><span class="linenos">1045</span></a>
</span><span id="TinkoffBrokerServer-1046"><a href="#-1046"><span class="linenos">1046</span></a>    <span class="k">def</span> <span class="nf">RequestPositions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1047"><a href="#-1047"><span class="linenos">1047</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-1048"><a href="#-1048"><span class="linenos">1048</span></a><span class="sd">        Requesting current open positions in currencies and instruments.</span>
</span><span id="TinkoffBrokerServer-1049"><a href="#-1049"><span class="linenos">1049</span></a><span class="sd">        REST API for open positions: https://tinkoff.github.io/investAPI/swagger-ui/#/OperationsService/OperationsService_GetPositions</span>
</span><span id="TinkoffBrokerServer-1050"><a href="#-1050"><span class="linenos">1050</span></a>
</span><span id="TinkoffBrokerServer-1051"><a href="#-1051"><span class="linenos">1051</span></a><span class="sd">        :return: dictionary with open positions by instruments.</span>
</span><span id="TinkoffBrokerServer-1052"><a href="#-1052"><span class="linenos">1052</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-1053"><a href="#-1053"><span class="linenos">1053</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Requesting current open positions in currencies and instruments. Wait, please...&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-1054"><a href="#-1054"><span class="linenos">1054</span></a>
</span><span id="TinkoffBrokerServer-1055"><a href="#-1055"><span class="linenos">1055</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="nb">str</span><span class="p">({</span><span class="s2">&quot;accountId&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">accountId</span><span class="p">})</span>
</span><span id="TinkoffBrokerServer-1056"><a href="#-1056"><span class="linenos">1056</span></a>        <span class="n">positionsURL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;/tinkoff.public.invest.api.contract.v1.OperationsService/GetPositions&quot;</span>
</span><span id="TinkoffBrokerServer-1057"><a href="#-1057"><span class="linenos">1057</span></a>        <span class="n">rawPositions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SendAPIRequest</span><span class="p">(</span><span class="n">positionsURL</span><span class="p">,</span> <span class="n">reqType</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-1058"><a href="#-1058"><span class="linenos">1058</span></a>
</span><span id="TinkoffBrokerServer-1059"><a href="#-1059"><span class="linenos">1059</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Records about current open positions successfully received&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-1060"><a href="#-1060"><span class="linenos">1060</span></a>
</span><span id="TinkoffBrokerServer-1061"><a href="#-1061"><span class="linenos">1061</span></a>        <span class="k">return</span> <span class="n">rawPositions</span>
</span><span id="TinkoffBrokerServer-1062"><a href="#-1062"><span class="linenos">1062</span></a>
</span><span id="TinkoffBrokerServer-1063"><a href="#-1063"><span class="linenos">1063</span></a>    <span class="k">def</span> <span class="nf">RequestPendingOrders</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1064"><a href="#-1064"><span class="linenos">1064</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-1065"><a href="#-1065"><span class="linenos">1065</span></a><span class="sd">        Requesting current actual pending orders.</span>
</span><span id="TinkoffBrokerServer-1066"><a href="#-1066"><span class="linenos">1066</span></a><span class="sd">        REST API for pending (market) orders: https://tinkoff.github.io/investAPI/swagger-ui/#/OrdersService/OrdersService_GetOrders</span>
</span><span id="TinkoffBrokerServer-1067"><a href="#-1067"><span class="linenos">1067</span></a>
</span><span id="TinkoffBrokerServer-1068"><a href="#-1068"><span class="linenos">1068</span></a><span class="sd">        :return: list of dictionaries with pending orders.</span>
</span><span id="TinkoffBrokerServer-1069"><a href="#-1069"><span class="linenos">1069</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-1070"><a href="#-1070"><span class="linenos">1070</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Requesting current actual pending orders. Wait, please...&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-1071"><a href="#-1071"><span class="linenos">1071</span></a>
</span><span id="TinkoffBrokerServer-1072"><a href="#-1072"><span class="linenos">1072</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="nb">str</span><span class="p">({</span><span class="s2">&quot;accountId&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">accountId</span><span class="p">})</span>
</span><span id="TinkoffBrokerServer-1073"><a href="#-1073"><span class="linenos">1073</span></a>        <span class="n">ordersURL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;/tinkoff.public.invest.api.contract.v1.OrdersService/GetOrders&quot;</span>
</span><span id="TinkoffBrokerServer-1074"><a href="#-1074"><span class="linenos">1074</span></a>        <span class="n">rawOrders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SendAPIRequest</span><span class="p">(</span><span class="n">ordersURL</span><span class="p">,</span> <span class="n">reqType</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">)[</span><span class="s2">&quot;orders&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer-1075"><a href="#-1075"><span class="linenos">1075</span></a>
</span><span id="TinkoffBrokerServer-1076"><a href="#-1076"><span class="linenos">1076</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">] records about pending orders successfully received&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rawOrders</span><span class="p">)))</span>
</span><span id="TinkoffBrokerServer-1077"><a href="#-1077"><span class="linenos">1077</span></a>
</span><span id="TinkoffBrokerServer-1078"><a href="#-1078"><span class="linenos">1078</span></a>        <span class="k">return</span> <span class="n">rawOrders</span>
</span><span id="TinkoffBrokerServer-1079"><a href="#-1079"><span class="linenos">1079</span></a>
</span><span id="TinkoffBrokerServer-1080"><a href="#-1080"><span class="linenos">1080</span></a>    <span class="k">def</span> <span class="nf">RequestStopOrders</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1081"><a href="#-1081"><span class="linenos">1081</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-1082"><a href="#-1082"><span class="linenos">1082</span></a><span class="sd">        Requesting current actual stop orders.</span>
</span><span id="TinkoffBrokerServer-1083"><a href="#-1083"><span class="linenos">1083</span></a><span class="sd">        REST API for opened stop-orders: https://tinkoff.github.io/investAPI/swagger-ui/#/StopOrdersService/StopOrdersService_GetStopOrders</span>
</span><span id="TinkoffBrokerServer-1084"><a href="#-1084"><span class="linenos">1084</span></a>
</span><span id="TinkoffBrokerServer-1085"><a href="#-1085"><span class="linenos">1085</span></a><span class="sd">        :return: list of dictionaries with stop orders.</span>
</span><span id="TinkoffBrokerServer-1086"><a href="#-1086"><span class="linenos">1086</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-1087"><a href="#-1087"><span class="linenos">1087</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Requesting current actual stop orders. Wait, please...&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-1088"><a href="#-1088"><span class="linenos">1088</span></a>
</span><span id="TinkoffBrokerServer-1089"><a href="#-1089"><span class="linenos">1089</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="nb">str</span><span class="p">({</span><span class="s2">&quot;accountId&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">accountId</span><span class="p">})</span>
</span><span id="TinkoffBrokerServer-1090"><a href="#-1090"><span class="linenos">1090</span></a>        <span class="n">ordersURL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;/tinkoff.public.invest.api.contract.v1.StopOrdersService/GetStopOrders&quot;</span>
</span><span id="TinkoffBrokerServer-1091"><a href="#-1091"><span class="linenos">1091</span></a>        <span class="n">rawStopOrders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SendAPIRequest</span><span class="p">(</span><span class="n">ordersURL</span><span class="p">,</span> <span class="n">reqType</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">)[</span><span class="s2">&quot;stopOrders&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer-1092"><a href="#-1092"><span class="linenos">1092</span></a>
</span><span id="TinkoffBrokerServer-1093"><a href="#-1093"><span class="linenos">1093</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">] records about stop orders successfully received&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rawStopOrders</span><span class="p">)))</span>
</span><span id="TinkoffBrokerServer-1094"><a href="#-1094"><span class="linenos">1094</span></a>
</span><span id="TinkoffBrokerServer-1095"><a href="#-1095"><span class="linenos">1095</span></a>        <span class="k">return</span> <span class="n">rawStopOrders</span>
</span><span id="TinkoffBrokerServer-1096"><a href="#-1096"><span class="linenos">1096</span></a>
</span><span id="TinkoffBrokerServer-1097"><a href="#-1097"><span class="linenos">1097</span></a>    <span class="k">def</span> <span class="nf">Overview</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">showStatistics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1098"><a href="#-1098"><span class="linenos">1098</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-1099"><a href="#-1099"><span class="linenos">1099</span></a><span class="sd">        Get portfolio: all open positions, orders and some statistics for defined accountId.</span>
</span><span id="TinkoffBrokerServer-1100"><a href="#-1100"><span class="linenos">1100</span></a><span class="sd">        If `overviewFile` is define then also save information to file.</span>
</span><span id="TinkoffBrokerServer-1101"><a href="#-1101"><span class="linenos">1101</span></a>
</span><span id="TinkoffBrokerServer-1102"><a href="#-1102"><span class="linenos">1102</span></a><span class="sd">        :param showStatistics: if `False` then only dictionary returns, if `True` then show more debug information.</span>
</span><span id="TinkoffBrokerServer-1103"><a href="#-1103"><span class="linenos">1103</span></a><span class="sd">        :return: dictionary with client&#39;s raw portfolio and some statistics.</span>
</span><span id="TinkoffBrokerServer-1104"><a href="#-1104"><span class="linenos">1104</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-1105"><a href="#-1105"><span class="linenos">1105</span></a>        <span class="n">view</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="TinkoffBrokerServer-1106"><a href="#-1106"><span class="linenos">1106</span></a>            <span class="s2">&quot;raw&quot;</span><span class="p">:</span> <span class="p">{</span>  <span class="c1"># --- raw portfolio responses from broker with user portfolio data:</span>
</span><span id="TinkoffBrokerServer-1107"><a href="#-1107"><span class="linenos">1107</span></a>                <span class="s2">&quot;headers&quot;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># list of dictionaries, response headers without &quot;positions&quot; section</span>
</span><span id="TinkoffBrokerServer-1108"><a href="#-1108"><span class="linenos">1108</span></a>                <span class="s2">&quot;Currencies&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># list of dictionaries, open trades with currencies from &quot;positions&quot; section</span>
</span><span id="TinkoffBrokerServer-1109"><a href="#-1109"><span class="linenos">1109</span></a>                <span class="s2">&quot;Shares&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># list of dictionaries, open trades with stocks from &quot;positions&quot; section</span>
</span><span id="TinkoffBrokerServer-1110"><a href="#-1110"><span class="linenos">1110</span></a>                <span class="s2">&quot;Bonds&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># list of dictionaries, open trades with bonds from &quot;positions&quot; section</span>
</span><span id="TinkoffBrokerServer-1111"><a href="#-1111"><span class="linenos">1111</span></a>                <span class="s2">&quot;Etfs&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># list of dictionaries, open trades with etfs from &quot;positions&quot; section</span>
</span><span id="TinkoffBrokerServer-1112"><a href="#-1112"><span class="linenos">1112</span></a>                <span class="s2">&quot;Futures&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># list of dictionaries, open trades with futures from &quot;positions&quot; section</span>
</span><span id="TinkoffBrokerServer-1113"><a href="#-1113"><span class="linenos">1113</span></a>                <span class="s2">&quot;positions&quot;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># raw response from broker: dictionary with current available or blocked currencies and instruments for client</span>
</span><span id="TinkoffBrokerServer-1114"><a href="#-1114"><span class="linenos">1114</span></a>                <span class="s2">&quot;orders&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># raw response from broker: list of dictionaries with all pending (market) orders</span>
</span><span id="TinkoffBrokerServer-1115"><a href="#-1115"><span class="linenos">1115</span></a>                <span class="s2">&quot;stopOrders&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># raw response from broker: list of dictionaries with all stop orders</span>
</span><span id="TinkoffBrokerServer-1116"><a href="#-1116"><span class="linenos">1116</span></a>                <span class="s2">&quot;currenciesCurrentPrices&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rub&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;currentPrice&quot;</span><span class="p">:</span> <span class="mf">1.</span><span class="p">}},</span>  <span class="c1"># dict with prices of all currencies in RUB</span>
</span><span id="TinkoffBrokerServer-1117"><a href="#-1117"><span class="linenos">1117</span></a>            <span class="p">},</span>
</span><span id="TinkoffBrokerServer-1118"><a href="#-1118"><span class="linenos">1118</span></a>            <span class="s2">&quot;stat&quot;</span><span class="p">:</span> <span class="p">{</span>  <span class="c1"># --- some statistics calculated using &quot;raw&quot; sections:</span>
</span><span id="TinkoffBrokerServer-1119"><a href="#-1119"><span class="linenos">1119</span></a>                <span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>  <span class="c1"># portfolio cost in RUB (Russian Rouble)</span>
</span><span id="TinkoffBrokerServer-1120"><a href="#-1120"><span class="linenos">1120</span></a>                <span class="s2">&quot;currentBlockedRUB&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>  <span class="c1"># blocked sum in Russian Rouble</span>
</span><span id="TinkoffBrokerServer-1121"><a href="#-1121"><span class="linenos">1121</span></a>                <span class="s2">&quot;totalChangesRUB&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>  <span class="c1"># changes for all open trades in RUB</span>
</span><span id="TinkoffBrokerServer-1122"><a href="#-1122"><span class="linenos">1122</span></a>                <span class="s2">&quot;totalChangesPercentRUB&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>  <span class="c1"># changes for all open trades in percents</span>
</span><span id="TinkoffBrokerServer-1123"><a href="#-1123"><span class="linenos">1123</span></a>                <span class="s2">&quot;allCurrenciesCostRUB&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>  <span class="c1"># costs of all currencies (include rubles) in RUB</span>
</span><span id="TinkoffBrokerServer-1124"><a href="#-1124"><span class="linenos">1124</span></a>                <span class="s2">&quot;availableRUB&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>  <span class="c1"># available rubles (without other currencies)</span>
</span><span id="TinkoffBrokerServer-1125"><a href="#-1125"><span class="linenos">1125</span></a>                <span class="s2">&quot;stocksCostRUB&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>  <span class="c1"># costs of all stocks in RUB</span>
</span><span id="TinkoffBrokerServer-1126"><a href="#-1126"><span class="linenos">1126</span></a>                <span class="s2">&quot;bondsCostRUB&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>  <span class="c1"># costs of all bonds in RUB</span>
</span><span id="TinkoffBrokerServer-1127"><a href="#-1127"><span class="linenos">1127</span></a>                <span class="s2">&quot;etfsCostRUB&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>  <span class="c1"># costs of all etfs in RUB</span>
</span><span id="TinkoffBrokerServer-1128"><a href="#-1128"><span class="linenos">1128</span></a>                <span class="s2">&quot;Currencies&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># list of dictionaries of all currencies statistics</span>
</span><span id="TinkoffBrokerServer-1129"><a href="#-1129"><span class="linenos">1129</span></a>                <span class="s2">&quot;Shares&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># list of dictionaries of all stocks statistics</span>
</span><span id="TinkoffBrokerServer-1130"><a href="#-1130"><span class="linenos">1130</span></a>                <span class="s2">&quot;Bonds&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># list of dictionaries of all bonds statistics</span>
</span><span id="TinkoffBrokerServer-1131"><a href="#-1131"><span class="linenos">1131</span></a>                <span class="s2">&quot;Etfs&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="c1"># list of dictionaries of all etfs statistics</span>
</span><span id="TinkoffBrokerServer-1132"><a href="#-1132"><span class="linenos">1132</span></a>                <span class="s2">&quot;Futures&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="c1"># list of dictionaries of all futures statistics</span>
</span><span id="TinkoffBrokerServer-1133"><a href="#-1133"><span class="linenos">1133</span></a>                <span class="s2">&quot;orders&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># list of dictionaries of all pending (market) orders and it&#39;s parameters</span>
</span><span id="TinkoffBrokerServer-1134"><a href="#-1134"><span class="linenos">1134</span></a>                <span class="s2">&quot;stopOrders&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># list of dictionaries of all stop orders and it&#39;s parameters</span>
</span><span id="TinkoffBrokerServer-1135"><a href="#-1135"><span class="linenos">1135</span></a>                <span class="s2">&quot;blockedCurrencies&quot;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># dict with blocked instruments and currencies, e.g. {&quot;rub&quot;: 1291.87, &quot;usd&quot;: 6.21}</span>
</span><span id="TinkoffBrokerServer-1136"><a href="#-1136"><span class="linenos">1136</span></a>                <span class="s2">&quot;blockedInstruments&quot;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># dict with blocked  by FIGI, e.g. {}</span>
</span><span id="TinkoffBrokerServer-1137"><a href="#-1137"><span class="linenos">1137</span></a>            <span class="p">},</span>
</span><span id="TinkoffBrokerServer-1138"><a href="#-1138"><span class="linenos">1138</span></a>            <span class="s2">&quot;analytics&quot;</span><span class="p">:{</span>  <span class="c1"># --- some analytics of portfolio:</span>
</span><span id="TinkoffBrokerServer-1139"><a href="#-1139"><span class="linenos">1139</span></a>                <span class="s2">&quot;distrByAssets&quot;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># portfolio distribution by assets</span>
</span><span id="TinkoffBrokerServer-1140"><a href="#-1140"><span class="linenos">1140</span></a>                <span class="s2">&quot;distrByCompanies&quot;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># portfolio distribution by companies</span>
</span><span id="TinkoffBrokerServer-1141"><a href="#-1141"><span class="linenos">1141</span></a>                <span class="s2">&quot;distrBySectors&quot;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># portfolio distribution by sectors</span>
</span><span id="TinkoffBrokerServer-1142"><a href="#-1142"><span class="linenos">1142</span></a>                <span class="s2">&quot;distrByCurrencies&quot;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># portfolio distribution by currencies</span>
</span><span id="TinkoffBrokerServer-1143"><a href="#-1143"><span class="linenos">1143</span></a>            <span class="p">}</span>
</span><span id="TinkoffBrokerServer-1144"><a href="#-1144"><span class="linenos">1144</span></a>        <span class="p">}</span>
</span><span id="TinkoffBrokerServer-1145"><a href="#-1145"><span class="linenos">1145</span></a>
</span><span id="TinkoffBrokerServer-1146"><a href="#-1146"><span class="linenos">1146</span></a>        <span class="k">if</span> <span class="n">showStatistics</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1147"><a href="#-1147"><span class="linenos">1147</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Request portfolio of a client...&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-1148"><a href="#-1148"><span class="linenos">1148</span></a>
</span><span id="TinkoffBrokerServer-1149"><a href="#-1149"><span class="linenos">1149</span></a>        <span class="n">portfolioResponse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RequestPortfolio</span><span class="p">()</span>  <span class="c1"># current user&#39;s portfolio (dict)</span>
</span><span id="TinkoffBrokerServer-1150"><a href="#-1150"><span class="linenos">1150</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;positions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RequestPositions</span><span class="p">()</span>  <span class="c1"># current open positions by instruments (dict)</span>
</span><span id="TinkoffBrokerServer-1151"><a href="#-1151"><span class="linenos">1151</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;orders&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RequestPendingOrders</span><span class="p">()</span>  <span class="c1"># current actual pending orders (list)</span>
</span><span id="TinkoffBrokerServer-1152"><a href="#-1152"><span class="linenos">1152</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;stopOrders&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RequestStopOrders</span><span class="p">()</span>  <span class="c1"># current actual stop orders (list)</span>
</span><span id="TinkoffBrokerServer-1153"><a href="#-1153"><span class="linenos">1153</span></a>
</span><span id="TinkoffBrokerServer-1154"><a href="#-1154"><span class="linenos">1154</span></a>        <span class="c1"># save response headers without &quot;positions&quot; section:</span>
</span><span id="TinkoffBrokerServer-1155"><a href="#-1155"><span class="linenos">1155</span></a>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">portfolioResponse</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-1156"><a href="#-1156"><span class="linenos">1156</span></a>            <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;positions&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1157"><a href="#-1157"><span class="linenos">1157</span></a>                <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;headers&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">portfolioResponse</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer-1158"><a href="#-1158"><span class="linenos">1158</span></a>
</span><span id="TinkoffBrokerServer-1159"><a href="#-1159"><span class="linenos">1159</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1160"><a href="#-1160"><span class="linenos">1160</span></a>                <span class="k">continue</span>
</span><span id="TinkoffBrokerServer-1161"><a href="#-1161"><span class="linenos">1161</span></a>
</span><span id="TinkoffBrokerServer-1162"><a href="#-1162"><span class="linenos">1162</span></a>        <span class="c1"># Re-sorting and separating given raw instruments and currencies by type: https://tinkoff.github.io/investAPI/operations/#operation</span>
</span><span id="TinkoffBrokerServer-1163"><a href="#-1163"><span class="linenos">1163</span></a>        <span class="c1"># Type of instrument must be only one of supported types in TKS_INSTRUMENTS</span>
</span><span id="TinkoffBrokerServer-1164"><a href="#-1164"><span class="linenos">1164</span></a>        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">portfolioResponse</span><span class="p">[</span><span class="s2">&quot;positions&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-1165"><a href="#-1165"><span class="linenos">1165</span></a>            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;currency&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1166"><a href="#-1166"><span class="linenos">1166</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer-1167"><a href="#-1167"><span class="linenos">1167</span></a>                <span class="n">curr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SearchByFIGI</span><span class="p">(</span><span class="n">requestPrice</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-1168"><a href="#-1168"><span class="linenos">1168</span></a>
</span><span id="TinkoffBrokerServer-1169"><a href="#-1169"><span class="linenos">1169</span></a>                <span class="c1"># current price of currency in RUB:</span>
</span><span id="TinkoffBrokerServer-1170"><a href="#-1170"><span class="linenos">1170</span></a>                <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;currenciesCurrentPrices&quot;</span><span class="p">][</span><span class="n">curr</span><span class="p">[</span><span class="s2">&quot;nominal&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="TinkoffBrokerServer-1171"><a href="#-1171"><span class="linenos">1171</span></a>                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">curr</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1172"><a href="#-1172"><span class="linenos">1172</span></a>                    <span class="s2">&quot;currentPrice&quot;</span><span class="p">:</span> <span class="n">NanoToFloat</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-1173"><a href="#-1173"><span class="linenos">1173</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1174"><a href="#-1174"><span class="linenos">1174</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer-1175"><a href="#-1175"><span class="linenos">1175</span></a>                    <span class="p">),</span>
</span><span id="TinkoffBrokerServer-1176"><a href="#-1176"><span class="linenos">1176</span></a>                <span class="p">}</span>
</span><span id="TinkoffBrokerServer-1177"><a href="#-1177"><span class="linenos">1177</span></a>
</span><span id="TinkoffBrokerServer-1178"><a href="#-1178"><span class="linenos">1178</span></a>                <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;Currencies&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-1179"><a href="#-1179"><span class="linenos">1179</span></a>
</span><span id="TinkoffBrokerServer-1180"><a href="#-1180"><span class="linenos">1180</span></a>            <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;share&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1181"><a href="#-1181"><span class="linenos">1181</span></a>                <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;Shares&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-1182"><a href="#-1182"><span class="linenos">1182</span></a>
</span><span id="TinkoffBrokerServer-1183"><a href="#-1183"><span class="linenos">1183</span></a>            <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;bond&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1184"><a href="#-1184"><span class="linenos">1184</span></a>                <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;Bonds&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-1185"><a href="#-1185"><span class="linenos">1185</span></a>
</span><span id="TinkoffBrokerServer-1186"><a href="#-1186"><span class="linenos">1186</span></a>            <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;etf&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1187"><a href="#-1187"><span class="linenos">1187</span></a>                <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;Etfs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-1188"><a href="#-1188"><span class="linenos">1188</span></a>
</span><span id="TinkoffBrokerServer-1189"><a href="#-1189"><span class="linenos">1189</span></a>            <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;futures&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1190"><a href="#-1190"><span class="linenos">1190</span></a>                <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;Futures&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-1191"><a href="#-1191"><span class="linenos">1191</span></a>
</span><span id="TinkoffBrokerServer-1192"><a href="#-1192"><span class="linenos">1192</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1193"><a href="#-1193"><span class="linenos">1193</span></a>                <span class="k">continue</span>
</span><span id="TinkoffBrokerServer-1194"><a href="#-1194"><span class="linenos">1194</span></a>
</span><span id="TinkoffBrokerServer-1195"><a href="#-1195"><span class="linenos">1195</span></a>        <span class="c1"># how many volume of currencies (by ISO currency name) are blocked:</span>
</span><span id="TinkoffBrokerServer-1196"><a href="#-1196"><span class="linenos">1196</span></a>        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;positions&quot;</span><span class="p">][</span><span class="s2">&quot;blocked&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-1197"><a href="#-1197"><span class="linenos">1197</span></a>            <span class="n">blocked</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>
</span><span id="TinkoffBrokerServer-1198"><a href="#-1198"><span class="linenos">1198</span></a>            <span class="k">if</span> <span class="n">blocked</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1199"><a href="#-1199"><span class="linenos">1199</span></a>                <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;blockedCurrencies&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">blocked</span>
</span><span id="TinkoffBrokerServer-1200"><a href="#-1200"><span class="linenos">1200</span></a>
</span><span id="TinkoffBrokerServer-1201"><a href="#-1201"><span class="linenos">1201</span></a>        <span class="c1"># how many volume of instruments (by FIGI) are blocked:</span>
</span><span id="TinkoffBrokerServer-1202"><a href="#-1202"><span class="linenos">1202</span></a>        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;positions&quot;</span><span class="p">][</span><span class="s2">&quot;securities&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-1203"><a href="#-1203"><span class="linenos">1203</span></a>            <span class="n">blocked</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;blocked&quot;</span><span class="p">])</span>
</span><span id="TinkoffBrokerServer-1204"><a href="#-1204"><span class="linenos">1204</span></a>            <span class="k">if</span> <span class="n">blocked</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1205"><a href="#-1205"><span class="linenos">1205</span></a>                <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;blockedInstruments&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">blocked</span>
</span><span id="TinkoffBrokerServer-1206"><a href="#-1206"><span class="linenos">1206</span></a>
</span><span id="TinkoffBrokerServer-1207"><a href="#-1207"><span class="linenos">1207</span></a>        <span class="n">allBlocked</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;blockedCurrencies&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;blockedInstruments&quot;</span><span class="p">]}</span>
</span><span id="TinkoffBrokerServer-1208"><a href="#-1208"><span class="linenos">1208</span></a>
</span><span id="TinkoffBrokerServer-1209"><a href="#-1209"><span class="linenos">1209</span></a>        <span class="k">if</span> <span class="s2">&quot;rub&quot;</span> <span class="ow">in</span> <span class="n">allBlocked</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-1210"><a href="#-1210"><span class="linenos">1210</span></a>            <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;currentBlockedRUB&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">allBlocked</span><span class="p">[</span><span class="s2">&quot;rub&quot;</span><span class="p">]</span>  <span class="c1"># blocked rubles</span>
</span><span id="TinkoffBrokerServer-1211"><a href="#-1211"><span class="linenos">1211</span></a>
</span><span id="TinkoffBrokerServer-1212"><a href="#-1212"><span class="linenos">1212</span></a>        <span class="c1"># --- saving current total amount in RUB of all currencies (with ruble), stocks, bonds, etfs, futures and currencies:</span>
</span><span id="TinkoffBrokerServer-1213"><a href="#-1213"><span class="linenos">1213</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;allCurrenciesCostRUB&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">portfolioResponse</span><span class="p">[</span><span class="s2">&quot;totalAmountCurrencies&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">portfolioResponse</span><span class="p">[</span><span class="s2">&quot;totalAmountCurrencies&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>
</span><span id="TinkoffBrokerServer-1214"><a href="#-1214"><span class="linenos">1214</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;stocksCostRUB&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">portfolioResponse</span><span class="p">[</span><span class="s2">&quot;totalAmountShares&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">portfolioResponse</span><span class="p">[</span><span class="s2">&quot;totalAmountShares&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>
</span><span id="TinkoffBrokerServer-1215"><a href="#-1215"><span class="linenos">1215</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;bondsCostRUB&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">portfolioResponse</span><span class="p">[</span><span class="s2">&quot;totalAmountBonds&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">portfolioResponse</span><span class="p">[</span><span class="s2">&quot;totalAmountBonds&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>
</span><span id="TinkoffBrokerServer-1216"><a href="#-1216"><span class="linenos">1216</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;etfsCostRUB&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">portfolioResponse</span><span class="p">[</span><span class="s2">&quot;totalAmountEtf&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">portfolioResponse</span><span class="p">[</span><span class="s2">&quot;totalAmountEtf&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>
</span><span id="TinkoffBrokerServer-1217"><a href="#-1217"><span class="linenos">1217</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;futuresCostRUB&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">portfolioResponse</span><span class="p">[</span><span class="s2">&quot;totalAmountFutures&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">portfolioResponse</span><span class="p">[</span><span class="s2">&quot;totalAmountFutures&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>
</span><span id="TinkoffBrokerServer-1218"><a href="#-1218"><span class="linenos">1218</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span>
</span><span id="TinkoffBrokerServer-1219"><a href="#-1219"><span class="linenos">1219</span></a>            <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;allCurrenciesCostRUB&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1220"><a href="#-1220"><span class="linenos">1220</span></a>            <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;stocksCostRUB&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1221"><a href="#-1221"><span class="linenos">1221</span></a>            <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;bondsCostRUB&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1222"><a href="#-1222"><span class="linenos">1222</span></a>            <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;etfsCostRUB&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1223"><a href="#-1223"><span class="linenos">1223</span></a>            <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;futuresCostRUB&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1224"><a href="#-1224"><span class="linenos">1224</span></a>        <span class="p">])</span>
</span><span id="TinkoffBrokerServer-1225"><a href="#-1225"><span class="linenos">1225</span></a>
</span><span id="TinkoffBrokerServer-1226"><a href="#-1226"><span class="linenos">1226</span></a>        <span class="c1"># --- calculating some portfolio statistics:</span>
</span><span id="TinkoffBrokerServer-1227"><a href="#-1227"><span class="linenos">1227</span></a>        <span class="n">byComp</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># distribution by companies</span>
</span><span id="TinkoffBrokerServer-1228"><a href="#-1228"><span class="linenos">1228</span></a>        <span class="n">bySect</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># distribution by sectors</span>
</span><span id="TinkoffBrokerServer-1229"><a href="#-1229"><span class="linenos">1229</span></a>        <span class="n">byCurr</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># distribution by currencies (include RUB)</span>
</span><span id="TinkoffBrokerServer-1230"><a href="#-1230"><span class="linenos">1230</span></a>
</span><span id="TinkoffBrokerServer-1231"><a href="#-1231"><span class="linenos">1231</span></a>        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">portfolioResponse</span><span class="p">[</span><span class="s2">&quot;positions&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-1232"><a href="#-1232"><span class="linenos">1232</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer-1233"><a href="#-1233"><span class="linenos">1233</span></a>            <span class="n">instrument</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SearchByFIGI</span><span class="p">(</span><span class="n">requestPrice</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># full raw info about instrument by FIGI</span>
</span><span id="TinkoffBrokerServer-1234"><a href="#-1234"><span class="linenos">1234</span></a>
</span><span id="TinkoffBrokerServer-1235"><a href="#-1235"><span class="linenos">1235</span></a>            <span class="k">if</span> <span class="n">instrument</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1236"><a href="#-1236"><span class="linenos">1236</span></a>                <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;currency&quot;</span> <span class="ow">and</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;nominal&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">allBlocked</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-1237"><a href="#-1237"><span class="linenos">1237</span></a>                    <span class="n">blocked</span> <span class="o">=</span> <span class="n">allBlocked</span><span class="p">[</span><span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;nominal&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span>  <span class="c1"># blocked volume of currency</span>
</span><span id="TinkoffBrokerServer-1238"><a href="#-1238"><span class="linenos">1238</span></a>
</span><span id="TinkoffBrokerServer-1239"><a href="#-1239"><span class="linenos">1239</span></a>                <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;currency&quot;</span> <span class="ow">and</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">allBlocked</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-1240"><a href="#-1240"><span class="linenos">1240</span></a>                    <span class="n">blocked</span> <span class="o">=</span> <span class="n">allBlocked</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]]</span>  <span class="c1"># blocked volume of other instruments</span>
</span><span id="TinkoffBrokerServer-1241"><a href="#-1241"><span class="linenos">1241</span></a>
</span><span id="TinkoffBrokerServer-1242"><a href="#-1242"><span class="linenos">1242</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1243"><a href="#-1243"><span class="linenos">1243</span></a>                    <span class="n">blocked</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="TinkoffBrokerServer-1244"><a href="#-1244"><span class="linenos">1244</span></a>
</span><span id="TinkoffBrokerServer-1245"><a href="#-1245"><span class="linenos">1245</span></a>                <span class="n">volume</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;quantity&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;quantity&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>  <span class="c1"># available volume of instrument</span>
</span><span id="TinkoffBrokerServer-1246"><a href="#-1246"><span class="linenos">1246</span></a>                <span class="n">lots</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;quantityLots&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;quantityLots&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>  <span class="c1"># available volume in lots of instrument</span>
</span><span id="TinkoffBrokerServer-1247"><a href="#-1247"><span class="linenos">1247</span></a>                <span class="n">direction</span> <span class="o">=</span> <span class="s2">&quot;Long&quot;</span> <span class="k">if</span> <span class="n">lots</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;Short&quot;</span>  <span class="c1"># direction of an instrument&#39;s position: short or long</span>
</span><span id="TinkoffBrokerServer-1248"><a href="#-1248"><span class="linenos">1248</span></a>                <span class="n">curPrice</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>  <span class="c1"># current instrument&#39;s price</span>
</span><span id="TinkoffBrokerServer-1249"><a href="#-1249"><span class="linenos">1249</span></a>                <span class="n">average</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;averagePositionPriceFifo&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;averagePositionPriceFifo&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>  <span class="c1"># current average position price</span>
</span><span id="TinkoffBrokerServer-1250"><a href="#-1250"><span class="linenos">1250</span></a>                <span class="n">profit</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;expectedYield&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;expectedYield&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>  <span class="c1"># expected profit at current moment</span>
</span><span id="TinkoffBrokerServer-1251"><a href="#-1251"><span class="linenos">1251</span></a>                <span class="n">currency</span> <span class="o">=</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;share&quot;</span> <span class="ow">or</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;etf&quot;</span> <span class="ow">or</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;future&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;nominal&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span>  <span class="c1"># currency name rub, usd, eur etc.</span>
</span><span id="TinkoffBrokerServer-1252"><a href="#-1252"><span class="linenos">1252</span></a>                <span class="n">cost</span> <span class="o">=</span> <span class="p">(</span><span class="n">curPrice</span> <span class="o">+</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentNkd&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentNkd&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">]))</span> <span class="o">*</span> <span class="n">volume</span>  <span class="c1"># current cost of all volume of instrument in basic asset</span>
</span><span id="TinkoffBrokerServer-1253"><a href="#-1253"><span class="linenos">1253</span></a>                <span class="n">baseCurrencyName</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span>  <span class="c1"># name of base currency (rub)</span>
</span><span id="TinkoffBrokerServer-1254"><a href="#-1254"><span class="linenos">1254</span></a>                <span class="n">costRUB</span> <span class="o">=</span> <span class="n">cost</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;currency&quot;</span> <span class="k">else</span> <span class="n">cost</span> <span class="o">*</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;currenciesCurrentPrices&quot;</span><span class="p">][</span><span class="n">currency</span><span class="p">][</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">]</span>  <span class="c1"># cost in rubles</span>
</span><span id="TinkoffBrokerServer-1255"><a href="#-1255"><span class="linenos">1255</span></a>                <span class="n">percentCostRUB</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">costRUB</span> <span class="o">/</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.</span>  <span class="c1"># instrument&#39;s part in percent of full portfolio cost</span>
</span><span id="TinkoffBrokerServer-1256"><a href="#-1256"><span class="linenos">1256</span></a>
</span><span id="TinkoffBrokerServer-1257"><a href="#-1257"><span class="linenos">1257</span></a>                <span class="n">statData</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="TinkoffBrokerServer-1258"><a href="#-1258"><span class="linenos">1258</span></a>                    <span class="s2">&quot;figi&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">],</span>  <span class="c1"># FIGI from REST API &quot;GetPortfolio&quot; method</span>
</span><span id="TinkoffBrokerServer-1259"><a href="#-1259"><span class="linenos">1259</span></a>                    <span class="s2">&quot;ticker&quot;</span><span class="p">:</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">],</span>  <span class="c1"># ticker by FIGI</span>
</span><span id="TinkoffBrokerServer-1260"><a href="#-1260"><span class="linenos">1260</span></a>                    <span class="s2">&quot;currency&quot;</span><span class="p">:</span> <span class="n">currency</span><span class="p">,</span>  <span class="c1"># currency name rub, usd, eur etc. for instrument price</span>
</span><span id="TinkoffBrokerServer-1261"><a href="#-1261"><span class="linenos">1261</span></a>                    <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="n">volume</span><span class="p">,</span>  <span class="c1"># available volume of instrument</span>
</span><span id="TinkoffBrokerServer-1262"><a href="#-1262"><span class="linenos">1262</span></a>                    <span class="s2">&quot;lots&quot;</span><span class="p">:</span> <span class="n">lots</span><span class="p">,</span>  <span class="c1"># volume in lots of instrument</span>
</span><span id="TinkoffBrokerServer-1263"><a href="#-1263"><span class="linenos">1263</span></a>                    <span class="s2">&quot;direction&quot;</span><span class="p">:</span> <span class="n">direction</span><span class="p">,</span>  <span class="c1"># direction of an instrument&#39;s position: short or long</span>
</span><span id="TinkoffBrokerServer-1264"><a href="#-1264"><span class="linenos">1264</span></a>                    <span class="s2">&quot;blocked&quot;</span><span class="p">:</span> <span class="n">blocked</span><span class="p">,</span>  <span class="c1"># blocked volume of currency or instrument</span>
</span><span id="TinkoffBrokerServer-1265"><a href="#-1265"><span class="linenos">1265</span></a>                    <span class="s2">&quot;currentPrice&quot;</span><span class="p">:</span> <span class="n">curPrice</span><span class="p">,</span>  <span class="c1"># current instrument&#39;s price in basic asset</span>
</span><span id="TinkoffBrokerServer-1266"><a href="#-1266"><span class="linenos">1266</span></a>                    <span class="s2">&quot;average&quot;</span><span class="p">:</span> <span class="n">average</span><span class="p">,</span>  <span class="c1"># current average position price</span>
</span><span id="TinkoffBrokerServer-1267"><a href="#-1267"><span class="linenos">1267</span></a>                    <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">cost</span><span class="p">,</span>  <span class="c1"># current cost of all volume of instrument in basic asset</span>
</span><span id="TinkoffBrokerServer-1268"><a href="#-1268"><span class="linenos">1268</span></a>                    <span class="s2">&quot;baseCurrencyName&quot;</span><span class="p">:</span> <span class="n">baseCurrencyName</span><span class="p">,</span>  <span class="c1"># name of base currency (rub)</span>
</span><span id="TinkoffBrokerServer-1269"><a href="#-1269"><span class="linenos">1269</span></a>                    <span class="s2">&quot;costRUB&quot;</span><span class="p">:</span> <span class="n">costRUB</span><span class="p">,</span>  <span class="c1"># cost of instrument in ruble</span>
</span><span id="TinkoffBrokerServer-1270"><a href="#-1270"><span class="linenos">1270</span></a>                    <span class="s2">&quot;percentCostRUB&quot;</span><span class="p">:</span> <span class="n">percentCostRUB</span><span class="p">,</span>  <span class="c1"># instrument&#39;s part in percent of full portfolio cost in RUB</span>
</span><span id="TinkoffBrokerServer-1271"><a href="#-1271"><span class="linenos">1271</span></a>                    <span class="s2">&quot;profit&quot;</span><span class="p">:</span> <span class="n">profit</span><span class="p">,</span>  <span class="c1"># expected profit at current moment</span>
</span><span id="TinkoffBrokerServer-1272"><a href="#-1272"><span class="linenos">1272</span></a>                    <span class="s2">&quot;percentProfit&quot;</span><span class="p">:</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">profit</span> <span class="o">/</span> <span class="p">(</span><span class="n">average</span> <span class="o">*</span> <span class="n">volume</span><span class="p">),</span>  <span class="c1"># expected percents of profit at current moment for this instrument</span>
</span><span id="TinkoffBrokerServer-1273"><a href="#-1273"><span class="linenos">1273</span></a>                    <span class="s2">&quot;sector&quot;</span><span class="p">:</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;sector&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;sector&quot;</span> <span class="ow">in</span> <span class="n">instrument</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;sector&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;other&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1274"><a href="#-1274"><span class="linenos">1274</span></a>                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">instrument</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>  <span class="c1"># human-readable names of instruments</span>
</span><span id="TinkoffBrokerServer-1275"><a href="#-1275"><span class="linenos">1275</span></a>                    <span class="s2">&quot;isoCurrencyName&quot;</span><span class="p">:</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;isoCurrencyName&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;isoCurrencyName&quot;</span> <span class="ow">in</span> <span class="n">instrument</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>  <span class="c1"># ISO name for currencies only</span>
</span><span id="TinkoffBrokerServer-1276"><a href="#-1276"><span class="linenos">1276</span></a>                <span class="p">}</span>
</span><span id="TinkoffBrokerServer-1277"><a href="#-1277"><span class="linenos">1277</span></a>
</span><span id="TinkoffBrokerServer-1278"><a href="#-1278"><span class="linenos">1278</span></a>                <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;currency&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1279"><a href="#-1279"><span class="linenos">1279</span></a>                    <span class="c1"># adding distribution by unique companies:</span>
</span><span id="TinkoffBrokerServer-1280"><a href="#-1280"><span class="linenos">1280</span></a>                    <span class="k">if</span> <span class="n">statData</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-1281"><a href="#-1281"><span class="linenos">1281</span></a>                        <span class="k">if</span> <span class="n">statData</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">byComp</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-1282"><a href="#-1282"><span class="linenos">1282</span></a>                            <span class="n">byComp</span><span class="p">[</span><span class="n">statData</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ticker&quot;</span><span class="p">:</span> <span class="n">statData</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">],</span> <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">costRUB</span><span class="p">,</span> <span class="s2">&quot;percent&quot;</span><span class="p">:</span> <span class="n">percentCostRUB</span><span class="p">}</span>
</span><span id="TinkoffBrokerServer-1283"><a href="#-1283"><span class="linenos">1283</span></a>
</span><span id="TinkoffBrokerServer-1284"><a href="#-1284"><span class="linenos">1284</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1285"><a href="#-1285"><span class="linenos">1285</span></a>                            <span class="n">byComp</span><span class="p">[</span><span class="n">statData</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]][</span><span class="s2">&quot;cost&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">costRUB</span>
</span><span id="TinkoffBrokerServer-1286"><a href="#-1286"><span class="linenos">1286</span></a>                            <span class="n">byComp</span><span class="p">[</span><span class="n">statData</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]][</span><span class="s2">&quot;percent&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">percentCostRUB</span>
</span><span id="TinkoffBrokerServer-1287"><a href="#-1287"><span class="linenos">1287</span></a>
</span><span id="TinkoffBrokerServer-1288"><a href="#-1288"><span class="linenos">1288</span></a>                    <span class="c1"># adding distribution by unique sectors:</span>
</span><span id="TinkoffBrokerServer-1289"><a href="#-1289"><span class="linenos">1289</span></a>                    <span class="k">if</span> <span class="n">statData</span><span class="p">[</span><span class="s2">&quot;sector&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bySect</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-1290"><a href="#-1290"><span class="linenos">1290</span></a>                        <span class="n">bySect</span><span class="p">[</span><span class="n">statData</span><span class="p">[</span><span class="s2">&quot;sector&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">costRUB</span><span class="p">,</span> <span class="s2">&quot;percent&quot;</span><span class="p">:</span> <span class="n">percentCostRUB</span><span class="p">}</span>
</span><span id="TinkoffBrokerServer-1291"><a href="#-1291"><span class="linenos">1291</span></a>
</span><span id="TinkoffBrokerServer-1292"><a href="#-1292"><span class="linenos">1292</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1293"><a href="#-1293"><span class="linenos">1293</span></a>                        <span class="n">bySect</span><span class="p">[</span><span class="n">statData</span><span class="p">[</span><span class="s2">&quot;sector&quot;</span><span class="p">]][</span><span class="s2">&quot;cost&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">costRUB</span>
</span><span id="TinkoffBrokerServer-1294"><a href="#-1294"><span class="linenos">1294</span></a>                        <span class="n">bySect</span><span class="p">[</span><span class="n">statData</span><span class="p">[</span><span class="s2">&quot;sector&quot;</span><span class="p">]][</span><span class="s2">&quot;percent&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">percentCostRUB</span>
</span><span id="TinkoffBrokerServer-1295"><a href="#-1295"><span class="linenos">1295</span></a>
</span><span id="TinkoffBrokerServer-1296"><a href="#-1296"><span class="linenos">1296</span></a>                <span class="c1"># adding distribution by unique currencies:</span>
</span><span id="TinkoffBrokerServer-1297"><a href="#-1297"><span class="linenos">1297</span></a>                <span class="k">if</span> <span class="n">currency</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">byCurr</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-1298"><a href="#-1298"><span class="linenos">1298</span></a>                    <span class="n">byCurr</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="TinkoffBrokerServer-1299"><a href="#-1299"><span class="linenos">1299</span></a>                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;currenciesCurrentPrices&quot;</span><span class="p">][</span><span class="n">currency</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1300"><a href="#-1300"><span class="linenos">1300</span></a>                        <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">costRUB</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1301"><a href="#-1301"><span class="linenos">1301</span></a>                        <span class="s2">&quot;percent&quot;</span><span class="p">:</span> <span class="n">percentCostRUB</span>
</span><span id="TinkoffBrokerServer-1302"><a href="#-1302"><span class="linenos">1302</span></a>                    <span class="p">}</span>
</span><span id="TinkoffBrokerServer-1303"><a href="#-1303"><span class="linenos">1303</span></a>
</span><span id="TinkoffBrokerServer-1304"><a href="#-1304"><span class="linenos">1304</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1305"><a href="#-1305"><span class="linenos">1305</span></a>                    <span class="n">byCurr</span><span class="p">[</span><span class="n">currency</span><span class="p">][</span><span class="s2">&quot;cost&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">costRUB</span>
</span><span id="TinkoffBrokerServer-1306"><a href="#-1306"><span class="linenos">1306</span></a>                    <span class="n">byCurr</span><span class="p">[</span><span class="n">currency</span><span class="p">][</span><span class="s2">&quot;percent&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">percentCostRUB</span>
</span><span id="TinkoffBrokerServer-1307"><a href="#-1307"><span class="linenos">1307</span></a>
</span><span id="TinkoffBrokerServer-1308"><a href="#-1308"><span class="linenos">1308</span></a>                <span class="c1"># saving statistics for every instruments:</span>
</span><span id="TinkoffBrokerServer-1309"><a href="#-1309"><span class="linenos">1309</span></a>                <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;currency&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1310"><a href="#-1310"><span class="linenos">1310</span></a>                    <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Currencies&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">statData</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-1311"><a href="#-1311"><span class="linenos">1311</span></a>
</span><span id="TinkoffBrokerServer-1312"><a href="#-1312"><span class="linenos">1312</span></a>                <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;share&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1313"><a href="#-1313"><span class="linenos">1313</span></a>                    <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Shares&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">statData</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-1314"><a href="#-1314"><span class="linenos">1314</span></a>
</span><span id="TinkoffBrokerServer-1315"><a href="#-1315"><span class="linenos">1315</span></a>                <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;bond&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1316"><a href="#-1316"><span class="linenos">1316</span></a>                    <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Bonds&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">statData</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-1317"><a href="#-1317"><span class="linenos">1317</span></a>
</span><span id="TinkoffBrokerServer-1318"><a href="#-1318"><span class="linenos">1318</span></a>                <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;etf&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1319"><a href="#-1319"><span class="linenos">1319</span></a>                    <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Etfs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">statData</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-1320"><a href="#-1320"><span class="linenos">1320</span></a>
</span><span id="TinkoffBrokerServer-1321"><a href="#-1321"><span class="linenos">1321</span></a>                <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Futures&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1322"><a href="#-1322"><span class="linenos">1322</span></a>                    <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Futures&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">statData</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-1323"><a href="#-1323"><span class="linenos">1323</span></a>
</span><span id="TinkoffBrokerServer-1324"><a href="#-1324"><span class="linenos">1324</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1325"><a href="#-1325"><span class="linenos">1325</span></a>                    <span class="k">continue</span>
</span><span id="TinkoffBrokerServer-1326"><a href="#-1326"><span class="linenos">1326</span></a>
</span><span id="TinkoffBrokerServer-1327"><a href="#-1327"><span class="linenos">1327</span></a>        <span class="c1"># total changes:</span>
</span><span id="TinkoffBrokerServer-1328"><a href="#-1328"><span class="linenos">1328</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;availableRUB&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;allCurrenciesCostRUB&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">([</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;cost&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Currencies&quot;</span><span class="p">]])</span>  <span class="c1"># available RUB without other currencies</span>
</span><span id="TinkoffBrokerServer-1329"><a href="#-1329"><span class="linenos">1329</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;totalChangesPercentRUB&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;headers&quot;</span><span class="p">][</span><span class="s2">&quot;expectedYield&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;headers&quot;</span><span class="p">][</span><span class="s2">&quot;expectedYield&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;expectedYield&quot;</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;headers&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="mf">0.</span>
</span><span id="TinkoffBrokerServer-1330"><a href="#-1330"><span class="linenos">1330</span></a>        <span class="n">startCost</span> <span class="o">=</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;totalChangesPercentRUB&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-1331"><a href="#-1331"><span class="linenos">1331</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;totalChangesRUB&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">startCost</span>
</span><span id="TinkoffBrokerServer-1332"><a href="#-1332"><span class="linenos">1332</span></a>
</span><span id="TinkoffBrokerServer-1333"><a href="#-1333"><span class="linenos">1333</span></a>        <span class="c1"># --- pending orders sector data:</span>
</span><span id="TinkoffBrokerServer-1334"><a href="#-1334"><span class="linenos">1334</span></a>        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;orders&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-1335"><a href="#-1335"><span class="linenos">1335</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer-1336"><a href="#-1336"><span class="linenos">1336</span></a>            <span class="n">instrument</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SearchByFIGI</span><span class="p">(</span><span class="n">requestPrice</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># full raw info about instrument by FIGI</span>
</span><span id="TinkoffBrokerServer-1337"><a href="#-1337"><span class="linenos">1337</span></a>
</span><span id="TinkoffBrokerServer-1338"><a href="#-1338"><span class="linenos">1338</span></a>            <span class="k">if</span> <span class="n">instrument</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1339"><a href="#-1339"><span class="linenos">1339</span></a>                <span class="n">action</span> <span class="o">=</span> <span class="n">TKS_ORDER_DIRECTIONS</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;direction&quot;</span><span class="p">]]</span>
</span><span id="TinkoffBrokerServer-1340"><a href="#-1340"><span class="linenos">1340</span></a>                <span class="n">orderType</span> <span class="o">=</span> <span class="n">TKS_ORDER_TYPES</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;orderType&quot;</span><span class="p">]]</span>
</span><span id="TinkoffBrokerServer-1341"><a href="#-1341"><span class="linenos">1341</span></a>                <span class="n">orderState</span> <span class="o">=</span> <span class="n">TKS_ORDER_STATES</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;executionReportStatus&quot;</span><span class="p">]]</span>
</span><span id="TinkoffBrokerServer-1342"><a href="#-1342"><span class="linenos">1342</span></a>                <span class="n">orderDate</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;orderDate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># date in UTC format, e.g. &quot;2022-12-31T23:59:59.123456Z&quot;</span>
</span><span id="TinkoffBrokerServer-1343"><a href="#-1343"><span class="linenos">1343</span></a>
</span><span id="TinkoffBrokerServer-1344"><a href="#-1344"><span class="linenos">1344</span></a>                <span class="c1"># current instrument&#39;s price (last sellers order if buy, and last buyers order if sell):</span>
</span><span id="TinkoffBrokerServer-1345"><a href="#-1345"><span class="linenos">1345</span></a>                <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;direction&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ORDER_DIRECTION_BUY&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1346"><a href="#-1346"><span class="linenos">1346</span></a>                    <span class="n">lastPrice</span> <span class="o">=</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;sell&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;price&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;sell&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span>
</span><span id="TinkoffBrokerServer-1347"><a href="#-1347"><span class="linenos">1347</span></a>
</span><span id="TinkoffBrokerServer-1348"><a href="#-1348"><span class="linenos">1348</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1349"><a href="#-1349"><span class="linenos">1349</span></a>                    <span class="n">lastPrice</span> <span class="o">=</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;buy&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;price&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;buy&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span>
</span><span id="TinkoffBrokerServer-1350"><a href="#-1350"><span class="linenos">1350</span></a>
</span><span id="TinkoffBrokerServer-1351"><a href="#-1351"><span class="linenos">1351</span></a>                <span class="c1"># requested price for order execution:</span>
</span><span id="TinkoffBrokerServer-1352"><a href="#-1352"><span class="linenos">1352</span></a>                <span class="n">target</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;initialSecurityPrice&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;initialSecurityPrice&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>
</span><span id="TinkoffBrokerServer-1353"><a href="#-1353"><span class="linenos">1353</span></a>
</span><span id="TinkoffBrokerServer-1354"><a href="#-1354"><span class="linenos">1354</span></a>                <span class="c1"># necessary changes in percent to reach target from current price:</span>
</span><span id="TinkoffBrokerServer-1355"><a href="#-1355"><span class="linenos">1355</span></a>                <span class="n">changes</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">lastPrice</span> <span class="o">-</span> <span class="n">target</span><span class="p">)</span> <span class="o">/</span> <span class="n">target</span> <span class="k">if</span> <span class="n">lastPrice</span> <span class="o">!=</span> <span class="s2">&quot;N/A&quot;</span> <span class="ow">and</span> <span class="n">target</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="TinkoffBrokerServer-1356"><a href="#-1356"><span class="linenos">1356</span></a>
</span><span id="TinkoffBrokerServer-1357"><a href="#-1357"><span class="linenos">1357</span></a>                <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;orders&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="TinkoffBrokerServer-1358"><a href="#-1358"><span class="linenos">1358</span></a>                    <span class="s2">&quot;orderID&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;orderId&quot;</span><span class="p">],</span>  <span class="c1"># orderId number parameter of current order</span>
</span><span id="TinkoffBrokerServer-1359"><a href="#-1359"><span class="linenos">1359</span></a>                    <span class="s2">&quot;figi&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">],</span>  <span class="c1"># FIGI identification</span>
</span><span id="TinkoffBrokerServer-1360"><a href="#-1360"><span class="linenos">1360</span></a>                    <span class="s2">&quot;ticker&quot;</span><span class="p">:</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">],</span>  <span class="c1"># ticker name by FIGI</span>
</span><span id="TinkoffBrokerServer-1361"><a href="#-1361"><span class="linenos">1361</span></a>                    <span class="s2">&quot;lotsRequested&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;lotsRequested&quot;</span><span class="p">],</span>  <span class="c1"># requested lots value</span>
</span><span id="TinkoffBrokerServer-1362"><a href="#-1362"><span class="linenos">1362</span></a>                    <span class="s2">&quot;lotsExecuted&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;lotsExecuted&quot;</span><span class="p">],</span>  <span class="c1"># how many lots are executed</span>
</span><span id="TinkoffBrokerServer-1363"><a href="#-1363"><span class="linenos">1363</span></a>                    <span class="s2">&quot;currentPrice&quot;</span><span class="p">:</span> <span class="n">lastPrice</span><span class="p">,</span>  <span class="c1"># current instrument&#39;s price for defined action</span>
</span><span id="TinkoffBrokerServer-1364"><a href="#-1364"><span class="linenos">1364</span></a>                    <span class="s2">&quot;targetPrice&quot;</span><span class="p">:</span> <span class="n">target</span><span class="p">,</span>  <span class="c1"># requested price for order execution in base currency</span>
</span><span id="TinkoffBrokerServer-1365"><a href="#-1365"><span class="linenos">1365</span></a>                    <span class="s2">&quot;baseCurrencyName&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;initialSecurityPrice&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>  <span class="c1"># name of base currency</span>
</span><span id="TinkoffBrokerServer-1366"><a href="#-1366"><span class="linenos">1366</span></a>                    <span class="s2">&quot;percentChanges&quot;</span><span class="p">:</span> <span class="n">changes</span><span class="p">,</span>  <span class="c1"># changes in percent to target from current price</span>
</span><span id="TinkoffBrokerServer-1367"><a href="#-1367"><span class="linenos">1367</span></a>                    <span class="s2">&quot;currency&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>  <span class="c1"># instrument&#39;s currency name</span>
</span><span id="TinkoffBrokerServer-1368"><a href="#-1368"><span class="linenos">1368</span></a>                    <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span>  <span class="c1"># sell / buy / Unknown from TKS_ORDER_DIRECTIONS</span>
</span><span id="TinkoffBrokerServer-1369"><a href="#-1369"><span class="linenos">1369</span></a>                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">orderType</span><span class="p">,</span>  <span class="c1"># type of order from TKS_ORDER_TYPES</span>
</span><span id="TinkoffBrokerServer-1370"><a href="#-1370"><span class="linenos">1370</span></a>                    <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">orderState</span><span class="p">,</span>  <span class="c1"># order status from TKS_ORDER_STATES</span>
</span><span id="TinkoffBrokerServer-1371"><a href="#-1371"><span class="linenos">1371</span></a>                    <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="n">orderDate</span><span class="p">,</span>  <span class="c1"># string with order date and time from UTC format (without nano seconds part)</span>
</span><span id="TinkoffBrokerServer-1372"><a href="#-1372"><span class="linenos">1372</span></a>                <span class="p">})</span>
</span><span id="TinkoffBrokerServer-1373"><a href="#-1373"><span class="linenos">1373</span></a>
</span><span id="TinkoffBrokerServer-1374"><a href="#-1374"><span class="linenos">1374</span></a>        <span class="c1"># --- stop orders sector data:</span>
</span><span id="TinkoffBrokerServer-1375"><a href="#-1375"><span class="linenos">1375</span></a>        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;stopOrders&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-1376"><a href="#-1376"><span class="linenos">1376</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer-1377"><a href="#-1377"><span class="linenos">1377</span></a>            <span class="n">instrument</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SearchByFIGI</span><span class="p">(</span><span class="n">requestPrice</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># full raw info about instrument by FIGI</span>
</span><span id="TinkoffBrokerServer-1378"><a href="#-1378"><span class="linenos">1378</span></a>
</span><span id="TinkoffBrokerServer-1379"><a href="#-1379"><span class="linenos">1379</span></a>            <span class="k">if</span> <span class="n">instrument</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1380"><a href="#-1380"><span class="linenos">1380</span></a>                <span class="n">action</span> <span class="o">=</span> <span class="n">TKS_STOP_ORDER_DIRECTIONS</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;direction&quot;</span><span class="p">]]</span>
</span><span id="TinkoffBrokerServer-1381"><a href="#-1381"><span class="linenos">1381</span></a>                <span class="n">orderType</span> <span class="o">=</span> <span class="n">TKS_STOP_ORDER_TYPES</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;orderType&quot;</span><span class="p">]]</span>
</span><span id="TinkoffBrokerServer-1382"><a href="#-1382"><span class="linenos">1382</span></a>                <span class="n">createDate</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;createDate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># date in UTC format, e.g. &quot;2022-12-31T23:59:59.123456Z&quot;</span>
</span><span id="TinkoffBrokerServer-1383"><a href="#-1383"><span class="linenos">1383</span></a>
</span><span id="TinkoffBrokerServer-1384"><a href="#-1384"><span class="linenos">1384</span></a>                <span class="c1"># hack: server response can&#39;t contain &quot;expirationTime&quot; key if it is not &quot;Until date&quot; type of stop order</span>
</span><span id="TinkoffBrokerServer-1385"><a href="#-1385"><span class="linenos">1385</span></a>                <span class="k">if</span> <span class="s2">&quot;expirationTime&quot;</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-1386"><a href="#-1386"><span class="linenos">1386</span></a>                    <span class="n">expType</span> <span class="o">=</span> <span class="n">TKS_STOP_ORDER_EXPIRATION_TYPES</span><span class="p">[</span><span class="s2">&quot;STOP_ORDER_EXPIRATION_TYPE_GOOD_TILL_DATE&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer-1387"><a href="#-1387"><span class="linenos">1387</span></a>                    <span class="n">expDate</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;expirationTime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer-1388"><a href="#-1388"><span class="linenos">1388</span></a>
</span><span id="TinkoffBrokerServer-1389"><a href="#-1389"><span class="linenos">1389</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1390"><a href="#-1390"><span class="linenos">1390</span></a>                    <span class="n">expType</span> <span class="o">=</span> <span class="n">TKS_STOP_ORDER_EXPIRATION_TYPES</span><span class="p">[</span><span class="s2">&quot;STOP_ORDER_EXPIRATION_TYPE_GOOD_TILL_CANCEL&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer-1391"><a href="#-1391"><span class="linenos">1391</span></a>                    <span class="n">expDate</span> <span class="o">=</span> <span class="n">TKS_STOP_ORDER_EXPIRATION_TYPES</span><span class="p">[</span><span class="s2">&quot;STOP_ORDER_EXPIRATION_TYPE_UNSPECIFIED&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer-1392"><a href="#-1392"><span class="linenos">1392</span></a>
</span><span id="TinkoffBrokerServer-1393"><a href="#-1393"><span class="linenos">1393</span></a>                <span class="c1"># current instrument&#39;s price (last sellers order if buy, and last buyers order if sell):</span>
</span><span id="TinkoffBrokerServer-1394"><a href="#-1394"><span class="linenos">1394</span></a>                <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;direction&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;STOP_ORDER_DIRECTION_BUY&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1395"><a href="#-1395"><span class="linenos">1395</span></a>                    <span class="n">lastPrice</span> <span class="o">=</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;sell&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;price&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;sell&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span>
</span><span id="TinkoffBrokerServer-1396"><a href="#-1396"><span class="linenos">1396</span></a>
</span><span id="TinkoffBrokerServer-1397"><a href="#-1397"><span class="linenos">1397</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1398"><a href="#-1398"><span class="linenos">1398</span></a>                    <span class="n">lastPrice</span> <span class="o">=</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;buy&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;price&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;buy&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span>
</span><span id="TinkoffBrokerServer-1399"><a href="#-1399"><span class="linenos">1399</span></a>
</span><span id="TinkoffBrokerServer-1400"><a href="#-1400"><span class="linenos">1400</span></a>                <span class="c1"># requested price when stop-order executed:</span>
</span><span id="TinkoffBrokerServer-1401"><a href="#-1401"><span class="linenos">1401</span></a>                <span class="n">target</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;stopPrice&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;stopPrice&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>
</span><span id="TinkoffBrokerServer-1402"><a href="#-1402"><span class="linenos">1402</span></a>
</span><span id="TinkoffBrokerServer-1403"><a href="#-1403"><span class="linenos">1403</span></a>                <span class="c1"># price for limit-order, set up when stop-order executed:</span>
</span><span id="TinkoffBrokerServer-1404"><a href="#-1404"><span class="linenos">1404</span></a>                <span class="n">limit</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>
</span><span id="TinkoffBrokerServer-1405"><a href="#-1405"><span class="linenos">1405</span></a>
</span><span id="TinkoffBrokerServer-1406"><a href="#-1406"><span class="linenos">1406</span></a>                <span class="c1"># necessary changes in percent to reach target from current price:</span>
</span><span id="TinkoffBrokerServer-1407"><a href="#-1407"><span class="linenos">1407</span></a>                <span class="n">changes</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">lastPrice</span> <span class="o">-</span> <span class="n">target</span><span class="p">)</span> <span class="o">/</span> <span class="n">target</span> <span class="k">if</span> <span class="n">lastPrice</span> <span class="o">!=</span> <span class="s2">&quot;N/A&quot;</span> <span class="ow">and</span> <span class="n">target</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="TinkoffBrokerServer-1408"><a href="#-1408"><span class="linenos">1408</span></a>
</span><span id="TinkoffBrokerServer-1409"><a href="#-1409"><span class="linenos">1409</span></a>                <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;stopOrders&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="TinkoffBrokerServer-1410"><a href="#-1410"><span class="linenos">1410</span></a>                    <span class="s2">&quot;orderID&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;stopOrderId&quot;</span><span class="p">],</span>  <span class="c1"># stopOrderId number parameter of current stop-order</span>
</span><span id="TinkoffBrokerServer-1411"><a href="#-1411"><span class="linenos">1411</span></a>                    <span class="s2">&quot;figi&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">],</span>  <span class="c1"># FIGI identification</span>
</span><span id="TinkoffBrokerServer-1412"><a href="#-1412"><span class="linenos">1412</span></a>                    <span class="s2">&quot;ticker&quot;</span><span class="p">:</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">],</span>  <span class="c1"># ticker name by FIGI</span>
</span><span id="TinkoffBrokerServer-1413"><a href="#-1413"><span class="linenos">1413</span></a>                    <span class="s2">&quot;lotsRequested&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;lotsRequested&quot;</span><span class="p">],</span>  <span class="c1"># requested lots value</span>
</span><span id="TinkoffBrokerServer-1414"><a href="#-1414"><span class="linenos">1414</span></a>                    <span class="s2">&quot;currentPrice&quot;</span><span class="p">:</span> <span class="n">lastPrice</span><span class="p">,</span>  <span class="c1"># current instrument&#39;s price for defined action</span>
</span><span id="TinkoffBrokerServer-1415"><a href="#-1415"><span class="linenos">1415</span></a>                    <span class="s2">&quot;targetPrice&quot;</span><span class="p">:</span> <span class="n">target</span><span class="p">,</span>  <span class="c1"># requested price for stop-order execution in base currency</span>
</span><span id="TinkoffBrokerServer-1416"><a href="#-1416"><span class="linenos">1416</span></a>                    <span class="s2">&quot;limitPrice&quot;</span><span class="p">:</span> <span class="n">limit</span><span class="p">,</span>  <span class="c1"># price for limit-order, set up when stop-order executed, 0 if market order</span>
</span><span id="TinkoffBrokerServer-1417"><a href="#-1417"><span class="linenos">1417</span></a>                    <span class="s2">&quot;baseCurrencyName&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;stopPrice&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>  <span class="c1"># name of base currency</span>
</span><span id="TinkoffBrokerServer-1418"><a href="#-1418"><span class="linenos">1418</span></a>                    <span class="s2">&quot;percentChanges&quot;</span><span class="p">:</span> <span class="n">changes</span><span class="p">,</span>  <span class="c1"># changes in percent to target from current price</span>
</span><span id="TinkoffBrokerServer-1419"><a href="#-1419"><span class="linenos">1419</span></a>                    <span class="s2">&quot;currency&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>  <span class="c1"># instrument&#39;s currency name</span>
</span><span id="TinkoffBrokerServer-1420"><a href="#-1420"><span class="linenos">1420</span></a>                    <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span>  <span class="c1"># sell / buy / Unknown from TKS_STOP_ORDER_DIRECTIONS</span>
</span><span id="TinkoffBrokerServer-1421"><a href="#-1421"><span class="linenos">1421</span></a>                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">orderType</span><span class="p">,</span>  <span class="c1"># type of order from TKS_STOP_ORDER_TYPES</span>
</span><span id="TinkoffBrokerServer-1422"><a href="#-1422"><span class="linenos">1422</span></a>                    <span class="s2">&quot;expType&quot;</span><span class="p">:</span> <span class="n">expType</span><span class="p">,</span>  <span class="c1"># expiration type of stop-order from TKS_STOP_ORDER_EXPIRATION_TYPES</span>
</span><span id="TinkoffBrokerServer-1423"><a href="#-1423"><span class="linenos">1423</span></a>                    <span class="s2">&quot;createDate&quot;</span><span class="p">:</span> <span class="n">createDate</span><span class="p">,</span>  <span class="c1"># string with created order date and time from UTC format (without nano seconds part)</span>
</span><span id="TinkoffBrokerServer-1424"><a href="#-1424"><span class="linenos">1424</span></a>                    <span class="s2">&quot;expDate&quot;</span><span class="p">:</span> <span class="n">expDate</span><span class="p">,</span>  <span class="c1"># string with expiration order date and time from UTC format (without nano seconds part)</span>
</span><span id="TinkoffBrokerServer-1425"><a href="#-1425"><span class="linenos">1425</span></a>                <span class="p">})</span>
</span><span id="TinkoffBrokerServer-1426"><a href="#-1426"><span class="linenos">1426</span></a>
</span><span id="TinkoffBrokerServer-1427"><a href="#-1427"><span class="linenos">1427</span></a>        <span class="c1"># --- calculating data for analytics section:</span>
</span><span id="TinkoffBrokerServer-1428"><a href="#-1428"><span class="linenos">1428</span></a>        <span class="c1"># portfolio distribution by assets:</span>
</span><span id="TinkoffBrokerServer-1429"><a href="#-1429"><span class="linenos">1429</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByAssets&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="TinkoffBrokerServer-1430"><a href="#-1430"><span class="linenos">1430</span></a>            <span class="s2">&quot;Ruble&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="TinkoffBrokerServer-1431"><a href="#-1431"><span class="linenos">1431</span></a>                <span class="s2">&quot;uniques&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1432"><a href="#-1432"><span class="linenos">1432</span></a>                <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;availableRUB&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1433"><a href="#-1433"><span class="linenos">1433</span></a>                <span class="s2">&quot;percent&quot;</span><span class="p">:</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;availableRUB&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1434"><a href="#-1434"><span class="linenos">1434</span></a>            <span class="p">},</span>
</span><span id="TinkoffBrokerServer-1435"><a href="#-1435"><span class="linenos">1435</span></a>            <span class="s2">&quot;Currencies&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="TinkoffBrokerServer-1436"><a href="#-1436"><span class="linenos">1436</span></a>                <span class="s2">&quot;uniques&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Currencies&quot;</span><span class="p">]),</span>  <span class="c1"># all foreign currencies without RUB</span>
</span><span id="TinkoffBrokerServer-1437"><a href="#-1437"><span class="linenos">1437</span></a>                <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;allCurrenciesCostRUB&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;availableRUB&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1438"><a href="#-1438"><span class="linenos">1438</span></a>                <span class="s2">&quot;percent&quot;</span><span class="p">:</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;allCurrenciesCostRUB&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;availableRUB&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1439"><a href="#-1439"><span class="linenos">1439</span></a>            <span class="p">},</span>
</span><span id="TinkoffBrokerServer-1440"><a href="#-1440"><span class="linenos">1440</span></a>            <span class="s2">&quot;Shares&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="TinkoffBrokerServer-1441"><a href="#-1441"><span class="linenos">1441</span></a>                <span class="s2">&quot;uniques&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Shares&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer-1442"><a href="#-1442"><span class="linenos">1442</span></a>                <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;stocksCostRUB&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1443"><a href="#-1443"><span class="linenos">1443</span></a>                <span class="s2">&quot;percent&quot;</span><span class="p">:</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;stocksCostRUB&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1444"><a href="#-1444"><span class="linenos">1444</span></a>            <span class="p">},</span>
</span><span id="TinkoffBrokerServer-1445"><a href="#-1445"><span class="linenos">1445</span></a>            <span class="s2">&quot;Bonds&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="TinkoffBrokerServer-1446"><a href="#-1446"><span class="linenos">1446</span></a>                <span class="s2">&quot;uniques&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Bonds&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer-1447"><a href="#-1447"><span class="linenos">1447</span></a>                <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;bondsCostRUB&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1448"><a href="#-1448"><span class="linenos">1448</span></a>                <span class="s2">&quot;percent&quot;</span><span class="p">:</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;bondsCostRUB&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1449"><a href="#-1449"><span class="linenos">1449</span></a>            <span class="p">},</span>
</span><span id="TinkoffBrokerServer-1450"><a href="#-1450"><span class="linenos">1450</span></a>            <span class="s2">&quot;Etfs&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="TinkoffBrokerServer-1451"><a href="#-1451"><span class="linenos">1451</span></a>                <span class="s2">&quot;uniques&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Etfs&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer-1452"><a href="#-1452"><span class="linenos">1452</span></a>                <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;etfsCostRUB&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1453"><a href="#-1453"><span class="linenos">1453</span></a>                <span class="s2">&quot;percent&quot;</span><span class="p">:</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;etfsCostRUB&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1454"><a href="#-1454"><span class="linenos">1454</span></a>            <span class="p">},</span>
</span><span id="TinkoffBrokerServer-1455"><a href="#-1455"><span class="linenos">1455</span></a>            <span class="s2">&quot;Futures&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="TinkoffBrokerServer-1456"><a href="#-1456"><span class="linenos">1456</span></a>                <span class="s2">&quot;uniques&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Futures&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer-1457"><a href="#-1457"><span class="linenos">1457</span></a>                <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;futuresCostRUB&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1458"><a href="#-1458"><span class="linenos">1458</span></a>                <span class="s2">&quot;percent&quot;</span><span class="p">:</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;futuresCostRUB&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1459"><a href="#-1459"><span class="linenos">1459</span></a>            <span class="p">},</span>
</span><span id="TinkoffBrokerServer-1460"><a href="#-1460"><span class="linenos">1460</span></a>        <span class="p">}</span>
</span><span id="TinkoffBrokerServer-1461"><a href="#-1461"><span class="linenos">1461</span></a>
</span><span id="TinkoffBrokerServer-1462"><a href="#-1462"><span class="linenos">1462</span></a>        <span class="c1"># portfolio distribution by companies:</span>
</span><span id="TinkoffBrokerServer-1463"><a href="#-1463"><span class="linenos">1463</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCompanies&quot;</span><span class="p">][</span><span class="s2">&quot;All money cash&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="TinkoffBrokerServer-1464"><a href="#-1464"><span class="linenos">1464</span></a>            <span class="s2">&quot;ticker&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1465"><a href="#-1465"><span class="linenos">1465</span></a>            <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;allCurrenciesCostRUB&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1466"><a href="#-1466"><span class="linenos">1466</span></a>            <span class="s2">&quot;percent&quot;</span><span class="p">:</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;allCurrenciesCostRUB&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1467"><a href="#-1467"><span class="linenos">1467</span></a>        <span class="p">}</span>
</span><span id="TinkoffBrokerServer-1468"><a href="#-1468"><span class="linenos">1468</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCompanies&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">byComp</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-1469"><a href="#-1469"><span class="linenos">1469</span></a>
</span><span id="TinkoffBrokerServer-1470"><a href="#-1470"><span class="linenos">1470</span></a>        <span class="c1"># portfolio distribution by sectors:</span>
</span><span id="TinkoffBrokerServer-1471"><a href="#-1471"><span class="linenos">1471</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrBySectors&quot;</span><span class="p">][</span><span class="s2">&quot;All money cash&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="TinkoffBrokerServer-1472"><a href="#-1472"><span class="linenos">1472</span></a>            <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCompanies&quot;</span><span class="p">][</span><span class="s2">&quot;All money cash&quot;</span><span class="p">][</span><span class="s2">&quot;cost&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1473"><a href="#-1473"><span class="linenos">1473</span></a>            <span class="s2">&quot;percent&quot;</span><span class="p">:</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCompanies&quot;</span><span class="p">][</span><span class="s2">&quot;All money cash&quot;</span><span class="p">][</span><span class="s2">&quot;percent&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1474"><a href="#-1474"><span class="linenos">1474</span></a>        <span class="p">}</span>
</span><span id="TinkoffBrokerServer-1475"><a href="#-1475"><span class="linenos">1475</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrBySectors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">bySect</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-1476"><a href="#-1476"><span class="linenos">1476</span></a>
</span><span id="TinkoffBrokerServer-1477"><a href="#-1477"><span class="linenos">1477</span></a>        <span class="c1"># portfolio distribution by currencies:</span>
</span><span id="TinkoffBrokerServer-1478"><a href="#-1478"><span class="linenos">1478</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCurrencies&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">byCurr</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-1479"><a href="#-1479"><span class="linenos">1479</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCurrencies&quot;</span><span class="p">][</span><span class="s2">&quot;rub&quot;</span><span class="p">][</span><span class="s2">&quot;cost&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByAssets&quot;</span><span class="p">][</span><span class="s2">&quot;Ruble&quot;</span><span class="p">][</span><span class="s2">&quot;cost&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer-1480"><a href="#-1480"><span class="linenos">1480</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCurrencies&quot;</span><span class="p">][</span><span class="s2">&quot;rub&quot;</span><span class="p">][</span><span class="s2">&quot;percent&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByAssets&quot;</span><span class="p">][</span><span class="s2">&quot;Ruble&quot;</span><span class="p">][</span><span class="s2">&quot;percent&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer-1481"><a href="#-1481"><span class="linenos">1481</span></a>
</span><span id="TinkoffBrokerServer-1482"><a href="#-1482"><span class="linenos">1482</span></a>        <span class="c1"># --- Prepare text statistics overview in human-readable:</span>
</span><span id="TinkoffBrokerServer-1483"><a href="#-1483"><span class="linenos">1483</span></a>        <span class="k">if</span> <span class="n">showStatistics</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1484"><a href="#-1484"><span class="linenos">1484</span></a>            <span class="n">info</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="TinkoffBrokerServer-1485"><a href="#-1485"><span class="linenos">1485</span></a>                <span class="s2">&quot;# Client&#39;s portfolio</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1486"><a href="#-1486"><span class="linenos">1486</span></a>                <span class="s2">&quot;* **Actual date:** [</span><span class="si">{}</span><span class="s2">] (UTC)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tzutc</span><span class="p">())</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)),</span>
</span><span id="TinkoffBrokerServer-1487"><a href="#-1487"><span class="linenos">1487</span></a>                <span class="s2">&quot;* **Portfolio cost:** </span><span class="si">{:.2f}</span><span class="s2"> RUB</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer-1488"><a href="#-1488"><span class="linenos">1488</span></a>                <span class="s2">&quot;* **Changes:** </span><span class="si">{}{:.2f}</span><span class="s2"> RUB (</span><span class="si">{}{:.2f}</span><span class="s2">%)</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-1489"><a href="#-1489"><span class="linenos">1489</span></a>                    <span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;totalChangesRUB&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1490"><a href="#-1490"><span class="linenos">1490</span></a>                    <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;totalChangesRUB&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1491"><a href="#-1491"><span class="linenos">1491</span></a>                    <span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;totalChangesPercentRUB&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1492"><a href="#-1492"><span class="linenos">1492</span></a>                    <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;totalChangesPercentRUB&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1493"><a href="#-1493"><span class="linenos">1493</span></a>                <span class="p">),</span>
</span><span id="TinkoffBrokerServer-1494"><a href="#-1494"><span class="linenos">1494</span></a>                <span class="s2">&quot;## Open positions</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1495"><a href="#-1495"><span class="linenos">1495</span></a>                <span class="s2">&quot;| Ticker [FIGI]               | Volume (blocked)                | Lots     | Curr. price  | Avg. price   | Current volume cost | Profit (%)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1496"><a href="#-1496"><span class="linenos">1496</span></a>                <span class="s2">&quot;|-----------------------------|---------------------------------|----------|--------------|--------------|---------------------|----------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1497"><a href="#-1497"><span class="linenos">1497</span></a>                <span class="s2">&quot;| Ruble                       | </span><span class="si">{:&gt;31}</span><span class="s2"> |          |              |              |                     |</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-1498"><a href="#-1498"><span class="linenos">1498</span></a>                    <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2"> (</span><span class="si">{:.2f}</span><span class="s2">) rub&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-1499"><a href="#-1499"><span class="linenos">1499</span></a>                        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;availableRUB&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1500"><a href="#-1500"><span class="linenos">1500</span></a>                        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;currentBlockedRUB&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1501"><a href="#-1501"><span class="linenos">1501</span></a>                    <span class="p">)</span>
</span><span id="TinkoffBrokerServer-1502"><a href="#-1502"><span class="linenos">1502</span></a>                <span class="p">)</span>
</span><span id="TinkoffBrokerServer-1503"><a href="#-1503"><span class="linenos">1503</span></a>            <span class="p">]</span>
</span><span id="TinkoffBrokerServer-1504"><a href="#-1504"><span class="linenos">1504</span></a>
</span><span id="TinkoffBrokerServer-1505"><a href="#-1505"><span class="linenos">1505</span></a>            <span class="k">def</span> <span class="nf">_SplitStr</span><span class="p">(</span><span class="n">CostRUB</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">typeStr</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">noTradeStr</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1506"><a href="#-1506"><span class="linenos">1506</span></a>                <span class="k">return</span> <span class="p">[</span>
</span><span id="TinkoffBrokerServer-1507"><a href="#-1507"><span class="linenos">1507</span></a>                    <span class="s2">&quot;|                             |                                 |          |              |              |                     |</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1508"><a href="#-1508"><span class="linenos">1508</span></a>                    <span class="s2">&quot;| </span><span class="si">{:&lt;27}</span><span class="s2"> |                                 |          |              |              | </span><span class="si">{:&gt;19}</span><span class="s2"> |</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-1509"><a href="#-1509"><span class="linenos">1509</span></a>                        <span class="n">noTradeStr</span> <span class="k">if</span> <span class="n">noTradeStr</span> <span class="k">else</span> <span class="n">typeStr</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1510"><a href="#-1510"><span class="linenos">1510</span></a>                        <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">noTradeStr</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2"> RUB&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">CostRUB</span><span class="p">),</span>
</span><span id="TinkoffBrokerServer-1511"><a href="#-1511"><span class="linenos">1511</span></a>                    <span class="p">),</span>
</span><span id="TinkoffBrokerServer-1512"><a href="#-1512"><span class="linenos">1512</span></a>                <span class="p">]</span>
</span><span id="TinkoffBrokerServer-1513"><a href="#-1513"><span class="linenos">1513</span></a>
</span><span id="TinkoffBrokerServer-1514"><a href="#-1514"><span class="linenos">1514</span></a>            <span class="k">def</span> <span class="nf">_InfoStr</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">showCurrencyName</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1515"><a href="#-1515"><span class="linenos">1515</span></a>                <span class="k">return</span> <span class="s2">&quot;| </span><span class="si">{:&lt;27}</span><span class="s2"> | </span><span class="si">{:&gt;31}</span><span class="s2"> | </span><span class="si">{:&lt;8}</span><span class="s2"> | </span><span class="si">{:&gt;12}</span><span class="s2"> | </span><span class="si">{:&gt;12}</span><span class="s2"> | </span><span class="si">{:&gt;19}</span><span class="s2"> | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-1516"><a href="#-1516"><span class="linenos">1516</span></a>                    <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer-1517"><a href="#-1517"><span class="linenos">1517</span></a>                    <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2"> (</span><span class="si">{:.2f}</span><span class="s2">) </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-1518"><a href="#-1518"><span class="linenos">1518</span></a>                        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;volume&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1519"><a href="#-1519"><span class="linenos">1519</span></a>                        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;blocked&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1520"><a href="#-1520"><span class="linenos">1520</span></a>                        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1521"><a href="#-1521"><span class="linenos">1521</span></a>                    <span class="p">)</span> <span class="k">if</span> <span class="n">showCurrencyName</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2"> (</span><span class="si">{:.0f}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-1522"><a href="#-1522"><span class="linenos">1522</span></a>                        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;volume&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1523"><a href="#-1523"><span class="linenos">1523</span></a>                        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;blocked&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1524"><a href="#-1524"><span class="linenos">1524</span></a>                    <span class="p">),</span>
</span><span id="TinkoffBrokerServer-1525"><a href="#-1525"><span class="linenos">1525</span></a>                    <span class="s2">&quot;</span><span class="si">{:.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;lots&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">showCurrencyName</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;lots&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer-1526"><a href="#-1526"><span class="linenos">1526</span></a>                    <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;baseCurrencyName&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;n/a&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1527"><a href="#-1527"><span class="linenos">1527</span></a>                    <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;average&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;baseCurrencyName&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;average&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;n/a&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1528"><a href="#-1528"><span class="linenos">1528</span></a>                    <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cost&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;baseCurrencyName&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer-1529"><a href="#-1529"><span class="linenos">1529</span></a>                    <span class="s2">&quot;</span><span class="si">{}{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}{:.2f}</span><span class="s2">%)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-1530"><a href="#-1530"><span class="linenos">1530</span></a>                        <span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;profit&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1531"><a href="#-1531"><span class="linenos">1531</span></a>                        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;profit&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;baseCurrencyName&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1532"><a href="#-1532"><span class="linenos">1532</span></a>                        <span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;percentProfit&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1533"><a href="#-1533"><span class="linenos">1533</span></a>                        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;percentProfit&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1534"><a href="#-1534"><span class="linenos">1534</span></a>                    <span class="p">),</span>
</span><span id="TinkoffBrokerServer-1535"><a href="#-1535"><span class="linenos">1535</span></a>                <span class="p">)</span>
</span><span id="TinkoffBrokerServer-1536"><a href="#-1536"><span class="linenos">1536</span></a>
</span><span id="TinkoffBrokerServer-1537"><a href="#-1537"><span class="linenos">1537</span></a>            <span class="c1"># --- Show currencies section:</span>
</span><span id="TinkoffBrokerServer-1538"><a href="#-1538"><span class="linenos">1538</span></a>            <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Currencies&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-1539"><a href="#-1539"><span class="linenos">1539</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_SplitStr</span><span class="p">(</span><span class="n">CostRUB</span><span class="o">=</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByAssets&quot;</span><span class="p">][</span><span class="s2">&quot;Currencies&quot;</span><span class="p">][</span><span class="s2">&quot;cost&quot;</span><span class="p">],</span> <span class="n">typeStr</span><span class="o">=</span><span class="s2">&quot;**Currencies:**&quot;</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-1540"><a href="#-1540"><span class="linenos">1540</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Currencies&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-1541"><a href="#-1541"><span class="linenos">1541</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_InfoStr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">showCurrencyName</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-1542"><a href="#-1542"><span class="linenos">1542</span></a>
</span><span id="TinkoffBrokerServer-1543"><a href="#-1543"><span class="linenos">1543</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1544"><a href="#-1544"><span class="linenos">1544</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_SplitStr</span><span class="p">(</span><span class="n">noTradeStr</span><span class="o">=</span><span class="s2">&quot;**Currencies:** no trades&quot;</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-1545"><a href="#-1545"><span class="linenos">1545</span></a>
</span><span id="TinkoffBrokerServer-1546"><a href="#-1546"><span class="linenos">1546</span></a>            <span class="c1"># --- Show stocks section:</span>
</span><span id="TinkoffBrokerServer-1547"><a href="#-1547"><span class="linenos">1547</span></a>            <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Shares&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-1548"><a href="#-1548"><span class="linenos">1548</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_SplitStr</span><span class="p">(</span><span class="n">CostRUB</span><span class="o">=</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;stocksCostRUB&quot;</span><span class="p">],</span> <span class="n">typeStr</span><span class="o">=</span><span class="s2">&quot;**Stocks:**&quot;</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-1549"><a href="#-1549"><span class="linenos">1549</span></a>
</span><span id="TinkoffBrokerServer-1550"><a href="#-1550"><span class="linenos">1550</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Shares&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-1551"><a href="#-1551"><span class="linenos">1551</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_InfoStr</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-1552"><a href="#-1552"><span class="linenos">1552</span></a>
</span><span id="TinkoffBrokerServer-1553"><a href="#-1553"><span class="linenos">1553</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1554"><a href="#-1554"><span class="linenos">1554</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_SplitStr</span><span class="p">(</span><span class="n">noTradeStr</span><span class="o">=</span><span class="s2">&quot;**Stocks:** no trades&quot;</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-1555"><a href="#-1555"><span class="linenos">1555</span></a>
</span><span id="TinkoffBrokerServer-1556"><a href="#-1556"><span class="linenos">1556</span></a>            <span class="c1"># --- Show bonds section:</span>
</span><span id="TinkoffBrokerServer-1557"><a href="#-1557"><span class="linenos">1557</span></a>            <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Bonds&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-1558"><a href="#-1558"><span class="linenos">1558</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_SplitStr</span><span class="p">(</span><span class="n">CostRUB</span><span class="o">=</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;bondsCostRUB&quot;</span><span class="p">],</span> <span class="n">typeStr</span><span class="o">=</span><span class="s2">&quot;**Bonds:**&quot;</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-1559"><a href="#-1559"><span class="linenos">1559</span></a>
</span><span id="TinkoffBrokerServer-1560"><a href="#-1560"><span class="linenos">1560</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Bonds&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-1561"><a href="#-1561"><span class="linenos">1561</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_InfoStr</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-1562"><a href="#-1562"><span class="linenos">1562</span></a>
</span><span id="TinkoffBrokerServer-1563"><a href="#-1563"><span class="linenos">1563</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1564"><a href="#-1564"><span class="linenos">1564</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_SplitStr</span><span class="p">(</span><span class="n">noTradeStr</span><span class="o">=</span><span class="s2">&quot;**Bonds:** no trades&quot;</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-1565"><a href="#-1565"><span class="linenos">1565</span></a>
</span><span id="TinkoffBrokerServer-1566"><a href="#-1566"><span class="linenos">1566</span></a>            <span class="c1"># --- Show etfs section:</span>
</span><span id="TinkoffBrokerServer-1567"><a href="#-1567"><span class="linenos">1567</span></a>            <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Etfs&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-1568"><a href="#-1568"><span class="linenos">1568</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_SplitStr</span><span class="p">(</span><span class="n">CostRUB</span><span class="o">=</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;etfsCostRUB&quot;</span><span class="p">],</span> <span class="n">typeStr</span><span class="o">=</span><span class="s2">&quot;**Etfs:**&quot;</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-1569"><a href="#-1569"><span class="linenos">1569</span></a>
</span><span id="TinkoffBrokerServer-1570"><a href="#-1570"><span class="linenos">1570</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Etfs&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-1571"><a href="#-1571"><span class="linenos">1571</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_InfoStr</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-1572"><a href="#-1572"><span class="linenos">1572</span></a>
</span><span id="TinkoffBrokerServer-1573"><a href="#-1573"><span class="linenos">1573</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1574"><a href="#-1574"><span class="linenos">1574</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_SplitStr</span><span class="p">(</span><span class="n">noTradeStr</span><span class="o">=</span><span class="s2">&quot;**Etfs:** no trades&quot;</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-1575"><a href="#-1575"><span class="linenos">1575</span></a>
</span><span id="TinkoffBrokerServer-1576"><a href="#-1576"><span class="linenos">1576</span></a>            <span class="c1"># --- Show futures section:</span>
</span><span id="TinkoffBrokerServer-1577"><a href="#-1577"><span class="linenos">1577</span></a>            <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Futures&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-1578"><a href="#-1578"><span class="linenos">1578</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_SplitStr</span><span class="p">(</span><span class="n">CostRUB</span><span class="o">=</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;futuresCostRUB&quot;</span><span class="p">],</span> <span class="n">typeStr</span><span class="o">=</span><span class="s2">&quot;**Futures:**&quot;</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-1579"><a href="#-1579"><span class="linenos">1579</span></a>
</span><span id="TinkoffBrokerServer-1580"><a href="#-1580"><span class="linenos">1580</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Futures&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-1581"><a href="#-1581"><span class="linenos">1581</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_InfoStr</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-1582"><a href="#-1582"><span class="linenos">1582</span></a>
</span><span id="TinkoffBrokerServer-1583"><a href="#-1583"><span class="linenos">1583</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1584"><a href="#-1584"><span class="linenos">1584</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_SplitStr</span><span class="p">(</span><span class="n">noTradeStr</span><span class="o">=</span><span class="s2">&quot;**Futures:** no trades&quot;</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-1585"><a href="#-1585"><span class="linenos">1585</span></a>
</span><span id="TinkoffBrokerServer-1586"><a href="#-1586"><span class="linenos">1586</span></a>            <span class="c1"># --- Show pending orders section:</span>
</span><span id="TinkoffBrokerServer-1587"><a href="#-1587"><span class="linenos">1587</span></a>            <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;orders&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-1588"><a href="#-1588"><span class="linenos">1588</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span><span id="TinkoffBrokerServer-1589"><a href="#-1589"><span class="linenos">1589</span></a>                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">## Opened pending limit-orders: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;orders&quot;</span><span class="p">])),</span>
</span><span id="TinkoffBrokerServer-1590"><a href="#-1590"><span class="linenos">1590</span></a>                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">| Ticker [FIGI]               | Order ID       | Lots (exec.) | Current price (</span><span class="si">% d</span><span class="s2">elta) | Target price  | Action    | Type      | Create date (UTC)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1591"><a href="#-1591"><span class="linenos">1591</span></a>                    <span class="s2">&quot;|-----------------------------|----------------|--------------|-------------------------|---------------|-----------|-----------|---------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1592"><a href="#-1592"><span class="linenos">1592</span></a>                <span class="p">])</span>
</span><span id="TinkoffBrokerServer-1593"><a href="#-1593"><span class="linenos">1593</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;orders&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-1594"><a href="#-1594"><span class="linenos">1594</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| </span><span class="si">{:&lt;27}</span><span class="s2"> | </span><span class="si">{:&lt;14}</span><span class="s2"> | </span><span class="si">{:&lt;12}</span><span class="s2"> | </span><span class="si">{:&gt;23}</span><span class="s2"> | </span><span class="si">{:&gt;13}</span><span class="s2"> | </span><span class="si">{:&lt;9}</span><span class="s2"> | </span><span class="si">{:&lt;9}</span><span class="s2"> | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-1595"><a href="#-1595"><span class="linenos">1595</span></a>                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer-1596"><a href="#-1596"><span class="linenos">1596</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;orderID&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1597"><a href="#-1597"><span class="linenos">1597</span></a>                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;lotsRequested&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;lotsExecuted&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer-1598"><a href="#-1598"><span class="linenos">1598</span></a>                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}{:.2f}</span><span class="s2">%)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-1599"><a href="#-1599"><span class="linenos">1599</span></a>                            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">])),</span>
</span><span id="TinkoffBrokerServer-1600"><a href="#-1600"><span class="linenos">1600</span></a>                            <span class="n">item</span><span class="p">[</span><span class="s2">&quot;baseCurrencyName&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1601"><a href="#-1601"><span class="linenos">1601</span></a>                            <span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;percentChanges&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1602"><a href="#-1602"><span class="linenos">1602</span></a>                            <span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;percentChanges&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer-1603"><a href="#-1603"><span class="linenos">1603</span></a>                        <span class="p">),</span>
</span><span id="TinkoffBrokerServer-1604"><a href="#-1604"><span class="linenos">1604</span></a>                        <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;targetPrice&quot;</span><span class="p">]),</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;baseCurrencyName&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer-1605"><a href="#-1605"><span class="linenos">1605</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1606"><a href="#-1606"><span class="linenos">1606</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1607"><a href="#-1607"><span class="linenos">1607</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1608"><a href="#-1608"><span class="linenos">1608</span></a>                    <span class="p">))</span>
</span><span id="TinkoffBrokerServer-1609"><a href="#-1609"><span class="linenos">1609</span></a>
</span><span id="TinkoffBrokerServer-1610"><a href="#-1610"><span class="linenos">1610</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1611"><a href="#-1611"><span class="linenos">1611</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">## Total pending limit-orders: 0</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-1612"><a href="#-1612"><span class="linenos">1612</span></a>
</span><span id="TinkoffBrokerServer-1613"><a href="#-1613"><span class="linenos">1613</span></a>            <span class="c1"># --- Show stop orders section:</span>
</span><span id="TinkoffBrokerServer-1614"><a href="#-1614"><span class="linenos">1614</span></a>            <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;stopOrders&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-1615"><a href="#-1615"><span class="linenos">1615</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span><span id="TinkoffBrokerServer-1616"><a href="#-1616"><span class="linenos">1616</span></a>                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">## Opened stop-orders: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;stopOrders&quot;</span><span class="p">])),</span>
</span><span id="TinkoffBrokerServer-1617"><a href="#-1617"><span class="linenos">1617</span></a>                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">| Ticker [FIGI]               | Stop order ID                        | Lots   | Current price (</span><span class="si">% d</span><span class="s2">elta) | Target price  | Limit price   | Action    | Type        | Expire type  | Create date (UTC)   | Expiration (UTC)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1618"><a href="#-1618"><span class="linenos">1618</span></a>                    <span class="s2">&quot;|-----------------------------|--------------------------------------|--------|-------------------------|---------------|---------------|-----------|-------------|--------------|---------------------|---------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1619"><a href="#-1619"><span class="linenos">1619</span></a>                <span class="p">])</span>
</span><span id="TinkoffBrokerServer-1620"><a href="#-1620"><span class="linenos">1620</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;stopOrders&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-1621"><a href="#-1621"><span class="linenos">1621</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| </span><span class="si">{:&lt;27}</span><span class="s2"> | </span><span class="si">{:&lt;14}</span><span class="s2"> | </span><span class="si">{:&lt;6}</span><span class="s2"> | </span><span class="si">{:&gt;23}</span><span class="s2"> | </span><span class="si">{:&gt;13}</span><span class="s2"> | </span><span class="si">{:&gt;13}</span><span class="s2"> | </span><span class="si">{:&lt;9}</span><span class="s2"> | </span><span class="si">{:&lt;11}</span><span class="s2"> | </span><span class="si">{:&lt;12}</span><span class="s2"> | </span><span class="si">{:&lt;19}</span><span class="s2"> | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-1622"><a href="#-1622"><span class="linenos">1622</span></a>                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer-1623"><a href="#-1623"><span class="linenos">1623</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;orderID&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1624"><a href="#-1624"><span class="linenos">1624</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;lotsRequested&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1625"><a href="#-1625"><span class="linenos">1625</span></a>                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}{:.2f}</span><span class="s2">%)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-1626"><a href="#-1626"><span class="linenos">1626</span></a>                            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">])),</span>
</span><span id="TinkoffBrokerServer-1627"><a href="#-1627"><span class="linenos">1627</span></a>                            <span class="n">item</span><span class="p">[</span><span class="s2">&quot;baseCurrencyName&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1628"><a href="#-1628"><span class="linenos">1628</span></a>                            <span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;percentChanges&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1629"><a href="#-1629"><span class="linenos">1629</span></a>                            <span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;percentChanges&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer-1630"><a href="#-1630"><span class="linenos">1630</span></a>                        <span class="p">),</span>
</span><span id="TinkoffBrokerServer-1631"><a href="#-1631"><span class="linenos">1631</span></a>                        <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;targetPrice&quot;</span><span class="p">]),</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;baseCurrencyName&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer-1632"><a href="#-1632"><span class="linenos">1632</span></a>                        <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;limitPrice&quot;</span><span class="p">]),</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;baseCurrencyName&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;limitPrice&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;limitPrice&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;targetPrice&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="n">TKS_ORDER_TYPES</span><span class="p">[</span><span class="s2">&quot;ORDER_TYPE_MARKET&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1633"><a href="#-1633"><span class="linenos">1633</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1634"><a href="#-1634"><span class="linenos">1634</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1635"><a href="#-1635"><span class="linenos">1635</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;expType&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1636"><a href="#-1636"><span class="linenos">1636</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;createDate&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1637"><a href="#-1637"><span class="linenos">1637</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;expDate&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1638"><a href="#-1638"><span class="linenos">1638</span></a>                    <span class="p">))</span>
</span><span id="TinkoffBrokerServer-1639"><a href="#-1639"><span class="linenos">1639</span></a>
</span><span id="TinkoffBrokerServer-1640"><a href="#-1640"><span class="linenos">1640</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1641"><a href="#-1641"><span class="linenos">1641</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">## Total stop-orders: 0</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-1642"><a href="#-1642"><span class="linenos">1642</span></a>
</span><span id="TinkoffBrokerServer-1643"><a href="#-1643"><span class="linenos">1643</span></a>            <span class="c1"># -- Show analytics section:</span>
</span><span id="TinkoffBrokerServer-1644"><a href="#-1644"><span class="linenos">1644</span></a>            <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1645"><a href="#-1645"><span class="linenos">1645</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span><span id="TinkoffBrokerServer-1646"><a href="#-1646"><span class="linenos">1646</span></a>                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"># Analytics</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="TinkoffBrokerServer-1647"><a href="#-1647"><span class="linenos">1647</span></a>                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">* **Current total portfolio cost:** </span><span class="si">{:.2f}</span><span class="s2"> RUB</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer-1648"><a href="#-1648"><span class="linenos">1648</span></a>                    <span class="s2">&quot;* **Changes:** </span><span class="si">{}{:.2f}</span><span class="s2"> RUB (</span><span class="si">{}{:.2f}</span><span class="s2">%)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-1649"><a href="#-1649"><span class="linenos">1649</span></a>                        <span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;totalChangesRUB&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1650"><a href="#-1650"><span class="linenos">1650</span></a>                        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;totalChangesRUB&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1651"><a href="#-1651"><span class="linenos">1651</span></a>                        <span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;totalChangesPercentRUB&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1652"><a href="#-1652"><span class="linenos">1652</span></a>                        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;totalChangesPercentRUB&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1653"><a href="#-1653"><span class="linenos">1653</span></a>                    <span class="p">),</span>
</span><span id="TinkoffBrokerServer-1654"><a href="#-1654"><span class="linenos">1654</span></a>                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">## Portfolio distribution by assets</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="TinkoffBrokerServer-1655"><a href="#-1655"><span class="linenos">1655</span></a>                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">| Type       | Uniques | Percent | Current cost</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1656"><a href="#-1656"><span class="linenos">1656</span></a>                    <span class="s2">&quot;|------------|---------|---------|-----------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1657"><a href="#-1657"><span class="linenos">1657</span></a>                <span class="p">])</span>
</span><span id="TinkoffBrokerServer-1658"><a href="#-1658"><span class="linenos">1658</span></a>
</span><span id="TinkoffBrokerServer-1659"><a href="#-1659"><span class="linenos">1659</span></a>                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByAssets&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-1660"><a href="#-1660"><span class="linenos">1660</span></a>                    <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByAssets&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;cost&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1661"><a href="#-1661"><span class="linenos">1661</span></a>                        <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| </span><span class="si">{:&lt;10}</span><span class="s2"> | </span><span class="si">{:&lt;7}</span><span class="s2"> | </span><span class="si">{:&lt;7}</span><span class="s2"> | </span><span class="si">{:.2f}</span><span class="s2"> rub</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-1662"><a href="#-1662"><span class="linenos">1662</span></a>                            <span class="n">key</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1663"><a href="#-1663"><span class="linenos">1663</span></a>                            <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByAssets&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;uniques&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1664"><a href="#-1664"><span class="linenos">1664</span></a>                            <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByAssets&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;percent&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer-1665"><a href="#-1665"><span class="linenos">1665</span></a>                            <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByAssets&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;cost&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1666"><a href="#-1666"><span class="linenos">1666</span></a>                        <span class="p">))</span>
</span><span id="TinkoffBrokerServer-1667"><a href="#-1667"><span class="linenos">1667</span></a>
</span><span id="TinkoffBrokerServer-1668"><a href="#-1668"><span class="linenos">1668</span></a>                <span class="n">maxLenNames</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">+</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">company</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCompanies&quot;</span><span class="p">][</span><span class="n">company</span><span class="p">][</span><span class="s2">&quot;ticker&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">company</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCompanies&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
</span><span id="TinkoffBrokerServer-1669"><a href="#-1669"><span class="linenos">1669</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span><span id="TinkoffBrokerServer-1670"><a href="#-1670"><span class="linenos">1670</span></a>                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">## Portfolio distribution by companies</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="TinkoffBrokerServer-1671"><a href="#-1671"><span class="linenos">1671</span></a>                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">| Company</span><span class="si">{}</span><span class="s2"> | Percent | Current cost</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxLenNames</span> <span class="o">-</span> <span class="mi">7</span><span class="p">)),</span>
</span><span id="TinkoffBrokerServer-1672"><a href="#-1672"><span class="linenos">1672</span></a>                    <span class="s2">&quot;|--------</span><span class="si">{}</span><span class="s2">-|---------|-----------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxLenNames</span> <span class="o">-</span> <span class="mi">7</span><span class="p">)),</span>
</span><span id="TinkoffBrokerServer-1673"><a href="#-1673"><span class="linenos">1673</span></a>                <span class="p">])</span>
</span><span id="TinkoffBrokerServer-1674"><a href="#-1674"><span class="linenos">1674</span></a>
</span><span id="TinkoffBrokerServer-1675"><a href="#-1675"><span class="linenos">1675</span></a>                <span class="k">for</span> <span class="n">company</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCompanies&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-1676"><a href="#-1676"><span class="linenos">1676</span></a>                    <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCompanies&quot;</span><span class="p">][</span><span class="n">company</span><span class="p">][</span><span class="s2">&quot;cost&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1677"><a href="#-1677"><span class="linenos">1677</span></a>                        <span class="n">nameLen</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">company</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCompanies&quot;</span><span class="p">][</span><span class="n">company</span><span class="p">][</span><span class="s2">&quot;ticker&quot;</span><span class="p">])</span>
</span><span id="TinkoffBrokerServer-1678"><a href="#-1678"><span class="linenos">1678</span></a>                        <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| </span><span class="si">{}</span><span class="s2"> | </span><span class="si">{:&lt;7}</span><span class="s2"> | </span><span class="si">{:.2f}</span><span class="s2"> rub</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-1679"><a href="#-1679"><span class="linenos">1679</span></a>                            <span class="s2">&quot;</span><span class="si">{}{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-1680"><a href="#-1680"><span class="linenos">1680</span></a>                                <span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">] &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCompanies&quot;</span><span class="p">][</span><span class="n">company</span><span class="p">][</span><span class="s2">&quot;ticker&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCompanies&quot;</span><span class="p">][</span><span class="n">company</span><span class="p">][</span><span class="s2">&quot;ticker&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1681"><a href="#-1681"><span class="linenos">1681</span></a>                                <span class="n">company</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1682"><a href="#-1682"><span class="linenos">1682</span></a>                                <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">nameLen</span> <span class="o">==</span> <span class="n">maxLenNames</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxLenNames</span> <span class="o">-</span> <span class="n">nameLen</span><span class="p">)</span> <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCompanies&quot;</span><span class="p">][</span><span class="n">company</span><span class="p">][</span><span class="s2">&quot;ticker&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxLenNames</span> <span class="o">-</span> <span class="n">nameLen</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)),</span>
</span><span id="TinkoffBrokerServer-1683"><a href="#-1683"><span class="linenos">1683</span></a>                            <span class="p">),</span>
</span><span id="TinkoffBrokerServer-1684"><a href="#-1684"><span class="linenos">1684</span></a>                            <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCompanies&quot;</span><span class="p">][</span><span class="n">company</span><span class="p">][</span><span class="s2">&quot;percent&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer-1685"><a href="#-1685"><span class="linenos">1685</span></a>                            <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCompanies&quot;</span><span class="p">][</span><span class="n">company</span><span class="p">][</span><span class="s2">&quot;cost&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1686"><a href="#-1686"><span class="linenos">1686</span></a>                        <span class="p">))</span>
</span><span id="TinkoffBrokerServer-1687"><a href="#-1687"><span class="linenos">1687</span></a>
</span><span id="TinkoffBrokerServer-1688"><a href="#-1688"><span class="linenos">1688</span></a>                <span class="n">maxLenSectors</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">sector</span><span class="p">)</span> <span class="k">for</span> <span class="n">sector</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrBySectors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
</span><span id="TinkoffBrokerServer-1689"><a href="#-1689"><span class="linenos">1689</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span><span id="TinkoffBrokerServer-1690"><a href="#-1690"><span class="linenos">1690</span></a>                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">## Portfolio distribution by sectors</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="TinkoffBrokerServer-1691"><a href="#-1691"><span class="linenos">1691</span></a>                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">| Sector</span><span class="si">{}</span><span class="s2"> | Percent | Current cost</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxLenSectors</span> <span class="o">-</span> <span class="mi">6</span><span class="p">)),</span>
</span><span id="TinkoffBrokerServer-1692"><a href="#-1692"><span class="linenos">1692</span></a>                    <span class="s2">&quot;|-------</span><span class="si">{}</span><span class="s2">-|---------|-----------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxLenSectors</span> <span class="o">-</span> <span class="mi">6</span><span class="p">)),</span>
</span><span id="TinkoffBrokerServer-1693"><a href="#-1693"><span class="linenos">1693</span></a>                <span class="p">])</span>
</span><span id="TinkoffBrokerServer-1694"><a href="#-1694"><span class="linenos">1694</span></a>
</span><span id="TinkoffBrokerServer-1695"><a href="#-1695"><span class="linenos">1695</span></a>                <span class="k">for</span> <span class="n">sector</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrBySectors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-1696"><a href="#-1696"><span class="linenos">1696</span></a>                    <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrBySectors&quot;</span><span class="p">][</span><span class="n">sector</span><span class="p">][</span><span class="s2">&quot;cost&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1697"><a href="#-1697"><span class="linenos">1697</span></a>                        <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| </span><span class="si">{}{}</span><span class="s2"> | </span><span class="si">{:&lt;7}</span><span class="s2"> | </span><span class="si">{:.2f}</span><span class="s2"> rub</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-1698"><a href="#-1698"><span class="linenos">1698</span></a>                            <span class="n">sector</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1699"><a href="#-1699"><span class="linenos">1699</span></a>                            <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sector</span><span class="p">)</span> <span class="o">==</span> <span class="n">maxLenSectors</span> <span class="k">else</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxLenSectors</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">sector</span><span class="p">)),</span>
</span><span id="TinkoffBrokerServer-1700"><a href="#-1700"><span class="linenos">1700</span></a>                            <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrBySectors&quot;</span><span class="p">][</span><span class="n">sector</span><span class="p">][</span><span class="s2">&quot;percent&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer-1701"><a href="#-1701"><span class="linenos">1701</span></a>                            <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrBySectors&quot;</span><span class="p">][</span><span class="n">sector</span><span class="p">][</span><span class="s2">&quot;cost&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1702"><a href="#-1702"><span class="linenos">1702</span></a>                        <span class="p">))</span>
</span><span id="TinkoffBrokerServer-1703"><a href="#-1703"><span class="linenos">1703</span></a>
</span><span id="TinkoffBrokerServer-1704"><a href="#-1704"><span class="linenos">1704</span></a>                <span class="n">maxLenMoney</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">+</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">currency</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCurrencies&quot;</span><span class="p">][</span><span class="n">currency</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">currency</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCurrencies&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
</span><span id="TinkoffBrokerServer-1705"><a href="#-1705"><span class="linenos">1705</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span><span id="TinkoffBrokerServer-1706"><a href="#-1706"><span class="linenos">1706</span></a>                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">## Portfolio distribution by currencies</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="TinkoffBrokerServer-1707"><a href="#-1707"><span class="linenos">1707</span></a>                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">| Instruments currencies</span><span class="si">{}</span><span class="s2"> | Percent | Current cost</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxLenMoney</span> <span class="o">-</span> <span class="mi">22</span><span class="p">)),</span>
</span><span id="TinkoffBrokerServer-1708"><a href="#-1708"><span class="linenos">1708</span></a>                    <span class="s2">&quot;|-----------------------</span><span class="si">{}</span><span class="s2">-|---------|-----------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxLenMoney</span> <span class="o">-</span> <span class="mi">22</span><span class="p">)),</span>
</span><span id="TinkoffBrokerServer-1709"><a href="#-1709"><span class="linenos">1709</span></a>                <span class="p">])</span>
</span><span id="TinkoffBrokerServer-1710"><a href="#-1710"><span class="linenos">1710</span></a>
</span><span id="TinkoffBrokerServer-1711"><a href="#-1711"><span class="linenos">1711</span></a>                <span class="k">for</span> <span class="n">curr</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCurrencies&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-1712"><a href="#-1712"><span class="linenos">1712</span></a>                    <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCurrencies&quot;</span><span class="p">][</span><span class="n">curr</span><span class="p">][</span><span class="s2">&quot;cost&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1713"><a href="#-1713"><span class="linenos">1713</span></a>                        <span class="n">nameLen</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">curr</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCurrencies&quot;</span><span class="p">][</span><span class="n">curr</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
</span><span id="TinkoffBrokerServer-1714"><a href="#-1714"><span class="linenos">1714</span></a>                        <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| </span><span class="si">{}</span><span class="s2"> | </span><span class="si">{:&lt;7}</span><span class="s2"> | </span><span class="si">{:.2f}</span><span class="s2"> rub</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-1715"><a href="#-1715"><span class="linenos">1715</span></a>                            <span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">] </span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-1716"><a href="#-1716"><span class="linenos">1716</span></a>                                <span class="n">curr</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1717"><a href="#-1717"><span class="linenos">1717</span></a>                                <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCurrencies&quot;</span><span class="p">][</span><span class="n">curr</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1718"><a href="#-1718"><span class="linenos">1718</span></a>                                <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">nameLen</span> <span class="o">==</span> <span class="n">maxLenMoney</span> <span class="k">else</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxLenMoney</span> <span class="o">-</span> <span class="n">nameLen</span><span class="p">),</span>
</span><span id="TinkoffBrokerServer-1719"><a href="#-1719"><span class="linenos">1719</span></a>                            <span class="p">),</span>
</span><span id="TinkoffBrokerServer-1720"><a href="#-1720"><span class="linenos">1720</span></a>                            <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCurrencies&quot;</span><span class="p">][</span><span class="n">curr</span><span class="p">][</span><span class="s2">&quot;percent&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer-1721"><a href="#-1721"><span class="linenos">1721</span></a>                            <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCurrencies&quot;</span><span class="p">][</span><span class="n">curr</span><span class="p">][</span><span class="s2">&quot;cost&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1722"><a href="#-1722"><span class="linenos">1722</span></a>                        <span class="p">))</span>
</span><span id="TinkoffBrokerServer-1723"><a href="#-1723"><span class="linenos">1723</span></a>
</span><span id="TinkoffBrokerServer-1724"><a href="#-1724"><span class="linenos">1724</span></a>            <span class="n">infoText</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-1725"><a href="#-1725"><span class="linenos">1725</span></a>
</span><span id="TinkoffBrokerServer-1726"><a href="#-1726"><span class="linenos">1726</span></a>            <span class="k">if</span> <span class="n">showStatistics</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1727"><a href="#-1727"><span class="linenos">1727</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Statistics of client&#39;s portfolio:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">infoText</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-1728"><a href="#-1728"><span class="linenos">1728</span></a>
</span><span id="TinkoffBrokerServer-1729"><a href="#-1729"><span class="linenos">1729</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">overviewFile</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1730"><a href="#-1730"><span class="linenos">1730</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overviewFile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fH</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1731"><a href="#-1731"><span class="linenos">1731</span></a>                    <span class="n">fH</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">infoText</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-1732"><a href="#-1732"><span class="linenos">1732</span></a>
</span><span id="TinkoffBrokerServer-1733"><a href="#-1733"><span class="linenos">1733</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Client&#39;s portfolio is saved to file: [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overviewFile</span><span class="p">)))</span>
</span><span id="TinkoffBrokerServer-1734"><a href="#-1734"><span class="linenos">1734</span></a>
</span><span id="TinkoffBrokerServer-1735"><a href="#-1735"><span class="linenos">1735</span></a>        <span class="k">return</span> <span class="n">view</span>
</span><span id="TinkoffBrokerServer-1736"><a href="#-1736"><span class="linenos">1736</span></a>
</span><span id="TinkoffBrokerServer-1737"><a href="#-1737"><span class="linenos">1737</span></a>    <span class="k">def</span> <span class="nf">Deals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">printDeals</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1738"><a href="#-1738"><span class="linenos">1738</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-1739"><a href="#-1739"><span class="linenos">1739</span></a><span class="sd">        Returns history operations between two given dates.</span>
</span><span id="TinkoffBrokerServer-1740"><a href="#-1740"><span class="linenos">1740</span></a><span class="sd">        If `reportFile` string is not empty then also save human-readable report.</span>
</span><span id="TinkoffBrokerServer-1741"><a href="#-1741"><span class="linenos">1741</span></a><span class="sd">        Shows some statistical data of closed positions.</span>
</span><span id="TinkoffBrokerServer-1742"><a href="#-1742"><span class="linenos">1742</span></a>
</span><span id="TinkoffBrokerServer-1743"><a href="#-1743"><span class="linenos">1743</span></a><span class="sd">        :param start: see docstring in `GetDatesAsString()` method</span>
</span><span id="TinkoffBrokerServer-1744"><a href="#-1744"><span class="linenos">1744</span></a><span class="sd">        :param end: see docstring in `GetDatesAsString()` method</span>
</span><span id="TinkoffBrokerServer-1745"><a href="#-1745"><span class="linenos">1745</span></a><span class="sd">        :param printDeals: if `True` then also print all records to the console.</span>
</span><span id="TinkoffBrokerServer-1746"><a href="#-1746"><span class="linenos">1746</span></a><span class="sd">        :return: original list of dictionaries with history of deals records from API (&quot;operations&quot; key):</span>
</span><span id="TinkoffBrokerServer-1747"><a href="#-1747"><span class="linenos">1747</span></a><span class="sd">                 https://tinkoff.github.io/investAPI/swagger-ui/#/OperationsService/OperationsService_GetOperations</span>
</span><span id="TinkoffBrokerServer-1748"><a href="#-1748"><span class="linenos">1748</span></a><span class="sd">                 and dictionary with custom stats: operations in different currencies, withdrawals, incomes etc.</span>
</span><span id="TinkoffBrokerServer-1749"><a href="#-1749"><span class="linenos">1749</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-1750"><a href="#-1750"><span class="linenos">1750</span></a>        <span class="n">startDate</span><span class="p">,</span> <span class="n">endDate</span> <span class="o">=</span> <span class="n">GetDatesAsString</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>  <span class="c1"># Example: (&quot;2000-01-01T00:00:00Z&quot;, &quot;2022-12-31T23:59:59Z&quot;)</span>
</span><span id="TinkoffBrokerServer-1751"><a href="#-1751"><span class="linenos">1751</span></a>
</span><span id="TinkoffBrokerServer-1752"><a href="#-1752"><span class="linenos">1752</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Requesting history of a client&#39;s operations. Wait, please...&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-1753"><a href="#-1753"><span class="linenos">1753</span></a>
</span><span id="TinkoffBrokerServer-1754"><a href="#-1754"><span class="linenos">1754</span></a>        <span class="c1"># REST API for request: https://tinkoff.github.io/investAPI/swagger-ui/#/OperationsService/OperationsService_GetOperations</span>
</span><span id="TinkoffBrokerServer-1755"><a href="#-1755"><span class="linenos">1755</span></a>        <span class="n">dealsURL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;/tinkoff.public.invest.api.contract.v1.OperationsService/GetOperations&quot;</span>
</span><span id="TinkoffBrokerServer-1756"><a href="#-1756"><span class="linenos">1756</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="nb">str</span><span class="p">({</span><span class="s2">&quot;accountId&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">accountId</span><span class="p">,</span> <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="n">startDate</span><span class="p">,</span> <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="n">endDate</span><span class="p">})</span>
</span><span id="TinkoffBrokerServer-1757"><a href="#-1757"><span class="linenos">1757</span></a>        <span class="n">ops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SendAPIRequest</span><span class="p">(</span><span class="n">dealsURL</span><span class="p">,</span> <span class="n">reqType</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">)[</span><span class="s2">&quot;operations&quot;</span><span class="p">]</span>  <span class="c1"># list of dict: operations returns by broker</span>
</span><span id="TinkoffBrokerServer-1758"><a href="#-1758"><span class="linenos">1758</span></a>        <span class="n">customStat</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># custom statistics in additional to responseJSON</span>
</span><span id="TinkoffBrokerServer-1759"><a href="#-1759"><span class="linenos">1759</span></a>
</span><span id="TinkoffBrokerServer-1760"><a href="#-1760"><span class="linenos">1760</span></a>        <span class="c1"># --- output report in human-readable format:</span>
</span><span id="TinkoffBrokerServer-1761"><a href="#-1761"><span class="linenos">1761</span></a>        <span class="k">if</span> <span class="n">printDeals</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">reportFile</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1762"><a href="#-1762"><span class="linenos">1762</span></a>            <span class="n">splitLine1</span> <span class="o">=</span> <span class="s2">&quot;|                            |                               |                              |                      |</span><span class="se">\n</span><span class="s2">&quot;</span>  <span class="c1"># Summary section</span>
</span><span id="TinkoffBrokerServer-1763"><a href="#-1763"><span class="linenos">1763</span></a>            <span class="n">splitLine2</span> <span class="o">=</span> <span class="s2">&quot;|                     |              |              |            |           |                 |            |</span><span class="se">\n</span><span class="s2">&quot;</span>  <span class="c1"># Operations section</span>
</span><span id="TinkoffBrokerServer-1764"><a href="#-1764"><span class="linenos">1764</span></a>            <span class="n">nextDay</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-1765"><a href="#-1765"><span class="linenos">1765</span></a>
</span><span id="TinkoffBrokerServer-1766"><a href="#-1766"><span class="linenos">1766</span></a>            <span class="n">info</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;# Client&#39;s operations</span><span class="se">\n\n</span><span class="s2">* **Period:** from [</span><span class="si">{}</span><span class="s2">] to [</span><span class="si">{}</span><span class="s2">]</span><span class="se">\n\n</span><span class="s2">## Summary (operations executed only)</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">startDate</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">endDate</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])]</span>
</span><span id="TinkoffBrokerServer-1767"><a href="#-1767"><span class="linenos">1767</span></a>
</span><span id="TinkoffBrokerServer-1768"><a href="#-1768"><span class="linenos">1768</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ops</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1769"><a href="#-1769"><span class="linenos">1769</span></a>                <span class="n">customStat</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="TinkoffBrokerServer-1770"><a href="#-1770"><span class="linenos">1770</span></a>                    <span class="s2">&quot;opsCount&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># total operations count</span>
</span><span id="TinkoffBrokerServer-1771"><a href="#-1771"><span class="linenos">1771</span></a>                    <span class="s2">&quot;buyCount&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># buy operations</span>
</span><span id="TinkoffBrokerServer-1772"><a href="#-1772"><span class="linenos">1772</span></a>                    <span class="s2">&quot;sellCount&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># sell operations</span>
</span><span id="TinkoffBrokerServer-1773"><a href="#-1773"><span class="linenos">1773</span></a>                    <span class="s2">&quot;buyTotal&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rub&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">},</span>  <span class="c1"># Buy sums in different currencies</span>
</span><span id="TinkoffBrokerServer-1774"><a href="#-1774"><span class="linenos">1774</span></a>                    <span class="s2">&quot;sellTotal&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rub&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">},</span>  <span class="c1"># Sell sums in different currencies</span>
</span><span id="TinkoffBrokerServer-1775"><a href="#-1775"><span class="linenos">1775</span></a>                    <span class="s2">&quot;payIn&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rub&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">},</span>  <span class="c1"># Deposit brokerage account</span>
</span><span id="TinkoffBrokerServer-1776"><a href="#-1776"><span class="linenos">1776</span></a>                    <span class="s2">&quot;payOut&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rub&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">},</span>  <span class="c1"># Withdrawals</span>
</span><span id="TinkoffBrokerServer-1777"><a href="#-1777"><span class="linenos">1777</span></a>                    <span class="s2">&quot;divs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rub&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">},</span>  <span class="c1"># Dividends income</span>
</span><span id="TinkoffBrokerServer-1778"><a href="#-1778"><span class="linenos">1778</span></a>                    <span class="s2">&quot;coupons&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rub&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">},</span>  <span class="c1"># Coupon&#39;s income</span>
</span><span id="TinkoffBrokerServer-1779"><a href="#-1779"><span class="linenos">1779</span></a>                    <span class="s2">&quot;brokerCom&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rub&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">},</span>  <span class="c1"># Service commissions</span>
</span><span id="TinkoffBrokerServer-1780"><a href="#-1780"><span class="linenos">1780</span></a>                    <span class="s2">&quot;serviceCom&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rub&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">},</span>  <span class="c1"># Service commissions</span>
</span><span id="TinkoffBrokerServer-1781"><a href="#-1781"><span class="linenos">1781</span></a>                    <span class="s2">&quot;marginCom&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rub&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">},</span>  <span class="c1"># Margin commissions</span>
</span><span id="TinkoffBrokerServer-1782"><a href="#-1782"><span class="linenos">1782</span></a>                    <span class="s2">&quot;allTaxes&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rub&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">},</span>  <span class="c1"># Sum of withholding taxes and corrections</span>
</span><span id="TinkoffBrokerServer-1783"><a href="#-1783"><span class="linenos">1783</span></a>                <span class="p">}</span>
</span><span id="TinkoffBrokerServer-1784"><a href="#-1784"><span class="linenos">1784</span></a>
</span><span id="TinkoffBrokerServer-1785"><a href="#-1785"><span class="linenos">1785</span></a>                <span class="c1"># --- calculating statistics depends on operations type in TKS_OPERATION_TYPES:</span>
</span><span id="TinkoffBrokerServer-1786"><a href="#-1786"><span class="linenos">1786</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1787"><a href="#-1787"><span class="linenos">1787</span></a>                    <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;OPERATION_STATE_EXECUTED&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1788"><a href="#-1788"><span class="linenos">1788</span></a>                        <span class="n">payment</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>
</span><span id="TinkoffBrokerServer-1789"><a href="#-1789"><span class="linenos">1789</span></a>
</span><span id="TinkoffBrokerServer-1790"><a href="#-1790"><span class="linenos">1790</span></a>                        <span class="c1"># count buy operations:</span>
</span><span id="TinkoffBrokerServer-1791"><a href="#-1791"><span class="linenos">1791</span></a>                        <span class="k">if</span> <span class="s2">&quot;_BUY&quot;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;operationType&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-1792"><a href="#-1792"><span class="linenos">1792</span></a>                            <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;buyCount&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="TinkoffBrokerServer-1793"><a href="#-1793"><span class="linenos">1793</span></a>
</span><span id="TinkoffBrokerServer-1794"><a href="#-1794"><span class="linenos">1794</span></a>                            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;buyTotal&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-1795"><a href="#-1795"><span class="linenos">1795</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;buyTotal&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">payment</span>
</span><span id="TinkoffBrokerServer-1796"><a href="#-1796"><span class="linenos">1796</span></a>
</span><span id="TinkoffBrokerServer-1797"><a href="#-1797"><span class="linenos">1797</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1798"><a href="#-1798"><span class="linenos">1798</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;buyTotal&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">payment</span>
</span><span id="TinkoffBrokerServer-1799"><a href="#-1799"><span class="linenos">1799</span></a>
</span><span id="TinkoffBrokerServer-1800"><a href="#-1800"><span class="linenos">1800</span></a>                        <span class="c1"># count sell operations:</span>
</span><span id="TinkoffBrokerServer-1801"><a href="#-1801"><span class="linenos">1801</span></a>                        <span class="k">elif</span> <span class="s2">&quot;_SELL&quot;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;operationType&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-1802"><a href="#-1802"><span class="linenos">1802</span></a>                            <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;sellCount&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="TinkoffBrokerServer-1803"><a href="#-1803"><span class="linenos">1803</span></a>
</span><span id="TinkoffBrokerServer-1804"><a href="#-1804"><span class="linenos">1804</span></a>                            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;sellTotal&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-1805"><a href="#-1805"><span class="linenos">1805</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;sellTotal&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">payment</span>
</span><span id="TinkoffBrokerServer-1806"><a href="#-1806"><span class="linenos">1806</span></a>
</span><span id="TinkoffBrokerServer-1807"><a href="#-1807"><span class="linenos">1807</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1808"><a href="#-1808"><span class="linenos">1808</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;sellTotal&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">payment</span>
</span><span id="TinkoffBrokerServer-1809"><a href="#-1809"><span class="linenos">1809</span></a>
</span><span id="TinkoffBrokerServer-1810"><a href="#-1810"><span class="linenos">1810</span></a>                        <span class="c1"># count incoming operations:</span>
</span><span id="TinkoffBrokerServer-1811"><a href="#-1811"><span class="linenos">1811</span></a>                        <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;operationType&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;OPERATION_TYPE_INPUT&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-1812"><a href="#-1812"><span class="linenos">1812</span></a>                            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;payIn&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-1813"><a href="#-1813"><span class="linenos">1813</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;payIn&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">payment</span>
</span><span id="TinkoffBrokerServer-1814"><a href="#-1814"><span class="linenos">1814</span></a>
</span><span id="TinkoffBrokerServer-1815"><a href="#-1815"><span class="linenos">1815</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1816"><a href="#-1816"><span class="linenos">1816</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;payIn&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">payment</span>
</span><span id="TinkoffBrokerServer-1817"><a href="#-1817"><span class="linenos">1817</span></a>
</span><span id="TinkoffBrokerServer-1818"><a href="#-1818"><span class="linenos">1818</span></a>                        <span class="c1"># count withdrawals operations:</span>
</span><span id="TinkoffBrokerServer-1819"><a href="#-1819"><span class="linenos">1819</span></a>                        <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;operationType&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;OPERATION_TYPE_OUTPUT&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-1820"><a href="#-1820"><span class="linenos">1820</span></a>                            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;payOut&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-1821"><a href="#-1821"><span class="linenos">1821</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;payOut&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">payment</span>
</span><span id="TinkoffBrokerServer-1822"><a href="#-1822"><span class="linenos">1822</span></a>
</span><span id="TinkoffBrokerServer-1823"><a href="#-1823"><span class="linenos">1823</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1824"><a href="#-1824"><span class="linenos">1824</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;payOut&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">payment</span>
</span><span id="TinkoffBrokerServer-1825"><a href="#-1825"><span class="linenos">1825</span></a>
</span><span id="TinkoffBrokerServer-1826"><a href="#-1826"><span class="linenos">1826</span></a>                        <span class="c1"># count dividends income:</span>
</span><span id="TinkoffBrokerServer-1827"><a href="#-1827"><span class="linenos">1827</span></a>                        <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;operationType&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;OPERATION_TYPE_DIVIDEND&quot;</span><span class="p">,</span> <span class="s2">&quot;OPERATION_TYPE_DIVIDEND_TRANSFER&quot;</span><span class="p">,</span> <span class="s2">&quot;OPERATION_TYPE_DIV_EXT&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-1828"><a href="#-1828"><span class="linenos">1828</span></a>                            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;divs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-1829"><a href="#-1829"><span class="linenos">1829</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;divs&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">payment</span>
</span><span id="TinkoffBrokerServer-1830"><a href="#-1830"><span class="linenos">1830</span></a>
</span><span id="TinkoffBrokerServer-1831"><a href="#-1831"><span class="linenos">1831</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1832"><a href="#-1832"><span class="linenos">1832</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;divs&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">payment</span>
</span><span id="TinkoffBrokerServer-1833"><a href="#-1833"><span class="linenos">1833</span></a>
</span><span id="TinkoffBrokerServer-1834"><a href="#-1834"><span class="linenos">1834</span></a>                        <span class="c1"># count coupon&#39;s income:</span>
</span><span id="TinkoffBrokerServer-1835"><a href="#-1835"><span class="linenos">1835</span></a>                        <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;operationType&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;OPERATION_TYPE_COUPON&quot;</span><span class="p">,</span> <span class="s2">&quot;OPERATION_TYPE_BOND_REPAYMENT_FULL&quot;</span><span class="p">,</span> <span class="s2">&quot;OPERATION_TYPE_BOND_REPAYMENT&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-1836"><a href="#-1836"><span class="linenos">1836</span></a>                            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;coupons&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-1837"><a href="#-1837"><span class="linenos">1837</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;coupons&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">payment</span>
</span><span id="TinkoffBrokerServer-1838"><a href="#-1838"><span class="linenos">1838</span></a>
</span><span id="TinkoffBrokerServer-1839"><a href="#-1839"><span class="linenos">1839</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1840"><a href="#-1840"><span class="linenos">1840</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;coupons&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">payment</span>
</span><span id="TinkoffBrokerServer-1841"><a href="#-1841"><span class="linenos">1841</span></a>
</span><span id="TinkoffBrokerServer-1842"><a href="#-1842"><span class="linenos">1842</span></a>                        <span class="c1"># count broker commissions:</span>
</span><span id="TinkoffBrokerServer-1843"><a href="#-1843"><span class="linenos">1843</span></a>                        <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;operationType&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;OPERATION_TYPE_BROKER_FEE&quot;</span><span class="p">,</span> <span class="s2">&quot;OPERATION_TYPE_SUCCESS_FEE&quot;</span><span class="p">,</span> <span class="s2">&quot;OPERATION_TYPE_TRACK_MFEE&quot;</span><span class="p">,</span> <span class="s2">&quot;OPERATION_TYPE_TRACK_PFEE&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-1844"><a href="#-1844"><span class="linenos">1844</span></a>                            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;brokerCom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-1845"><a href="#-1845"><span class="linenos">1845</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;brokerCom&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">payment</span>
</span><span id="TinkoffBrokerServer-1846"><a href="#-1846"><span class="linenos">1846</span></a>
</span><span id="TinkoffBrokerServer-1847"><a href="#-1847"><span class="linenos">1847</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1848"><a href="#-1848"><span class="linenos">1848</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;brokerCom&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">payment</span>
</span><span id="TinkoffBrokerServer-1849"><a href="#-1849"><span class="linenos">1849</span></a>
</span><span id="TinkoffBrokerServer-1850"><a href="#-1850"><span class="linenos">1850</span></a>                        <span class="c1"># count service commissions:</span>
</span><span id="TinkoffBrokerServer-1851"><a href="#-1851"><span class="linenos">1851</span></a>                        <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;operationType&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;OPERATION_TYPE_SERVICE_FEE&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-1852"><a href="#-1852"><span class="linenos">1852</span></a>                            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;serviceCom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-1853"><a href="#-1853"><span class="linenos">1853</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;serviceCom&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">payment</span>
</span><span id="TinkoffBrokerServer-1854"><a href="#-1854"><span class="linenos">1854</span></a>
</span><span id="TinkoffBrokerServer-1855"><a href="#-1855"><span class="linenos">1855</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1856"><a href="#-1856"><span class="linenos">1856</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;serviceCom&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">payment</span>
</span><span id="TinkoffBrokerServer-1857"><a href="#-1857"><span class="linenos">1857</span></a>
</span><span id="TinkoffBrokerServer-1858"><a href="#-1858"><span class="linenos">1858</span></a>                        <span class="c1"># count margin commissions:</span>
</span><span id="TinkoffBrokerServer-1859"><a href="#-1859"><span class="linenos">1859</span></a>                        <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;operationType&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;OPERATION_TYPE_MARGIN_FEE&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-1860"><a href="#-1860"><span class="linenos">1860</span></a>                            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;marginCom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-1861"><a href="#-1861"><span class="linenos">1861</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;marginCom&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">payment</span>
</span><span id="TinkoffBrokerServer-1862"><a href="#-1862"><span class="linenos">1862</span></a>
</span><span id="TinkoffBrokerServer-1863"><a href="#-1863"><span class="linenos">1863</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1864"><a href="#-1864"><span class="linenos">1864</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;marginCom&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">payment</span>
</span><span id="TinkoffBrokerServer-1865"><a href="#-1865"><span class="linenos">1865</span></a>
</span><span id="TinkoffBrokerServer-1866"><a href="#-1866"><span class="linenos">1866</span></a>                        <span class="c1"># count withholding taxes:</span>
</span><span id="TinkoffBrokerServer-1867"><a href="#-1867"><span class="linenos">1867</span></a>                        <span class="k">elif</span> <span class="s2">&quot;_TAX&quot;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;operationType&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-1868"><a href="#-1868"><span class="linenos">1868</span></a>                            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;allTaxes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-1869"><a href="#-1869"><span class="linenos">1869</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;allTaxes&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">payment</span>
</span><span id="TinkoffBrokerServer-1870"><a href="#-1870"><span class="linenos">1870</span></a>
</span><span id="TinkoffBrokerServer-1871"><a href="#-1871"><span class="linenos">1871</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1872"><a href="#-1872"><span class="linenos">1872</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;allTaxes&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">payment</span>
</span><span id="TinkoffBrokerServer-1873"><a href="#-1873"><span class="linenos">1873</span></a>
</span><span id="TinkoffBrokerServer-1874"><a href="#-1874"><span class="linenos">1874</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1875"><a href="#-1875"><span class="linenos">1875</span></a>                            <span class="k">continue</span>
</span><span id="TinkoffBrokerServer-1876"><a href="#-1876"><span class="linenos">1876</span></a>
</span><span id="TinkoffBrokerServer-1877"><a href="#-1877"><span class="linenos">1877</span></a>                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;opsCount&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;buyCount&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;sellCount&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer-1878"><a href="#-1878"><span class="linenos">1878</span></a>
</span><span id="TinkoffBrokerServer-1879"><a href="#-1879"><span class="linenos">1879</span></a>                <span class="c1"># --- view &quot;Actions&quot; lines:</span>
</span><span id="TinkoffBrokerServer-1880"><a href="#-1880"><span class="linenos">1880</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span><span id="TinkoffBrokerServer-1881"><a href="#-1881"><span class="linenos">1881</span></a>                    <span class="s2">&quot;| 1                          | 2                             | 3                            | 4                    | 5</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1882"><a href="#-1882"><span class="linenos">1882</span></a>                    <span class="s2">&quot;|----------------------------|-------------------------------|------------------------------|----------------------|------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1883"><a href="#-1883"><span class="linenos">1883</span></a>                    <span class="s2">&quot;| **Actions:**               | Operations executed: </span><span class="si">{:&lt;8}</span><span class="s2"> | Trading volumes:             |                      |</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;opsCount&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer-1884"><a href="#-1884"><span class="linenos">1884</span></a>                    <span class="s2">&quot;|                            |   Buy: </span><span class="si">{:&lt;22}</span><span class="s2"> | </span><span class="si">{:&lt;28}</span><span class="s2"> |                      |</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-1885"><a href="#-1885"><span class="linenos">1885</span></a>                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> (</span><span class="si">{:.1f}</span><span class="s2">%)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;buyCount&quot;</span><span class="p">],</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;buyCount&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;opsCount&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;opsCount&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1886"><a href="#-1886"><span class="linenos">1886</span></a>                        <span class="s2">&quot;  rub, buy: </span><span class="si">{:&lt;16}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;buyTotal&quot;</span><span class="p">][</span><span class="s2">&quot;rub&quot;</span><span class="p">]))</span> <span class="k">if</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;buyTotal&quot;</span><span class="p">][</span><span class="s2">&quot;rub&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1887"><a href="#-1887"><span class="linenos">1887</span></a>                    <span class="p">),</span>
</span><span id="TinkoffBrokerServer-1888"><a href="#-1888"><span class="linenos">1888</span></a>                    <span class="s2">&quot;|                            |   Sell: </span><span class="si">{:&lt;21}</span><span class="s2"> | </span><span class="si">{:&lt;28}</span><span class="s2"> |                      |</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-1889"><a href="#-1889"><span class="linenos">1889</span></a>                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> (</span><span class="si">{:.1f}</span><span class="s2">%)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;sellCount&quot;</span><span class="p">],</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;sellCount&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;opsCount&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;opsCount&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1890"><a href="#-1890"><span class="linenos">1890</span></a>                        <span class="s2">&quot;  rub, sell: </span><span class="si">{:&lt;13}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;+</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;sellTotal&quot;</span><span class="p">][</span><span class="s2">&quot;rub&quot;</span><span class="p">]))</span> <span class="k">if</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;sellTotal&quot;</span><span class="p">][</span><span class="s2">&quot;rub&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1891"><a href="#-1891"><span class="linenos">1891</span></a>                    <span class="p">),</span>
</span><span id="TinkoffBrokerServer-1892"><a href="#-1892"><span class="linenos">1892</span></a>                <span class="p">])</span>
</span><span id="TinkoffBrokerServer-1893"><a href="#-1893"><span class="linenos">1893</span></a>
</span><span id="TinkoffBrokerServer-1894"><a href="#-1894"><span class="linenos">1894</span></a>                <span class="n">opsKeys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;buyTotal&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;sellTotal&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))))</span>
</span><span id="TinkoffBrokerServer-1895"><a href="#-1895"><span class="linenos">1895</span></a>                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">opsKeys</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1896"><a href="#-1896"><span class="linenos">1896</span></a>                    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;rub&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1897"><a href="#-1897"><span class="linenos">1897</span></a>                        <span class="k">continue</span>
</span><span id="TinkoffBrokerServer-1898"><a href="#-1898"><span class="linenos">1898</span></a>
</span><span id="TinkoffBrokerServer-1899"><a href="#-1899"><span class="linenos">1899</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span><span id="TinkoffBrokerServer-1900"><a href="#-1900"><span class="linenos">1900</span></a>                        <span class="s2">&quot;|                            |                               | </span><span class="si">{:&lt;28}</span><span class="s2"> |                      |</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-1901"><a href="#-1901"><span class="linenos">1901</span></a>                            <span class="s2">&quot;  </span><span class="si">{}</span><span class="s2">, buy: </span><span class="si">{:&lt;16}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;buyTotal&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">])</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;buyTotal&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;buyTotal&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-1902"><a href="#-1902"><span class="linenos">1902</span></a>                        <span class="p">),</span>
</span><span id="TinkoffBrokerServer-1903"><a href="#-1903"><span class="linenos">1903</span></a>                        <span class="s2">&quot;|                            |                               | </span><span class="si">{:&lt;28}</span><span class="s2"> |                      |</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-1904"><a href="#-1904"><span class="linenos">1904</span></a>                            <span class="s2">&quot;  </span><span class="si">{}</span><span class="s2">, sell: </span><span class="si">{:&lt;13}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;+</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;sellTotal&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">])</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;sellTotal&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;sellTotal&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-1905"><a href="#-1905"><span class="linenos">1905</span></a>                        <span class="p">),</span>
</span><span id="TinkoffBrokerServer-1906"><a href="#-1906"><span class="linenos">1906</span></a>                    <span class="p">])</span>
</span><span id="TinkoffBrokerServer-1907"><a href="#-1907"><span class="linenos">1907</span></a>
</span><span id="TinkoffBrokerServer-1908"><a href="#-1908"><span class="linenos">1908</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">splitLine1</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-1909"><a href="#-1909"><span class="linenos">1909</span></a>
</span><span id="TinkoffBrokerServer-1910"><a href="#-1910"><span class="linenos">1910</span></a>                <span class="k">def</span> <span class="nf">_InfoStr</span><span class="p">(</span><span class="n">data1</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">data2</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">data3</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">data4</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">cur</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1911"><a href="#-1911"><span class="linenos">1911</span></a>                    <span class="k">return</span> <span class="s2">&quot;|                            | </span><span class="si">{:&lt;29}</span><span class="s2"> | </span><span class="si">{:&lt;28}</span><span class="s2"> | </span><span class="si">{:&lt;20}</span><span class="s2"> | </span><span class="si">{:&lt;22}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-1912"><a href="#-1912"><span class="linenos">1912</span></a>                            <span class="s2">&quot;  </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="n">data1</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">data1</span><span class="p">[</span><span class="n">cur</span><span class="p">])</span> <span class="k">if</span> <span class="n">cur</span> <span class="ow">and</span> <span class="n">cur</span> <span class="ow">in</span> <span class="n">data1</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">data1</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1913"><a href="#-1913"><span class="linenos">1913</span></a>                            <span class="s2">&quot;  </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="n">data2</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">data2</span><span class="p">[</span><span class="n">cur</span><span class="p">])</span> <span class="k">if</span> <span class="n">cur</span> <span class="ow">and</span> <span class="n">cur</span> <span class="ow">in</span> <span class="n">data2</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">data2</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1914"><a href="#-1914"><span class="linenos">1914</span></a>                            <span class="s2">&quot;  </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="n">data3</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">data3</span><span class="p">[</span><span class="n">cur</span><span class="p">])</span> <span class="k">if</span> <span class="n">cur</span> <span class="ow">and</span> <span class="n">cur</span> <span class="ow">in</span> <span class="n">data3</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">data3</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1915"><a href="#-1915"><span class="linenos">1915</span></a>                            <span class="s2">&quot;  </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="n">data4</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">data4</span><span class="p">[</span><span class="n">cur</span><span class="p">])</span> <span class="k">if</span> <span class="n">cur</span> <span class="ow">and</span> <span class="n">cur</span> <span class="ow">in</span> <span class="n">data4</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">data4</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1916"><a href="#-1916"><span class="linenos">1916</span></a>                    <span class="p">)</span>
</span><span id="TinkoffBrokerServer-1917"><a href="#-1917"><span class="linenos">1917</span></a>
</span><span id="TinkoffBrokerServer-1918"><a href="#-1918"><span class="linenos">1918</span></a>                <span class="c1"># --- view &quot;Payments&quot; lines:</span>
</span><span id="TinkoffBrokerServer-1919"><a href="#-1919"><span class="linenos">1919</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| **Payments:**              | Deposit on broker account:    | Withdrawals:                 | Dividends income:    | Coupons income:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-1920"><a href="#-1920"><span class="linenos">1920</span></a>                <span class="n">paymentsKeys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;payIn&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;payOut&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;divs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;coupons&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))))</span>
</span><span id="TinkoffBrokerServer-1921"><a href="#-1921"><span class="linenos">1921</span></a>
</span><span id="TinkoffBrokerServer-1922"><a href="#-1922"><span class="linenos">1922</span></a>                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">paymentsKeys</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1923"><a href="#-1923"><span class="linenos">1923</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_InfoStr</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;payIn&quot;</span><span class="p">],</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;payOut&quot;</span><span class="p">],</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;divs&quot;</span><span class="p">],</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;coupons&quot;</span><span class="p">],</span> <span class="n">key</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-1924"><a href="#-1924"><span class="linenos">1924</span></a>
</span><span id="TinkoffBrokerServer-1925"><a href="#-1925"><span class="linenos">1925</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">splitLine1</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-1926"><a href="#-1926"><span class="linenos">1926</span></a>
</span><span id="TinkoffBrokerServer-1927"><a href="#-1927"><span class="linenos">1927</span></a>                <span class="c1"># --- view &quot;Commissions and taxes&quot; lines:</span>
</span><span id="TinkoffBrokerServer-1928"><a href="#-1928"><span class="linenos">1928</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| **Commissions and taxes:** | Broker commissions:           | Service commissions:         | Margin commissions:  | All taxes/corrections:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-1929"><a href="#-1929"><span class="linenos">1929</span></a>                <span class="n">comKeys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;brokerCom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;serviceCom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;marginCom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;allTaxes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))))</span>
</span><span id="TinkoffBrokerServer-1930"><a href="#-1930"><span class="linenos">1930</span></a>
</span><span id="TinkoffBrokerServer-1931"><a href="#-1931"><span class="linenos">1931</span></a>                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">comKeys</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1932"><a href="#-1932"><span class="linenos">1932</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_InfoStr</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;brokerCom&quot;</span><span class="p">],</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;serviceCom&quot;</span><span class="p">],</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;marginCom&quot;</span><span class="p">],</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;allTaxes&quot;</span><span class="p">],</span> <span class="n">key</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-1933"><a href="#-1933"><span class="linenos">1933</span></a>
</span><span id="TinkoffBrokerServer-1934"><a href="#-1934"><span class="linenos">1934</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">splitLine1</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-1935"><a href="#-1935"><span class="linenos">1935</span></a>
</span><span id="TinkoffBrokerServer-1936"><a href="#-1936"><span class="linenos">1936</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span><span id="TinkoffBrokerServer-1937"><a href="#-1937"><span class="linenos">1937</span></a>                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">## All operations</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1938"><a href="#-1938"><span class="linenos">1938</span></a>                    <span class="s2">&quot;| Date and time       | FIGI         | Ticker       | Asset      | Value     | Payment         | Status     | Operation type</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1939"><a href="#-1939"><span class="linenos">1939</span></a>                    <span class="s2">&quot;|---------------------|--------------|--------------|------------|-----------|-----------------|------------|--------------------------------------------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1940"><a href="#-1940"><span class="linenos">1940</span></a>                <span class="p">])</span>
</span><span id="TinkoffBrokerServer-1941"><a href="#-1941"><span class="linenos">1941</span></a>
</span><span id="TinkoffBrokerServer-1942"><a href="#-1942"><span class="linenos">1942</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1943"><a href="#-1943"><span class="linenos">1943</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Broker returned no operations during this period</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-1944"><a href="#-1944"><span class="linenos">1944</span></a>
</span><span id="TinkoffBrokerServer-1945"><a href="#-1945"><span class="linenos">1945</span></a>            <span class="c1"># --- view &quot;Operations&quot; section:</span>
</span><span id="TinkoffBrokerServer-1946"><a href="#-1946"><span class="linenos">1946</span></a>            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1947"><a href="#-1947"><span class="linenos">1947</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-1948"><a href="#-1948"><span class="linenos">1948</span></a>                <span class="n">payment</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>
</span><span id="TinkoffBrokerServer-1949"><a href="#-1949"><span class="linenos">1949</span></a>                <span class="n">instrument</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SearchByFIGI</span><span class="p">(</span><span class="n">requestPrice</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="k">else</span> <span class="p">{}</span>
</span><span id="TinkoffBrokerServer-1950"><a href="#-1950"><span class="linenos">1950</span></a>
</span><span id="TinkoffBrokerServer-1951"><a href="#-1951"><span class="linenos">1951</span></a>                <span class="c1"># group of deals during one day:</span>
</span><span id="TinkoffBrokerServer-1952"><a href="#-1952"><span class="linenos">1952</span></a>                <span class="k">if</span> <span class="n">nextDay</span> <span class="ow">and</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">nextDay</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1953"><a href="#-1953"><span class="linenos">1953</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">splitLine2</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-1954"><a href="#-1954"><span class="linenos">1954</span></a>                    <span class="n">nextDay</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-1955"><a href="#-1955"><span class="linenos">1955</span></a>
</span><span id="TinkoffBrokerServer-1956"><a href="#-1956"><span class="linenos">1956</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1957"><a href="#-1957"><span class="linenos">1957</span></a>                    <span class="n">nextDay</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># saving current day for splitting</span>
</span><span id="TinkoffBrokerServer-1958"><a href="#-1958"><span class="linenos">1958</span></a>
</span><span id="TinkoffBrokerServer-1959"><a href="#-1959"><span class="linenos">1959</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| </span><span class="si">{:&lt;19}</span><span class="s2"> | </span><span class="si">{:&lt;12}</span><span class="s2"> | </span><span class="si">{:&lt;12}</span><span class="s2"> | </span><span class="si">{:&lt;10}</span><span class="s2"> | </span><span class="si">{:&lt;9}</span><span class="s2"> | </span><span class="si">{:&gt;15}</span><span class="s2"> | </span><span class="si">{:&lt;10}</span><span class="s2"> | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-1960"><a href="#-1960"><span class="linenos">1960</span></a>                    <span class="n">item</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-1961"><a href="#-1961"><span class="linenos">1961</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1962"><a href="#-1962"><span class="linenos">1962</span></a>                    <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">instrument</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1963"><a href="#-1963"><span class="linenos">1963</span></a>                    <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">instrument</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1964"><a href="#-1964"><span class="linenos">1964</span></a>                    <span class="n">item</span><span class="p">[</span><span class="s2">&quot;quantity&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;quantity&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1965"><a href="#-1965"><span class="linenos">1965</span></a>                    <span class="s2">&quot;</span><span class="si">{}{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="n">payment</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">payment</span><span class="p">,</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">payment</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-1966"><a href="#-1966"><span class="linenos">1966</span></a>                    <span class="n">TKS_OPERATION_STATES</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]],</span>
</span><span id="TinkoffBrokerServer-1967"><a href="#-1967"><span class="linenos">1967</span></a>                    <span class="n">TKS_OPERATION_TYPES</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;operationType&quot;</span><span class="p">]],</span>
</span><span id="TinkoffBrokerServer-1968"><a href="#-1968"><span class="linenos">1968</span></a>                <span class="p">))</span>
</span><span id="TinkoffBrokerServer-1969"><a href="#-1969"><span class="linenos">1969</span></a>
</span><span id="TinkoffBrokerServer-1970"><a href="#-1970"><span class="linenos">1970</span></a>            <span class="n">infoText</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-1971"><a href="#-1971"><span class="linenos">1971</span></a>
</span><span id="TinkoffBrokerServer-1972"><a href="#-1972"><span class="linenos">1972</span></a>            <span class="k">if</span> <span class="n">printDeals</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1973"><a href="#-1973"><span class="linenos">1973</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">infoText</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-1974"><a href="#-1974"><span class="linenos">1974</span></a>
</span><span id="TinkoffBrokerServer-1975"><a href="#-1975"><span class="linenos">1975</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reportFile</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1976"><a href="#-1976"><span class="linenos">1976</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reportFile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fH</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-1977"><a href="#-1977"><span class="linenos">1977</span></a>                    <span class="n">fH</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">infoText</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-1978"><a href="#-1978"><span class="linenos">1978</span></a>
</span><span id="TinkoffBrokerServer-1979"><a href="#-1979"><span class="linenos">1979</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;History of a client&#39;s operations are saved to file: [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reportFile</span><span class="p">)))</span>
</span><span id="TinkoffBrokerServer-1980"><a href="#-1980"><span class="linenos">1980</span></a>
</span><span id="TinkoffBrokerServer-1981"><a href="#-1981"><span class="linenos">1981</span></a>        <span class="k">return</span> <span class="n">ops</span><span class="p">,</span> <span class="n">customStat</span>
</span><span id="TinkoffBrokerServer-1982"><a href="#-1982"><span class="linenos">1982</span></a>
</span><span id="TinkoffBrokerServer-1983"><a href="#-1983"><span class="linenos">1983</span></a>    <span class="k">def</span> <span class="nf">History</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">onlyMissing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="TinkoffBrokerServer-1984"><a href="#-1984"><span class="linenos">1984</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-1985"><a href="#-1985"><span class="linenos">1985</span></a><span class="sd">        This method returns last history candles of the current instrument defined by `ticker`.</span>
</span><span id="TinkoffBrokerServer-1986"><a href="#-1986"><span class="linenos">1986</span></a><span class="sd">        If `historyFile` is not None then method save history to this file, otherwise return only pandas dataframe.</span>
</span><span id="TinkoffBrokerServer-1987"><a href="#-1987"><span class="linenos">1987</span></a><span class="sd">        `historyLength` define how many candles returns from past to current date.</span>
</span><span id="TinkoffBrokerServer-1988"><a href="#-1988"><span class="linenos">1988</span></a><span class="sd">        `historyInterval` define candle interval. Available values are strings: `&quot;1min&quot;`, `&quot;2min&quot;`, `&quot;3min&quot;`, `&quot;5min&quot;`,</span>
</span><span id="TinkoffBrokerServer-1989"><a href="#-1989"><span class="linenos">1989</span></a><span class="sd">        `&quot;10min&quot;`, `&quot;15min&quot;`, `&quot;30min&quot;`, `&quot;hour&quot;`, `&quot;day&quot;`, `&quot;week&quot;`, `&quot;month&quot;`. Default: `&quot;hour&quot;`.</span>
</span><span id="TinkoffBrokerServer-1990"><a href="#-1990"><span class="linenos">1990</span></a><span class="sd">        Maximum requested history date in the past: `1970.01.02 03:45`</span>
</span><span id="TinkoffBrokerServer-1991"><a href="#-1991"><span class="linenos">1991</span></a>
</span><span id="TinkoffBrokerServer-1992"><a href="#-1992"><span class="linenos">1992</span></a><span class="sd">        :param onlyMissing: if history file define then add only last missing candles, do not request all history length. False by default.</span>
</span><span id="TinkoffBrokerServer-1993"><a href="#-1993"><span class="linenos">1993</span></a><span class="sd">                            WARNING! History appends only from last candle to current time with replace last candle! Intervals must be similar!</span>
</span><span id="TinkoffBrokerServer-1994"><a href="#-1994"><span class="linenos">1994</span></a><span class="sd">        :return: pandas dataframe with stock history. Columns: `date`, `time`, `open`, `high`, `low`, `close`, `volume`.</span>
</span><span id="TinkoffBrokerServer-1995"><a href="#-1995"><span class="linenos">1995</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-1996"><a href="#-1996"><span class="linenos">1996</span></a>        <span class="n">history</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># empty pandas object for history</span>
</span><span id="TinkoffBrokerServer-1997"><a href="#-1997"><span class="linenos">1997</span></a>        <span class="c1"># TODO: update history to work with api v2</span>
</span><span id="TinkoffBrokerServer-1998"><a href="#-1998"><span class="linenos">1998</span></a>        <span class="c1"># if self.historyLength &lt; 1:</span>
</span><span id="TinkoffBrokerServer-1999"><a href="#-1999"><span class="linenos">1999</span></a>        <span class="c1">#     raise Exception(&quot;History length parameter must be &gt;=1!&quot;)</span>
</span><span id="TinkoffBrokerServer-2000"><a href="#-2000"><span class="linenos">2000</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer-2001"><a href="#-2001"><span class="linenos">2001</span></a>        <span class="c1"># if self.historyInterval not in TKS_TIMEFRAMES.keys():</span>
</span><span id="TinkoffBrokerServer-2002"><a href="#-2002"><span class="linenos">2002</span></a>        <span class="c1">#     raise Exception(&quot;Interval parameter must be string with available values: 1min, 2min, 3min, 5min, 10min, 15min, 30min, hour, day, week, month.&quot;)</span>
</span><span id="TinkoffBrokerServer-2003"><a href="#-2003"><span class="linenos">2003</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer-2004"><a href="#-2004"><span class="linenos">2004</span></a>        <span class="c1"># if not (self.ticker or self.figi):</span>
</span><span id="TinkoffBrokerServer-2005"><a href="#-2005"><span class="linenos">2005</span></a>        <span class="c1">#     raise Exception(&quot;self.ticker or self.figi variables must be defined!&quot;)</span>
</span><span id="TinkoffBrokerServer-2006"><a href="#-2006"><span class="linenos">2006</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer-2007"><a href="#-2007"><span class="linenos">2007</span></a>        <span class="c1"># if self.ticker and not self.figi:</span>
</span><span id="TinkoffBrokerServer-2008"><a href="#-2008"><span class="linenos">2008</span></a>        <span class="c1">#     instrumentByTicker = self.SearchByTicker(requestPrice=False, debug=False)</span>
</span><span id="TinkoffBrokerServer-2009"><a href="#-2009"><span class="linenos">2009</span></a>        <span class="c1">#     self.figi = instrumentByTicker[&quot;figi&quot;] if instrumentByTicker else &quot;&quot;</span>
</span><span id="TinkoffBrokerServer-2010"><a href="#-2010"><span class="linenos">2010</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer-2011"><a href="#-2011"><span class="linenos">2011</span></a>        <span class="c1"># endDate = datetime.now(tzutc())  # current time for request history</span>
</span><span id="TinkoffBrokerServer-2012"><a href="#-2012"><span class="linenos">2012</span></a>        <span class="c1"># tempOld = None  # pandas object for old history, if --only-missing key present</span>
</span><span id="TinkoffBrokerServer-2013"><a href="#-2013"><span class="linenos">2013</span></a>        <span class="c1"># lastTime = None  # datetime object of last old candle in file</span>
</span><span id="TinkoffBrokerServer-2014"><a href="#-2014"><span class="linenos">2014</span></a>        <span class="c1"># minStartDate = datetime.strptime(&quot;1970.01.02 03:45&quot;, &quot;%Y.%m.%d %H:%M&quot;).astimezone(tzutc())  # Maximum requested history date in the past</span>
</span><span id="TinkoffBrokerServer-2015"><a href="#-2015"><span class="linenos">2015</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer-2016"><a href="#-2016"><span class="linenos">2016</span></a>        <span class="c1"># # get old history saved earlier in file:</span>
</span><span id="TinkoffBrokerServer-2017"><a href="#-2017"><span class="linenos">2017</span></a>        <span class="c1"># if onlyMissing and self.historyFile and os.path.exists(self.historyFile):</span>
</span><span id="TinkoffBrokerServer-2018"><a href="#-2018"><span class="linenos">2018</span></a>        <span class="c1">#     uLogger.debug(&quot;--only-missing key present, so auto decreasing --length value...&quot;)</span>
</span><span id="TinkoffBrokerServer-2019"><a href="#-2019"><span class="linenos">2019</span></a>        <span class="c1">#     uLogger.debug(&quot;Only append missing last history candles at the end of the file [{}]&quot;.format(os.path.abspath(self.historyFile)))</span>
</span><span id="TinkoffBrokerServer-2020"><a href="#-2020"><span class="linenos">2020</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer-2021"><a href="#-2021"><span class="linenos">2021</span></a>        <span class="c1">#     tempOld = pd.read_csv(self.historyFile, sep=&quot;,&quot;, header=None, names=[&quot;date&quot;, &quot;time&quot;, &quot;open&quot;, &quot;high&quot;, &quot;low&quot;, &quot;close&quot;, &quot;volume&quot;])</span>
</span><span id="TinkoffBrokerServer-2022"><a href="#-2022"><span class="linenos">2022</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer-2023"><a href="#-2023"><span class="linenos">2023</span></a>        <span class="c1">#     tempOld[&quot;date&quot;] = pd.to_datetime(tempOld[&quot;date&quot;])  # load date &quot;as is&quot;</span>
</span><span id="TinkoffBrokerServer-2024"><a href="#-2024"><span class="linenos">2024</span></a>        <span class="c1">#     tempOld[&quot;date&quot;] = tempOld[&quot;date&quot;].dt.strftime(&quot;%Y.%m.%d&quot;)  # convert date to string</span>
</span><span id="TinkoffBrokerServer-2025"><a href="#-2025"><span class="linenos">2025</span></a>        <span class="c1">#     tempOld[&quot;time&quot;] = pd.to_datetime(tempOld[&quot;time&quot;])  # load time &quot;as is&quot;</span>
</span><span id="TinkoffBrokerServer-2026"><a href="#-2026"><span class="linenos">2026</span></a>        <span class="c1">#     tempOld[&quot;time&quot;] = tempOld[&quot;time&quot;].dt.strftime(&quot;%H:%M&quot;)  # convert time to string</span>
</span><span id="TinkoffBrokerServer-2027"><a href="#-2027"><span class="linenos">2027</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer-2028"><a href="#-2028"><span class="linenos">2028</span></a>        <span class="c1">#     # get last datetime object from last string in file or minus 1 delta if file is empty:</span>
</span><span id="TinkoffBrokerServer-2029"><a href="#-2029"><span class="linenos">2029</span></a>        <span class="c1">#     if len(tempOld) &gt; 0:</span>
</span><span id="TinkoffBrokerServer-2030"><a href="#-2030"><span class="linenos">2030</span></a>        <span class="c1">#         lastTime = datetime.strptime(tempOld.date.iloc[-1] + &quot; &quot; + tempOld.time.iloc[-1], &quot;%Y.%m.%d %H:%M&quot;).astimezone(tzutc())</span>
</span><span id="TinkoffBrokerServer-2031"><a href="#-2031"><span class="linenos">2031</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer-2032"><a href="#-2032"><span class="linenos">2032</span></a>        <span class="c1">#     else:</span>
</span><span id="TinkoffBrokerServer-2033"><a href="#-2033"><span class="linenos">2033</span></a>        <span class="c1">#         lastTime = endDate - timedelta(minutes=TKS_TIMEFRAMES[self.historyInterval][&quot;minutes&quot;])</span>
</span><span id="TinkoffBrokerServer-2034"><a href="#-2034"><span class="linenos">2034</span></a>        <span class="c1">#         uLogger.warning(&quot;No history in file, set last date to request at [{}]&quot;.format(lastTime))</span>
</span><span id="TinkoffBrokerServer-2035"><a href="#-2035"><span class="linenos">2035</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer-2036"><a href="#-2036"><span class="linenos">2036</span></a>        <span class="c1">#     delta = endDate - lastTime  # current time minus last time in file</span>
</span><span id="TinkoffBrokerServer-2037"><a href="#-2037"><span class="linenos">2037</span></a>        <span class="c1">#     deltaMinutes = delta.days * 1440 + delta.seconds // 60  # minutes between last datetime and current datetime</span>
</span><span id="TinkoffBrokerServer-2038"><a href="#-2038"><span class="linenos">2038</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer-2039"><a href="#-2039"><span class="linenos">2039</span></a>        <span class="c1">#     # calculate new (decreased) history length to download:</span>
</span><span id="TinkoffBrokerServer-2040"><a href="#-2040"><span class="linenos">2040</span></a>        <span class="c1">#     self.historyLength = deltaMinutes // TKS_TIMEFRAMES[self.historyInterval][&quot;minutes&quot;]</span>
</span><span id="TinkoffBrokerServer-2041"><a href="#-2041"><span class="linenos">2041</span></a>        <span class="c1">#     if deltaMinutes % TKS_TIMEFRAMES[self.historyInterval][&quot;minutes&quot;] &gt; 0:</span>
</span><span id="TinkoffBrokerServer-2042"><a href="#-2042"><span class="linenos">2042</span></a>        <span class="c1">#         self.historyLength += 1  # to avoid fraction time</span>
</span><span id="TinkoffBrokerServer-2043"><a href="#-2043"><span class="linenos">2043</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer-2044"><a href="#-2044"><span class="linenos">2044</span></a>        <span class="c1">#     tempOld = tempOld[:-1]  # always remove last old candle because it may be incompletely at the current time</span>
</span><span id="TinkoffBrokerServer-2045"><a href="#-2045"><span class="linenos">2045</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer-2046"><a href="#-2046"><span class="linenos">2046</span></a>        <span class="c1"># if self.figi:</span>
</span><span id="TinkoffBrokerServer-2047"><a href="#-2047"><span class="linenos">2047</span></a>        <span class="c1">#     blocks = 1 if self.historyLength &lt;= TKS_TIMEFRAMES[self.historyInterval][&quot;maxCandles&quot;] else 1 + self.historyLength // TKS_TIMEFRAMES[self.historyInterval][&quot;maxCandles&quot;]</span>
</span><span id="TinkoffBrokerServer-2048"><a href="#-2048"><span class="linenos">2048</span></a>        <span class="c1">#     responseJSONs = []  # raw history blocks</span>
</span><span id="TinkoffBrokerServer-2049"><a href="#-2049"><span class="linenos">2049</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer-2050"><a href="#-2050"><span class="linenos">2050</span></a>        <span class="c1">#     uLogger.debug(&quot;Request last history from Tinkoff Broker server for ticker [{}], FIGI [{}]...&quot;.format(self.ticker, self.figi))</span>
</span><span id="TinkoffBrokerServer-2051"><a href="#-2051"><span class="linenos">2051</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer-2052"><a href="#-2052"><span class="linenos">2052</span></a>        <span class="c1">#     uLogger.debug(&quot;Requested history length: [{}], interval: [{}]&quot;.format(self.historyLength, self.historyInterval))</span>
</span><span id="TinkoffBrokerServer-2053"><a href="#-2053"><span class="linenos">2053</span></a>        <span class="c1">#     uLogger.debug(&quot;User requested time period is about from [{}] to [{}]&quot;.format(</span>
</span><span id="TinkoffBrokerServer-2054"><a href="#-2054"><span class="linenos">2054</span></a>        <span class="c1">#         (endDate - timedelta(minutes=TKS_TIMEFRAMES[self.historyInterval][&quot;minutes&quot;] * self.historyLength)).strftime(&quot;%Y-%m-%d %H:%M:%S&quot;),</span>
</span><span id="TinkoffBrokerServer-2055"><a href="#-2055"><span class="linenos">2055</span></a>        <span class="c1">#         endDate.strftime(&quot;%Y-%m-%d %H:%M:%S&quot;),</span>
</span><span id="TinkoffBrokerServer-2056"><a href="#-2056"><span class="linenos">2056</span></a>        <span class="c1">#     ))</span>
</span><span id="TinkoffBrokerServer-2057"><a href="#-2057"><span class="linenos">2057</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer-2058"><a href="#-2058"><span class="linenos">2058</span></a>        <span class="c1">#     uLogger.debug(&quot;Blocks count: [{}], max candles in block for this interval: [{}]&quot;.format(blocks, TKS_TIMEFRAMES[self.historyInterval][&quot;maxCandles&quot;]))</span>
</span><span id="TinkoffBrokerServer-2059"><a href="#-2059"><span class="linenos">2059</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer-2060"><a href="#-2060"><span class="linenos">2060</span></a>        <span class="c1">#     oldFlag = False</span>
</span><span id="TinkoffBrokerServer-2061"><a href="#-2061"><span class="linenos">2061</span></a>        <span class="c1">#     for item in range(blocks):</span>
</span><span id="TinkoffBrokerServer-2062"><a href="#-2062"><span class="linenos">2062</span></a>        <span class="c1">#         tail = self.historyLength % TKS_TIMEFRAMES[self.historyInterval][&quot;maxCandles&quot;] if item + 1 == blocks else TKS_TIMEFRAMES[self.historyInterval][&quot;maxCandles&quot;]</span>
</span><span id="TinkoffBrokerServer-2063"><a href="#-2063"><span class="linenos">2063</span></a>        <span class="c1">#         startDate = endDate - timedelta(minutes=TKS_TIMEFRAMES[self.historyInterval][&quot;minutes&quot;] * tail)</span>
</span><span id="TinkoffBrokerServer-2064"><a href="#-2064"><span class="linenos">2064</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer-2065"><a href="#-2065"><span class="linenos">2065</span></a>        <span class="c1">#         if startDate &lt; minStartDate:</span>
</span><span id="TinkoffBrokerServer-2066"><a href="#-2066"><span class="linenos">2066</span></a>        <span class="c1">#             startDate = minStartDate  # set minimum date in the past if delta is too long</span>
</span><span id="TinkoffBrokerServer-2067"><a href="#-2067"><span class="linenos">2067</span></a>        <span class="c1">#             uLogger.debug(&quot;Date in the past is too old for request. Set start time to [{}]&quot;.format(minStartDate.strftime(&quot;%Y-%m-%d %H:%M:%S&quot;)))</span>
</span><span id="TinkoffBrokerServer-2068"><a href="#-2068"><span class="linenos">2068</span></a>        <span class="c1">#             oldFlag = True</span>
</span><span id="TinkoffBrokerServer-2069"><a href="#-2069"><span class="linenos">2069</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer-2070"><a href="#-2070"><span class="linenos">2070</span></a>        <span class="c1">#         uLogger.debug(&quot;Block time period: from [{}] to [{}] ({}/{})&quot;.format(</span>
</span><span id="TinkoffBrokerServer-2071"><a href="#-2071"><span class="linenos">2071</span></a>        <span class="c1">#             startDate.strftime(&quot;%Y-%m-%d %H:%M:%S&quot;),</span>
</span><span id="TinkoffBrokerServer-2072"><a href="#-2072"><span class="linenos">2072</span></a>        <span class="c1">#             endDate.strftime(&quot;%Y-%m-%d %H:%M:%S&quot;),</span>
</span><span id="TinkoffBrokerServer-2073"><a href="#-2073"><span class="linenos">2073</span></a>        <span class="c1">#             item + 1,</span>
</span><span id="TinkoffBrokerServer-2074"><a href="#-2074"><span class="linenos">2074</span></a>        <span class="c1">#             blocks,</span>
</span><span id="TinkoffBrokerServer-2075"><a href="#-2075"><span class="linenos">2075</span></a>        <span class="c1">#         ))</span>
</span><span id="TinkoffBrokerServer-2076"><a href="#-2076"><span class="linenos">2076</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer-2077"><a href="#-2077"><span class="linenos">2077</span></a>        <span class="c1">#         historyURL = self.server + r&quot;/market/candles?figi={}&amp;from={}&amp;to={}&amp;interval={}&quot;.format(</span>
</span><span id="TinkoffBrokerServer-2078"><a href="#-2078"><span class="linenos">2078</span></a>        <span class="c1">#             self.figi,</span>
</span><span id="TinkoffBrokerServer-2079"><a href="#-2079"><span class="linenos">2079</span></a>        <span class="c1">#             quote(startDate.isoformat()),</span>
</span><span id="TinkoffBrokerServer-2080"><a href="#-2080"><span class="linenos">2080</span></a>        <span class="c1">#             quote(endDate.isoformat()),</span>
</span><span id="TinkoffBrokerServer-2081"><a href="#-2081"><span class="linenos">2081</span></a>        <span class="c1">#             self.historyInterval,</span>
</span><span id="TinkoffBrokerServer-2082"><a href="#-2082"><span class="linenos">2082</span></a>        <span class="c1">#         )</span>
</span><span id="TinkoffBrokerServer-2083"><a href="#-2083"><span class="linenos">2083</span></a>        <span class="c1">#         responseJSON = self.SendAPIRequest(historyURL, debug=False)[&quot;payload&quot;][&quot;candles&quot;]</span>
</span><span id="TinkoffBrokerServer-2084"><a href="#-2084"><span class="linenos">2084</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer-2085"><a href="#-2085"><span class="linenos">2085</span></a>        <span class="c1">#         responseJSONs = responseJSON + responseJSONs  # add more old history behind newest dates</span>
</span><span id="TinkoffBrokerServer-2086"><a href="#-2086"><span class="linenos">2086</span></a>        <span class="c1">#         endDate = startDate</span>
</span><span id="TinkoffBrokerServer-2087"><a href="#-2087"><span class="linenos">2087</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer-2088"><a href="#-2088"><span class="linenos">2088</span></a>        <span class="c1">#         if oldFlag: break</span>
</span><span id="TinkoffBrokerServer-2089"><a href="#-2089"><span class="linenos">2089</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer-2090"><a href="#-2090"><span class="linenos">2090</span></a>        <span class="c1">#     if responseJSONs:</span>
</span><span id="TinkoffBrokerServer-2091"><a href="#-2091"><span class="linenos">2091</span></a>        <span class="c1">#         tempHistory = pd.DataFrame(</span>
</span><span id="TinkoffBrokerServer-2092"><a href="#-2092"><span class="linenos">2092</span></a>        <span class="c1">#             data={</span>
</span><span id="TinkoffBrokerServer-2093"><a href="#-2093"><span class="linenos">2093</span></a>        <span class="c1">#                 &quot;date&quot;: [pd.to_datetime(item[&quot;time&quot;]).astimezone(tzutc()) for item in responseJSONs],</span>
</span><span id="TinkoffBrokerServer-2094"><a href="#-2094"><span class="linenos">2094</span></a>        <span class="c1">#                 &quot;time&quot;: [pd.to_datetime(item[&quot;time&quot;]).astimezone(tzutc()) for item in responseJSONs],</span>
</span><span id="TinkoffBrokerServer-2095"><a href="#-2095"><span class="linenos">2095</span></a>        <span class="c1">#                 &quot;open&quot;: [item[&quot;o&quot;] for item in responseJSONs],</span>
</span><span id="TinkoffBrokerServer-2096"><a href="#-2096"><span class="linenos">2096</span></a>        <span class="c1">#                 &quot;high&quot;: [item[&quot;h&quot;] for item in responseJSONs],</span>
</span><span id="TinkoffBrokerServer-2097"><a href="#-2097"><span class="linenos">2097</span></a>        <span class="c1">#                 &quot;low&quot;: [item[&quot;l&quot;] for item in responseJSONs],</span>
</span><span id="TinkoffBrokerServer-2098"><a href="#-2098"><span class="linenos">2098</span></a>        <span class="c1">#                 &quot;close&quot;: [item[&quot;c&quot;] for item in responseJSONs],</span>
</span><span id="TinkoffBrokerServer-2099"><a href="#-2099"><span class="linenos">2099</span></a>        <span class="c1">#                 &quot;volume&quot;: [item[&quot;v&quot;] for item in responseJSONs],</span>
</span><span id="TinkoffBrokerServer-2100"><a href="#-2100"><span class="linenos">2100</span></a>        <span class="c1">#             },</span>
</span><span id="TinkoffBrokerServer-2101"><a href="#-2101"><span class="linenos">2101</span></a>        <span class="c1">#             index=range(len(responseJSONs)),</span>
</span><span id="TinkoffBrokerServer-2102"><a href="#-2102"><span class="linenos">2102</span></a>        <span class="c1">#             columns=[&quot;date&quot;, &quot;time&quot;, &quot;open&quot;, &quot;high&quot;, &quot;low&quot;, &quot;close&quot;, &quot;volume&quot;],</span>
</span><span id="TinkoffBrokerServer-2103"><a href="#-2103"><span class="linenos">2103</span></a>        <span class="c1">#         )</span>
</span><span id="TinkoffBrokerServer-2104"><a href="#-2104"><span class="linenos">2104</span></a>        <span class="c1">#         tempHistory[&quot;date&quot;] = tempHistory[&quot;date&quot;].dt.strftime(&quot;%Y.%m.%d&quot;)</span>
</span><span id="TinkoffBrokerServer-2105"><a href="#-2105"><span class="linenos">2105</span></a>        <span class="c1">#         tempHistory[&quot;time&quot;] = tempHistory[&quot;time&quot;].dt.strftime(&quot;%H:%M&quot;)</span>
</span><span id="TinkoffBrokerServer-2106"><a href="#-2106"><span class="linenos">2106</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer-2107"><a href="#-2107"><span class="linenos">2107</span></a>        <span class="c1">#         # append only newest candles to old history if --only-missing key present:</span>
</span><span id="TinkoffBrokerServer-2108"><a href="#-2108"><span class="linenos">2108</span></a>        <span class="c1">#         if onlyMissing and tempOld is not None and lastTime is not None:</span>
</span><span id="TinkoffBrokerServer-2109"><a href="#-2109"><span class="linenos">2109</span></a>        <span class="c1">#             indx = 0  # find start index in given from server tempHistory data:</span>
</span><span id="TinkoffBrokerServer-2110"><a href="#-2110"><span class="linenos">2110</span></a>        <span class="c1">#             for i, item in tempHistory.iterrows():</span>
</span><span id="TinkoffBrokerServer-2111"><a href="#-2111"><span class="linenos">2111</span></a>        <span class="c1">#                 curTime = datetime.strptime(item[&quot;date&quot;] + &quot; &quot; + item[&quot;time&quot;], &quot;%Y.%m.%d %H:%M&quot;).astimezone(tzutc())</span>
</span><span id="TinkoffBrokerServer-2112"><a href="#-2112"><span class="linenos">2112</span></a>        <span class="c1">#                 if curTime == lastTime:</span>
</span><span id="TinkoffBrokerServer-2113"><a href="#-2113"><span class="linenos">2113</span></a>        <span class="c1">#                     uLogger.debug(&quot;History candles will be updated starting from the candle with date: [{}]&quot;.format(curTime.strftime(&quot;%Y-%m-%d %H:%M:%S&quot;)))</span>
</span><span id="TinkoffBrokerServer-2114"><a href="#-2114"><span class="linenos">2114</span></a>        <span class="c1">#                     indx = i</span>
</span><span id="TinkoffBrokerServer-2115"><a href="#-2115"><span class="linenos">2115</span></a>        <span class="c1">#                     break</span>
</span><span id="TinkoffBrokerServer-2116"><a href="#-2116"><span class="linenos">2116</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer-2117"><a href="#-2117"><span class="linenos">2117</span></a>        <span class="c1">#             history = tempOld.append(tempHistory[indx:], ignore_index=True)</span>
</span><span id="TinkoffBrokerServer-2118"><a href="#-2118"><span class="linenos">2118</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer-2119"><a href="#-2119"><span class="linenos">2119</span></a>        <span class="c1">#         else:</span>
</span><span id="TinkoffBrokerServer-2120"><a href="#-2120"><span class="linenos">2120</span></a>        <span class="c1">#             history = tempHistory  # if no --only-missing key then load full data from server</span>
</span><span id="TinkoffBrokerServer-2121"><a href="#-2121"><span class="linenos">2121</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer-2122"><a href="#-2122"><span class="linenos">2122</span></a>        <span class="c1">#         uLogger.debug(&quot;Showing last 3 rows of candles history:&quot;)</span>
</span><span id="TinkoffBrokerServer-2123"><a href="#-2123"><span class="linenos">2123</span></a>        <span class="c1">#         for line in pd.DataFrame.to_string(</span>
</span><span id="TinkoffBrokerServer-2124"><a href="#-2124"><span class="linenos">2124</span></a>        <span class="c1">#                 history[[&quot;date&quot;, &quot;time&quot;, &quot;open&quot;, &quot;high&quot;, &quot;low&quot;, &quot;close&quot;, &quot;volume&quot;]][-3:],</span>
</span><span id="TinkoffBrokerServer-2125"><a href="#-2125"><span class="linenos">2125</span></a>        <span class="c1">#                 max_cols=20,</span>
</span><span id="TinkoffBrokerServer-2126"><a href="#-2126"><span class="linenos">2126</span></a>        <span class="c1">#         ).split(&quot;\n&quot;):</span>
</span><span id="TinkoffBrokerServer-2127"><a href="#-2127"><span class="linenos">2127</span></a>        <span class="c1">#             uLogger.debug(line)</span>
</span><span id="TinkoffBrokerServer-2128"><a href="#-2128"><span class="linenos">2128</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer-2129"><a href="#-2129"><span class="linenos">2129</span></a>        <span class="c1">#     if self.historyFile is not None:</span>
</span><span id="TinkoffBrokerServer-2130"><a href="#-2130"><span class="linenos">2130</span></a>        <span class="c1">#         if history is not None:</span>
</span><span id="TinkoffBrokerServer-2131"><a href="#-2131"><span class="linenos">2131</span></a>        <span class="c1">#             history.to_csv(self.historyFile, sep=&quot;,&quot;, index=False, header=False)</span>
</span><span id="TinkoffBrokerServer-2132"><a href="#-2132"><span class="linenos">2132</span></a>        <span class="c1">#             uLogger.info(&quot;Ticker [{}], FIGI [{}], tf: [{}], history saved: [{}]&quot;.format(</span>
</span><span id="TinkoffBrokerServer-2133"><a href="#-2133"><span class="linenos">2133</span></a>        <span class="c1">#                 self.ticker,</span>
</span><span id="TinkoffBrokerServer-2134"><a href="#-2134"><span class="linenos">2134</span></a>        <span class="c1">#                 self.figi,</span>
</span><span id="TinkoffBrokerServer-2135"><a href="#-2135"><span class="linenos">2135</span></a>        <span class="c1">#                 self.historyInterval,</span>
</span><span id="TinkoffBrokerServer-2136"><a href="#-2136"><span class="linenos">2136</span></a>        <span class="c1">#                 os.path.abspath(self.historyFile),</span>
</span><span id="TinkoffBrokerServer-2137"><a href="#-2137"><span class="linenos">2137</span></a>        <span class="c1">#             ))</span>
</span><span id="TinkoffBrokerServer-2138"><a href="#-2138"><span class="linenos">2138</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer-2139"><a href="#-2139"><span class="linenos">2139</span></a>        <span class="c1">#         else:</span>
</span><span id="TinkoffBrokerServer-2140"><a href="#-2140"><span class="linenos">2140</span></a>        <span class="c1">#             uLogger.warning(&quot;Empty history received! File NOT updated: [{}]&quot;.format(os.path.abspath(self.historyFile)))</span>
</span><span id="TinkoffBrokerServer-2141"><a href="#-2141"><span class="linenos">2141</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer-2142"><a href="#-2142"><span class="linenos">2142</span></a>        <span class="c1">#     else:</span>
</span><span id="TinkoffBrokerServer-2143"><a href="#-2143"><span class="linenos">2143</span></a>        <span class="c1">#         uLogger.debug(&quot;--output key is not defined. Parsed history file not saved to .csv-file, only pandas dataframe returns.&quot;)</span>
</span><span id="TinkoffBrokerServer-2144"><a href="#-2144"><span class="linenos">2144</span></a>
</span><span id="TinkoffBrokerServer-2145"><a href="#-2145"><span class="linenos">2145</span></a>        <span class="k">return</span> <span class="n">history</span>
</span><span id="TinkoffBrokerServer-2146"><a href="#-2146"><span class="linenos">2146</span></a>
</span><span id="TinkoffBrokerServer-2147"><a href="#-2147"><span class="linenos">2147</span></a>    <span class="k">def</span> <span class="nf">Trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">lots</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">sl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">expDate</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Undefined&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2148"><a href="#-2148"><span class="linenos">2148</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-2149"><a href="#-2149"><span class="linenos">2149</span></a><span class="sd">        Universal method to create market order and make deal at the current price. Returns JSON data with response.</span>
</span><span id="TinkoffBrokerServer-2150"><a href="#-2150"><span class="linenos">2150</span></a><span class="sd">        If `tp` or `sl` &gt; 0, then in additional will opens stop-orders with &quot;TP&quot; and &quot;SL&quot; flags for `stopType` parameter.</span>
</span><span id="TinkoffBrokerServer-2151"><a href="#-2151"><span class="linenos">2151</span></a>
</span><span id="TinkoffBrokerServer-2152"><a href="#-2152"><span class="linenos">2152</span></a><span class="sd">        See also: `Order()` docstring. More simple methods than `Trade()` are `Buy()` and `Sell()`.</span>
</span><span id="TinkoffBrokerServer-2153"><a href="#-2153"><span class="linenos">2153</span></a>
</span><span id="TinkoffBrokerServer-2154"><a href="#-2154"><span class="linenos">2154</span></a><span class="sd">        :param operation: string &quot;Buy&quot; or &quot;Sell&quot;.</span>
</span><span id="TinkoffBrokerServer-2155"><a href="#-2155"><span class="linenos">2155</span></a><span class="sd">        :param lots: volume, integer count of lots &gt;= 1.</span>
</span><span id="TinkoffBrokerServer-2156"><a href="#-2156"><span class="linenos">2156</span></a><span class="sd">        :param tp: float &gt; 0, target price for stop-order with &quot;TP&quot; type. It used as take profit parameter `targetPrice` in `self.Order()`.</span>
</span><span id="TinkoffBrokerServer-2157"><a href="#-2157"><span class="linenos">2157</span></a><span class="sd">        :param sl: float &gt; 0, target price for stop-order with &quot;SL&quot; type. It used as stop loss parameter `targetPrice` in `self.Order()`.</span>
</span><span id="TinkoffBrokerServer-2158"><a href="#-2158"><span class="linenos">2158</span></a><span class="sd">        :param expDate: string &quot;Undefined&quot; by default or local date in future,</span>
</span><span id="TinkoffBrokerServer-2159"><a href="#-2159"><span class="linenos">2159</span></a><span class="sd">                        it is a string with format `%Y-%m-%d %H:%M:%S`.</span>
</span><span id="TinkoffBrokerServer-2160"><a href="#-2160"><span class="linenos">2160</span></a><span class="sd">        :return: JSON with response from broker server.</span>
</span><span id="TinkoffBrokerServer-2161"><a href="#-2161"><span class="linenos">2161</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-2162"><a href="#-2162"><span class="linenos">2162</span></a>        <span class="k">if</span> <span class="n">operation</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">operation</span> <span class="ow">or</span> <span class="n">operation</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Buy&quot;</span><span class="p">,</span> <span class="s2">&quot;Sell&quot;</span><span class="p">):</span>
</span><span id="TinkoffBrokerServer-2163"><a href="#-2163"><span class="linenos">2163</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;You must define operation type only one of them: `Buy` or `Sell`!&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-2164"><a href="#-2164"><span class="linenos">2164</span></a>
</span><span id="TinkoffBrokerServer-2165"><a href="#-2165"><span class="linenos">2165</span></a>        <span class="k">if</span> <span class="n">lots</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">lots</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2166"><a href="#-2166"><span class="linenos">2166</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;You must define trade volume &gt; 0: integer count of lots! For current operation lots reset to 1.&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-2167"><a href="#-2167"><span class="linenos">2167</span></a>            <span class="n">lots</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="TinkoffBrokerServer-2168"><a href="#-2168"><span class="linenos">2168</span></a>
</span><span id="TinkoffBrokerServer-2169"><a href="#-2169"><span class="linenos">2169</span></a>        <span class="k">if</span> <span class="n">tp</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">tp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2170"><a href="#-2170"><span class="linenos">2170</span></a>            <span class="n">tp</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="TinkoffBrokerServer-2171"><a href="#-2171"><span class="linenos">2171</span></a>
</span><span id="TinkoffBrokerServer-2172"><a href="#-2172"><span class="linenos">2172</span></a>        <span class="k">if</span> <span class="n">sl</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">sl</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2173"><a href="#-2173"><span class="linenos">2173</span></a>            <span class="n">sl</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="TinkoffBrokerServer-2174"><a href="#-2174"><span class="linenos">2174</span></a>
</span><span id="TinkoffBrokerServer-2175"><a href="#-2175"><span class="linenos">2175</span></a>        <span class="k">if</span> <span class="n">expDate</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">expDate</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2176"><a href="#-2176"><span class="linenos">2176</span></a>            <span class="n">expDate</span> <span class="o">=</span> <span class="s2">&quot;Undefined&quot;</span>
</span><span id="TinkoffBrokerServer-2177"><a href="#-2177"><span class="linenos">2177</span></a>
</span><span id="TinkoffBrokerServer-2178"><a href="#-2178"><span class="linenos">2178</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">):</span>
</span><span id="TinkoffBrokerServer-2179"><a href="#-2179"><span class="linenos">2179</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;`self.ticker` or `self.figi` variables must be defined!&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-2180"><a href="#-2180"><span class="linenos">2180</span></a>
</span><span id="TinkoffBrokerServer-2181"><a href="#-2181"><span class="linenos">2181</span></a>        <span class="n">instrument</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SearchByTicker</span><span class="p">(</span><span class="n">requestPrice</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">SearchByFIGI</span><span class="p">(</span><span class="n">requestPrice</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-2182"><a href="#-2182"><span class="linenos">2182</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer-2183"><a href="#-2183"><span class="linenos">2183</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">=</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer-2184"><a href="#-2184"><span class="linenos">2184</span></a>
</span><span id="TinkoffBrokerServer-2185"><a href="#-2185"><span class="linenos">2185</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Opening [</span><span class="si">{}</span><span class="s2">] market order: ticker [</span><span class="si">{}</span><span class="s2">], FIGI [</span><span class="si">{}</span><span class="s2">], lots [</span><span class="si">{}</span><span class="s2">], TP [</span><span class="si">{:.4f}</span><span class="s2">], SL [</span><span class="si">{:.4f}</span><span class="s2">], expiration date of TP/SL orders [</span><span class="si">{}</span><span class="s2">]. Wait, please...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">,</span> <span class="n">lots</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">sl</span><span class="p">,</span> <span class="n">expDate</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-2186"><a href="#-2186"><span class="linenos">2186</span></a>
</span><span id="TinkoffBrokerServer-2187"><a href="#-2187"><span class="linenos">2187</span></a>        <span class="n">openTradeURL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;/tinkoff.public.invest.api.contract.v1.OrdersService/PostOrder&quot;</span>
</span><span id="TinkoffBrokerServer-2188"><a href="#-2188"><span class="linenos">2188</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="nb">str</span><span class="p">({</span>
</span><span id="TinkoffBrokerServer-2189"><a href="#-2189"><span class="linenos">2189</span></a>            <span class="s2">&quot;figi&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-2190"><a href="#-2190"><span class="linenos">2190</span></a>            <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">lots</span><span class="p">),</span>
</span><span id="TinkoffBrokerServer-2191"><a href="#-2191"><span class="linenos">2191</span></a>            <span class="s2">&quot;direction&quot;</span><span class="p">:</span> <span class="s2">&quot;ORDER_DIRECTION_BUY&quot;</span> <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;Buy&quot;</span> <span class="k">else</span> <span class="s2">&quot;ORDER_DIRECTION_SELL&quot;</span><span class="p">,</span>  <span class="c1"># see: TKS_ORDER_DIRECTIONS</span>
</span><span id="TinkoffBrokerServer-2192"><a href="#-2192"><span class="linenos">2192</span></a>            <span class="s2">&quot;accountId&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">accountId</span><span class="p">),</span>
</span><span id="TinkoffBrokerServer-2193"><a href="#-2193"><span class="linenos">2193</span></a>            <span class="s2">&quot;orderType&quot;</span><span class="p">:</span> <span class="s2">&quot;ORDER_TYPE_MARKET&quot;</span><span class="p">,</span>  <span class="c1"># see: TKS_ORDER_TYPES</span>
</span><span id="TinkoffBrokerServer-2194"><a href="#-2194"><span class="linenos">2194</span></a>        <span class="p">})</span>
</span><span id="TinkoffBrokerServer-2195"><a href="#-2195"><span class="linenos">2195</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SendAPIRequest</span><span class="p">(</span><span class="n">openTradeURL</span><span class="p">,</span> <span class="n">reqType</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="n">retry</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-2196"><a href="#-2196"><span class="linenos">2196</span></a>
</span><span id="TinkoffBrokerServer-2197"><a href="#-2197"><span class="linenos">2197</span></a>        <span class="k">if</span> <span class="s2">&quot;orderId&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-2198"><a href="#-2198"><span class="linenos">2198</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">] market order [</span><span class="si">{}</span><span class="s2">] was executed: ticker [</span><span class="si">{}</span><span class="s2">], FIGI [</span><span class="si">{}</span><span class="s2">], lots [</span><span class="si">{}</span><span class="s2">]. Total order price: [</span><span class="si">{:.4f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">] (with commission: [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">]). Average price of lot: [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-2199"><a href="#-2199"><span class="linenos">2199</span></a>                <span class="n">operation</span><span class="p">,</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;orderId&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-2200"><a href="#-2200"><span class="linenos">2200</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">,</span> <span class="n">lots</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-2201"><a href="#-2201"><span class="linenos">2201</span></a>                <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;totalOrderAmount&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;totalOrderAmount&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">]),</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;totalOrderAmount&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-2202"><a href="#-2202"><span class="linenos">2202</span></a>                <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;initialCommission&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;initialCommission&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">]),</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;initialCommission&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-2203"><a href="#-2203"><span class="linenos">2203</span></a>                <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;executedOrderPrice&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;executedOrderPrice&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">]),</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;executedOrderPrice&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-2204"><a href="#-2204"><span class="linenos">2204</span></a>            <span class="p">))</span>
</span><span id="TinkoffBrokerServer-2205"><a href="#-2205"><span class="linenos">2205</span></a>
</span><span id="TinkoffBrokerServer-2206"><a href="#-2206"><span class="linenos">2206</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2207"><a href="#-2207"><span class="linenos">2207</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Not `oK` status received! Market order not created. See full debug log or try again and open order later.&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-2208"><a href="#-2208"><span class="linenos">2208</span></a>
</span><span id="TinkoffBrokerServer-2209"><a href="#-2209"><span class="linenos">2209</span></a>        <span class="k">if</span> <span class="n">tp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2210"><a href="#-2210"><span class="linenos">2210</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Order</span><span class="p">(</span><span class="n">operation</span><span class="o">=</span><span class="s2">&quot;Sell&quot;</span> <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;Buy&quot;</span> <span class="k">else</span> <span class="s2">&quot;Buy&quot;</span><span class="p">,</span> <span class="n">orderType</span><span class="o">=</span><span class="s2">&quot;Stop&quot;</span><span class="p">,</span> <span class="n">lots</span><span class="o">=</span><span class="n">lots</span><span class="p">,</span> <span class="n">targetPrice</span><span class="o">=</span><span class="n">tp</span><span class="p">,</span> <span class="n">limitPrice</span><span class="o">=</span><span class="n">tp</span><span class="p">,</span> <span class="n">stopType</span><span class="o">=</span><span class="s2">&quot;TP&quot;</span><span class="p">,</span> <span class="n">expDate</span><span class="o">=</span><span class="n">expDate</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-2211"><a href="#-2211"><span class="linenos">2211</span></a>
</span><span id="TinkoffBrokerServer-2212"><a href="#-2212"><span class="linenos">2212</span></a>        <span class="k">if</span> <span class="n">sl</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2213"><a href="#-2213"><span class="linenos">2213</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Order</span><span class="p">(</span><span class="n">operation</span><span class="o">=</span><span class="s2">&quot;Sell&quot;</span> <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;Buy&quot;</span> <span class="k">else</span> <span class="s2">&quot;Buy&quot;</span><span class="p">,</span> <span class="n">orderType</span><span class="o">=</span><span class="s2">&quot;Stop&quot;</span><span class="p">,</span> <span class="n">lots</span><span class="o">=</span><span class="n">lots</span><span class="p">,</span> <span class="n">targetPrice</span><span class="o">=</span><span class="n">sl</span><span class="p">,</span> <span class="n">limitPrice</span><span class="o">=</span><span class="n">sl</span><span class="p">,</span> <span class="n">stopType</span><span class="o">=</span><span class="s2">&quot;SL&quot;</span><span class="p">,</span> <span class="n">expDate</span><span class="o">=</span><span class="n">expDate</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-2214"><a href="#-2214"><span class="linenos">2214</span></a>
</span><span id="TinkoffBrokerServer-2215"><a href="#-2215"><span class="linenos">2215</span></a>        <span class="k">return</span> <span class="n">response</span>
</span><span id="TinkoffBrokerServer-2216"><a href="#-2216"><span class="linenos">2216</span></a>
</span><span id="TinkoffBrokerServer-2217"><a href="#-2217"><span class="linenos">2217</span></a>    <span class="k">def</span> <span class="nf">Buy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lots</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">sl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">expDate</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Undefined&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2218"><a href="#-2218"><span class="linenos">2218</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-2219"><a href="#-2219"><span class="linenos">2219</span></a><span class="sd">        More simple method than `Trade()`. Create `Buy` market order and make deal at the current price. Returns JSON data with response.</span>
</span><span id="TinkoffBrokerServer-2220"><a href="#-2220"><span class="linenos">2220</span></a><span class="sd">        If `tp` or `sl` &gt; 0, then in additional will opens stop-orders with &quot;TP&quot; and &quot;SL&quot; flags for `stopType` parameter.</span>
</span><span id="TinkoffBrokerServer-2221"><a href="#-2221"><span class="linenos">2221</span></a>
</span><span id="TinkoffBrokerServer-2222"><a href="#-2222"><span class="linenos">2222</span></a><span class="sd">        See also: `Order()` and `Trade()` docstrings.</span>
</span><span id="TinkoffBrokerServer-2223"><a href="#-2223"><span class="linenos">2223</span></a>
</span><span id="TinkoffBrokerServer-2224"><a href="#-2224"><span class="linenos">2224</span></a><span class="sd">        :param lots: volume, integer count of lots &gt;= 1.</span>
</span><span id="TinkoffBrokerServer-2225"><a href="#-2225"><span class="linenos">2225</span></a><span class="sd">        :param tp: float &gt; 0, take profit price of stop-order.</span>
</span><span id="TinkoffBrokerServer-2226"><a href="#-2226"><span class="linenos">2226</span></a><span class="sd">        :param sl: float &gt; 0, stop loss price of stop-order.</span>
</span><span id="TinkoffBrokerServer-2227"><a href="#-2227"><span class="linenos">2227</span></a><span class="sd">        :param expDate: it&#39;s a local date in future.</span>
</span><span id="TinkoffBrokerServer-2228"><a href="#-2228"><span class="linenos">2228</span></a><span class="sd">                        String has a format like this: `%Y-%m-%d %H:%M:%S`.</span>
</span><span id="TinkoffBrokerServer-2229"><a href="#-2229"><span class="linenos">2229</span></a><span class="sd">        :return: JSON with response from broker server.</span>
</span><span id="TinkoffBrokerServer-2230"><a href="#-2230"><span class="linenos">2230</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-2231"><a href="#-2231"><span class="linenos">2231</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Trade</span><span class="p">(</span><span class="n">operation</span><span class="o">=</span><span class="s2">&quot;Buy&quot;</span><span class="p">,</span> <span class="n">lots</span><span class="o">=</span><span class="n">lots</span><span class="p">,</span> <span class="n">tp</span><span class="o">=</span><span class="n">tp</span><span class="p">,</span> <span class="n">sl</span><span class="o">=</span><span class="n">sl</span><span class="p">,</span> <span class="n">expDate</span><span class="o">=</span><span class="n">expDate</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-2232"><a href="#-2232"><span class="linenos">2232</span></a>
</span><span id="TinkoffBrokerServer-2233"><a href="#-2233"><span class="linenos">2233</span></a>    <span class="k">def</span> <span class="nf">Sell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lots</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">sl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">expDate</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Undefined&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2234"><a href="#-2234"><span class="linenos">2234</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-2235"><a href="#-2235"><span class="linenos">2235</span></a><span class="sd">        More simple method than `Trade()`. Create `Sell` market order and make deal at the current price. Returns JSON data with response.</span>
</span><span id="TinkoffBrokerServer-2236"><a href="#-2236"><span class="linenos">2236</span></a><span class="sd">        If `tp` or `sl` &gt; 0, then in additional will opens stop-orders with &quot;TP&quot; and &quot;SL&quot; flags for `stopType` parameter.</span>
</span><span id="TinkoffBrokerServer-2237"><a href="#-2237"><span class="linenos">2237</span></a>
</span><span id="TinkoffBrokerServer-2238"><a href="#-2238"><span class="linenos">2238</span></a><span class="sd">        See also: `Order()` and `Trade()` docstrings.</span>
</span><span id="TinkoffBrokerServer-2239"><a href="#-2239"><span class="linenos">2239</span></a>
</span><span id="TinkoffBrokerServer-2240"><a href="#-2240"><span class="linenos">2240</span></a><span class="sd">        :param lots: volume, integer count of lots &gt;= 1.</span>
</span><span id="TinkoffBrokerServer-2241"><a href="#-2241"><span class="linenos">2241</span></a><span class="sd">        :param tp: float &gt; 0, take profit price of stop-order.</span>
</span><span id="TinkoffBrokerServer-2242"><a href="#-2242"><span class="linenos">2242</span></a><span class="sd">        :param sl: float &gt; 0, stop loss price of stop-order.</span>
</span><span id="TinkoffBrokerServer-2243"><a href="#-2243"><span class="linenos">2243</span></a><span class="sd">        :param expDate: it&#39;s a local date in future.</span>
</span><span id="TinkoffBrokerServer-2244"><a href="#-2244"><span class="linenos">2244</span></a><span class="sd">                        String has a format like this: `%Y-%m-%d %H:%M:%S`.</span>
</span><span id="TinkoffBrokerServer-2245"><a href="#-2245"><span class="linenos">2245</span></a><span class="sd">        :return: JSON with response from broker server.</span>
</span><span id="TinkoffBrokerServer-2246"><a href="#-2246"><span class="linenos">2246</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-2247"><a href="#-2247"><span class="linenos">2247</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Trade</span><span class="p">(</span><span class="n">operation</span><span class="o">=</span><span class="s2">&quot;Sell&quot;</span><span class="p">,</span> <span class="n">lots</span><span class="o">=</span><span class="n">lots</span><span class="p">,</span> <span class="n">tp</span><span class="o">=</span><span class="n">tp</span><span class="p">,</span> <span class="n">sl</span><span class="o">=</span><span class="n">sl</span><span class="p">,</span> <span class="n">expDate</span><span class="o">=</span><span class="n">expDate</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-2248"><a href="#-2248"><span class="linenos">2248</span></a>
</span><span id="TinkoffBrokerServer-2249"><a href="#-2249"><span class="linenos">2249</span></a>    <span class="k">def</span> <span class="nf">CloseTrades</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tickers</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">overview</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2250"><a href="#-2250"><span class="linenos">2250</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-2251"><a href="#-2251"><span class="linenos">2251</span></a><span class="sd">        Close position of given instruments.</span>
</span><span id="TinkoffBrokerServer-2252"><a href="#-2252"><span class="linenos">2252</span></a>
</span><span id="TinkoffBrokerServer-2253"><a href="#-2253"><span class="linenos">2253</span></a><span class="sd">        :param tickers: tickers list of instruments that must be closed.</span>
</span><span id="TinkoffBrokerServer-2254"><a href="#-2254"><span class="linenos">2254</span></a><span class="sd">        :param overview: pre-received dictionary with open trades, returned by `Overview()` method.</span>
</span><span id="TinkoffBrokerServer-2255"><a href="#-2255"><span class="linenos">2255</span></a><span class="sd">                         This avoids unnecessary downloading data from the server.</span>
</span><span id="TinkoffBrokerServer-2256"><a href="#-2256"><span class="linenos">2256</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-2257"><a href="#-2257"><span class="linenos">2257</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">tickers</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2258"><a href="#-2258"><span class="linenos">2258</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Tickers list empty, nothing to close.&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-2259"><a href="#-2259"><span class="linenos">2259</span></a>
</span><span id="TinkoffBrokerServer-2260"><a href="#-2260"><span class="linenos">2260</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2261"><a href="#-2261"><span class="linenos">2261</span></a>            <span class="k">if</span> <span class="n">overview</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">overview</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2262"><a href="#-2262"><span class="linenos">2262</span></a>                <span class="n">overview</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Overview</span><span class="p">(</span><span class="n">showStatistics</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-2263"><a href="#-2263"><span class="linenos">2263</span></a>
</span><span id="TinkoffBrokerServer-2264"><a href="#-2264"><span class="linenos">2264</span></a>            <span class="n">allOpenedTickers</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">iType</span> <span class="ow">in</span> <span class="n">TKS_INSTRUMENTS</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">overview</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="n">iType</span><span class="p">]]</span>
</span><span id="TinkoffBrokerServer-2265"><a href="#-2265"><span class="linenos">2265</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;All opened instruments by it&#39;s tickers names: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">allOpenedTickers</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-2266"><a href="#-2266"><span class="linenos">2266</span></a>
</span><span id="TinkoffBrokerServer-2267"><a href="#-2267"><span class="linenos">2267</span></a>            <span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">tickers</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2268"><a href="#-2268"><span class="linenos">2268</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">allOpenedTickers</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2269"><a href="#-2269"><span class="linenos">2269</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Instrument with ticker [</span><span class="si">{}</span><span class="s2">] not in open positions list!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ticker</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-2270"><a href="#-2270"><span class="linenos">2270</span></a>                    <span class="k">continue</span>
</span><span id="TinkoffBrokerServer-2271"><a href="#-2271"><span class="linenos">2271</span></a>
</span><span id="TinkoffBrokerServer-2272"><a href="#-2272"><span class="linenos">2272</span></a>                <span class="c1"># search open trade info about instrument by ticker:</span>
</span><span id="TinkoffBrokerServer-2273"><a href="#-2273"><span class="linenos">2273</span></a>                <span class="n">instrument</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="TinkoffBrokerServer-2274"><a href="#-2274"><span class="linenos">2274</span></a>                <span class="k">for</span> <span class="n">iType</span> <span class="ow">in</span> <span class="n">TKS_INSTRUMENTS</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2275"><a href="#-2275"><span class="linenos">2275</span></a>                    <span class="k">if</span> <span class="n">instrument</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2276"><a href="#-2276"><span class="linenos">2276</span></a>                        <span class="k">break</span>
</span><span id="TinkoffBrokerServer-2277"><a href="#-2277"><span class="linenos">2277</span></a>
</span><span id="TinkoffBrokerServer-2278"><a href="#-2278"><span class="linenos">2278</span></a>                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">overview</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="n">iType</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-2279"><a href="#-2279"><span class="linenos">2279</span></a>                        <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ticker</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2280"><a href="#-2280"><span class="linenos">2280</span></a>                            <span class="n">instrument</span> <span class="o">=</span> <span class="n">item</span>
</span><span id="TinkoffBrokerServer-2281"><a href="#-2281"><span class="linenos">2281</span></a>                            <span class="k">break</span>
</span><span id="TinkoffBrokerServer-2282"><a href="#-2282"><span class="linenos">2282</span></a>
</span><span id="TinkoffBrokerServer-2283"><a href="#-2283"><span class="linenos">2283</span></a>                <span class="k">if</span> <span class="n">instrument</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2284"><a href="#-2284"><span class="linenos">2284</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">ticker</span>
</span><span id="TinkoffBrokerServer-2285"><a href="#-2285"><span class="linenos">2285</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">=</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer-2286"><a href="#-2286"><span class="linenos">2286</span></a>
</span><span id="TinkoffBrokerServer-2287"><a href="#-2287"><span class="linenos">2287</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Closing trade of instrument: ticker [</span><span class="si">{}</span><span class="s2">], FIGI[</span><span class="si">{}</span><span class="s2">], lots [</span><span class="si">{}</span><span class="s2">]</span><span class="si">{}</span><span class="s2">. Wait, please...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-2288"><a href="#-2288"><span class="linenos">2288</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-2289"><a href="#-2289"><span class="linenos">2289</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-2290"><a href="#-2290"><span class="linenos">2290</span></a>                        <span class="nb">int</span><span class="p">(</span><span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;volume&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer-2291"><a href="#-2291"><span class="linenos">2291</span></a>                        <span class="s2">&quot;, blocked [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;blocked&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;blocked&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-2292"><a href="#-2292"><span class="linenos">2292</span></a>                    <span class="p">))</span>
</span><span id="TinkoffBrokerServer-2293"><a href="#-2293"><span class="linenos">2293</span></a>
</span><span id="TinkoffBrokerServer-2294"><a href="#-2294"><span class="linenos">2294</span></a>                    <span class="n">tradeLots</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;lots&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;blocked&quot;</span><span class="p">]</span>  <span class="c1"># available volumes in lots for close operation</span>
</span><span id="TinkoffBrokerServer-2295"><a href="#-2295"><span class="linenos">2295</span></a>
</span><span id="TinkoffBrokerServer-2296"><a href="#-2296"><span class="linenos">2296</span></a>                    <span class="k">if</span> <span class="n">tradeLots</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2297"><a href="#-2297"><span class="linenos">2297</span></a>                        <span class="k">if</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;blocked&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2298"><a href="#-2298"><span class="linenos">2298</span></a>                            <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Just for your information: there are [</span><span class="si">{}</span><span class="s2">] lots blocked for instrument [</span><span class="si">{}</span><span class="s2">]! Available only [</span><span class="si">{}</span><span class="s2">] lots to closing trade.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-2299"><a href="#-2299"><span class="linenos">2299</span></a>                                <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;blocked&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-2300"><a href="#-2300"><span class="linenos">2300</span></a>                                <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-2301"><a href="#-2301"><span class="linenos">2301</span></a>                                <span class="n">tradeLots</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-2302"><a href="#-2302"><span class="linenos">2302</span></a>                            <span class="p">))</span>
</span><span id="TinkoffBrokerServer-2303"><a href="#-2303"><span class="linenos">2303</span></a>
</span><span id="TinkoffBrokerServer-2304"><a href="#-2304"><span class="linenos">2304</span></a>                        <span class="c1"># if direction is &quot;Long&quot; then we need sell, if direction is &quot;Short&quot; then we need buy:</span>
</span><span id="TinkoffBrokerServer-2305"><a href="#-2305"><span class="linenos">2305</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">Trade</span><span class="p">(</span><span class="n">operation</span><span class="o">=</span><span class="s2">&quot;Sell&quot;</span> <span class="k">if</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;direction&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Long&quot;</span> <span class="k">else</span> <span class="s2">&quot;Buy&quot;</span><span class="p">,</span> <span class="n">lots</span><span class="o">=</span><span class="n">tradeLots</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-2306"><a href="#-2306"><span class="linenos">2306</span></a>
</span><span id="TinkoffBrokerServer-2307"><a href="#-2307"><span class="linenos">2307</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2308"><a href="#-2308"><span class="linenos">2308</span></a>                        <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;There are no available lots for instrument [</span><span class="si">{}</span><span class="s2">] to closing trade at this moment! Try again later or cancel some orders.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-2309"><a href="#-2309"><span class="linenos">2309</span></a>
</span><span id="TinkoffBrokerServer-2310"><a href="#-2310"><span class="linenos">2310</span></a>    <span class="k">def</span> <span class="nf">CloseAllTrades</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iType</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">overview</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2311"><a href="#-2311"><span class="linenos">2311</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-2312"><a href="#-2312"><span class="linenos">2312</span></a><span class="sd">        Close all positions of given instruments with defined type.</span>
</span><span id="TinkoffBrokerServer-2313"><a href="#-2313"><span class="linenos">2313</span></a>
</span><span id="TinkoffBrokerServer-2314"><a href="#-2314"><span class="linenos">2314</span></a><span class="sd">        :param iType: type of the instruments that be closed, it must be one of supported types in TKS_INSTRUMENTS list.</span>
</span><span id="TinkoffBrokerServer-2315"><a href="#-2315"><span class="linenos">2315</span></a><span class="sd">        :param overview: pre-received dictionary with open trades, returned by `Overview()` method.</span>
</span><span id="TinkoffBrokerServer-2316"><a href="#-2316"><span class="linenos">2316</span></a><span class="sd">                         This avoids unnecessary downloading data from the server.</span>
</span><span id="TinkoffBrokerServer-2317"><a href="#-2317"><span class="linenos">2317</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-2318"><a href="#-2318"><span class="linenos">2318</span></a>        <span class="k">if</span> <span class="n">iType</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">TKS_INSTRUMENTS</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2319"><a href="#-2319"><span class="linenos">2319</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Type of the instrument must be one of supported types: </span><span class="si">{}</span><span class="s2">. Given: [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TKS_INSTRUMENTS</span><span class="p">),</span> <span class="n">iType</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-2320"><a href="#-2320"><span class="linenos">2320</span></a>
</span><span id="TinkoffBrokerServer-2321"><a href="#-2321"><span class="linenos">2321</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2322"><a href="#-2322"><span class="linenos">2322</span></a>            <span class="k">if</span> <span class="n">overview</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">overview</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2323"><a href="#-2323"><span class="linenos">2323</span></a>                <span class="n">overview</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Overview</span><span class="p">(</span><span class="n">showStatistics</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-2324"><a href="#-2324"><span class="linenos">2324</span></a>
</span><span id="TinkoffBrokerServer-2325"><a href="#-2325"><span class="linenos">2325</span></a>            <span class="n">tickers</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">overview</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="n">iType</span><span class="p">]]</span>
</span><span id="TinkoffBrokerServer-2326"><a href="#-2326"><span class="linenos">2326</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Instrument tickers with type [</span><span class="si">{}</span><span class="s2">] that will be closed: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iType</span><span class="p">,</span> <span class="n">tickers</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-2327"><a href="#-2327"><span class="linenos">2327</span></a>
</span><span id="TinkoffBrokerServer-2328"><a href="#-2328"><span class="linenos">2328</span></a>            <span class="k">if</span> <span class="n">tickers</span> <span class="ow">and</span> <span class="n">overview</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2329"><a href="#-2329"><span class="linenos">2329</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">CloseTrades</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">overview</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-2330"><a href="#-2330"><span class="linenos">2330</span></a>
</span><span id="TinkoffBrokerServer-2331"><a href="#-2331"><span class="linenos">2331</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2332"><a href="#-2332"><span class="linenos">2332</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Instrument tickers with type [</span><span class="si">{}</span><span class="s2">] not found, nothing to close.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iType</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-2333"><a href="#-2333"><span class="linenos">2333</span></a>
</span><span id="TinkoffBrokerServer-2334"><a href="#-2334"><span class="linenos">2334</span></a>    <span class="k">def</span> <span class="nf">Order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">orderType</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">lots</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">targetPrice</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">limitPrice</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">stopType</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Limit&quot;</span><span class="p">,</span> <span class="n">expDate</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Undefined&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2335"><a href="#-2335"><span class="linenos">2335</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-2336"><a href="#-2336"><span class="linenos">2336</span></a><span class="sd">        Universal method to create market or limit orders with all available parameters.</span>
</span><span id="TinkoffBrokerServer-2337"><a href="#-2337"><span class="linenos">2337</span></a><span class="sd">        See more simple methods: `BuyLimit()`, `BuyStop()`, `SellLimit()`, `SellStop()`.</span>
</span><span id="TinkoffBrokerServer-2338"><a href="#-2338"><span class="linenos">2338</span></a>
</span><span id="TinkoffBrokerServer-2339"><a href="#-2339"><span class="linenos">2339</span></a><span class="sd">        If orderType is &quot;Limit&quot; then create pending limit-order below current price if operation is &quot;Buy&quot; and above</span>
</span><span id="TinkoffBrokerServer-2340"><a href="#-2340"><span class="linenos">2340</span></a><span class="sd">        current price if operation is &quot;Sell&quot;. A limit order has no expiration date, it lasts until the end of the trading day.</span>
</span><span id="TinkoffBrokerServer-2341"><a href="#-2341"><span class="linenos">2341</span></a>
</span><span id="TinkoffBrokerServer-2342"><a href="#-2342"><span class="linenos">2342</span></a><span class="sd">        Warning! If you try to create limit-order above current price if &quot;Buy&quot; or below current price if &quot;Sell&quot;</span>
</span><span id="TinkoffBrokerServer-2343"><a href="#-2343"><span class="linenos">2343</span></a><span class="sd">        then broker immediately open market order as you can do simple --buy or --sell operations!</span>
</span><span id="TinkoffBrokerServer-2344"><a href="#-2344"><span class="linenos">2344</span></a>
</span><span id="TinkoffBrokerServer-2345"><a href="#-2345"><span class="linenos">2345</span></a><span class="sd">        If orderType is &quot;Stop&quot; then creates stop-order with any direction &quot;Buy&quot; or &quot;Sell&quot;.</span>
</span><span id="TinkoffBrokerServer-2346"><a href="#-2346"><span class="linenos">2346</span></a><span class="sd">        When current price will go up or down to target price value then broker opens a limit order.</span>
</span><span id="TinkoffBrokerServer-2347"><a href="#-2347"><span class="linenos">2347</span></a><span class="sd">        Stop-order is opened with unlimited expiration date by default, or you can define expiration date with expDate parameter.</span>
</span><span id="TinkoffBrokerServer-2348"><a href="#-2348"><span class="linenos">2348</span></a>
</span><span id="TinkoffBrokerServer-2349"><a href="#-2349"><span class="linenos">2349</span></a><span class="sd">        Only one attempt and no retry for opens order. If network issue occurred you can create new request.</span>
</span><span id="TinkoffBrokerServer-2350"><a href="#-2350"><span class="linenos">2350</span></a>
</span><span id="TinkoffBrokerServer-2351"><a href="#-2351"><span class="linenos">2351</span></a><span class="sd">        :param operation: string &quot;Buy&quot; or &quot;Sell&quot;.</span>
</span><span id="TinkoffBrokerServer-2352"><a href="#-2352"><span class="linenos">2352</span></a><span class="sd">        :param orderType: string &quot;Limit&quot; or &quot;Stop&quot;.</span>
</span><span id="TinkoffBrokerServer-2353"><a href="#-2353"><span class="linenos">2353</span></a><span class="sd">        :param lots: volume, integer count of lots &gt;= 1.</span>
</span><span id="TinkoffBrokerServer-2354"><a href="#-2354"><span class="linenos">2354</span></a><span class="sd">        :param targetPrice: target price &gt; 0. This is open trade price for limit order.</span>
</span><span id="TinkoffBrokerServer-2355"><a href="#-2355"><span class="linenos">2355</span></a><span class="sd">        :param limitPrice: limit price &gt;= 0. This parameter only makes sense for stop-order. If limitPrice = 0, then it set as targetPrice.</span>
</span><span id="TinkoffBrokerServer-2356"><a href="#-2356"><span class="linenos">2356</span></a><span class="sd">                           Broker will creates limit-order with price equal to limitPrice, when current price goes to target price of stop-order.</span>
</span><span id="TinkoffBrokerServer-2357"><a href="#-2357"><span class="linenos">2357</span></a><span class="sd">        :param stopType: string &quot;Limit&quot; by default. This parameter only makes sense for stop-order. There are 3 stop-order types</span>
</span><span id="TinkoffBrokerServer-2358"><a href="#-2358"><span class="linenos">2358</span></a><span class="sd">                         &quot;SL&quot;, &quot;TP&quot;, &quot;Limit&quot; for &quot;Stop loss&quot;, &quot;Take profit&quot; and &quot;Stop limit&quot; types accordingly.</span>
</span><span id="TinkoffBrokerServer-2359"><a href="#-2359"><span class="linenos">2359</span></a><span class="sd">                         Stop loss order always executed by market price.</span>
</span><span id="TinkoffBrokerServer-2360"><a href="#-2360"><span class="linenos">2360</span></a><span class="sd">        :param expDate: string &quot;Undefined&quot; by default or local date in future.</span>
</span><span id="TinkoffBrokerServer-2361"><a href="#-2361"><span class="linenos">2361</span></a><span class="sd">                        String has a format like this: `%Y-%m-%d %H:%M:%S`.</span>
</span><span id="TinkoffBrokerServer-2362"><a href="#-2362"><span class="linenos">2362</span></a><span class="sd">                        This date is converting to UTC format for server. This parameter only makes sense for stop-order.</span>
</span><span id="TinkoffBrokerServer-2363"><a href="#-2363"><span class="linenos">2363</span></a><span class="sd">                        A limit order has no expiration date, it lasts until the end of the trading day.</span>
</span><span id="TinkoffBrokerServer-2364"><a href="#-2364"><span class="linenos">2364</span></a><span class="sd">        :return: JSON with response from broker server.</span>
</span><span id="TinkoffBrokerServer-2365"><a href="#-2365"><span class="linenos">2365</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-2366"><a href="#-2366"><span class="linenos">2366</span></a>        <span class="k">if</span> <span class="n">operation</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">operation</span> <span class="ow">or</span> <span class="n">operation</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Buy&quot;</span><span class="p">,</span> <span class="s2">&quot;Sell&quot;</span><span class="p">):</span>
</span><span id="TinkoffBrokerServer-2367"><a href="#-2367"><span class="linenos">2367</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;You must define operation type only one of them: `Buy` or `Sell`!&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-2368"><a href="#-2368"><span class="linenos">2368</span></a>
</span><span id="TinkoffBrokerServer-2369"><a href="#-2369"><span class="linenos">2369</span></a>        <span class="k">if</span> <span class="n">orderType</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">orderType</span> <span class="ow">or</span> <span class="n">orderType</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Limit&quot;</span><span class="p">,</span> <span class="s2">&quot;Stop&quot;</span><span class="p">):</span>
</span><span id="TinkoffBrokerServer-2370"><a href="#-2370"><span class="linenos">2370</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;You must define order type only one of them: `Limit` or `Stop`!&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-2371"><a href="#-2371"><span class="linenos">2371</span></a>
</span><span id="TinkoffBrokerServer-2372"><a href="#-2372"><span class="linenos">2372</span></a>        <span class="k">if</span> <span class="n">lots</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">lots</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2373"><a href="#-2373"><span class="linenos">2373</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;You must define trade volume &gt; 0: integer count of lots!&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-2374"><a href="#-2374"><span class="linenos">2374</span></a>
</span><span id="TinkoffBrokerServer-2375"><a href="#-2375"><span class="linenos">2375</span></a>        <span class="k">if</span> <span class="n">targetPrice</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">targetPrice</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2376"><a href="#-2376"><span class="linenos">2376</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Target price for limit-order must be greater than 0!&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-2377"><a href="#-2377"><span class="linenos">2377</span></a>
</span><span id="TinkoffBrokerServer-2378"><a href="#-2378"><span class="linenos">2378</span></a>        <span class="k">if</span> <span class="n">limitPrice</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">limitPrice</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2379"><a href="#-2379"><span class="linenos">2379</span></a>            <span class="n">limitPrice</span> <span class="o">=</span> <span class="n">targetPrice</span>
</span><span id="TinkoffBrokerServer-2380"><a href="#-2380"><span class="linenos">2380</span></a>
</span><span id="TinkoffBrokerServer-2381"><a href="#-2381"><span class="linenos">2381</span></a>        <span class="k">if</span> <span class="n">stopType</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">stopType</span> <span class="ow">or</span> <span class="n">stopType</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;SL&quot;</span><span class="p">,</span> <span class="s2">&quot;TP&quot;</span><span class="p">,</span> <span class="s2">&quot;Limit&quot;</span><span class="p">):</span>
</span><span id="TinkoffBrokerServer-2382"><a href="#-2382"><span class="linenos">2382</span></a>            <span class="n">stopType</span> <span class="o">=</span> <span class="s2">&quot;Limit&quot;</span>
</span><span id="TinkoffBrokerServer-2383"><a href="#-2383"><span class="linenos">2383</span></a>
</span><span id="TinkoffBrokerServer-2384"><a href="#-2384"><span class="linenos">2384</span></a>        <span class="k">if</span> <span class="n">expDate</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">expDate</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2385"><a href="#-2385"><span class="linenos">2385</span></a>            <span class="n">expDate</span> <span class="o">=</span> <span class="s2">&quot;Undefined&quot;</span>
</span><span id="TinkoffBrokerServer-2386"><a href="#-2386"><span class="linenos">2386</span></a>
</span><span id="TinkoffBrokerServer-2387"><a href="#-2387"><span class="linenos">2387</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">):</span>
</span><span id="TinkoffBrokerServer-2388"><a href="#-2388"><span class="linenos">2388</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;`self.ticker` or `self.figi` variables must be defined!&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-2389"><a href="#-2389"><span class="linenos">2389</span></a>
</span><span id="TinkoffBrokerServer-2390"><a href="#-2390"><span class="linenos">2390</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="TinkoffBrokerServer-2391"><a href="#-2391"><span class="linenos">2391</span></a>        <span class="n">instrument</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SearchByTicker</span><span class="p">(</span><span class="n">requestPrice</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">SearchByFIGI</span><span class="p">(</span><span class="n">requestPrice</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-2392"><a href="#-2392"><span class="linenos">2392</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer-2393"><a href="#-2393"><span class="linenos">2393</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">=</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer-2394"><a href="#-2394"><span class="linenos">2394</span></a>
</span><span id="TinkoffBrokerServer-2395"><a href="#-2395"><span class="linenos">2395</span></a>        <span class="k">if</span> <span class="n">orderType</span> <span class="o">==</span> <span class="s2">&quot;Limit&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2396"><a href="#-2396"><span class="linenos">2396</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-2397"><a href="#-2397"><span class="linenos">2397</span></a>                <span class="s2">&quot;Creating pending limit-order: ticker [</span><span class="si">{}</span><span class="s2">], FIGI [</span><span class="si">{}</span><span class="s2">], action [</span><span class="si">{}</span><span class="s2">], lots [</span><span class="si">{}</span><span class="s2">] and the target price [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">]. Wait, please...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-2398"><a href="#-2398"><span class="linenos">2398</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-2399"><a href="#-2399"><span class="linenos">2399</span></a>                    <span class="n">operation</span><span class="p">,</span> <span class="n">lots</span><span class="p">,</span> <span class="n">targetPrice</span><span class="p">,</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-2400"><a href="#-2400"><span class="linenos">2400</span></a>                <span class="p">))</span>
</span><span id="TinkoffBrokerServer-2401"><a href="#-2401"><span class="linenos">2401</span></a>
</span><span id="TinkoffBrokerServer-2402"><a href="#-2402"><span class="linenos">2402</span></a>            <span class="n">openOrderURL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;/tinkoff.public.invest.api.contract.v1.OrdersService/PostOrder&quot;</span>
</span><span id="TinkoffBrokerServer-2403"><a href="#-2403"><span class="linenos">2403</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="nb">str</span><span class="p">({</span>
</span><span id="TinkoffBrokerServer-2404"><a href="#-2404"><span class="linenos">2404</span></a>                <span class="s2">&quot;figi&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-2405"><a href="#-2405"><span class="linenos">2405</span></a>                <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">lots</span><span class="p">),</span>
</span><span id="TinkoffBrokerServer-2406"><a href="#-2406"><span class="linenos">2406</span></a>                <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="n">FloatToNano</span><span class="p">(</span><span class="n">targetPrice</span><span class="p">),</span>
</span><span id="TinkoffBrokerServer-2407"><a href="#-2407"><span class="linenos">2407</span></a>                <span class="s2">&quot;direction&quot;</span><span class="p">:</span> <span class="s2">&quot;ORDER_DIRECTION_BUY&quot;</span> <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;Buy&quot;</span> <span class="k">else</span> <span class="s2">&quot;ORDER_DIRECTION_SELL&quot;</span><span class="p">,</span>  <span class="c1"># see: TKS_ORDER_DIRECTIONS</span>
</span><span id="TinkoffBrokerServer-2408"><a href="#-2408"><span class="linenos">2408</span></a>                <span class="s2">&quot;accountId&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">accountId</span><span class="p">),</span>
</span><span id="TinkoffBrokerServer-2409"><a href="#-2409"><span class="linenos">2409</span></a>                <span class="s2">&quot;orderType&quot;</span><span class="p">:</span> <span class="s2">&quot;ORDER_TYPE_LIMIT&quot;</span><span class="p">,</span>  <span class="c1"># see: TKS_ORDER_TYPES</span>
</span><span id="TinkoffBrokerServer-2410"><a href="#-2410"><span class="linenos">2410</span></a>            <span class="p">})</span>
</span><span id="TinkoffBrokerServer-2411"><a href="#-2411"><span class="linenos">2411</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SendAPIRequest</span><span class="p">(</span><span class="n">openOrderURL</span><span class="p">,</span> <span class="n">reqType</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="n">retry</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-2412"><a href="#-2412"><span class="linenos">2412</span></a>
</span><span id="TinkoffBrokerServer-2413"><a href="#-2413"><span class="linenos">2413</span></a>            <span class="k">if</span> <span class="s2">&quot;orderId&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-2414"><a href="#-2414"><span class="linenos">2414</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-2415"><a href="#-2415"><span class="linenos">2415</span></a>                    <span class="s2">&quot;Limit-order [</span><span class="si">{}</span><span class="s2">] was created: ticker [</span><span class="si">{}</span><span class="s2">], FIGI [</span><span class="si">{}</span><span class="s2">], action [</span><span class="si">{}</span><span class="s2">], lots [</span><span class="si">{}</span><span class="s2">], target price [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-2416"><a href="#-2416"><span class="linenos">2416</span></a>                        <span class="n">response</span><span class="p">[</span><span class="s2">&quot;orderId&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-2417"><a href="#-2417"><span class="linenos">2417</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-2418"><a href="#-2418"><span class="linenos">2418</span></a>                        <span class="n">operation</span><span class="p">,</span> <span class="n">lots</span><span class="p">,</span> <span class="n">targetPrice</span><span class="p">,</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-2419"><a href="#-2419"><span class="linenos">2419</span></a>                    <span class="p">))</span>
</span><span id="TinkoffBrokerServer-2420"><a href="#-2420"><span class="linenos">2420</span></a>
</span><span id="TinkoffBrokerServer-2421"><a href="#-2421"><span class="linenos">2421</span></a>                <span class="k">if</span> <span class="s2">&quot;lastPrice&quot;</span> <span class="ow">in</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-2422"><a href="#-2422"><span class="linenos">2422</span></a>                    <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;Buy&quot;</span> <span class="ow">and</span> <span class="n">targetPrice</span> <span class="o">&gt;</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-2423"><a href="#-2423"><span class="linenos">2423</span></a>                        <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Your order was executed as a market order, not as a limit order! Comment: because your target price [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">] was higher than current price [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">] broker immediately opened `Buy` market order, such as if you did simple `--buy` operation.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-2424"><a href="#-2424"><span class="linenos">2424</span></a>                            <span class="n">targetPrice</span><span class="p">,</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-2425"><a href="#-2425"><span class="linenos">2425</span></a>                            <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">],</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-2426"><a href="#-2426"><span class="linenos">2426</span></a>                        <span class="p">))</span>
</span><span id="TinkoffBrokerServer-2427"><a href="#-2427"><span class="linenos">2427</span></a>
</span><span id="TinkoffBrokerServer-2428"><a href="#-2428"><span class="linenos">2428</span></a>                    <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;Sell&quot;</span> <span class="ow">and</span> <span class="n">targetPrice</span> <span class="o">&lt;</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-2429"><a href="#-2429"><span class="linenos">2429</span></a>                        <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Your order was executed as a market order, not as a limit order! Comment: because your target price [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">] was lower than current price [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">] broker immediately opened `Sell` market order, such as if you did simple `--sell` operation.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-2430"><a href="#-2430"><span class="linenos">2430</span></a>                            <span class="n">targetPrice</span><span class="p">,</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-2431"><a href="#-2431"><span class="linenos">2431</span></a>                            <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">],</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-2432"><a href="#-2432"><span class="linenos">2432</span></a>                        <span class="p">))</span>
</span><span id="TinkoffBrokerServer-2433"><a href="#-2433"><span class="linenos">2433</span></a>
</span><span id="TinkoffBrokerServer-2434"><a href="#-2434"><span class="linenos">2434</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2435"><a href="#-2435"><span class="linenos">2435</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Not `oK` status received! Limit order not opened. See full debug log or try again and open order later.&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-2436"><a href="#-2436"><span class="linenos">2436</span></a>
</span><span id="TinkoffBrokerServer-2437"><a href="#-2437"><span class="linenos">2437</span></a>        <span class="k">if</span> <span class="n">orderType</span> <span class="o">==</span> <span class="s2">&quot;Stop&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2438"><a href="#-2438"><span class="linenos">2438</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-2439"><a href="#-2439"><span class="linenos">2439</span></a>                <span class="s2">&quot;Creating stop-order: ticker [</span><span class="si">{}</span><span class="s2">], FIGI [</span><span class="si">{}</span><span class="s2">], action [</span><span class="si">{}</span><span class="s2">], lots [</span><span class="si">{}</span><span class="s2">], target price [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">], limit price [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">], stop-order type [</span><span class="si">{}</span><span class="s2">] and local expiration date [</span><span class="si">{}</span><span class="s2">]. Wait, please...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-2440"><a href="#-2440"><span class="linenos">2440</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-2441"><a href="#-2441"><span class="linenos">2441</span></a>                    <span class="n">operation</span><span class="p">,</span> <span class="n">lots</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-2442"><a href="#-2442"><span class="linenos">2442</span></a>                    <span class="n">targetPrice</span><span class="p">,</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-2443"><a href="#-2443"><span class="linenos">2443</span></a>                    <span class="n">limitPrice</span><span class="p">,</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-2444"><a href="#-2444"><span class="linenos">2444</span></a>                    <span class="n">stopType</span><span class="p">,</span> <span class="n">expDate</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-2445"><a href="#-2445"><span class="linenos">2445</span></a>                <span class="p">))</span>
</span><span id="TinkoffBrokerServer-2446"><a href="#-2446"><span class="linenos">2446</span></a>
</span><span id="TinkoffBrokerServer-2447"><a href="#-2447"><span class="linenos">2447</span></a>            <span class="n">openOrderURL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;/tinkoff.public.invest.api.contract.v1.StopOrdersService/PostStopOrder&quot;</span>
</span><span id="TinkoffBrokerServer-2448"><a href="#-2448"><span class="linenos">2448</span></a>            <span class="n">expDateUTC</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">expDate</span> <span class="o">==</span> <span class="s2">&quot;Undefined&quot;</span> <span class="k">else</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">expDate</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">tzlocal</span><span class="p">())</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">tzutc</span><span class="p">())</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S.</span><span class="si">%f</span><span class="s2">Z&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-2449"><a href="#-2449"><span class="linenos">2449</span></a>            <span class="n">stopOrderType</span> <span class="o">=</span> <span class="s2">&quot;STOP_ORDER_TYPE_STOP_LOSS&quot;</span> <span class="k">if</span> <span class="n">stopType</span> <span class="o">==</span> <span class="s2">&quot;SL&quot;</span> <span class="k">else</span> <span class="s2">&quot;STOP_ORDER_TYPE_TAKE_PROFIT&quot;</span> <span class="k">if</span> <span class="n">stopType</span> <span class="o">==</span> <span class="s2">&quot;TP&quot;</span> <span class="k">else</span> <span class="s2">&quot;STOP_ORDER_TYPE_STOP_LIMIT&quot;</span>
</span><span id="TinkoffBrokerServer-2450"><a href="#-2450"><span class="linenos">2450</span></a>
</span><span id="TinkoffBrokerServer-2451"><a href="#-2451"><span class="linenos">2451</span></a>            <span class="n">body</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="TinkoffBrokerServer-2452"><a href="#-2452"><span class="linenos">2452</span></a>                <span class="s2">&quot;figi&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-2453"><a href="#-2453"><span class="linenos">2453</span></a>                <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">lots</span><span class="p">),</span>
</span><span id="TinkoffBrokerServer-2454"><a href="#-2454"><span class="linenos">2454</span></a>                <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="n">FloatToNano</span><span class="p">(</span><span class="n">limitPrice</span><span class="p">),</span>
</span><span id="TinkoffBrokerServer-2455"><a href="#-2455"><span class="linenos">2455</span></a>                <span class="s2">&quot;stopPrice&quot;</span><span class="p">:</span> <span class="n">FloatToNano</span><span class="p">(</span><span class="n">targetPrice</span><span class="p">),</span>
</span><span id="TinkoffBrokerServer-2456"><a href="#-2456"><span class="linenos">2456</span></a>                <span class="s2">&quot;direction&quot;</span><span class="p">:</span> <span class="s2">&quot;STOP_ORDER_DIRECTION_BUY&quot;</span> <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;Buy&quot;</span> <span class="k">else</span> <span class="s2">&quot;STOP_ORDER_DIRECTION_SELL&quot;</span><span class="p">,</span>  <span class="c1"># see: TKS_STOP_ORDER_DIRECTIONS</span>
</span><span id="TinkoffBrokerServer-2457"><a href="#-2457"><span class="linenos">2457</span></a>                <span class="s2">&quot;accountId&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">accountId</span><span class="p">),</span>
</span><span id="TinkoffBrokerServer-2458"><a href="#-2458"><span class="linenos">2458</span></a>                <span class="s2">&quot;expirationType&quot;</span><span class="p">:</span> <span class="s2">&quot;STOP_ORDER_EXPIRATION_TYPE_GOOD_TILL_DATE&quot;</span> <span class="k">if</span> <span class="n">expDateUTC</span> <span class="k">else</span> <span class="s2">&quot;STOP_ORDER_EXPIRATION_TYPE_GOOD_TILL_CANCEL&quot;</span><span class="p">,</span>  <span class="c1"># see: TKS_STOP_ORDER_EXPIRATION_TYPES</span>
</span><span id="TinkoffBrokerServer-2459"><a href="#-2459"><span class="linenos">2459</span></a>                <span class="s2">&quot;stopOrderType&quot;</span><span class="p">:</span> <span class="n">stopOrderType</span><span class="p">,</span>  <span class="c1"># see: TKS_STOP_ORDER_TYPES</span>
</span><span id="TinkoffBrokerServer-2460"><a href="#-2460"><span class="linenos">2460</span></a>            <span class="p">}</span>
</span><span id="TinkoffBrokerServer-2461"><a href="#-2461"><span class="linenos">2461</span></a>
</span><span id="TinkoffBrokerServer-2462"><a href="#-2462"><span class="linenos">2462</span></a>            <span class="k">if</span> <span class="n">expDateUTC</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2463"><a href="#-2463"><span class="linenos">2463</span></a>                <span class="n">body</span><span class="p">[</span><span class="s2">&quot;expireDate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">expDateUTC</span>
</span><span id="TinkoffBrokerServer-2464"><a href="#-2464"><span class="linenos">2464</span></a>
</span><span id="TinkoffBrokerServer-2465"><a href="#-2465"><span class="linenos">2465</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-2466"><a href="#-2466"><span class="linenos">2466</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SendAPIRequest</span><span class="p">(</span><span class="n">openOrderURL</span><span class="p">,</span> <span class="n">reqType</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="n">retry</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-2467"><a href="#-2467"><span class="linenos">2467</span></a>
</span><span id="TinkoffBrokerServer-2468"><a href="#-2468"><span class="linenos">2468</span></a>            <span class="k">if</span> <span class="s2">&quot;stopOrderId&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer-2469"><a href="#-2469"><span class="linenos">2469</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-2470"><a href="#-2470"><span class="linenos">2470</span></a>                    <span class="s2">&quot;Stop-order [</span><span class="si">{}</span><span class="s2">] was created: ticker [</span><span class="si">{}</span><span class="s2">], FIGI [</span><span class="si">{}</span><span class="s2">], action [</span><span class="si">{}</span><span class="s2">], lots [</span><span class="si">{}</span><span class="s2">], target price [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">], limit price [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">], stop-order type [</span><span class="si">{}</span><span class="s2">] and expiration date in UTC [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-2471"><a href="#-2471"><span class="linenos">2471</span></a>                    <span class="n">response</span><span class="p">[</span><span class="s2">&quot;stopOrderId&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-2472"><a href="#-2472"><span class="linenos">2472</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-2473"><a href="#-2473"><span class="linenos">2473</span></a>                    <span class="n">operation</span><span class="p">,</span> <span class="n">lots</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer-2474"><a href="#-2474"><span class="linenos">2474</span></a>                    <span class="n">targetPrice</span><span class="p">,</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-2475"><a href="#-2475"><span class="linenos">2475</span></a>                    <span class="n">limitPrice</span><span class="p">,</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-2476"><a href="#-2476"><span class="linenos">2476</span></a>                    <span class="n">TKS_STOP_ORDER_TYPES</span><span class="p">[</span><span class="n">stopOrderType</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-2477"><a href="#-2477"><span class="linenos">2477</span></a>                    <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">expDateUTC</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S.</span><span class="si">%f</span><span class="s2">Z&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">tzutc</span><span class="p">())</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">tzutc</span><span class="p">())</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">expDateUTC</span> <span class="k">else</span> <span class="n">TKS_STOP_ORDER_EXPIRATION_TYPES</span><span class="p">[</span><span class="s2">&quot;STOP_ORDER_EXPIRATION_TYPE_UNSPECIFIED&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-2478"><a href="#-2478"><span class="linenos">2478</span></a>                <span class="p">))</span>
</span><span id="TinkoffBrokerServer-2479"><a href="#-2479"><span class="linenos">2479</span></a>
</span><span id="TinkoffBrokerServer-2480"><a href="#-2480"><span class="linenos">2480</span></a>                <span class="k">if</span> <span class="s2">&quot;lastPrice&quot;</span> <span class="ow">in</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-2481"><a href="#-2481"><span class="linenos">2481</span></a>                    <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;Buy&quot;</span> <span class="ow">and</span> <span class="n">targetPrice</span> <span class="o">&lt;</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">stopType</span> <span class="o">!=</span> <span class="s2">&quot;TP&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2482"><a href="#-2482"><span class="linenos">2482</span></a>                        <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;The broker will cancel this order after some time. Comment: you placed the wrong stop order because the target buy price [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">] is lower than the current price [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">]. Also try to set up order type as `TP` if you want to place stop order at that price.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-2483"><a href="#-2483"><span class="linenos">2483</span></a>                            <span class="n">targetPrice</span><span class="p">,</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-2484"><a href="#-2484"><span class="linenos">2484</span></a>                            <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">],</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-2485"><a href="#-2485"><span class="linenos">2485</span></a>                        <span class="p">))</span>
</span><span id="TinkoffBrokerServer-2486"><a href="#-2486"><span class="linenos">2486</span></a>
</span><span id="TinkoffBrokerServer-2487"><a href="#-2487"><span class="linenos">2487</span></a>                    <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;Sell&quot;</span> <span class="ow">and</span> <span class="n">targetPrice</span> <span class="o">&gt;</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">stopType</span> <span class="o">!=</span> <span class="s2">&quot;TP&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2488"><a href="#-2488"><span class="linenos">2488</span></a>                        <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;The broker will cancel this order after some time. Comment: you placed the wrong stop order because the target sell price [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">] is higher than the current price [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">]. Also try to set up order type as `TP` if you want to place stop order at that price.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer-2489"><a href="#-2489"><span class="linenos">2489</span></a>                            <span class="n">targetPrice</span><span class="p">,</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-2490"><a href="#-2490"><span class="linenos">2490</span></a>                            <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">],</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer-2491"><a href="#-2491"><span class="linenos">2491</span></a>                        <span class="p">))</span>
</span><span id="TinkoffBrokerServer-2492"><a href="#-2492"><span class="linenos">2492</span></a>
</span><span id="TinkoffBrokerServer-2493"><a href="#-2493"><span class="linenos">2493</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2494"><a href="#-2494"><span class="linenos">2494</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Not `oK` status received! Stop order not opened. See full debug log or try again and open order later.&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-2495"><a href="#-2495"><span class="linenos">2495</span></a>
</span><span id="TinkoffBrokerServer-2496"><a href="#-2496"><span class="linenos">2496</span></a>        <span class="k">return</span> <span class="n">response</span>
</span><span id="TinkoffBrokerServer-2497"><a href="#-2497"><span class="linenos">2497</span></a>
</span><span id="TinkoffBrokerServer-2498"><a href="#-2498"><span class="linenos">2498</span></a>    <span class="k">def</span> <span class="nf">BuyLimit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lots</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">targetPrice</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2499"><a href="#-2499"><span class="linenos">2499</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-2500"><a href="#-2500"><span class="linenos">2500</span></a><span class="sd">        Create pending `Buy` limit-order (below current price). You must specify only 2 parameters:</span>
</span><span id="TinkoffBrokerServer-2501"><a href="#-2501"><span class="linenos">2501</span></a><span class="sd">        `lots` and `target price` to open buy limit-order. If you try to create buy limit-order above current price then</span>
</span><span id="TinkoffBrokerServer-2502"><a href="#-2502"><span class="linenos">2502</span></a><span class="sd">        broker immediately open `Buy` market order, such as if you do simple `--buy` operation!</span>
</span><span id="TinkoffBrokerServer-2503"><a href="#-2503"><span class="linenos">2503</span></a><span class="sd">        See also: `Order()` docstring.</span>
</span><span id="TinkoffBrokerServer-2504"><a href="#-2504"><span class="linenos">2504</span></a>
</span><span id="TinkoffBrokerServer-2505"><a href="#-2505"><span class="linenos">2505</span></a><span class="sd">        :param lots: volume, integer count of lots &gt;= 1.</span>
</span><span id="TinkoffBrokerServer-2506"><a href="#-2506"><span class="linenos">2506</span></a><span class="sd">        :param targetPrice: target price &gt; 0. This is open trade price for limit order.</span>
</span><span id="TinkoffBrokerServer-2507"><a href="#-2507"><span class="linenos">2507</span></a><span class="sd">        :return: JSON with response from broker server.</span>
</span><span id="TinkoffBrokerServer-2508"><a href="#-2508"><span class="linenos">2508</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-2509"><a href="#-2509"><span class="linenos">2509</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Order</span><span class="p">(</span><span class="n">operation</span><span class="o">=</span><span class="s2">&quot;Buy&quot;</span><span class="p">,</span> <span class="n">orderType</span><span class="o">=</span><span class="s2">&quot;Limit&quot;</span><span class="p">,</span> <span class="n">lots</span><span class="o">=</span><span class="n">lots</span><span class="p">,</span> <span class="n">targetPrice</span><span class="o">=</span><span class="n">targetPrice</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-2510"><a href="#-2510"><span class="linenos">2510</span></a>
</span><span id="TinkoffBrokerServer-2511"><a href="#-2511"><span class="linenos">2511</span></a>    <span class="k">def</span> <span class="nf">BuyStop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lots</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">targetPrice</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">limitPrice</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">stopType</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Limit&quot;</span><span class="p">,</span> <span class="n">expDate</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Undefined&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2512"><a href="#-2512"><span class="linenos">2512</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-2513"><a href="#-2513"><span class="linenos">2513</span></a><span class="sd">        Create `Buy` stop-order. You must specify at least 2 parameters: `lots` `target price` to open buy stop-order.</span>
</span><span id="TinkoffBrokerServer-2514"><a href="#-2514"><span class="linenos">2514</span></a><span class="sd">        In additional you can specify 3 parameters for buy stop-order: `limit price` &gt;=0, `stop type` = Limit|SL|TP,</span>
</span><span id="TinkoffBrokerServer-2515"><a href="#-2515"><span class="linenos">2515</span></a><span class="sd">        `expiration date` = Undefined|`%%Y-%%m-%%d %%H:%%M:%%S`. When current price will go up or down to</span>
</span><span id="TinkoffBrokerServer-2516"><a href="#-2516"><span class="linenos">2516</span></a><span class="sd">        target price value then broker opens a limit order. See also: `Order()` docstring.</span>
</span><span id="TinkoffBrokerServer-2517"><a href="#-2517"><span class="linenos">2517</span></a>
</span><span id="TinkoffBrokerServer-2518"><a href="#-2518"><span class="linenos">2518</span></a><span class="sd">        :param lots: volume, integer count of lots &gt;= 1.</span>
</span><span id="TinkoffBrokerServer-2519"><a href="#-2519"><span class="linenos">2519</span></a><span class="sd">        :param targetPrice: target price &gt; 0. This is trigger price for buy stop-order.</span>
</span><span id="TinkoffBrokerServer-2520"><a href="#-2520"><span class="linenos">2520</span></a><span class="sd">        :param limitPrice: limit price &gt;= 0 (limitPrice = targetPrice if limitPrice is 0). Broker will creates limit-order</span>
</span><span id="TinkoffBrokerServer-2521"><a href="#-2521"><span class="linenos">2521</span></a><span class="sd">                           with price equal to limitPrice, when current price goes to target price of buy stop-order.</span>
</span><span id="TinkoffBrokerServer-2522"><a href="#-2522"><span class="linenos">2522</span></a><span class="sd">        :param stopType: string &quot;Limit&quot; by default. There are 3 stop-order types &quot;SL&quot;, &quot;TP&quot;, &quot;Limit&quot;</span>
</span><span id="TinkoffBrokerServer-2523"><a href="#-2523"><span class="linenos">2523</span></a><span class="sd">                         for &quot;Stop loss&quot;, &quot;Take profit&quot; and &quot;Stop limit&quot; types accordingly.</span>
</span><span id="TinkoffBrokerServer-2524"><a href="#-2524"><span class="linenos">2524</span></a><span class="sd">        :param expDate: string &quot;Undefined&quot; by default or local date in future.</span>
</span><span id="TinkoffBrokerServer-2525"><a href="#-2525"><span class="linenos">2525</span></a><span class="sd">                        String has a format like this: `%Y-%m-%d %H:%M:%S`.</span>
</span><span id="TinkoffBrokerServer-2526"><a href="#-2526"><span class="linenos">2526</span></a><span class="sd">                        This date is converting to UTC format for server.</span>
</span><span id="TinkoffBrokerServer-2527"><a href="#-2527"><span class="linenos">2527</span></a><span class="sd">        :return: JSON with response from broker server.</span>
</span><span id="TinkoffBrokerServer-2528"><a href="#-2528"><span class="linenos">2528</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-2529"><a href="#-2529"><span class="linenos">2529</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Order</span><span class="p">(</span><span class="n">operation</span><span class="o">=</span><span class="s2">&quot;Buy&quot;</span><span class="p">,</span> <span class="n">orderType</span><span class="o">=</span><span class="s2">&quot;Stop&quot;</span><span class="p">,</span> <span class="n">lots</span><span class="o">=</span><span class="n">lots</span><span class="p">,</span> <span class="n">targetPrice</span><span class="o">=</span><span class="n">targetPrice</span><span class="p">,</span> <span class="n">limitPrice</span><span class="o">=</span><span class="n">limitPrice</span><span class="p">,</span> <span class="n">stopType</span><span class="o">=</span><span class="n">stopType</span><span class="p">,</span> <span class="n">expDate</span><span class="o">=</span><span class="n">expDate</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-2530"><a href="#-2530"><span class="linenos">2530</span></a>
</span><span id="TinkoffBrokerServer-2531"><a href="#-2531"><span class="linenos">2531</span></a>    <span class="k">def</span> <span class="nf">SellLimit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lots</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">targetPrice</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2532"><a href="#-2532"><span class="linenos">2532</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-2533"><a href="#-2533"><span class="linenos">2533</span></a><span class="sd">        Create pending `Sell` limit-order (above current price). You must specify only 2 parameters:</span>
</span><span id="TinkoffBrokerServer-2534"><a href="#-2534"><span class="linenos">2534</span></a><span class="sd">        `lots` and `target price` to open sell limit-order. If you try to create sell limit-order below current price then</span>
</span><span id="TinkoffBrokerServer-2535"><a href="#-2535"><span class="linenos">2535</span></a><span class="sd">        broker immediately open `Sell` market order, such as if you do simple `--sell` operation!</span>
</span><span id="TinkoffBrokerServer-2536"><a href="#-2536"><span class="linenos">2536</span></a><span class="sd">        See also: `Order()` docstring.</span>
</span><span id="TinkoffBrokerServer-2537"><a href="#-2537"><span class="linenos">2537</span></a>
</span><span id="TinkoffBrokerServer-2538"><a href="#-2538"><span class="linenos">2538</span></a><span class="sd">        :param lots: volume, integer count of lots &gt;= 1.</span>
</span><span id="TinkoffBrokerServer-2539"><a href="#-2539"><span class="linenos">2539</span></a><span class="sd">        :param targetPrice: target price &gt; 0. This is open trade price for limit order.</span>
</span><span id="TinkoffBrokerServer-2540"><a href="#-2540"><span class="linenos">2540</span></a><span class="sd">        :return: JSON with response from broker server.</span>
</span><span id="TinkoffBrokerServer-2541"><a href="#-2541"><span class="linenos">2541</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-2542"><a href="#-2542"><span class="linenos">2542</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Order</span><span class="p">(</span><span class="n">operation</span><span class="o">=</span><span class="s2">&quot;Sell&quot;</span><span class="p">,</span> <span class="n">orderType</span><span class="o">=</span><span class="s2">&quot;Limit&quot;</span><span class="p">,</span> <span class="n">lots</span><span class="o">=</span><span class="n">lots</span><span class="p">,</span> <span class="n">targetPrice</span><span class="o">=</span><span class="n">targetPrice</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-2543"><a href="#-2543"><span class="linenos">2543</span></a>
</span><span id="TinkoffBrokerServer-2544"><a href="#-2544"><span class="linenos">2544</span></a>    <span class="k">def</span> <span class="nf">SellStop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lots</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">targetPrice</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">limitPrice</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">stopType</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Limit&quot;</span><span class="p">,</span> <span class="n">expDate</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Undefined&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2545"><a href="#-2545"><span class="linenos">2545</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-2546"><a href="#-2546"><span class="linenos">2546</span></a><span class="sd">        Create `Sell` stop-order. You must specify at least 2 parameters: `lots` `target price` to open sell stop-order.</span>
</span><span id="TinkoffBrokerServer-2547"><a href="#-2547"><span class="linenos">2547</span></a><span class="sd">        In additional you can specify 3 parameters for sell stop-order: `limit price` &gt;=0, `stop type` = Limit|SL|TP,</span>
</span><span id="TinkoffBrokerServer-2548"><a href="#-2548"><span class="linenos">2548</span></a><span class="sd">        `expiration date` = Undefined|`%%Y-%%m-%%d %%H:%%M:%%S`. When current price will go up or down to</span>
</span><span id="TinkoffBrokerServer-2549"><a href="#-2549"><span class="linenos">2549</span></a><span class="sd">        target price value then broker opens a limit order. See also: `Order()` docstring.</span>
</span><span id="TinkoffBrokerServer-2550"><a href="#-2550"><span class="linenos">2550</span></a>
</span><span id="TinkoffBrokerServer-2551"><a href="#-2551"><span class="linenos">2551</span></a><span class="sd">        :param lots: volume, integer count of lots &gt;= 1.</span>
</span><span id="TinkoffBrokerServer-2552"><a href="#-2552"><span class="linenos">2552</span></a><span class="sd">        :param targetPrice: target price &gt; 0. This is trigger price for sell stop-order.</span>
</span><span id="TinkoffBrokerServer-2553"><a href="#-2553"><span class="linenos">2553</span></a><span class="sd">        :param limitPrice: limit price &gt;= 0 (limitPrice = targetPrice if limitPrice is 0). Broker will creates limit-order</span>
</span><span id="TinkoffBrokerServer-2554"><a href="#-2554"><span class="linenos">2554</span></a><span class="sd">                           with price equal to limitPrice, when current price goes to target price of sell stop-order.</span>
</span><span id="TinkoffBrokerServer-2555"><a href="#-2555"><span class="linenos">2555</span></a><span class="sd">        :param stopType: string &quot;Limit&quot; by default. There are 3 stop-order types &quot;SL&quot;, &quot;TP&quot;, &quot;Limit&quot;</span>
</span><span id="TinkoffBrokerServer-2556"><a href="#-2556"><span class="linenos">2556</span></a><span class="sd">                         for &quot;Stop loss&quot;, &quot;Take profit&quot; and &quot;Stop limit&quot; types accordingly.</span>
</span><span id="TinkoffBrokerServer-2557"><a href="#-2557"><span class="linenos">2557</span></a><span class="sd">        :param expDate: string &quot;Undefined&quot; by default or local date in future.</span>
</span><span id="TinkoffBrokerServer-2558"><a href="#-2558"><span class="linenos">2558</span></a><span class="sd">                        String has a format like this: `%Y-%m-%d %H:%M:%S`.</span>
</span><span id="TinkoffBrokerServer-2559"><a href="#-2559"><span class="linenos">2559</span></a><span class="sd">                        This date is converting to UTC format for server.</span>
</span><span id="TinkoffBrokerServer-2560"><a href="#-2560"><span class="linenos">2560</span></a><span class="sd">        :return: JSON with response from broker server.</span>
</span><span id="TinkoffBrokerServer-2561"><a href="#-2561"><span class="linenos">2561</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-2562"><a href="#-2562"><span class="linenos">2562</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Order</span><span class="p">(</span><span class="n">operation</span><span class="o">=</span><span class="s2">&quot;Sell&quot;</span><span class="p">,</span> <span class="n">orderType</span><span class="o">=</span><span class="s2">&quot;Stop&quot;</span><span class="p">,</span> <span class="n">lots</span><span class="o">=</span><span class="n">lots</span><span class="p">,</span> <span class="n">targetPrice</span><span class="o">=</span><span class="n">targetPrice</span><span class="p">,</span> <span class="n">limitPrice</span><span class="o">=</span><span class="n">limitPrice</span><span class="p">,</span> <span class="n">stopType</span><span class="o">=</span><span class="n">stopType</span><span class="p">,</span> <span class="n">expDate</span><span class="o">=</span><span class="n">expDate</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-2563"><a href="#-2563"><span class="linenos">2563</span></a>
</span><span id="TinkoffBrokerServer-2564"><a href="#-2564"><span class="linenos">2564</span></a>    <span class="k">def</span> <span class="nf">CloseOrders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orderIDs</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">allOrdersIDs</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">allStopOrdersIDs</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2565"><a href="#-2565"><span class="linenos">2565</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-2566"><a href="#-2566"><span class="linenos">2566</span></a><span class="sd">        Cancel order or list of orders by its `orderId` or `stopOrderId`.</span>
</span><span id="TinkoffBrokerServer-2567"><a href="#-2567"><span class="linenos">2567</span></a>
</span><span id="TinkoffBrokerServer-2568"><a href="#-2568"><span class="linenos">2568</span></a><span class="sd">        :param orderIDs: list of integers with `orderId` or `stopOrderId`.</span>
</span><span id="TinkoffBrokerServer-2569"><a href="#-2569"><span class="linenos">2569</span></a><span class="sd">        :param allOrdersIDs: pre-received lists of all active pending orders.</span>
</span><span id="TinkoffBrokerServer-2570"><a href="#-2570"><span class="linenos">2570</span></a><span class="sd">                             This avoids unnecessary downloading data from the server.</span>
</span><span id="TinkoffBrokerServer-2571"><a href="#-2571"><span class="linenos">2571</span></a><span class="sd">        :param allStopOrdersIDs: pre-received lists of all active stop orders.</span>
</span><span id="TinkoffBrokerServer-2572"><a href="#-2572"><span class="linenos">2572</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-2573"><a href="#-2573"><span class="linenos">2573</span></a>        <span class="k">if</span> <span class="n">orderIDs</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2574"><a href="#-2574"><span class="linenos">2574</span></a>            <span class="k">if</span> <span class="n">allOrdersIDs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">allOrdersIDs</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2575"><a href="#-2575"><span class="linenos">2575</span></a>                <span class="n">rawOrders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RequestPendingOrders</span><span class="p">()</span>
</span><span id="TinkoffBrokerServer-2576"><a href="#-2576"><span class="linenos">2576</span></a>                <span class="n">allOrdersIDs</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;orderId&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">rawOrders</span><span class="p">]</span>  <span class="c1"># all pending orders ID</span>
</span><span id="TinkoffBrokerServer-2577"><a href="#-2577"><span class="linenos">2577</span></a>
</span><span id="TinkoffBrokerServer-2578"><a href="#-2578"><span class="linenos">2578</span></a>            <span class="k">if</span> <span class="n">allStopOrdersIDs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">allStopOrdersIDs</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2579"><a href="#-2579"><span class="linenos">2579</span></a>                <span class="n">rawStopOrders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RequestStopOrders</span><span class="p">()</span>
</span><span id="TinkoffBrokerServer-2580"><a href="#-2580"><span class="linenos">2580</span></a>                <span class="n">allStopOrdersIDs</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;stopOrderId&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">rawStopOrders</span><span class="p">]</span>  <span class="c1"># all stop orders ID</span>
</span><span id="TinkoffBrokerServer-2581"><a href="#-2581"><span class="linenos">2581</span></a>
</span><span id="TinkoffBrokerServer-2582"><a href="#-2582"><span class="linenos">2582</span></a>            <span class="k">for</span> <span class="n">orderID</span> <span class="ow">in</span> <span class="n">orderIDs</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2583"><a href="#-2583"><span class="linenos">2583</span></a>                <span class="n">idInPendingOrders</span> <span class="o">=</span> <span class="n">orderID</span> <span class="ow">in</span> <span class="n">allOrdersIDs</span>
</span><span id="TinkoffBrokerServer-2584"><a href="#-2584"><span class="linenos">2584</span></a>                <span class="n">idInStopOrders</span> <span class="o">=</span> <span class="n">orderID</span> <span class="ow">in</span> <span class="n">allStopOrdersIDs</span>
</span><span id="TinkoffBrokerServer-2585"><a href="#-2585"><span class="linenos">2585</span></a>
</span><span id="TinkoffBrokerServer-2586"><a href="#-2586"><span class="linenos">2586</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">idInPendingOrders</span> <span class="ow">or</span> <span class="n">idInStopOrders</span><span class="p">):</span>
</span><span id="TinkoffBrokerServer-2587"><a href="#-2587"><span class="linenos">2587</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Order not found by ID: [</span><span class="si">{}</span><span class="s2">]. Maybe cancelled already? Check it with `--overview` key.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">orderID</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-2588"><a href="#-2588"><span class="linenos">2588</span></a>                    <span class="k">continue</span>
</span><span id="TinkoffBrokerServer-2589"><a href="#-2589"><span class="linenos">2589</span></a>
</span><span id="TinkoffBrokerServer-2590"><a href="#-2590"><span class="linenos">2590</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2591"><a href="#-2591"><span class="linenos">2591</span></a>                    <span class="k">if</span> <span class="n">idInPendingOrders</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2592"><a href="#-2592"><span class="linenos">2592</span></a>                        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Cancelling pending order with ID: [</span><span class="si">{}</span><span class="s2">]. Wait, please...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">orderID</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-2593"><a href="#-2593"><span class="linenos">2593</span></a>
</span><span id="TinkoffBrokerServer-2594"><a href="#-2594"><span class="linenos">2594</span></a>                        <span class="c1"># REST API for request: https://tinkoff.github.io/investAPI/swagger-ui/#/OrdersService/OrdersService_CancelOrder</span>
</span><span id="TinkoffBrokerServer-2595"><a href="#-2595"><span class="linenos">2595</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="nb">str</span><span class="p">({</span><span class="s2">&quot;accountId&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">accountId</span><span class="p">,</span> <span class="s2">&quot;orderId&quot;</span><span class="p">:</span> <span class="n">orderID</span><span class="p">})</span>
</span><span id="TinkoffBrokerServer-2596"><a href="#-2596"><span class="linenos">2596</span></a>                        <span class="n">closeURL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;/tinkoff.public.invest.api.contract.v1.OrdersService/CancelOrder&quot;</span>
</span><span id="TinkoffBrokerServer-2597"><a href="#-2597"><span class="linenos">2597</span></a>                        <span class="n">responseJSON</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SendAPIRequest</span><span class="p">(</span><span class="n">closeURL</span><span class="p">,</span> <span class="n">reqType</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-2598"><a href="#-2598"><span class="linenos">2598</span></a>
</span><span id="TinkoffBrokerServer-2599"><a href="#-2599"><span class="linenos">2599</span></a>                        <span class="k">if</span> <span class="n">responseJSON</span> <span class="ow">and</span> <span class="s2">&quot;time&quot;</span> <span class="ow">in</span> <span class="n">responseJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">responseJSON</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-2600"><a href="#-2600"><span class="linenos">2600</span></a>                            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Success time marker received from server: [</span><span class="si">{}</span><span class="s2">] (UTC)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">responseJSON</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]))</span>
</span><span id="TinkoffBrokerServer-2601"><a href="#-2601"><span class="linenos">2601</span></a>                            <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Pending order with ID [</span><span class="si">{}</span><span class="s2">] successfully cancel&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">orderID</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-2602"><a href="#-2602"><span class="linenos">2602</span></a>
</span><span id="TinkoffBrokerServer-2603"><a href="#-2603"><span class="linenos">2603</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2604"><a href="#-2604"><span class="linenos">2604</span></a>                            <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unknown issue occurred when cancelling pending order with ID: [</span><span class="si">{}</span><span class="s2">]. Check ID and try again.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">orderID</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-2605"><a href="#-2605"><span class="linenos">2605</span></a>
</span><span id="TinkoffBrokerServer-2606"><a href="#-2606"><span class="linenos">2606</span></a>                    <span class="k">elif</span> <span class="n">idInStopOrders</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2607"><a href="#-2607"><span class="linenos">2607</span></a>                        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Cancelling stop order with ID: [</span><span class="si">{}</span><span class="s2">]. Wait, please...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">orderID</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-2608"><a href="#-2608"><span class="linenos">2608</span></a>
</span><span id="TinkoffBrokerServer-2609"><a href="#-2609"><span class="linenos">2609</span></a>                        <span class="c1"># REST API for request: https://tinkoff.github.io/investAPI/swagger-ui/#/StopOrdersService/StopOrdersService_CancelStopOrder</span>
</span><span id="TinkoffBrokerServer-2610"><a href="#-2610"><span class="linenos">2610</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="nb">str</span><span class="p">({</span><span class="s2">&quot;accountId&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">accountId</span><span class="p">,</span> <span class="s2">&quot;stopOrderId&quot;</span><span class="p">:</span> <span class="n">orderID</span><span class="p">})</span>
</span><span id="TinkoffBrokerServer-2611"><a href="#-2611"><span class="linenos">2611</span></a>                        <span class="n">closeURL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;/tinkoff.public.invest.api.contract.v1.StopOrdersService/CancelStopOrder&quot;</span>
</span><span id="TinkoffBrokerServer-2612"><a href="#-2612"><span class="linenos">2612</span></a>                        <span class="n">responseJSON</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SendAPIRequest</span><span class="p">(</span><span class="n">closeURL</span><span class="p">,</span> <span class="n">reqType</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-2613"><a href="#-2613"><span class="linenos">2613</span></a>
</span><span id="TinkoffBrokerServer-2614"><a href="#-2614"><span class="linenos">2614</span></a>                        <span class="k">if</span> <span class="n">responseJSON</span> <span class="ow">and</span> <span class="s2">&quot;time&quot;</span> <span class="ow">in</span> <span class="n">responseJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">responseJSON</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer-2615"><a href="#-2615"><span class="linenos">2615</span></a>                            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Success time marker received from server: [</span><span class="si">{}</span><span class="s2">] (UTC)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">responseJSON</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]))</span>
</span><span id="TinkoffBrokerServer-2616"><a href="#-2616"><span class="linenos">2616</span></a>                            <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Stop order with ID [</span><span class="si">{}</span><span class="s2">] successfully cancel&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">orderID</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-2617"><a href="#-2617"><span class="linenos">2617</span></a>
</span><span id="TinkoffBrokerServer-2618"><a href="#-2618"><span class="linenos">2618</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2619"><a href="#-2619"><span class="linenos">2619</span></a>                            <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unknown issue occurred when cancelling stop order with ID: [</span><span class="si">{}</span><span class="s2">]. Check ID and try again.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">orderID</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-2620"><a href="#-2620"><span class="linenos">2620</span></a>
</span><span id="TinkoffBrokerServer-2621"><a href="#-2621"><span class="linenos">2621</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2622"><a href="#-2622"><span class="linenos">2622</span></a>                        <span class="k">continue</span>
</span><span id="TinkoffBrokerServer-2623"><a href="#-2623"><span class="linenos">2623</span></a>
</span><span id="TinkoffBrokerServer-2624"><a href="#-2624"><span class="linenos">2624</span></a>    <span class="k">def</span> <span class="nf">CloseAllOrders</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2625"><a href="#-2625"><span class="linenos">2625</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-2626"><a href="#-2626"><span class="linenos">2626</span></a><span class="sd">        Gets a list of open pending and stop orders and cancel it all.</span>
</span><span id="TinkoffBrokerServer-2627"><a href="#-2627"><span class="linenos">2627</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-2628"><a href="#-2628"><span class="linenos">2628</span></a>        <span class="n">rawOrders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RequestPendingOrders</span><span class="p">()</span>
</span><span id="TinkoffBrokerServer-2629"><a href="#-2629"><span class="linenos">2629</span></a>        <span class="n">allOrdersIDs</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;orderId&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">rawOrders</span><span class="p">]</span>  <span class="c1"># all pending orders ID</span>
</span><span id="TinkoffBrokerServer-2630"><a href="#-2630"><span class="linenos">2630</span></a>        <span class="n">lenOrders</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">allOrdersIDs</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-2631"><a href="#-2631"><span class="linenos">2631</span></a>
</span><span id="TinkoffBrokerServer-2632"><a href="#-2632"><span class="linenos">2632</span></a>        <span class="n">rawStopOrders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RequestStopOrders</span><span class="p">()</span>
</span><span id="TinkoffBrokerServer-2633"><a href="#-2633"><span class="linenos">2633</span></a>        <span class="n">allStopOrdersIDs</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;stopOrderId&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">rawStopOrders</span><span class="p">]</span>  <span class="c1"># all stop orders ID</span>
</span><span id="TinkoffBrokerServer-2634"><a href="#-2634"><span class="linenos">2634</span></a>        <span class="n">lenSOrders</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">allStopOrdersIDs</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-2635"><a href="#-2635"><span class="linenos">2635</span></a>
</span><span id="TinkoffBrokerServer-2636"><a href="#-2636"><span class="linenos">2636</span></a>        <span class="k">if</span> <span class="n">lenOrders</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">lenSOrders</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2637"><a href="#-2637"><span class="linenos">2637</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Found: [</span><span class="si">{}</span><span class="s2">] opened pending and [</span><span class="si">{}</span><span class="s2">] stop orders. Let&#39;s trying to cancel it all. Wait, please...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lenOrders</span><span class="p">,</span> <span class="n">lenSOrders</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer-2638"><a href="#-2638"><span class="linenos">2638</span></a>
</span><span id="TinkoffBrokerServer-2639"><a href="#-2639"><span class="linenos">2639</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">CloseOrders</span><span class="p">(</span><span class="n">allOrdersIDs</span> <span class="o">+</span> <span class="n">allStopOrdersIDs</span><span class="p">,</span> <span class="n">allOrdersIDs</span><span class="p">,</span> <span class="n">allStopOrdersIDs</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-2640"><a href="#-2640"><span class="linenos">2640</span></a>
</span><span id="TinkoffBrokerServer-2641"><a href="#-2641"><span class="linenos">2641</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2642"><a href="#-2642"><span class="linenos">2642</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Orders not found, nothing to cancel.&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-2643"><a href="#-2643"><span class="linenos">2643</span></a>
</span><span id="TinkoffBrokerServer-2644"><a href="#-2644"><span class="linenos">2644</span></a>    <span class="k">def</span> <span class="nf">CloseAll</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2645"><a href="#-2645"><span class="linenos">2645</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-2646"><a href="#-2646"><span class="linenos">2646</span></a><span class="sd">        Close all available (not blocked) opened trades and orders.</span>
</span><span id="TinkoffBrokerServer-2647"><a href="#-2647"><span class="linenos">2647</span></a>
</span><span id="TinkoffBrokerServer-2648"><a href="#-2648"><span class="linenos">2648</span></a><span class="sd">        Also you can select one or more keywords case insensitive:</span>
</span><span id="TinkoffBrokerServer-2649"><a href="#-2649"><span class="linenos">2649</span></a><span class="sd">        `orders`, `shares`, `bonds`, `etfs` and `futures` from `TKS_INSTRUMENTS` enum to specify trades type.</span>
</span><span id="TinkoffBrokerServer-2650"><a href="#-2650"><span class="linenos">2650</span></a>
</span><span id="TinkoffBrokerServer-2651"><a href="#-2651"><span class="linenos">2651</span></a><span class="sd">        Currency positions you must closes manually using buy or sell operations, `CloseTrades()` or `CloseAllTrades()` methods.</span>
</span><span id="TinkoffBrokerServer-2652"><a href="#-2652"><span class="linenos">2652</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-2653"><a href="#-2653"><span class="linenos">2653</span></a>        <span class="n">overview</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Overview</span><span class="p">(</span><span class="n">showStatistics</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># get all open trades info</span>
</span><span id="TinkoffBrokerServer-2654"><a href="#-2654"><span class="linenos">2654</span></a>
</span><span id="TinkoffBrokerServer-2655"><a href="#-2655"><span class="linenos">2655</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2656"><a href="#-2656"><span class="linenos">2656</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Closing all available (not blocked) opened trades and orders. Currency positions you must closes manually using buy or sell operations! Wait, please...&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer-2657"><a href="#-2657"><span class="linenos">2657</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">CloseAllOrders</span><span class="p">()</span>  <span class="c1"># close all pending and stop orders</span>
</span><span id="TinkoffBrokerServer-2658"><a href="#-2658"><span class="linenos">2658</span></a>
</span><span id="TinkoffBrokerServer-2659"><a href="#-2659"><span class="linenos">2659</span></a>            <span class="k">for</span> <span class="n">iType</span> <span class="ow">in</span> <span class="n">TKS_INSTRUMENTS</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2660"><a href="#-2660"><span class="linenos">2660</span></a>                <span class="k">if</span> <span class="n">iType</span> <span class="o">!=</span> <span class="s2">&quot;Currencies&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2661"><a href="#-2661"><span class="linenos">2661</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">CloseAllTrades</span><span class="p">(</span><span class="n">iType</span><span class="p">,</span> <span class="n">overview</span><span class="p">)</span>  <span class="c1"># close all positions of instruments with same type without currencies</span>
</span><span id="TinkoffBrokerServer-2662"><a href="#-2662"><span class="linenos">2662</span></a>
</span><span id="TinkoffBrokerServer-2663"><a href="#-2663"><span class="linenos">2663</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2664"><a href="#-2664"><span class="linenos">2664</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Closing all available </span><span class="si">{}</span><span class="s2">. Currency positions you must closes manually using buy or sell operations! Wait, please...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)))</span>
</span><span id="TinkoffBrokerServer-2665"><a href="#-2665"><span class="linenos">2665</span></a>            <span class="n">lowerArgs</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer-2666"><a href="#-2666"><span class="linenos">2666</span></a>
</span><span id="TinkoffBrokerServer-2667"><a href="#-2667"><span class="linenos">2667</span></a>            <span class="k">if</span> <span class="s2">&quot;orders&quot;</span> <span class="ow">in</span> <span class="n">lowerArgs</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2668"><a href="#-2668"><span class="linenos">2668</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">CloseAllOrders</span><span class="p">()</span>  <span class="c1"># close all pending and stop orders</span>
</span><span id="TinkoffBrokerServer-2669"><a href="#-2669"><span class="linenos">2669</span></a>
</span><span id="TinkoffBrokerServer-2670"><a href="#-2670"><span class="linenos">2670</span></a>            <span class="k">for</span> <span class="n">iType</span> <span class="ow">in</span> <span class="n">TKS_INSTRUMENTS</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2671"><a href="#-2671"><span class="linenos">2671</span></a>                <span class="k">if</span> <span class="n">iType</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">lowerArgs</span> <span class="ow">and</span> <span class="n">iType</span> <span class="o">!=</span> <span class="s2">&quot;Currencies&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer-2672"><a href="#-2672"><span class="linenos">2672</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">CloseAllTrades</span><span class="p">(</span><span class="n">iType</span><span class="p">,</span> <span class="n">overview</span><span class="p">)</span>  <span class="c1"># close all positions of instruments with same type without currencies</span>
</span><span id="TinkoffBrokerServer-2673"><a href="#-2673"><span class="linenos">2673</span></a>
</span><span id="TinkoffBrokerServer-2674"><a href="#-2674"><span class="linenos">2674</span></a>    <span class="nd">@staticmethod</span>
</span><span id="TinkoffBrokerServer-2675"><a href="#-2675"><span class="linenos">2675</span></a>    <span class="k">def</span> <span class="nf">ParseOrderParameters</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="o">**</span><span class="n">inputParameters</span><span class="p">):</span>
</span><span id="TinkoffBrokerServer-2676"><a href="#-2676"><span class="linenos">2676</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-2677"><a href="#-2677"><span class="linenos">2677</span></a><span class="sd">        Parse input dictionary of strings with order parameters and return dictionary with parameters to open all orders.</span>
</span><span id="TinkoffBrokerServer-2678"><a href="#-2678"><span class="linenos">2678</span></a>
</span><span id="TinkoffBrokerServer-2679"><a href="#-2679"><span class="linenos">2679</span></a><span class="sd">        :param operation: string &quot;Buy&quot; or &quot;Sell&quot;.</span>
</span><span id="TinkoffBrokerServer-2680"><a href="#-2680"><span class="linenos">2680</span></a><span class="sd">        :param inputParameters: this is dict of strings that looks like this</span>
</span><span id="TinkoffBrokerServer-2681"><a href="#-2681"><span class="linenos">2681</span></a><span class="sd">               `{&quot;lots&quot;: &quot;L_int,...&quot;, &quot;prices&quot;: &quot;P_float,...&quot;}` where</span>
</span><span id="TinkoffBrokerServer-2682"><a href="#-2682"><span class="linenos">2682</span></a><span class="sd">               &quot;lots&quot; key: one or more lot values (integer numbers) to open with every limit-order</span>
</span><span id="TinkoffBrokerServer-2683"><a href="#-2683"><span class="linenos">2683</span></a><span class="sd">               &quot;prices&quot; key: one or more prices to open limit-orders</span>
</span><span id="TinkoffBrokerServer-2684"><a href="#-2684"><span class="linenos">2684</span></a><span class="sd">               Counts of values in lots and prices lists must be equals!</span>
</span><span id="TinkoffBrokerServer-2685"><a href="#-2685"><span class="linenos">2685</span></a><span class="sd">        :return: list of dictionaries with all lots and prices to open orders that looks like this `[{&quot;lot&quot;: lots_1, &quot;price&quot;: price_1}, {...}, ...]`</span>
</span><span id="TinkoffBrokerServer-2686"><a href="#-2686"><span class="linenos">2686</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer-2687"><a href="#-2687"><span class="linenos">2687</span></a>        <span class="c1"># TODO: update order grid work with api v2</span>
</span><span id="TinkoffBrokerServer-2688"><a href="#-2688"><span class="linenos">2688</span></a>        <span class="k">pass</span>
</span></pre></div>


            <div class="docstring"><p>This class implements methods to work with Tinkoff broker server.</p>

<p>Examples to work with API: <a href="https://tinkoff.github.io/investAPI/swagger-ui/">https://tinkoff.github.io/investAPI/swagger-ui/</a></p>

<p>Where is <code>token</code>: <a href="https://tinkoff.github.io/investAPI/token/">https://tinkoff.github.io/investAPI/token/</a></p>
</div>


                            <div id="TinkoffBrokerServer.__init__" class="classattr">
                                        <input id="TinkoffBrokerServer.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">TinkoffBrokerServer</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">token</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">iList</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span>, </span><span class="param"><span class="n">accountId</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="TinkoffBrokerServer.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TinkoffBrokerServer.__init__-187"><a href="#-187"><span class="linenos">187</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">iList</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">accountId</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.__init__-188"><a href="#-188"><span class="linenos">188</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.__init__-189"><a href="#-189"><span class="linenos">189</span></a><span class="sd">        Main class init.</span>
</span><span id="TinkoffBrokerServer.__init__-190"><a href="#-190"><span class="linenos">190</span></a>
</span><span id="TinkoffBrokerServer.__init__-191"><a href="#-191"><span class="linenos">191</span></a><span class="sd">        :param token: Bearer token for Tinkoff Invest API. It can be set from environment variable `TKS_API_TOKEN`.</span>
</span><span id="TinkoffBrokerServer.__init__-192"><a href="#-192"><span class="linenos">192</span></a><span class="sd">        :param iList: dictionary of dictionaries with instrument&#39;s data.</span>
</span><span id="TinkoffBrokerServer.__init__-193"><a href="#-193"><span class="linenos">193</span></a><span class="sd">        :param accountId: string with user&#39;s numeric account ID in Tinkoff Broker. It can be found in broker&#39;s reports.</span>
</span><span id="TinkoffBrokerServer.__init__-194"><a href="#-194"><span class="linenos">194</span></a><span class="sd">                          Also, this variable can be set from environment variable `TKS_ACCOUNT_ID`.</span>
</span><span id="TinkoffBrokerServer.__init__-195"><a href="#-195"><span class="linenos">195</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.__init__-196"><a href="#-196"><span class="linenos">196</span></a>        <span class="k">if</span> <span class="n">token</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.__init__-197"><a href="#-197"><span class="linenos">197</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.__init__-198"><a href="#-198"><span class="linenos">198</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;TKS_API_TOKEN&quot;</span><span class="p">])</span>
</span><span id="TinkoffBrokerServer.__init__-199"><a href="#-199"><span class="linenos">199</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Bearer token for Tinkoff OpenApi set up from environment variable `TKS_API_TOKEN`. See https://tinkoff.github.io/investAPI/token/&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.__init__-200"><a href="#-200"><span class="linenos">200</span></a>
</span><span id="TinkoffBrokerServer.__init__-201"><a href="#-201"><span class="linenos">201</span></a>            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.__init__-202"><a href="#-202"><span class="linenos">202</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;`--token` key or environment variable `TKS_API_TOKEN` is required! See https://tinkoff.github.io/investAPI/token/&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.__init__-203"><a href="#-203"><span class="linenos">203</span></a>
</span><span id="TinkoffBrokerServer.__init__-204"><a href="#-204"><span class="linenos">204</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.__init__-205"><a href="#-205"><span class="linenos">205</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">token</span>  <span class="c1"># highly priority than environment variable &#39;TKS_API_TOKEN&#39;</span>
</span><span id="TinkoffBrokerServer.__init__-206"><a href="#-206"><span class="linenos">206</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Bearer token for Tinkoff OpenApi set up from class variable `token`&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.__init__-207"><a href="#-207"><span class="linenos">207</span></a>
</span><span id="TinkoffBrokerServer.__init__-208"><a href="#-208"><span class="linenos">208</span></a>        <span class="k">if</span> <span class="n">accountId</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">accountId</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.__init__-209"><a href="#-209"><span class="linenos">209</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.__init__-210"><a href="#-210"><span class="linenos">210</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">accountId</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;TKS_ACCOUNT_ID&quot;</span><span class="p">])</span>
</span><span id="TinkoffBrokerServer.__init__-211"><a href="#-211"><span class="linenos">211</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;String with user&#39;s numeric account ID in Tinkoff Broker set up from environment variable `TKS_ACCOUNT_ID`&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.__init__-212"><a href="#-212"><span class="linenos">212</span></a>
</span><span id="TinkoffBrokerServer.__init__-213"><a href="#-213"><span class="linenos">213</span></a>            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.__init__-214"><a href="#-214"><span class="linenos">214</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;`--account-id` key or environment variable `TKS_ACCOUNT_ID` undefined! Some of operations may be unavailable (overview, trading etc).&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.__init__-215"><a href="#-215"><span class="linenos">215</span></a>
</span><span id="TinkoffBrokerServer.__init__-216"><a href="#-216"><span class="linenos">216</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.__init__-217"><a href="#-217"><span class="linenos">217</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">accountId</span> <span class="o">=</span> <span class="n">accountId</span>  <span class="c1"># highly priority than environment variable &#39;TKS_ACCOUNT_ID&#39;</span>
</span><span id="TinkoffBrokerServer.__init__-218"><a href="#-218"><span class="linenos">218</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;String with user&#39;s numeric account ID in Tinkoff Broker set up from class variable `accountId`&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.__init__-219"><a href="#-219"><span class="linenos">219</span></a>
</span><span id="TinkoffBrokerServer.__init__-220"><a href="#-220"><span class="linenos">220</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">aliases</span> <span class="o">=</span> <span class="n">TKS_TICKER_ALIASES</span>
</span><span id="TinkoffBrokerServer.__init__-221"><a href="#-221"><span class="linenos">221</span></a>        <span class="sd">&quot;&quot;&quot;Some aliases instead official tickers. See `TKSEnums.TKS_TICKER_ALIASES`&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.__init__-222"><a href="#-222"><span class="linenos">222</span></a>
</span><span id="TinkoffBrokerServer.__init__-223"><a href="#-223"><span class="linenos">223</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">aliasesKeys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aliases</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>  <span class="c1"># re-calc only first time at class init</span>
</span><span id="TinkoffBrokerServer.__init__-224"><a href="#-224"><span class="linenos">224</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">exclude</span> <span class="o">=</span> <span class="n">TKS_TICKERS_OR_FIGI_EXCLUDED</span>  <span class="c1"># some of tickets or FIGIs raised exception earlier when it sends to server, that is why we exclude there</span>
</span><span id="TinkoffBrokerServer.__init__-225"><a href="#-225"><span class="linenos">225</span></a>
</span><span id="TinkoffBrokerServer.__init__-226"><a href="#-226"><span class="linenos">226</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.__init__-227"><a href="#-227"><span class="linenos">227</span></a>        <span class="sd">&quot;&quot;&quot;String with ticker, e.g. `GOOGL`. Use alias for `USD000UTSTOM` simple as `USD`, `EUR_RUB__TOM` as `EUR` etc. More tickers aliases here: `TKSEnums.TKS_TICKER_ALIASES`.&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.__init__-228"><a href="#-228"><span class="linenos">228</span></a>
</span><span id="TinkoffBrokerServer.__init__-229"><a href="#-229"><span class="linenos">229</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.__init__-230"><a href="#-230"><span class="linenos">230</span></a>        <span class="sd">&quot;&quot;&quot;String with FIGI, e.g. ticker `GOOGL` has FIGI `BBG009S39JX6`&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.__init__-231"><a href="#-231"><span class="linenos">231</span></a>
</span><span id="TinkoffBrokerServer.__init__-232"><a href="#-232"><span class="linenos">232</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="TinkoffBrokerServer.__init__-233"><a href="#-233"><span class="linenos">233</span></a>        <span class="sd">&quot;&quot;&quot;Depth of Market (DOM) can be &gt;= 1. Default: 1. It used with `--price` key to showing DOM with current prices for givens ticker or FIGI.&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.__init__-234"><a href="#-234"><span class="linenos">234</span></a>
</span><span id="TinkoffBrokerServer.__init__-235"><a href="#-235"><span class="linenos">235</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;https://invest-public-api.tinkoff.ru/rest&quot;</span>
</span><span id="TinkoffBrokerServer.__init__-236"><a href="#-236"><span class="linenos">236</span></a>        <span class="sd">&quot;&quot;&quot;Tinkoff REST API server for real trade operations. Default: https://invest-public-api.tinkoff.ru/rest</span>
</span><span id="TinkoffBrokerServer.__init__-237"><a href="#-237"><span class="linenos">237</span></a>
</span><span id="TinkoffBrokerServer.__init__-238"><a href="#-238"><span class="linenos">238</span></a><span class="sd">        See: https://tinkoff.github.io/investAPI/#tinkoff-invest-api_1</span>
</span><span id="TinkoffBrokerServer.__init__-239"><a href="#-239"><span class="linenos">239</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.__init__-240"><a href="#-240"><span class="linenos">240</span></a>
</span><span id="TinkoffBrokerServer.__init__-241"><a href="#-241"><span class="linenos">241</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Broker API server: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.__init__-242"><a href="#-242"><span class="linenos">242</span></a>
</span><span id="TinkoffBrokerServer.__init__-243"><a href="#-243"><span class="linenos">243</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">15</span>
</span><span id="TinkoffBrokerServer.__init__-244"><a href="#-244"><span class="linenos">244</span></a>        <span class="sd">&quot;&quot;&quot;Server operations timeout in seconds. Default: 15&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.__init__-245"><a href="#-245"><span class="linenos">245</span></a>
</span><span id="TinkoffBrokerServer.__init__-246"><a href="#-246"><span class="linenos">246</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span> <span class="s2">&quot;accept&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span> <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="s2">&quot;Bearer </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">)}</span>
</span><span id="TinkoffBrokerServer.__init__-247"><a href="#-247"><span class="linenos">247</span></a>        <span class="sd">&quot;&quot;&quot;Headers which send in every request to broker server. Default: `{&quot;Content-Type&quot;: &quot;application/json&quot;, &quot;accept&quot;: &quot;application/json&quot;, &quot;Authorization&quot;: &quot;Bearer {token}&quot;}`&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.__init__-248"><a href="#-248"><span class="linenos">248</span></a>
</span><span id="TinkoffBrokerServer.__init__-249"><a href="#-249"><span class="linenos">249</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="TinkoffBrokerServer.__init__-250"><a href="#-250"><span class="linenos">250</span></a>        <span class="sd">&quot;&quot;&quot;Request body which send to broker server. Default: `None`&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.__init__-251"><a href="#-251"><span class="linenos">251</span></a>
</span><span id="TinkoffBrokerServer.__init__-252"><a href="#-252"><span class="linenos">252</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">historyLength</span> <span class="o">=</span> <span class="mi">24</span>
</span><span id="TinkoffBrokerServer.__init__-253"><a href="#-253"><span class="linenos">253</span></a>        <span class="sd">&quot;&quot;&quot;How many candles returns if candles history request. For example, if `historyInterval=&quot;hour&quot;` and `historyLength=24` it means: &quot;give me last 24 hours&quot;. Must be &gt;=1. Default: 24&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.__init__-254"><a href="#-254"><span class="linenos">254</span></a>
</span><span id="TinkoffBrokerServer.__init__-255"><a href="#-255"><span class="linenos">255</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">historyInterval</span> <span class="o">=</span> <span class="s2">&quot;hour&quot;</span>
</span><span id="TinkoffBrokerServer.__init__-256"><a href="#-256"><span class="linenos">256</span></a>        <span class="sd">&quot;&quot;&quot;Interval string for Tinkoff API (see: `TKSEnums.TKS_TIMEFRAMES`). Available values are `&quot;1min&quot;`, `&quot;2min&quot;`, `&quot;3min&quot;`, `&quot;5min&quot;`, `&quot;10min&quot;`, `&quot;15min&quot;`, `&quot;30min&quot;`, `&quot;hour&quot;`, `&quot;day&quot;`, `&quot;week&quot;`, `&quot;month&quot;`. Default: `&quot;hour&quot;`&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.__init__-257"><a href="#-257"><span class="linenos">257</span></a>
</span><span id="TinkoffBrokerServer.__init__-258"><a href="#-258"><span class="linenos">258</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">iList</span> <span class="o">=</span> <span class="n">iList</span> <span class="k">if</span> <span class="n">iList</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">Listing</span><span class="p">()</span>
</span><span id="TinkoffBrokerServer.__init__-259"><a href="#-259"><span class="linenos">259</span></a>        <span class="sd">&quot;&quot;&quot;Dictionary with raw data about stocks, currencies, bonds, etfs and futures from broker server.</span>
</span><span id="TinkoffBrokerServer.__init__-260"><a href="#-260"><span class="linenos">260</span></a><span class="sd">        At first time, when class init, `Listing()` method auto-update this variable.</span>
</span><span id="TinkoffBrokerServer.__init__-261"><a href="#-261"><span class="linenos">261</span></a><span class="sd">        For future use, you can save this variable and substitute it in the `iList` to avoid permanent downloads from the server.</span>
</span><span id="TinkoffBrokerServer.__init__-262"><a href="#-262"><span class="linenos">262</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.__init__-263"><a href="#-263"><span class="linenos">263</span></a>
</span><span id="TinkoffBrokerServer.__init__-264"><a href="#-264"><span class="linenos">264</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pricesList</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># You can request all current prices with `ShowAllPrices()` method. WARNING! This is too long operation!</span>
</span><span id="TinkoffBrokerServer.__init__-265"><a href="#-265"><span class="linenos">265</span></a>
</span><span id="TinkoffBrokerServer.__init__-266"><a href="#-266"><span class="linenos">266</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">instrumentsFile</span> <span class="o">=</span> <span class="s2">&quot;instruments.md&quot;</span>
</span><span id="TinkoffBrokerServer.__init__-267"><a href="#-267"><span class="linenos">267</span></a>        <span class="sd">&quot;&quot;&quot;Filename where full broker&#39;s instruments list will be saved. Default: `&quot;instruments.md&quot;`&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.__init__-268"><a href="#-268"><span class="linenos">268</span></a>
</span><span id="TinkoffBrokerServer.__init__-269"><a href="#-269"><span class="linenos">269</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pricesFile</span> <span class="o">=</span> <span class="s2">&quot;prices.md&quot;</span>
</span><span id="TinkoffBrokerServer.__init__-270"><a href="#-270"><span class="linenos">270</span></a>        <span class="sd">&quot;&quot;&quot;Filename where prices of selected instruments will be saved. Default: `&quot;prices.md&quot;`&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.__init__-271"><a href="#-271"><span class="linenos">271</span></a>
</span><span id="TinkoffBrokerServer.__init__-272"><a href="#-272"><span class="linenos">272</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">overviewFile</span> <span class="o">=</span> <span class="s2">&quot;overview.md&quot;</span>
</span><span id="TinkoffBrokerServer.__init__-273"><a href="#-273"><span class="linenos">273</span></a>        <span class="sd">&quot;&quot;&quot;Filename where current portfolio, open trades and orders will be saved. Default: `&quot;overview.md&quot;`&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.__init__-274"><a href="#-274"><span class="linenos">274</span></a>
</span><span id="TinkoffBrokerServer.__init__-275"><a href="#-275"><span class="linenos">275</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reportFile</span> <span class="o">=</span> <span class="s2">&quot;report.md&quot;</span>
</span><span id="TinkoffBrokerServer.__init__-276"><a href="#-276"><span class="linenos">276</span></a>        <span class="sd">&quot;&quot;&quot;Filename where history of deals and trade statistics will be saved. Default: `&quot;report.md&quot;`&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.__init__-277"><a href="#-277"><span class="linenos">277</span></a>
</span><span id="TinkoffBrokerServer.__init__-278"><a href="#-278"><span class="linenos">278</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">historyFile</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="TinkoffBrokerServer.__init__-279"><a href="#-279"><span class="linenos">279</span></a>        <span class="sd">&quot;&quot;&quot;Full path to .csv output file where history candles will be saved. Default: `None`, mean that returns only pandas dataframe.&quot;&quot;&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Main class init.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>token</strong>:  Bearer token for Tinkoff Invest API. It can be set from environment variable <code>TKS_API_TOKEN</code>.</li>
<li><strong>iList</strong>:  dictionary of dictionaries with instrument's data.</li>
<li><strong>accountId</strong>:  string with user's numeric account ID in Tinkoff Broker. It can be found in broker's reports.
              Also, this variable can be set from environment variable <code>TKS_ACCOUNT_ID</code>.</li>
</ul>
</div>


                            </div>
                            <div id="TinkoffBrokerServer.aliases" class="classattr">
                                <div class="attr variable">
            <span class="name">aliases</span>

        
    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.aliases"></a>
    
            <div class="docstring"><p>Some aliases instead official tickers. See <code>TKSEnums.TKS_TICKER_ALIASES</code></p>
</div>


                            </div>
                            <div id="TinkoffBrokerServer.ticker" class="classattr">
                                <div class="attr variable">
            <span class="name">ticker</span>

        
    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.ticker"></a>
    
            <div class="docstring"><p>String with ticker, e.g. <code>GOOGL</code>. Use alias for <code>USD000UTSTOM</code> simple as <code>USD</code>, <code>EUR_RUB__TOM</code> as <code>EUR</code> etc. More tickers aliases here: <code>TKSEnums.TKS_TICKER_ALIASES</code>.</p>
</div>


                            </div>
                            <div id="TinkoffBrokerServer.figi" class="classattr">
                                <div class="attr variable">
            <span class="name">figi</span>

        
    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.figi"></a>
    
            <div class="docstring"><p>String with FIGI, e.g. ticker <code>GOOGL</code> has FIGI <code>BBG009S39JX6</code></p>
</div>


                            </div>
                            <div id="TinkoffBrokerServer.depth" class="classattr">
                                <div class="attr variable">
            <span class="name">depth</span>

        
    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.depth"></a>
    
            <div class="docstring"><p>Depth of Market (DOM) can be &gt;= 1. Default: 1. It used with <code>--price</code> key to showing DOM with current prices for givens ticker or FIGI.</p>
</div>


                            </div>
                            <div id="TinkoffBrokerServer.server" class="classattr">
                                <div class="attr variable">
            <span class="name">server</span>

        
    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.server"></a>
    
            <div class="docstring"><p>Tinkoff REST API server for real trade operations. Default: <a href="https://invest-public-api.tinkoff.ru/rest">https://invest-public-api.tinkoff.ru/rest</a></p>

<p>See: <a href="https://tinkoff.github.io/investAPI/#tinkoff-invest-api_1">https://tinkoff.github.io/investAPI/#tinkoff-invest-api_1</a></p>
</div>


                            </div>
                            <div id="TinkoffBrokerServer.timeout" class="classattr">
                                <div class="attr variable">
            <span class="name">timeout</span>

        
    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.timeout"></a>
    
            <div class="docstring"><p>Server operations timeout in seconds. Default: 15</p>
</div>


                            </div>
                            <div id="TinkoffBrokerServer.headers" class="classattr">
                                <div class="attr variable">
            <span class="name">headers</span>

        
    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.headers"></a>
    
            <div class="docstring"><p>Headers which send in every request to broker server. Default: <code>{"Content-Type": "application/json", "accept": "application/json", "Authorization": "Bearer {token}"}</code></p>
</div>


                            </div>
                            <div id="TinkoffBrokerServer.body" class="classattr">
                                <div class="attr variable">
            <span class="name">body</span>

        
    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.body"></a>
    
            <div class="docstring"><p>Request body which send to broker server. Default: <code>None</code></p>
</div>


                            </div>
                            <div id="TinkoffBrokerServer.historyLength" class="classattr">
                                <div class="attr variable">
            <span class="name">historyLength</span>

        
    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.historyLength"></a>
    
            <div class="docstring"><p>How many candles returns if candles history request. For example, if <code>historyInterval="hour"</code> and <code>historyLength=24</code> it means: "give me last 24 hours". Must be &gt;=1. Default: 24</p>
</div>


                            </div>
                            <div id="TinkoffBrokerServer.historyInterval" class="classattr">
                                <div class="attr variable">
            <span class="name">historyInterval</span>

        
    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.historyInterval"></a>
    
            <div class="docstring"><p>Interval string for Tinkoff API (see: <code>TKSEnums.TKS_TIMEFRAMES</code>). Available values are <code>"1min"</code>, <code>"2min"</code>, <code>"3min"</code>, <code>"5min"</code>, <code>"10min"</code>, <code>"15min"</code>, <code>"30min"</code>, <code>"hour"</code>, <code>"day"</code>, <code>"week"</code>, <code>"month"</code>. Default: <code>"hour"</code></p>
</div>


                            </div>
                            <div id="TinkoffBrokerServer.iList" class="classattr">
                                <div class="attr variable">
            <span class="name">iList</span>

        
    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.iList"></a>
    
            <div class="docstring"><p>Dictionary with raw data about stocks, currencies, bonds, etfs and futures from broker server.
At first time, when class init, <code><a href="#TinkoffBrokerServer.Listing">Listing()</a></code> method auto-update this variable.
For future use, you can save this variable and substitute it in the <code><a href="#TinkoffBrokerServer.iList">iList</a></code> to avoid permanent downloads from the server.</p>
</div>


                            </div>
                            <div id="TinkoffBrokerServer.instrumentsFile" class="classattr">
                                <div class="attr variable">
            <span class="name">instrumentsFile</span>

        
    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.instrumentsFile"></a>
    
            <div class="docstring"><p>Filename where full broker's instruments list will be saved. Default: <code>"instruments.md"</code></p>
</div>


                            </div>
                            <div id="TinkoffBrokerServer.pricesFile" class="classattr">
                                <div class="attr variable">
            <span class="name">pricesFile</span>

        
    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.pricesFile"></a>
    
            <div class="docstring"><p>Filename where prices of selected instruments will be saved. Default: <code>"prices.md"</code></p>
</div>


                            </div>
                            <div id="TinkoffBrokerServer.overviewFile" class="classattr">
                                <div class="attr variable">
            <span class="name">overviewFile</span>

        
    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.overviewFile"></a>
    
            <div class="docstring"><p>Filename where current portfolio, open trades and orders will be saved. Default: <code>"overview.md"</code></p>
</div>


                            </div>
                            <div id="TinkoffBrokerServer.reportFile" class="classattr">
                                <div class="attr variable">
            <span class="name">reportFile</span>

        
    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.reportFile"></a>
    
            <div class="docstring"><p>Filename where history of deals and trade statistics will be saved. Default: <code>"report.md"</code></p>
</div>


                            </div>
                            <div id="TinkoffBrokerServer.historyFile" class="classattr">
                                <div class="attr variable">
            <span class="name">historyFile</span>

        
    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.historyFile"></a>
    
            <div class="docstring"><p>Full path to .csv output file where history candles will be saved. Default: <code>None</code>, mean that returns only pandas dataframe.</p>
</div>


                            </div>
                            <div id="TinkoffBrokerServer.SendAPIRequest" class="classattr">
                                        <input id="TinkoffBrokerServer.SendAPIRequest-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">SendAPIRequest</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">url</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">reqType</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;GET&#39;</span>,</span><span class="param">	<span class="n">retry</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>,</span><span class="param">	<span class="n">pause</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>,</span><span class="param">	<span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="nb">dict</span>:</span></span>

                <label class="view-source-button" for="TinkoffBrokerServer.SendAPIRequest-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.SendAPIRequest"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TinkoffBrokerServer.SendAPIRequest-303"><a href="#-303"><span class="linenos">303</span></a>    <span class="k">def</span> <span class="nf">SendAPIRequest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">reqType</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="n">retry</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">pause</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-304"><a href="#-304"><span class="linenos">304</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-305"><a href="#-305"><span class="linenos">305</span></a><span class="sd">        Send GET or POST request to broker server and receive JSON object.</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-306"><a href="#-306"><span class="linenos">306</span></a>
</span><span id="TinkoffBrokerServer.SendAPIRequest-307"><a href="#-307"><span class="linenos">307</span></a><span class="sd">        self.header: must be define with dictionary of headers.</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-308"><a href="#-308"><span class="linenos">308</span></a><span class="sd">        self.body: if define then used as request body. None by default.</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-309"><a href="#-309"><span class="linenos">309</span></a><span class="sd">        self.timeout: global request timeout, 15 seconds by default.</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-310"><a href="#-310"><span class="linenos">310</span></a><span class="sd">        :param url: url with REST request.</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-311"><a href="#-311"><span class="linenos">311</span></a><span class="sd">        :param reqType: send &quot;GET&quot; or &quot;POST&quot; request. &quot;GET&quot; by default.</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-312"><a href="#-312"><span class="linenos">312</span></a><span class="sd">        :param retry: how many times retry after first request if an error occurred.</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-313"><a href="#-313"><span class="linenos">313</span></a><span class="sd">        :param pause: sleep time in seconds between retries.</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-314"><a href="#-314"><span class="linenos">314</span></a><span class="sd">        :param debug: if `True` then print more debug information.</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-315"><a href="#-315"><span class="linenos">315</span></a><span class="sd">        :return: response JSON (dictionary) from broker.</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-316"><a href="#-316"><span class="linenos">316</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-317"><a href="#-317"><span class="linenos">317</span></a>        <span class="k">if</span> <span class="n">reqType</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">):</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-318"><a href="#-318"><span class="linenos">318</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;You can define request type: &#39;GET&#39; or &#39;POST&#39;!&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-319"><a href="#-319"><span class="linenos">319</span></a>
</span><span id="TinkoffBrokerServer.SendAPIRequest-320"><a href="#-320"><span class="linenos">320</span></a>        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-321"><a href="#-321"><span class="linenos">321</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Request parameters:&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-322"><a href="#-322"><span class="linenos">322</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;    - REST API URL: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-323"><a href="#-323"><span class="linenos">323</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;    - request type: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reqType</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-324"><a href="#-324"><span class="linenos">324</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;    - headers: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="s2">&quot;*** request token ***&quot;</span><span class="p">)))</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-325"><a href="#-325"><span class="linenos">325</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;    - body: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-326"><a href="#-326"><span class="linenos">326</span></a>
</span><span id="TinkoffBrokerServer.SendAPIRequest-327"><a href="#-327"><span class="linenos">327</span></a>        <span class="c1"># fast hack to avoid all operations with some tickers/FIGI</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-328"><a href="#-328"><span class="linenos">328</span></a>        <span class="n">responseJSON</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-329"><a href="#-329"><span class="linenos">329</span></a>        <span class="n">oK</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-330"><a href="#-330"><span class="linenos">330</span></a>        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exclude</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-331"><a href="#-331"><span class="linenos">331</span></a>            <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">url</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-332"><a href="#-332"><span class="linenos">332</span></a>                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-333"><a href="#-333"><span class="linenos">333</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Do not execute operations with list of this tickers/FIGI: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exclude</span><span class="p">)))</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-334"><a href="#-334"><span class="linenos">334</span></a>
</span><span id="TinkoffBrokerServer.SendAPIRequest-335"><a href="#-335"><span class="linenos">335</span></a>                <span class="n">oK</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-336"><a href="#-336"><span class="linenos">336</span></a>                <span class="k">break</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-337"><a href="#-337"><span class="linenos">337</span></a>
</span><span id="TinkoffBrokerServer.SendAPIRequest-338"><a href="#-338"><span class="linenos">338</span></a>        <span class="k">if</span> <span class="n">oK</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-339"><a href="#-339"><span class="linenos">339</span></a>            <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-340"><a href="#-340"><span class="linenos">340</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-341"><a href="#-341"><span class="linenos">341</span></a>            <span class="n">errMsg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-342"><a href="#-342"><span class="linenos">342</span></a>
</span><span id="TinkoffBrokerServer.SendAPIRequest-343"><a href="#-343"><span class="linenos">343</span></a>            <span class="k">while</span> <span class="ow">not</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">counter</span> <span class="o">&lt;=</span> <span class="n">retry</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-344"><a href="#-344"><span class="linenos">344</span></a>                <span class="k">if</span> <span class="n">reqType</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-345"><a href="#-345"><span class="linenos">345</span></a>                    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-346"><a href="#-346"><span class="linenos">346</span></a>
</span><span id="TinkoffBrokerServer.SendAPIRequest-347"><a href="#-347"><span class="linenos">347</span></a>                <span class="k">if</span> <span class="n">reqType</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-348"><a href="#-348"><span class="linenos">348</span></a>                    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-349"><a href="#-349"><span class="linenos">349</span></a>
</span><span id="TinkoffBrokerServer.SendAPIRequest-350"><a href="#-350"><span class="linenos">350</span></a>                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-351"><a href="#-351"><span class="linenos">351</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Response:&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-352"><a href="#-352"><span class="linenos">352</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;    - status code: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-353"><a href="#-353"><span class="linenos">353</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;    - reason: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">reason</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-354"><a href="#-354"><span class="linenos">354</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;    - body length: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)))</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-355"><a href="#-355"><span class="linenos">355</span></a>
</span><span id="TinkoffBrokerServer.SendAPIRequest-356"><a href="#-356"><span class="linenos">356</span></a>                <span class="c1"># Error status codes: https://en.wikipedia.org/wiki/List_of_HTTP_status_codes</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-357"><a href="#-357"><span class="linenos">357</span></a>                <span class="k">if</span> <span class="mi">400</span> <span class="o">&lt;=</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&lt;</span> <span class="mi">600</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-358"><a href="#-358"><span class="linenos">358</span></a>                    <span class="n">errMsg</span> <span class="o">=</span> <span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">] </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-359"><a href="#-359"><span class="linenos">359</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;    - not oK status code received: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">errMsg</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-360"><a href="#-360"><span class="linenos">360</span></a>                    <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-361"><a href="#-361"><span class="linenos">361</span></a>
</span><span id="TinkoffBrokerServer.SendAPIRequest-362"><a href="#-362"><span class="linenos">362</span></a>                    <span class="k">if</span> <span class="n">counter</span> <span class="o">&lt;=</span> <span class="n">retry</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-363"><a href="#-363"><span class="linenos">363</span></a>                        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Retry: [</span><span class="si">{}</span><span class="s2">]. Wait until </span><span class="si">{}</span><span class="s2"> sec. and try again...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="n">pause</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-364"><a href="#-364"><span class="linenos">364</span></a>                        <span class="n">sleep</span><span class="p">(</span><span class="n">pause</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-365"><a href="#-365"><span class="linenos">365</span></a>
</span><span id="TinkoffBrokerServer.SendAPIRequest-366"><a href="#-366"><span class="linenos">366</span></a>            <span class="n">responseJSON</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ParseJSON</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-367"><a href="#-367"><span class="linenos">367</span></a>
</span><span id="TinkoffBrokerServer.SendAPIRequest-368"><a href="#-368"><span class="linenos">368</span></a>            <span class="k">if</span> <span class="n">errMsg</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-369"><a href="#-369"><span class="linenos">369</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Not `oK` status received from broker server!&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-370"><a href="#-370"><span class="linenos">370</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;    - message: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">errMsg</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-371"><a href="#-371"><span class="linenos">371</span></a>                <span class="c1"># raise Exception(&quot;Server returned an error! See full debug log. Also you can set debug=True in SendAPIRequest() and _ParseJSON() methods.&quot;)</span>
</span><span id="TinkoffBrokerServer.SendAPIRequest-372"><a href="#-372"><span class="linenos">372</span></a>
</span><span id="TinkoffBrokerServer.SendAPIRequest-373"><a href="#-373"><span class="linenos">373</span></a>        <span class="k">return</span> <span class="n">responseJSON</span>
</span></pre></div>


            <div class="docstring"><p>Send GET or POST request to broker server and receive JSON object.</p>

<p>self.header: must be define with dictionary of headers.
self.body: if define then used as request body. None by default.
self.timeout: global request timeout, 15 seconds by default.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>url</strong>:  url with REST request.</li>
<li><strong>reqType</strong>:  send "GET" or "POST" request. "GET" by default.</li>
<li><strong>retry</strong>:  how many times retry after first request if an error occurred.</li>
<li><strong>pause</strong>:  sleep time in seconds between retries.</li>
<li><strong>debug</strong>:  if <code>True</code> then print more debug information.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>response JSON (dictionary) from broker.</p>
</blockquote>
</div>


                            </div>
                            <div id="TinkoffBrokerServer.Listing" class="classattr">
                                        <input id="TinkoffBrokerServer.Listing-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">Listing</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">dict</span>:</span></span>

                <label class="view-source-button" for="TinkoffBrokerServer.Listing-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.Listing"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TinkoffBrokerServer.Listing-406"><a href="#-406"><span class="linenos">406</span></a>    <span class="k">def</span> <span class="nf">Listing</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Listing-407"><a href="#-407"><span class="linenos">407</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.Listing-408"><a href="#-408"><span class="linenos">408</span></a><span class="sd">        Gets JSON with raw data about stocks, currencies, bonds, etfs and futures from broker server.</span>
</span><span id="TinkoffBrokerServer.Listing-409"><a href="#-409"><span class="linenos">409</span></a>
</span><span id="TinkoffBrokerServer.Listing-410"><a href="#-410"><span class="linenos">410</span></a><span class="sd">        :return: Dictionary with all available broker instruments: currencies, stocks, bonds, etfs and futures.</span>
</span><span id="TinkoffBrokerServer.Listing-411"><a href="#-411"><span class="linenos">411</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.Listing-412"><a href="#-412"><span class="linenos">412</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Requesting all available instruments from broker for current user token. Wait, please...&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Listing-413"><a href="#-413"><span class="linenos">413</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;CPU usages for parallel requests: [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">CPU_USAGES</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.Listing-414"><a href="#-414"><span class="linenos">414</span></a>
</span><span id="TinkoffBrokerServer.Listing-415"><a href="#-415"><span class="linenos">415</span></a>        <span class="c1"># this parameters insert to requests: https://tinkoff.github.io/investAPI/swagger-ui/#/InstrumentsService</span>
</span><span id="TinkoffBrokerServer.Listing-416"><a href="#-416"><span class="linenos">416</span></a>        <span class="c1"># iType is type of instrument, it must be one of supported types in TKS_INSTRUMENTS list.</span>
</span><span id="TinkoffBrokerServer.Listing-417"><a href="#-417"><span class="linenos">417</span></a>        <span class="n">iParams</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;iType&quot;</span><span class="p">:</span> <span class="n">iType</span><span class="p">}</span> <span class="k">for</span> <span class="n">iType</span> <span class="ow">in</span> <span class="n">TKS_INSTRUMENTS</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer.Listing-418"><a href="#-418"><span class="linenos">418</span></a>
</span><span id="TinkoffBrokerServer.Listing-419"><a href="#-419"><span class="linenos">419</span></a>        <span class="n">poolUpdater</span> <span class="o">=</span> <span class="n">ThreadPool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">CPU_USAGES</span><span class="p">)</span>  <span class="c1"># create pool for update instruments in parallel mode</span>
</span><span id="TinkoffBrokerServer.Listing-420"><a href="#-420"><span class="linenos">420</span></a>        <span class="n">listing</span> <span class="o">=</span> <span class="n">poolUpdater</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_IWrapper</span><span class="p">,</span> <span class="n">iParams</span><span class="p">)</span>  <span class="c1"># execute update operations</span>
</span><span id="TinkoffBrokerServer.Listing-421"><a href="#-421"><span class="linenos">421</span></a>        <span class="n">poolUpdater</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="TinkoffBrokerServer.Listing-422"><a href="#-422"><span class="linenos">422</span></a>
</span><span id="TinkoffBrokerServer.Listing-423"><a href="#-423"><span class="linenos">423</span></a>        <span class="c1"># Dictionary with all broker instruments: stocks, currencies, bonds, etfs and futures.</span>
</span><span id="TinkoffBrokerServer.Listing-424"><a href="#-424"><span class="linenos">424</span></a>        <span class="c1"># Next in this code: item[0] is &quot;iType&quot; and item[1] is list of available instruments from the result of _IUpdater() method</span>
</span><span id="TinkoffBrokerServer.Listing-425"><a href="#-425"><span class="linenos">425</span></a>        <span class="n">iList</span> <span class="o">=</span> <span class="p">{</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="p">{</span><span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">]:</span> <span class="n">instrument</span> <span class="k">for</span> <span class="n">instrument</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">listing</span><span class="p">}</span>
</span><span id="TinkoffBrokerServer.Listing-426"><a href="#-426"><span class="linenos">426</span></a>
</span><span id="TinkoffBrokerServer.Listing-427"><a href="#-427"><span class="linenos">427</span></a>        <span class="c1"># calculate minimum price increment (step) for all instruments and set up instrument&#39;s type:</span>
</span><span id="TinkoffBrokerServer.Listing-428"><a href="#-428"><span class="linenos">428</span></a>        <span class="k">for</span> <span class="n">iType</span> <span class="ow">in</span> <span class="n">iList</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.Listing-429"><a href="#-429"><span class="linenos">429</span></a>            <span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.Listing-430"><a href="#-430"><span class="linenos">430</span></a>                <span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">][</span><span class="n">ticker</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iType</span>
</span><span id="TinkoffBrokerServer.Listing-431"><a href="#-431"><span class="linenos">431</span></a>
</span><span id="TinkoffBrokerServer.Listing-432"><a href="#-432"><span class="linenos">432</span></a>                <span class="k">if</span> <span class="s2">&quot;minPriceIncrement&quot;</span> <span class="ow">in</span> <span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">][</span><span class="n">ticker</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.Listing-433"><a href="#-433"><span class="linenos">433</span></a>                    <span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">][</span><span class="n">ticker</span><span class="p">][</span><span class="s2">&quot;step&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.Listing-434"><a href="#-434"><span class="linenos">434</span></a>                        <span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">][</span><span class="n">ticker</span><span class="p">][</span><span class="s2">&quot;minPriceIncrement&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Listing-435"><a href="#-435"><span class="linenos">435</span></a>                        <span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">][</span><span class="n">ticker</span><span class="p">][</span><span class="s2">&quot;minPriceIncrement&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Listing-436"><a href="#-436"><span class="linenos">436</span></a>                    <span class="p">)</span>
</span><span id="TinkoffBrokerServer.Listing-437"><a href="#-437"><span class="linenos">437</span></a>
</span><span id="TinkoffBrokerServer.Listing-438"><a href="#-438"><span class="linenos">438</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Listing-439"><a href="#-439"><span class="linenos">439</span></a>                    <span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">][</span><span class="n">ticker</span><span class="p">][</span><span class="s2">&quot;step&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># hack to avoid empty value in some instruments, e.g. futures</span>
</span><span id="TinkoffBrokerServer.Listing-440"><a href="#-440"><span class="linenos">440</span></a>
</span><span id="TinkoffBrokerServer.Listing-441"><a href="#-441"><span class="linenos">441</span></a>        <span class="k">return</span> <span class="n">iList</span>
</span></pre></div>


            <div class="docstring"><p>Gets JSON with raw data about stocks, currencies, bonds, etfs and futures from broker server.</p>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>Dictionary with all available broker instruments: currencies, stocks, bonds, etfs and futures.</p>
</blockquote>
</div>


                            </div>
                            <div id="TinkoffBrokerServer.ShowInstrumentInfo" class="classattr">
                                        <input id="TinkoffBrokerServer.ShowInstrumentInfo-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">ShowInstrumentInfo</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">iJSON</span><span class="p">:</span> <span class="nb">dict</span>, </span><span class="param"><span class="n">printInfo</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="TinkoffBrokerServer.ShowInstrumentInfo-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.ShowInstrumentInfo"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TinkoffBrokerServer.ShowInstrumentInfo-443"><a href="#-443"><span class="linenos">443</span></a>    <span class="nd">@staticmethod</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-444"><a href="#-444"><span class="linenos">444</span></a>    <span class="k">def</span> <span class="nf">ShowInstrumentInfo</span><span class="p">(</span><span class="n">iJSON</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">printInfo</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-445"><a href="#-445"><span class="linenos">445</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-446"><a href="#-446"><span class="linenos">446</span></a><span class="sd">        Show information about instrument defined by json and print in Markdown format.</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-447"><a href="#-447"><span class="linenos">447</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-448"><a href="#-448"><span class="linenos">448</span></a><span class="sd">        :param iJSON: json data of instrument, e.g. in code `iJSON = self.iList[&quot;Shares&quot;][self.ticker]`</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-449"><a href="#-449"><span class="linenos">449</span></a><span class="sd">        :param printInfo: if `True` then also printing information about instrument and its current price.</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-450"><a href="#-450"><span class="linenos">450</span></a><span class="sd">        :return: text in Markdown format with information about instrument.</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-451"><a href="#-451"><span class="linenos">451</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-452"><a href="#-452"><span class="linenos">452</span></a>        <span class="n">infoText</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-453"><a href="#-453"><span class="linenos">453</span></a>        <span class="k">if</span> <span class="n">iJSON</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">iJSON</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">iJSON</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-454"><a href="#-454"><span class="linenos">454</span></a>            <span class="n">info</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-455"><a href="#-455"><span class="linenos">455</span></a>                <span class="s2">&quot;# Information is actual at: [</span><span class="si">{}</span><span class="s2">] (UTC)</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tzutc</span><span class="p">())</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M&quot;</span><span class="p">)),</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-456"><a href="#-456"><span class="linenos">456</span></a>                <span class="s2">&quot;| Parameters                                              | Values</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-457"><a href="#-457"><span class="linenos">457</span></a>                <span class="s2">&quot;|---------------------------------------------------------|---------------------------------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-458"><a href="#-458"><span class="linenos">458</span></a>                <span class="s2">&quot;| Stock ticker:                                           | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-459"><a href="#-459"><span class="linenos">459</span></a>                <span class="s2">&quot;| Full name:                                              | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-460"><a href="#-460"><span class="linenos">460</span></a>            <span class="p">]</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-461"><a href="#-461"><span class="linenos">461</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-462"><a href="#-462"><span class="linenos">462</span></a>            <span class="k">if</span> <span class="s2">&quot;sector&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;sector&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-463"><a href="#-463"><span class="linenos">463</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Sector:                                                 | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;sector&quot;</span><span class="p">]))</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-464"><a href="#-464"><span class="linenos">464</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-465"><a href="#-465"><span class="linenos">465</span></a>            <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Country of instrument:                                  | </span><span class="si">{}{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-466"><a href="#-466"><span class="linenos">466</span></a>                <span class="s2">&quot;(</span><span class="si">{}</span><span class="s2">) &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;countryOfRisk&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;countryOfRisk&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;countryOfRisk&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-467"><a href="#-467"><span class="linenos">467</span></a>                <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;countryOfRiskName&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;countryOfRiskName&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;countryOfRiskName&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-468"><a href="#-468"><span class="linenos">468</span></a>            <span class="p">))</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-469"><a href="#-469"><span class="linenos">469</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-470"><a href="#-470"><span class="linenos">470</span></a>            <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-471"><a href="#-471"><span class="linenos">471</span></a>                <span class="s2">&quot;|                                                         |</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-472"><a href="#-472"><span class="linenos">472</span></a>                <span class="s2">&quot;| FIGI (Financial Instrument Global Identifier):          | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-473"><a href="#-473"><span class="linenos">473</span></a>                <span class="s2">&quot;| Exchange:                                               | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;exchange&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-474"><a href="#-474"><span class="linenos">474</span></a>            <span class="p">])</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-475"><a href="#-475"><span class="linenos">475</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-476"><a href="#-476"><span class="linenos">476</span></a>            <span class="k">if</span> <span class="s2">&quot;isin&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;isin&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-477"><a href="#-477"><span class="linenos">477</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| ISIN (International Securities Identification Number):  | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;isin&quot;</span><span class="p">]))</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-478"><a href="#-478"><span class="linenos">478</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-479"><a href="#-479"><span class="linenos">479</span></a>            <span class="k">if</span> <span class="s2">&quot;classCode&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-480"><a href="#-480"><span class="linenos">480</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Class Code:                                             | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;classCode&quot;</span><span class="p">]))</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-481"><a href="#-481"><span class="linenos">481</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-482"><a href="#-482"><span class="linenos">482</span></a>            <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-483"><a href="#-483"><span class="linenos">483</span></a>                <span class="s2">&quot;|                                                         |</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-484"><a href="#-484"><span class="linenos">484</span></a>                <span class="s2">&quot;| Current broker security trading status:                 | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">TKS_TRADING_STATUSES</span><span class="p">[</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;tradingStatus&quot;</span><span class="p">]]),</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-485"><a href="#-485"><span class="linenos">485</span></a>                <span class="s2">&quot;| Buy operations allowed:                                 | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Yes&quot;</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;buyAvailableFlag&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;No&quot;</span><span class="p">),</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-486"><a href="#-486"><span class="linenos">486</span></a>                <span class="s2">&quot;| Sale operations allowed:                                | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Yes&quot;</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;sellAvailableFlag&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;No&quot;</span><span class="p">),</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-487"><a href="#-487"><span class="linenos">487</span></a>                <span class="s2">&quot;| Short positions allowed:                                | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Yes&quot;</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;shortEnabledFlag&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;No&quot;</span><span class="p">),</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-488"><a href="#-488"><span class="linenos">488</span></a>            <span class="p">])</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-489"><a href="#-489"><span class="linenos">489</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-490"><a href="#-490"><span class="linenos">490</span></a>            <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;|                                                         |</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-491"><a href="#-491"><span class="linenos">491</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-492"><a href="#-492"><span class="linenos">492</span></a>            <span class="k">if</span> <span class="s2">&quot;type&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-493"><a href="#-493"><span class="linenos">493</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Type of the instrument:                                 | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]))</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-494"><a href="#-494"><span class="linenos">494</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-495"><a href="#-495"><span class="linenos">495</span></a>            <span class="k">if</span> <span class="s2">&quot;futuresType&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;futuresType&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-496"><a href="#-496"><span class="linenos">496</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Futures type:                                           | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;futuresType&quot;</span><span class="p">]))</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-497"><a href="#-497"><span class="linenos">497</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-498"><a href="#-498"><span class="linenos">498</span></a>            <span class="k">if</span> <span class="s2">&quot;ipoDate&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;ipoDate&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-499"><a href="#-499"><span class="linenos">499</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| IPO date:                                               | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;ipoDate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-500"><a href="#-500"><span class="linenos">500</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-501"><a href="#-501"><span class="linenos">501</span></a>            <span class="k">if</span> <span class="s2">&quot;releasedDate&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;releasedDate&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-502"><a href="#-502"><span class="linenos">502</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Released date:                                          | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;releasedDate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-503"><a href="#-503"><span class="linenos">503</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-504"><a href="#-504"><span class="linenos">504</span></a>            <span class="k">if</span> <span class="s2">&quot;rebalancingFreq&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;rebalancingFreq&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-505"><a href="#-505"><span class="linenos">505</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Rebalancing frequency:                                  | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;rebalancingFreq&quot;</span><span class="p">]))</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-506"><a href="#-506"><span class="linenos">506</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-507"><a href="#-507"><span class="linenos">507</span></a>            <span class="k">if</span> <span class="s2">&quot;focusType&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;focusType&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-508"><a href="#-508"><span class="linenos">508</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Focusing type:                                          | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;focusType&quot;</span><span class="p">]))</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-509"><a href="#-509"><span class="linenos">509</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-510"><a href="#-510"><span class="linenos">510</span></a>            <span class="k">if</span> <span class="s2">&quot;assetType&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;assetType&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-511"><a href="#-511"><span class="linenos">511</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Asset type:                                             | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;assetType&quot;</span><span class="p">]))</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-512"><a href="#-512"><span class="linenos">512</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-513"><a href="#-513"><span class="linenos">513</span></a>            <span class="k">if</span> <span class="s2">&quot;basicAsset&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;basicAsset&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-514"><a href="#-514"><span class="linenos">514</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Basic asset:                                            | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;basicAsset&quot;</span><span class="p">]))</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-515"><a href="#-515"><span class="linenos">515</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-516"><a href="#-516"><span class="linenos">516</span></a>            <span class="k">if</span> <span class="s2">&quot;basicAssetSize&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;basicAssetSize&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-517"><a href="#-517"><span class="linenos">517</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Basic asset size:                                       | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">NanoToFloat</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;basicAssetSize&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">]),</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;basicAssetSize&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])))</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-518"><a href="#-518"><span class="linenos">518</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-519"><a href="#-519"><span class="linenos">519</span></a>            <span class="k">if</span> <span class="s2">&quot;isoCurrencyName&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;isoCurrencyName&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-520"><a href="#-520"><span class="linenos">520</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| ISO currency name:                                      | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;isoCurrencyName&quot;</span><span class="p">]))</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-521"><a href="#-521"><span class="linenos">521</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-522"><a href="#-522"><span class="linenos">522</span></a>            <span class="k">if</span> <span class="s2">&quot;currency&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-523"><a href="#-523"><span class="linenos">523</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Payment currency:                                       | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">]))</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-524"><a href="#-524"><span class="linenos">524</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-525"><a href="#-525"><span class="linenos">525</span></a>            <span class="k">if</span> <span class="s2">&quot;firstTradeDate&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;firstTradeDate&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-526"><a href="#-526"><span class="linenos">526</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| First trade date:                                       | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;firstTradeDate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-527"><a href="#-527"><span class="linenos">527</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-528"><a href="#-528"><span class="linenos">528</span></a>            <span class="k">if</span> <span class="s2">&quot;lastTradeDate&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;lastTradeDate&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-529"><a href="#-529"><span class="linenos">529</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Last trade date:                                        | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;lastTradeDate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-530"><a href="#-530"><span class="linenos">530</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-531"><a href="#-531"><span class="linenos">531</span></a>            <span class="k">if</span> <span class="s2">&quot;expirationDate&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;expirationDate&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-532"><a href="#-532"><span class="linenos">532</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Date of expiration:                                     | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;expirationDate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-533"><a href="#-533"><span class="linenos">533</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-534"><a href="#-534"><span class="linenos">534</span></a>            <span class="k">if</span> <span class="s2">&quot;stateRegDate&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;stateRegDate&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-535"><a href="#-535"><span class="linenos">535</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| State registration date:                                | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;stateRegDate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-536"><a href="#-536"><span class="linenos">536</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-537"><a href="#-537"><span class="linenos">537</span></a>            <span class="k">if</span> <span class="s2">&quot;placementDate&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;placementDate&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-538"><a href="#-538"><span class="linenos">538</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Placement date:                                         | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;placementDate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-539"><a href="#-539"><span class="linenos">539</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-540"><a href="#-540"><span class="linenos">540</span></a>            <span class="k">if</span> <span class="s2">&quot;maturityDate&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;maturityDate&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-541"><a href="#-541"><span class="linenos">541</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Maturity date:                                          | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;maturityDate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-542"><a href="#-542"><span class="linenos">542</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-543"><a href="#-543"><span class="linenos">543</span></a>            <span class="k">if</span> <span class="s2">&quot;perpetualFlag&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;perpetualFlag&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-544"><a href="#-544"><span class="linenos">544</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Perpetual bond:                                         | Yes</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-545"><a href="#-545"><span class="linenos">545</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-546"><a href="#-546"><span class="linenos">546</span></a>            <span class="k">if</span> <span class="s2">&quot;otcFlag&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;otcFlag&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-547"><a href="#-547"><span class="linenos">547</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Over-the-counter (OTC) securities:                      | Yes</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-548"><a href="#-548"><span class="linenos">548</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-549"><a href="#-549"><span class="linenos">549</span></a>            <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Bond&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-550"><a href="#-550"><span class="linenos">550</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Bond issue (size / plan):                               | </span><span class="si">{}</span><span class="s2"> / </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;issueSize&quot;</span><span class="p">],</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;issueSizePlan&quot;</span><span class="p">]))</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-551"><a href="#-551"><span class="linenos">551</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-552"><a href="#-552"><span class="linenos">552</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Nominal price (100%):                                   | </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-553"><a href="#-553"><span class="linenos">553</span></a>                    <span class="n">NanoToFloat</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;nominal&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">]),</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;nominal&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-554"><a href="#-554"><span class="linenos">554</span></a>                    <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;nominal&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-555"><a href="#-555"><span class="linenos">555</span></a>                <span class="p">))</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-556"><a href="#-556"><span class="linenos">556</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-557"><a href="#-557"><span class="linenos">557</span></a>                <span class="k">if</span> <span class="s2">&quot;floatingCouponFlag&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-558"><a href="#-558"><span class="linenos">558</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Floating coupon:                                        | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Yes&quot;</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;floatingCouponFlag&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;No&quot;</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-559"><a href="#-559"><span class="linenos">559</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-560"><a href="#-560"><span class="linenos">560</span></a>                <span class="k">if</span> <span class="s2">&quot;amortizationFlag&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-561"><a href="#-561"><span class="linenos">561</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Amortization:                                           | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Yes&quot;</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;amortizationFlag&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;No&quot;</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-562"><a href="#-562"><span class="linenos">562</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-563"><a href="#-563"><span class="linenos">563</span></a>                <span class="k">if</span> <span class="s2">&quot;couponQuantityPerYear&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;couponQuantityPerYear&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-564"><a href="#-564"><span class="linenos">564</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Number of coupon payments per year:                     | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;couponQuantityPerYear&quot;</span><span class="p">]))</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-565"><a href="#-565"><span class="linenos">565</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-566"><a href="#-566"><span class="linenos">566</span></a>                <span class="k">if</span> <span class="s2">&quot;aciValue&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;aciValue&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-567"><a href="#-567"><span class="linenos">567</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Current ACI (Accrued Interest):                         | </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-568"><a href="#-568"><span class="linenos">568</span></a>                        <span class="n">NanoToFloat</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;aciValue&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">]),</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;aciValue&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-569"><a href="#-569"><span class="linenos">569</span></a>                        <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;aciValue&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-570"><a href="#-570"><span class="linenos">570</span></a>                    <span class="p">))</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-571"><a href="#-571"><span class="linenos">571</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-572"><a href="#-572"><span class="linenos">572</span></a>            <span class="k">if</span> <span class="s2">&quot;currentPrice&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-573"><a href="#-573"><span class="linenos">573</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;|                                                         |</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-574"><a href="#-574"><span class="linenos">574</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-575"><a href="#-575"><span class="linenos">575</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-576"><a href="#-576"><span class="linenos">576</span></a>                    <span class="s2">&quot;| Previous close price of the instrument:                 | </span><span class="si">{}{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-577"><a href="#-577"><span class="linenos">577</span></a>                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;closePrice&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;closePrice&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-578"><a href="#-578"><span class="linenos">578</span></a>                        <span class="s2">&quot;</span><span class="si">% o</span><span class="s2">f nominal price&quot;</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Bond&quot;</span> <span class="k">else</span> <span class="s2">&quot; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;currency&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-579"><a href="#-579"><span class="linenos">579</span></a>                    <span class="p">),</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-580"><a href="#-580"><span class="linenos">580</span></a>                    <span class="s2">&quot;| Last deal price of the instrument:                      | </span><span class="si">{}{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-581"><a href="#-581"><span class="linenos">581</span></a>                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-582"><a href="#-582"><span class="linenos">582</span></a>                        <span class="s2">&quot;</span><span class="si">% o</span><span class="s2">f nominal price&quot;</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Bond&quot;</span> <span class="k">else</span> <span class="s2">&quot; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;currency&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-583"><a href="#-583"><span class="linenos">583</span></a>                    <span class="p">),</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-584"><a href="#-584"><span class="linenos">584</span></a>                    <span class="s2">&quot;| Changes between last deal price and last close  %       | </span><span class="si">{:.2f}</span><span class="s2">%</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;changes&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-585"><a href="#-585"><span class="linenos">585</span></a>                    <span class="s2">&quot;| Current limit price, min / max:                         | </span><span class="si">{}{}</span><span class="s2"> / </span><span class="si">{}{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-586"><a href="#-586"><span class="linenos">586</span></a>                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;limitDown&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;limitDown&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-587"><a href="#-587"><span class="linenos">587</span></a>                        <span class="s2">&quot;%&quot;</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Bond&quot;</span> <span class="k">else</span> <span class="s2">&quot; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;currency&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-588"><a href="#-588"><span class="linenos">588</span></a>                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;limitUp&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;limitUp&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-589"><a href="#-589"><span class="linenos">589</span></a>                        <span class="s2">&quot;%&quot;</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Bond&quot;</span> <span class="k">else</span> <span class="s2">&quot; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;currency&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-590"><a href="#-590"><span class="linenos">590</span></a>                    <span class="p">),</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-591"><a href="#-591"><span class="linenos">591</span></a>                    <span class="s2">&quot;| Actual price, sell / buy:                               | </span><span class="si">{}{}</span><span class="s2"> / </span><span class="si">{}{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-592"><a href="#-592"><span class="linenos">592</span></a>                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;sell&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;price&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;sell&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-593"><a href="#-593"><span class="linenos">593</span></a>                        <span class="s2">&quot;%&quot;</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Bond&quot;</span> <span class="k">else</span> <span class="s2">&quot; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;currency&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-594"><a href="#-594"><span class="linenos">594</span></a>                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;buy&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;price&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;buy&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-595"><a href="#-595"><span class="linenos">595</span></a>                        <span class="s2">&quot;%&quot;</span> <span class="k">if</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Bond&quot;</span> <span class="k">else</span><span class="s2">&quot; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;currency&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-596"><a href="#-596"><span class="linenos">596</span></a>                    <span class="p">),</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-597"><a href="#-597"><span class="linenos">597</span></a>                <span class="p">])</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-598"><a href="#-598"><span class="linenos">598</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-599"><a href="#-599"><span class="linenos">599</span></a>            <span class="k">if</span> <span class="s2">&quot;lot&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-600"><a href="#-600"><span class="linenos">600</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Minimum lot to buy:                                     | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;lot&quot;</span><span class="p">]))</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-601"><a href="#-601"><span class="linenos">601</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-602"><a href="#-602"><span class="linenos">602</span></a>            <span class="k">if</span> <span class="s2">&quot;step&quot;</span> <span class="ow">in</span> <span class="n">iJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-603"><a href="#-603"><span class="linenos">603</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| Minimum price increment (step):                         | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">]))</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-604"><a href="#-604"><span class="linenos">604</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-605"><a href="#-605"><span class="linenos">605</span></a>            <span class="n">infoText</span> <span class="o">+=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-606"><a href="#-606"><span class="linenos">606</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-607"><a href="#-607"><span class="linenos">607</span></a>            <span class="k">if</span> <span class="n">printInfo</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-608"><a href="#-608"><span class="linenos">608</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Information about instrument: ticker [</span><span class="si">{}</span><span class="s2">], FIGI [</span><span class="si">{}</span><span class="s2">]</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">],</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">],</span> <span class="n">infoText</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-609"><a href="#-609"><span class="linenos">609</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-610"><a href="#-610"><span class="linenos">610</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-611"><a href="#-611"><span class="linenos">611</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Information about instrument: ticker [</span><span class="si">{}</span><span class="s2">], FIGI [</span><span class="si">{}</span><span class="s2">]</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">],</span> <span class="n">iJSON</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">],</span> <span class="n">infoText</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-612"><a href="#-612"><span class="linenos">612</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentInfo-613"><a href="#-613"><span class="linenos">613</span></a>        <span class="k">return</span> <span class="n">infoText</span>
</span></pre></div>


            <div class="docstring"><p>Show information about instrument defined by json and print in Markdown format.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>iJSON</strong>:  json data of instrument, e.g. in code <code>iJSON = self.iList["Shares"][self.ticker]</code></li>
<li><strong>printInfo</strong>:  if <code>True</code> then also printing information about instrument and its current price.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>text in Markdown format with information about instrument.</p>
</blockquote>
</div>


                            </div>
                            <div id="TinkoffBrokerServer.SearchByTicker" class="classattr">
                                        <input id="TinkoffBrokerServer.SearchByTicker-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">SearchByTicker</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">requestPrice</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">showInfo</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="nb">dict</span>:</span></span>

                <label class="view-source-button" for="TinkoffBrokerServer.SearchByTicker-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.SearchByTicker"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TinkoffBrokerServer.SearchByTicker-615"><a href="#-615"><span class="linenos">615</span></a>    <span class="k">def</span> <span class="nf">SearchByTicker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requestPrice</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">showInfo</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-616"><a href="#-616"><span class="linenos">616</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-617"><a href="#-617"><span class="linenos">617</span></a><span class="sd">        Search and return raw broker&#39;s information about instrument by it&#39;s ticker.</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-618"><a href="#-618"><span class="linenos">618</span></a><span class="sd">        `ticker` must be define! If debug=True then print all debug messages.</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-619"><a href="#-619"><span class="linenos">619</span></a>
</span><span id="TinkoffBrokerServer.SearchByTicker-620"><a href="#-620"><span class="linenos">620</span></a><span class="sd">        :param requestPrice: if `False` then do not request current price of instrument (because this is long operation).</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-621"><a href="#-621"><span class="linenos">621</span></a><span class="sd">        :param showInfo: if `False` then do not run `ShowInstrumentInfo()` method and do not print info to the console.</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-622"><a href="#-622"><span class="linenos">622</span></a><span class="sd">        :param debug: if `True` then print all debug console messages.</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-623"><a href="#-623"><span class="linenos">623</span></a><span class="sd">        :return: JSON formatted data with information about instrument.</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-624"><a href="#-624"><span class="linenos">624</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-625"><a href="#-625"><span class="linenos">625</span></a>        <span class="n">tickerJSON</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-626"><a href="#-626"><span class="linenos">626</span></a>        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-627"><a href="#-627"><span class="linenos">627</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Searching information about instrument by it&#39;s ticker [</span><span class="si">{}</span><span class="s2">] ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-628"><a href="#-628"><span class="linenos">628</span></a>
</span><span id="TinkoffBrokerServer.SearchByTicker-629"><a href="#-629"><span class="linenos">629</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-630"><a href="#-630"><span class="linenos">630</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;self.ticker variable is not be empty!&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-631"><a href="#-631"><span class="linenos">631</span></a>
</span><span id="TinkoffBrokerServer.SearchByTicker-632"><a href="#-632"><span class="linenos">632</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-633"><a href="#-633"><span class="linenos">633</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-634"><a href="#-634"><span class="linenos">634</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">iList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Listing</span><span class="p">()</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-635"><a href="#-635"><span class="linenos">635</span></a>
</span><span id="TinkoffBrokerServer.SearchByTicker-636"><a href="#-636"><span class="linenos">636</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Shares&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-637"><a href="#-637"><span class="linenos">637</span></a>                <span class="n">tickerJSON</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Shares&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-638"><a href="#-638"><span class="linenos">638</span></a>                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-639"><a href="#-639"><span class="linenos">639</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Ticker [</span><span class="si">{}</span><span class="s2">] found in stocks list&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-640"><a href="#-640"><span class="linenos">640</span></a>
</span><span id="TinkoffBrokerServer.SearchByTicker-641"><a href="#-641"><span class="linenos">641</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Currencies&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-642"><a href="#-642"><span class="linenos">642</span></a>                <span class="n">tickerJSON</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Currencies&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-643"><a href="#-643"><span class="linenos">643</span></a>                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-644"><a href="#-644"><span class="linenos">644</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Ticker [</span><span class="si">{}</span><span class="s2">] found in currencies list&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-645"><a href="#-645"><span class="linenos">645</span></a>
</span><span id="TinkoffBrokerServer.SearchByTicker-646"><a href="#-646"><span class="linenos">646</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Bonds&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-647"><a href="#-647"><span class="linenos">647</span></a>                <span class="n">tickerJSON</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Bonds&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-648"><a href="#-648"><span class="linenos">648</span></a>                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-649"><a href="#-649"><span class="linenos">649</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Ticker [</span><span class="si">{}</span><span class="s2">] found in bonds list&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-650"><a href="#-650"><span class="linenos">650</span></a>
</span><span id="TinkoffBrokerServer.SearchByTicker-651"><a href="#-651"><span class="linenos">651</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Etfs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-652"><a href="#-652"><span class="linenos">652</span></a>                <span class="n">tickerJSON</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Etfs&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-653"><a href="#-653"><span class="linenos">653</span></a>                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-654"><a href="#-654"><span class="linenos">654</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Ticker [</span><span class="si">{}</span><span class="s2">] found in etfs list&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-655"><a href="#-655"><span class="linenos">655</span></a>
</span><span id="TinkoffBrokerServer.SearchByTicker-656"><a href="#-656"><span class="linenos">656</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Futures&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-657"><a href="#-657"><span class="linenos">657</span></a>                <span class="n">tickerJSON</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Futures&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-658"><a href="#-658"><span class="linenos">658</span></a>                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-659"><a href="#-659"><span class="linenos">659</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Ticker [</span><span class="si">{}</span><span class="s2">] found in futures list&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-660"><a href="#-660"><span class="linenos">660</span></a>
</span><span id="TinkoffBrokerServer.SearchByTicker-661"><a href="#-661"><span class="linenos">661</span></a>        <span class="k">if</span> <span class="n">tickerJSON</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-662"><a href="#-662"><span class="linenos">662</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">=</span> <span class="n">tickerJSON</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-663"><a href="#-663"><span class="linenos">663</span></a>
</span><span id="TinkoffBrokerServer.SearchByTicker-664"><a href="#-664"><span class="linenos">664</span></a>            <span class="k">if</span> <span class="n">requestPrice</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-665"><a href="#-665"><span class="linenos">665</span></a>                <span class="n">tickerJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetCurrentPrices</span><span class="p">(</span><span class="n">showPrice</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-666"><a href="#-666"><span class="linenos">666</span></a>
</span><span id="TinkoffBrokerServer.SearchByTicker-667"><a href="#-667"><span class="linenos">667</span></a>                <span class="k">if</span> <span class="n">tickerJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;closePrice&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tickerJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;closePrice&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">tickerJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-668"><a href="#-668"><span class="linenos">668</span></a>                    <span class="n">tickerJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;changes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">tickerJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">tickerJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;closePrice&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="n">tickerJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;closePrice&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-669"><a href="#-669"><span class="linenos">669</span></a>
</span><span id="TinkoffBrokerServer.SearchByTicker-670"><a href="#-670"><span class="linenos">670</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-671"><a href="#-671"><span class="linenos">671</span></a>                    <span class="n">tickerJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;changes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-672"><a href="#-672"><span class="linenos">672</span></a>
</span><span id="TinkoffBrokerServer.SearchByTicker-673"><a href="#-673"><span class="linenos">673</span></a>            <span class="k">if</span> <span class="n">showInfo</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-674"><a href="#-674"><span class="linenos">674</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">ShowInstrumentInfo</span><span class="p">(</span><span class="n">iJSON</span><span class="o">=</span><span class="n">tickerJSON</span><span class="p">,</span> <span class="n">printInfo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># print info as Markdown text</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-675"><a href="#-675"><span class="linenos">675</span></a>
</span><span id="TinkoffBrokerServer.SearchByTicker-676"><a href="#-676"><span class="linenos">676</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-677"><a href="#-677"><span class="linenos">677</span></a>            <span class="k">if</span> <span class="n">showInfo</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-678"><a href="#-678"><span class="linenos">678</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Ticker [</span><span class="si">{}</span><span class="s2">] not found in available broker instrument&#39;s list!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.SearchByTicker-679"><a href="#-679"><span class="linenos">679</span></a>
</span><span id="TinkoffBrokerServer.SearchByTicker-680"><a href="#-680"><span class="linenos">680</span></a>        <span class="k">return</span> <span class="n">tickerJSON</span>
</span></pre></div>


            <div class="docstring"><p>Search and return raw broker's information about instrument by it's ticker.
<code><a href="#TinkoffBrokerServer.ticker">ticker</a></code> must be define! If debug=True then print all debug messages.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>requestPrice</strong>:  if <code>False</code> then do not request current price of instrument (because this is long operation).</li>
<li><strong>showInfo</strong>:  if <code>False</code> then do not run <code><a href="#TinkoffBrokerServer.ShowInstrumentInfo">ShowInstrumentInfo()</a></code> method and do not print info to the console.</li>
<li><strong>debug</strong>:  if <code>True</code> then print all debug console messages.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>JSON formatted data with information about instrument.</p>
</blockquote>
</div>


                            </div>
                            <div id="TinkoffBrokerServer.SearchByFIGI" class="classattr">
                                        <input id="TinkoffBrokerServer.SearchByFIGI-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">SearchByFIGI</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">requestPrice</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">showInfo</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="nb">dict</span>:</span></span>

                <label class="view-source-button" for="TinkoffBrokerServer.SearchByFIGI-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.SearchByFIGI"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TinkoffBrokerServer.SearchByFIGI-682"><a href="#-682"><span class="linenos">682</span></a>    <span class="k">def</span> <span class="nf">SearchByFIGI</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requestPrice</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">showInfo</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-683"><a href="#-683"><span class="linenos">683</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-684"><a href="#-684"><span class="linenos">684</span></a><span class="sd">        Search and return raw broker&#39;s information about instrument by it&#39;s FIGI.</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-685"><a href="#-685"><span class="linenos">685</span></a><span class="sd">        `figi` must be define! If debug=True then print all debug messages.</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-686"><a href="#-686"><span class="linenos">686</span></a>
</span><span id="TinkoffBrokerServer.SearchByFIGI-687"><a href="#-687"><span class="linenos">687</span></a><span class="sd">        :param requestPrice: if `False` then do not request current price of instrument (it&#39;s long operation).</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-688"><a href="#-688"><span class="linenos">688</span></a><span class="sd">        :param showInfo: if `False` then do not run `ShowInstrumentInfo()` method and do not print info to the console.</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-689"><a href="#-689"><span class="linenos">689</span></a><span class="sd">        :param debug: if `True` then print all debug console messages.</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-690"><a href="#-690"><span class="linenos">690</span></a><span class="sd">        :return: JSON formatted data with information about instrument.</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-691"><a href="#-691"><span class="linenos">691</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-692"><a href="#-692"><span class="linenos">692</span></a>        <span class="n">figiJSON</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-693"><a href="#-693"><span class="linenos">693</span></a>        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-694"><a href="#-694"><span class="linenos">694</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Searching information about instrument by it&#39;s FIGI [</span><span class="si">{}</span><span class="s2">] ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-695"><a href="#-695"><span class="linenos">695</span></a>
</span><span id="TinkoffBrokerServer.SearchByFIGI-696"><a href="#-696"><span class="linenos">696</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-697"><a href="#-697"><span class="linenos">697</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;self.figi variable is not be empty!&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-698"><a href="#-698"><span class="linenos">698</span></a>
</span><span id="TinkoffBrokerServer.SearchByFIGI-699"><a href="#-699"><span class="linenos">699</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-700"><a href="#-700"><span class="linenos">700</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-701"><a href="#-701"><span class="linenos">701</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">iList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Listing</span><span class="p">()</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-702"><a href="#-702"><span class="linenos">702</span></a>
</span><span id="TinkoffBrokerServer.SearchByFIGI-703"><a href="#-703"><span class="linenos">703</span></a>            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Shares&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-704"><a href="#-704"><span class="linenos">704</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Shares&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">][</span><span class="s2">&quot;figi&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-705"><a href="#-705"><span class="linenos">705</span></a>                    <span class="n">figiJSON</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Shares&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-706"><a href="#-706"><span class="linenos">706</span></a>
</span><span id="TinkoffBrokerServer.SearchByFIGI-707"><a href="#-707"><span class="linenos">707</span></a>                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-708"><a href="#-708"><span class="linenos">708</span></a>                        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;FIGI [</span><span class="si">{}</span><span class="s2">] found in stocks list&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-709"><a href="#-709"><span class="linenos">709</span></a>
</span><span id="TinkoffBrokerServer.SearchByFIGI-710"><a href="#-710"><span class="linenos">710</span></a>                    <span class="k">break</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-711"><a href="#-711"><span class="linenos">711</span></a>
</span><span id="TinkoffBrokerServer.SearchByFIGI-712"><a href="#-712"><span class="linenos">712</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">figiJSON</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-713"><a href="#-713"><span class="linenos">713</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Currencies&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-714"><a href="#-714"><span class="linenos">714</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Currencies&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">][</span><span class="s2">&quot;figi&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-715"><a href="#-715"><span class="linenos">715</span></a>                        <span class="n">figiJSON</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Currencies&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-716"><a href="#-716"><span class="linenos">716</span></a>
</span><span id="TinkoffBrokerServer.SearchByFIGI-717"><a href="#-717"><span class="linenos">717</span></a>                        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-718"><a href="#-718"><span class="linenos">718</span></a>                            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;FIGI [</span><span class="si">{}</span><span class="s2">] found in currencies list&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-719"><a href="#-719"><span class="linenos">719</span></a>
</span><span id="TinkoffBrokerServer.SearchByFIGI-720"><a href="#-720"><span class="linenos">720</span></a>                        <span class="k">break</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-721"><a href="#-721"><span class="linenos">721</span></a>
</span><span id="TinkoffBrokerServer.SearchByFIGI-722"><a href="#-722"><span class="linenos">722</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">figiJSON</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-723"><a href="#-723"><span class="linenos">723</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Bonds&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-724"><a href="#-724"><span class="linenos">724</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Bonds&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">][</span><span class="s2">&quot;figi&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-725"><a href="#-725"><span class="linenos">725</span></a>                        <span class="n">figiJSON</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Bonds&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-726"><a href="#-726"><span class="linenos">726</span></a>
</span><span id="TinkoffBrokerServer.SearchByFIGI-727"><a href="#-727"><span class="linenos">727</span></a>                        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-728"><a href="#-728"><span class="linenos">728</span></a>                            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;FIGI [</span><span class="si">{}</span><span class="s2">] found in bonds list&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-729"><a href="#-729"><span class="linenos">729</span></a>
</span><span id="TinkoffBrokerServer.SearchByFIGI-730"><a href="#-730"><span class="linenos">730</span></a>                        <span class="k">break</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-731"><a href="#-731"><span class="linenos">731</span></a>
</span><span id="TinkoffBrokerServer.SearchByFIGI-732"><a href="#-732"><span class="linenos">732</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">figiJSON</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-733"><a href="#-733"><span class="linenos">733</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Etfs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-734"><a href="#-734"><span class="linenos">734</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Etfs&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">][</span><span class="s2">&quot;figi&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-735"><a href="#-735"><span class="linenos">735</span></a>                        <span class="n">figiJSON</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Etfs&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-736"><a href="#-736"><span class="linenos">736</span></a>
</span><span id="TinkoffBrokerServer.SearchByFIGI-737"><a href="#-737"><span class="linenos">737</span></a>                        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-738"><a href="#-738"><span class="linenos">738</span></a>                            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;FIGI [</span><span class="si">{}</span><span class="s2">] found in etfs list&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-739"><a href="#-739"><span class="linenos">739</span></a>
</span><span id="TinkoffBrokerServer.SearchByFIGI-740"><a href="#-740"><span class="linenos">740</span></a>                        <span class="k">break</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-741"><a href="#-741"><span class="linenos">741</span></a>
</span><span id="TinkoffBrokerServer.SearchByFIGI-742"><a href="#-742"><span class="linenos">742</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">figiJSON</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-743"><a href="#-743"><span class="linenos">743</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Futures&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-744"><a href="#-744"><span class="linenos">744</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Futures&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">][</span><span class="s2">&quot;figi&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-745"><a href="#-745"><span class="linenos">745</span></a>                        <span class="n">figiJSON</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="s2">&quot;Futures&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-746"><a href="#-746"><span class="linenos">746</span></a>
</span><span id="TinkoffBrokerServer.SearchByFIGI-747"><a href="#-747"><span class="linenos">747</span></a>                        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-748"><a href="#-748"><span class="linenos">748</span></a>                            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;FIGI [</span><span class="si">{}</span><span class="s2">] found in futures list&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-749"><a href="#-749"><span class="linenos">749</span></a>
</span><span id="TinkoffBrokerServer.SearchByFIGI-750"><a href="#-750"><span class="linenos">750</span></a>                        <span class="k">break</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-751"><a href="#-751"><span class="linenos">751</span></a>
</span><span id="TinkoffBrokerServer.SearchByFIGI-752"><a href="#-752"><span class="linenos">752</span></a>        <span class="k">if</span> <span class="n">figiJSON</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-753"><a href="#-753"><span class="linenos">753</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">=</span> <span class="n">figiJSON</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-754"><a href="#-754"><span class="linenos">754</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">figiJSON</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-755"><a href="#-755"><span class="linenos">755</span></a>
</span><span id="TinkoffBrokerServer.SearchByFIGI-756"><a href="#-756"><span class="linenos">756</span></a>            <span class="k">if</span> <span class="n">requestPrice</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-757"><a href="#-757"><span class="linenos">757</span></a>                <span class="n">figiJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetCurrentPrices</span><span class="p">(</span><span class="n">showPrice</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-758"><a href="#-758"><span class="linenos">758</span></a>
</span><span id="TinkoffBrokerServer.SearchByFIGI-759"><a href="#-759"><span class="linenos">759</span></a>                <span class="k">if</span> <span class="n">figiJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;closePrice&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">figiJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;closePrice&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">figiJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-760"><a href="#-760"><span class="linenos">760</span></a>                    <span class="n">figiJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;changes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">figiJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">figiJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;closePrice&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="n">figiJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;closePrice&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-761"><a href="#-761"><span class="linenos">761</span></a>
</span><span id="TinkoffBrokerServer.SearchByFIGI-762"><a href="#-762"><span class="linenos">762</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-763"><a href="#-763"><span class="linenos">763</span></a>                    <span class="n">figiJSON</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;changes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-764"><a href="#-764"><span class="linenos">764</span></a>
</span><span id="TinkoffBrokerServer.SearchByFIGI-765"><a href="#-765"><span class="linenos">765</span></a>            <span class="k">if</span> <span class="n">showInfo</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-766"><a href="#-766"><span class="linenos">766</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">ShowInstrumentInfo</span><span class="p">(</span><span class="n">iJSON</span><span class="o">=</span><span class="n">figiJSON</span><span class="p">,</span> <span class="n">printInfo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># print info as Markdown text</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-767"><a href="#-767"><span class="linenos">767</span></a>
</span><span id="TinkoffBrokerServer.SearchByFIGI-768"><a href="#-768"><span class="linenos">768</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-769"><a href="#-769"><span class="linenos">769</span></a>            <span class="k">if</span> <span class="n">showInfo</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-770"><a href="#-770"><span class="linenos">770</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;FIGI [</span><span class="si">{}</span><span class="s2">] not found in available broker instrument&#39;s list!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.SearchByFIGI-771"><a href="#-771"><span class="linenos">771</span></a>
</span><span id="TinkoffBrokerServer.SearchByFIGI-772"><a href="#-772"><span class="linenos">772</span></a>        <span class="k">return</span> <span class="n">figiJSON</span>
</span></pre></div>


            <div class="docstring"><p>Search and return raw broker's information about instrument by it's FIGI.
<code><a href="#TinkoffBrokerServer.figi">figi</a></code> must be define! If debug=True then print all debug messages.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>requestPrice</strong>:  if <code>False</code> then do not request current price of instrument (it's long operation).</li>
<li><strong>showInfo</strong>:  if <code>False</code> then do not run <code><a href="#TinkoffBrokerServer.ShowInstrumentInfo">ShowInstrumentInfo()</a></code> method and do not print info to the console.</li>
<li><strong>debug</strong>:  if <code>True</code> then print all debug console messages.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>JSON formatted data with information about instrument.</p>
</blockquote>
</div>


                            </div>
                            <div id="TinkoffBrokerServer.GetCurrentPrices" class="classattr">
                                        <input id="TinkoffBrokerServer.GetCurrentPrices-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">GetCurrentPrices</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">showPrice</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="nb">dict</span>:</span></span>

                <label class="view-source-button" for="TinkoffBrokerServer.GetCurrentPrices-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.GetCurrentPrices"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TinkoffBrokerServer.GetCurrentPrices-774"><a href="#-774"><span class="linenos">774</span></a>    <span class="k">def</span> <span class="nf">GetCurrentPrices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">showPrice</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-775"><a href="#-775"><span class="linenos">775</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-776"><a href="#-776"><span class="linenos">776</span></a><span class="sd">        Get and show Depth of Market with current prices of the instrument. If an error occurred then returns an empty record:</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-777"><a href="#-777"><span class="linenos">777</span></a><span class="sd">        `{&quot;buy&quot;: [], &quot;sell&quot;: [], &quot;limitUp&quot;: None, &quot;limitDown&quot;: None, &quot;lastPrice&quot;: None, &quot;closePrice&quot;: None}`.</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-778"><a href="#-778"><span class="linenos">778</span></a>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-779"><a href="#-779"><span class="linenos">779</span></a><span class="sd">        :param showPrice: if `True` then print DOM.</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-780"><a href="#-780"><span class="linenos">780</span></a><span class="sd">        :return: dict with Depth of Market (DOM): `{&quot;buy&quot;: [{&quot;price&quot;: x1, &quot;quantity&quot;: y1, ...}], &quot;sell&quot;: [....]}` with list of current prices.</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-781"><a href="#-781"><span class="linenos">781</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-782"><a href="#-782"><span class="linenos">782</span></a>        <span class="n">prices</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;buy&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;sell&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;limitUp&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;limitDown&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;lastPrice&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;closePrice&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-783"><a href="#-783"><span class="linenos">783</span></a>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-784"><a href="#-784"><span class="linenos">784</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-785"><a href="#-785"><span class="linenos">785</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Depth of Market (DOM) must be &gt;=1!&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-786"><a href="#-786"><span class="linenos">786</span></a>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-787"><a href="#-787"><span class="linenos">787</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">):</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-788"><a href="#-788"><span class="linenos">788</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;self.ticker or self.figi variables must be defined!&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-789"><a href="#-789"><span class="linenos">789</span></a>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-790"><a href="#-790"><span class="linenos">790</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-791"><a href="#-791"><span class="linenos">791</span></a>            <span class="n">instrumentByTicker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SearchByTicker</span><span class="p">(</span><span class="n">requestPrice</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># WARNING! requestPrice=False to avoid recursion!</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-792"><a href="#-792"><span class="linenos">792</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">=</span> <span class="n">instrumentByTicker</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">instrumentByTicker</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-793"><a href="#-793"><span class="linenos">793</span></a>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-794"><a href="#-794"><span class="linenos">794</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-795"><a href="#-795"><span class="linenos">795</span></a>            <span class="n">instrumentByFigi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SearchByFIGI</span><span class="p">(</span><span class="n">requestPrice</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># WARNING! requestPrice=False to avoid recursion!</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-796"><a href="#-796"><span class="linenos">796</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">instrumentByFigi</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">instrumentByFigi</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-797"><a href="#-797"><span class="linenos">797</span></a>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-798"><a href="#-798"><span class="linenos">798</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-799"><a href="#-799"><span class="linenos">799</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Requesting current prices for instrument with ticker [</span><span class="si">{}</span><span class="s2">] and FIGI [</span><span class="si">{}</span><span class="s2">]...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-800"><a href="#-800"><span class="linenos">800</span></a>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-801"><a href="#-801"><span class="linenos">801</span></a>            <span class="c1"># REST API for request: https://tinkoff.github.io/investAPI/swagger-ui/#/MarketDataService/MarketDataService_GetOrderBook</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-802"><a href="#-802"><span class="linenos">802</span></a>            <span class="n">priceURL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;/tinkoff.public.invest.api.contract.v1.MarketDataService/GetOrderBook&quot;</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-803"><a href="#-803"><span class="linenos">803</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="nb">str</span><span class="p">({</span><span class="s2">&quot;figi&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">,</span> <span class="s2">&quot;depth&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">})</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-804"><a href="#-804"><span class="linenos">804</span></a>            <span class="n">pricesResponse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SendAPIRequest</span><span class="p">(</span><span class="n">priceURL</span><span class="p">,</span> <span class="n">reqType</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-805"><a href="#-805"><span class="linenos">805</span></a>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-806"><a href="#-806"><span class="linenos">806</span></a>            <span class="k">if</span> <span class="n">pricesResponse</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-807"><a href="#-807"><span class="linenos">807</span></a>                <span class="c1"># list of dicts with sellers orders:</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-808"><a href="#-808"><span class="linenos">808</span></a>                <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;buy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">]),</span> <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;quantity&quot;</span><span class="p">])}</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">pricesResponse</span><span class="p">[</span><span class="s2">&quot;asks&quot;</span><span class="p">]]</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-809"><a href="#-809"><span class="linenos">809</span></a>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-810"><a href="#-810"><span class="linenos">810</span></a>                <span class="c1"># list of dicts with buyers orders:</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-811"><a href="#-811"><span class="linenos">811</span></a>                <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;sell&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">]),</span> <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;quantity&quot;</span><span class="p">])}</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">pricesResponse</span><span class="p">[</span><span class="s2">&quot;bids&quot;</span><span class="p">]]</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-812"><a href="#-812"><span class="linenos">812</span></a>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-813"><a href="#-813"><span class="linenos">813</span></a>                <span class="c1"># max price of instrument at this time:</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-814"><a href="#-814"><span class="linenos">814</span></a>                <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;limitUp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">pricesResponse</span><span class="p">[</span><span class="s2">&quot;limitUp&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">pricesResponse</span><span class="p">[</span><span class="s2">&quot;limitUp&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;limitUp&quot;</span> <span class="ow">in</span> <span class="n">pricesResponse</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-815"><a href="#-815"><span class="linenos">815</span></a>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-816"><a href="#-816"><span class="linenos">816</span></a>                <span class="c1"># min price of instrument at this time:</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-817"><a href="#-817"><span class="linenos">817</span></a>                <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;limitDown&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">pricesResponse</span><span class="p">[</span><span class="s2">&quot;limitDown&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">pricesResponse</span><span class="p">[</span><span class="s2">&quot;limitDown&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;limitDown&quot;</span> <span class="ow">in</span> <span class="n">pricesResponse</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-818"><a href="#-818"><span class="linenos">818</span></a>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-819"><a href="#-819"><span class="linenos">819</span></a>                <span class="c1"># last price of deal with instrument:</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-820"><a href="#-820"><span class="linenos">820</span></a>                <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">pricesResponse</span><span class="p">[</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">pricesResponse</span><span class="p">[</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;lastPrice&quot;</span> <span class="ow">in</span> <span class="n">pricesResponse</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-821"><a href="#-821"><span class="linenos">821</span></a>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-822"><a href="#-822"><span class="linenos">822</span></a>                <span class="c1"># last close price of instrument:</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-823"><a href="#-823"><span class="linenos">823</span></a>                <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;closePrice&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">pricesResponse</span><span class="p">[</span><span class="s2">&quot;closePrice&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">pricesResponse</span><span class="p">[</span><span class="s2">&quot;closePrice&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;closePrice&quot;</span> <span class="ow">in</span> <span class="n">pricesResponse</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-824"><a href="#-824"><span class="linenos">824</span></a>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-825"><a href="#-825"><span class="linenos">825</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-826"><a href="#-826"><span class="linenos">826</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Server return an empty or error response! See full log. Instrument: ticker [</span><span class="si">{}</span><span class="s2">], FIGI [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-827"><a href="#-827"><span class="linenos">827</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Server response: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pricesResponse</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-828"><a href="#-828"><span class="linenos">828</span></a>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-829"><a href="#-829"><span class="linenos">829</span></a>            <span class="k">if</span> <span class="n">showPrice</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-830"><a href="#-830"><span class="linenos">830</span></a>                <span class="k">if</span> <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;buy&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;sell&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-831"><a href="#-831"><span class="linenos">831</span></a>                    <span class="n">info</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-832"><a href="#-832"><span class="linenos">832</span></a>                        <span class="s2">&quot;Orders book actual at [</span><span class="si">{}</span><span class="s2">] (UTC)</span><span class="se">\n</span><span class="s2">Ticker: [</span><span class="si">{}</span><span class="s2">], FIGI: [</span><span class="si">{}</span><span class="s2">], Depth of Market: [</span><span class="si">{}</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-833"><a href="#-833"><span class="linenos">833</span></a>                            <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tzutc</span><span class="p">())</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">),</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-834"><a href="#-834"><span class="linenos">834</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-835"><a href="#-835"><span class="linenos">835</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-836"><a href="#-836"><span class="linenos">836</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-837"><a href="#-837"><span class="linenos">837</span></a>                        <span class="p">),</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-838"><a href="#-838"><span class="linenos">838</span></a>                        <span class="n">uLog</span><span class="o">.</span><span class="n">sepShort</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-839"><a href="#-839"><span class="linenos">839</span></a>                        <span class="s2">&quot; Orders of Buyers   | Orders of Sellers</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-840"><a href="#-840"><span class="linenos">840</span></a>                        <span class="n">uLog</span><span class="o">.</span><span class="n">sepShort</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-841"><a href="#-841"><span class="linenos">841</span></a>                        <span class="s2">&quot; Sell prices (vol.) | Buy prices (vol.)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-842"><a href="#-842"><span class="linenos">842</span></a>                        <span class="n">uLog</span><span class="o">.</span><span class="n">sepShort</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-843"><a href="#-843"><span class="linenos">843</span></a>                    <span class="p">]</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-844"><a href="#-844"><span class="linenos">844</span></a>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-845"><a href="#-845"><span class="linenos">845</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;buy&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-846"><a href="#-846"><span class="linenos">846</span></a>                        <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;                    | No orders!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-847"><a href="#-847"><span class="linenos">847</span></a>                        <span class="n">sumBuy</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-848"><a href="#-848"><span class="linenos">848</span></a>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-849"><a href="#-849"><span class="linenos">849</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-850"><a href="#-850"><span class="linenos">850</span></a>                        <span class="n">sumBuy</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;quantity&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;buy&quot;</span><span class="p">]])</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-851"><a href="#-851"><span class="linenos">851</span></a>                        <span class="n">maxMinSorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">prices</span><span class="p">[</span><span class="s2">&quot;buy&quot;</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">k</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-852"><a href="#-852"><span class="linenos">852</span></a>                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">maxMinSorted</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-853"><a href="#-853"><span class="linenos">853</span></a>                            <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;                    | </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;quantity&quot;</span><span class="p">]))</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-854"><a href="#-854"><span class="linenos">854</span></a>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-855"><a href="#-855"><span class="linenos">855</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;sell&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-856"><a href="#-856"><span class="linenos">856</span></a>                        <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;No orders!          |</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-857"><a href="#-857"><span class="linenos">857</span></a>                        <span class="n">sumSell</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-858"><a href="#-858"><span class="linenos">858</span></a>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-859"><a href="#-859"><span class="linenos">859</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-860"><a href="#-860"><span class="linenos">860</span></a>                        <span class="n">sumSell</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;quantity&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;sell&quot;</span><span class="p">]])</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-861"><a href="#-861"><span class="linenos">861</span></a>                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">[</span><span class="s2">&quot;sell&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-862"><a href="#-862"><span class="linenos">862</span></a>                            <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:&gt;19}</span><span class="s2"> |</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;quantity&quot;</span><span class="p">])))</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-863"><a href="#-863"><span class="linenos">863</span></a>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-864"><a href="#-864"><span class="linenos">864</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-865"><a href="#-865"><span class="linenos">865</span></a>                        <span class="n">uLog</span><span class="o">.</span><span class="n">sepShort</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-866"><a href="#-866"><span class="linenos">866</span></a>                        <span class="s2">&quot;</span><span class="si">{:&gt;19}</span><span class="s2"> | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Total sell: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sumSell</span><span class="p">),</span> <span class="s2">&quot;Total buy: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sumBuy</span><span class="p">)),</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-867"><a href="#-867"><span class="linenos">867</span></a>                        <span class="n">uLog</span><span class="o">.</span><span class="n">sepShort</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-868"><a href="#-868"><span class="linenos">868</span></a>                    <span class="p">])</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-869"><a href="#-869"><span class="linenos">869</span></a>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-870"><a href="#-870"><span class="linenos">870</span></a>                    <span class="n">infoText</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-871"><a href="#-871"><span class="linenos">871</span></a>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-872"><a href="#-872"><span class="linenos">872</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Current prices in order book:</span><span class="se">\n\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">infoText</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-873"><a href="#-873"><span class="linenos">873</span></a>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-874"><a href="#-874"><span class="linenos">874</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-875"><a href="#-875"><span class="linenos">875</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Orders book is empty at this time! Instrument: ticker [</span><span class="si">{}</span><span class="s2">], FIGI [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-876"><a href="#-876"><span class="linenos">876</span></a>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-877"><a href="#-877"><span class="linenos">877</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-878"><a href="#-878"><span class="linenos">878</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;FIGI is not defined!&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-879"><a href="#-879"><span class="linenos">879</span></a>
</span><span id="TinkoffBrokerServer.GetCurrentPrices-880"><a href="#-880"><span class="linenos">880</span></a>        <span class="k">return</span> <span class="n">prices</span>
</span></pre></div>


            <div class="docstring"><p>Get and show Depth of Market with current prices of the instrument. If an error occurred then returns an empty record:
<code>{"buy": [], "sell": [], "limitUp": None, "limitDown": None, "lastPrice": None, "closePrice": None}</code>.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>showPrice</strong>:  if <code>True</code> then print DOM.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>dict with Depth of Market (DOM): <code>{"buy": [{"price": x1, "quantity": y1, ...}], "sell": [....]}</code> with list of current prices.</p>
</blockquote>
</div>


                            </div>
                            <div id="TinkoffBrokerServer.ShowInstrumentsInfo" class="classattr">
                                        <input id="TinkoffBrokerServer.ShowInstrumentsInfo-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">ShowInstrumentsInfo</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">showInstruments</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="TinkoffBrokerServer.ShowInstrumentsInfo-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.ShowInstrumentsInfo"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-882"><a href="#-882"><span class="linenos">882</span></a>    <span class="k">def</span> <span class="nf">ShowInstrumentsInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">showInstruments</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-883"><a href="#-883"><span class="linenos">883</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-884"><a href="#-884"><span class="linenos">884</span></a><span class="sd">        This method get and show information about all available broker instruments.</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-885"><a href="#-885"><span class="linenos">885</span></a><span class="sd">        If `instrumentsFile` string is not empty then also save information to this file.</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-886"><a href="#-886"><span class="linenos">886</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-887"><a href="#-887"><span class="linenos">887</span></a><span class="sd">        :param showInstruments: if `True` then print to console, if `False` - print only to file.</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-888"><a href="#-888"><span class="linenos">888</span></a><span class="sd">        :return: multi-string with all available broker instruments</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-889"><a href="#-889"><span class="linenos">889</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-890"><a href="#-890"><span class="linenos">890</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-891"><a href="#-891"><span class="linenos">891</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">iList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Listing</span><span class="p">()</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-892"><a href="#-892"><span class="linenos">892</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-893"><a href="#-893"><span class="linenos">893</span></a>        <span class="n">info</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-894"><a href="#-894"><span class="linenos">894</span></a>            <span class="s2">&quot;# All available instruments from Tinkoff Broker server for current user token</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-895"><a href="#-895"><span class="linenos">895</span></a>            <span class="s2">&quot;* **Actual on date:** [</span><span class="si">{}</span><span class="s2">] (UTC)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tzutc</span><span class="p">())</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M&quot;</span><span class="p">)),</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-896"><a href="#-896"><span class="linenos">896</span></a>        <span class="p">]</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-897"><a href="#-897"><span class="linenos">897</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-898"><a href="#-898"><span class="linenos">898</span></a>        <span class="c1"># add instruments count by type:</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-899"><a href="#-899"><span class="linenos">899</span></a>        <span class="k">for</span> <span class="n">iType</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-900"><a href="#-900"><span class="linenos">900</span></a>            <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;* **</span><span class="si">{}</span><span class="s2">:** [</span><span class="si">{}</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iType</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">])))</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-901"><a href="#-901"><span class="linenos">901</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-902"><a href="#-902"><span class="linenos">902</span></a>        <span class="n">headerLine</span> <span class="o">=</span> <span class="s2">&quot;| Ticker       | Full name                                                      | FIGI         | Cur | Lot    | Step</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-903"><a href="#-903"><span class="linenos">903</span></a>        <span class="n">splitLine</span> <span class="o">=</span> <span class="s2">&quot;|--------------|----------------------------------------------------------------|--------------|-----|--------|---------</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-904"><a href="#-904"><span class="linenos">904</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-905"><a href="#-905"><span class="linenos">905</span></a>        <span class="c1"># generate info tables with all instruments by type:</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-906"><a href="#-906"><span class="linenos">906</span></a>        <span class="k">for</span> <span class="n">iType</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-907"><a href="#-907"><span class="linenos">907</span></a>            <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">## </span><span class="si">{}</span><span class="s2"> available. Total: [</span><span class="si">{}</span><span class="s2">]</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iType</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">])),</span> <span class="n">headerLine</span><span class="p">,</span> <span class="n">splitLine</span><span class="p">])</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-908"><a href="#-908"><span class="linenos">908</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-909"><a href="#-909"><span class="linenos">909</span></a>            <span class="k">for</span> <span class="n">instrument</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-910"><a href="#-910"><span class="linenos">910</span></a>                <span class="n">iName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">][</span><span class="n">instrument</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>  <span class="c1"># instrument&#39;s name</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-911"><a href="#-911"><span class="linenos">911</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">iName</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">63</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-912"><a href="#-912"><span class="linenos">912</span></a>                    <span class="n">iName</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iName</span><span class="p">[:</span><span class="mi">60</span><span class="p">])</span>  <span class="c1"># right trim for a long string</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-913"><a href="#-913"><span class="linenos">913</span></a>    
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-914"><a href="#-914"><span class="linenos">914</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| </span><span class="si">{:&lt;12}</span><span class="s2"> | </span><span class="si">{:&lt;63}</span><span class="s2">| </span><span class="si">{:&lt;13}</span><span class="s2">| </span><span class="si">{:&lt;4}</span><span class="s2">| </span><span class="si">{:&lt;7}</span><span class="s2">| </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-915"><a href="#-915"><span class="linenos">915</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">][</span><span class="n">instrument</span><span class="p">][</span><span class="s2">&quot;ticker&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-916"><a href="#-916"><span class="linenos">916</span></a>                    <span class="n">iName</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-917"><a href="#-917"><span class="linenos">917</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">][</span><span class="n">instrument</span><span class="p">][</span><span class="s2">&quot;figi&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-918"><a href="#-918"><span class="linenos">918</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">][</span><span class="n">instrument</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-919"><a href="#-919"><span class="linenos">919</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">][</span><span class="n">instrument</span><span class="p">][</span><span class="s2">&quot;lot&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-920"><a href="#-920"><span class="linenos">920</span></a>                    <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iList</span><span class="p">[</span><span class="n">iType</span><span class="p">][</span><span class="n">instrument</span><span class="p">][</span><span class="s2">&quot;step&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">),</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-921"><a href="#-921"><span class="linenos">921</span></a>                <span class="p">))</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-922"><a href="#-922"><span class="linenos">922</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-923"><a href="#-923"><span class="linenos">923</span></a>        <span class="n">infoText</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-924"><a href="#-924"><span class="linenos">924</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-925"><a href="#-925"><span class="linenos">925</span></a>        <span class="k">if</span> <span class="n">showInstruments</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-926"><a href="#-926"><span class="linenos">926</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">infoText</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-927"><a href="#-927"><span class="linenos">927</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-928"><a href="#-928"><span class="linenos">928</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrumentsFile</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-929"><a href="#-929"><span class="linenos">929</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instrumentsFile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fH</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-930"><a href="#-930"><span class="linenos">930</span></a>                <span class="n">fH</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">infoText</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-931"><a href="#-931"><span class="linenos">931</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-932"><a href="#-932"><span class="linenos">932</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;All available instruments are saved to file: [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instrumentsFile</span><span class="p">)))</span>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-933"><a href="#-933"><span class="linenos">933</span></a>
</span><span id="TinkoffBrokerServer.ShowInstrumentsInfo-934"><a href="#-934"><span class="linenos">934</span></a>        <span class="k">return</span> <span class="n">infoText</span>
</span></pre></div>


            <div class="docstring"><p>This method get and show information about all available broker instruments.
If <code><a href="#TinkoffBrokerServer.instrumentsFile">instrumentsFile</a></code> string is not empty then also save information to this file.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>showInstruments</strong>:  if <code>True</code> then print to console, if <code>False</code> - print only to file.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>multi-string with all available broker instruments</p>
</blockquote>
</div>


                            </div>
                            <div id="TinkoffBrokerServer.GetListOfPrices" class="classattr">
                                        <input id="TinkoffBrokerServer.GetListOfPrices-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">GetListOfPrices</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">instruments</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span>, </span><span class="param"><span class="n">showPrices</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="nb">list</span>:</span></span>

                <label class="view-source-button" for="TinkoffBrokerServer.GetListOfPrices-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.GetListOfPrices"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TinkoffBrokerServer.GetListOfPrices-936"><a href="#-936"><span class="linenos"> 936</span></a>    <span class="k">def</span> <span class="nf">GetListOfPrices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instruments</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">showPrices</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-937"><a href="#-937"><span class="linenos"> 937</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-938"><a href="#-938"><span class="linenos"> 938</span></a><span class="sd">        This method get, maybe show and return prices of list of instruments. WARNING! This is potential long operation!</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-939"><a href="#-939"><span class="linenos"> 939</span></a><span class="sd">        See limits: https://tinkoff.github.io/investAPI/limits/</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-940"><a href="#-940"><span class="linenos"> 940</span></a><span class="sd">        If `pricesFile` string is not empty then also save information to this file.</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-941"><a href="#-941"><span class="linenos"> 941</span></a>
</span><span id="TinkoffBrokerServer.GetListOfPrices-942"><a href="#-942"><span class="linenos"> 942</span></a><span class="sd">        :param instruments: list of tickers or FIGIs.</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-943"><a href="#-943"><span class="linenos"> 943</span></a><span class="sd">        :param showPrices: if `True` then print to console, if `False` - print only to file.</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-944"><a href="#-944"><span class="linenos"> 944</span></a><span class="sd">        :return: list of instruments looks like this: `iList = [{some ticker info, &quot;currentPrice&quot;: {current prices}}, {...}, ...]`</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-945"><a href="#-945"><span class="linenos"> 945</span></a><span class="sd">                 One item is dict returned by `SearchByTicker()` or `SearchByFIGI()` methods.</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-946"><a href="#-946"><span class="linenos"> 946</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-947"><a href="#-947"><span class="linenos"> 947</span></a>        <span class="k">if</span> <span class="n">instruments</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">instruments</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-948"><a href="#-948"><span class="linenos"> 948</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;You must define some of tickers or FIGIs to request it&#39;s actual prices!&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-949"><a href="#-949"><span class="linenos"> 949</span></a>
</span><span id="TinkoffBrokerServer.GetListOfPrices-950"><a href="#-950"><span class="linenos"> 950</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Requesting current prices of list of instruments from Tinkoff Broker server...&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-951"><a href="#-951"><span class="linenos"> 951</span></a>
</span><span id="TinkoffBrokerServer.GetListOfPrices-952"><a href="#-952"><span class="linenos"> 952</span></a>        <span class="n">iList</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-953"><a href="#-953"><span class="linenos"> 953</span></a>        <span class="k">for</span> <span class="n">iName</span> <span class="ow">in</span> <span class="n">instruments</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-954"><a href="#-954"><span class="linenos"> 954</span></a>            <span class="k">if</span> <span class="n">iName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">aliases</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-955"><a href="#-955"><span class="linenos"> 955</span></a>                <span class="n">iList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iName</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-956"><a href="#-956"><span class="linenos"> 956</span></a>
</span><span id="TinkoffBrokerServer.GetListOfPrices-957"><a href="#-957"><span class="linenos"> 957</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-958"><a href="#-958"><span class="linenos"> 958</span></a>                <span class="n">iList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aliases</span><span class="p">[</span><span class="n">iName</span><span class="p">])</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-959"><a href="#-959"><span class="linenos"> 959</span></a>
</span><span id="TinkoffBrokerServer.GetListOfPrices-960"><a href="#-960"><span class="linenos"> 960</span></a>        <span class="n">unique</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># create list with every figi only one time with the same order position:</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-961"><a href="#-961"><span class="linenos"> 961</span></a>        <span class="n">tempNames</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">iList</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">item</span> <span class="ow">in</span> <span class="n">unique</span> <span class="ow">or</span> <span class="n">unique</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">))]</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-962"><a href="#-962"><span class="linenos"> 962</span></a>
</span><span id="TinkoffBrokerServer.GetListOfPrices-963"><a href="#-963"><span class="linenos"> 963</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Ordered input list of instruments without duplicates of names: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tempNames</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-964"><a href="#-964"><span class="linenos"> 964</span></a>
</span><span id="TinkoffBrokerServer.GetListOfPrices-965"><a href="#-965"><span class="linenos"> 965</span></a>        <span class="n">iList</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># try to get info about all unique instruments:</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-966"><a href="#-966"><span class="linenos"> 966</span></a>        <span class="k">for</span> <span class="n">iName</span> <span class="ow">in</span> <span class="n">tempNames</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-967"><a href="#-967"><span class="linenos"> 967</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">iName</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-968"><a href="#-968"><span class="linenos"> 968</span></a>            <span class="n">iData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SearchByTicker</span><span class="p">(</span><span class="n">requestPrice</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-969"><a href="#-969"><span class="linenos"> 969</span></a>
</span><span id="TinkoffBrokerServer.GetListOfPrices-970"><a href="#-970"><span class="linenos"> 970</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">iData</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-971"><a href="#-971"><span class="linenos"> 971</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-972"><a href="#-972"><span class="linenos"> 972</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">=</span> <span class="n">iName</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-973"><a href="#-973"><span class="linenos"> 973</span></a>
</span><span id="TinkoffBrokerServer.GetListOfPrices-974"><a href="#-974"><span class="linenos"> 974</span></a>                <span class="n">iData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SearchByFIGI</span><span class="p">(</span><span class="n">requestPrice</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-975"><a href="#-975"><span class="linenos"> 975</span></a>
</span><span id="TinkoffBrokerServer.GetListOfPrices-976"><a href="#-976"><span class="linenos"> 976</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">iData</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-977"><a href="#-977"><span class="linenos"> 977</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-978"><a href="#-978"><span class="linenos"> 978</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Instrument [</span><span class="si">{}</span><span class="s2">] not in list of available instruments for current token!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iName</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-979"><a href="#-979"><span class="linenos"> 979</span></a>
</span><span id="TinkoffBrokerServer.GetListOfPrices-980"><a href="#-980"><span class="linenos"> 980</span></a>            <span class="k">if</span> <span class="n">iData</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-981"><a href="#-981"><span class="linenos"> 981</span></a>                <span class="n">isUnique</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-982"><a href="#-982"><span class="linenos"> 982</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">iList</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-983"><a href="#-983"><span class="linenos"> 983</span></a>                    <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">iData</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">iData</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-984"><a href="#-984"><span class="linenos"> 984</span></a>                        <span class="n">isUnique</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-985"><a href="#-985"><span class="linenos"> 985</span></a>                        <span class="k">break</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-986"><a href="#-986"><span class="linenos"> 986</span></a>
</span><span id="TinkoffBrokerServer.GetListOfPrices-987"><a href="#-987"><span class="linenos"> 987</span></a>                <span class="k">if</span> <span class="n">isUnique</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-988"><a href="#-988"><span class="linenos"> 988</span></a>                    <span class="n">iList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iData</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-989"><a href="#-989"><span class="linenos"> 989</span></a>
</span><span id="TinkoffBrokerServer.GetListOfPrices-990"><a href="#-990"><span class="linenos"> 990</span></a>        <span class="k">if</span> <span class="n">showPrices</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-991"><a href="#-991"><span class="linenos"> 991</span></a>            <span class="n">info</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-992"><a href="#-992"><span class="linenos"> 992</span></a>                <span class="s2">&quot;# Actual prices at: [</span><span class="si">{}</span><span class="s2"> UTC]</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tzutc</span><span class="p">())</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M&quot;</span><span class="p">)),</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-993"><a href="#-993"><span class="linenos"> 993</span></a>                <span class="s2">&quot;| Ticker       | FIGI         | Type       | Prev. close | Last price  | Chg. %   | Day limits min/max  | Actual sell / buy   | Curr.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-994"><a href="#-994"><span class="linenos"> 994</span></a>                <span class="s2">&quot;|--------------|--------------|------------|-------------|-------------|----------|---------------------|---------------------|------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-995"><a href="#-995"><span class="linenos"> 995</span></a>            <span class="p">]</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-996"><a href="#-996"><span class="linenos"> 996</span></a>
</span><span id="TinkoffBrokerServer.GetListOfPrices-997"><a href="#-997"><span class="linenos"> 997</span></a>            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">iList</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-998"><a href="#-998"><span class="linenos"> 998</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| </span><span class="si">{:&lt;12}</span><span class="s2"> | </span><span class="si">{:&lt;12}</span><span class="s2"> | </span><span class="si">{:&lt;10}</span><span class="s2"> | </span><span class="si">{:&gt;11}</span><span class="s2"> | </span><span class="si">{:&gt;11}</span><span class="s2"> | </span><span class="si">{:&gt;7}</span><span class="s2">% | </span><span class="si">{:&gt;19}</span><span class="s2"> | </span><span class="si">{:&gt;19}</span><span class="s2"> | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-999"><a href="#-999"><span class="linenos"> 999</span></a>                    <span class="n">item</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-1000"><a href="#-1000"><span class="linenos">1000</span></a>                    <span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-1001"><a href="#-1001"><span class="linenos">1001</span></a>                    <span class="n">item</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-1002"><a href="#-1002"><span class="linenos">1002</span></a>                    <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;closePrice&quot;</span><span class="p">])),</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-1003"><a href="#-1003"><span class="linenos">1003</span></a>                    <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">])),</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-1004"><a href="#-1004"><span class="linenos">1004</span></a>                    <span class="s2">&quot;</span><span class="si">{}{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;changes&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;changes&quot;</span><span class="p">])),</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-1005"><a href="#-1005"><span class="linenos">1005</span></a>                    <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> / </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-1006"><a href="#-1006"><span class="linenos">1006</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;limitDown&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;limitDown&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-1007"><a href="#-1007"><span class="linenos">1007</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;limitUp&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;limitUp&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-1008"><a href="#-1008"><span class="linenos">1008</span></a>                    <span class="p">),</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-1009"><a href="#-1009"><span class="linenos">1009</span></a>                    <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> / </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-1010"><a href="#-1010"><span class="linenos">1010</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;sell&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;price&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;sell&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-1011"><a href="#-1011"><span class="linenos">1011</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;buy&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;price&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;buy&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-1012"><a href="#-1012"><span class="linenos">1012</span></a>                    <span class="p">),</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-1013"><a href="#-1013"><span class="linenos">1013</span></a>                    <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-1014"><a href="#-1014"><span class="linenos">1014</span></a>                <span class="p">))</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-1015"><a href="#-1015"><span class="linenos">1015</span></a>
</span><span id="TinkoffBrokerServer.GetListOfPrices-1016"><a href="#-1016"><span class="linenos">1016</span></a>            <span class="n">infoText</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-1017"><a href="#-1017"><span class="linenos">1017</span></a>
</span><span id="TinkoffBrokerServer.GetListOfPrices-1018"><a href="#-1018"><span class="linenos">1018</span></a>            <span class="k">if</span> <span class="n">showPrices</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-1019"><a href="#-1019"><span class="linenos">1019</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Only unique instruments are shown:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">infoText</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-1020"><a href="#-1020"><span class="linenos">1020</span></a>
</span><span id="TinkoffBrokerServer.GetListOfPrices-1021"><a href="#-1021"><span class="linenos">1021</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pricesFile</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-1022"><a href="#-1022"><span class="linenos">1022</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pricesFile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fH</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-1023"><a href="#-1023"><span class="linenos">1023</span></a>                    <span class="n">fH</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">infoText</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-1024"><a href="#-1024"><span class="linenos">1024</span></a>
</span><span id="TinkoffBrokerServer.GetListOfPrices-1025"><a href="#-1025"><span class="linenos">1025</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Price list for all instruments saved to file: [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pricesFile</span><span class="p">)))</span>
</span><span id="TinkoffBrokerServer.GetListOfPrices-1026"><a href="#-1026"><span class="linenos">1026</span></a>
</span><span id="TinkoffBrokerServer.GetListOfPrices-1027"><a href="#-1027"><span class="linenos">1027</span></a>        <span class="k">return</span> <span class="n">iList</span>
</span></pre></div>


            <div class="docstring"><p>This method get, maybe show and return prices of list of instruments. WARNING! This is potential long operation!
See limits: <a href="https://tinkoff.github.io/investAPI/limits/">https://tinkoff.github.io/investAPI/limits/</a>
If <code><a href="#TinkoffBrokerServer.pricesFile">pricesFile</a></code> string is not empty then also save information to this file.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>instruments</strong>:  list of tickers or FIGIs.</li>
<li><strong>showPrices</strong>:  if <code>True</code> then print to console, if <code>False</code> - print only to file.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>list of instruments looks like this: <code>iList = [{some ticker info, "currentPrice": {current prices}}, {...}, ...]</code>
           One item is dict returned by <code><a href="#TinkoffBrokerServer.SearchByTicker">SearchByTicker()</a></code> or <code><a href="#TinkoffBrokerServer.SearchByFIGI">SearchByFIGI()</a></code> methods.</p>
</blockquote>
</div>


                            </div>
                            <div id="TinkoffBrokerServer.RequestPortfolio" class="classattr">
                                        <input id="TinkoffBrokerServer.RequestPortfolio-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">RequestPortfolio</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">dict</span>:</span></span>

                <label class="view-source-button" for="TinkoffBrokerServer.RequestPortfolio-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.RequestPortfolio"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TinkoffBrokerServer.RequestPortfolio-1029"><a href="#-1029"><span class="linenos">1029</span></a>    <span class="k">def</span> <span class="nf">RequestPortfolio</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.RequestPortfolio-1030"><a href="#-1030"><span class="linenos">1030</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.RequestPortfolio-1031"><a href="#-1031"><span class="linenos">1031</span></a><span class="sd">        Requesting current actual user&#39;s portfolio.</span>
</span><span id="TinkoffBrokerServer.RequestPortfolio-1032"><a href="#-1032"><span class="linenos">1032</span></a><span class="sd">        REST API for user portfolio: https://tinkoff.github.io/investAPI/swagger-ui/#/OperationsService/OperationsService_GetPortfolio</span>
</span><span id="TinkoffBrokerServer.RequestPortfolio-1033"><a href="#-1033"><span class="linenos">1033</span></a>
</span><span id="TinkoffBrokerServer.RequestPortfolio-1034"><a href="#-1034"><span class="linenos">1034</span></a><span class="sd">        :return: dictionary with user&#39;s portfolio.</span>
</span><span id="TinkoffBrokerServer.RequestPortfolio-1035"><a href="#-1035"><span class="linenos">1035</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.RequestPortfolio-1036"><a href="#-1036"><span class="linenos">1036</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Requesting current actual user&#39;s portfolio. Wait, please...&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.RequestPortfolio-1037"><a href="#-1037"><span class="linenos">1037</span></a>
</span><span id="TinkoffBrokerServer.RequestPortfolio-1038"><a href="#-1038"><span class="linenos">1038</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="nb">str</span><span class="p">({</span><span class="s2">&quot;accountId&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">accountId</span><span class="p">})</span>
</span><span id="TinkoffBrokerServer.RequestPortfolio-1039"><a href="#-1039"><span class="linenos">1039</span></a>        <span class="n">portfolioURL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;/tinkoff.public.invest.api.contract.v1.OperationsService/GetPortfolio&quot;</span>
</span><span id="TinkoffBrokerServer.RequestPortfolio-1040"><a href="#-1040"><span class="linenos">1040</span></a>        <span class="n">rawPortfolio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SendAPIRequest</span><span class="p">(</span><span class="n">portfolioURL</span><span class="p">,</span> <span class="n">reqType</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.RequestPortfolio-1041"><a href="#-1041"><span class="linenos">1041</span></a>
</span><span id="TinkoffBrokerServer.RequestPortfolio-1042"><a href="#-1042"><span class="linenos">1042</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Records about user&#39;s portfolio successfully received&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.RequestPortfolio-1043"><a href="#-1043"><span class="linenos">1043</span></a>
</span><span id="TinkoffBrokerServer.RequestPortfolio-1044"><a href="#-1044"><span class="linenos">1044</span></a>        <span class="k">return</span> <span class="n">rawPortfolio</span>
</span></pre></div>


            <div class="docstring"><p>Requesting current actual user's portfolio.
REST API for user portfolio: <a href="https://tinkoff.github.io/investAPI/swagger-ui/#/OperationsService/OperationsService_GetPortfolio">https://tinkoff.github.io/investAPI/swagger-ui/#/OperationsService/OperationsService_GetPortfolio</a></p>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>dictionary with user's portfolio.</p>
</blockquote>
</div>


                            </div>
                            <div id="TinkoffBrokerServer.RequestPositions" class="classattr">
                                        <input id="TinkoffBrokerServer.RequestPositions-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">RequestPositions</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">dict</span>:</span></span>

                <label class="view-source-button" for="TinkoffBrokerServer.RequestPositions-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.RequestPositions"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TinkoffBrokerServer.RequestPositions-1046"><a href="#-1046"><span class="linenos">1046</span></a>    <span class="k">def</span> <span class="nf">RequestPositions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.RequestPositions-1047"><a href="#-1047"><span class="linenos">1047</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.RequestPositions-1048"><a href="#-1048"><span class="linenos">1048</span></a><span class="sd">        Requesting current open positions in currencies and instruments.</span>
</span><span id="TinkoffBrokerServer.RequestPositions-1049"><a href="#-1049"><span class="linenos">1049</span></a><span class="sd">        REST API for open positions: https://tinkoff.github.io/investAPI/swagger-ui/#/OperationsService/OperationsService_GetPositions</span>
</span><span id="TinkoffBrokerServer.RequestPositions-1050"><a href="#-1050"><span class="linenos">1050</span></a>
</span><span id="TinkoffBrokerServer.RequestPositions-1051"><a href="#-1051"><span class="linenos">1051</span></a><span class="sd">        :return: dictionary with open positions by instruments.</span>
</span><span id="TinkoffBrokerServer.RequestPositions-1052"><a href="#-1052"><span class="linenos">1052</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.RequestPositions-1053"><a href="#-1053"><span class="linenos">1053</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Requesting current open positions in currencies and instruments. Wait, please...&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.RequestPositions-1054"><a href="#-1054"><span class="linenos">1054</span></a>
</span><span id="TinkoffBrokerServer.RequestPositions-1055"><a href="#-1055"><span class="linenos">1055</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="nb">str</span><span class="p">({</span><span class="s2">&quot;accountId&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">accountId</span><span class="p">})</span>
</span><span id="TinkoffBrokerServer.RequestPositions-1056"><a href="#-1056"><span class="linenos">1056</span></a>        <span class="n">positionsURL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;/tinkoff.public.invest.api.contract.v1.OperationsService/GetPositions&quot;</span>
</span><span id="TinkoffBrokerServer.RequestPositions-1057"><a href="#-1057"><span class="linenos">1057</span></a>        <span class="n">rawPositions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SendAPIRequest</span><span class="p">(</span><span class="n">positionsURL</span><span class="p">,</span> <span class="n">reqType</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.RequestPositions-1058"><a href="#-1058"><span class="linenos">1058</span></a>
</span><span id="TinkoffBrokerServer.RequestPositions-1059"><a href="#-1059"><span class="linenos">1059</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Records about current open positions successfully received&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.RequestPositions-1060"><a href="#-1060"><span class="linenos">1060</span></a>
</span><span id="TinkoffBrokerServer.RequestPositions-1061"><a href="#-1061"><span class="linenos">1061</span></a>        <span class="k">return</span> <span class="n">rawPositions</span>
</span></pre></div>


            <div class="docstring"><p>Requesting current open positions in currencies and instruments.
REST API for open positions: <a href="https://tinkoff.github.io/investAPI/swagger-ui/#/OperationsService/OperationsService_GetPositions">https://tinkoff.github.io/investAPI/swagger-ui/#/OperationsService/OperationsService_GetPositions</a></p>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>dictionary with open positions by instruments.</p>
</blockquote>
</div>


                            </div>
                            <div id="TinkoffBrokerServer.RequestPendingOrders" class="classattr">
                                        <input id="TinkoffBrokerServer.RequestPendingOrders-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">RequestPendingOrders</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">list</span>:</span></span>

                <label class="view-source-button" for="TinkoffBrokerServer.RequestPendingOrders-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.RequestPendingOrders"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TinkoffBrokerServer.RequestPendingOrders-1063"><a href="#-1063"><span class="linenos">1063</span></a>    <span class="k">def</span> <span class="nf">RequestPendingOrders</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.RequestPendingOrders-1064"><a href="#-1064"><span class="linenos">1064</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.RequestPendingOrders-1065"><a href="#-1065"><span class="linenos">1065</span></a><span class="sd">        Requesting current actual pending orders.</span>
</span><span id="TinkoffBrokerServer.RequestPendingOrders-1066"><a href="#-1066"><span class="linenos">1066</span></a><span class="sd">        REST API for pending (market) orders: https://tinkoff.github.io/investAPI/swagger-ui/#/OrdersService/OrdersService_GetOrders</span>
</span><span id="TinkoffBrokerServer.RequestPendingOrders-1067"><a href="#-1067"><span class="linenos">1067</span></a>
</span><span id="TinkoffBrokerServer.RequestPendingOrders-1068"><a href="#-1068"><span class="linenos">1068</span></a><span class="sd">        :return: list of dictionaries with pending orders.</span>
</span><span id="TinkoffBrokerServer.RequestPendingOrders-1069"><a href="#-1069"><span class="linenos">1069</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.RequestPendingOrders-1070"><a href="#-1070"><span class="linenos">1070</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Requesting current actual pending orders. Wait, please...&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.RequestPendingOrders-1071"><a href="#-1071"><span class="linenos">1071</span></a>
</span><span id="TinkoffBrokerServer.RequestPendingOrders-1072"><a href="#-1072"><span class="linenos">1072</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="nb">str</span><span class="p">({</span><span class="s2">&quot;accountId&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">accountId</span><span class="p">})</span>
</span><span id="TinkoffBrokerServer.RequestPendingOrders-1073"><a href="#-1073"><span class="linenos">1073</span></a>        <span class="n">ordersURL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;/tinkoff.public.invest.api.contract.v1.OrdersService/GetOrders&quot;</span>
</span><span id="TinkoffBrokerServer.RequestPendingOrders-1074"><a href="#-1074"><span class="linenos">1074</span></a>        <span class="n">rawOrders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SendAPIRequest</span><span class="p">(</span><span class="n">ordersURL</span><span class="p">,</span> <span class="n">reqType</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">)[</span><span class="s2">&quot;orders&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer.RequestPendingOrders-1075"><a href="#-1075"><span class="linenos">1075</span></a>
</span><span id="TinkoffBrokerServer.RequestPendingOrders-1076"><a href="#-1076"><span class="linenos">1076</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">] records about pending orders successfully received&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rawOrders</span><span class="p">)))</span>
</span><span id="TinkoffBrokerServer.RequestPendingOrders-1077"><a href="#-1077"><span class="linenos">1077</span></a>
</span><span id="TinkoffBrokerServer.RequestPendingOrders-1078"><a href="#-1078"><span class="linenos">1078</span></a>        <span class="k">return</span> <span class="n">rawOrders</span>
</span></pre></div>


            <div class="docstring"><p>Requesting current actual pending orders.
REST API for pending (market) orders: <a href="https://tinkoff.github.io/investAPI/swagger-ui/#/OrdersService/OrdersService_GetOrders">https://tinkoff.github.io/investAPI/swagger-ui/#/OrdersService/OrdersService_GetOrders</a></p>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>list of dictionaries with pending orders.</p>
</blockquote>
</div>


                            </div>
                            <div id="TinkoffBrokerServer.RequestStopOrders" class="classattr">
                                        <input id="TinkoffBrokerServer.RequestStopOrders-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">RequestStopOrders</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">list</span>:</span></span>

                <label class="view-source-button" for="TinkoffBrokerServer.RequestStopOrders-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.RequestStopOrders"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TinkoffBrokerServer.RequestStopOrders-1080"><a href="#-1080"><span class="linenos">1080</span></a>    <span class="k">def</span> <span class="nf">RequestStopOrders</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.RequestStopOrders-1081"><a href="#-1081"><span class="linenos">1081</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.RequestStopOrders-1082"><a href="#-1082"><span class="linenos">1082</span></a><span class="sd">        Requesting current actual stop orders.</span>
</span><span id="TinkoffBrokerServer.RequestStopOrders-1083"><a href="#-1083"><span class="linenos">1083</span></a><span class="sd">        REST API for opened stop-orders: https://tinkoff.github.io/investAPI/swagger-ui/#/StopOrdersService/StopOrdersService_GetStopOrders</span>
</span><span id="TinkoffBrokerServer.RequestStopOrders-1084"><a href="#-1084"><span class="linenos">1084</span></a>
</span><span id="TinkoffBrokerServer.RequestStopOrders-1085"><a href="#-1085"><span class="linenos">1085</span></a><span class="sd">        :return: list of dictionaries with stop orders.</span>
</span><span id="TinkoffBrokerServer.RequestStopOrders-1086"><a href="#-1086"><span class="linenos">1086</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.RequestStopOrders-1087"><a href="#-1087"><span class="linenos">1087</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Requesting current actual stop orders. Wait, please...&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.RequestStopOrders-1088"><a href="#-1088"><span class="linenos">1088</span></a>
</span><span id="TinkoffBrokerServer.RequestStopOrders-1089"><a href="#-1089"><span class="linenos">1089</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="nb">str</span><span class="p">({</span><span class="s2">&quot;accountId&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">accountId</span><span class="p">})</span>
</span><span id="TinkoffBrokerServer.RequestStopOrders-1090"><a href="#-1090"><span class="linenos">1090</span></a>        <span class="n">ordersURL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;/tinkoff.public.invest.api.contract.v1.StopOrdersService/GetStopOrders&quot;</span>
</span><span id="TinkoffBrokerServer.RequestStopOrders-1091"><a href="#-1091"><span class="linenos">1091</span></a>        <span class="n">rawStopOrders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SendAPIRequest</span><span class="p">(</span><span class="n">ordersURL</span><span class="p">,</span> <span class="n">reqType</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">)[</span><span class="s2">&quot;stopOrders&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer.RequestStopOrders-1092"><a href="#-1092"><span class="linenos">1092</span></a>
</span><span id="TinkoffBrokerServer.RequestStopOrders-1093"><a href="#-1093"><span class="linenos">1093</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">] records about stop orders successfully received&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rawStopOrders</span><span class="p">)))</span>
</span><span id="TinkoffBrokerServer.RequestStopOrders-1094"><a href="#-1094"><span class="linenos">1094</span></a>
</span><span id="TinkoffBrokerServer.RequestStopOrders-1095"><a href="#-1095"><span class="linenos">1095</span></a>        <span class="k">return</span> <span class="n">rawStopOrders</span>
</span></pre></div>


            <div class="docstring"><p>Requesting current actual stop orders.
REST API for opened stop-orders: <a href="https://tinkoff.github.io/investAPI/swagger-ui/#/StopOrdersService/StopOrdersService_GetStopOrders">https://tinkoff.github.io/investAPI/swagger-ui/#/StopOrdersService/StopOrdersService_GetStopOrders</a></p>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>list of dictionaries with stop orders.</p>
</blockquote>
</div>


                            </div>
                            <div id="TinkoffBrokerServer.Overview" class="classattr">
                                        <input id="TinkoffBrokerServer.Overview-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">Overview</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">showStatistics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="nb">dict</span>:</span></span>

                <label class="view-source-button" for="TinkoffBrokerServer.Overview-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.Overview"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TinkoffBrokerServer.Overview-1097"><a href="#-1097"><span class="linenos">1097</span></a>    <span class="k">def</span> <span class="nf">Overview</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">showStatistics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1098"><a href="#-1098"><span class="linenos">1098</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.Overview-1099"><a href="#-1099"><span class="linenos">1099</span></a><span class="sd">        Get portfolio: all open positions, orders and some statistics for defined accountId.</span>
</span><span id="TinkoffBrokerServer.Overview-1100"><a href="#-1100"><span class="linenos">1100</span></a><span class="sd">        If `overviewFile` is define then also save information to file.</span>
</span><span id="TinkoffBrokerServer.Overview-1101"><a href="#-1101"><span class="linenos">1101</span></a>
</span><span id="TinkoffBrokerServer.Overview-1102"><a href="#-1102"><span class="linenos">1102</span></a><span class="sd">        :param showStatistics: if `False` then only dictionary returns, if `True` then show more debug information.</span>
</span><span id="TinkoffBrokerServer.Overview-1103"><a href="#-1103"><span class="linenos">1103</span></a><span class="sd">        :return: dictionary with client&#39;s raw portfolio and some statistics.</span>
</span><span id="TinkoffBrokerServer.Overview-1104"><a href="#-1104"><span class="linenos">1104</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.Overview-1105"><a href="#-1105"><span class="linenos">1105</span></a>        <span class="n">view</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="TinkoffBrokerServer.Overview-1106"><a href="#-1106"><span class="linenos">1106</span></a>            <span class="s2">&quot;raw&quot;</span><span class="p">:</span> <span class="p">{</span>  <span class="c1"># --- raw portfolio responses from broker with user portfolio data:</span>
</span><span id="TinkoffBrokerServer.Overview-1107"><a href="#-1107"><span class="linenos">1107</span></a>                <span class="s2">&quot;headers&quot;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># list of dictionaries, response headers without &quot;positions&quot; section</span>
</span><span id="TinkoffBrokerServer.Overview-1108"><a href="#-1108"><span class="linenos">1108</span></a>                <span class="s2">&quot;Currencies&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># list of dictionaries, open trades with currencies from &quot;positions&quot; section</span>
</span><span id="TinkoffBrokerServer.Overview-1109"><a href="#-1109"><span class="linenos">1109</span></a>                <span class="s2">&quot;Shares&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># list of dictionaries, open trades with stocks from &quot;positions&quot; section</span>
</span><span id="TinkoffBrokerServer.Overview-1110"><a href="#-1110"><span class="linenos">1110</span></a>                <span class="s2">&quot;Bonds&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># list of dictionaries, open trades with bonds from &quot;positions&quot; section</span>
</span><span id="TinkoffBrokerServer.Overview-1111"><a href="#-1111"><span class="linenos">1111</span></a>                <span class="s2">&quot;Etfs&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># list of dictionaries, open trades with etfs from &quot;positions&quot; section</span>
</span><span id="TinkoffBrokerServer.Overview-1112"><a href="#-1112"><span class="linenos">1112</span></a>                <span class="s2">&quot;Futures&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># list of dictionaries, open trades with futures from &quot;positions&quot; section</span>
</span><span id="TinkoffBrokerServer.Overview-1113"><a href="#-1113"><span class="linenos">1113</span></a>                <span class="s2">&quot;positions&quot;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># raw response from broker: dictionary with current available or blocked currencies and instruments for client</span>
</span><span id="TinkoffBrokerServer.Overview-1114"><a href="#-1114"><span class="linenos">1114</span></a>                <span class="s2">&quot;orders&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># raw response from broker: list of dictionaries with all pending (market) orders</span>
</span><span id="TinkoffBrokerServer.Overview-1115"><a href="#-1115"><span class="linenos">1115</span></a>                <span class="s2">&quot;stopOrders&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># raw response from broker: list of dictionaries with all stop orders</span>
</span><span id="TinkoffBrokerServer.Overview-1116"><a href="#-1116"><span class="linenos">1116</span></a>                <span class="s2">&quot;currenciesCurrentPrices&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rub&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;currentPrice&quot;</span><span class="p">:</span> <span class="mf">1.</span><span class="p">}},</span>  <span class="c1"># dict with prices of all currencies in RUB</span>
</span><span id="TinkoffBrokerServer.Overview-1117"><a href="#-1117"><span class="linenos">1117</span></a>            <span class="p">},</span>
</span><span id="TinkoffBrokerServer.Overview-1118"><a href="#-1118"><span class="linenos">1118</span></a>            <span class="s2">&quot;stat&quot;</span><span class="p">:</span> <span class="p">{</span>  <span class="c1"># --- some statistics calculated using &quot;raw&quot; sections:</span>
</span><span id="TinkoffBrokerServer.Overview-1119"><a href="#-1119"><span class="linenos">1119</span></a>                <span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>  <span class="c1"># portfolio cost in RUB (Russian Rouble)</span>
</span><span id="TinkoffBrokerServer.Overview-1120"><a href="#-1120"><span class="linenos">1120</span></a>                <span class="s2">&quot;currentBlockedRUB&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>  <span class="c1"># blocked sum in Russian Rouble</span>
</span><span id="TinkoffBrokerServer.Overview-1121"><a href="#-1121"><span class="linenos">1121</span></a>                <span class="s2">&quot;totalChangesRUB&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>  <span class="c1"># changes for all open trades in RUB</span>
</span><span id="TinkoffBrokerServer.Overview-1122"><a href="#-1122"><span class="linenos">1122</span></a>                <span class="s2">&quot;totalChangesPercentRUB&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>  <span class="c1"># changes for all open trades in percents</span>
</span><span id="TinkoffBrokerServer.Overview-1123"><a href="#-1123"><span class="linenos">1123</span></a>                <span class="s2">&quot;allCurrenciesCostRUB&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>  <span class="c1"># costs of all currencies (include rubles) in RUB</span>
</span><span id="TinkoffBrokerServer.Overview-1124"><a href="#-1124"><span class="linenos">1124</span></a>                <span class="s2">&quot;availableRUB&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>  <span class="c1"># available rubles (without other currencies)</span>
</span><span id="TinkoffBrokerServer.Overview-1125"><a href="#-1125"><span class="linenos">1125</span></a>                <span class="s2">&quot;stocksCostRUB&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>  <span class="c1"># costs of all stocks in RUB</span>
</span><span id="TinkoffBrokerServer.Overview-1126"><a href="#-1126"><span class="linenos">1126</span></a>                <span class="s2">&quot;bondsCostRUB&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>  <span class="c1"># costs of all bonds in RUB</span>
</span><span id="TinkoffBrokerServer.Overview-1127"><a href="#-1127"><span class="linenos">1127</span></a>                <span class="s2">&quot;etfsCostRUB&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>  <span class="c1"># costs of all etfs in RUB</span>
</span><span id="TinkoffBrokerServer.Overview-1128"><a href="#-1128"><span class="linenos">1128</span></a>                <span class="s2">&quot;Currencies&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># list of dictionaries of all currencies statistics</span>
</span><span id="TinkoffBrokerServer.Overview-1129"><a href="#-1129"><span class="linenos">1129</span></a>                <span class="s2">&quot;Shares&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># list of dictionaries of all stocks statistics</span>
</span><span id="TinkoffBrokerServer.Overview-1130"><a href="#-1130"><span class="linenos">1130</span></a>                <span class="s2">&quot;Bonds&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># list of dictionaries of all bonds statistics</span>
</span><span id="TinkoffBrokerServer.Overview-1131"><a href="#-1131"><span class="linenos">1131</span></a>                <span class="s2">&quot;Etfs&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="c1"># list of dictionaries of all etfs statistics</span>
</span><span id="TinkoffBrokerServer.Overview-1132"><a href="#-1132"><span class="linenos">1132</span></a>                <span class="s2">&quot;Futures&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="c1"># list of dictionaries of all futures statistics</span>
</span><span id="TinkoffBrokerServer.Overview-1133"><a href="#-1133"><span class="linenos">1133</span></a>                <span class="s2">&quot;orders&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># list of dictionaries of all pending (market) orders and it&#39;s parameters</span>
</span><span id="TinkoffBrokerServer.Overview-1134"><a href="#-1134"><span class="linenos">1134</span></a>                <span class="s2">&quot;stopOrders&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># list of dictionaries of all stop orders and it&#39;s parameters</span>
</span><span id="TinkoffBrokerServer.Overview-1135"><a href="#-1135"><span class="linenos">1135</span></a>                <span class="s2">&quot;blockedCurrencies&quot;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># dict with blocked instruments and currencies, e.g. {&quot;rub&quot;: 1291.87, &quot;usd&quot;: 6.21}</span>
</span><span id="TinkoffBrokerServer.Overview-1136"><a href="#-1136"><span class="linenos">1136</span></a>                <span class="s2">&quot;blockedInstruments&quot;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># dict with blocked  by FIGI, e.g. {}</span>
</span><span id="TinkoffBrokerServer.Overview-1137"><a href="#-1137"><span class="linenos">1137</span></a>            <span class="p">},</span>
</span><span id="TinkoffBrokerServer.Overview-1138"><a href="#-1138"><span class="linenos">1138</span></a>            <span class="s2">&quot;analytics&quot;</span><span class="p">:{</span>  <span class="c1"># --- some analytics of portfolio:</span>
</span><span id="TinkoffBrokerServer.Overview-1139"><a href="#-1139"><span class="linenos">1139</span></a>                <span class="s2">&quot;distrByAssets&quot;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># portfolio distribution by assets</span>
</span><span id="TinkoffBrokerServer.Overview-1140"><a href="#-1140"><span class="linenos">1140</span></a>                <span class="s2">&quot;distrByCompanies&quot;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># portfolio distribution by companies</span>
</span><span id="TinkoffBrokerServer.Overview-1141"><a href="#-1141"><span class="linenos">1141</span></a>                <span class="s2">&quot;distrBySectors&quot;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># portfolio distribution by sectors</span>
</span><span id="TinkoffBrokerServer.Overview-1142"><a href="#-1142"><span class="linenos">1142</span></a>                <span class="s2">&quot;distrByCurrencies&quot;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># portfolio distribution by currencies</span>
</span><span id="TinkoffBrokerServer.Overview-1143"><a href="#-1143"><span class="linenos">1143</span></a>            <span class="p">}</span>
</span><span id="TinkoffBrokerServer.Overview-1144"><a href="#-1144"><span class="linenos">1144</span></a>        <span class="p">}</span>
</span><span id="TinkoffBrokerServer.Overview-1145"><a href="#-1145"><span class="linenos">1145</span></a>
</span><span id="TinkoffBrokerServer.Overview-1146"><a href="#-1146"><span class="linenos">1146</span></a>        <span class="k">if</span> <span class="n">showStatistics</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1147"><a href="#-1147"><span class="linenos">1147</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Request portfolio of a client...&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Overview-1148"><a href="#-1148"><span class="linenos">1148</span></a>
</span><span id="TinkoffBrokerServer.Overview-1149"><a href="#-1149"><span class="linenos">1149</span></a>        <span class="n">portfolioResponse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RequestPortfolio</span><span class="p">()</span>  <span class="c1"># current user&#39;s portfolio (dict)</span>
</span><span id="TinkoffBrokerServer.Overview-1150"><a href="#-1150"><span class="linenos">1150</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;positions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RequestPositions</span><span class="p">()</span>  <span class="c1"># current open positions by instruments (dict)</span>
</span><span id="TinkoffBrokerServer.Overview-1151"><a href="#-1151"><span class="linenos">1151</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;orders&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RequestPendingOrders</span><span class="p">()</span>  <span class="c1"># current actual pending orders (list)</span>
</span><span id="TinkoffBrokerServer.Overview-1152"><a href="#-1152"><span class="linenos">1152</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;stopOrders&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RequestStopOrders</span><span class="p">()</span>  <span class="c1"># current actual stop orders (list)</span>
</span><span id="TinkoffBrokerServer.Overview-1153"><a href="#-1153"><span class="linenos">1153</span></a>
</span><span id="TinkoffBrokerServer.Overview-1154"><a href="#-1154"><span class="linenos">1154</span></a>        <span class="c1"># save response headers without &quot;positions&quot; section:</span>
</span><span id="TinkoffBrokerServer.Overview-1155"><a href="#-1155"><span class="linenos">1155</span></a>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">portfolioResponse</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.Overview-1156"><a href="#-1156"><span class="linenos">1156</span></a>            <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;positions&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1157"><a href="#-1157"><span class="linenos">1157</span></a>                <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;headers&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">portfolioResponse</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer.Overview-1158"><a href="#-1158"><span class="linenos">1158</span></a>
</span><span id="TinkoffBrokerServer.Overview-1159"><a href="#-1159"><span class="linenos">1159</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1160"><a href="#-1160"><span class="linenos">1160</span></a>                <span class="k">continue</span>
</span><span id="TinkoffBrokerServer.Overview-1161"><a href="#-1161"><span class="linenos">1161</span></a>
</span><span id="TinkoffBrokerServer.Overview-1162"><a href="#-1162"><span class="linenos">1162</span></a>        <span class="c1"># Re-sorting and separating given raw instruments and currencies by type: https://tinkoff.github.io/investAPI/operations/#operation</span>
</span><span id="TinkoffBrokerServer.Overview-1163"><a href="#-1163"><span class="linenos">1163</span></a>        <span class="c1"># Type of instrument must be only one of supported types in TKS_INSTRUMENTS</span>
</span><span id="TinkoffBrokerServer.Overview-1164"><a href="#-1164"><span class="linenos">1164</span></a>        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">portfolioResponse</span><span class="p">[</span><span class="s2">&quot;positions&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.Overview-1165"><a href="#-1165"><span class="linenos">1165</span></a>            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;currency&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1166"><a href="#-1166"><span class="linenos">1166</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer.Overview-1167"><a href="#-1167"><span class="linenos">1167</span></a>                <span class="n">curr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SearchByFIGI</span><span class="p">(</span><span class="n">requestPrice</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Overview-1168"><a href="#-1168"><span class="linenos">1168</span></a>
</span><span id="TinkoffBrokerServer.Overview-1169"><a href="#-1169"><span class="linenos">1169</span></a>                <span class="c1"># current price of currency in RUB:</span>
</span><span id="TinkoffBrokerServer.Overview-1170"><a href="#-1170"><span class="linenos">1170</span></a>                <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;currenciesCurrentPrices&quot;</span><span class="p">][</span><span class="n">curr</span><span class="p">[</span><span class="s2">&quot;nominal&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="TinkoffBrokerServer.Overview-1171"><a href="#-1171"><span class="linenos">1171</span></a>                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">curr</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1172"><a href="#-1172"><span class="linenos">1172</span></a>                    <span class="s2">&quot;currentPrice&quot;</span><span class="p">:</span> <span class="n">NanoToFloat</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.Overview-1173"><a href="#-1173"><span class="linenos">1173</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1174"><a href="#-1174"><span class="linenos">1174</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer.Overview-1175"><a href="#-1175"><span class="linenos">1175</span></a>                    <span class="p">),</span>
</span><span id="TinkoffBrokerServer.Overview-1176"><a href="#-1176"><span class="linenos">1176</span></a>                <span class="p">}</span>
</span><span id="TinkoffBrokerServer.Overview-1177"><a href="#-1177"><span class="linenos">1177</span></a>
</span><span id="TinkoffBrokerServer.Overview-1178"><a href="#-1178"><span class="linenos">1178</span></a>                <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;Currencies&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Overview-1179"><a href="#-1179"><span class="linenos">1179</span></a>
</span><span id="TinkoffBrokerServer.Overview-1180"><a href="#-1180"><span class="linenos">1180</span></a>            <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;share&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1181"><a href="#-1181"><span class="linenos">1181</span></a>                <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;Shares&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Overview-1182"><a href="#-1182"><span class="linenos">1182</span></a>
</span><span id="TinkoffBrokerServer.Overview-1183"><a href="#-1183"><span class="linenos">1183</span></a>            <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;bond&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1184"><a href="#-1184"><span class="linenos">1184</span></a>                <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;Bonds&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Overview-1185"><a href="#-1185"><span class="linenos">1185</span></a>
</span><span id="TinkoffBrokerServer.Overview-1186"><a href="#-1186"><span class="linenos">1186</span></a>            <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;etf&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1187"><a href="#-1187"><span class="linenos">1187</span></a>                <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;Etfs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Overview-1188"><a href="#-1188"><span class="linenos">1188</span></a>
</span><span id="TinkoffBrokerServer.Overview-1189"><a href="#-1189"><span class="linenos">1189</span></a>            <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;futures&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1190"><a href="#-1190"><span class="linenos">1190</span></a>                <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;Futures&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Overview-1191"><a href="#-1191"><span class="linenos">1191</span></a>
</span><span id="TinkoffBrokerServer.Overview-1192"><a href="#-1192"><span class="linenos">1192</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1193"><a href="#-1193"><span class="linenos">1193</span></a>                <span class="k">continue</span>
</span><span id="TinkoffBrokerServer.Overview-1194"><a href="#-1194"><span class="linenos">1194</span></a>
</span><span id="TinkoffBrokerServer.Overview-1195"><a href="#-1195"><span class="linenos">1195</span></a>        <span class="c1"># how many volume of currencies (by ISO currency name) are blocked:</span>
</span><span id="TinkoffBrokerServer.Overview-1196"><a href="#-1196"><span class="linenos">1196</span></a>        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;positions&quot;</span><span class="p">][</span><span class="s2">&quot;blocked&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.Overview-1197"><a href="#-1197"><span class="linenos">1197</span></a>            <span class="n">blocked</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>
</span><span id="TinkoffBrokerServer.Overview-1198"><a href="#-1198"><span class="linenos">1198</span></a>            <span class="k">if</span> <span class="n">blocked</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1199"><a href="#-1199"><span class="linenos">1199</span></a>                <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;blockedCurrencies&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">blocked</span>
</span><span id="TinkoffBrokerServer.Overview-1200"><a href="#-1200"><span class="linenos">1200</span></a>
</span><span id="TinkoffBrokerServer.Overview-1201"><a href="#-1201"><span class="linenos">1201</span></a>        <span class="c1"># how many volume of instruments (by FIGI) are blocked:</span>
</span><span id="TinkoffBrokerServer.Overview-1202"><a href="#-1202"><span class="linenos">1202</span></a>        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;positions&quot;</span><span class="p">][</span><span class="s2">&quot;securities&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.Overview-1203"><a href="#-1203"><span class="linenos">1203</span></a>            <span class="n">blocked</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;blocked&quot;</span><span class="p">])</span>
</span><span id="TinkoffBrokerServer.Overview-1204"><a href="#-1204"><span class="linenos">1204</span></a>            <span class="k">if</span> <span class="n">blocked</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1205"><a href="#-1205"><span class="linenos">1205</span></a>                <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;blockedInstruments&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">blocked</span>
</span><span id="TinkoffBrokerServer.Overview-1206"><a href="#-1206"><span class="linenos">1206</span></a>
</span><span id="TinkoffBrokerServer.Overview-1207"><a href="#-1207"><span class="linenos">1207</span></a>        <span class="n">allBlocked</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;blockedCurrencies&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;blockedInstruments&quot;</span><span class="p">]}</span>
</span><span id="TinkoffBrokerServer.Overview-1208"><a href="#-1208"><span class="linenos">1208</span></a>
</span><span id="TinkoffBrokerServer.Overview-1209"><a href="#-1209"><span class="linenos">1209</span></a>        <span class="k">if</span> <span class="s2">&quot;rub&quot;</span> <span class="ow">in</span> <span class="n">allBlocked</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.Overview-1210"><a href="#-1210"><span class="linenos">1210</span></a>            <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;currentBlockedRUB&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">allBlocked</span><span class="p">[</span><span class="s2">&quot;rub&quot;</span><span class="p">]</span>  <span class="c1"># blocked rubles</span>
</span><span id="TinkoffBrokerServer.Overview-1211"><a href="#-1211"><span class="linenos">1211</span></a>
</span><span id="TinkoffBrokerServer.Overview-1212"><a href="#-1212"><span class="linenos">1212</span></a>        <span class="c1"># --- saving current total amount in RUB of all currencies (with ruble), stocks, bonds, etfs, futures and currencies:</span>
</span><span id="TinkoffBrokerServer.Overview-1213"><a href="#-1213"><span class="linenos">1213</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;allCurrenciesCostRUB&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">portfolioResponse</span><span class="p">[</span><span class="s2">&quot;totalAmountCurrencies&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">portfolioResponse</span><span class="p">[</span><span class="s2">&quot;totalAmountCurrencies&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>
</span><span id="TinkoffBrokerServer.Overview-1214"><a href="#-1214"><span class="linenos">1214</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;stocksCostRUB&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">portfolioResponse</span><span class="p">[</span><span class="s2">&quot;totalAmountShares&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">portfolioResponse</span><span class="p">[</span><span class="s2">&quot;totalAmountShares&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>
</span><span id="TinkoffBrokerServer.Overview-1215"><a href="#-1215"><span class="linenos">1215</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;bondsCostRUB&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">portfolioResponse</span><span class="p">[</span><span class="s2">&quot;totalAmountBonds&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">portfolioResponse</span><span class="p">[</span><span class="s2">&quot;totalAmountBonds&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>
</span><span id="TinkoffBrokerServer.Overview-1216"><a href="#-1216"><span class="linenos">1216</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;etfsCostRUB&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">portfolioResponse</span><span class="p">[</span><span class="s2">&quot;totalAmountEtf&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">portfolioResponse</span><span class="p">[</span><span class="s2">&quot;totalAmountEtf&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>
</span><span id="TinkoffBrokerServer.Overview-1217"><a href="#-1217"><span class="linenos">1217</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;futuresCostRUB&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">portfolioResponse</span><span class="p">[</span><span class="s2">&quot;totalAmountFutures&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">portfolioResponse</span><span class="p">[</span><span class="s2">&quot;totalAmountFutures&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>
</span><span id="TinkoffBrokerServer.Overview-1218"><a href="#-1218"><span class="linenos">1218</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span>
</span><span id="TinkoffBrokerServer.Overview-1219"><a href="#-1219"><span class="linenos">1219</span></a>            <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;allCurrenciesCostRUB&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1220"><a href="#-1220"><span class="linenos">1220</span></a>            <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;stocksCostRUB&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1221"><a href="#-1221"><span class="linenos">1221</span></a>            <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;bondsCostRUB&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1222"><a href="#-1222"><span class="linenos">1222</span></a>            <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;etfsCostRUB&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1223"><a href="#-1223"><span class="linenos">1223</span></a>            <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;futuresCostRUB&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1224"><a href="#-1224"><span class="linenos">1224</span></a>        <span class="p">])</span>
</span><span id="TinkoffBrokerServer.Overview-1225"><a href="#-1225"><span class="linenos">1225</span></a>
</span><span id="TinkoffBrokerServer.Overview-1226"><a href="#-1226"><span class="linenos">1226</span></a>        <span class="c1"># --- calculating some portfolio statistics:</span>
</span><span id="TinkoffBrokerServer.Overview-1227"><a href="#-1227"><span class="linenos">1227</span></a>        <span class="n">byComp</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># distribution by companies</span>
</span><span id="TinkoffBrokerServer.Overview-1228"><a href="#-1228"><span class="linenos">1228</span></a>        <span class="n">bySect</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># distribution by sectors</span>
</span><span id="TinkoffBrokerServer.Overview-1229"><a href="#-1229"><span class="linenos">1229</span></a>        <span class="n">byCurr</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># distribution by currencies (include RUB)</span>
</span><span id="TinkoffBrokerServer.Overview-1230"><a href="#-1230"><span class="linenos">1230</span></a>
</span><span id="TinkoffBrokerServer.Overview-1231"><a href="#-1231"><span class="linenos">1231</span></a>        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">portfolioResponse</span><span class="p">[</span><span class="s2">&quot;positions&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.Overview-1232"><a href="#-1232"><span class="linenos">1232</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer.Overview-1233"><a href="#-1233"><span class="linenos">1233</span></a>            <span class="n">instrument</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SearchByFIGI</span><span class="p">(</span><span class="n">requestPrice</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># full raw info about instrument by FIGI</span>
</span><span id="TinkoffBrokerServer.Overview-1234"><a href="#-1234"><span class="linenos">1234</span></a>
</span><span id="TinkoffBrokerServer.Overview-1235"><a href="#-1235"><span class="linenos">1235</span></a>            <span class="k">if</span> <span class="n">instrument</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1236"><a href="#-1236"><span class="linenos">1236</span></a>                <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;currency&quot;</span> <span class="ow">and</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;nominal&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">allBlocked</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.Overview-1237"><a href="#-1237"><span class="linenos">1237</span></a>                    <span class="n">blocked</span> <span class="o">=</span> <span class="n">allBlocked</span><span class="p">[</span><span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;nominal&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span>  <span class="c1"># blocked volume of currency</span>
</span><span id="TinkoffBrokerServer.Overview-1238"><a href="#-1238"><span class="linenos">1238</span></a>
</span><span id="TinkoffBrokerServer.Overview-1239"><a href="#-1239"><span class="linenos">1239</span></a>                <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;currency&quot;</span> <span class="ow">and</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">allBlocked</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.Overview-1240"><a href="#-1240"><span class="linenos">1240</span></a>                    <span class="n">blocked</span> <span class="o">=</span> <span class="n">allBlocked</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]]</span>  <span class="c1"># blocked volume of other instruments</span>
</span><span id="TinkoffBrokerServer.Overview-1241"><a href="#-1241"><span class="linenos">1241</span></a>
</span><span id="TinkoffBrokerServer.Overview-1242"><a href="#-1242"><span class="linenos">1242</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1243"><a href="#-1243"><span class="linenos">1243</span></a>                    <span class="n">blocked</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="TinkoffBrokerServer.Overview-1244"><a href="#-1244"><span class="linenos">1244</span></a>
</span><span id="TinkoffBrokerServer.Overview-1245"><a href="#-1245"><span class="linenos">1245</span></a>                <span class="n">volume</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;quantity&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;quantity&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>  <span class="c1"># available volume of instrument</span>
</span><span id="TinkoffBrokerServer.Overview-1246"><a href="#-1246"><span class="linenos">1246</span></a>                <span class="n">lots</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;quantityLots&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;quantityLots&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>  <span class="c1"># available volume in lots of instrument</span>
</span><span id="TinkoffBrokerServer.Overview-1247"><a href="#-1247"><span class="linenos">1247</span></a>                <span class="n">direction</span> <span class="o">=</span> <span class="s2">&quot;Long&quot;</span> <span class="k">if</span> <span class="n">lots</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;Short&quot;</span>  <span class="c1"># direction of an instrument&#39;s position: short or long</span>
</span><span id="TinkoffBrokerServer.Overview-1248"><a href="#-1248"><span class="linenos">1248</span></a>                <span class="n">curPrice</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>  <span class="c1"># current instrument&#39;s price</span>
</span><span id="TinkoffBrokerServer.Overview-1249"><a href="#-1249"><span class="linenos">1249</span></a>                <span class="n">average</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;averagePositionPriceFifo&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;averagePositionPriceFifo&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>  <span class="c1"># current average position price</span>
</span><span id="TinkoffBrokerServer.Overview-1250"><a href="#-1250"><span class="linenos">1250</span></a>                <span class="n">profit</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;expectedYield&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;expectedYield&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>  <span class="c1"># expected profit at current moment</span>
</span><span id="TinkoffBrokerServer.Overview-1251"><a href="#-1251"><span class="linenos">1251</span></a>                <span class="n">currency</span> <span class="o">=</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;share&quot;</span> <span class="ow">or</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;etf&quot;</span> <span class="ow">or</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;future&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;nominal&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span>  <span class="c1"># currency name rub, usd, eur etc.</span>
</span><span id="TinkoffBrokerServer.Overview-1252"><a href="#-1252"><span class="linenos">1252</span></a>                <span class="n">cost</span> <span class="o">=</span> <span class="p">(</span><span class="n">curPrice</span> <span class="o">+</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentNkd&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentNkd&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">]))</span> <span class="o">*</span> <span class="n">volume</span>  <span class="c1"># current cost of all volume of instrument in basic asset</span>
</span><span id="TinkoffBrokerServer.Overview-1253"><a href="#-1253"><span class="linenos">1253</span></a>                <span class="n">baseCurrencyName</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span>  <span class="c1"># name of base currency (rub)</span>
</span><span id="TinkoffBrokerServer.Overview-1254"><a href="#-1254"><span class="linenos">1254</span></a>                <span class="n">costRUB</span> <span class="o">=</span> <span class="n">cost</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;currency&quot;</span> <span class="k">else</span> <span class="n">cost</span> <span class="o">*</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;currenciesCurrentPrices&quot;</span><span class="p">][</span><span class="n">currency</span><span class="p">][</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">]</span>  <span class="c1"># cost in rubles</span>
</span><span id="TinkoffBrokerServer.Overview-1255"><a href="#-1255"><span class="linenos">1255</span></a>                <span class="n">percentCostRUB</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">costRUB</span> <span class="o">/</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.</span>  <span class="c1"># instrument&#39;s part in percent of full portfolio cost</span>
</span><span id="TinkoffBrokerServer.Overview-1256"><a href="#-1256"><span class="linenos">1256</span></a>
</span><span id="TinkoffBrokerServer.Overview-1257"><a href="#-1257"><span class="linenos">1257</span></a>                <span class="n">statData</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="TinkoffBrokerServer.Overview-1258"><a href="#-1258"><span class="linenos">1258</span></a>                    <span class="s2">&quot;figi&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">],</span>  <span class="c1"># FIGI from REST API &quot;GetPortfolio&quot; method</span>
</span><span id="TinkoffBrokerServer.Overview-1259"><a href="#-1259"><span class="linenos">1259</span></a>                    <span class="s2">&quot;ticker&quot;</span><span class="p">:</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">],</span>  <span class="c1"># ticker by FIGI</span>
</span><span id="TinkoffBrokerServer.Overview-1260"><a href="#-1260"><span class="linenos">1260</span></a>                    <span class="s2">&quot;currency&quot;</span><span class="p">:</span> <span class="n">currency</span><span class="p">,</span>  <span class="c1"># currency name rub, usd, eur etc. for instrument price</span>
</span><span id="TinkoffBrokerServer.Overview-1261"><a href="#-1261"><span class="linenos">1261</span></a>                    <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="n">volume</span><span class="p">,</span>  <span class="c1"># available volume of instrument</span>
</span><span id="TinkoffBrokerServer.Overview-1262"><a href="#-1262"><span class="linenos">1262</span></a>                    <span class="s2">&quot;lots&quot;</span><span class="p">:</span> <span class="n">lots</span><span class="p">,</span>  <span class="c1"># volume in lots of instrument</span>
</span><span id="TinkoffBrokerServer.Overview-1263"><a href="#-1263"><span class="linenos">1263</span></a>                    <span class="s2">&quot;direction&quot;</span><span class="p">:</span> <span class="n">direction</span><span class="p">,</span>  <span class="c1"># direction of an instrument&#39;s position: short or long</span>
</span><span id="TinkoffBrokerServer.Overview-1264"><a href="#-1264"><span class="linenos">1264</span></a>                    <span class="s2">&quot;blocked&quot;</span><span class="p">:</span> <span class="n">blocked</span><span class="p">,</span>  <span class="c1"># blocked volume of currency or instrument</span>
</span><span id="TinkoffBrokerServer.Overview-1265"><a href="#-1265"><span class="linenos">1265</span></a>                    <span class="s2">&quot;currentPrice&quot;</span><span class="p">:</span> <span class="n">curPrice</span><span class="p">,</span>  <span class="c1"># current instrument&#39;s price in basic asset</span>
</span><span id="TinkoffBrokerServer.Overview-1266"><a href="#-1266"><span class="linenos">1266</span></a>                    <span class="s2">&quot;average&quot;</span><span class="p">:</span> <span class="n">average</span><span class="p">,</span>  <span class="c1"># current average position price</span>
</span><span id="TinkoffBrokerServer.Overview-1267"><a href="#-1267"><span class="linenos">1267</span></a>                    <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">cost</span><span class="p">,</span>  <span class="c1"># current cost of all volume of instrument in basic asset</span>
</span><span id="TinkoffBrokerServer.Overview-1268"><a href="#-1268"><span class="linenos">1268</span></a>                    <span class="s2">&quot;baseCurrencyName&quot;</span><span class="p">:</span> <span class="n">baseCurrencyName</span><span class="p">,</span>  <span class="c1"># name of base currency (rub)</span>
</span><span id="TinkoffBrokerServer.Overview-1269"><a href="#-1269"><span class="linenos">1269</span></a>                    <span class="s2">&quot;costRUB&quot;</span><span class="p">:</span> <span class="n">costRUB</span><span class="p">,</span>  <span class="c1"># cost of instrument in ruble</span>
</span><span id="TinkoffBrokerServer.Overview-1270"><a href="#-1270"><span class="linenos">1270</span></a>                    <span class="s2">&quot;percentCostRUB&quot;</span><span class="p">:</span> <span class="n">percentCostRUB</span><span class="p">,</span>  <span class="c1"># instrument&#39;s part in percent of full portfolio cost in RUB</span>
</span><span id="TinkoffBrokerServer.Overview-1271"><a href="#-1271"><span class="linenos">1271</span></a>                    <span class="s2">&quot;profit&quot;</span><span class="p">:</span> <span class="n">profit</span><span class="p">,</span>  <span class="c1"># expected profit at current moment</span>
</span><span id="TinkoffBrokerServer.Overview-1272"><a href="#-1272"><span class="linenos">1272</span></a>                    <span class="s2">&quot;percentProfit&quot;</span><span class="p">:</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">profit</span> <span class="o">/</span> <span class="p">(</span><span class="n">average</span> <span class="o">*</span> <span class="n">volume</span><span class="p">),</span>  <span class="c1"># expected percents of profit at current moment for this instrument</span>
</span><span id="TinkoffBrokerServer.Overview-1273"><a href="#-1273"><span class="linenos">1273</span></a>                    <span class="s2">&quot;sector&quot;</span><span class="p">:</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;sector&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;sector&quot;</span> <span class="ow">in</span> <span class="n">instrument</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;sector&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;other&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Overview-1274"><a href="#-1274"><span class="linenos">1274</span></a>                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">instrument</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>  <span class="c1"># human-readable names of instruments</span>
</span><span id="TinkoffBrokerServer.Overview-1275"><a href="#-1275"><span class="linenos">1275</span></a>                    <span class="s2">&quot;isoCurrencyName&quot;</span><span class="p">:</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;isoCurrencyName&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;isoCurrencyName&quot;</span> <span class="ow">in</span> <span class="n">instrument</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>  <span class="c1"># ISO name for currencies only</span>
</span><span id="TinkoffBrokerServer.Overview-1276"><a href="#-1276"><span class="linenos">1276</span></a>                <span class="p">}</span>
</span><span id="TinkoffBrokerServer.Overview-1277"><a href="#-1277"><span class="linenos">1277</span></a>
</span><span id="TinkoffBrokerServer.Overview-1278"><a href="#-1278"><span class="linenos">1278</span></a>                <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;currency&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1279"><a href="#-1279"><span class="linenos">1279</span></a>                    <span class="c1"># adding distribution by unique companies:</span>
</span><span id="TinkoffBrokerServer.Overview-1280"><a href="#-1280"><span class="linenos">1280</span></a>                    <span class="k">if</span> <span class="n">statData</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.Overview-1281"><a href="#-1281"><span class="linenos">1281</span></a>                        <span class="k">if</span> <span class="n">statData</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">byComp</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.Overview-1282"><a href="#-1282"><span class="linenos">1282</span></a>                            <span class="n">byComp</span><span class="p">[</span><span class="n">statData</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ticker&quot;</span><span class="p">:</span> <span class="n">statData</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">],</span> <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">costRUB</span><span class="p">,</span> <span class="s2">&quot;percent&quot;</span><span class="p">:</span> <span class="n">percentCostRUB</span><span class="p">}</span>
</span><span id="TinkoffBrokerServer.Overview-1283"><a href="#-1283"><span class="linenos">1283</span></a>
</span><span id="TinkoffBrokerServer.Overview-1284"><a href="#-1284"><span class="linenos">1284</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1285"><a href="#-1285"><span class="linenos">1285</span></a>                            <span class="n">byComp</span><span class="p">[</span><span class="n">statData</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]][</span><span class="s2">&quot;cost&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">costRUB</span>
</span><span id="TinkoffBrokerServer.Overview-1286"><a href="#-1286"><span class="linenos">1286</span></a>                            <span class="n">byComp</span><span class="p">[</span><span class="n">statData</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]][</span><span class="s2">&quot;percent&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">percentCostRUB</span>
</span><span id="TinkoffBrokerServer.Overview-1287"><a href="#-1287"><span class="linenos">1287</span></a>
</span><span id="TinkoffBrokerServer.Overview-1288"><a href="#-1288"><span class="linenos">1288</span></a>                    <span class="c1"># adding distribution by unique sectors:</span>
</span><span id="TinkoffBrokerServer.Overview-1289"><a href="#-1289"><span class="linenos">1289</span></a>                    <span class="k">if</span> <span class="n">statData</span><span class="p">[</span><span class="s2">&quot;sector&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bySect</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.Overview-1290"><a href="#-1290"><span class="linenos">1290</span></a>                        <span class="n">bySect</span><span class="p">[</span><span class="n">statData</span><span class="p">[</span><span class="s2">&quot;sector&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">costRUB</span><span class="p">,</span> <span class="s2">&quot;percent&quot;</span><span class="p">:</span> <span class="n">percentCostRUB</span><span class="p">}</span>
</span><span id="TinkoffBrokerServer.Overview-1291"><a href="#-1291"><span class="linenos">1291</span></a>
</span><span id="TinkoffBrokerServer.Overview-1292"><a href="#-1292"><span class="linenos">1292</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1293"><a href="#-1293"><span class="linenos">1293</span></a>                        <span class="n">bySect</span><span class="p">[</span><span class="n">statData</span><span class="p">[</span><span class="s2">&quot;sector&quot;</span><span class="p">]][</span><span class="s2">&quot;cost&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">costRUB</span>
</span><span id="TinkoffBrokerServer.Overview-1294"><a href="#-1294"><span class="linenos">1294</span></a>                        <span class="n">bySect</span><span class="p">[</span><span class="n">statData</span><span class="p">[</span><span class="s2">&quot;sector&quot;</span><span class="p">]][</span><span class="s2">&quot;percent&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">percentCostRUB</span>
</span><span id="TinkoffBrokerServer.Overview-1295"><a href="#-1295"><span class="linenos">1295</span></a>
</span><span id="TinkoffBrokerServer.Overview-1296"><a href="#-1296"><span class="linenos">1296</span></a>                <span class="c1"># adding distribution by unique currencies:</span>
</span><span id="TinkoffBrokerServer.Overview-1297"><a href="#-1297"><span class="linenos">1297</span></a>                <span class="k">if</span> <span class="n">currency</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">byCurr</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.Overview-1298"><a href="#-1298"><span class="linenos">1298</span></a>                    <span class="n">byCurr</span><span class="p">[</span><span class="n">currency</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="TinkoffBrokerServer.Overview-1299"><a href="#-1299"><span class="linenos">1299</span></a>                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;currenciesCurrentPrices&quot;</span><span class="p">][</span><span class="n">currency</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1300"><a href="#-1300"><span class="linenos">1300</span></a>                        <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">costRUB</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Overview-1301"><a href="#-1301"><span class="linenos">1301</span></a>                        <span class="s2">&quot;percent&quot;</span><span class="p">:</span> <span class="n">percentCostRUB</span>
</span><span id="TinkoffBrokerServer.Overview-1302"><a href="#-1302"><span class="linenos">1302</span></a>                    <span class="p">}</span>
</span><span id="TinkoffBrokerServer.Overview-1303"><a href="#-1303"><span class="linenos">1303</span></a>
</span><span id="TinkoffBrokerServer.Overview-1304"><a href="#-1304"><span class="linenos">1304</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1305"><a href="#-1305"><span class="linenos">1305</span></a>                    <span class="n">byCurr</span><span class="p">[</span><span class="n">currency</span><span class="p">][</span><span class="s2">&quot;cost&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">costRUB</span>
</span><span id="TinkoffBrokerServer.Overview-1306"><a href="#-1306"><span class="linenos">1306</span></a>                    <span class="n">byCurr</span><span class="p">[</span><span class="n">currency</span><span class="p">][</span><span class="s2">&quot;percent&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">percentCostRUB</span>
</span><span id="TinkoffBrokerServer.Overview-1307"><a href="#-1307"><span class="linenos">1307</span></a>
</span><span id="TinkoffBrokerServer.Overview-1308"><a href="#-1308"><span class="linenos">1308</span></a>                <span class="c1"># saving statistics for every instruments:</span>
</span><span id="TinkoffBrokerServer.Overview-1309"><a href="#-1309"><span class="linenos">1309</span></a>                <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;currency&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1310"><a href="#-1310"><span class="linenos">1310</span></a>                    <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Currencies&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">statData</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Overview-1311"><a href="#-1311"><span class="linenos">1311</span></a>
</span><span id="TinkoffBrokerServer.Overview-1312"><a href="#-1312"><span class="linenos">1312</span></a>                <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;share&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1313"><a href="#-1313"><span class="linenos">1313</span></a>                    <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Shares&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">statData</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Overview-1314"><a href="#-1314"><span class="linenos">1314</span></a>
</span><span id="TinkoffBrokerServer.Overview-1315"><a href="#-1315"><span class="linenos">1315</span></a>                <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;bond&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1316"><a href="#-1316"><span class="linenos">1316</span></a>                    <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Bonds&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">statData</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Overview-1317"><a href="#-1317"><span class="linenos">1317</span></a>
</span><span id="TinkoffBrokerServer.Overview-1318"><a href="#-1318"><span class="linenos">1318</span></a>                <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;etf&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1319"><a href="#-1319"><span class="linenos">1319</span></a>                    <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Etfs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">statData</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Overview-1320"><a href="#-1320"><span class="linenos">1320</span></a>
</span><span id="TinkoffBrokerServer.Overview-1321"><a href="#-1321"><span class="linenos">1321</span></a>                <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;instrumentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Futures&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1322"><a href="#-1322"><span class="linenos">1322</span></a>                    <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Futures&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">statData</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Overview-1323"><a href="#-1323"><span class="linenos">1323</span></a>
</span><span id="TinkoffBrokerServer.Overview-1324"><a href="#-1324"><span class="linenos">1324</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1325"><a href="#-1325"><span class="linenos">1325</span></a>                    <span class="k">continue</span>
</span><span id="TinkoffBrokerServer.Overview-1326"><a href="#-1326"><span class="linenos">1326</span></a>
</span><span id="TinkoffBrokerServer.Overview-1327"><a href="#-1327"><span class="linenos">1327</span></a>        <span class="c1"># total changes:</span>
</span><span id="TinkoffBrokerServer.Overview-1328"><a href="#-1328"><span class="linenos">1328</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;availableRUB&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;allCurrenciesCostRUB&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">([</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;cost&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Currencies&quot;</span><span class="p">]])</span>  <span class="c1"># available RUB without other currencies</span>
</span><span id="TinkoffBrokerServer.Overview-1329"><a href="#-1329"><span class="linenos">1329</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;totalChangesPercentRUB&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;headers&quot;</span><span class="p">][</span><span class="s2">&quot;expectedYield&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;headers&quot;</span><span class="p">][</span><span class="s2">&quot;expectedYield&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;expectedYield&quot;</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;headers&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="mf">0.</span>
</span><span id="TinkoffBrokerServer.Overview-1330"><a href="#-1330"><span class="linenos">1330</span></a>        <span class="n">startCost</span> <span class="o">=</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;totalChangesPercentRUB&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Overview-1331"><a href="#-1331"><span class="linenos">1331</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;totalChangesRUB&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">startCost</span>
</span><span id="TinkoffBrokerServer.Overview-1332"><a href="#-1332"><span class="linenos">1332</span></a>
</span><span id="TinkoffBrokerServer.Overview-1333"><a href="#-1333"><span class="linenos">1333</span></a>        <span class="c1"># --- pending orders sector data:</span>
</span><span id="TinkoffBrokerServer.Overview-1334"><a href="#-1334"><span class="linenos">1334</span></a>        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;orders&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.Overview-1335"><a href="#-1335"><span class="linenos">1335</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer.Overview-1336"><a href="#-1336"><span class="linenos">1336</span></a>            <span class="n">instrument</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SearchByFIGI</span><span class="p">(</span><span class="n">requestPrice</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># full raw info about instrument by FIGI</span>
</span><span id="TinkoffBrokerServer.Overview-1337"><a href="#-1337"><span class="linenos">1337</span></a>
</span><span id="TinkoffBrokerServer.Overview-1338"><a href="#-1338"><span class="linenos">1338</span></a>            <span class="k">if</span> <span class="n">instrument</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1339"><a href="#-1339"><span class="linenos">1339</span></a>                <span class="n">action</span> <span class="o">=</span> <span class="n">TKS_ORDER_DIRECTIONS</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;direction&quot;</span><span class="p">]]</span>
</span><span id="TinkoffBrokerServer.Overview-1340"><a href="#-1340"><span class="linenos">1340</span></a>                <span class="n">orderType</span> <span class="o">=</span> <span class="n">TKS_ORDER_TYPES</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;orderType&quot;</span><span class="p">]]</span>
</span><span id="TinkoffBrokerServer.Overview-1341"><a href="#-1341"><span class="linenos">1341</span></a>                <span class="n">orderState</span> <span class="o">=</span> <span class="n">TKS_ORDER_STATES</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;executionReportStatus&quot;</span><span class="p">]]</span>
</span><span id="TinkoffBrokerServer.Overview-1342"><a href="#-1342"><span class="linenos">1342</span></a>                <span class="n">orderDate</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;orderDate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># date in UTC format, e.g. &quot;2022-12-31T23:59:59.123456Z&quot;</span>
</span><span id="TinkoffBrokerServer.Overview-1343"><a href="#-1343"><span class="linenos">1343</span></a>
</span><span id="TinkoffBrokerServer.Overview-1344"><a href="#-1344"><span class="linenos">1344</span></a>                <span class="c1"># current instrument&#39;s price (last sellers order if buy, and last buyers order if sell):</span>
</span><span id="TinkoffBrokerServer.Overview-1345"><a href="#-1345"><span class="linenos">1345</span></a>                <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;direction&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ORDER_DIRECTION_BUY&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1346"><a href="#-1346"><span class="linenos">1346</span></a>                    <span class="n">lastPrice</span> <span class="o">=</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;sell&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;price&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;sell&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span>
</span><span id="TinkoffBrokerServer.Overview-1347"><a href="#-1347"><span class="linenos">1347</span></a>
</span><span id="TinkoffBrokerServer.Overview-1348"><a href="#-1348"><span class="linenos">1348</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1349"><a href="#-1349"><span class="linenos">1349</span></a>                    <span class="n">lastPrice</span> <span class="o">=</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;buy&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;price&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;buy&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span>
</span><span id="TinkoffBrokerServer.Overview-1350"><a href="#-1350"><span class="linenos">1350</span></a>
</span><span id="TinkoffBrokerServer.Overview-1351"><a href="#-1351"><span class="linenos">1351</span></a>                <span class="c1"># requested price for order execution:</span>
</span><span id="TinkoffBrokerServer.Overview-1352"><a href="#-1352"><span class="linenos">1352</span></a>                <span class="n">target</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;initialSecurityPrice&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;initialSecurityPrice&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>
</span><span id="TinkoffBrokerServer.Overview-1353"><a href="#-1353"><span class="linenos">1353</span></a>
</span><span id="TinkoffBrokerServer.Overview-1354"><a href="#-1354"><span class="linenos">1354</span></a>                <span class="c1"># necessary changes in percent to reach target from current price:</span>
</span><span id="TinkoffBrokerServer.Overview-1355"><a href="#-1355"><span class="linenos">1355</span></a>                <span class="n">changes</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">lastPrice</span> <span class="o">-</span> <span class="n">target</span><span class="p">)</span> <span class="o">/</span> <span class="n">target</span> <span class="k">if</span> <span class="n">lastPrice</span> <span class="o">!=</span> <span class="s2">&quot;N/A&quot;</span> <span class="ow">and</span> <span class="n">target</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="TinkoffBrokerServer.Overview-1356"><a href="#-1356"><span class="linenos">1356</span></a>
</span><span id="TinkoffBrokerServer.Overview-1357"><a href="#-1357"><span class="linenos">1357</span></a>                <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;orders&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="TinkoffBrokerServer.Overview-1358"><a href="#-1358"><span class="linenos">1358</span></a>                    <span class="s2">&quot;orderID&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;orderId&quot;</span><span class="p">],</span>  <span class="c1"># orderId number parameter of current order</span>
</span><span id="TinkoffBrokerServer.Overview-1359"><a href="#-1359"><span class="linenos">1359</span></a>                    <span class="s2">&quot;figi&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">],</span>  <span class="c1"># FIGI identification</span>
</span><span id="TinkoffBrokerServer.Overview-1360"><a href="#-1360"><span class="linenos">1360</span></a>                    <span class="s2">&quot;ticker&quot;</span><span class="p">:</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">],</span>  <span class="c1"># ticker name by FIGI</span>
</span><span id="TinkoffBrokerServer.Overview-1361"><a href="#-1361"><span class="linenos">1361</span></a>                    <span class="s2">&quot;lotsRequested&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;lotsRequested&quot;</span><span class="p">],</span>  <span class="c1"># requested lots value</span>
</span><span id="TinkoffBrokerServer.Overview-1362"><a href="#-1362"><span class="linenos">1362</span></a>                    <span class="s2">&quot;lotsExecuted&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;lotsExecuted&quot;</span><span class="p">],</span>  <span class="c1"># how many lots are executed</span>
</span><span id="TinkoffBrokerServer.Overview-1363"><a href="#-1363"><span class="linenos">1363</span></a>                    <span class="s2">&quot;currentPrice&quot;</span><span class="p">:</span> <span class="n">lastPrice</span><span class="p">,</span>  <span class="c1"># current instrument&#39;s price for defined action</span>
</span><span id="TinkoffBrokerServer.Overview-1364"><a href="#-1364"><span class="linenos">1364</span></a>                    <span class="s2">&quot;targetPrice&quot;</span><span class="p">:</span> <span class="n">target</span><span class="p">,</span>  <span class="c1"># requested price for order execution in base currency</span>
</span><span id="TinkoffBrokerServer.Overview-1365"><a href="#-1365"><span class="linenos">1365</span></a>                    <span class="s2">&quot;baseCurrencyName&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;initialSecurityPrice&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>  <span class="c1"># name of base currency</span>
</span><span id="TinkoffBrokerServer.Overview-1366"><a href="#-1366"><span class="linenos">1366</span></a>                    <span class="s2">&quot;percentChanges&quot;</span><span class="p">:</span> <span class="n">changes</span><span class="p">,</span>  <span class="c1"># changes in percent to target from current price</span>
</span><span id="TinkoffBrokerServer.Overview-1367"><a href="#-1367"><span class="linenos">1367</span></a>                    <span class="s2">&quot;currency&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>  <span class="c1"># instrument&#39;s currency name</span>
</span><span id="TinkoffBrokerServer.Overview-1368"><a href="#-1368"><span class="linenos">1368</span></a>                    <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span>  <span class="c1"># sell / buy / Unknown from TKS_ORDER_DIRECTIONS</span>
</span><span id="TinkoffBrokerServer.Overview-1369"><a href="#-1369"><span class="linenos">1369</span></a>                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">orderType</span><span class="p">,</span>  <span class="c1"># type of order from TKS_ORDER_TYPES</span>
</span><span id="TinkoffBrokerServer.Overview-1370"><a href="#-1370"><span class="linenos">1370</span></a>                    <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">orderState</span><span class="p">,</span>  <span class="c1"># order status from TKS_ORDER_STATES</span>
</span><span id="TinkoffBrokerServer.Overview-1371"><a href="#-1371"><span class="linenos">1371</span></a>                    <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="n">orderDate</span><span class="p">,</span>  <span class="c1"># string with order date and time from UTC format (without nano seconds part)</span>
</span><span id="TinkoffBrokerServer.Overview-1372"><a href="#-1372"><span class="linenos">1372</span></a>                <span class="p">})</span>
</span><span id="TinkoffBrokerServer.Overview-1373"><a href="#-1373"><span class="linenos">1373</span></a>
</span><span id="TinkoffBrokerServer.Overview-1374"><a href="#-1374"><span class="linenos">1374</span></a>        <span class="c1"># --- stop orders sector data:</span>
</span><span id="TinkoffBrokerServer.Overview-1375"><a href="#-1375"><span class="linenos">1375</span></a>        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;stopOrders&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.Overview-1376"><a href="#-1376"><span class="linenos">1376</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer.Overview-1377"><a href="#-1377"><span class="linenos">1377</span></a>            <span class="n">instrument</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SearchByFIGI</span><span class="p">(</span><span class="n">requestPrice</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># full raw info about instrument by FIGI</span>
</span><span id="TinkoffBrokerServer.Overview-1378"><a href="#-1378"><span class="linenos">1378</span></a>
</span><span id="TinkoffBrokerServer.Overview-1379"><a href="#-1379"><span class="linenos">1379</span></a>            <span class="k">if</span> <span class="n">instrument</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1380"><a href="#-1380"><span class="linenos">1380</span></a>                <span class="n">action</span> <span class="o">=</span> <span class="n">TKS_STOP_ORDER_DIRECTIONS</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;direction&quot;</span><span class="p">]]</span>
</span><span id="TinkoffBrokerServer.Overview-1381"><a href="#-1381"><span class="linenos">1381</span></a>                <span class="n">orderType</span> <span class="o">=</span> <span class="n">TKS_STOP_ORDER_TYPES</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;orderType&quot;</span><span class="p">]]</span>
</span><span id="TinkoffBrokerServer.Overview-1382"><a href="#-1382"><span class="linenos">1382</span></a>                <span class="n">createDate</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;createDate&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># date in UTC format, e.g. &quot;2022-12-31T23:59:59.123456Z&quot;</span>
</span><span id="TinkoffBrokerServer.Overview-1383"><a href="#-1383"><span class="linenos">1383</span></a>
</span><span id="TinkoffBrokerServer.Overview-1384"><a href="#-1384"><span class="linenos">1384</span></a>                <span class="c1"># hack: server response can&#39;t contain &quot;expirationTime&quot; key if it is not &quot;Until date&quot; type of stop order</span>
</span><span id="TinkoffBrokerServer.Overview-1385"><a href="#-1385"><span class="linenos">1385</span></a>                <span class="k">if</span> <span class="s2">&quot;expirationTime&quot;</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.Overview-1386"><a href="#-1386"><span class="linenos">1386</span></a>                    <span class="n">expType</span> <span class="o">=</span> <span class="n">TKS_STOP_ORDER_EXPIRATION_TYPES</span><span class="p">[</span><span class="s2">&quot;STOP_ORDER_EXPIRATION_TYPE_GOOD_TILL_DATE&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer.Overview-1387"><a href="#-1387"><span class="linenos">1387</span></a>                    <span class="n">expDate</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;expirationTime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer.Overview-1388"><a href="#-1388"><span class="linenos">1388</span></a>
</span><span id="TinkoffBrokerServer.Overview-1389"><a href="#-1389"><span class="linenos">1389</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1390"><a href="#-1390"><span class="linenos">1390</span></a>                    <span class="n">expType</span> <span class="o">=</span> <span class="n">TKS_STOP_ORDER_EXPIRATION_TYPES</span><span class="p">[</span><span class="s2">&quot;STOP_ORDER_EXPIRATION_TYPE_GOOD_TILL_CANCEL&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer.Overview-1391"><a href="#-1391"><span class="linenos">1391</span></a>                    <span class="n">expDate</span> <span class="o">=</span> <span class="n">TKS_STOP_ORDER_EXPIRATION_TYPES</span><span class="p">[</span><span class="s2">&quot;STOP_ORDER_EXPIRATION_TYPE_UNSPECIFIED&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer.Overview-1392"><a href="#-1392"><span class="linenos">1392</span></a>
</span><span id="TinkoffBrokerServer.Overview-1393"><a href="#-1393"><span class="linenos">1393</span></a>                <span class="c1"># current instrument&#39;s price (last sellers order if buy, and last buyers order if sell):</span>
</span><span id="TinkoffBrokerServer.Overview-1394"><a href="#-1394"><span class="linenos">1394</span></a>                <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;direction&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;STOP_ORDER_DIRECTION_BUY&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1395"><a href="#-1395"><span class="linenos">1395</span></a>                    <span class="n">lastPrice</span> <span class="o">=</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;sell&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;price&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;sell&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span>
</span><span id="TinkoffBrokerServer.Overview-1396"><a href="#-1396"><span class="linenos">1396</span></a>
</span><span id="TinkoffBrokerServer.Overview-1397"><a href="#-1397"><span class="linenos">1397</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1398"><a href="#-1398"><span class="linenos">1398</span></a>                    <span class="n">lastPrice</span> <span class="o">=</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;buy&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;price&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;buy&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span>
</span><span id="TinkoffBrokerServer.Overview-1399"><a href="#-1399"><span class="linenos">1399</span></a>
</span><span id="TinkoffBrokerServer.Overview-1400"><a href="#-1400"><span class="linenos">1400</span></a>                <span class="c1"># requested price when stop-order executed:</span>
</span><span id="TinkoffBrokerServer.Overview-1401"><a href="#-1401"><span class="linenos">1401</span></a>                <span class="n">target</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;stopPrice&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;stopPrice&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>
</span><span id="TinkoffBrokerServer.Overview-1402"><a href="#-1402"><span class="linenos">1402</span></a>
</span><span id="TinkoffBrokerServer.Overview-1403"><a href="#-1403"><span class="linenos">1403</span></a>                <span class="c1"># price for limit-order, set up when stop-order executed:</span>
</span><span id="TinkoffBrokerServer.Overview-1404"><a href="#-1404"><span class="linenos">1404</span></a>                <span class="n">limit</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>
</span><span id="TinkoffBrokerServer.Overview-1405"><a href="#-1405"><span class="linenos">1405</span></a>
</span><span id="TinkoffBrokerServer.Overview-1406"><a href="#-1406"><span class="linenos">1406</span></a>                <span class="c1"># necessary changes in percent to reach target from current price:</span>
</span><span id="TinkoffBrokerServer.Overview-1407"><a href="#-1407"><span class="linenos">1407</span></a>                <span class="n">changes</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">lastPrice</span> <span class="o">-</span> <span class="n">target</span><span class="p">)</span> <span class="o">/</span> <span class="n">target</span> <span class="k">if</span> <span class="n">lastPrice</span> <span class="o">!=</span> <span class="s2">&quot;N/A&quot;</span> <span class="ow">and</span> <span class="n">target</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="TinkoffBrokerServer.Overview-1408"><a href="#-1408"><span class="linenos">1408</span></a>
</span><span id="TinkoffBrokerServer.Overview-1409"><a href="#-1409"><span class="linenos">1409</span></a>                <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;stopOrders&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="TinkoffBrokerServer.Overview-1410"><a href="#-1410"><span class="linenos">1410</span></a>                    <span class="s2">&quot;orderID&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;stopOrderId&quot;</span><span class="p">],</span>  <span class="c1"># stopOrderId number parameter of current stop-order</span>
</span><span id="TinkoffBrokerServer.Overview-1411"><a href="#-1411"><span class="linenos">1411</span></a>                    <span class="s2">&quot;figi&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">],</span>  <span class="c1"># FIGI identification</span>
</span><span id="TinkoffBrokerServer.Overview-1412"><a href="#-1412"><span class="linenos">1412</span></a>                    <span class="s2">&quot;ticker&quot;</span><span class="p">:</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">],</span>  <span class="c1"># ticker name by FIGI</span>
</span><span id="TinkoffBrokerServer.Overview-1413"><a href="#-1413"><span class="linenos">1413</span></a>                    <span class="s2">&quot;lotsRequested&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;lotsRequested&quot;</span><span class="p">],</span>  <span class="c1"># requested lots value</span>
</span><span id="TinkoffBrokerServer.Overview-1414"><a href="#-1414"><span class="linenos">1414</span></a>                    <span class="s2">&quot;currentPrice&quot;</span><span class="p">:</span> <span class="n">lastPrice</span><span class="p">,</span>  <span class="c1"># current instrument&#39;s price for defined action</span>
</span><span id="TinkoffBrokerServer.Overview-1415"><a href="#-1415"><span class="linenos">1415</span></a>                    <span class="s2">&quot;targetPrice&quot;</span><span class="p">:</span> <span class="n">target</span><span class="p">,</span>  <span class="c1"># requested price for stop-order execution in base currency</span>
</span><span id="TinkoffBrokerServer.Overview-1416"><a href="#-1416"><span class="linenos">1416</span></a>                    <span class="s2">&quot;limitPrice&quot;</span><span class="p">:</span> <span class="n">limit</span><span class="p">,</span>  <span class="c1"># price for limit-order, set up when stop-order executed, 0 if market order</span>
</span><span id="TinkoffBrokerServer.Overview-1417"><a href="#-1417"><span class="linenos">1417</span></a>                    <span class="s2">&quot;baseCurrencyName&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;stopPrice&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>  <span class="c1"># name of base currency</span>
</span><span id="TinkoffBrokerServer.Overview-1418"><a href="#-1418"><span class="linenos">1418</span></a>                    <span class="s2">&quot;percentChanges&quot;</span><span class="p">:</span> <span class="n">changes</span><span class="p">,</span>  <span class="c1"># changes in percent to target from current price</span>
</span><span id="TinkoffBrokerServer.Overview-1419"><a href="#-1419"><span class="linenos">1419</span></a>                    <span class="s2">&quot;currency&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>  <span class="c1"># instrument&#39;s currency name</span>
</span><span id="TinkoffBrokerServer.Overview-1420"><a href="#-1420"><span class="linenos">1420</span></a>                    <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span>  <span class="c1"># sell / buy / Unknown from TKS_STOP_ORDER_DIRECTIONS</span>
</span><span id="TinkoffBrokerServer.Overview-1421"><a href="#-1421"><span class="linenos">1421</span></a>                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">orderType</span><span class="p">,</span>  <span class="c1"># type of order from TKS_STOP_ORDER_TYPES</span>
</span><span id="TinkoffBrokerServer.Overview-1422"><a href="#-1422"><span class="linenos">1422</span></a>                    <span class="s2">&quot;expType&quot;</span><span class="p">:</span> <span class="n">expType</span><span class="p">,</span>  <span class="c1"># expiration type of stop-order from TKS_STOP_ORDER_EXPIRATION_TYPES</span>
</span><span id="TinkoffBrokerServer.Overview-1423"><a href="#-1423"><span class="linenos">1423</span></a>                    <span class="s2">&quot;createDate&quot;</span><span class="p">:</span> <span class="n">createDate</span><span class="p">,</span>  <span class="c1"># string with created order date and time from UTC format (without nano seconds part)</span>
</span><span id="TinkoffBrokerServer.Overview-1424"><a href="#-1424"><span class="linenos">1424</span></a>                    <span class="s2">&quot;expDate&quot;</span><span class="p">:</span> <span class="n">expDate</span><span class="p">,</span>  <span class="c1"># string with expiration order date and time from UTC format (without nano seconds part)</span>
</span><span id="TinkoffBrokerServer.Overview-1425"><a href="#-1425"><span class="linenos">1425</span></a>                <span class="p">})</span>
</span><span id="TinkoffBrokerServer.Overview-1426"><a href="#-1426"><span class="linenos">1426</span></a>
</span><span id="TinkoffBrokerServer.Overview-1427"><a href="#-1427"><span class="linenos">1427</span></a>        <span class="c1"># --- calculating data for analytics section:</span>
</span><span id="TinkoffBrokerServer.Overview-1428"><a href="#-1428"><span class="linenos">1428</span></a>        <span class="c1"># portfolio distribution by assets:</span>
</span><span id="TinkoffBrokerServer.Overview-1429"><a href="#-1429"><span class="linenos">1429</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByAssets&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="TinkoffBrokerServer.Overview-1430"><a href="#-1430"><span class="linenos">1430</span></a>            <span class="s2">&quot;Ruble&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="TinkoffBrokerServer.Overview-1431"><a href="#-1431"><span class="linenos">1431</span></a>                <span class="s2">&quot;uniques&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Overview-1432"><a href="#-1432"><span class="linenos">1432</span></a>                <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;availableRUB&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1433"><a href="#-1433"><span class="linenos">1433</span></a>                <span class="s2">&quot;percent&quot;</span><span class="p">:</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;availableRUB&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Overview-1434"><a href="#-1434"><span class="linenos">1434</span></a>            <span class="p">},</span>
</span><span id="TinkoffBrokerServer.Overview-1435"><a href="#-1435"><span class="linenos">1435</span></a>            <span class="s2">&quot;Currencies&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="TinkoffBrokerServer.Overview-1436"><a href="#-1436"><span class="linenos">1436</span></a>                <span class="s2">&quot;uniques&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Currencies&quot;</span><span class="p">]),</span>  <span class="c1"># all foreign currencies without RUB</span>
</span><span id="TinkoffBrokerServer.Overview-1437"><a href="#-1437"><span class="linenos">1437</span></a>                <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;allCurrenciesCostRUB&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;availableRUB&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1438"><a href="#-1438"><span class="linenos">1438</span></a>                <span class="s2">&quot;percent&quot;</span><span class="p">:</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;allCurrenciesCostRUB&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;availableRUB&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Overview-1439"><a href="#-1439"><span class="linenos">1439</span></a>            <span class="p">},</span>
</span><span id="TinkoffBrokerServer.Overview-1440"><a href="#-1440"><span class="linenos">1440</span></a>            <span class="s2">&quot;Shares&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="TinkoffBrokerServer.Overview-1441"><a href="#-1441"><span class="linenos">1441</span></a>                <span class="s2">&quot;uniques&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Shares&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer.Overview-1442"><a href="#-1442"><span class="linenos">1442</span></a>                <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;stocksCostRUB&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1443"><a href="#-1443"><span class="linenos">1443</span></a>                <span class="s2">&quot;percent&quot;</span><span class="p">:</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;stocksCostRUB&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Overview-1444"><a href="#-1444"><span class="linenos">1444</span></a>            <span class="p">},</span>
</span><span id="TinkoffBrokerServer.Overview-1445"><a href="#-1445"><span class="linenos">1445</span></a>            <span class="s2">&quot;Bonds&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="TinkoffBrokerServer.Overview-1446"><a href="#-1446"><span class="linenos">1446</span></a>                <span class="s2">&quot;uniques&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Bonds&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer.Overview-1447"><a href="#-1447"><span class="linenos">1447</span></a>                <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;bondsCostRUB&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1448"><a href="#-1448"><span class="linenos">1448</span></a>                <span class="s2">&quot;percent&quot;</span><span class="p">:</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;bondsCostRUB&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Overview-1449"><a href="#-1449"><span class="linenos">1449</span></a>            <span class="p">},</span>
</span><span id="TinkoffBrokerServer.Overview-1450"><a href="#-1450"><span class="linenos">1450</span></a>            <span class="s2">&quot;Etfs&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="TinkoffBrokerServer.Overview-1451"><a href="#-1451"><span class="linenos">1451</span></a>                <span class="s2">&quot;uniques&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Etfs&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer.Overview-1452"><a href="#-1452"><span class="linenos">1452</span></a>                <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;etfsCostRUB&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1453"><a href="#-1453"><span class="linenos">1453</span></a>                <span class="s2">&quot;percent&quot;</span><span class="p">:</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;etfsCostRUB&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Overview-1454"><a href="#-1454"><span class="linenos">1454</span></a>            <span class="p">},</span>
</span><span id="TinkoffBrokerServer.Overview-1455"><a href="#-1455"><span class="linenos">1455</span></a>            <span class="s2">&quot;Futures&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="TinkoffBrokerServer.Overview-1456"><a href="#-1456"><span class="linenos">1456</span></a>                <span class="s2">&quot;uniques&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Futures&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer.Overview-1457"><a href="#-1457"><span class="linenos">1457</span></a>                <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;futuresCostRUB&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1458"><a href="#-1458"><span class="linenos">1458</span></a>                <span class="s2">&quot;percent&quot;</span><span class="p">:</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;futuresCostRUB&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Overview-1459"><a href="#-1459"><span class="linenos">1459</span></a>            <span class="p">},</span>
</span><span id="TinkoffBrokerServer.Overview-1460"><a href="#-1460"><span class="linenos">1460</span></a>        <span class="p">}</span>
</span><span id="TinkoffBrokerServer.Overview-1461"><a href="#-1461"><span class="linenos">1461</span></a>
</span><span id="TinkoffBrokerServer.Overview-1462"><a href="#-1462"><span class="linenos">1462</span></a>        <span class="c1"># portfolio distribution by companies:</span>
</span><span id="TinkoffBrokerServer.Overview-1463"><a href="#-1463"><span class="linenos">1463</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCompanies&quot;</span><span class="p">][</span><span class="s2">&quot;All money cash&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="TinkoffBrokerServer.Overview-1464"><a href="#-1464"><span class="linenos">1464</span></a>            <span class="s2">&quot;ticker&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Overview-1465"><a href="#-1465"><span class="linenos">1465</span></a>            <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;allCurrenciesCostRUB&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1466"><a href="#-1466"><span class="linenos">1466</span></a>            <span class="s2">&quot;percent&quot;</span><span class="p">:</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;allCurrenciesCostRUB&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Overview-1467"><a href="#-1467"><span class="linenos">1467</span></a>        <span class="p">}</span>
</span><span id="TinkoffBrokerServer.Overview-1468"><a href="#-1468"><span class="linenos">1468</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCompanies&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">byComp</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Overview-1469"><a href="#-1469"><span class="linenos">1469</span></a>
</span><span id="TinkoffBrokerServer.Overview-1470"><a href="#-1470"><span class="linenos">1470</span></a>        <span class="c1"># portfolio distribution by sectors:</span>
</span><span id="TinkoffBrokerServer.Overview-1471"><a href="#-1471"><span class="linenos">1471</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrBySectors&quot;</span><span class="p">][</span><span class="s2">&quot;All money cash&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="TinkoffBrokerServer.Overview-1472"><a href="#-1472"><span class="linenos">1472</span></a>            <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCompanies&quot;</span><span class="p">][</span><span class="s2">&quot;All money cash&quot;</span><span class="p">][</span><span class="s2">&quot;cost&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1473"><a href="#-1473"><span class="linenos">1473</span></a>            <span class="s2">&quot;percent&quot;</span><span class="p">:</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCompanies&quot;</span><span class="p">][</span><span class="s2">&quot;All money cash&quot;</span><span class="p">][</span><span class="s2">&quot;percent&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1474"><a href="#-1474"><span class="linenos">1474</span></a>        <span class="p">}</span>
</span><span id="TinkoffBrokerServer.Overview-1475"><a href="#-1475"><span class="linenos">1475</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrBySectors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">bySect</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Overview-1476"><a href="#-1476"><span class="linenos">1476</span></a>
</span><span id="TinkoffBrokerServer.Overview-1477"><a href="#-1477"><span class="linenos">1477</span></a>        <span class="c1"># portfolio distribution by currencies:</span>
</span><span id="TinkoffBrokerServer.Overview-1478"><a href="#-1478"><span class="linenos">1478</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCurrencies&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">byCurr</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Overview-1479"><a href="#-1479"><span class="linenos">1479</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCurrencies&quot;</span><span class="p">][</span><span class="s2">&quot;rub&quot;</span><span class="p">][</span><span class="s2">&quot;cost&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByAssets&quot;</span><span class="p">][</span><span class="s2">&quot;Ruble&quot;</span><span class="p">][</span><span class="s2">&quot;cost&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer.Overview-1480"><a href="#-1480"><span class="linenos">1480</span></a>        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCurrencies&quot;</span><span class="p">][</span><span class="s2">&quot;rub&quot;</span><span class="p">][</span><span class="s2">&quot;percent&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByAssets&quot;</span><span class="p">][</span><span class="s2">&quot;Ruble&quot;</span><span class="p">][</span><span class="s2">&quot;percent&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer.Overview-1481"><a href="#-1481"><span class="linenos">1481</span></a>
</span><span id="TinkoffBrokerServer.Overview-1482"><a href="#-1482"><span class="linenos">1482</span></a>        <span class="c1"># --- Prepare text statistics overview in human-readable:</span>
</span><span id="TinkoffBrokerServer.Overview-1483"><a href="#-1483"><span class="linenos">1483</span></a>        <span class="k">if</span> <span class="n">showStatistics</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1484"><a href="#-1484"><span class="linenos">1484</span></a>            <span class="n">info</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="TinkoffBrokerServer.Overview-1485"><a href="#-1485"><span class="linenos">1485</span></a>                <span class="s2">&quot;# Client&#39;s portfolio</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Overview-1486"><a href="#-1486"><span class="linenos">1486</span></a>                <span class="s2">&quot;* **Actual date:** [</span><span class="si">{}</span><span class="s2">] (UTC)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tzutc</span><span class="p">())</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)),</span>
</span><span id="TinkoffBrokerServer.Overview-1487"><a href="#-1487"><span class="linenos">1487</span></a>                <span class="s2">&quot;* **Portfolio cost:** </span><span class="si">{:.2f}</span><span class="s2"> RUB</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer.Overview-1488"><a href="#-1488"><span class="linenos">1488</span></a>                <span class="s2">&quot;* **Changes:** </span><span class="si">{}{:.2f}</span><span class="s2"> RUB (</span><span class="si">{}{:.2f}</span><span class="s2">%)</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.Overview-1489"><a href="#-1489"><span class="linenos">1489</span></a>                    <span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;totalChangesRUB&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Overview-1490"><a href="#-1490"><span class="linenos">1490</span></a>                    <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;totalChangesRUB&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1491"><a href="#-1491"><span class="linenos">1491</span></a>                    <span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;totalChangesPercentRUB&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Overview-1492"><a href="#-1492"><span class="linenos">1492</span></a>                    <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;totalChangesPercentRUB&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1493"><a href="#-1493"><span class="linenos">1493</span></a>                <span class="p">),</span>
</span><span id="TinkoffBrokerServer.Overview-1494"><a href="#-1494"><span class="linenos">1494</span></a>                <span class="s2">&quot;## Open positions</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Overview-1495"><a href="#-1495"><span class="linenos">1495</span></a>                <span class="s2">&quot;| Ticker [FIGI]               | Volume (blocked)                | Lots     | Curr. price  | Avg. price   | Current volume cost | Profit (%)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Overview-1496"><a href="#-1496"><span class="linenos">1496</span></a>                <span class="s2">&quot;|-----------------------------|---------------------------------|----------|--------------|--------------|---------------------|----------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Overview-1497"><a href="#-1497"><span class="linenos">1497</span></a>                <span class="s2">&quot;| Ruble                       | </span><span class="si">{:&gt;31}</span><span class="s2"> |          |              |              |                     |</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.Overview-1498"><a href="#-1498"><span class="linenos">1498</span></a>                    <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2"> (</span><span class="si">{:.2f}</span><span class="s2">) rub&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.Overview-1499"><a href="#-1499"><span class="linenos">1499</span></a>                        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;availableRUB&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1500"><a href="#-1500"><span class="linenos">1500</span></a>                        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;currentBlockedRUB&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1501"><a href="#-1501"><span class="linenos">1501</span></a>                    <span class="p">)</span>
</span><span id="TinkoffBrokerServer.Overview-1502"><a href="#-1502"><span class="linenos">1502</span></a>                <span class="p">)</span>
</span><span id="TinkoffBrokerServer.Overview-1503"><a href="#-1503"><span class="linenos">1503</span></a>            <span class="p">]</span>
</span><span id="TinkoffBrokerServer.Overview-1504"><a href="#-1504"><span class="linenos">1504</span></a>
</span><span id="TinkoffBrokerServer.Overview-1505"><a href="#-1505"><span class="linenos">1505</span></a>            <span class="k">def</span> <span class="nf">_SplitStr</span><span class="p">(</span><span class="n">CostRUB</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">typeStr</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">noTradeStr</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1506"><a href="#-1506"><span class="linenos">1506</span></a>                <span class="k">return</span> <span class="p">[</span>
</span><span id="TinkoffBrokerServer.Overview-1507"><a href="#-1507"><span class="linenos">1507</span></a>                    <span class="s2">&quot;|                             |                                 |          |              |              |                     |</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Overview-1508"><a href="#-1508"><span class="linenos">1508</span></a>                    <span class="s2">&quot;| </span><span class="si">{:&lt;27}</span><span class="s2"> |                                 |          |              |              | </span><span class="si">{:&gt;19}</span><span class="s2"> |</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.Overview-1509"><a href="#-1509"><span class="linenos">1509</span></a>                        <span class="n">noTradeStr</span> <span class="k">if</span> <span class="n">noTradeStr</span> <span class="k">else</span> <span class="n">typeStr</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Overview-1510"><a href="#-1510"><span class="linenos">1510</span></a>                        <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">noTradeStr</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2"> RUB&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">CostRUB</span><span class="p">),</span>
</span><span id="TinkoffBrokerServer.Overview-1511"><a href="#-1511"><span class="linenos">1511</span></a>                    <span class="p">),</span>
</span><span id="TinkoffBrokerServer.Overview-1512"><a href="#-1512"><span class="linenos">1512</span></a>                <span class="p">]</span>
</span><span id="TinkoffBrokerServer.Overview-1513"><a href="#-1513"><span class="linenos">1513</span></a>
</span><span id="TinkoffBrokerServer.Overview-1514"><a href="#-1514"><span class="linenos">1514</span></a>            <span class="k">def</span> <span class="nf">_InfoStr</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">showCurrencyName</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1515"><a href="#-1515"><span class="linenos">1515</span></a>                <span class="k">return</span> <span class="s2">&quot;| </span><span class="si">{:&lt;27}</span><span class="s2"> | </span><span class="si">{:&gt;31}</span><span class="s2"> | </span><span class="si">{:&lt;8}</span><span class="s2"> | </span><span class="si">{:&gt;12}</span><span class="s2"> | </span><span class="si">{:&gt;12}</span><span class="s2"> | </span><span class="si">{:&gt;19}</span><span class="s2"> | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.Overview-1516"><a href="#-1516"><span class="linenos">1516</span></a>                    <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer.Overview-1517"><a href="#-1517"><span class="linenos">1517</span></a>                    <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2"> (</span><span class="si">{:.2f}</span><span class="s2">) </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.Overview-1518"><a href="#-1518"><span class="linenos">1518</span></a>                        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;volume&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1519"><a href="#-1519"><span class="linenos">1519</span></a>                        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;blocked&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1520"><a href="#-1520"><span class="linenos">1520</span></a>                        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1521"><a href="#-1521"><span class="linenos">1521</span></a>                    <span class="p">)</span> <span class="k">if</span> <span class="n">showCurrencyName</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2"> (</span><span class="si">{:.0f}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.Overview-1522"><a href="#-1522"><span class="linenos">1522</span></a>                        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;volume&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1523"><a href="#-1523"><span class="linenos">1523</span></a>                        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;blocked&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1524"><a href="#-1524"><span class="linenos">1524</span></a>                    <span class="p">),</span>
</span><span id="TinkoffBrokerServer.Overview-1525"><a href="#-1525"><span class="linenos">1525</span></a>                    <span class="s2">&quot;</span><span class="si">{:.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;lots&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">showCurrencyName</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;lots&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer.Overview-1526"><a href="#-1526"><span class="linenos">1526</span></a>                    <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;baseCurrencyName&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;n/a&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Overview-1527"><a href="#-1527"><span class="linenos">1527</span></a>                    <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;average&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;baseCurrencyName&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;average&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;n/a&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Overview-1528"><a href="#-1528"><span class="linenos">1528</span></a>                    <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cost&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;baseCurrencyName&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer.Overview-1529"><a href="#-1529"><span class="linenos">1529</span></a>                    <span class="s2">&quot;</span><span class="si">{}{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}{:.2f}</span><span class="s2">%)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.Overview-1530"><a href="#-1530"><span class="linenos">1530</span></a>                        <span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;profit&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Overview-1531"><a href="#-1531"><span class="linenos">1531</span></a>                        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;profit&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;baseCurrencyName&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1532"><a href="#-1532"><span class="linenos">1532</span></a>                        <span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;percentProfit&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Overview-1533"><a href="#-1533"><span class="linenos">1533</span></a>                        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;percentProfit&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1534"><a href="#-1534"><span class="linenos">1534</span></a>                    <span class="p">),</span>
</span><span id="TinkoffBrokerServer.Overview-1535"><a href="#-1535"><span class="linenos">1535</span></a>                <span class="p">)</span>
</span><span id="TinkoffBrokerServer.Overview-1536"><a href="#-1536"><span class="linenos">1536</span></a>
</span><span id="TinkoffBrokerServer.Overview-1537"><a href="#-1537"><span class="linenos">1537</span></a>            <span class="c1"># --- Show currencies section:</span>
</span><span id="TinkoffBrokerServer.Overview-1538"><a href="#-1538"><span class="linenos">1538</span></a>            <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Currencies&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.Overview-1539"><a href="#-1539"><span class="linenos">1539</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_SplitStr</span><span class="p">(</span><span class="n">CostRUB</span><span class="o">=</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByAssets&quot;</span><span class="p">][</span><span class="s2">&quot;Currencies&quot;</span><span class="p">][</span><span class="s2">&quot;cost&quot;</span><span class="p">],</span> <span class="n">typeStr</span><span class="o">=</span><span class="s2">&quot;**Currencies:**&quot;</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.Overview-1540"><a href="#-1540"><span class="linenos">1540</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Currencies&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.Overview-1541"><a href="#-1541"><span class="linenos">1541</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_InfoStr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">showCurrencyName</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.Overview-1542"><a href="#-1542"><span class="linenos">1542</span></a>
</span><span id="TinkoffBrokerServer.Overview-1543"><a href="#-1543"><span class="linenos">1543</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1544"><a href="#-1544"><span class="linenos">1544</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_SplitStr</span><span class="p">(</span><span class="n">noTradeStr</span><span class="o">=</span><span class="s2">&quot;**Currencies:** no trades&quot;</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.Overview-1545"><a href="#-1545"><span class="linenos">1545</span></a>
</span><span id="TinkoffBrokerServer.Overview-1546"><a href="#-1546"><span class="linenos">1546</span></a>            <span class="c1"># --- Show stocks section:</span>
</span><span id="TinkoffBrokerServer.Overview-1547"><a href="#-1547"><span class="linenos">1547</span></a>            <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Shares&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.Overview-1548"><a href="#-1548"><span class="linenos">1548</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_SplitStr</span><span class="p">(</span><span class="n">CostRUB</span><span class="o">=</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;stocksCostRUB&quot;</span><span class="p">],</span> <span class="n">typeStr</span><span class="o">=</span><span class="s2">&quot;**Stocks:**&quot;</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.Overview-1549"><a href="#-1549"><span class="linenos">1549</span></a>
</span><span id="TinkoffBrokerServer.Overview-1550"><a href="#-1550"><span class="linenos">1550</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Shares&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.Overview-1551"><a href="#-1551"><span class="linenos">1551</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_InfoStr</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.Overview-1552"><a href="#-1552"><span class="linenos">1552</span></a>
</span><span id="TinkoffBrokerServer.Overview-1553"><a href="#-1553"><span class="linenos">1553</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1554"><a href="#-1554"><span class="linenos">1554</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_SplitStr</span><span class="p">(</span><span class="n">noTradeStr</span><span class="o">=</span><span class="s2">&quot;**Stocks:** no trades&quot;</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.Overview-1555"><a href="#-1555"><span class="linenos">1555</span></a>
</span><span id="TinkoffBrokerServer.Overview-1556"><a href="#-1556"><span class="linenos">1556</span></a>            <span class="c1"># --- Show bonds section:</span>
</span><span id="TinkoffBrokerServer.Overview-1557"><a href="#-1557"><span class="linenos">1557</span></a>            <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Bonds&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.Overview-1558"><a href="#-1558"><span class="linenos">1558</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_SplitStr</span><span class="p">(</span><span class="n">CostRUB</span><span class="o">=</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;bondsCostRUB&quot;</span><span class="p">],</span> <span class="n">typeStr</span><span class="o">=</span><span class="s2">&quot;**Bonds:**&quot;</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.Overview-1559"><a href="#-1559"><span class="linenos">1559</span></a>
</span><span id="TinkoffBrokerServer.Overview-1560"><a href="#-1560"><span class="linenos">1560</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Bonds&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.Overview-1561"><a href="#-1561"><span class="linenos">1561</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_InfoStr</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.Overview-1562"><a href="#-1562"><span class="linenos">1562</span></a>
</span><span id="TinkoffBrokerServer.Overview-1563"><a href="#-1563"><span class="linenos">1563</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1564"><a href="#-1564"><span class="linenos">1564</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_SplitStr</span><span class="p">(</span><span class="n">noTradeStr</span><span class="o">=</span><span class="s2">&quot;**Bonds:** no trades&quot;</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.Overview-1565"><a href="#-1565"><span class="linenos">1565</span></a>
</span><span id="TinkoffBrokerServer.Overview-1566"><a href="#-1566"><span class="linenos">1566</span></a>            <span class="c1"># --- Show etfs section:</span>
</span><span id="TinkoffBrokerServer.Overview-1567"><a href="#-1567"><span class="linenos">1567</span></a>            <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Etfs&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.Overview-1568"><a href="#-1568"><span class="linenos">1568</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_SplitStr</span><span class="p">(</span><span class="n">CostRUB</span><span class="o">=</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;etfsCostRUB&quot;</span><span class="p">],</span> <span class="n">typeStr</span><span class="o">=</span><span class="s2">&quot;**Etfs:**&quot;</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.Overview-1569"><a href="#-1569"><span class="linenos">1569</span></a>
</span><span id="TinkoffBrokerServer.Overview-1570"><a href="#-1570"><span class="linenos">1570</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Etfs&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.Overview-1571"><a href="#-1571"><span class="linenos">1571</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_InfoStr</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.Overview-1572"><a href="#-1572"><span class="linenos">1572</span></a>
</span><span id="TinkoffBrokerServer.Overview-1573"><a href="#-1573"><span class="linenos">1573</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1574"><a href="#-1574"><span class="linenos">1574</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_SplitStr</span><span class="p">(</span><span class="n">noTradeStr</span><span class="o">=</span><span class="s2">&quot;**Etfs:** no trades&quot;</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.Overview-1575"><a href="#-1575"><span class="linenos">1575</span></a>
</span><span id="TinkoffBrokerServer.Overview-1576"><a href="#-1576"><span class="linenos">1576</span></a>            <span class="c1"># --- Show futures section:</span>
</span><span id="TinkoffBrokerServer.Overview-1577"><a href="#-1577"><span class="linenos">1577</span></a>            <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Futures&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.Overview-1578"><a href="#-1578"><span class="linenos">1578</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_SplitStr</span><span class="p">(</span><span class="n">CostRUB</span><span class="o">=</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;futuresCostRUB&quot;</span><span class="p">],</span> <span class="n">typeStr</span><span class="o">=</span><span class="s2">&quot;**Futures:**&quot;</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.Overview-1579"><a href="#-1579"><span class="linenos">1579</span></a>
</span><span id="TinkoffBrokerServer.Overview-1580"><a href="#-1580"><span class="linenos">1580</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;Futures&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.Overview-1581"><a href="#-1581"><span class="linenos">1581</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_InfoStr</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.Overview-1582"><a href="#-1582"><span class="linenos">1582</span></a>
</span><span id="TinkoffBrokerServer.Overview-1583"><a href="#-1583"><span class="linenos">1583</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1584"><a href="#-1584"><span class="linenos">1584</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_SplitStr</span><span class="p">(</span><span class="n">noTradeStr</span><span class="o">=</span><span class="s2">&quot;**Futures:** no trades&quot;</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.Overview-1585"><a href="#-1585"><span class="linenos">1585</span></a>
</span><span id="TinkoffBrokerServer.Overview-1586"><a href="#-1586"><span class="linenos">1586</span></a>            <span class="c1"># --- Show pending orders section:</span>
</span><span id="TinkoffBrokerServer.Overview-1587"><a href="#-1587"><span class="linenos">1587</span></a>            <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;orders&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.Overview-1588"><a href="#-1588"><span class="linenos">1588</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span><span id="TinkoffBrokerServer.Overview-1589"><a href="#-1589"><span class="linenos">1589</span></a>                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">## Opened pending limit-orders: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;orders&quot;</span><span class="p">])),</span>
</span><span id="TinkoffBrokerServer.Overview-1590"><a href="#-1590"><span class="linenos">1590</span></a>                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">| Ticker [FIGI]               | Order ID       | Lots (exec.) | Current price (</span><span class="si">% d</span><span class="s2">elta) | Target price  | Action    | Type      | Create date (UTC)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Overview-1591"><a href="#-1591"><span class="linenos">1591</span></a>                    <span class="s2">&quot;|-----------------------------|----------------|--------------|-------------------------|---------------|-----------|-----------|---------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Overview-1592"><a href="#-1592"><span class="linenos">1592</span></a>                <span class="p">])</span>
</span><span id="TinkoffBrokerServer.Overview-1593"><a href="#-1593"><span class="linenos">1593</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;orders&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.Overview-1594"><a href="#-1594"><span class="linenos">1594</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| </span><span class="si">{:&lt;27}</span><span class="s2"> | </span><span class="si">{:&lt;14}</span><span class="s2"> | </span><span class="si">{:&lt;12}</span><span class="s2"> | </span><span class="si">{:&gt;23}</span><span class="s2"> | </span><span class="si">{:&gt;13}</span><span class="s2"> | </span><span class="si">{:&lt;9}</span><span class="s2"> | </span><span class="si">{:&lt;9}</span><span class="s2"> | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.Overview-1595"><a href="#-1595"><span class="linenos">1595</span></a>                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer.Overview-1596"><a href="#-1596"><span class="linenos">1596</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;orderID&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1597"><a href="#-1597"><span class="linenos">1597</span></a>                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;lotsRequested&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;lotsExecuted&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer.Overview-1598"><a href="#-1598"><span class="linenos">1598</span></a>                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}{:.2f}</span><span class="s2">%)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.Overview-1599"><a href="#-1599"><span class="linenos">1599</span></a>                            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">])),</span>
</span><span id="TinkoffBrokerServer.Overview-1600"><a href="#-1600"><span class="linenos">1600</span></a>                            <span class="n">item</span><span class="p">[</span><span class="s2">&quot;baseCurrencyName&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1601"><a href="#-1601"><span class="linenos">1601</span></a>                            <span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;percentChanges&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Overview-1602"><a href="#-1602"><span class="linenos">1602</span></a>                            <span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;percentChanges&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer.Overview-1603"><a href="#-1603"><span class="linenos">1603</span></a>                        <span class="p">),</span>
</span><span id="TinkoffBrokerServer.Overview-1604"><a href="#-1604"><span class="linenos">1604</span></a>                        <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;targetPrice&quot;</span><span class="p">]),</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;baseCurrencyName&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer.Overview-1605"><a href="#-1605"><span class="linenos">1605</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1606"><a href="#-1606"><span class="linenos">1606</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1607"><a href="#-1607"><span class="linenos">1607</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1608"><a href="#-1608"><span class="linenos">1608</span></a>                    <span class="p">))</span>
</span><span id="TinkoffBrokerServer.Overview-1609"><a href="#-1609"><span class="linenos">1609</span></a>
</span><span id="TinkoffBrokerServer.Overview-1610"><a href="#-1610"><span class="linenos">1610</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1611"><a href="#-1611"><span class="linenos">1611</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">## Total pending limit-orders: 0</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Overview-1612"><a href="#-1612"><span class="linenos">1612</span></a>
</span><span id="TinkoffBrokerServer.Overview-1613"><a href="#-1613"><span class="linenos">1613</span></a>            <span class="c1"># --- Show stop orders section:</span>
</span><span id="TinkoffBrokerServer.Overview-1614"><a href="#-1614"><span class="linenos">1614</span></a>            <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;stopOrders&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.Overview-1615"><a href="#-1615"><span class="linenos">1615</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span><span id="TinkoffBrokerServer.Overview-1616"><a href="#-1616"><span class="linenos">1616</span></a>                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">## Opened stop-orders: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;stopOrders&quot;</span><span class="p">])),</span>
</span><span id="TinkoffBrokerServer.Overview-1617"><a href="#-1617"><span class="linenos">1617</span></a>                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">| Ticker [FIGI]               | Stop order ID                        | Lots   | Current price (</span><span class="si">% d</span><span class="s2">elta) | Target price  | Limit price   | Action    | Type        | Expire type  | Create date (UTC)   | Expiration (UTC)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Overview-1618"><a href="#-1618"><span class="linenos">1618</span></a>                    <span class="s2">&quot;|-----------------------------|--------------------------------------|--------|-------------------------|---------------|---------------|-----------|-------------|--------------|---------------------|---------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Overview-1619"><a href="#-1619"><span class="linenos">1619</span></a>                <span class="p">])</span>
</span><span id="TinkoffBrokerServer.Overview-1620"><a href="#-1620"><span class="linenos">1620</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;stopOrders&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.Overview-1621"><a href="#-1621"><span class="linenos">1621</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| </span><span class="si">{:&lt;27}</span><span class="s2"> | </span><span class="si">{:&lt;14}</span><span class="s2"> | </span><span class="si">{:&lt;6}</span><span class="s2"> | </span><span class="si">{:&gt;23}</span><span class="s2"> | </span><span class="si">{:&gt;13}</span><span class="s2"> | </span><span class="si">{:&gt;13}</span><span class="s2"> | </span><span class="si">{:&lt;9}</span><span class="s2"> | </span><span class="si">{:&lt;11}</span><span class="s2"> | </span><span class="si">{:&lt;12}</span><span class="s2"> | </span><span class="si">{:&lt;19}</span><span class="s2"> | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.Overview-1622"><a href="#-1622"><span class="linenos">1622</span></a>                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer.Overview-1623"><a href="#-1623"><span class="linenos">1623</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;orderID&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1624"><a href="#-1624"><span class="linenos">1624</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;lotsRequested&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1625"><a href="#-1625"><span class="linenos">1625</span></a>                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}{:.2f}</span><span class="s2">%)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.Overview-1626"><a href="#-1626"><span class="linenos">1626</span></a>                            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">])),</span>
</span><span id="TinkoffBrokerServer.Overview-1627"><a href="#-1627"><span class="linenos">1627</span></a>                            <span class="n">item</span><span class="p">[</span><span class="s2">&quot;baseCurrencyName&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1628"><a href="#-1628"><span class="linenos">1628</span></a>                            <span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;percentChanges&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Overview-1629"><a href="#-1629"><span class="linenos">1629</span></a>                            <span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;percentChanges&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer.Overview-1630"><a href="#-1630"><span class="linenos">1630</span></a>                        <span class="p">),</span>
</span><span id="TinkoffBrokerServer.Overview-1631"><a href="#-1631"><span class="linenos">1631</span></a>                        <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;targetPrice&quot;</span><span class="p">]),</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;baseCurrencyName&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer.Overview-1632"><a href="#-1632"><span class="linenos">1632</span></a>                        <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;limitPrice&quot;</span><span class="p">]),</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;baseCurrencyName&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;limitPrice&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;limitPrice&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;targetPrice&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="n">TKS_ORDER_TYPES</span><span class="p">[</span><span class="s2">&quot;ORDER_TYPE_MARKET&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1633"><a href="#-1633"><span class="linenos">1633</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1634"><a href="#-1634"><span class="linenos">1634</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1635"><a href="#-1635"><span class="linenos">1635</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;expType&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1636"><a href="#-1636"><span class="linenos">1636</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;createDate&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1637"><a href="#-1637"><span class="linenos">1637</span></a>                        <span class="n">item</span><span class="p">[</span><span class="s2">&quot;expDate&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1638"><a href="#-1638"><span class="linenos">1638</span></a>                    <span class="p">))</span>
</span><span id="TinkoffBrokerServer.Overview-1639"><a href="#-1639"><span class="linenos">1639</span></a>
</span><span id="TinkoffBrokerServer.Overview-1640"><a href="#-1640"><span class="linenos">1640</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1641"><a href="#-1641"><span class="linenos">1641</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">## Total stop-orders: 0</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Overview-1642"><a href="#-1642"><span class="linenos">1642</span></a>
</span><span id="TinkoffBrokerServer.Overview-1643"><a href="#-1643"><span class="linenos">1643</span></a>            <span class="c1"># -- Show analytics section:</span>
</span><span id="TinkoffBrokerServer.Overview-1644"><a href="#-1644"><span class="linenos">1644</span></a>            <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1645"><a href="#-1645"><span class="linenos">1645</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span><span id="TinkoffBrokerServer.Overview-1646"><a href="#-1646"><span class="linenos">1646</span></a>                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"># Analytics</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="TinkoffBrokerServer.Overview-1647"><a href="#-1647"><span class="linenos">1647</span></a>                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">* **Current total portfolio cost:** </span><span class="si">{:.2f}</span><span class="s2"> RUB</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;portfolioCostRUB&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer.Overview-1648"><a href="#-1648"><span class="linenos">1648</span></a>                    <span class="s2">&quot;* **Changes:** </span><span class="si">{}{:.2f}</span><span class="s2"> RUB (</span><span class="si">{}{:.2f}</span><span class="s2">%)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.Overview-1649"><a href="#-1649"><span class="linenos">1649</span></a>                        <span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;totalChangesRUB&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Overview-1650"><a href="#-1650"><span class="linenos">1650</span></a>                        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;totalChangesRUB&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1651"><a href="#-1651"><span class="linenos">1651</span></a>                        <span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;totalChangesPercentRUB&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Overview-1652"><a href="#-1652"><span class="linenos">1652</span></a>                        <span class="n">view</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="s2">&quot;totalChangesPercentRUB&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1653"><a href="#-1653"><span class="linenos">1653</span></a>                    <span class="p">),</span>
</span><span id="TinkoffBrokerServer.Overview-1654"><a href="#-1654"><span class="linenos">1654</span></a>                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">## Portfolio distribution by assets</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="TinkoffBrokerServer.Overview-1655"><a href="#-1655"><span class="linenos">1655</span></a>                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">| Type       | Uniques | Percent | Current cost</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Overview-1656"><a href="#-1656"><span class="linenos">1656</span></a>                    <span class="s2">&quot;|------------|---------|---------|-----------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Overview-1657"><a href="#-1657"><span class="linenos">1657</span></a>                <span class="p">])</span>
</span><span id="TinkoffBrokerServer.Overview-1658"><a href="#-1658"><span class="linenos">1658</span></a>
</span><span id="TinkoffBrokerServer.Overview-1659"><a href="#-1659"><span class="linenos">1659</span></a>                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByAssets&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.Overview-1660"><a href="#-1660"><span class="linenos">1660</span></a>                    <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByAssets&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;cost&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1661"><a href="#-1661"><span class="linenos">1661</span></a>                        <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| </span><span class="si">{:&lt;10}</span><span class="s2"> | </span><span class="si">{:&lt;7}</span><span class="s2"> | </span><span class="si">{:&lt;7}</span><span class="s2"> | </span><span class="si">{:.2f}</span><span class="s2"> rub</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.Overview-1662"><a href="#-1662"><span class="linenos">1662</span></a>                            <span class="n">key</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Overview-1663"><a href="#-1663"><span class="linenos">1663</span></a>                            <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByAssets&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;uniques&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1664"><a href="#-1664"><span class="linenos">1664</span></a>                            <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByAssets&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;percent&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer.Overview-1665"><a href="#-1665"><span class="linenos">1665</span></a>                            <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByAssets&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;cost&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1666"><a href="#-1666"><span class="linenos">1666</span></a>                        <span class="p">))</span>
</span><span id="TinkoffBrokerServer.Overview-1667"><a href="#-1667"><span class="linenos">1667</span></a>
</span><span id="TinkoffBrokerServer.Overview-1668"><a href="#-1668"><span class="linenos">1668</span></a>                <span class="n">maxLenNames</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">+</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">company</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCompanies&quot;</span><span class="p">][</span><span class="n">company</span><span class="p">][</span><span class="s2">&quot;ticker&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">company</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCompanies&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
</span><span id="TinkoffBrokerServer.Overview-1669"><a href="#-1669"><span class="linenos">1669</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span><span id="TinkoffBrokerServer.Overview-1670"><a href="#-1670"><span class="linenos">1670</span></a>                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">## Portfolio distribution by companies</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="TinkoffBrokerServer.Overview-1671"><a href="#-1671"><span class="linenos">1671</span></a>                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">| Company</span><span class="si">{}</span><span class="s2"> | Percent | Current cost</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxLenNames</span> <span class="o">-</span> <span class="mi">7</span><span class="p">)),</span>
</span><span id="TinkoffBrokerServer.Overview-1672"><a href="#-1672"><span class="linenos">1672</span></a>                    <span class="s2">&quot;|--------</span><span class="si">{}</span><span class="s2">-|---------|-----------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxLenNames</span> <span class="o">-</span> <span class="mi">7</span><span class="p">)),</span>
</span><span id="TinkoffBrokerServer.Overview-1673"><a href="#-1673"><span class="linenos">1673</span></a>                <span class="p">])</span>
</span><span id="TinkoffBrokerServer.Overview-1674"><a href="#-1674"><span class="linenos">1674</span></a>
</span><span id="TinkoffBrokerServer.Overview-1675"><a href="#-1675"><span class="linenos">1675</span></a>                <span class="k">for</span> <span class="n">company</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCompanies&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.Overview-1676"><a href="#-1676"><span class="linenos">1676</span></a>                    <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCompanies&quot;</span><span class="p">][</span><span class="n">company</span><span class="p">][</span><span class="s2">&quot;cost&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1677"><a href="#-1677"><span class="linenos">1677</span></a>                        <span class="n">nameLen</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">company</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCompanies&quot;</span><span class="p">][</span><span class="n">company</span><span class="p">][</span><span class="s2">&quot;ticker&quot;</span><span class="p">])</span>
</span><span id="TinkoffBrokerServer.Overview-1678"><a href="#-1678"><span class="linenos">1678</span></a>                        <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| </span><span class="si">{}</span><span class="s2"> | </span><span class="si">{:&lt;7}</span><span class="s2"> | </span><span class="si">{:.2f}</span><span class="s2"> rub</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.Overview-1679"><a href="#-1679"><span class="linenos">1679</span></a>                            <span class="s2">&quot;</span><span class="si">{}{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.Overview-1680"><a href="#-1680"><span class="linenos">1680</span></a>                                <span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">] &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCompanies&quot;</span><span class="p">][</span><span class="n">company</span><span class="p">][</span><span class="s2">&quot;ticker&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCompanies&quot;</span><span class="p">][</span><span class="n">company</span><span class="p">][</span><span class="s2">&quot;ticker&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Overview-1681"><a href="#-1681"><span class="linenos">1681</span></a>                                <span class="n">company</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Overview-1682"><a href="#-1682"><span class="linenos">1682</span></a>                                <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">nameLen</span> <span class="o">==</span> <span class="n">maxLenNames</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxLenNames</span> <span class="o">-</span> <span class="n">nameLen</span><span class="p">)</span> <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCompanies&quot;</span><span class="p">][</span><span class="n">company</span><span class="p">][</span><span class="s2">&quot;ticker&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxLenNames</span> <span class="o">-</span> <span class="n">nameLen</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)),</span>
</span><span id="TinkoffBrokerServer.Overview-1683"><a href="#-1683"><span class="linenos">1683</span></a>                            <span class="p">),</span>
</span><span id="TinkoffBrokerServer.Overview-1684"><a href="#-1684"><span class="linenos">1684</span></a>                            <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCompanies&quot;</span><span class="p">][</span><span class="n">company</span><span class="p">][</span><span class="s2">&quot;percent&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer.Overview-1685"><a href="#-1685"><span class="linenos">1685</span></a>                            <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCompanies&quot;</span><span class="p">][</span><span class="n">company</span><span class="p">][</span><span class="s2">&quot;cost&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1686"><a href="#-1686"><span class="linenos">1686</span></a>                        <span class="p">))</span>
</span><span id="TinkoffBrokerServer.Overview-1687"><a href="#-1687"><span class="linenos">1687</span></a>
</span><span id="TinkoffBrokerServer.Overview-1688"><a href="#-1688"><span class="linenos">1688</span></a>                <span class="n">maxLenSectors</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">sector</span><span class="p">)</span> <span class="k">for</span> <span class="n">sector</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrBySectors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
</span><span id="TinkoffBrokerServer.Overview-1689"><a href="#-1689"><span class="linenos">1689</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span><span id="TinkoffBrokerServer.Overview-1690"><a href="#-1690"><span class="linenos">1690</span></a>                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">## Portfolio distribution by sectors</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="TinkoffBrokerServer.Overview-1691"><a href="#-1691"><span class="linenos">1691</span></a>                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">| Sector</span><span class="si">{}</span><span class="s2"> | Percent | Current cost</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxLenSectors</span> <span class="o">-</span> <span class="mi">6</span><span class="p">)),</span>
</span><span id="TinkoffBrokerServer.Overview-1692"><a href="#-1692"><span class="linenos">1692</span></a>                    <span class="s2">&quot;|-------</span><span class="si">{}</span><span class="s2">-|---------|-----------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxLenSectors</span> <span class="o">-</span> <span class="mi">6</span><span class="p">)),</span>
</span><span id="TinkoffBrokerServer.Overview-1693"><a href="#-1693"><span class="linenos">1693</span></a>                <span class="p">])</span>
</span><span id="TinkoffBrokerServer.Overview-1694"><a href="#-1694"><span class="linenos">1694</span></a>
</span><span id="TinkoffBrokerServer.Overview-1695"><a href="#-1695"><span class="linenos">1695</span></a>                <span class="k">for</span> <span class="n">sector</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrBySectors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.Overview-1696"><a href="#-1696"><span class="linenos">1696</span></a>                    <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrBySectors&quot;</span><span class="p">][</span><span class="n">sector</span><span class="p">][</span><span class="s2">&quot;cost&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1697"><a href="#-1697"><span class="linenos">1697</span></a>                        <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| </span><span class="si">{}{}</span><span class="s2"> | </span><span class="si">{:&lt;7}</span><span class="s2"> | </span><span class="si">{:.2f}</span><span class="s2"> rub</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.Overview-1698"><a href="#-1698"><span class="linenos">1698</span></a>                            <span class="n">sector</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Overview-1699"><a href="#-1699"><span class="linenos">1699</span></a>                            <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sector</span><span class="p">)</span> <span class="o">==</span> <span class="n">maxLenSectors</span> <span class="k">else</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxLenSectors</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">sector</span><span class="p">)),</span>
</span><span id="TinkoffBrokerServer.Overview-1700"><a href="#-1700"><span class="linenos">1700</span></a>                            <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrBySectors&quot;</span><span class="p">][</span><span class="n">sector</span><span class="p">][</span><span class="s2">&quot;percent&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer.Overview-1701"><a href="#-1701"><span class="linenos">1701</span></a>                            <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrBySectors&quot;</span><span class="p">][</span><span class="n">sector</span><span class="p">][</span><span class="s2">&quot;cost&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1702"><a href="#-1702"><span class="linenos">1702</span></a>                        <span class="p">))</span>
</span><span id="TinkoffBrokerServer.Overview-1703"><a href="#-1703"><span class="linenos">1703</span></a>
</span><span id="TinkoffBrokerServer.Overview-1704"><a href="#-1704"><span class="linenos">1704</span></a>                <span class="n">maxLenMoney</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">+</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">currency</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCurrencies&quot;</span><span class="p">][</span><span class="n">currency</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">currency</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCurrencies&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
</span><span id="TinkoffBrokerServer.Overview-1705"><a href="#-1705"><span class="linenos">1705</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span><span id="TinkoffBrokerServer.Overview-1706"><a href="#-1706"><span class="linenos">1706</span></a>                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">## Portfolio distribution by currencies</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="TinkoffBrokerServer.Overview-1707"><a href="#-1707"><span class="linenos">1707</span></a>                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">| Instruments currencies</span><span class="si">{}</span><span class="s2"> | Percent | Current cost</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxLenMoney</span> <span class="o">-</span> <span class="mi">22</span><span class="p">)),</span>
</span><span id="TinkoffBrokerServer.Overview-1708"><a href="#-1708"><span class="linenos">1708</span></a>                    <span class="s2">&quot;|-----------------------</span><span class="si">{}</span><span class="s2">-|---------|-----------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxLenMoney</span> <span class="o">-</span> <span class="mi">22</span><span class="p">)),</span>
</span><span id="TinkoffBrokerServer.Overview-1709"><a href="#-1709"><span class="linenos">1709</span></a>                <span class="p">])</span>
</span><span id="TinkoffBrokerServer.Overview-1710"><a href="#-1710"><span class="linenos">1710</span></a>
</span><span id="TinkoffBrokerServer.Overview-1711"><a href="#-1711"><span class="linenos">1711</span></a>                <span class="k">for</span> <span class="n">curr</span> <span class="ow">in</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCurrencies&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.Overview-1712"><a href="#-1712"><span class="linenos">1712</span></a>                    <span class="k">if</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCurrencies&quot;</span><span class="p">][</span><span class="n">curr</span><span class="p">][</span><span class="s2">&quot;cost&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1713"><a href="#-1713"><span class="linenos">1713</span></a>                        <span class="n">nameLen</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">curr</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCurrencies&quot;</span><span class="p">][</span><span class="n">curr</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
</span><span id="TinkoffBrokerServer.Overview-1714"><a href="#-1714"><span class="linenos">1714</span></a>                        <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| </span><span class="si">{}</span><span class="s2"> | </span><span class="si">{:&lt;7}</span><span class="s2"> | </span><span class="si">{:.2f}</span><span class="s2"> rub</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.Overview-1715"><a href="#-1715"><span class="linenos">1715</span></a>                            <span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">] </span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.Overview-1716"><a href="#-1716"><span class="linenos">1716</span></a>                                <span class="n">curr</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Overview-1717"><a href="#-1717"><span class="linenos">1717</span></a>                                <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCurrencies&quot;</span><span class="p">][</span><span class="n">curr</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1718"><a href="#-1718"><span class="linenos">1718</span></a>                                <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">nameLen</span> <span class="o">==</span> <span class="n">maxLenMoney</span> <span class="k">else</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxLenMoney</span> <span class="o">-</span> <span class="n">nameLen</span><span class="p">),</span>
</span><span id="TinkoffBrokerServer.Overview-1719"><a href="#-1719"><span class="linenos">1719</span></a>                            <span class="p">),</span>
</span><span id="TinkoffBrokerServer.Overview-1720"><a href="#-1720"><span class="linenos">1720</span></a>                            <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCurrencies&quot;</span><span class="p">][</span><span class="n">curr</span><span class="p">][</span><span class="s2">&quot;percent&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer.Overview-1721"><a href="#-1721"><span class="linenos">1721</span></a>                            <span class="n">view</span><span class="p">[</span><span class="s2">&quot;analytics&quot;</span><span class="p">][</span><span class="s2">&quot;distrByCurrencies&quot;</span><span class="p">][</span><span class="n">curr</span><span class="p">][</span><span class="s2">&quot;cost&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Overview-1722"><a href="#-1722"><span class="linenos">1722</span></a>                        <span class="p">))</span>
</span><span id="TinkoffBrokerServer.Overview-1723"><a href="#-1723"><span class="linenos">1723</span></a>
</span><span id="TinkoffBrokerServer.Overview-1724"><a href="#-1724"><span class="linenos">1724</span></a>            <span class="n">infoText</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Overview-1725"><a href="#-1725"><span class="linenos">1725</span></a>
</span><span id="TinkoffBrokerServer.Overview-1726"><a href="#-1726"><span class="linenos">1726</span></a>            <span class="k">if</span> <span class="n">showStatistics</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1727"><a href="#-1727"><span class="linenos">1727</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Statistics of client&#39;s portfolio:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">infoText</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.Overview-1728"><a href="#-1728"><span class="linenos">1728</span></a>
</span><span id="TinkoffBrokerServer.Overview-1729"><a href="#-1729"><span class="linenos">1729</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">overviewFile</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1730"><a href="#-1730"><span class="linenos">1730</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overviewFile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fH</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Overview-1731"><a href="#-1731"><span class="linenos">1731</span></a>                    <span class="n">fH</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">infoText</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Overview-1732"><a href="#-1732"><span class="linenos">1732</span></a>
</span><span id="TinkoffBrokerServer.Overview-1733"><a href="#-1733"><span class="linenos">1733</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Client&#39;s portfolio is saved to file: [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">overviewFile</span><span class="p">)))</span>
</span><span id="TinkoffBrokerServer.Overview-1734"><a href="#-1734"><span class="linenos">1734</span></a>
</span><span id="TinkoffBrokerServer.Overview-1735"><a href="#-1735"><span class="linenos">1735</span></a>        <span class="k">return</span> <span class="n">view</span>
</span></pre></div>


            <div class="docstring"><p>Get portfolio: all open positions, orders and some statistics for defined accountId.
If <code><a href="#TinkoffBrokerServer.overviewFile">overviewFile</a></code> is define then also save information to file.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>showStatistics</strong>:  if <code>False</code> then only dictionary returns, if <code>True</code> then show more debug information.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>dictionary with client's raw portfolio and some statistics.</p>
</blockquote>
</div>


                            </div>
                            <div id="TinkoffBrokerServer.Deals" class="classattr">
                                        <input id="TinkoffBrokerServer.Deals-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">Deals</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">start</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">end</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">printDeals</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="nb">tuple</span>:</span></span>

                <label class="view-source-button" for="TinkoffBrokerServer.Deals-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.Deals"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TinkoffBrokerServer.Deals-1737"><a href="#-1737"><span class="linenos">1737</span></a>    <span class="k">def</span> <span class="nf">Deals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">printDeals</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Deals-1738"><a href="#-1738"><span class="linenos">1738</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.Deals-1739"><a href="#-1739"><span class="linenos">1739</span></a><span class="sd">        Returns history operations between two given dates.</span>
</span><span id="TinkoffBrokerServer.Deals-1740"><a href="#-1740"><span class="linenos">1740</span></a><span class="sd">        If `reportFile` string is not empty then also save human-readable report.</span>
</span><span id="TinkoffBrokerServer.Deals-1741"><a href="#-1741"><span class="linenos">1741</span></a><span class="sd">        Shows some statistical data of closed positions.</span>
</span><span id="TinkoffBrokerServer.Deals-1742"><a href="#-1742"><span class="linenos">1742</span></a>
</span><span id="TinkoffBrokerServer.Deals-1743"><a href="#-1743"><span class="linenos">1743</span></a><span class="sd">        :param start: see docstring in `GetDatesAsString()` method</span>
</span><span id="TinkoffBrokerServer.Deals-1744"><a href="#-1744"><span class="linenos">1744</span></a><span class="sd">        :param end: see docstring in `GetDatesAsString()` method</span>
</span><span id="TinkoffBrokerServer.Deals-1745"><a href="#-1745"><span class="linenos">1745</span></a><span class="sd">        :param printDeals: if `True` then also print all records to the console.</span>
</span><span id="TinkoffBrokerServer.Deals-1746"><a href="#-1746"><span class="linenos">1746</span></a><span class="sd">        :return: original list of dictionaries with history of deals records from API (&quot;operations&quot; key):</span>
</span><span id="TinkoffBrokerServer.Deals-1747"><a href="#-1747"><span class="linenos">1747</span></a><span class="sd">                 https://tinkoff.github.io/investAPI/swagger-ui/#/OperationsService/OperationsService_GetOperations</span>
</span><span id="TinkoffBrokerServer.Deals-1748"><a href="#-1748"><span class="linenos">1748</span></a><span class="sd">                 and dictionary with custom stats: operations in different currencies, withdrawals, incomes etc.</span>
</span><span id="TinkoffBrokerServer.Deals-1749"><a href="#-1749"><span class="linenos">1749</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.Deals-1750"><a href="#-1750"><span class="linenos">1750</span></a>        <span class="n">startDate</span><span class="p">,</span> <span class="n">endDate</span> <span class="o">=</span> <span class="n">GetDatesAsString</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>  <span class="c1"># Example: (&quot;2000-01-01T00:00:00Z&quot;, &quot;2022-12-31T23:59:59Z&quot;)</span>
</span><span id="TinkoffBrokerServer.Deals-1751"><a href="#-1751"><span class="linenos">1751</span></a>
</span><span id="TinkoffBrokerServer.Deals-1752"><a href="#-1752"><span class="linenos">1752</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Requesting history of a client&#39;s operations. Wait, please...&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Deals-1753"><a href="#-1753"><span class="linenos">1753</span></a>
</span><span id="TinkoffBrokerServer.Deals-1754"><a href="#-1754"><span class="linenos">1754</span></a>        <span class="c1"># REST API for request: https://tinkoff.github.io/investAPI/swagger-ui/#/OperationsService/OperationsService_GetOperations</span>
</span><span id="TinkoffBrokerServer.Deals-1755"><a href="#-1755"><span class="linenos">1755</span></a>        <span class="n">dealsURL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;/tinkoff.public.invest.api.contract.v1.OperationsService/GetOperations&quot;</span>
</span><span id="TinkoffBrokerServer.Deals-1756"><a href="#-1756"><span class="linenos">1756</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="nb">str</span><span class="p">({</span><span class="s2">&quot;accountId&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">accountId</span><span class="p">,</span> <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="n">startDate</span><span class="p">,</span> <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="n">endDate</span><span class="p">})</span>
</span><span id="TinkoffBrokerServer.Deals-1757"><a href="#-1757"><span class="linenos">1757</span></a>        <span class="n">ops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SendAPIRequest</span><span class="p">(</span><span class="n">dealsURL</span><span class="p">,</span> <span class="n">reqType</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">)[</span><span class="s2">&quot;operations&quot;</span><span class="p">]</span>  <span class="c1"># list of dict: operations returns by broker</span>
</span><span id="TinkoffBrokerServer.Deals-1758"><a href="#-1758"><span class="linenos">1758</span></a>        <span class="n">customStat</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># custom statistics in additional to responseJSON</span>
</span><span id="TinkoffBrokerServer.Deals-1759"><a href="#-1759"><span class="linenos">1759</span></a>
</span><span id="TinkoffBrokerServer.Deals-1760"><a href="#-1760"><span class="linenos">1760</span></a>        <span class="c1"># --- output report in human-readable format:</span>
</span><span id="TinkoffBrokerServer.Deals-1761"><a href="#-1761"><span class="linenos">1761</span></a>        <span class="k">if</span> <span class="n">printDeals</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">reportFile</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Deals-1762"><a href="#-1762"><span class="linenos">1762</span></a>            <span class="n">splitLine1</span> <span class="o">=</span> <span class="s2">&quot;|                            |                               |                              |                      |</span><span class="se">\n</span><span class="s2">&quot;</span>  <span class="c1"># Summary section</span>
</span><span id="TinkoffBrokerServer.Deals-1763"><a href="#-1763"><span class="linenos">1763</span></a>            <span class="n">splitLine2</span> <span class="o">=</span> <span class="s2">&quot;|                     |              |              |            |           |                 |            |</span><span class="se">\n</span><span class="s2">&quot;</span>  <span class="c1"># Operations section</span>
</span><span id="TinkoffBrokerServer.Deals-1764"><a href="#-1764"><span class="linenos">1764</span></a>            <span class="n">nextDay</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.Deals-1765"><a href="#-1765"><span class="linenos">1765</span></a>
</span><span id="TinkoffBrokerServer.Deals-1766"><a href="#-1766"><span class="linenos">1766</span></a>            <span class="n">info</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;# Client&#39;s operations</span><span class="se">\n\n</span><span class="s2">* **Period:** from [</span><span class="si">{}</span><span class="s2">] to [</span><span class="si">{}</span><span class="s2">]</span><span class="se">\n\n</span><span class="s2">## Summary (operations executed only)</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">startDate</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">endDate</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])]</span>
</span><span id="TinkoffBrokerServer.Deals-1767"><a href="#-1767"><span class="linenos">1767</span></a>
</span><span id="TinkoffBrokerServer.Deals-1768"><a href="#-1768"><span class="linenos">1768</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ops</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Deals-1769"><a href="#-1769"><span class="linenos">1769</span></a>                <span class="n">customStat</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="TinkoffBrokerServer.Deals-1770"><a href="#-1770"><span class="linenos">1770</span></a>                    <span class="s2">&quot;opsCount&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># total operations count</span>
</span><span id="TinkoffBrokerServer.Deals-1771"><a href="#-1771"><span class="linenos">1771</span></a>                    <span class="s2">&quot;buyCount&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># buy operations</span>
</span><span id="TinkoffBrokerServer.Deals-1772"><a href="#-1772"><span class="linenos">1772</span></a>                    <span class="s2">&quot;sellCount&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># sell operations</span>
</span><span id="TinkoffBrokerServer.Deals-1773"><a href="#-1773"><span class="linenos">1773</span></a>                    <span class="s2">&quot;buyTotal&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rub&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">},</span>  <span class="c1"># Buy sums in different currencies</span>
</span><span id="TinkoffBrokerServer.Deals-1774"><a href="#-1774"><span class="linenos">1774</span></a>                    <span class="s2">&quot;sellTotal&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rub&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">},</span>  <span class="c1"># Sell sums in different currencies</span>
</span><span id="TinkoffBrokerServer.Deals-1775"><a href="#-1775"><span class="linenos">1775</span></a>                    <span class="s2">&quot;payIn&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rub&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">},</span>  <span class="c1"># Deposit brokerage account</span>
</span><span id="TinkoffBrokerServer.Deals-1776"><a href="#-1776"><span class="linenos">1776</span></a>                    <span class="s2">&quot;payOut&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rub&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">},</span>  <span class="c1"># Withdrawals</span>
</span><span id="TinkoffBrokerServer.Deals-1777"><a href="#-1777"><span class="linenos">1777</span></a>                    <span class="s2">&quot;divs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rub&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">},</span>  <span class="c1"># Dividends income</span>
</span><span id="TinkoffBrokerServer.Deals-1778"><a href="#-1778"><span class="linenos">1778</span></a>                    <span class="s2">&quot;coupons&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rub&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">},</span>  <span class="c1"># Coupon&#39;s income</span>
</span><span id="TinkoffBrokerServer.Deals-1779"><a href="#-1779"><span class="linenos">1779</span></a>                    <span class="s2">&quot;brokerCom&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rub&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">},</span>  <span class="c1"># Service commissions</span>
</span><span id="TinkoffBrokerServer.Deals-1780"><a href="#-1780"><span class="linenos">1780</span></a>                    <span class="s2">&quot;serviceCom&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rub&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">},</span>  <span class="c1"># Service commissions</span>
</span><span id="TinkoffBrokerServer.Deals-1781"><a href="#-1781"><span class="linenos">1781</span></a>                    <span class="s2">&quot;marginCom&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rub&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">},</span>  <span class="c1"># Margin commissions</span>
</span><span id="TinkoffBrokerServer.Deals-1782"><a href="#-1782"><span class="linenos">1782</span></a>                    <span class="s2">&quot;allTaxes&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;rub&quot;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">},</span>  <span class="c1"># Sum of withholding taxes and corrections</span>
</span><span id="TinkoffBrokerServer.Deals-1783"><a href="#-1783"><span class="linenos">1783</span></a>                <span class="p">}</span>
</span><span id="TinkoffBrokerServer.Deals-1784"><a href="#-1784"><span class="linenos">1784</span></a>
</span><span id="TinkoffBrokerServer.Deals-1785"><a href="#-1785"><span class="linenos">1785</span></a>                <span class="c1"># --- calculating statistics depends on operations type in TKS_OPERATION_TYPES:</span>
</span><span id="TinkoffBrokerServer.Deals-1786"><a href="#-1786"><span class="linenos">1786</span></a>                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Deals-1787"><a href="#-1787"><span class="linenos">1787</span></a>                    <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;OPERATION_STATE_EXECUTED&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Deals-1788"><a href="#-1788"><span class="linenos">1788</span></a>                        <span class="n">payment</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>
</span><span id="TinkoffBrokerServer.Deals-1789"><a href="#-1789"><span class="linenos">1789</span></a>
</span><span id="TinkoffBrokerServer.Deals-1790"><a href="#-1790"><span class="linenos">1790</span></a>                        <span class="c1"># count buy operations:</span>
</span><span id="TinkoffBrokerServer.Deals-1791"><a href="#-1791"><span class="linenos">1791</span></a>                        <span class="k">if</span> <span class="s2">&quot;_BUY&quot;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;operationType&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.Deals-1792"><a href="#-1792"><span class="linenos">1792</span></a>                            <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;buyCount&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="TinkoffBrokerServer.Deals-1793"><a href="#-1793"><span class="linenos">1793</span></a>
</span><span id="TinkoffBrokerServer.Deals-1794"><a href="#-1794"><span class="linenos">1794</span></a>                            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;buyTotal&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.Deals-1795"><a href="#-1795"><span class="linenos">1795</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;buyTotal&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">payment</span>
</span><span id="TinkoffBrokerServer.Deals-1796"><a href="#-1796"><span class="linenos">1796</span></a>
</span><span id="TinkoffBrokerServer.Deals-1797"><a href="#-1797"><span class="linenos">1797</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Deals-1798"><a href="#-1798"><span class="linenos">1798</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;buyTotal&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">payment</span>
</span><span id="TinkoffBrokerServer.Deals-1799"><a href="#-1799"><span class="linenos">1799</span></a>
</span><span id="TinkoffBrokerServer.Deals-1800"><a href="#-1800"><span class="linenos">1800</span></a>                        <span class="c1"># count sell operations:</span>
</span><span id="TinkoffBrokerServer.Deals-1801"><a href="#-1801"><span class="linenos">1801</span></a>                        <span class="k">elif</span> <span class="s2">&quot;_SELL&quot;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;operationType&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.Deals-1802"><a href="#-1802"><span class="linenos">1802</span></a>                            <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;sellCount&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="TinkoffBrokerServer.Deals-1803"><a href="#-1803"><span class="linenos">1803</span></a>
</span><span id="TinkoffBrokerServer.Deals-1804"><a href="#-1804"><span class="linenos">1804</span></a>                            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;sellTotal&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.Deals-1805"><a href="#-1805"><span class="linenos">1805</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;sellTotal&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">payment</span>
</span><span id="TinkoffBrokerServer.Deals-1806"><a href="#-1806"><span class="linenos">1806</span></a>
</span><span id="TinkoffBrokerServer.Deals-1807"><a href="#-1807"><span class="linenos">1807</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Deals-1808"><a href="#-1808"><span class="linenos">1808</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;sellTotal&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">payment</span>
</span><span id="TinkoffBrokerServer.Deals-1809"><a href="#-1809"><span class="linenos">1809</span></a>
</span><span id="TinkoffBrokerServer.Deals-1810"><a href="#-1810"><span class="linenos">1810</span></a>                        <span class="c1"># count incoming operations:</span>
</span><span id="TinkoffBrokerServer.Deals-1811"><a href="#-1811"><span class="linenos">1811</span></a>                        <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;operationType&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;OPERATION_TYPE_INPUT&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.Deals-1812"><a href="#-1812"><span class="linenos">1812</span></a>                            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;payIn&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.Deals-1813"><a href="#-1813"><span class="linenos">1813</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;payIn&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">payment</span>
</span><span id="TinkoffBrokerServer.Deals-1814"><a href="#-1814"><span class="linenos">1814</span></a>
</span><span id="TinkoffBrokerServer.Deals-1815"><a href="#-1815"><span class="linenos">1815</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Deals-1816"><a href="#-1816"><span class="linenos">1816</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;payIn&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">payment</span>
</span><span id="TinkoffBrokerServer.Deals-1817"><a href="#-1817"><span class="linenos">1817</span></a>
</span><span id="TinkoffBrokerServer.Deals-1818"><a href="#-1818"><span class="linenos">1818</span></a>                        <span class="c1"># count withdrawals operations:</span>
</span><span id="TinkoffBrokerServer.Deals-1819"><a href="#-1819"><span class="linenos">1819</span></a>                        <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;operationType&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;OPERATION_TYPE_OUTPUT&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.Deals-1820"><a href="#-1820"><span class="linenos">1820</span></a>                            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;payOut&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.Deals-1821"><a href="#-1821"><span class="linenos">1821</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;payOut&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">payment</span>
</span><span id="TinkoffBrokerServer.Deals-1822"><a href="#-1822"><span class="linenos">1822</span></a>
</span><span id="TinkoffBrokerServer.Deals-1823"><a href="#-1823"><span class="linenos">1823</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Deals-1824"><a href="#-1824"><span class="linenos">1824</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;payOut&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">payment</span>
</span><span id="TinkoffBrokerServer.Deals-1825"><a href="#-1825"><span class="linenos">1825</span></a>
</span><span id="TinkoffBrokerServer.Deals-1826"><a href="#-1826"><span class="linenos">1826</span></a>                        <span class="c1"># count dividends income:</span>
</span><span id="TinkoffBrokerServer.Deals-1827"><a href="#-1827"><span class="linenos">1827</span></a>                        <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;operationType&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;OPERATION_TYPE_DIVIDEND&quot;</span><span class="p">,</span> <span class="s2">&quot;OPERATION_TYPE_DIVIDEND_TRANSFER&quot;</span><span class="p">,</span> <span class="s2">&quot;OPERATION_TYPE_DIV_EXT&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.Deals-1828"><a href="#-1828"><span class="linenos">1828</span></a>                            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;divs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.Deals-1829"><a href="#-1829"><span class="linenos">1829</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;divs&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">payment</span>
</span><span id="TinkoffBrokerServer.Deals-1830"><a href="#-1830"><span class="linenos">1830</span></a>
</span><span id="TinkoffBrokerServer.Deals-1831"><a href="#-1831"><span class="linenos">1831</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Deals-1832"><a href="#-1832"><span class="linenos">1832</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;divs&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">payment</span>
</span><span id="TinkoffBrokerServer.Deals-1833"><a href="#-1833"><span class="linenos">1833</span></a>
</span><span id="TinkoffBrokerServer.Deals-1834"><a href="#-1834"><span class="linenos">1834</span></a>                        <span class="c1"># count coupon&#39;s income:</span>
</span><span id="TinkoffBrokerServer.Deals-1835"><a href="#-1835"><span class="linenos">1835</span></a>                        <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;operationType&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;OPERATION_TYPE_COUPON&quot;</span><span class="p">,</span> <span class="s2">&quot;OPERATION_TYPE_BOND_REPAYMENT_FULL&quot;</span><span class="p">,</span> <span class="s2">&quot;OPERATION_TYPE_BOND_REPAYMENT&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.Deals-1836"><a href="#-1836"><span class="linenos">1836</span></a>                            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;coupons&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.Deals-1837"><a href="#-1837"><span class="linenos">1837</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;coupons&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">payment</span>
</span><span id="TinkoffBrokerServer.Deals-1838"><a href="#-1838"><span class="linenos">1838</span></a>
</span><span id="TinkoffBrokerServer.Deals-1839"><a href="#-1839"><span class="linenos">1839</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Deals-1840"><a href="#-1840"><span class="linenos">1840</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;coupons&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">payment</span>
</span><span id="TinkoffBrokerServer.Deals-1841"><a href="#-1841"><span class="linenos">1841</span></a>
</span><span id="TinkoffBrokerServer.Deals-1842"><a href="#-1842"><span class="linenos">1842</span></a>                        <span class="c1"># count broker commissions:</span>
</span><span id="TinkoffBrokerServer.Deals-1843"><a href="#-1843"><span class="linenos">1843</span></a>                        <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;operationType&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;OPERATION_TYPE_BROKER_FEE&quot;</span><span class="p">,</span> <span class="s2">&quot;OPERATION_TYPE_SUCCESS_FEE&quot;</span><span class="p">,</span> <span class="s2">&quot;OPERATION_TYPE_TRACK_MFEE&quot;</span><span class="p">,</span> <span class="s2">&quot;OPERATION_TYPE_TRACK_PFEE&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.Deals-1844"><a href="#-1844"><span class="linenos">1844</span></a>                            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;brokerCom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.Deals-1845"><a href="#-1845"><span class="linenos">1845</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;brokerCom&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">payment</span>
</span><span id="TinkoffBrokerServer.Deals-1846"><a href="#-1846"><span class="linenos">1846</span></a>
</span><span id="TinkoffBrokerServer.Deals-1847"><a href="#-1847"><span class="linenos">1847</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Deals-1848"><a href="#-1848"><span class="linenos">1848</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;brokerCom&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">payment</span>
</span><span id="TinkoffBrokerServer.Deals-1849"><a href="#-1849"><span class="linenos">1849</span></a>
</span><span id="TinkoffBrokerServer.Deals-1850"><a href="#-1850"><span class="linenos">1850</span></a>                        <span class="c1"># count service commissions:</span>
</span><span id="TinkoffBrokerServer.Deals-1851"><a href="#-1851"><span class="linenos">1851</span></a>                        <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;operationType&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;OPERATION_TYPE_SERVICE_FEE&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.Deals-1852"><a href="#-1852"><span class="linenos">1852</span></a>                            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;serviceCom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.Deals-1853"><a href="#-1853"><span class="linenos">1853</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;serviceCom&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">payment</span>
</span><span id="TinkoffBrokerServer.Deals-1854"><a href="#-1854"><span class="linenos">1854</span></a>
</span><span id="TinkoffBrokerServer.Deals-1855"><a href="#-1855"><span class="linenos">1855</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Deals-1856"><a href="#-1856"><span class="linenos">1856</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;serviceCom&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">payment</span>
</span><span id="TinkoffBrokerServer.Deals-1857"><a href="#-1857"><span class="linenos">1857</span></a>
</span><span id="TinkoffBrokerServer.Deals-1858"><a href="#-1858"><span class="linenos">1858</span></a>                        <span class="c1"># count margin commissions:</span>
</span><span id="TinkoffBrokerServer.Deals-1859"><a href="#-1859"><span class="linenos">1859</span></a>                        <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;operationType&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;OPERATION_TYPE_MARGIN_FEE&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.Deals-1860"><a href="#-1860"><span class="linenos">1860</span></a>                            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;marginCom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.Deals-1861"><a href="#-1861"><span class="linenos">1861</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;marginCom&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">payment</span>
</span><span id="TinkoffBrokerServer.Deals-1862"><a href="#-1862"><span class="linenos">1862</span></a>
</span><span id="TinkoffBrokerServer.Deals-1863"><a href="#-1863"><span class="linenos">1863</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Deals-1864"><a href="#-1864"><span class="linenos">1864</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;marginCom&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">payment</span>
</span><span id="TinkoffBrokerServer.Deals-1865"><a href="#-1865"><span class="linenos">1865</span></a>
</span><span id="TinkoffBrokerServer.Deals-1866"><a href="#-1866"><span class="linenos">1866</span></a>                        <span class="c1"># count withholding taxes:</span>
</span><span id="TinkoffBrokerServer.Deals-1867"><a href="#-1867"><span class="linenos">1867</span></a>                        <span class="k">elif</span> <span class="s2">&quot;_TAX&quot;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;operationType&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.Deals-1868"><a href="#-1868"><span class="linenos">1868</span></a>                            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;allTaxes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.Deals-1869"><a href="#-1869"><span class="linenos">1869</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;allTaxes&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">payment</span>
</span><span id="TinkoffBrokerServer.Deals-1870"><a href="#-1870"><span class="linenos">1870</span></a>
</span><span id="TinkoffBrokerServer.Deals-1871"><a href="#-1871"><span class="linenos">1871</span></a>                            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Deals-1872"><a href="#-1872"><span class="linenos">1872</span></a>                                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;allTaxes&quot;</span><span class="p">][</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">payment</span>
</span><span id="TinkoffBrokerServer.Deals-1873"><a href="#-1873"><span class="linenos">1873</span></a>
</span><span id="TinkoffBrokerServer.Deals-1874"><a href="#-1874"><span class="linenos">1874</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Deals-1875"><a href="#-1875"><span class="linenos">1875</span></a>                            <span class="k">continue</span>
</span><span id="TinkoffBrokerServer.Deals-1876"><a href="#-1876"><span class="linenos">1876</span></a>
</span><span id="TinkoffBrokerServer.Deals-1877"><a href="#-1877"><span class="linenos">1877</span></a>                <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;opsCount&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;buyCount&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;sellCount&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer.Deals-1878"><a href="#-1878"><span class="linenos">1878</span></a>
</span><span id="TinkoffBrokerServer.Deals-1879"><a href="#-1879"><span class="linenos">1879</span></a>                <span class="c1"># --- view &quot;Actions&quot; lines:</span>
</span><span id="TinkoffBrokerServer.Deals-1880"><a href="#-1880"><span class="linenos">1880</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span><span id="TinkoffBrokerServer.Deals-1881"><a href="#-1881"><span class="linenos">1881</span></a>                    <span class="s2">&quot;| 1                          | 2                             | 3                            | 4                    | 5</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Deals-1882"><a href="#-1882"><span class="linenos">1882</span></a>                    <span class="s2">&quot;|----------------------------|-------------------------------|------------------------------|----------------------|------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Deals-1883"><a href="#-1883"><span class="linenos">1883</span></a>                    <span class="s2">&quot;| **Actions:**               | Operations executed: </span><span class="si">{:&lt;8}</span><span class="s2"> | Trading volumes:             |                      |</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;opsCount&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer.Deals-1884"><a href="#-1884"><span class="linenos">1884</span></a>                    <span class="s2">&quot;|                            |   Buy: </span><span class="si">{:&lt;22}</span><span class="s2"> | </span><span class="si">{:&lt;28}</span><span class="s2"> |                      |</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.Deals-1885"><a href="#-1885"><span class="linenos">1885</span></a>                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> (</span><span class="si">{:.1f}</span><span class="s2">%)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;buyCount&quot;</span><span class="p">],</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;buyCount&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;opsCount&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;opsCount&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Deals-1886"><a href="#-1886"><span class="linenos">1886</span></a>                        <span class="s2">&quot;  rub, buy: </span><span class="si">{:&lt;16}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;buyTotal&quot;</span><span class="p">][</span><span class="s2">&quot;rub&quot;</span><span class="p">]))</span> <span class="k">if</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;buyTotal&quot;</span><span class="p">][</span><span class="s2">&quot;rub&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Deals-1887"><a href="#-1887"><span class="linenos">1887</span></a>                    <span class="p">),</span>
</span><span id="TinkoffBrokerServer.Deals-1888"><a href="#-1888"><span class="linenos">1888</span></a>                    <span class="s2">&quot;|                            |   Sell: </span><span class="si">{:&lt;21}</span><span class="s2"> | </span><span class="si">{:&lt;28}</span><span class="s2"> |                      |</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.Deals-1889"><a href="#-1889"><span class="linenos">1889</span></a>                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> (</span><span class="si">{:.1f}</span><span class="s2">%)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;sellCount&quot;</span><span class="p">],</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;sellCount&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;opsCount&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;opsCount&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Deals-1890"><a href="#-1890"><span class="linenos">1890</span></a>                        <span class="s2">&quot;  rub, sell: </span><span class="si">{:&lt;13}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;+</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;sellTotal&quot;</span><span class="p">][</span><span class="s2">&quot;rub&quot;</span><span class="p">]))</span> <span class="k">if</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;sellTotal&quot;</span><span class="p">][</span><span class="s2">&quot;rub&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Deals-1891"><a href="#-1891"><span class="linenos">1891</span></a>                    <span class="p">),</span>
</span><span id="TinkoffBrokerServer.Deals-1892"><a href="#-1892"><span class="linenos">1892</span></a>                <span class="p">])</span>
</span><span id="TinkoffBrokerServer.Deals-1893"><a href="#-1893"><span class="linenos">1893</span></a>
</span><span id="TinkoffBrokerServer.Deals-1894"><a href="#-1894"><span class="linenos">1894</span></a>                <span class="n">opsKeys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;buyTotal&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;sellTotal&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))))</span>
</span><span id="TinkoffBrokerServer.Deals-1895"><a href="#-1895"><span class="linenos">1895</span></a>                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">opsKeys</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Deals-1896"><a href="#-1896"><span class="linenos">1896</span></a>                    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;rub&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Deals-1897"><a href="#-1897"><span class="linenos">1897</span></a>                        <span class="k">continue</span>
</span><span id="TinkoffBrokerServer.Deals-1898"><a href="#-1898"><span class="linenos">1898</span></a>
</span><span id="TinkoffBrokerServer.Deals-1899"><a href="#-1899"><span class="linenos">1899</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span><span id="TinkoffBrokerServer.Deals-1900"><a href="#-1900"><span class="linenos">1900</span></a>                        <span class="s2">&quot;|                            |                               | </span><span class="si">{:&lt;28}</span><span class="s2"> |                      |</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.Deals-1901"><a href="#-1901"><span class="linenos">1901</span></a>                            <span class="s2">&quot;  </span><span class="si">{}</span><span class="s2">, buy: </span><span class="si">{:&lt;16}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;buyTotal&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">])</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;buyTotal&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;buyTotal&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Deals-1902"><a href="#-1902"><span class="linenos">1902</span></a>                        <span class="p">),</span>
</span><span id="TinkoffBrokerServer.Deals-1903"><a href="#-1903"><span class="linenos">1903</span></a>                        <span class="s2">&quot;|                            |                               | </span><span class="si">{:&lt;28}</span><span class="s2"> |                      |</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.Deals-1904"><a href="#-1904"><span class="linenos">1904</span></a>                            <span class="s2">&quot;  </span><span class="si">{}</span><span class="s2">, sell: </span><span class="si">{:&lt;13}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;+</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;sellTotal&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">])</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;sellTotal&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;sellTotal&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Deals-1905"><a href="#-1905"><span class="linenos">1905</span></a>                        <span class="p">),</span>
</span><span id="TinkoffBrokerServer.Deals-1906"><a href="#-1906"><span class="linenos">1906</span></a>                    <span class="p">])</span>
</span><span id="TinkoffBrokerServer.Deals-1907"><a href="#-1907"><span class="linenos">1907</span></a>
</span><span id="TinkoffBrokerServer.Deals-1908"><a href="#-1908"><span class="linenos">1908</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">splitLine1</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Deals-1909"><a href="#-1909"><span class="linenos">1909</span></a>
</span><span id="TinkoffBrokerServer.Deals-1910"><a href="#-1910"><span class="linenos">1910</span></a>                <span class="k">def</span> <span class="nf">_InfoStr</span><span class="p">(</span><span class="n">data1</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">data2</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">data3</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">data4</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">cur</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Deals-1911"><a href="#-1911"><span class="linenos">1911</span></a>                    <span class="k">return</span> <span class="s2">&quot;|                            | </span><span class="si">{:&lt;29}</span><span class="s2"> | </span><span class="si">{:&lt;28}</span><span class="s2"> | </span><span class="si">{:&lt;20}</span><span class="s2"> | </span><span class="si">{:&lt;22}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.Deals-1912"><a href="#-1912"><span class="linenos">1912</span></a>                            <span class="s2">&quot;  </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="n">data1</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">data1</span><span class="p">[</span><span class="n">cur</span><span class="p">])</span> <span class="k">if</span> <span class="n">cur</span> <span class="ow">and</span> <span class="n">cur</span> <span class="ow">in</span> <span class="n">data1</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">data1</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Deals-1913"><a href="#-1913"><span class="linenos">1913</span></a>                            <span class="s2">&quot;  </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="n">data2</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">data2</span><span class="p">[</span><span class="n">cur</span><span class="p">])</span> <span class="k">if</span> <span class="n">cur</span> <span class="ow">and</span> <span class="n">cur</span> <span class="ow">in</span> <span class="n">data2</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">data2</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Deals-1914"><a href="#-1914"><span class="linenos">1914</span></a>                            <span class="s2">&quot;  </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="n">data3</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">data3</span><span class="p">[</span><span class="n">cur</span><span class="p">])</span> <span class="k">if</span> <span class="n">cur</span> <span class="ow">and</span> <span class="n">cur</span> <span class="ow">in</span> <span class="n">data3</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">data3</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Deals-1915"><a href="#-1915"><span class="linenos">1915</span></a>                            <span class="s2">&quot;  </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="n">data4</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">data4</span><span class="p">[</span><span class="n">cur</span><span class="p">])</span> <span class="k">if</span> <span class="n">cur</span> <span class="ow">and</span> <span class="n">cur</span> <span class="ow">in</span> <span class="n">data4</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">data4</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;  &quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Deals-1916"><a href="#-1916"><span class="linenos">1916</span></a>                    <span class="p">)</span>
</span><span id="TinkoffBrokerServer.Deals-1917"><a href="#-1917"><span class="linenos">1917</span></a>
</span><span id="TinkoffBrokerServer.Deals-1918"><a href="#-1918"><span class="linenos">1918</span></a>                <span class="c1"># --- view &quot;Payments&quot; lines:</span>
</span><span id="TinkoffBrokerServer.Deals-1919"><a href="#-1919"><span class="linenos">1919</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| **Payments:**              | Deposit on broker account:    | Withdrawals:                 | Dividends income:    | Coupons income:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Deals-1920"><a href="#-1920"><span class="linenos">1920</span></a>                <span class="n">paymentsKeys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;payIn&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;payOut&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;divs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;coupons&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))))</span>
</span><span id="TinkoffBrokerServer.Deals-1921"><a href="#-1921"><span class="linenos">1921</span></a>
</span><span id="TinkoffBrokerServer.Deals-1922"><a href="#-1922"><span class="linenos">1922</span></a>                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">paymentsKeys</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Deals-1923"><a href="#-1923"><span class="linenos">1923</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_InfoStr</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;payIn&quot;</span><span class="p">],</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;payOut&quot;</span><span class="p">],</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;divs&quot;</span><span class="p">],</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;coupons&quot;</span><span class="p">],</span> <span class="n">key</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.Deals-1924"><a href="#-1924"><span class="linenos">1924</span></a>
</span><span id="TinkoffBrokerServer.Deals-1925"><a href="#-1925"><span class="linenos">1925</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">splitLine1</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Deals-1926"><a href="#-1926"><span class="linenos">1926</span></a>
</span><span id="TinkoffBrokerServer.Deals-1927"><a href="#-1927"><span class="linenos">1927</span></a>                <span class="c1"># --- view &quot;Commissions and taxes&quot; lines:</span>
</span><span id="TinkoffBrokerServer.Deals-1928"><a href="#-1928"><span class="linenos">1928</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| **Commissions and taxes:** | Broker commissions:           | Service commissions:         | Margin commissions:  | All taxes/corrections:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Deals-1929"><a href="#-1929"><span class="linenos">1929</span></a>                <span class="n">comKeys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;brokerCom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;serviceCom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;marginCom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;allTaxes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))))</span>
</span><span id="TinkoffBrokerServer.Deals-1930"><a href="#-1930"><span class="linenos">1930</span></a>
</span><span id="TinkoffBrokerServer.Deals-1931"><a href="#-1931"><span class="linenos">1931</span></a>                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">comKeys</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Deals-1932"><a href="#-1932"><span class="linenos">1932</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_InfoStr</span><span class="p">(</span><span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;brokerCom&quot;</span><span class="p">],</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;serviceCom&quot;</span><span class="p">],</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;marginCom&quot;</span><span class="p">],</span> <span class="n">customStat</span><span class="p">[</span><span class="s2">&quot;allTaxes&quot;</span><span class="p">],</span> <span class="n">key</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.Deals-1933"><a href="#-1933"><span class="linenos">1933</span></a>
</span><span id="TinkoffBrokerServer.Deals-1934"><a href="#-1934"><span class="linenos">1934</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">splitLine1</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Deals-1935"><a href="#-1935"><span class="linenos">1935</span></a>
</span><span id="TinkoffBrokerServer.Deals-1936"><a href="#-1936"><span class="linenos">1936</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
</span><span id="TinkoffBrokerServer.Deals-1937"><a href="#-1937"><span class="linenos">1937</span></a>                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">## All operations</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Deals-1938"><a href="#-1938"><span class="linenos">1938</span></a>                    <span class="s2">&quot;| Date and time       | FIGI         | Ticker       | Asset      | Value     | Payment         | Status     | Operation type</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Deals-1939"><a href="#-1939"><span class="linenos">1939</span></a>                    <span class="s2">&quot;|---------------------|--------------|--------------|------------|-----------|-----------------|------------|--------------------------------------------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Deals-1940"><a href="#-1940"><span class="linenos">1940</span></a>                <span class="p">])</span>
</span><span id="TinkoffBrokerServer.Deals-1941"><a href="#-1941"><span class="linenos">1941</span></a>
</span><span id="TinkoffBrokerServer.Deals-1942"><a href="#-1942"><span class="linenos">1942</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Deals-1943"><a href="#-1943"><span class="linenos">1943</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Broker returned no operations during this period</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Deals-1944"><a href="#-1944"><span class="linenos">1944</span></a>
</span><span id="TinkoffBrokerServer.Deals-1945"><a href="#-1945"><span class="linenos">1945</span></a>            <span class="c1"># --- view &quot;Operations&quot; section:</span>
</span><span id="TinkoffBrokerServer.Deals-1946"><a href="#-1946"><span class="linenos">1946</span></a>            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Deals-1947"><a href="#-1947"><span class="linenos">1947</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.Deals-1948"><a href="#-1948"><span class="linenos">1948</span></a>                <span class="n">payment</span> <span class="o">=</span> <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">])</span>
</span><span id="TinkoffBrokerServer.Deals-1949"><a href="#-1949"><span class="linenos">1949</span></a>                <span class="n">instrument</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SearchByFIGI</span><span class="p">(</span><span class="n">requestPrice</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="k">else</span> <span class="p">{}</span>
</span><span id="TinkoffBrokerServer.Deals-1950"><a href="#-1950"><span class="linenos">1950</span></a>
</span><span id="TinkoffBrokerServer.Deals-1951"><a href="#-1951"><span class="linenos">1951</span></a>                <span class="c1"># group of deals during one day:</span>
</span><span id="TinkoffBrokerServer.Deals-1952"><a href="#-1952"><span class="linenos">1952</span></a>                <span class="k">if</span> <span class="n">nextDay</span> <span class="ow">and</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">nextDay</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Deals-1953"><a href="#-1953"><span class="linenos">1953</span></a>                    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">splitLine2</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Deals-1954"><a href="#-1954"><span class="linenos">1954</span></a>                    <span class="n">nextDay</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.Deals-1955"><a href="#-1955"><span class="linenos">1955</span></a>
</span><span id="TinkoffBrokerServer.Deals-1956"><a href="#-1956"><span class="linenos">1956</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Deals-1957"><a href="#-1957"><span class="linenos">1957</span></a>                    <span class="n">nextDay</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># saving current day for splitting</span>
</span><span id="TinkoffBrokerServer.Deals-1958"><a href="#-1958"><span class="linenos">1958</span></a>
</span><span id="TinkoffBrokerServer.Deals-1959"><a href="#-1959"><span class="linenos">1959</span></a>                <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| </span><span class="si">{:&lt;19}</span><span class="s2"> | </span><span class="si">{:&lt;12}</span><span class="s2"> | </span><span class="si">{:&lt;12}</span><span class="s2"> | </span><span class="si">{:&lt;10}</span><span class="s2"> | </span><span class="si">{:&lt;9}</span><span class="s2"> | </span><span class="si">{:&gt;15}</span><span class="s2"> | </span><span class="si">{:&lt;10}</span><span class="s2"> | </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.Deals-1960"><a href="#-1960"><span class="linenos">1960</span></a>                    <span class="n">item</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Deals-1961"><a href="#-1961"><span class="linenos">1961</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Deals-1962"><a href="#-1962"><span class="linenos">1962</span></a>                    <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">instrument</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Deals-1963"><a href="#-1963"><span class="linenos">1963</span></a>                    <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">instrument</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Deals-1964"><a href="#-1964"><span class="linenos">1964</span></a>                    <span class="n">item</span><span class="p">[</span><span class="s2">&quot;quantity&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;quantity&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Deals-1965"><a href="#-1965"><span class="linenos">1965</span></a>                    <span class="s2">&quot;</span><span class="si">{}{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;+&quot;</span> <span class="k">if</span> <span class="n">payment</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">payment</span><span class="p">,</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;payment&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">payment</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Deals-1966"><a href="#-1966"><span class="linenos">1966</span></a>                    <span class="n">TKS_OPERATION_STATES</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]],</span>
</span><span id="TinkoffBrokerServer.Deals-1967"><a href="#-1967"><span class="linenos">1967</span></a>                    <span class="n">TKS_OPERATION_TYPES</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;operationType&quot;</span><span class="p">]],</span>
</span><span id="TinkoffBrokerServer.Deals-1968"><a href="#-1968"><span class="linenos">1968</span></a>                <span class="p">))</span>
</span><span id="TinkoffBrokerServer.Deals-1969"><a href="#-1969"><span class="linenos">1969</span></a>
</span><span id="TinkoffBrokerServer.Deals-1970"><a href="#-1970"><span class="linenos">1970</span></a>            <span class="n">infoText</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Deals-1971"><a href="#-1971"><span class="linenos">1971</span></a>
</span><span id="TinkoffBrokerServer.Deals-1972"><a href="#-1972"><span class="linenos">1972</span></a>            <span class="k">if</span> <span class="n">printDeals</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Deals-1973"><a href="#-1973"><span class="linenos">1973</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">infoText</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Deals-1974"><a href="#-1974"><span class="linenos">1974</span></a>
</span><span id="TinkoffBrokerServer.Deals-1975"><a href="#-1975"><span class="linenos">1975</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reportFile</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Deals-1976"><a href="#-1976"><span class="linenos">1976</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reportFile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fH</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Deals-1977"><a href="#-1977"><span class="linenos">1977</span></a>                    <span class="n">fH</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">infoText</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Deals-1978"><a href="#-1978"><span class="linenos">1978</span></a>
</span><span id="TinkoffBrokerServer.Deals-1979"><a href="#-1979"><span class="linenos">1979</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;History of a client&#39;s operations are saved to file: [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reportFile</span><span class="p">)))</span>
</span><span id="TinkoffBrokerServer.Deals-1980"><a href="#-1980"><span class="linenos">1980</span></a>
</span><span id="TinkoffBrokerServer.Deals-1981"><a href="#-1981"><span class="linenos">1981</span></a>        <span class="k">return</span> <span class="n">ops</span><span class="p">,</span> <span class="n">customStat</span>
</span></pre></div>


            <div class="docstring"><p>Returns history operations between two given dates.
If <code><a href="#TinkoffBrokerServer.reportFile">reportFile</a></code> string is not empty then also save human-readable report.
Shows some statistical data of closed positions.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>start</strong>:  see docstring in <code><a href="#GetDatesAsString">GetDatesAsString()</a></code> method</li>
<li><strong>end</strong>:  see docstring in <code><a href="#GetDatesAsString">GetDatesAsString()</a></code> method</li>
<li><strong>printDeals</strong>:  if <code>True</code> then also print all records to the console.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>original list of dictionaries with history of deals records from API ("operations" key):
           <a href="https://tinkoff.github.io/investAPI/swagger-ui/#/OperationsService/OperationsService_GetOperations">https://tinkoff.github.io/investAPI/swagger-ui/#/OperationsService/OperationsService_GetOperations</a>
           and dictionary with custom stats: operations in different currencies, withdrawals, incomes etc.</p>
</blockquote>
</div>


                            </div>
                            <div id="TinkoffBrokerServer.History" class="classattr">
                                        <input id="TinkoffBrokerServer.History-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">History</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">onlyMissing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span>)</span>

                <label class="view-source-button" for="TinkoffBrokerServer.History-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.History"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TinkoffBrokerServer.History-1983"><a href="#-1983"><span class="linenos">1983</span></a>    <span class="k">def</span> <span class="nf">History</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">onlyMissing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="TinkoffBrokerServer.History-1984"><a href="#-1984"><span class="linenos">1984</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.History-1985"><a href="#-1985"><span class="linenos">1985</span></a><span class="sd">        This method returns last history candles of the current instrument defined by `ticker`.</span>
</span><span id="TinkoffBrokerServer.History-1986"><a href="#-1986"><span class="linenos">1986</span></a><span class="sd">        If `historyFile` is not None then method save history to this file, otherwise return only pandas dataframe.</span>
</span><span id="TinkoffBrokerServer.History-1987"><a href="#-1987"><span class="linenos">1987</span></a><span class="sd">        `historyLength` define how many candles returns from past to current date.</span>
</span><span id="TinkoffBrokerServer.History-1988"><a href="#-1988"><span class="linenos">1988</span></a><span class="sd">        `historyInterval` define candle interval. Available values are strings: `&quot;1min&quot;`, `&quot;2min&quot;`, `&quot;3min&quot;`, `&quot;5min&quot;`,</span>
</span><span id="TinkoffBrokerServer.History-1989"><a href="#-1989"><span class="linenos">1989</span></a><span class="sd">        `&quot;10min&quot;`, `&quot;15min&quot;`, `&quot;30min&quot;`, `&quot;hour&quot;`, `&quot;day&quot;`, `&quot;week&quot;`, `&quot;month&quot;`. Default: `&quot;hour&quot;`.</span>
</span><span id="TinkoffBrokerServer.History-1990"><a href="#-1990"><span class="linenos">1990</span></a><span class="sd">        Maximum requested history date in the past: `1970.01.02 03:45`</span>
</span><span id="TinkoffBrokerServer.History-1991"><a href="#-1991"><span class="linenos">1991</span></a>
</span><span id="TinkoffBrokerServer.History-1992"><a href="#-1992"><span class="linenos">1992</span></a><span class="sd">        :param onlyMissing: if history file define then add only last missing candles, do not request all history length. False by default.</span>
</span><span id="TinkoffBrokerServer.History-1993"><a href="#-1993"><span class="linenos">1993</span></a><span class="sd">                            WARNING! History appends only from last candle to current time with replace last candle! Intervals must be similar!</span>
</span><span id="TinkoffBrokerServer.History-1994"><a href="#-1994"><span class="linenos">1994</span></a><span class="sd">        :return: pandas dataframe with stock history. Columns: `date`, `time`, `open`, `high`, `low`, `close`, `volume`.</span>
</span><span id="TinkoffBrokerServer.History-1995"><a href="#-1995"><span class="linenos">1995</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.History-1996"><a href="#-1996"><span class="linenos">1996</span></a>        <span class="n">history</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># empty pandas object for history</span>
</span><span id="TinkoffBrokerServer.History-1997"><a href="#-1997"><span class="linenos">1997</span></a>        <span class="c1"># TODO: update history to work with api v2</span>
</span><span id="TinkoffBrokerServer.History-1998"><a href="#-1998"><span class="linenos">1998</span></a>        <span class="c1"># if self.historyLength &lt; 1:</span>
</span><span id="TinkoffBrokerServer.History-1999"><a href="#-1999"><span class="linenos">1999</span></a>        <span class="c1">#     raise Exception(&quot;History length parameter must be &gt;=1!&quot;)</span>
</span><span id="TinkoffBrokerServer.History-2000"><a href="#-2000"><span class="linenos">2000</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer.History-2001"><a href="#-2001"><span class="linenos">2001</span></a>        <span class="c1"># if self.historyInterval not in TKS_TIMEFRAMES.keys():</span>
</span><span id="TinkoffBrokerServer.History-2002"><a href="#-2002"><span class="linenos">2002</span></a>        <span class="c1">#     raise Exception(&quot;Interval parameter must be string with available values: 1min, 2min, 3min, 5min, 10min, 15min, 30min, hour, day, week, month.&quot;)</span>
</span><span id="TinkoffBrokerServer.History-2003"><a href="#-2003"><span class="linenos">2003</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer.History-2004"><a href="#-2004"><span class="linenos">2004</span></a>        <span class="c1"># if not (self.ticker or self.figi):</span>
</span><span id="TinkoffBrokerServer.History-2005"><a href="#-2005"><span class="linenos">2005</span></a>        <span class="c1">#     raise Exception(&quot;self.ticker or self.figi variables must be defined!&quot;)</span>
</span><span id="TinkoffBrokerServer.History-2006"><a href="#-2006"><span class="linenos">2006</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer.History-2007"><a href="#-2007"><span class="linenos">2007</span></a>        <span class="c1"># if self.ticker and not self.figi:</span>
</span><span id="TinkoffBrokerServer.History-2008"><a href="#-2008"><span class="linenos">2008</span></a>        <span class="c1">#     instrumentByTicker = self.SearchByTicker(requestPrice=False, debug=False)</span>
</span><span id="TinkoffBrokerServer.History-2009"><a href="#-2009"><span class="linenos">2009</span></a>        <span class="c1">#     self.figi = instrumentByTicker[&quot;figi&quot;] if instrumentByTicker else &quot;&quot;</span>
</span><span id="TinkoffBrokerServer.History-2010"><a href="#-2010"><span class="linenos">2010</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer.History-2011"><a href="#-2011"><span class="linenos">2011</span></a>        <span class="c1"># endDate = datetime.now(tzutc())  # current time for request history</span>
</span><span id="TinkoffBrokerServer.History-2012"><a href="#-2012"><span class="linenos">2012</span></a>        <span class="c1"># tempOld = None  # pandas object for old history, if --only-missing key present</span>
</span><span id="TinkoffBrokerServer.History-2013"><a href="#-2013"><span class="linenos">2013</span></a>        <span class="c1"># lastTime = None  # datetime object of last old candle in file</span>
</span><span id="TinkoffBrokerServer.History-2014"><a href="#-2014"><span class="linenos">2014</span></a>        <span class="c1"># minStartDate = datetime.strptime(&quot;1970.01.02 03:45&quot;, &quot;%Y.%m.%d %H:%M&quot;).astimezone(tzutc())  # Maximum requested history date in the past</span>
</span><span id="TinkoffBrokerServer.History-2015"><a href="#-2015"><span class="linenos">2015</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer.History-2016"><a href="#-2016"><span class="linenos">2016</span></a>        <span class="c1"># # get old history saved earlier in file:</span>
</span><span id="TinkoffBrokerServer.History-2017"><a href="#-2017"><span class="linenos">2017</span></a>        <span class="c1"># if onlyMissing and self.historyFile and os.path.exists(self.historyFile):</span>
</span><span id="TinkoffBrokerServer.History-2018"><a href="#-2018"><span class="linenos">2018</span></a>        <span class="c1">#     uLogger.debug(&quot;--only-missing key present, so auto decreasing --length value...&quot;)</span>
</span><span id="TinkoffBrokerServer.History-2019"><a href="#-2019"><span class="linenos">2019</span></a>        <span class="c1">#     uLogger.debug(&quot;Only append missing last history candles at the end of the file [{}]&quot;.format(os.path.abspath(self.historyFile)))</span>
</span><span id="TinkoffBrokerServer.History-2020"><a href="#-2020"><span class="linenos">2020</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer.History-2021"><a href="#-2021"><span class="linenos">2021</span></a>        <span class="c1">#     tempOld = pd.read_csv(self.historyFile, sep=&quot;,&quot;, header=None, names=[&quot;date&quot;, &quot;time&quot;, &quot;open&quot;, &quot;high&quot;, &quot;low&quot;, &quot;close&quot;, &quot;volume&quot;])</span>
</span><span id="TinkoffBrokerServer.History-2022"><a href="#-2022"><span class="linenos">2022</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer.History-2023"><a href="#-2023"><span class="linenos">2023</span></a>        <span class="c1">#     tempOld[&quot;date&quot;] = pd.to_datetime(tempOld[&quot;date&quot;])  # load date &quot;as is&quot;</span>
</span><span id="TinkoffBrokerServer.History-2024"><a href="#-2024"><span class="linenos">2024</span></a>        <span class="c1">#     tempOld[&quot;date&quot;] = tempOld[&quot;date&quot;].dt.strftime(&quot;%Y.%m.%d&quot;)  # convert date to string</span>
</span><span id="TinkoffBrokerServer.History-2025"><a href="#-2025"><span class="linenos">2025</span></a>        <span class="c1">#     tempOld[&quot;time&quot;] = pd.to_datetime(tempOld[&quot;time&quot;])  # load time &quot;as is&quot;</span>
</span><span id="TinkoffBrokerServer.History-2026"><a href="#-2026"><span class="linenos">2026</span></a>        <span class="c1">#     tempOld[&quot;time&quot;] = tempOld[&quot;time&quot;].dt.strftime(&quot;%H:%M&quot;)  # convert time to string</span>
</span><span id="TinkoffBrokerServer.History-2027"><a href="#-2027"><span class="linenos">2027</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer.History-2028"><a href="#-2028"><span class="linenos">2028</span></a>        <span class="c1">#     # get last datetime object from last string in file or minus 1 delta if file is empty:</span>
</span><span id="TinkoffBrokerServer.History-2029"><a href="#-2029"><span class="linenos">2029</span></a>        <span class="c1">#     if len(tempOld) &gt; 0:</span>
</span><span id="TinkoffBrokerServer.History-2030"><a href="#-2030"><span class="linenos">2030</span></a>        <span class="c1">#         lastTime = datetime.strptime(tempOld.date.iloc[-1] + &quot; &quot; + tempOld.time.iloc[-1], &quot;%Y.%m.%d %H:%M&quot;).astimezone(tzutc())</span>
</span><span id="TinkoffBrokerServer.History-2031"><a href="#-2031"><span class="linenos">2031</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer.History-2032"><a href="#-2032"><span class="linenos">2032</span></a>        <span class="c1">#     else:</span>
</span><span id="TinkoffBrokerServer.History-2033"><a href="#-2033"><span class="linenos">2033</span></a>        <span class="c1">#         lastTime = endDate - timedelta(minutes=TKS_TIMEFRAMES[self.historyInterval][&quot;minutes&quot;])</span>
</span><span id="TinkoffBrokerServer.History-2034"><a href="#-2034"><span class="linenos">2034</span></a>        <span class="c1">#         uLogger.warning(&quot;No history in file, set last date to request at [{}]&quot;.format(lastTime))</span>
</span><span id="TinkoffBrokerServer.History-2035"><a href="#-2035"><span class="linenos">2035</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer.History-2036"><a href="#-2036"><span class="linenos">2036</span></a>        <span class="c1">#     delta = endDate - lastTime  # current time minus last time in file</span>
</span><span id="TinkoffBrokerServer.History-2037"><a href="#-2037"><span class="linenos">2037</span></a>        <span class="c1">#     deltaMinutes = delta.days * 1440 + delta.seconds // 60  # minutes between last datetime and current datetime</span>
</span><span id="TinkoffBrokerServer.History-2038"><a href="#-2038"><span class="linenos">2038</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer.History-2039"><a href="#-2039"><span class="linenos">2039</span></a>        <span class="c1">#     # calculate new (decreased) history length to download:</span>
</span><span id="TinkoffBrokerServer.History-2040"><a href="#-2040"><span class="linenos">2040</span></a>        <span class="c1">#     self.historyLength = deltaMinutes // TKS_TIMEFRAMES[self.historyInterval][&quot;minutes&quot;]</span>
</span><span id="TinkoffBrokerServer.History-2041"><a href="#-2041"><span class="linenos">2041</span></a>        <span class="c1">#     if deltaMinutes % TKS_TIMEFRAMES[self.historyInterval][&quot;minutes&quot;] &gt; 0:</span>
</span><span id="TinkoffBrokerServer.History-2042"><a href="#-2042"><span class="linenos">2042</span></a>        <span class="c1">#         self.historyLength += 1  # to avoid fraction time</span>
</span><span id="TinkoffBrokerServer.History-2043"><a href="#-2043"><span class="linenos">2043</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer.History-2044"><a href="#-2044"><span class="linenos">2044</span></a>        <span class="c1">#     tempOld = tempOld[:-1]  # always remove last old candle because it may be incompletely at the current time</span>
</span><span id="TinkoffBrokerServer.History-2045"><a href="#-2045"><span class="linenos">2045</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer.History-2046"><a href="#-2046"><span class="linenos">2046</span></a>        <span class="c1"># if self.figi:</span>
</span><span id="TinkoffBrokerServer.History-2047"><a href="#-2047"><span class="linenos">2047</span></a>        <span class="c1">#     blocks = 1 if self.historyLength &lt;= TKS_TIMEFRAMES[self.historyInterval][&quot;maxCandles&quot;] else 1 + self.historyLength // TKS_TIMEFRAMES[self.historyInterval][&quot;maxCandles&quot;]</span>
</span><span id="TinkoffBrokerServer.History-2048"><a href="#-2048"><span class="linenos">2048</span></a>        <span class="c1">#     responseJSONs = []  # raw history blocks</span>
</span><span id="TinkoffBrokerServer.History-2049"><a href="#-2049"><span class="linenos">2049</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer.History-2050"><a href="#-2050"><span class="linenos">2050</span></a>        <span class="c1">#     uLogger.debug(&quot;Request last history from Tinkoff Broker server for ticker [{}], FIGI [{}]...&quot;.format(self.ticker, self.figi))</span>
</span><span id="TinkoffBrokerServer.History-2051"><a href="#-2051"><span class="linenos">2051</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer.History-2052"><a href="#-2052"><span class="linenos">2052</span></a>        <span class="c1">#     uLogger.debug(&quot;Requested history length: [{}], interval: [{}]&quot;.format(self.historyLength, self.historyInterval))</span>
</span><span id="TinkoffBrokerServer.History-2053"><a href="#-2053"><span class="linenos">2053</span></a>        <span class="c1">#     uLogger.debug(&quot;User requested time period is about from [{}] to [{}]&quot;.format(</span>
</span><span id="TinkoffBrokerServer.History-2054"><a href="#-2054"><span class="linenos">2054</span></a>        <span class="c1">#         (endDate - timedelta(minutes=TKS_TIMEFRAMES[self.historyInterval][&quot;minutes&quot;] * self.historyLength)).strftime(&quot;%Y-%m-%d %H:%M:%S&quot;),</span>
</span><span id="TinkoffBrokerServer.History-2055"><a href="#-2055"><span class="linenos">2055</span></a>        <span class="c1">#         endDate.strftime(&quot;%Y-%m-%d %H:%M:%S&quot;),</span>
</span><span id="TinkoffBrokerServer.History-2056"><a href="#-2056"><span class="linenos">2056</span></a>        <span class="c1">#     ))</span>
</span><span id="TinkoffBrokerServer.History-2057"><a href="#-2057"><span class="linenos">2057</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer.History-2058"><a href="#-2058"><span class="linenos">2058</span></a>        <span class="c1">#     uLogger.debug(&quot;Blocks count: [{}], max candles in block for this interval: [{}]&quot;.format(blocks, TKS_TIMEFRAMES[self.historyInterval][&quot;maxCandles&quot;]))</span>
</span><span id="TinkoffBrokerServer.History-2059"><a href="#-2059"><span class="linenos">2059</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer.History-2060"><a href="#-2060"><span class="linenos">2060</span></a>        <span class="c1">#     oldFlag = False</span>
</span><span id="TinkoffBrokerServer.History-2061"><a href="#-2061"><span class="linenos">2061</span></a>        <span class="c1">#     for item in range(blocks):</span>
</span><span id="TinkoffBrokerServer.History-2062"><a href="#-2062"><span class="linenos">2062</span></a>        <span class="c1">#         tail = self.historyLength % TKS_TIMEFRAMES[self.historyInterval][&quot;maxCandles&quot;] if item + 1 == blocks else TKS_TIMEFRAMES[self.historyInterval][&quot;maxCandles&quot;]</span>
</span><span id="TinkoffBrokerServer.History-2063"><a href="#-2063"><span class="linenos">2063</span></a>        <span class="c1">#         startDate = endDate - timedelta(minutes=TKS_TIMEFRAMES[self.historyInterval][&quot;minutes&quot;] * tail)</span>
</span><span id="TinkoffBrokerServer.History-2064"><a href="#-2064"><span class="linenos">2064</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer.History-2065"><a href="#-2065"><span class="linenos">2065</span></a>        <span class="c1">#         if startDate &lt; minStartDate:</span>
</span><span id="TinkoffBrokerServer.History-2066"><a href="#-2066"><span class="linenos">2066</span></a>        <span class="c1">#             startDate = minStartDate  # set minimum date in the past if delta is too long</span>
</span><span id="TinkoffBrokerServer.History-2067"><a href="#-2067"><span class="linenos">2067</span></a>        <span class="c1">#             uLogger.debug(&quot;Date in the past is too old for request. Set start time to [{}]&quot;.format(minStartDate.strftime(&quot;%Y-%m-%d %H:%M:%S&quot;)))</span>
</span><span id="TinkoffBrokerServer.History-2068"><a href="#-2068"><span class="linenos">2068</span></a>        <span class="c1">#             oldFlag = True</span>
</span><span id="TinkoffBrokerServer.History-2069"><a href="#-2069"><span class="linenos">2069</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer.History-2070"><a href="#-2070"><span class="linenos">2070</span></a>        <span class="c1">#         uLogger.debug(&quot;Block time period: from [{}] to [{}] ({}/{})&quot;.format(</span>
</span><span id="TinkoffBrokerServer.History-2071"><a href="#-2071"><span class="linenos">2071</span></a>        <span class="c1">#             startDate.strftime(&quot;%Y-%m-%d %H:%M:%S&quot;),</span>
</span><span id="TinkoffBrokerServer.History-2072"><a href="#-2072"><span class="linenos">2072</span></a>        <span class="c1">#             endDate.strftime(&quot;%Y-%m-%d %H:%M:%S&quot;),</span>
</span><span id="TinkoffBrokerServer.History-2073"><a href="#-2073"><span class="linenos">2073</span></a>        <span class="c1">#             item + 1,</span>
</span><span id="TinkoffBrokerServer.History-2074"><a href="#-2074"><span class="linenos">2074</span></a>        <span class="c1">#             blocks,</span>
</span><span id="TinkoffBrokerServer.History-2075"><a href="#-2075"><span class="linenos">2075</span></a>        <span class="c1">#         ))</span>
</span><span id="TinkoffBrokerServer.History-2076"><a href="#-2076"><span class="linenos">2076</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer.History-2077"><a href="#-2077"><span class="linenos">2077</span></a>        <span class="c1">#         historyURL = self.server + r&quot;/market/candles?figi={}&amp;from={}&amp;to={}&amp;interval={}&quot;.format(</span>
</span><span id="TinkoffBrokerServer.History-2078"><a href="#-2078"><span class="linenos">2078</span></a>        <span class="c1">#             self.figi,</span>
</span><span id="TinkoffBrokerServer.History-2079"><a href="#-2079"><span class="linenos">2079</span></a>        <span class="c1">#             quote(startDate.isoformat()),</span>
</span><span id="TinkoffBrokerServer.History-2080"><a href="#-2080"><span class="linenos">2080</span></a>        <span class="c1">#             quote(endDate.isoformat()),</span>
</span><span id="TinkoffBrokerServer.History-2081"><a href="#-2081"><span class="linenos">2081</span></a>        <span class="c1">#             self.historyInterval,</span>
</span><span id="TinkoffBrokerServer.History-2082"><a href="#-2082"><span class="linenos">2082</span></a>        <span class="c1">#         )</span>
</span><span id="TinkoffBrokerServer.History-2083"><a href="#-2083"><span class="linenos">2083</span></a>        <span class="c1">#         responseJSON = self.SendAPIRequest(historyURL, debug=False)[&quot;payload&quot;][&quot;candles&quot;]</span>
</span><span id="TinkoffBrokerServer.History-2084"><a href="#-2084"><span class="linenos">2084</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer.History-2085"><a href="#-2085"><span class="linenos">2085</span></a>        <span class="c1">#         responseJSONs = responseJSON + responseJSONs  # add more old history behind newest dates</span>
</span><span id="TinkoffBrokerServer.History-2086"><a href="#-2086"><span class="linenos">2086</span></a>        <span class="c1">#         endDate = startDate</span>
</span><span id="TinkoffBrokerServer.History-2087"><a href="#-2087"><span class="linenos">2087</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer.History-2088"><a href="#-2088"><span class="linenos">2088</span></a>        <span class="c1">#         if oldFlag: break</span>
</span><span id="TinkoffBrokerServer.History-2089"><a href="#-2089"><span class="linenos">2089</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer.History-2090"><a href="#-2090"><span class="linenos">2090</span></a>        <span class="c1">#     if responseJSONs:</span>
</span><span id="TinkoffBrokerServer.History-2091"><a href="#-2091"><span class="linenos">2091</span></a>        <span class="c1">#         tempHistory = pd.DataFrame(</span>
</span><span id="TinkoffBrokerServer.History-2092"><a href="#-2092"><span class="linenos">2092</span></a>        <span class="c1">#             data={</span>
</span><span id="TinkoffBrokerServer.History-2093"><a href="#-2093"><span class="linenos">2093</span></a>        <span class="c1">#                 &quot;date&quot;: [pd.to_datetime(item[&quot;time&quot;]).astimezone(tzutc()) for item in responseJSONs],</span>
</span><span id="TinkoffBrokerServer.History-2094"><a href="#-2094"><span class="linenos">2094</span></a>        <span class="c1">#                 &quot;time&quot;: [pd.to_datetime(item[&quot;time&quot;]).astimezone(tzutc()) for item in responseJSONs],</span>
</span><span id="TinkoffBrokerServer.History-2095"><a href="#-2095"><span class="linenos">2095</span></a>        <span class="c1">#                 &quot;open&quot;: [item[&quot;o&quot;] for item in responseJSONs],</span>
</span><span id="TinkoffBrokerServer.History-2096"><a href="#-2096"><span class="linenos">2096</span></a>        <span class="c1">#                 &quot;high&quot;: [item[&quot;h&quot;] for item in responseJSONs],</span>
</span><span id="TinkoffBrokerServer.History-2097"><a href="#-2097"><span class="linenos">2097</span></a>        <span class="c1">#                 &quot;low&quot;: [item[&quot;l&quot;] for item in responseJSONs],</span>
</span><span id="TinkoffBrokerServer.History-2098"><a href="#-2098"><span class="linenos">2098</span></a>        <span class="c1">#                 &quot;close&quot;: [item[&quot;c&quot;] for item in responseJSONs],</span>
</span><span id="TinkoffBrokerServer.History-2099"><a href="#-2099"><span class="linenos">2099</span></a>        <span class="c1">#                 &quot;volume&quot;: [item[&quot;v&quot;] for item in responseJSONs],</span>
</span><span id="TinkoffBrokerServer.History-2100"><a href="#-2100"><span class="linenos">2100</span></a>        <span class="c1">#             },</span>
</span><span id="TinkoffBrokerServer.History-2101"><a href="#-2101"><span class="linenos">2101</span></a>        <span class="c1">#             index=range(len(responseJSONs)),</span>
</span><span id="TinkoffBrokerServer.History-2102"><a href="#-2102"><span class="linenos">2102</span></a>        <span class="c1">#             columns=[&quot;date&quot;, &quot;time&quot;, &quot;open&quot;, &quot;high&quot;, &quot;low&quot;, &quot;close&quot;, &quot;volume&quot;],</span>
</span><span id="TinkoffBrokerServer.History-2103"><a href="#-2103"><span class="linenos">2103</span></a>        <span class="c1">#         )</span>
</span><span id="TinkoffBrokerServer.History-2104"><a href="#-2104"><span class="linenos">2104</span></a>        <span class="c1">#         tempHistory[&quot;date&quot;] = tempHistory[&quot;date&quot;].dt.strftime(&quot;%Y.%m.%d&quot;)</span>
</span><span id="TinkoffBrokerServer.History-2105"><a href="#-2105"><span class="linenos">2105</span></a>        <span class="c1">#         tempHistory[&quot;time&quot;] = tempHistory[&quot;time&quot;].dt.strftime(&quot;%H:%M&quot;)</span>
</span><span id="TinkoffBrokerServer.History-2106"><a href="#-2106"><span class="linenos">2106</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer.History-2107"><a href="#-2107"><span class="linenos">2107</span></a>        <span class="c1">#         # append only newest candles to old history if --only-missing key present:</span>
</span><span id="TinkoffBrokerServer.History-2108"><a href="#-2108"><span class="linenos">2108</span></a>        <span class="c1">#         if onlyMissing and tempOld is not None and lastTime is not None:</span>
</span><span id="TinkoffBrokerServer.History-2109"><a href="#-2109"><span class="linenos">2109</span></a>        <span class="c1">#             indx = 0  # find start index in given from server tempHistory data:</span>
</span><span id="TinkoffBrokerServer.History-2110"><a href="#-2110"><span class="linenos">2110</span></a>        <span class="c1">#             for i, item in tempHistory.iterrows():</span>
</span><span id="TinkoffBrokerServer.History-2111"><a href="#-2111"><span class="linenos">2111</span></a>        <span class="c1">#                 curTime = datetime.strptime(item[&quot;date&quot;] + &quot; &quot; + item[&quot;time&quot;], &quot;%Y.%m.%d %H:%M&quot;).astimezone(tzutc())</span>
</span><span id="TinkoffBrokerServer.History-2112"><a href="#-2112"><span class="linenos">2112</span></a>        <span class="c1">#                 if curTime == lastTime:</span>
</span><span id="TinkoffBrokerServer.History-2113"><a href="#-2113"><span class="linenos">2113</span></a>        <span class="c1">#                     uLogger.debug(&quot;History candles will be updated starting from the candle with date: [{}]&quot;.format(curTime.strftime(&quot;%Y-%m-%d %H:%M:%S&quot;)))</span>
</span><span id="TinkoffBrokerServer.History-2114"><a href="#-2114"><span class="linenos">2114</span></a>        <span class="c1">#                     indx = i</span>
</span><span id="TinkoffBrokerServer.History-2115"><a href="#-2115"><span class="linenos">2115</span></a>        <span class="c1">#                     break</span>
</span><span id="TinkoffBrokerServer.History-2116"><a href="#-2116"><span class="linenos">2116</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer.History-2117"><a href="#-2117"><span class="linenos">2117</span></a>        <span class="c1">#             history = tempOld.append(tempHistory[indx:], ignore_index=True)</span>
</span><span id="TinkoffBrokerServer.History-2118"><a href="#-2118"><span class="linenos">2118</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer.History-2119"><a href="#-2119"><span class="linenos">2119</span></a>        <span class="c1">#         else:</span>
</span><span id="TinkoffBrokerServer.History-2120"><a href="#-2120"><span class="linenos">2120</span></a>        <span class="c1">#             history = tempHistory  # if no --only-missing key then load full data from server</span>
</span><span id="TinkoffBrokerServer.History-2121"><a href="#-2121"><span class="linenos">2121</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer.History-2122"><a href="#-2122"><span class="linenos">2122</span></a>        <span class="c1">#         uLogger.debug(&quot;Showing last 3 rows of candles history:&quot;)</span>
</span><span id="TinkoffBrokerServer.History-2123"><a href="#-2123"><span class="linenos">2123</span></a>        <span class="c1">#         for line in pd.DataFrame.to_string(</span>
</span><span id="TinkoffBrokerServer.History-2124"><a href="#-2124"><span class="linenos">2124</span></a>        <span class="c1">#                 history[[&quot;date&quot;, &quot;time&quot;, &quot;open&quot;, &quot;high&quot;, &quot;low&quot;, &quot;close&quot;, &quot;volume&quot;]][-3:],</span>
</span><span id="TinkoffBrokerServer.History-2125"><a href="#-2125"><span class="linenos">2125</span></a>        <span class="c1">#                 max_cols=20,</span>
</span><span id="TinkoffBrokerServer.History-2126"><a href="#-2126"><span class="linenos">2126</span></a>        <span class="c1">#         ).split(&quot;\n&quot;):</span>
</span><span id="TinkoffBrokerServer.History-2127"><a href="#-2127"><span class="linenos">2127</span></a>        <span class="c1">#             uLogger.debug(line)</span>
</span><span id="TinkoffBrokerServer.History-2128"><a href="#-2128"><span class="linenos">2128</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer.History-2129"><a href="#-2129"><span class="linenos">2129</span></a>        <span class="c1">#     if self.historyFile is not None:</span>
</span><span id="TinkoffBrokerServer.History-2130"><a href="#-2130"><span class="linenos">2130</span></a>        <span class="c1">#         if history is not None:</span>
</span><span id="TinkoffBrokerServer.History-2131"><a href="#-2131"><span class="linenos">2131</span></a>        <span class="c1">#             history.to_csv(self.historyFile, sep=&quot;,&quot;, index=False, header=False)</span>
</span><span id="TinkoffBrokerServer.History-2132"><a href="#-2132"><span class="linenos">2132</span></a>        <span class="c1">#             uLogger.info(&quot;Ticker [{}], FIGI [{}], tf: [{}], history saved: [{}]&quot;.format(</span>
</span><span id="TinkoffBrokerServer.History-2133"><a href="#-2133"><span class="linenos">2133</span></a>        <span class="c1">#                 self.ticker,</span>
</span><span id="TinkoffBrokerServer.History-2134"><a href="#-2134"><span class="linenos">2134</span></a>        <span class="c1">#                 self.figi,</span>
</span><span id="TinkoffBrokerServer.History-2135"><a href="#-2135"><span class="linenos">2135</span></a>        <span class="c1">#                 self.historyInterval,</span>
</span><span id="TinkoffBrokerServer.History-2136"><a href="#-2136"><span class="linenos">2136</span></a>        <span class="c1">#                 os.path.abspath(self.historyFile),</span>
</span><span id="TinkoffBrokerServer.History-2137"><a href="#-2137"><span class="linenos">2137</span></a>        <span class="c1">#             ))</span>
</span><span id="TinkoffBrokerServer.History-2138"><a href="#-2138"><span class="linenos">2138</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer.History-2139"><a href="#-2139"><span class="linenos">2139</span></a>        <span class="c1">#         else:</span>
</span><span id="TinkoffBrokerServer.History-2140"><a href="#-2140"><span class="linenos">2140</span></a>        <span class="c1">#             uLogger.warning(&quot;Empty history received! File NOT updated: [{}]&quot;.format(os.path.abspath(self.historyFile)))</span>
</span><span id="TinkoffBrokerServer.History-2141"><a href="#-2141"><span class="linenos">2141</span></a>        <span class="c1">#</span>
</span><span id="TinkoffBrokerServer.History-2142"><a href="#-2142"><span class="linenos">2142</span></a>        <span class="c1">#     else:</span>
</span><span id="TinkoffBrokerServer.History-2143"><a href="#-2143"><span class="linenos">2143</span></a>        <span class="c1">#         uLogger.debug(&quot;--output key is not defined. Parsed history file not saved to .csv-file, only pandas dataframe returns.&quot;)</span>
</span><span id="TinkoffBrokerServer.History-2144"><a href="#-2144"><span class="linenos">2144</span></a>
</span><span id="TinkoffBrokerServer.History-2145"><a href="#-2145"><span class="linenos">2145</span></a>        <span class="k">return</span> <span class="n">history</span>
</span></pre></div>


            <div class="docstring"><p>This method returns last history candles of the current instrument defined by <code><a href="#TinkoffBrokerServer.ticker">ticker</a></code>.
If <code><a href="#TinkoffBrokerServer.historyFile">historyFile</a></code> is not None then method save history to this file, otherwise return only pandas dataframe.
<code><a href="#TinkoffBrokerServer.historyLength">historyLength</a></code> define how many candles returns from past to current date.
<code><a href="#TinkoffBrokerServer.historyInterval">historyInterval</a></code> define candle interval. Available values are strings: <code>"1min"</code>, <code>"2min"</code>, <code>"3min"</code>, <code>"5min"</code>,
<code>"10min"</code>, <code>"15min"</code>, <code>"30min"</code>, <code>"hour"</code>, <code>"day"</code>, <code>"week"</code>, <code>"month"</code>. Default: <code>"hour"</code>.
Maximum requested history date in the past: <code>1970.01.02 03:45</code></p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>onlyMissing</strong>:  if history file define then add only last missing candles, do not request all history length. False by default.
                WARNING! History appends only from last candle to current time with replace last candle! Intervals must be similar!</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>pandas dataframe with stock history. Columns: <code>date</code>, <code>time</code>, <code>open</code>, <code>high</code>, <code>low</code>, <code>close</code>, <code>volume</code>.</p>
</blockquote>
</div>


                            </div>
                            <div id="TinkoffBrokerServer.Trade" class="classattr">
                                        <input id="TinkoffBrokerServer.Trade-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">Trade</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">operation</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">lots</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>,</span><span class="param">	<span class="n">tp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>,</span><span class="param">	<span class="n">sl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>,</span><span class="param">	<span class="n">expDate</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Undefined&#39;</span></span><span class="return-annotation">) -> <span class="nb">dict</span>:</span></span>

                <label class="view-source-button" for="TinkoffBrokerServer.Trade-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.Trade"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TinkoffBrokerServer.Trade-2147"><a href="#-2147"><span class="linenos">2147</span></a>    <span class="k">def</span> <span class="nf">Trade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">lots</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">sl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">expDate</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Undefined&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Trade-2148"><a href="#-2148"><span class="linenos">2148</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.Trade-2149"><a href="#-2149"><span class="linenos">2149</span></a><span class="sd">        Universal method to create market order and make deal at the current price. Returns JSON data with response.</span>
</span><span id="TinkoffBrokerServer.Trade-2150"><a href="#-2150"><span class="linenos">2150</span></a><span class="sd">        If `tp` or `sl` &gt; 0, then in additional will opens stop-orders with &quot;TP&quot; and &quot;SL&quot; flags for `stopType` parameter.</span>
</span><span id="TinkoffBrokerServer.Trade-2151"><a href="#-2151"><span class="linenos">2151</span></a>
</span><span id="TinkoffBrokerServer.Trade-2152"><a href="#-2152"><span class="linenos">2152</span></a><span class="sd">        See also: `Order()` docstring. More simple methods than `Trade()` are `Buy()` and `Sell()`.</span>
</span><span id="TinkoffBrokerServer.Trade-2153"><a href="#-2153"><span class="linenos">2153</span></a>
</span><span id="TinkoffBrokerServer.Trade-2154"><a href="#-2154"><span class="linenos">2154</span></a><span class="sd">        :param operation: string &quot;Buy&quot; or &quot;Sell&quot;.</span>
</span><span id="TinkoffBrokerServer.Trade-2155"><a href="#-2155"><span class="linenos">2155</span></a><span class="sd">        :param lots: volume, integer count of lots &gt;= 1.</span>
</span><span id="TinkoffBrokerServer.Trade-2156"><a href="#-2156"><span class="linenos">2156</span></a><span class="sd">        :param tp: float &gt; 0, target price for stop-order with &quot;TP&quot; type. It used as take profit parameter `targetPrice` in `self.Order()`.</span>
</span><span id="TinkoffBrokerServer.Trade-2157"><a href="#-2157"><span class="linenos">2157</span></a><span class="sd">        :param sl: float &gt; 0, target price for stop-order with &quot;SL&quot; type. It used as stop loss parameter `targetPrice` in `self.Order()`.</span>
</span><span id="TinkoffBrokerServer.Trade-2158"><a href="#-2158"><span class="linenos">2158</span></a><span class="sd">        :param expDate: string &quot;Undefined&quot; by default or local date in future,</span>
</span><span id="TinkoffBrokerServer.Trade-2159"><a href="#-2159"><span class="linenos">2159</span></a><span class="sd">                        it is a string with format `%Y-%m-%d %H:%M:%S`.</span>
</span><span id="TinkoffBrokerServer.Trade-2160"><a href="#-2160"><span class="linenos">2160</span></a><span class="sd">        :return: JSON with response from broker server.</span>
</span><span id="TinkoffBrokerServer.Trade-2161"><a href="#-2161"><span class="linenos">2161</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.Trade-2162"><a href="#-2162"><span class="linenos">2162</span></a>        <span class="k">if</span> <span class="n">operation</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">operation</span> <span class="ow">or</span> <span class="n">operation</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Buy&quot;</span><span class="p">,</span> <span class="s2">&quot;Sell&quot;</span><span class="p">):</span>
</span><span id="TinkoffBrokerServer.Trade-2163"><a href="#-2163"><span class="linenos">2163</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;You must define operation type only one of them: `Buy` or `Sell`!&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Trade-2164"><a href="#-2164"><span class="linenos">2164</span></a>
</span><span id="TinkoffBrokerServer.Trade-2165"><a href="#-2165"><span class="linenos">2165</span></a>        <span class="k">if</span> <span class="n">lots</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">lots</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Trade-2166"><a href="#-2166"><span class="linenos">2166</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;You must define trade volume &gt; 0: integer count of lots! For current operation lots reset to 1.&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Trade-2167"><a href="#-2167"><span class="linenos">2167</span></a>            <span class="n">lots</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="TinkoffBrokerServer.Trade-2168"><a href="#-2168"><span class="linenos">2168</span></a>
</span><span id="TinkoffBrokerServer.Trade-2169"><a href="#-2169"><span class="linenos">2169</span></a>        <span class="k">if</span> <span class="n">tp</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">tp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Trade-2170"><a href="#-2170"><span class="linenos">2170</span></a>            <span class="n">tp</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="TinkoffBrokerServer.Trade-2171"><a href="#-2171"><span class="linenos">2171</span></a>
</span><span id="TinkoffBrokerServer.Trade-2172"><a href="#-2172"><span class="linenos">2172</span></a>        <span class="k">if</span> <span class="n">sl</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">sl</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Trade-2173"><a href="#-2173"><span class="linenos">2173</span></a>            <span class="n">sl</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="TinkoffBrokerServer.Trade-2174"><a href="#-2174"><span class="linenos">2174</span></a>
</span><span id="TinkoffBrokerServer.Trade-2175"><a href="#-2175"><span class="linenos">2175</span></a>        <span class="k">if</span> <span class="n">expDate</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">expDate</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Trade-2176"><a href="#-2176"><span class="linenos">2176</span></a>            <span class="n">expDate</span> <span class="o">=</span> <span class="s2">&quot;Undefined&quot;</span>
</span><span id="TinkoffBrokerServer.Trade-2177"><a href="#-2177"><span class="linenos">2177</span></a>
</span><span id="TinkoffBrokerServer.Trade-2178"><a href="#-2178"><span class="linenos">2178</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">):</span>
</span><span id="TinkoffBrokerServer.Trade-2179"><a href="#-2179"><span class="linenos">2179</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;`self.ticker` or `self.figi` variables must be defined!&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Trade-2180"><a href="#-2180"><span class="linenos">2180</span></a>
</span><span id="TinkoffBrokerServer.Trade-2181"><a href="#-2181"><span class="linenos">2181</span></a>        <span class="n">instrument</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SearchByTicker</span><span class="p">(</span><span class="n">requestPrice</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">SearchByFIGI</span><span class="p">(</span><span class="n">requestPrice</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Trade-2182"><a href="#-2182"><span class="linenos">2182</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer.Trade-2183"><a href="#-2183"><span class="linenos">2183</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">=</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer.Trade-2184"><a href="#-2184"><span class="linenos">2184</span></a>
</span><span id="TinkoffBrokerServer.Trade-2185"><a href="#-2185"><span class="linenos">2185</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Opening [</span><span class="si">{}</span><span class="s2">] market order: ticker [</span><span class="si">{}</span><span class="s2">], FIGI [</span><span class="si">{}</span><span class="s2">], lots [</span><span class="si">{}</span><span class="s2">], TP [</span><span class="si">{:.4f}</span><span class="s2">], SL [</span><span class="si">{:.4f}</span><span class="s2">], expiration date of TP/SL orders [</span><span class="si">{}</span><span class="s2">]. Wait, please...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">,</span> <span class="n">lots</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">sl</span><span class="p">,</span> <span class="n">expDate</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.Trade-2186"><a href="#-2186"><span class="linenos">2186</span></a>
</span><span id="TinkoffBrokerServer.Trade-2187"><a href="#-2187"><span class="linenos">2187</span></a>        <span class="n">openTradeURL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;/tinkoff.public.invest.api.contract.v1.OrdersService/PostOrder&quot;</span>
</span><span id="TinkoffBrokerServer.Trade-2188"><a href="#-2188"><span class="linenos">2188</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="nb">str</span><span class="p">({</span>
</span><span id="TinkoffBrokerServer.Trade-2189"><a href="#-2189"><span class="linenos">2189</span></a>            <span class="s2">&quot;figi&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Trade-2190"><a href="#-2190"><span class="linenos">2190</span></a>            <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">lots</span><span class="p">),</span>
</span><span id="TinkoffBrokerServer.Trade-2191"><a href="#-2191"><span class="linenos">2191</span></a>            <span class="s2">&quot;direction&quot;</span><span class="p">:</span> <span class="s2">&quot;ORDER_DIRECTION_BUY&quot;</span> <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;Buy&quot;</span> <span class="k">else</span> <span class="s2">&quot;ORDER_DIRECTION_SELL&quot;</span><span class="p">,</span>  <span class="c1"># see: TKS_ORDER_DIRECTIONS</span>
</span><span id="TinkoffBrokerServer.Trade-2192"><a href="#-2192"><span class="linenos">2192</span></a>            <span class="s2">&quot;accountId&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">accountId</span><span class="p">),</span>
</span><span id="TinkoffBrokerServer.Trade-2193"><a href="#-2193"><span class="linenos">2193</span></a>            <span class="s2">&quot;orderType&quot;</span><span class="p">:</span> <span class="s2">&quot;ORDER_TYPE_MARKET&quot;</span><span class="p">,</span>  <span class="c1"># see: TKS_ORDER_TYPES</span>
</span><span id="TinkoffBrokerServer.Trade-2194"><a href="#-2194"><span class="linenos">2194</span></a>        <span class="p">})</span>
</span><span id="TinkoffBrokerServer.Trade-2195"><a href="#-2195"><span class="linenos">2195</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SendAPIRequest</span><span class="p">(</span><span class="n">openTradeURL</span><span class="p">,</span> <span class="n">reqType</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="n">retry</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Trade-2196"><a href="#-2196"><span class="linenos">2196</span></a>
</span><span id="TinkoffBrokerServer.Trade-2197"><a href="#-2197"><span class="linenos">2197</span></a>        <span class="k">if</span> <span class="s2">&quot;orderId&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.Trade-2198"><a href="#-2198"><span class="linenos">2198</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">] market order [</span><span class="si">{}</span><span class="s2">] was executed: ticker [</span><span class="si">{}</span><span class="s2">], FIGI [</span><span class="si">{}</span><span class="s2">], lots [</span><span class="si">{}</span><span class="s2">]. Total order price: [</span><span class="si">{:.4f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">] (with commission: [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">]). Average price of lot: [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.Trade-2199"><a href="#-2199"><span class="linenos">2199</span></a>                <span class="n">operation</span><span class="p">,</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;orderId&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Trade-2200"><a href="#-2200"><span class="linenos">2200</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">,</span> <span class="n">lots</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Trade-2201"><a href="#-2201"><span class="linenos">2201</span></a>                <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;totalOrderAmount&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;totalOrderAmount&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">]),</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;totalOrderAmount&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Trade-2202"><a href="#-2202"><span class="linenos">2202</span></a>                <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;initialCommission&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;initialCommission&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">]),</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;initialCommission&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Trade-2203"><a href="#-2203"><span class="linenos">2203</span></a>                <span class="n">NanoToFloat</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;executedOrderPrice&quot;</span><span class="p">][</span><span class="s2">&quot;units&quot;</span><span class="p">],</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;executedOrderPrice&quot;</span><span class="p">][</span><span class="s2">&quot;nano&quot;</span><span class="p">]),</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;executedOrderPrice&quot;</span><span class="p">][</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Trade-2204"><a href="#-2204"><span class="linenos">2204</span></a>            <span class="p">))</span>
</span><span id="TinkoffBrokerServer.Trade-2205"><a href="#-2205"><span class="linenos">2205</span></a>
</span><span id="TinkoffBrokerServer.Trade-2206"><a href="#-2206"><span class="linenos">2206</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Trade-2207"><a href="#-2207"><span class="linenos">2207</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Not `oK` status received! Market order not created. See full debug log or try again and open order later.&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Trade-2208"><a href="#-2208"><span class="linenos">2208</span></a>
</span><span id="TinkoffBrokerServer.Trade-2209"><a href="#-2209"><span class="linenos">2209</span></a>        <span class="k">if</span> <span class="n">tp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Trade-2210"><a href="#-2210"><span class="linenos">2210</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Order</span><span class="p">(</span><span class="n">operation</span><span class="o">=</span><span class="s2">&quot;Sell&quot;</span> <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;Buy&quot;</span> <span class="k">else</span> <span class="s2">&quot;Buy&quot;</span><span class="p">,</span> <span class="n">orderType</span><span class="o">=</span><span class="s2">&quot;Stop&quot;</span><span class="p">,</span> <span class="n">lots</span><span class="o">=</span><span class="n">lots</span><span class="p">,</span> <span class="n">targetPrice</span><span class="o">=</span><span class="n">tp</span><span class="p">,</span> <span class="n">limitPrice</span><span class="o">=</span><span class="n">tp</span><span class="p">,</span> <span class="n">stopType</span><span class="o">=</span><span class="s2">&quot;TP&quot;</span><span class="p">,</span> <span class="n">expDate</span><span class="o">=</span><span class="n">expDate</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Trade-2211"><a href="#-2211"><span class="linenos">2211</span></a>
</span><span id="TinkoffBrokerServer.Trade-2212"><a href="#-2212"><span class="linenos">2212</span></a>        <span class="k">if</span> <span class="n">sl</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Trade-2213"><a href="#-2213"><span class="linenos">2213</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Order</span><span class="p">(</span><span class="n">operation</span><span class="o">=</span><span class="s2">&quot;Sell&quot;</span> <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;Buy&quot;</span> <span class="k">else</span> <span class="s2">&quot;Buy&quot;</span><span class="p">,</span> <span class="n">orderType</span><span class="o">=</span><span class="s2">&quot;Stop&quot;</span><span class="p">,</span> <span class="n">lots</span><span class="o">=</span><span class="n">lots</span><span class="p">,</span> <span class="n">targetPrice</span><span class="o">=</span><span class="n">sl</span><span class="p">,</span> <span class="n">limitPrice</span><span class="o">=</span><span class="n">sl</span><span class="p">,</span> <span class="n">stopType</span><span class="o">=</span><span class="s2">&quot;SL&quot;</span><span class="p">,</span> <span class="n">expDate</span><span class="o">=</span><span class="n">expDate</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Trade-2214"><a href="#-2214"><span class="linenos">2214</span></a>
</span><span id="TinkoffBrokerServer.Trade-2215"><a href="#-2215"><span class="linenos">2215</span></a>        <span class="k">return</span> <span class="n">response</span>
</span></pre></div>


            <div class="docstring"><p>Universal method to create market order and make deal at the current price. Returns JSON data with response.
If <code>tp</code> or <code>sl</code> &gt; 0, then in additional will opens stop-orders with "TP" and "SL" flags for <code>stopType</code> parameter.</p>

<p>See also: <code><a href="#TinkoffBrokerServer.Order">Order()</a></code> docstring. More simple methods than <code><a href="#TinkoffBrokerServer.Trade">Trade()</a></code> are <code><a href="#TinkoffBrokerServer.Buy">Buy()</a></code> and <code><a href="#TinkoffBrokerServer.Sell">Sell()</a></code>.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>operation</strong>:  string "Buy" or "Sell".</li>
<li><strong>lots</strong>:  volume, integer count of lots &gt;= 1.</li>
<li><strong>tp</strong>:  float &gt; 0, target price for stop-order with "TP" type. It used as take profit parameter <code>targetPrice</code> in <code>self.Order()</code>.</li>
<li><strong>sl</strong>:  float &gt; 0, target price for stop-order with "SL" type. It used as stop loss parameter <code>targetPrice</code> in <code>self.Order()</code>.</li>
<li><strong>expDate</strong>:  string "Undefined" by default or local date in future,
            it is a string with format <code>%Y-%m-%d %H:%M:%S</code>.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>JSON with response from broker server.</p>
</blockquote>
</div>


                            </div>
                            <div id="TinkoffBrokerServer.Buy" class="classattr">
                                        <input id="TinkoffBrokerServer.Buy-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">Buy</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">lots</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>,</span><span class="param">	<span class="n">tp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>,</span><span class="param">	<span class="n">sl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>,</span><span class="param">	<span class="n">expDate</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Undefined&#39;</span></span><span class="return-annotation">) -> <span class="nb">dict</span>:</span></span>

                <label class="view-source-button" for="TinkoffBrokerServer.Buy-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.Buy"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TinkoffBrokerServer.Buy-2217"><a href="#-2217"><span class="linenos">2217</span></a>    <span class="k">def</span> <span class="nf">Buy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lots</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">sl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">expDate</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Undefined&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Buy-2218"><a href="#-2218"><span class="linenos">2218</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.Buy-2219"><a href="#-2219"><span class="linenos">2219</span></a><span class="sd">        More simple method than `Trade()`. Create `Buy` market order and make deal at the current price. Returns JSON data with response.</span>
</span><span id="TinkoffBrokerServer.Buy-2220"><a href="#-2220"><span class="linenos">2220</span></a><span class="sd">        If `tp` or `sl` &gt; 0, then in additional will opens stop-orders with &quot;TP&quot; and &quot;SL&quot; flags for `stopType` parameter.</span>
</span><span id="TinkoffBrokerServer.Buy-2221"><a href="#-2221"><span class="linenos">2221</span></a>
</span><span id="TinkoffBrokerServer.Buy-2222"><a href="#-2222"><span class="linenos">2222</span></a><span class="sd">        See also: `Order()` and `Trade()` docstrings.</span>
</span><span id="TinkoffBrokerServer.Buy-2223"><a href="#-2223"><span class="linenos">2223</span></a>
</span><span id="TinkoffBrokerServer.Buy-2224"><a href="#-2224"><span class="linenos">2224</span></a><span class="sd">        :param lots: volume, integer count of lots &gt;= 1.</span>
</span><span id="TinkoffBrokerServer.Buy-2225"><a href="#-2225"><span class="linenos">2225</span></a><span class="sd">        :param tp: float &gt; 0, take profit price of stop-order.</span>
</span><span id="TinkoffBrokerServer.Buy-2226"><a href="#-2226"><span class="linenos">2226</span></a><span class="sd">        :param sl: float &gt; 0, stop loss price of stop-order.</span>
</span><span id="TinkoffBrokerServer.Buy-2227"><a href="#-2227"><span class="linenos">2227</span></a><span class="sd">        :param expDate: it&#39;s a local date in future.</span>
</span><span id="TinkoffBrokerServer.Buy-2228"><a href="#-2228"><span class="linenos">2228</span></a><span class="sd">                        String has a format like this: `%Y-%m-%d %H:%M:%S`.</span>
</span><span id="TinkoffBrokerServer.Buy-2229"><a href="#-2229"><span class="linenos">2229</span></a><span class="sd">        :return: JSON with response from broker server.</span>
</span><span id="TinkoffBrokerServer.Buy-2230"><a href="#-2230"><span class="linenos">2230</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.Buy-2231"><a href="#-2231"><span class="linenos">2231</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Trade</span><span class="p">(</span><span class="n">operation</span><span class="o">=</span><span class="s2">&quot;Buy&quot;</span><span class="p">,</span> <span class="n">lots</span><span class="o">=</span><span class="n">lots</span><span class="p">,</span> <span class="n">tp</span><span class="o">=</span><span class="n">tp</span><span class="p">,</span> <span class="n">sl</span><span class="o">=</span><span class="n">sl</span><span class="p">,</span> <span class="n">expDate</span><span class="o">=</span><span class="n">expDate</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>More simple method than <code><a href="#TinkoffBrokerServer.Trade">Trade()</a></code>. Create <code><a href="#TinkoffBrokerServer.Buy">Buy</a></code> market order and make deal at the current price. Returns JSON data with response.
If <code>tp</code> or <code>sl</code> &gt; 0, then in additional will opens stop-orders with "TP" and "SL" flags for <code>stopType</code> parameter.</p>

<p>See also: <code><a href="#TinkoffBrokerServer.Order">Order()</a></code> and <code><a href="#TinkoffBrokerServer.Trade">Trade()</a></code> docstrings.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>lots</strong>:  volume, integer count of lots &gt;= 1.</li>
<li><strong>tp</strong>:  float &gt; 0, take profit price of stop-order.</li>
<li><strong>sl</strong>:  float &gt; 0, stop loss price of stop-order.</li>
<li><strong>expDate</strong>:  it's a local date in future.
            String has a format like this: <code>%Y-%m-%d %H:%M:%S</code>.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>JSON with response from broker server.</p>
</blockquote>
</div>


                            </div>
                            <div id="TinkoffBrokerServer.Sell" class="classattr">
                                        <input id="TinkoffBrokerServer.Sell-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">Sell</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">lots</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>,</span><span class="param">	<span class="n">tp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>,</span><span class="param">	<span class="n">sl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>,</span><span class="param">	<span class="n">expDate</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Undefined&#39;</span></span><span class="return-annotation">) -> <span class="nb">dict</span>:</span></span>

                <label class="view-source-button" for="TinkoffBrokerServer.Sell-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.Sell"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TinkoffBrokerServer.Sell-2233"><a href="#-2233"><span class="linenos">2233</span></a>    <span class="k">def</span> <span class="nf">Sell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lots</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">sl</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">expDate</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Undefined&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Sell-2234"><a href="#-2234"><span class="linenos">2234</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.Sell-2235"><a href="#-2235"><span class="linenos">2235</span></a><span class="sd">        More simple method than `Trade()`. Create `Sell` market order and make deal at the current price. Returns JSON data with response.</span>
</span><span id="TinkoffBrokerServer.Sell-2236"><a href="#-2236"><span class="linenos">2236</span></a><span class="sd">        If `tp` or `sl` &gt; 0, then in additional will opens stop-orders with &quot;TP&quot; and &quot;SL&quot; flags for `stopType` parameter.</span>
</span><span id="TinkoffBrokerServer.Sell-2237"><a href="#-2237"><span class="linenos">2237</span></a>
</span><span id="TinkoffBrokerServer.Sell-2238"><a href="#-2238"><span class="linenos">2238</span></a><span class="sd">        See also: `Order()` and `Trade()` docstrings.</span>
</span><span id="TinkoffBrokerServer.Sell-2239"><a href="#-2239"><span class="linenos">2239</span></a>
</span><span id="TinkoffBrokerServer.Sell-2240"><a href="#-2240"><span class="linenos">2240</span></a><span class="sd">        :param lots: volume, integer count of lots &gt;= 1.</span>
</span><span id="TinkoffBrokerServer.Sell-2241"><a href="#-2241"><span class="linenos">2241</span></a><span class="sd">        :param tp: float &gt; 0, take profit price of stop-order.</span>
</span><span id="TinkoffBrokerServer.Sell-2242"><a href="#-2242"><span class="linenos">2242</span></a><span class="sd">        :param sl: float &gt; 0, stop loss price of stop-order.</span>
</span><span id="TinkoffBrokerServer.Sell-2243"><a href="#-2243"><span class="linenos">2243</span></a><span class="sd">        :param expDate: it&#39;s a local date in future.</span>
</span><span id="TinkoffBrokerServer.Sell-2244"><a href="#-2244"><span class="linenos">2244</span></a><span class="sd">                        String has a format like this: `%Y-%m-%d %H:%M:%S`.</span>
</span><span id="TinkoffBrokerServer.Sell-2245"><a href="#-2245"><span class="linenos">2245</span></a><span class="sd">        :return: JSON with response from broker server.</span>
</span><span id="TinkoffBrokerServer.Sell-2246"><a href="#-2246"><span class="linenos">2246</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.Sell-2247"><a href="#-2247"><span class="linenos">2247</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Trade</span><span class="p">(</span><span class="n">operation</span><span class="o">=</span><span class="s2">&quot;Sell&quot;</span><span class="p">,</span> <span class="n">lots</span><span class="o">=</span><span class="n">lots</span><span class="p">,</span> <span class="n">tp</span><span class="o">=</span><span class="n">tp</span><span class="p">,</span> <span class="n">sl</span><span class="o">=</span><span class="n">sl</span><span class="p">,</span> <span class="n">expDate</span><span class="o">=</span><span class="n">expDate</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>More simple method than <code><a href="#TinkoffBrokerServer.Trade">Trade()</a></code>. Create <code><a href="#TinkoffBrokerServer.Sell">Sell</a></code> market order and make deal at the current price. Returns JSON data with response.
If <code>tp</code> or <code>sl</code> &gt; 0, then in additional will opens stop-orders with "TP" and "SL" flags for <code>stopType</code> parameter.</p>

<p>See also: <code><a href="#TinkoffBrokerServer.Order">Order()</a></code> and <code><a href="#TinkoffBrokerServer.Trade">Trade()</a></code> docstrings.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>lots</strong>:  volume, integer count of lots &gt;= 1.</li>
<li><strong>tp</strong>:  float &gt; 0, take profit price of stop-order.</li>
<li><strong>sl</strong>:  float &gt; 0, stop loss price of stop-order.</li>
<li><strong>expDate</strong>:  it's a local date in future.
            String has a format like this: <code>%Y-%m-%d %H:%M:%S</code>.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>JSON with response from broker server.</p>
</blockquote>
</div>


                            </div>
                            <div id="TinkoffBrokerServer.CloseTrades" class="classattr">
                                        <input id="TinkoffBrokerServer.CloseTrades-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">CloseTrades</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">tickers</span><span class="p">:</span> <span class="nb">list</span>, </span><span class="param"><span class="n">overview</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="TinkoffBrokerServer.CloseTrades-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.CloseTrades"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TinkoffBrokerServer.CloseTrades-2249"><a href="#-2249"><span class="linenos">2249</span></a>    <span class="k">def</span> <span class="nf">CloseTrades</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tickers</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">overview</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2250"><a href="#-2250"><span class="linenos">2250</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2251"><a href="#-2251"><span class="linenos">2251</span></a><span class="sd">        Close position of given instruments.</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2252"><a href="#-2252"><span class="linenos">2252</span></a>
</span><span id="TinkoffBrokerServer.CloseTrades-2253"><a href="#-2253"><span class="linenos">2253</span></a><span class="sd">        :param tickers: tickers list of instruments that must be closed.</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2254"><a href="#-2254"><span class="linenos">2254</span></a><span class="sd">        :param overview: pre-received dictionary with open trades, returned by `Overview()` method.</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2255"><a href="#-2255"><span class="linenos">2255</span></a><span class="sd">                         This avoids unnecessary downloading data from the server.</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2256"><a href="#-2256"><span class="linenos">2256</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2257"><a href="#-2257"><span class="linenos">2257</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">tickers</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2258"><a href="#-2258"><span class="linenos">2258</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Tickers list empty, nothing to close.&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2259"><a href="#-2259"><span class="linenos">2259</span></a>
</span><span id="TinkoffBrokerServer.CloseTrades-2260"><a href="#-2260"><span class="linenos">2260</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2261"><a href="#-2261"><span class="linenos">2261</span></a>            <span class="k">if</span> <span class="n">overview</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">overview</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2262"><a href="#-2262"><span class="linenos">2262</span></a>                <span class="n">overview</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Overview</span><span class="p">(</span><span class="n">showStatistics</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2263"><a href="#-2263"><span class="linenos">2263</span></a>
</span><span id="TinkoffBrokerServer.CloseTrades-2264"><a href="#-2264"><span class="linenos">2264</span></a>            <span class="n">allOpenedTickers</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">iType</span> <span class="ow">in</span> <span class="n">TKS_INSTRUMENTS</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">overview</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="n">iType</span><span class="p">]]</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2265"><a href="#-2265"><span class="linenos">2265</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;All opened instruments by it&#39;s tickers names: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">allOpenedTickers</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2266"><a href="#-2266"><span class="linenos">2266</span></a>
</span><span id="TinkoffBrokerServer.CloseTrades-2267"><a href="#-2267"><span class="linenos">2267</span></a>            <span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">tickers</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2268"><a href="#-2268"><span class="linenos">2268</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">allOpenedTickers</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2269"><a href="#-2269"><span class="linenos">2269</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Instrument with ticker [</span><span class="si">{}</span><span class="s2">] not in open positions list!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ticker</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2270"><a href="#-2270"><span class="linenos">2270</span></a>                    <span class="k">continue</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2271"><a href="#-2271"><span class="linenos">2271</span></a>
</span><span id="TinkoffBrokerServer.CloseTrades-2272"><a href="#-2272"><span class="linenos">2272</span></a>                <span class="c1"># search open trade info about instrument by ticker:</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2273"><a href="#-2273"><span class="linenos">2273</span></a>                <span class="n">instrument</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2274"><a href="#-2274"><span class="linenos">2274</span></a>                <span class="k">for</span> <span class="n">iType</span> <span class="ow">in</span> <span class="n">TKS_INSTRUMENTS</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2275"><a href="#-2275"><span class="linenos">2275</span></a>                    <span class="k">if</span> <span class="n">instrument</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2276"><a href="#-2276"><span class="linenos">2276</span></a>                        <span class="k">break</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2277"><a href="#-2277"><span class="linenos">2277</span></a>
</span><span id="TinkoffBrokerServer.CloseTrades-2278"><a href="#-2278"><span class="linenos">2278</span></a>                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">overview</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="n">iType</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2279"><a href="#-2279"><span class="linenos">2279</span></a>                        <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ticker</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2280"><a href="#-2280"><span class="linenos">2280</span></a>                            <span class="n">instrument</span> <span class="o">=</span> <span class="n">item</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2281"><a href="#-2281"><span class="linenos">2281</span></a>                            <span class="k">break</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2282"><a href="#-2282"><span class="linenos">2282</span></a>
</span><span id="TinkoffBrokerServer.CloseTrades-2283"><a href="#-2283"><span class="linenos">2283</span></a>                <span class="k">if</span> <span class="n">instrument</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2284"><a href="#-2284"><span class="linenos">2284</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">ticker</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2285"><a href="#-2285"><span class="linenos">2285</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">=</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2286"><a href="#-2286"><span class="linenos">2286</span></a>
</span><span id="TinkoffBrokerServer.CloseTrades-2287"><a href="#-2287"><span class="linenos">2287</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Closing trade of instrument: ticker [</span><span class="si">{}</span><span class="s2">], FIGI[</span><span class="si">{}</span><span class="s2">], lots [</span><span class="si">{}</span><span class="s2">]</span><span class="si">{}</span><span class="s2">. Wait, please...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2288"><a href="#-2288"><span class="linenos">2288</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2289"><a href="#-2289"><span class="linenos">2289</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2290"><a href="#-2290"><span class="linenos">2290</span></a>                        <span class="nb">int</span><span class="p">(</span><span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;volume&quot;</span><span class="p">]),</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2291"><a href="#-2291"><span class="linenos">2291</span></a>                        <span class="s2">&quot;, blocked [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;blocked&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;blocked&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2292"><a href="#-2292"><span class="linenos">2292</span></a>                    <span class="p">))</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2293"><a href="#-2293"><span class="linenos">2293</span></a>
</span><span id="TinkoffBrokerServer.CloseTrades-2294"><a href="#-2294"><span class="linenos">2294</span></a>                    <span class="n">tradeLots</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;lots&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;blocked&quot;</span><span class="p">]</span>  <span class="c1"># available volumes in lots for close operation</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2295"><a href="#-2295"><span class="linenos">2295</span></a>
</span><span id="TinkoffBrokerServer.CloseTrades-2296"><a href="#-2296"><span class="linenos">2296</span></a>                    <span class="k">if</span> <span class="n">tradeLots</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2297"><a href="#-2297"><span class="linenos">2297</span></a>                        <span class="k">if</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;blocked&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2298"><a href="#-2298"><span class="linenos">2298</span></a>                            <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Just for your information: there are [</span><span class="si">{}</span><span class="s2">] lots blocked for instrument [</span><span class="si">{}</span><span class="s2">]! Available only [</span><span class="si">{}</span><span class="s2">] lots to closing trade.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2299"><a href="#-2299"><span class="linenos">2299</span></a>                                <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;blocked&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2300"><a href="#-2300"><span class="linenos">2300</span></a>                                <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2301"><a href="#-2301"><span class="linenos">2301</span></a>                                <span class="n">tradeLots</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2302"><a href="#-2302"><span class="linenos">2302</span></a>                            <span class="p">))</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2303"><a href="#-2303"><span class="linenos">2303</span></a>
</span><span id="TinkoffBrokerServer.CloseTrades-2304"><a href="#-2304"><span class="linenos">2304</span></a>                        <span class="c1"># if direction is &quot;Long&quot; then we need sell, if direction is &quot;Short&quot; then we need buy:</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2305"><a href="#-2305"><span class="linenos">2305</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">Trade</span><span class="p">(</span><span class="n">operation</span><span class="o">=</span><span class="s2">&quot;Sell&quot;</span> <span class="k">if</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;direction&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Long&quot;</span> <span class="k">else</span> <span class="s2">&quot;Buy&quot;</span><span class="p">,</span> <span class="n">lots</span><span class="o">=</span><span class="n">tradeLots</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2306"><a href="#-2306"><span class="linenos">2306</span></a>
</span><span id="TinkoffBrokerServer.CloseTrades-2307"><a href="#-2307"><span class="linenos">2307</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.CloseTrades-2308"><a href="#-2308"><span class="linenos">2308</span></a>                        <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;There are no available lots for instrument [</span><span class="si">{}</span><span class="s2">] to closing trade at this moment! Try again later or cancel some orders.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Close position of given instruments.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>tickers</strong>:  tickers list of instruments that must be closed.</li>
<li><strong>overview</strong>:  pre-received dictionary with open trades, returned by <code><a href="#TinkoffBrokerServer.Overview">Overview()</a></code> method.
             This avoids unnecessary downloading data from the server.</li>
</ul>
</div>


                            </div>
                            <div id="TinkoffBrokerServer.CloseAllTrades" class="classattr">
                                        <input id="TinkoffBrokerServer.CloseAllTrades-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">CloseAllTrades</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">iType</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">overview</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="TinkoffBrokerServer.CloseAllTrades-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.CloseAllTrades"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TinkoffBrokerServer.CloseAllTrades-2310"><a href="#-2310"><span class="linenos">2310</span></a>    <span class="k">def</span> <span class="nf">CloseAllTrades</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iType</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">overview</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.CloseAllTrades-2311"><a href="#-2311"><span class="linenos">2311</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.CloseAllTrades-2312"><a href="#-2312"><span class="linenos">2312</span></a><span class="sd">        Close all positions of given instruments with defined type.</span>
</span><span id="TinkoffBrokerServer.CloseAllTrades-2313"><a href="#-2313"><span class="linenos">2313</span></a>
</span><span id="TinkoffBrokerServer.CloseAllTrades-2314"><a href="#-2314"><span class="linenos">2314</span></a><span class="sd">        :param iType: type of the instruments that be closed, it must be one of supported types in TKS_INSTRUMENTS list.</span>
</span><span id="TinkoffBrokerServer.CloseAllTrades-2315"><a href="#-2315"><span class="linenos">2315</span></a><span class="sd">        :param overview: pre-received dictionary with open trades, returned by `Overview()` method.</span>
</span><span id="TinkoffBrokerServer.CloseAllTrades-2316"><a href="#-2316"><span class="linenos">2316</span></a><span class="sd">                         This avoids unnecessary downloading data from the server.</span>
</span><span id="TinkoffBrokerServer.CloseAllTrades-2317"><a href="#-2317"><span class="linenos">2317</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.CloseAllTrades-2318"><a href="#-2318"><span class="linenos">2318</span></a>        <span class="k">if</span> <span class="n">iType</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">TKS_INSTRUMENTS</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.CloseAllTrades-2319"><a href="#-2319"><span class="linenos">2319</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Type of the instrument must be one of supported types: </span><span class="si">{}</span><span class="s2">. Given: [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TKS_INSTRUMENTS</span><span class="p">),</span> <span class="n">iType</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.CloseAllTrades-2320"><a href="#-2320"><span class="linenos">2320</span></a>
</span><span id="TinkoffBrokerServer.CloseAllTrades-2321"><a href="#-2321"><span class="linenos">2321</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.CloseAllTrades-2322"><a href="#-2322"><span class="linenos">2322</span></a>            <span class="k">if</span> <span class="n">overview</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">overview</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.CloseAllTrades-2323"><a href="#-2323"><span class="linenos">2323</span></a>                <span class="n">overview</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Overview</span><span class="p">(</span><span class="n">showStatistics</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.CloseAllTrades-2324"><a href="#-2324"><span class="linenos">2324</span></a>
</span><span id="TinkoffBrokerServer.CloseAllTrades-2325"><a href="#-2325"><span class="linenos">2325</span></a>            <span class="n">tickers</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">overview</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">][</span><span class="n">iType</span><span class="p">]]</span>
</span><span id="TinkoffBrokerServer.CloseAllTrades-2326"><a href="#-2326"><span class="linenos">2326</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Instrument tickers with type [</span><span class="si">{}</span><span class="s2">] that will be closed: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iType</span><span class="p">,</span> <span class="n">tickers</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.CloseAllTrades-2327"><a href="#-2327"><span class="linenos">2327</span></a>
</span><span id="TinkoffBrokerServer.CloseAllTrades-2328"><a href="#-2328"><span class="linenos">2328</span></a>            <span class="k">if</span> <span class="n">tickers</span> <span class="ow">and</span> <span class="n">overview</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.CloseAllTrades-2329"><a href="#-2329"><span class="linenos">2329</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">CloseTrades</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">overview</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.CloseAllTrades-2330"><a href="#-2330"><span class="linenos">2330</span></a>
</span><span id="TinkoffBrokerServer.CloseAllTrades-2331"><a href="#-2331"><span class="linenos">2331</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.CloseAllTrades-2332"><a href="#-2332"><span class="linenos">2332</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Instrument tickers with type [</span><span class="si">{}</span><span class="s2">] not found, nothing to close.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iType</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Close all positions of given instruments with defined type.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>iType</strong>:  type of the instruments that be closed, it must be one of supported types in TKS_INSTRUMENTS list.</li>
<li><strong>overview</strong>:  pre-received dictionary with open trades, returned by <code><a href="#TinkoffBrokerServer.Overview">Overview()</a></code> method.
             This avoids unnecessary downloading data from the server.</li>
</ul>
</div>


                            </div>
                            <div id="TinkoffBrokerServer.Order" class="classattr">
                                        <input id="TinkoffBrokerServer.Order-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">Order</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">operation</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">orderType</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">lots</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">targetPrice</span><span class="p">:</span> <span class="nb">float</span>,</span><span class="param">	<span class="n">limitPrice</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>,</span><span class="param">	<span class="n">stopType</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Limit&#39;</span>,</span><span class="param">	<span class="n">expDate</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Undefined&#39;</span></span><span class="return-annotation">) -> <span class="nb">dict</span>:</span></span>

                <label class="view-source-button" for="TinkoffBrokerServer.Order-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.Order"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TinkoffBrokerServer.Order-2334"><a href="#-2334"><span class="linenos">2334</span></a>    <span class="k">def</span> <span class="nf">Order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">orderType</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">lots</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">targetPrice</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">limitPrice</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">stopType</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Limit&quot;</span><span class="p">,</span> <span class="n">expDate</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Undefined&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Order-2335"><a href="#-2335"><span class="linenos">2335</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.Order-2336"><a href="#-2336"><span class="linenos">2336</span></a><span class="sd">        Universal method to create market or limit orders with all available parameters.</span>
</span><span id="TinkoffBrokerServer.Order-2337"><a href="#-2337"><span class="linenos">2337</span></a><span class="sd">        See more simple methods: `BuyLimit()`, `BuyStop()`, `SellLimit()`, `SellStop()`.</span>
</span><span id="TinkoffBrokerServer.Order-2338"><a href="#-2338"><span class="linenos">2338</span></a>
</span><span id="TinkoffBrokerServer.Order-2339"><a href="#-2339"><span class="linenos">2339</span></a><span class="sd">        If orderType is &quot;Limit&quot; then create pending limit-order below current price if operation is &quot;Buy&quot; and above</span>
</span><span id="TinkoffBrokerServer.Order-2340"><a href="#-2340"><span class="linenos">2340</span></a><span class="sd">        current price if operation is &quot;Sell&quot;. A limit order has no expiration date, it lasts until the end of the trading day.</span>
</span><span id="TinkoffBrokerServer.Order-2341"><a href="#-2341"><span class="linenos">2341</span></a>
</span><span id="TinkoffBrokerServer.Order-2342"><a href="#-2342"><span class="linenos">2342</span></a><span class="sd">        Warning! If you try to create limit-order above current price if &quot;Buy&quot; or below current price if &quot;Sell&quot;</span>
</span><span id="TinkoffBrokerServer.Order-2343"><a href="#-2343"><span class="linenos">2343</span></a><span class="sd">        then broker immediately open market order as you can do simple --buy or --sell operations!</span>
</span><span id="TinkoffBrokerServer.Order-2344"><a href="#-2344"><span class="linenos">2344</span></a>
</span><span id="TinkoffBrokerServer.Order-2345"><a href="#-2345"><span class="linenos">2345</span></a><span class="sd">        If orderType is &quot;Stop&quot; then creates stop-order with any direction &quot;Buy&quot; or &quot;Sell&quot;.</span>
</span><span id="TinkoffBrokerServer.Order-2346"><a href="#-2346"><span class="linenos">2346</span></a><span class="sd">        When current price will go up or down to target price value then broker opens a limit order.</span>
</span><span id="TinkoffBrokerServer.Order-2347"><a href="#-2347"><span class="linenos">2347</span></a><span class="sd">        Stop-order is opened with unlimited expiration date by default, or you can define expiration date with expDate parameter.</span>
</span><span id="TinkoffBrokerServer.Order-2348"><a href="#-2348"><span class="linenos">2348</span></a>
</span><span id="TinkoffBrokerServer.Order-2349"><a href="#-2349"><span class="linenos">2349</span></a><span class="sd">        Only one attempt and no retry for opens order. If network issue occurred you can create new request.</span>
</span><span id="TinkoffBrokerServer.Order-2350"><a href="#-2350"><span class="linenos">2350</span></a>
</span><span id="TinkoffBrokerServer.Order-2351"><a href="#-2351"><span class="linenos">2351</span></a><span class="sd">        :param operation: string &quot;Buy&quot; or &quot;Sell&quot;.</span>
</span><span id="TinkoffBrokerServer.Order-2352"><a href="#-2352"><span class="linenos">2352</span></a><span class="sd">        :param orderType: string &quot;Limit&quot; or &quot;Stop&quot;.</span>
</span><span id="TinkoffBrokerServer.Order-2353"><a href="#-2353"><span class="linenos">2353</span></a><span class="sd">        :param lots: volume, integer count of lots &gt;= 1.</span>
</span><span id="TinkoffBrokerServer.Order-2354"><a href="#-2354"><span class="linenos">2354</span></a><span class="sd">        :param targetPrice: target price &gt; 0. This is open trade price for limit order.</span>
</span><span id="TinkoffBrokerServer.Order-2355"><a href="#-2355"><span class="linenos">2355</span></a><span class="sd">        :param limitPrice: limit price &gt;= 0. This parameter only makes sense for stop-order. If limitPrice = 0, then it set as targetPrice.</span>
</span><span id="TinkoffBrokerServer.Order-2356"><a href="#-2356"><span class="linenos">2356</span></a><span class="sd">                           Broker will creates limit-order with price equal to limitPrice, when current price goes to target price of stop-order.</span>
</span><span id="TinkoffBrokerServer.Order-2357"><a href="#-2357"><span class="linenos">2357</span></a><span class="sd">        :param stopType: string &quot;Limit&quot; by default. This parameter only makes sense for stop-order. There are 3 stop-order types</span>
</span><span id="TinkoffBrokerServer.Order-2358"><a href="#-2358"><span class="linenos">2358</span></a><span class="sd">                         &quot;SL&quot;, &quot;TP&quot;, &quot;Limit&quot; for &quot;Stop loss&quot;, &quot;Take profit&quot; and &quot;Stop limit&quot; types accordingly.</span>
</span><span id="TinkoffBrokerServer.Order-2359"><a href="#-2359"><span class="linenos">2359</span></a><span class="sd">                         Stop loss order always executed by market price.</span>
</span><span id="TinkoffBrokerServer.Order-2360"><a href="#-2360"><span class="linenos">2360</span></a><span class="sd">        :param expDate: string &quot;Undefined&quot; by default or local date in future.</span>
</span><span id="TinkoffBrokerServer.Order-2361"><a href="#-2361"><span class="linenos">2361</span></a><span class="sd">                        String has a format like this: `%Y-%m-%d %H:%M:%S`.</span>
</span><span id="TinkoffBrokerServer.Order-2362"><a href="#-2362"><span class="linenos">2362</span></a><span class="sd">                        This date is converting to UTC format for server. This parameter only makes sense for stop-order.</span>
</span><span id="TinkoffBrokerServer.Order-2363"><a href="#-2363"><span class="linenos">2363</span></a><span class="sd">                        A limit order has no expiration date, it lasts until the end of the trading day.</span>
</span><span id="TinkoffBrokerServer.Order-2364"><a href="#-2364"><span class="linenos">2364</span></a><span class="sd">        :return: JSON with response from broker server.</span>
</span><span id="TinkoffBrokerServer.Order-2365"><a href="#-2365"><span class="linenos">2365</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.Order-2366"><a href="#-2366"><span class="linenos">2366</span></a>        <span class="k">if</span> <span class="n">operation</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">operation</span> <span class="ow">or</span> <span class="n">operation</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Buy&quot;</span><span class="p">,</span> <span class="s2">&quot;Sell&quot;</span><span class="p">):</span>
</span><span id="TinkoffBrokerServer.Order-2367"><a href="#-2367"><span class="linenos">2367</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;You must define operation type only one of them: `Buy` or `Sell`!&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Order-2368"><a href="#-2368"><span class="linenos">2368</span></a>
</span><span id="TinkoffBrokerServer.Order-2369"><a href="#-2369"><span class="linenos">2369</span></a>        <span class="k">if</span> <span class="n">orderType</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">orderType</span> <span class="ow">or</span> <span class="n">orderType</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Limit&quot;</span><span class="p">,</span> <span class="s2">&quot;Stop&quot;</span><span class="p">):</span>
</span><span id="TinkoffBrokerServer.Order-2370"><a href="#-2370"><span class="linenos">2370</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;You must define order type only one of them: `Limit` or `Stop`!&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Order-2371"><a href="#-2371"><span class="linenos">2371</span></a>
</span><span id="TinkoffBrokerServer.Order-2372"><a href="#-2372"><span class="linenos">2372</span></a>        <span class="k">if</span> <span class="n">lots</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">lots</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Order-2373"><a href="#-2373"><span class="linenos">2373</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;You must define trade volume &gt; 0: integer count of lots!&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Order-2374"><a href="#-2374"><span class="linenos">2374</span></a>
</span><span id="TinkoffBrokerServer.Order-2375"><a href="#-2375"><span class="linenos">2375</span></a>        <span class="k">if</span> <span class="n">targetPrice</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">targetPrice</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Order-2376"><a href="#-2376"><span class="linenos">2376</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Target price for limit-order must be greater than 0!&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Order-2377"><a href="#-2377"><span class="linenos">2377</span></a>
</span><span id="TinkoffBrokerServer.Order-2378"><a href="#-2378"><span class="linenos">2378</span></a>        <span class="k">if</span> <span class="n">limitPrice</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">limitPrice</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Order-2379"><a href="#-2379"><span class="linenos">2379</span></a>            <span class="n">limitPrice</span> <span class="o">=</span> <span class="n">targetPrice</span>
</span><span id="TinkoffBrokerServer.Order-2380"><a href="#-2380"><span class="linenos">2380</span></a>
</span><span id="TinkoffBrokerServer.Order-2381"><a href="#-2381"><span class="linenos">2381</span></a>        <span class="k">if</span> <span class="n">stopType</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">stopType</span> <span class="ow">or</span> <span class="n">stopType</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;SL&quot;</span><span class="p">,</span> <span class="s2">&quot;TP&quot;</span><span class="p">,</span> <span class="s2">&quot;Limit&quot;</span><span class="p">):</span>
</span><span id="TinkoffBrokerServer.Order-2382"><a href="#-2382"><span class="linenos">2382</span></a>            <span class="n">stopType</span> <span class="o">=</span> <span class="s2">&quot;Limit&quot;</span>
</span><span id="TinkoffBrokerServer.Order-2383"><a href="#-2383"><span class="linenos">2383</span></a>
</span><span id="TinkoffBrokerServer.Order-2384"><a href="#-2384"><span class="linenos">2384</span></a>        <span class="k">if</span> <span class="n">expDate</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">expDate</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Order-2385"><a href="#-2385"><span class="linenos">2385</span></a>            <span class="n">expDate</span> <span class="o">=</span> <span class="s2">&quot;Undefined&quot;</span>
</span><span id="TinkoffBrokerServer.Order-2386"><a href="#-2386"><span class="linenos">2386</span></a>
</span><span id="TinkoffBrokerServer.Order-2387"><a href="#-2387"><span class="linenos">2387</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">):</span>
</span><span id="TinkoffBrokerServer.Order-2388"><a href="#-2388"><span class="linenos">2388</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;`self.ticker` or `self.figi` variables must be defined!&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Order-2389"><a href="#-2389"><span class="linenos">2389</span></a>
</span><span id="TinkoffBrokerServer.Order-2390"><a href="#-2390"><span class="linenos">2390</span></a>        <span class="n">response</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="TinkoffBrokerServer.Order-2391"><a href="#-2391"><span class="linenos">2391</span></a>        <span class="n">instrument</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SearchByTicker</span><span class="p">(</span><span class="n">requestPrice</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">SearchByFIGI</span><span class="p">(</span><span class="n">requestPrice</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Order-2392"><a href="#-2392"><span class="linenos">2392</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;ticker&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer.Order-2393"><a href="#-2393"><span class="linenos">2393</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">figi</span> <span class="o">=</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;figi&quot;</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer.Order-2394"><a href="#-2394"><span class="linenos">2394</span></a>
</span><span id="TinkoffBrokerServer.Order-2395"><a href="#-2395"><span class="linenos">2395</span></a>        <span class="k">if</span> <span class="n">orderType</span> <span class="o">==</span> <span class="s2">&quot;Limit&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Order-2396"><a href="#-2396"><span class="linenos">2396</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.Order-2397"><a href="#-2397"><span class="linenos">2397</span></a>                <span class="s2">&quot;Creating pending limit-order: ticker [</span><span class="si">{}</span><span class="s2">], FIGI [</span><span class="si">{}</span><span class="s2">], action [</span><span class="si">{}</span><span class="s2">], lots [</span><span class="si">{}</span><span class="s2">] and the target price [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">]. Wait, please...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.Order-2398"><a href="#-2398"><span class="linenos">2398</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Order-2399"><a href="#-2399"><span class="linenos">2399</span></a>                    <span class="n">operation</span><span class="p">,</span> <span class="n">lots</span><span class="p">,</span> <span class="n">targetPrice</span><span class="p">,</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Order-2400"><a href="#-2400"><span class="linenos">2400</span></a>                <span class="p">))</span>
</span><span id="TinkoffBrokerServer.Order-2401"><a href="#-2401"><span class="linenos">2401</span></a>
</span><span id="TinkoffBrokerServer.Order-2402"><a href="#-2402"><span class="linenos">2402</span></a>            <span class="n">openOrderURL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;/tinkoff.public.invest.api.contract.v1.OrdersService/PostOrder&quot;</span>
</span><span id="TinkoffBrokerServer.Order-2403"><a href="#-2403"><span class="linenos">2403</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="nb">str</span><span class="p">({</span>
</span><span id="TinkoffBrokerServer.Order-2404"><a href="#-2404"><span class="linenos">2404</span></a>                <span class="s2">&quot;figi&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Order-2405"><a href="#-2405"><span class="linenos">2405</span></a>                <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">lots</span><span class="p">),</span>
</span><span id="TinkoffBrokerServer.Order-2406"><a href="#-2406"><span class="linenos">2406</span></a>                <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="n">FloatToNano</span><span class="p">(</span><span class="n">targetPrice</span><span class="p">),</span>
</span><span id="TinkoffBrokerServer.Order-2407"><a href="#-2407"><span class="linenos">2407</span></a>                <span class="s2">&quot;direction&quot;</span><span class="p">:</span> <span class="s2">&quot;ORDER_DIRECTION_BUY&quot;</span> <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;Buy&quot;</span> <span class="k">else</span> <span class="s2">&quot;ORDER_DIRECTION_SELL&quot;</span><span class="p">,</span>  <span class="c1"># see: TKS_ORDER_DIRECTIONS</span>
</span><span id="TinkoffBrokerServer.Order-2408"><a href="#-2408"><span class="linenos">2408</span></a>                <span class="s2">&quot;accountId&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">accountId</span><span class="p">),</span>
</span><span id="TinkoffBrokerServer.Order-2409"><a href="#-2409"><span class="linenos">2409</span></a>                <span class="s2">&quot;orderType&quot;</span><span class="p">:</span> <span class="s2">&quot;ORDER_TYPE_LIMIT&quot;</span><span class="p">,</span>  <span class="c1"># see: TKS_ORDER_TYPES</span>
</span><span id="TinkoffBrokerServer.Order-2410"><a href="#-2410"><span class="linenos">2410</span></a>            <span class="p">})</span>
</span><span id="TinkoffBrokerServer.Order-2411"><a href="#-2411"><span class="linenos">2411</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SendAPIRequest</span><span class="p">(</span><span class="n">openOrderURL</span><span class="p">,</span> <span class="n">reqType</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="n">retry</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Order-2412"><a href="#-2412"><span class="linenos">2412</span></a>
</span><span id="TinkoffBrokerServer.Order-2413"><a href="#-2413"><span class="linenos">2413</span></a>            <span class="k">if</span> <span class="s2">&quot;orderId&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.Order-2414"><a href="#-2414"><span class="linenos">2414</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.Order-2415"><a href="#-2415"><span class="linenos">2415</span></a>                    <span class="s2">&quot;Limit-order [</span><span class="si">{}</span><span class="s2">] was created: ticker [</span><span class="si">{}</span><span class="s2">], FIGI [</span><span class="si">{}</span><span class="s2">], action [</span><span class="si">{}</span><span class="s2">], lots [</span><span class="si">{}</span><span class="s2">], target price [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.Order-2416"><a href="#-2416"><span class="linenos">2416</span></a>                        <span class="n">response</span><span class="p">[</span><span class="s2">&quot;orderId&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Order-2417"><a href="#-2417"><span class="linenos">2417</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Order-2418"><a href="#-2418"><span class="linenos">2418</span></a>                        <span class="n">operation</span><span class="p">,</span> <span class="n">lots</span><span class="p">,</span> <span class="n">targetPrice</span><span class="p">,</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Order-2419"><a href="#-2419"><span class="linenos">2419</span></a>                    <span class="p">))</span>
</span><span id="TinkoffBrokerServer.Order-2420"><a href="#-2420"><span class="linenos">2420</span></a>
</span><span id="TinkoffBrokerServer.Order-2421"><a href="#-2421"><span class="linenos">2421</span></a>                <span class="k">if</span> <span class="s2">&quot;lastPrice&quot;</span> <span class="ow">in</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.Order-2422"><a href="#-2422"><span class="linenos">2422</span></a>                    <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;Buy&quot;</span> <span class="ow">and</span> <span class="n">targetPrice</span> <span class="o">&gt;</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.Order-2423"><a href="#-2423"><span class="linenos">2423</span></a>                        <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Your order was executed as a market order, not as a limit order! Comment: because your target price [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">] was higher than current price [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">] broker immediately opened `Buy` market order, such as if you did simple `--buy` operation.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.Order-2424"><a href="#-2424"><span class="linenos">2424</span></a>                            <span class="n">targetPrice</span><span class="p">,</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Order-2425"><a href="#-2425"><span class="linenos">2425</span></a>                            <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">],</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Order-2426"><a href="#-2426"><span class="linenos">2426</span></a>                        <span class="p">))</span>
</span><span id="TinkoffBrokerServer.Order-2427"><a href="#-2427"><span class="linenos">2427</span></a>
</span><span id="TinkoffBrokerServer.Order-2428"><a href="#-2428"><span class="linenos">2428</span></a>                    <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;Sell&quot;</span> <span class="ow">and</span> <span class="n">targetPrice</span> <span class="o">&lt;</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.Order-2429"><a href="#-2429"><span class="linenos">2429</span></a>                        <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Your order was executed as a market order, not as a limit order! Comment: because your target price [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">] was lower than current price [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">] broker immediately opened `Sell` market order, such as if you did simple `--sell` operation.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.Order-2430"><a href="#-2430"><span class="linenos">2430</span></a>                            <span class="n">targetPrice</span><span class="p">,</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Order-2431"><a href="#-2431"><span class="linenos">2431</span></a>                            <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">],</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Order-2432"><a href="#-2432"><span class="linenos">2432</span></a>                        <span class="p">))</span>
</span><span id="TinkoffBrokerServer.Order-2433"><a href="#-2433"><span class="linenos">2433</span></a>
</span><span id="TinkoffBrokerServer.Order-2434"><a href="#-2434"><span class="linenos">2434</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Order-2435"><a href="#-2435"><span class="linenos">2435</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Not `oK` status received! Limit order not opened. See full debug log or try again and open order later.&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Order-2436"><a href="#-2436"><span class="linenos">2436</span></a>
</span><span id="TinkoffBrokerServer.Order-2437"><a href="#-2437"><span class="linenos">2437</span></a>        <span class="k">if</span> <span class="n">orderType</span> <span class="o">==</span> <span class="s2">&quot;Stop&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Order-2438"><a href="#-2438"><span class="linenos">2438</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.Order-2439"><a href="#-2439"><span class="linenos">2439</span></a>                <span class="s2">&quot;Creating stop-order: ticker [</span><span class="si">{}</span><span class="s2">], FIGI [</span><span class="si">{}</span><span class="s2">], action [</span><span class="si">{}</span><span class="s2">], lots [</span><span class="si">{}</span><span class="s2">], target price [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">], limit price [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">], stop-order type [</span><span class="si">{}</span><span class="s2">] and local expiration date [</span><span class="si">{}</span><span class="s2">]. Wait, please...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.Order-2440"><a href="#-2440"><span class="linenos">2440</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Order-2441"><a href="#-2441"><span class="linenos">2441</span></a>                    <span class="n">operation</span><span class="p">,</span> <span class="n">lots</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Order-2442"><a href="#-2442"><span class="linenos">2442</span></a>                    <span class="n">targetPrice</span><span class="p">,</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Order-2443"><a href="#-2443"><span class="linenos">2443</span></a>                    <span class="n">limitPrice</span><span class="p">,</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Order-2444"><a href="#-2444"><span class="linenos">2444</span></a>                    <span class="n">stopType</span><span class="p">,</span> <span class="n">expDate</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Order-2445"><a href="#-2445"><span class="linenos">2445</span></a>                <span class="p">))</span>
</span><span id="TinkoffBrokerServer.Order-2446"><a href="#-2446"><span class="linenos">2446</span></a>
</span><span id="TinkoffBrokerServer.Order-2447"><a href="#-2447"><span class="linenos">2447</span></a>            <span class="n">openOrderURL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;/tinkoff.public.invest.api.contract.v1.StopOrdersService/PostStopOrder&quot;</span>
</span><span id="TinkoffBrokerServer.Order-2448"><a href="#-2448"><span class="linenos">2448</span></a>            <span class="n">expDateUTC</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">expDate</span> <span class="o">==</span> <span class="s2">&quot;Undefined&quot;</span> <span class="k">else</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">expDate</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">tzlocal</span><span class="p">())</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">tzutc</span><span class="p">())</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S.</span><span class="si">%f</span><span class="s2">Z&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Order-2449"><a href="#-2449"><span class="linenos">2449</span></a>            <span class="n">stopOrderType</span> <span class="o">=</span> <span class="s2">&quot;STOP_ORDER_TYPE_STOP_LOSS&quot;</span> <span class="k">if</span> <span class="n">stopType</span> <span class="o">==</span> <span class="s2">&quot;SL&quot;</span> <span class="k">else</span> <span class="s2">&quot;STOP_ORDER_TYPE_TAKE_PROFIT&quot;</span> <span class="k">if</span> <span class="n">stopType</span> <span class="o">==</span> <span class="s2">&quot;TP&quot;</span> <span class="k">else</span> <span class="s2">&quot;STOP_ORDER_TYPE_STOP_LIMIT&quot;</span>
</span><span id="TinkoffBrokerServer.Order-2450"><a href="#-2450"><span class="linenos">2450</span></a>
</span><span id="TinkoffBrokerServer.Order-2451"><a href="#-2451"><span class="linenos">2451</span></a>            <span class="n">body</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="TinkoffBrokerServer.Order-2452"><a href="#-2452"><span class="linenos">2452</span></a>                <span class="s2">&quot;figi&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Order-2453"><a href="#-2453"><span class="linenos">2453</span></a>                <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">lots</span><span class="p">),</span>
</span><span id="TinkoffBrokerServer.Order-2454"><a href="#-2454"><span class="linenos">2454</span></a>                <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="n">FloatToNano</span><span class="p">(</span><span class="n">limitPrice</span><span class="p">),</span>
</span><span id="TinkoffBrokerServer.Order-2455"><a href="#-2455"><span class="linenos">2455</span></a>                <span class="s2">&quot;stopPrice&quot;</span><span class="p">:</span> <span class="n">FloatToNano</span><span class="p">(</span><span class="n">targetPrice</span><span class="p">),</span>
</span><span id="TinkoffBrokerServer.Order-2456"><a href="#-2456"><span class="linenos">2456</span></a>                <span class="s2">&quot;direction&quot;</span><span class="p">:</span> <span class="s2">&quot;STOP_ORDER_DIRECTION_BUY&quot;</span> <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;Buy&quot;</span> <span class="k">else</span> <span class="s2">&quot;STOP_ORDER_DIRECTION_SELL&quot;</span><span class="p">,</span>  <span class="c1"># see: TKS_STOP_ORDER_DIRECTIONS</span>
</span><span id="TinkoffBrokerServer.Order-2457"><a href="#-2457"><span class="linenos">2457</span></a>                <span class="s2">&quot;accountId&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">accountId</span><span class="p">),</span>
</span><span id="TinkoffBrokerServer.Order-2458"><a href="#-2458"><span class="linenos">2458</span></a>                <span class="s2">&quot;expirationType&quot;</span><span class="p">:</span> <span class="s2">&quot;STOP_ORDER_EXPIRATION_TYPE_GOOD_TILL_DATE&quot;</span> <span class="k">if</span> <span class="n">expDateUTC</span> <span class="k">else</span> <span class="s2">&quot;STOP_ORDER_EXPIRATION_TYPE_GOOD_TILL_CANCEL&quot;</span><span class="p">,</span>  <span class="c1"># see: TKS_STOP_ORDER_EXPIRATION_TYPES</span>
</span><span id="TinkoffBrokerServer.Order-2459"><a href="#-2459"><span class="linenos">2459</span></a>                <span class="s2">&quot;stopOrderType&quot;</span><span class="p">:</span> <span class="n">stopOrderType</span><span class="p">,</span>  <span class="c1"># see: TKS_STOP_ORDER_TYPES</span>
</span><span id="TinkoffBrokerServer.Order-2460"><a href="#-2460"><span class="linenos">2460</span></a>            <span class="p">}</span>
</span><span id="TinkoffBrokerServer.Order-2461"><a href="#-2461"><span class="linenos">2461</span></a>
</span><span id="TinkoffBrokerServer.Order-2462"><a href="#-2462"><span class="linenos">2462</span></a>            <span class="k">if</span> <span class="n">expDateUTC</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Order-2463"><a href="#-2463"><span class="linenos">2463</span></a>                <span class="n">body</span><span class="p">[</span><span class="s2">&quot;expireDate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">expDateUTC</span>
</span><span id="TinkoffBrokerServer.Order-2464"><a href="#-2464"><span class="linenos">2464</span></a>
</span><span id="TinkoffBrokerServer.Order-2465"><a href="#-2465"><span class="linenos">2465</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Order-2466"><a href="#-2466"><span class="linenos">2466</span></a>            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SendAPIRequest</span><span class="p">(</span><span class="n">openOrderURL</span><span class="p">,</span> <span class="n">reqType</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="n">retry</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Order-2467"><a href="#-2467"><span class="linenos">2467</span></a>
</span><span id="TinkoffBrokerServer.Order-2468"><a href="#-2468"><span class="linenos">2468</span></a>            <span class="k">if</span> <span class="s2">&quot;stopOrderId&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="TinkoffBrokerServer.Order-2469"><a href="#-2469"><span class="linenos">2469</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.Order-2470"><a href="#-2470"><span class="linenos">2470</span></a>                    <span class="s2">&quot;Stop-order [</span><span class="si">{}</span><span class="s2">] was created: ticker [</span><span class="si">{}</span><span class="s2">], FIGI [</span><span class="si">{}</span><span class="s2">], action [</span><span class="si">{}</span><span class="s2">], lots [</span><span class="si">{}</span><span class="s2">], target price [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">], limit price [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">], stop-order type [</span><span class="si">{}</span><span class="s2">] and expiration date in UTC [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.Order-2471"><a href="#-2471"><span class="linenos">2471</span></a>                    <span class="n">response</span><span class="p">[</span><span class="s2">&quot;stopOrderId&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Order-2472"><a href="#-2472"><span class="linenos">2472</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">ticker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">figi</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Order-2473"><a href="#-2473"><span class="linenos">2473</span></a>                    <span class="n">operation</span><span class="p">,</span> <span class="n">lots</span><span class="p">,</span>
</span><span id="TinkoffBrokerServer.Order-2474"><a href="#-2474"><span class="linenos">2474</span></a>                    <span class="n">targetPrice</span><span class="p">,</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Order-2475"><a href="#-2475"><span class="linenos">2475</span></a>                    <span class="n">limitPrice</span><span class="p">,</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Order-2476"><a href="#-2476"><span class="linenos">2476</span></a>                    <span class="n">TKS_STOP_ORDER_TYPES</span><span class="p">[</span><span class="n">stopOrderType</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Order-2477"><a href="#-2477"><span class="linenos">2477</span></a>                    <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">expDateUTC</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S.</span><span class="si">%f</span><span class="s2">Z&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">tzutc</span><span class="p">())</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">tzutc</span><span class="p">())</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">expDateUTC</span> <span class="k">else</span> <span class="n">TKS_STOP_ORDER_EXPIRATION_TYPES</span><span class="p">[</span><span class="s2">&quot;STOP_ORDER_EXPIRATION_TYPE_UNSPECIFIED&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Order-2478"><a href="#-2478"><span class="linenos">2478</span></a>                <span class="p">))</span>
</span><span id="TinkoffBrokerServer.Order-2479"><a href="#-2479"><span class="linenos">2479</span></a>
</span><span id="TinkoffBrokerServer.Order-2480"><a href="#-2480"><span class="linenos">2480</span></a>                <span class="k">if</span> <span class="s2">&quot;lastPrice&quot;</span> <span class="ow">in</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.Order-2481"><a href="#-2481"><span class="linenos">2481</span></a>                    <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;Buy&quot;</span> <span class="ow">and</span> <span class="n">targetPrice</span> <span class="o">&lt;</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">stopType</span> <span class="o">!=</span> <span class="s2">&quot;TP&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Order-2482"><a href="#-2482"><span class="linenos">2482</span></a>                        <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;The broker will cancel this order after some time. Comment: you placed the wrong stop order because the target buy price [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">] is lower than the current price [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">]. Also try to set up order type as `TP` if you want to place stop order at that price.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.Order-2483"><a href="#-2483"><span class="linenos">2483</span></a>                            <span class="n">targetPrice</span><span class="p">,</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Order-2484"><a href="#-2484"><span class="linenos">2484</span></a>                            <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">],</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Order-2485"><a href="#-2485"><span class="linenos">2485</span></a>                        <span class="p">))</span>
</span><span id="TinkoffBrokerServer.Order-2486"><a href="#-2486"><span class="linenos">2486</span></a>
</span><span id="TinkoffBrokerServer.Order-2487"><a href="#-2487"><span class="linenos">2487</span></a>                    <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;Sell&quot;</span> <span class="ow">and</span> <span class="n">targetPrice</span> <span class="o">&gt;</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">stopType</span> <span class="o">!=</span> <span class="s2">&quot;TP&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Order-2488"><a href="#-2488"><span class="linenos">2488</span></a>                        <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;The broker will cancel this order after some time. Comment: you placed the wrong stop order because the target sell price [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">] is higher than the current price [</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">]. Also try to set up order type as `TP` if you want to place stop order at that price.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="TinkoffBrokerServer.Order-2489"><a href="#-2489"><span class="linenos">2489</span></a>                            <span class="n">targetPrice</span><span class="p">,</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Order-2490"><a href="#-2490"><span class="linenos">2490</span></a>                            <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currentPrice&quot;</span><span class="p">][</span><span class="s2">&quot;lastPrice&quot;</span><span class="p">],</span> <span class="n">instrument</span><span class="p">[</span><span class="s2">&quot;currency&quot;</span><span class="p">],</span>
</span><span id="TinkoffBrokerServer.Order-2491"><a href="#-2491"><span class="linenos">2491</span></a>                        <span class="p">))</span>
</span><span id="TinkoffBrokerServer.Order-2492"><a href="#-2492"><span class="linenos">2492</span></a>
</span><span id="TinkoffBrokerServer.Order-2493"><a href="#-2493"><span class="linenos">2493</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.Order-2494"><a href="#-2494"><span class="linenos">2494</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Not `oK` status received! Stop order not opened. See full debug log or try again and open order later.&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.Order-2495"><a href="#-2495"><span class="linenos">2495</span></a>
</span><span id="TinkoffBrokerServer.Order-2496"><a href="#-2496"><span class="linenos">2496</span></a>        <span class="k">return</span> <span class="n">response</span>
</span></pre></div>


            <div class="docstring"><p>Universal method to create market or limit orders with all available parameters.
See more simple methods: <code><a href="#TinkoffBrokerServer.BuyLimit">BuyLimit()</a></code>, <code><a href="#TinkoffBrokerServer.BuyStop">BuyStop()</a></code>, <code><a href="#TinkoffBrokerServer.SellLimit">SellLimit()</a></code>, <code><a href="#TinkoffBrokerServer.SellStop">SellStop()</a></code>.</p>

<p>If orderType is "Limit" then create pending limit-order below current price if operation is "Buy" and above
current price if operation is "Sell". A limit order has no expiration date, it lasts until the end of the trading day.</p>

<p>Warning! If you try to create limit-order above current price if "Buy" or below current price if "Sell"
then broker immediately open market order as you can do simple --buy or --sell operations!</p>

<p>If orderType is "Stop" then creates stop-order with any direction "Buy" or "Sell".
When current price will go up or down to target price value then broker opens a limit order.
Stop-order is opened with unlimited expiration date by default, or you can define expiration date with expDate parameter.</p>

<p>Only one attempt and no retry for opens order. If network issue occurred you can create new request.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>operation</strong>:  string "Buy" or "Sell".</li>
<li><strong>orderType</strong>:  string "Limit" or "Stop".</li>
<li><strong>lots</strong>:  volume, integer count of lots &gt;= 1.</li>
<li><strong>targetPrice</strong>:  target price &gt; 0. This is open trade price for limit order.</li>
<li><strong>limitPrice</strong>:  limit price &gt;= 0. This parameter only makes sense for stop-order. If limitPrice = 0, then it set as targetPrice.
               Broker will creates limit-order with price equal to limitPrice, when current price goes to target price of stop-order.</li>
<li><strong>stopType</strong>:  string "Limit" by default. This parameter only makes sense for stop-order. There are 3 stop-order types
             "SL", "TP", "Limit" for "Stop loss", "Take profit" and "Stop limit" types accordingly.
             Stop loss order always executed by market price.</li>
<li><strong>expDate</strong>:  string "Undefined" by default or local date in future.
            String has a format like this: <code>%Y-%m-%d %H:%M:%S</code>.
            This date is converting to UTC format for server. This parameter only makes sense for stop-order.
            A limit order has no expiration date, it lasts until the end of the trading day.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>JSON with response from broker server.</p>
</blockquote>
</div>


                            </div>
                            <div id="TinkoffBrokerServer.BuyLimit" class="classattr">
                                        <input id="TinkoffBrokerServer.BuyLimit-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">BuyLimit</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">lots</span><span class="p">:</span> <span class="nb">int</span>, </span><span class="param"><span class="n">targetPrice</span><span class="p">:</span> <span class="nb">float</span></span><span class="return-annotation">) -> <span class="nb">dict</span>:</span></span>

                <label class="view-source-button" for="TinkoffBrokerServer.BuyLimit-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.BuyLimit"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TinkoffBrokerServer.BuyLimit-2498"><a href="#-2498"><span class="linenos">2498</span></a>    <span class="k">def</span> <span class="nf">BuyLimit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lots</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">targetPrice</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.BuyLimit-2499"><a href="#-2499"><span class="linenos">2499</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.BuyLimit-2500"><a href="#-2500"><span class="linenos">2500</span></a><span class="sd">        Create pending `Buy` limit-order (below current price). You must specify only 2 parameters:</span>
</span><span id="TinkoffBrokerServer.BuyLimit-2501"><a href="#-2501"><span class="linenos">2501</span></a><span class="sd">        `lots` and `target price` to open buy limit-order. If you try to create buy limit-order above current price then</span>
</span><span id="TinkoffBrokerServer.BuyLimit-2502"><a href="#-2502"><span class="linenos">2502</span></a><span class="sd">        broker immediately open `Buy` market order, such as if you do simple `--buy` operation!</span>
</span><span id="TinkoffBrokerServer.BuyLimit-2503"><a href="#-2503"><span class="linenos">2503</span></a><span class="sd">        See also: `Order()` docstring.</span>
</span><span id="TinkoffBrokerServer.BuyLimit-2504"><a href="#-2504"><span class="linenos">2504</span></a>
</span><span id="TinkoffBrokerServer.BuyLimit-2505"><a href="#-2505"><span class="linenos">2505</span></a><span class="sd">        :param lots: volume, integer count of lots &gt;= 1.</span>
</span><span id="TinkoffBrokerServer.BuyLimit-2506"><a href="#-2506"><span class="linenos">2506</span></a><span class="sd">        :param targetPrice: target price &gt; 0. This is open trade price for limit order.</span>
</span><span id="TinkoffBrokerServer.BuyLimit-2507"><a href="#-2507"><span class="linenos">2507</span></a><span class="sd">        :return: JSON with response from broker server.</span>
</span><span id="TinkoffBrokerServer.BuyLimit-2508"><a href="#-2508"><span class="linenos">2508</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.BuyLimit-2509"><a href="#-2509"><span class="linenos">2509</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Order</span><span class="p">(</span><span class="n">operation</span><span class="o">=</span><span class="s2">&quot;Buy&quot;</span><span class="p">,</span> <span class="n">orderType</span><span class="o">=</span><span class="s2">&quot;Limit&quot;</span><span class="p">,</span> <span class="n">lots</span><span class="o">=</span><span class="n">lots</span><span class="p">,</span> <span class="n">targetPrice</span><span class="o">=</span><span class="n">targetPrice</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Create pending <code><a href="#TinkoffBrokerServer.Buy">Buy</a></code> limit-order (below current price). You must specify only 2 parameters:
<code>lots</code> and <code>target price</code> to open buy limit-order. If you try to create buy limit-order above current price then
broker immediately open <code><a href="#TinkoffBrokerServer.Buy">Buy</a></code> market order, such as if you do simple <code>--buy</code> operation!
See also: <code><a href="#TinkoffBrokerServer.Order">Order()</a></code> docstring.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>lots</strong>:  volume, integer count of lots &gt;= 1.</li>
<li><strong>targetPrice</strong>:  target price &gt; 0. This is open trade price for limit order.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>JSON with response from broker server.</p>
</blockquote>
</div>


                            </div>
                            <div id="TinkoffBrokerServer.BuyStop" class="classattr">
                                        <input id="TinkoffBrokerServer.BuyStop-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">BuyStop</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">lots</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">targetPrice</span><span class="p">:</span> <span class="nb">float</span>,</span><span class="param">	<span class="n">limitPrice</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>,</span><span class="param">	<span class="n">stopType</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Limit&#39;</span>,</span><span class="param">	<span class="n">expDate</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Undefined&#39;</span></span><span class="return-annotation">) -> <span class="nb">dict</span>:</span></span>

                <label class="view-source-button" for="TinkoffBrokerServer.BuyStop-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.BuyStop"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TinkoffBrokerServer.BuyStop-2511"><a href="#-2511"><span class="linenos">2511</span></a>    <span class="k">def</span> <span class="nf">BuyStop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lots</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">targetPrice</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">limitPrice</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">stopType</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Limit&quot;</span><span class="p">,</span> <span class="n">expDate</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Undefined&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.BuyStop-2512"><a href="#-2512"><span class="linenos">2512</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.BuyStop-2513"><a href="#-2513"><span class="linenos">2513</span></a><span class="sd">        Create `Buy` stop-order. You must specify at least 2 parameters: `lots` `target price` to open buy stop-order.</span>
</span><span id="TinkoffBrokerServer.BuyStop-2514"><a href="#-2514"><span class="linenos">2514</span></a><span class="sd">        In additional you can specify 3 parameters for buy stop-order: `limit price` &gt;=0, `stop type` = Limit|SL|TP,</span>
</span><span id="TinkoffBrokerServer.BuyStop-2515"><a href="#-2515"><span class="linenos">2515</span></a><span class="sd">        `expiration date` = Undefined|`%%Y-%%m-%%d %%H:%%M:%%S`. When current price will go up or down to</span>
</span><span id="TinkoffBrokerServer.BuyStop-2516"><a href="#-2516"><span class="linenos">2516</span></a><span class="sd">        target price value then broker opens a limit order. See also: `Order()` docstring.</span>
</span><span id="TinkoffBrokerServer.BuyStop-2517"><a href="#-2517"><span class="linenos">2517</span></a>
</span><span id="TinkoffBrokerServer.BuyStop-2518"><a href="#-2518"><span class="linenos">2518</span></a><span class="sd">        :param lots: volume, integer count of lots &gt;= 1.</span>
</span><span id="TinkoffBrokerServer.BuyStop-2519"><a href="#-2519"><span class="linenos">2519</span></a><span class="sd">        :param targetPrice: target price &gt; 0. This is trigger price for buy stop-order.</span>
</span><span id="TinkoffBrokerServer.BuyStop-2520"><a href="#-2520"><span class="linenos">2520</span></a><span class="sd">        :param limitPrice: limit price &gt;= 0 (limitPrice = targetPrice if limitPrice is 0). Broker will creates limit-order</span>
</span><span id="TinkoffBrokerServer.BuyStop-2521"><a href="#-2521"><span class="linenos">2521</span></a><span class="sd">                           with price equal to limitPrice, when current price goes to target price of buy stop-order.</span>
</span><span id="TinkoffBrokerServer.BuyStop-2522"><a href="#-2522"><span class="linenos">2522</span></a><span class="sd">        :param stopType: string &quot;Limit&quot; by default. There are 3 stop-order types &quot;SL&quot;, &quot;TP&quot;, &quot;Limit&quot;</span>
</span><span id="TinkoffBrokerServer.BuyStop-2523"><a href="#-2523"><span class="linenos">2523</span></a><span class="sd">                         for &quot;Stop loss&quot;, &quot;Take profit&quot; and &quot;Stop limit&quot; types accordingly.</span>
</span><span id="TinkoffBrokerServer.BuyStop-2524"><a href="#-2524"><span class="linenos">2524</span></a><span class="sd">        :param expDate: string &quot;Undefined&quot; by default or local date in future.</span>
</span><span id="TinkoffBrokerServer.BuyStop-2525"><a href="#-2525"><span class="linenos">2525</span></a><span class="sd">                        String has a format like this: `%Y-%m-%d %H:%M:%S`.</span>
</span><span id="TinkoffBrokerServer.BuyStop-2526"><a href="#-2526"><span class="linenos">2526</span></a><span class="sd">                        This date is converting to UTC format for server.</span>
</span><span id="TinkoffBrokerServer.BuyStop-2527"><a href="#-2527"><span class="linenos">2527</span></a><span class="sd">        :return: JSON with response from broker server.</span>
</span><span id="TinkoffBrokerServer.BuyStop-2528"><a href="#-2528"><span class="linenos">2528</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.BuyStop-2529"><a href="#-2529"><span class="linenos">2529</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Order</span><span class="p">(</span><span class="n">operation</span><span class="o">=</span><span class="s2">&quot;Buy&quot;</span><span class="p">,</span> <span class="n">orderType</span><span class="o">=</span><span class="s2">&quot;Stop&quot;</span><span class="p">,</span> <span class="n">lots</span><span class="o">=</span><span class="n">lots</span><span class="p">,</span> <span class="n">targetPrice</span><span class="o">=</span><span class="n">targetPrice</span><span class="p">,</span> <span class="n">limitPrice</span><span class="o">=</span><span class="n">limitPrice</span><span class="p">,</span> <span class="n">stopType</span><span class="o">=</span><span class="n">stopType</span><span class="p">,</span> <span class="n">expDate</span><span class="o">=</span><span class="n">expDate</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Create <code><a href="#TinkoffBrokerServer.Buy">Buy</a></code> stop-order. You must specify at least 2 parameters: <code>lots</code> <code>target price</code> to open buy stop-order.
In additional you can specify 3 parameters for buy stop-order: <code>limit price</code> &gt;=0, <code>stop type</code> = Limit|SL|TP,
<code>expiration date</code> = Undefined|<code>%%Y-%%m-%%d %%H:%%M:%%S</code>. When current price will go up or down to
target price value then broker opens a limit order. See also: <code><a href="#TinkoffBrokerServer.Order">Order()</a></code> docstring.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>lots</strong>:  volume, integer count of lots &gt;= 1.</li>
<li><strong>targetPrice</strong>:  target price &gt; 0. This is trigger price for buy stop-order.</li>
<li><strong>limitPrice</strong>:  limit price &gt;= 0 (limitPrice = targetPrice if limitPrice is 0). Broker will creates limit-order
               with price equal to limitPrice, when current price goes to target price of buy stop-order.</li>
<li><strong>stopType</strong>:  string "Limit" by default. There are 3 stop-order types "SL", "TP", "Limit"
             for "Stop loss", "Take profit" and "Stop limit" types accordingly.</li>
<li><strong>expDate</strong>:  string "Undefined" by default or local date in future.
            String has a format like this: <code>%Y-%m-%d %H:%M:%S</code>.
            This date is converting to UTC format for server.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>JSON with response from broker server.</p>
</blockquote>
</div>


                            </div>
                            <div id="TinkoffBrokerServer.SellLimit" class="classattr">
                                        <input id="TinkoffBrokerServer.SellLimit-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">SellLimit</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">lots</span><span class="p">:</span> <span class="nb">int</span>, </span><span class="param"><span class="n">targetPrice</span><span class="p">:</span> <span class="nb">float</span></span><span class="return-annotation">) -> <span class="nb">dict</span>:</span></span>

                <label class="view-source-button" for="TinkoffBrokerServer.SellLimit-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.SellLimit"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TinkoffBrokerServer.SellLimit-2531"><a href="#-2531"><span class="linenos">2531</span></a>    <span class="k">def</span> <span class="nf">SellLimit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lots</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">targetPrice</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SellLimit-2532"><a href="#-2532"><span class="linenos">2532</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.SellLimit-2533"><a href="#-2533"><span class="linenos">2533</span></a><span class="sd">        Create pending `Sell` limit-order (above current price). You must specify only 2 parameters:</span>
</span><span id="TinkoffBrokerServer.SellLimit-2534"><a href="#-2534"><span class="linenos">2534</span></a><span class="sd">        `lots` and `target price` to open sell limit-order. If you try to create sell limit-order below current price then</span>
</span><span id="TinkoffBrokerServer.SellLimit-2535"><a href="#-2535"><span class="linenos">2535</span></a><span class="sd">        broker immediately open `Sell` market order, such as if you do simple `--sell` operation!</span>
</span><span id="TinkoffBrokerServer.SellLimit-2536"><a href="#-2536"><span class="linenos">2536</span></a><span class="sd">        See also: `Order()` docstring.</span>
</span><span id="TinkoffBrokerServer.SellLimit-2537"><a href="#-2537"><span class="linenos">2537</span></a>
</span><span id="TinkoffBrokerServer.SellLimit-2538"><a href="#-2538"><span class="linenos">2538</span></a><span class="sd">        :param lots: volume, integer count of lots &gt;= 1.</span>
</span><span id="TinkoffBrokerServer.SellLimit-2539"><a href="#-2539"><span class="linenos">2539</span></a><span class="sd">        :param targetPrice: target price &gt; 0. This is open trade price for limit order.</span>
</span><span id="TinkoffBrokerServer.SellLimit-2540"><a href="#-2540"><span class="linenos">2540</span></a><span class="sd">        :return: JSON with response from broker server.</span>
</span><span id="TinkoffBrokerServer.SellLimit-2541"><a href="#-2541"><span class="linenos">2541</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.SellLimit-2542"><a href="#-2542"><span class="linenos">2542</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Order</span><span class="p">(</span><span class="n">operation</span><span class="o">=</span><span class="s2">&quot;Sell&quot;</span><span class="p">,</span> <span class="n">orderType</span><span class="o">=</span><span class="s2">&quot;Limit&quot;</span><span class="p">,</span> <span class="n">lots</span><span class="o">=</span><span class="n">lots</span><span class="p">,</span> <span class="n">targetPrice</span><span class="o">=</span><span class="n">targetPrice</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Create pending <code><a href="#TinkoffBrokerServer.Sell">Sell</a></code> limit-order (above current price). You must specify only 2 parameters:
<code>lots</code> and <code>target price</code> to open sell limit-order. If you try to create sell limit-order below current price then
broker immediately open <code><a href="#TinkoffBrokerServer.Sell">Sell</a></code> market order, such as if you do simple <code>--sell</code> operation!
See also: <code><a href="#TinkoffBrokerServer.Order">Order()</a></code> docstring.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>lots</strong>:  volume, integer count of lots &gt;= 1.</li>
<li><strong>targetPrice</strong>:  target price &gt; 0. This is open trade price for limit order.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>JSON with response from broker server.</p>
</blockquote>
</div>


                            </div>
                            <div id="TinkoffBrokerServer.SellStop" class="classattr">
                                        <input id="TinkoffBrokerServer.SellStop-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">SellStop</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">lots</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">targetPrice</span><span class="p">:</span> <span class="nb">float</span>,</span><span class="param">	<span class="n">limitPrice</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>,</span><span class="param">	<span class="n">stopType</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Limit&#39;</span>,</span><span class="param">	<span class="n">expDate</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Undefined&#39;</span></span><span class="return-annotation">) -> <span class="nb">dict</span>:</span></span>

                <label class="view-source-button" for="TinkoffBrokerServer.SellStop-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.SellStop"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TinkoffBrokerServer.SellStop-2544"><a href="#-2544"><span class="linenos">2544</span></a>    <span class="k">def</span> <span class="nf">SellStop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lots</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">targetPrice</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">limitPrice</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">stopType</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Limit&quot;</span><span class="p">,</span> <span class="n">expDate</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Undefined&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.SellStop-2545"><a href="#-2545"><span class="linenos">2545</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.SellStop-2546"><a href="#-2546"><span class="linenos">2546</span></a><span class="sd">        Create `Sell` stop-order. You must specify at least 2 parameters: `lots` `target price` to open sell stop-order.</span>
</span><span id="TinkoffBrokerServer.SellStop-2547"><a href="#-2547"><span class="linenos">2547</span></a><span class="sd">        In additional you can specify 3 parameters for sell stop-order: `limit price` &gt;=0, `stop type` = Limit|SL|TP,</span>
</span><span id="TinkoffBrokerServer.SellStop-2548"><a href="#-2548"><span class="linenos">2548</span></a><span class="sd">        `expiration date` = Undefined|`%%Y-%%m-%%d %%H:%%M:%%S`. When current price will go up or down to</span>
</span><span id="TinkoffBrokerServer.SellStop-2549"><a href="#-2549"><span class="linenos">2549</span></a><span class="sd">        target price value then broker opens a limit order. See also: `Order()` docstring.</span>
</span><span id="TinkoffBrokerServer.SellStop-2550"><a href="#-2550"><span class="linenos">2550</span></a>
</span><span id="TinkoffBrokerServer.SellStop-2551"><a href="#-2551"><span class="linenos">2551</span></a><span class="sd">        :param lots: volume, integer count of lots &gt;= 1.</span>
</span><span id="TinkoffBrokerServer.SellStop-2552"><a href="#-2552"><span class="linenos">2552</span></a><span class="sd">        :param targetPrice: target price &gt; 0. This is trigger price for sell stop-order.</span>
</span><span id="TinkoffBrokerServer.SellStop-2553"><a href="#-2553"><span class="linenos">2553</span></a><span class="sd">        :param limitPrice: limit price &gt;= 0 (limitPrice = targetPrice if limitPrice is 0). Broker will creates limit-order</span>
</span><span id="TinkoffBrokerServer.SellStop-2554"><a href="#-2554"><span class="linenos">2554</span></a><span class="sd">                           with price equal to limitPrice, when current price goes to target price of sell stop-order.</span>
</span><span id="TinkoffBrokerServer.SellStop-2555"><a href="#-2555"><span class="linenos">2555</span></a><span class="sd">        :param stopType: string &quot;Limit&quot; by default. There are 3 stop-order types &quot;SL&quot;, &quot;TP&quot;, &quot;Limit&quot;</span>
</span><span id="TinkoffBrokerServer.SellStop-2556"><a href="#-2556"><span class="linenos">2556</span></a><span class="sd">                         for &quot;Stop loss&quot;, &quot;Take profit&quot; and &quot;Stop limit&quot; types accordingly.</span>
</span><span id="TinkoffBrokerServer.SellStop-2557"><a href="#-2557"><span class="linenos">2557</span></a><span class="sd">        :param expDate: string &quot;Undefined&quot; by default or local date in future.</span>
</span><span id="TinkoffBrokerServer.SellStop-2558"><a href="#-2558"><span class="linenos">2558</span></a><span class="sd">                        String has a format like this: `%Y-%m-%d %H:%M:%S`.</span>
</span><span id="TinkoffBrokerServer.SellStop-2559"><a href="#-2559"><span class="linenos">2559</span></a><span class="sd">                        This date is converting to UTC format for server.</span>
</span><span id="TinkoffBrokerServer.SellStop-2560"><a href="#-2560"><span class="linenos">2560</span></a><span class="sd">        :return: JSON with response from broker server.</span>
</span><span id="TinkoffBrokerServer.SellStop-2561"><a href="#-2561"><span class="linenos">2561</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.SellStop-2562"><a href="#-2562"><span class="linenos">2562</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Order</span><span class="p">(</span><span class="n">operation</span><span class="o">=</span><span class="s2">&quot;Sell&quot;</span><span class="p">,</span> <span class="n">orderType</span><span class="o">=</span><span class="s2">&quot;Stop&quot;</span><span class="p">,</span> <span class="n">lots</span><span class="o">=</span><span class="n">lots</span><span class="p">,</span> <span class="n">targetPrice</span><span class="o">=</span><span class="n">targetPrice</span><span class="p">,</span> <span class="n">limitPrice</span><span class="o">=</span><span class="n">limitPrice</span><span class="p">,</span> <span class="n">stopType</span><span class="o">=</span><span class="n">stopType</span><span class="p">,</span> <span class="n">expDate</span><span class="o">=</span><span class="n">expDate</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Create <code><a href="#TinkoffBrokerServer.Sell">Sell</a></code> stop-order. You must specify at least 2 parameters: <code>lots</code> <code>target price</code> to open sell stop-order.
In additional you can specify 3 parameters for sell stop-order: <code>limit price</code> &gt;=0, <code>stop type</code> = Limit|SL|TP,
<code>expiration date</code> = Undefined|<code>%%Y-%%m-%%d %%H:%%M:%%S</code>. When current price will go up or down to
target price value then broker opens a limit order. See also: <code><a href="#TinkoffBrokerServer.Order">Order()</a></code> docstring.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>lots</strong>:  volume, integer count of lots &gt;= 1.</li>
<li><strong>targetPrice</strong>:  target price &gt; 0. This is trigger price for sell stop-order.</li>
<li><strong>limitPrice</strong>:  limit price &gt;= 0 (limitPrice = targetPrice if limitPrice is 0). Broker will creates limit-order
               with price equal to limitPrice, when current price goes to target price of sell stop-order.</li>
<li><strong>stopType</strong>:  string "Limit" by default. There are 3 stop-order types "SL", "TP", "Limit"
             for "Stop loss", "Take profit" and "Stop limit" types accordingly.</li>
<li><strong>expDate</strong>:  string "Undefined" by default or local date in future.
            String has a format like this: <code>%Y-%m-%d %H:%M:%S</code>.
            This date is converting to UTC format for server.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>JSON with response from broker server.</p>
</blockquote>
</div>


                            </div>
                            <div id="TinkoffBrokerServer.CloseOrders" class="classattr">
                                        <input id="TinkoffBrokerServer.CloseOrders-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">CloseOrders</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">orderIDs</span><span class="p">:</span> <span class="nb">list</span>,</span><span class="param">	<span class="n">allOrdersIDs</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">allStopOrdersIDs</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="TinkoffBrokerServer.CloseOrders-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.CloseOrders"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TinkoffBrokerServer.CloseOrders-2564"><a href="#-2564"><span class="linenos">2564</span></a>    <span class="k">def</span> <span class="nf">CloseOrders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orderIDs</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">allOrdersIDs</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">allStopOrdersIDs</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.CloseOrders-2565"><a href="#-2565"><span class="linenos">2565</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.CloseOrders-2566"><a href="#-2566"><span class="linenos">2566</span></a><span class="sd">        Cancel order or list of orders by its `orderId` or `stopOrderId`.</span>
</span><span id="TinkoffBrokerServer.CloseOrders-2567"><a href="#-2567"><span class="linenos">2567</span></a>
</span><span id="TinkoffBrokerServer.CloseOrders-2568"><a href="#-2568"><span class="linenos">2568</span></a><span class="sd">        :param orderIDs: list of integers with `orderId` or `stopOrderId`.</span>
</span><span id="TinkoffBrokerServer.CloseOrders-2569"><a href="#-2569"><span class="linenos">2569</span></a><span class="sd">        :param allOrdersIDs: pre-received lists of all active pending orders.</span>
</span><span id="TinkoffBrokerServer.CloseOrders-2570"><a href="#-2570"><span class="linenos">2570</span></a><span class="sd">                             This avoids unnecessary downloading data from the server.</span>
</span><span id="TinkoffBrokerServer.CloseOrders-2571"><a href="#-2571"><span class="linenos">2571</span></a><span class="sd">        :param allStopOrdersIDs: pre-received lists of all active stop orders.</span>
</span><span id="TinkoffBrokerServer.CloseOrders-2572"><a href="#-2572"><span class="linenos">2572</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.CloseOrders-2573"><a href="#-2573"><span class="linenos">2573</span></a>        <span class="k">if</span> <span class="n">orderIDs</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.CloseOrders-2574"><a href="#-2574"><span class="linenos">2574</span></a>            <span class="k">if</span> <span class="n">allOrdersIDs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">allOrdersIDs</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.CloseOrders-2575"><a href="#-2575"><span class="linenos">2575</span></a>                <span class="n">rawOrders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RequestPendingOrders</span><span class="p">()</span>
</span><span id="TinkoffBrokerServer.CloseOrders-2576"><a href="#-2576"><span class="linenos">2576</span></a>                <span class="n">allOrdersIDs</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;orderId&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">rawOrders</span><span class="p">]</span>  <span class="c1"># all pending orders ID</span>
</span><span id="TinkoffBrokerServer.CloseOrders-2577"><a href="#-2577"><span class="linenos">2577</span></a>
</span><span id="TinkoffBrokerServer.CloseOrders-2578"><a href="#-2578"><span class="linenos">2578</span></a>            <span class="k">if</span> <span class="n">allStopOrdersIDs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">allStopOrdersIDs</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.CloseOrders-2579"><a href="#-2579"><span class="linenos">2579</span></a>                <span class="n">rawStopOrders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RequestStopOrders</span><span class="p">()</span>
</span><span id="TinkoffBrokerServer.CloseOrders-2580"><a href="#-2580"><span class="linenos">2580</span></a>                <span class="n">allStopOrdersIDs</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;stopOrderId&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">rawStopOrders</span><span class="p">]</span>  <span class="c1"># all stop orders ID</span>
</span><span id="TinkoffBrokerServer.CloseOrders-2581"><a href="#-2581"><span class="linenos">2581</span></a>
</span><span id="TinkoffBrokerServer.CloseOrders-2582"><a href="#-2582"><span class="linenos">2582</span></a>            <span class="k">for</span> <span class="n">orderID</span> <span class="ow">in</span> <span class="n">orderIDs</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.CloseOrders-2583"><a href="#-2583"><span class="linenos">2583</span></a>                <span class="n">idInPendingOrders</span> <span class="o">=</span> <span class="n">orderID</span> <span class="ow">in</span> <span class="n">allOrdersIDs</span>
</span><span id="TinkoffBrokerServer.CloseOrders-2584"><a href="#-2584"><span class="linenos">2584</span></a>                <span class="n">idInStopOrders</span> <span class="o">=</span> <span class="n">orderID</span> <span class="ow">in</span> <span class="n">allStopOrdersIDs</span>
</span><span id="TinkoffBrokerServer.CloseOrders-2585"><a href="#-2585"><span class="linenos">2585</span></a>
</span><span id="TinkoffBrokerServer.CloseOrders-2586"><a href="#-2586"><span class="linenos">2586</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">idInPendingOrders</span> <span class="ow">or</span> <span class="n">idInStopOrders</span><span class="p">):</span>
</span><span id="TinkoffBrokerServer.CloseOrders-2587"><a href="#-2587"><span class="linenos">2587</span></a>                    <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Order not found by ID: [</span><span class="si">{}</span><span class="s2">]. Maybe cancelled already? Check it with `--overview` key.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">orderID</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.CloseOrders-2588"><a href="#-2588"><span class="linenos">2588</span></a>                    <span class="k">continue</span>
</span><span id="TinkoffBrokerServer.CloseOrders-2589"><a href="#-2589"><span class="linenos">2589</span></a>
</span><span id="TinkoffBrokerServer.CloseOrders-2590"><a href="#-2590"><span class="linenos">2590</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.CloseOrders-2591"><a href="#-2591"><span class="linenos">2591</span></a>                    <span class="k">if</span> <span class="n">idInPendingOrders</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.CloseOrders-2592"><a href="#-2592"><span class="linenos">2592</span></a>                        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Cancelling pending order with ID: [</span><span class="si">{}</span><span class="s2">]. Wait, please...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">orderID</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.CloseOrders-2593"><a href="#-2593"><span class="linenos">2593</span></a>
</span><span id="TinkoffBrokerServer.CloseOrders-2594"><a href="#-2594"><span class="linenos">2594</span></a>                        <span class="c1"># REST API for request: https://tinkoff.github.io/investAPI/swagger-ui/#/OrdersService/OrdersService_CancelOrder</span>
</span><span id="TinkoffBrokerServer.CloseOrders-2595"><a href="#-2595"><span class="linenos">2595</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="nb">str</span><span class="p">({</span><span class="s2">&quot;accountId&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">accountId</span><span class="p">,</span> <span class="s2">&quot;orderId&quot;</span><span class="p">:</span> <span class="n">orderID</span><span class="p">})</span>
</span><span id="TinkoffBrokerServer.CloseOrders-2596"><a href="#-2596"><span class="linenos">2596</span></a>                        <span class="n">closeURL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;/tinkoff.public.invest.api.contract.v1.OrdersService/CancelOrder&quot;</span>
</span><span id="TinkoffBrokerServer.CloseOrders-2597"><a href="#-2597"><span class="linenos">2597</span></a>                        <span class="n">responseJSON</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SendAPIRequest</span><span class="p">(</span><span class="n">closeURL</span><span class="p">,</span> <span class="n">reqType</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.CloseOrders-2598"><a href="#-2598"><span class="linenos">2598</span></a>
</span><span id="TinkoffBrokerServer.CloseOrders-2599"><a href="#-2599"><span class="linenos">2599</span></a>                        <span class="k">if</span> <span class="n">responseJSON</span> <span class="ow">and</span> <span class="s2">&quot;time&quot;</span> <span class="ow">in</span> <span class="n">responseJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">responseJSON</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.CloseOrders-2600"><a href="#-2600"><span class="linenos">2600</span></a>                            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Success time marker received from server: [</span><span class="si">{}</span><span class="s2">] (UTC)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">responseJSON</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]))</span>
</span><span id="TinkoffBrokerServer.CloseOrders-2601"><a href="#-2601"><span class="linenos">2601</span></a>                            <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Pending order with ID [</span><span class="si">{}</span><span class="s2">] successfully cancel&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">orderID</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.CloseOrders-2602"><a href="#-2602"><span class="linenos">2602</span></a>
</span><span id="TinkoffBrokerServer.CloseOrders-2603"><a href="#-2603"><span class="linenos">2603</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.CloseOrders-2604"><a href="#-2604"><span class="linenos">2604</span></a>                            <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unknown issue occurred when cancelling pending order with ID: [</span><span class="si">{}</span><span class="s2">]. Check ID and try again.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">orderID</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.CloseOrders-2605"><a href="#-2605"><span class="linenos">2605</span></a>
</span><span id="TinkoffBrokerServer.CloseOrders-2606"><a href="#-2606"><span class="linenos">2606</span></a>                    <span class="k">elif</span> <span class="n">idInStopOrders</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.CloseOrders-2607"><a href="#-2607"><span class="linenos">2607</span></a>                        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Cancelling stop order with ID: [</span><span class="si">{}</span><span class="s2">]. Wait, please...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">orderID</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.CloseOrders-2608"><a href="#-2608"><span class="linenos">2608</span></a>
</span><span id="TinkoffBrokerServer.CloseOrders-2609"><a href="#-2609"><span class="linenos">2609</span></a>                        <span class="c1"># REST API for request: https://tinkoff.github.io/investAPI/swagger-ui/#/StopOrdersService/StopOrdersService_CancelStopOrder</span>
</span><span id="TinkoffBrokerServer.CloseOrders-2610"><a href="#-2610"><span class="linenos">2610</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="nb">str</span><span class="p">({</span><span class="s2">&quot;accountId&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">accountId</span><span class="p">,</span> <span class="s2">&quot;stopOrderId&quot;</span><span class="p">:</span> <span class="n">orderID</span><span class="p">})</span>
</span><span id="TinkoffBrokerServer.CloseOrders-2611"><a href="#-2611"><span class="linenos">2611</span></a>                        <span class="n">closeURL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;/tinkoff.public.invest.api.contract.v1.StopOrdersService/CancelStopOrder&quot;</span>
</span><span id="TinkoffBrokerServer.CloseOrders-2612"><a href="#-2612"><span class="linenos">2612</span></a>                        <span class="n">responseJSON</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SendAPIRequest</span><span class="p">(</span><span class="n">closeURL</span><span class="p">,</span> <span class="n">reqType</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.CloseOrders-2613"><a href="#-2613"><span class="linenos">2613</span></a>
</span><span id="TinkoffBrokerServer.CloseOrders-2614"><a href="#-2614"><span class="linenos">2614</span></a>                        <span class="k">if</span> <span class="n">responseJSON</span> <span class="ow">and</span> <span class="s2">&quot;time&quot;</span> <span class="ow">in</span> <span class="n">responseJSON</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">responseJSON</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]:</span>
</span><span id="TinkoffBrokerServer.CloseOrders-2615"><a href="#-2615"><span class="linenos">2615</span></a>                            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Success time marker received from server: [</span><span class="si">{}</span><span class="s2">] (UTC)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">responseJSON</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]))</span>
</span><span id="TinkoffBrokerServer.CloseOrders-2616"><a href="#-2616"><span class="linenos">2616</span></a>                            <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Stop order with ID [</span><span class="si">{}</span><span class="s2">] successfully cancel&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">orderID</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.CloseOrders-2617"><a href="#-2617"><span class="linenos">2617</span></a>
</span><span id="TinkoffBrokerServer.CloseOrders-2618"><a href="#-2618"><span class="linenos">2618</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.CloseOrders-2619"><a href="#-2619"><span class="linenos">2619</span></a>                            <span class="n">uLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unknown issue occurred when cancelling stop order with ID: [</span><span class="si">{}</span><span class="s2">]. Check ID and try again.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">orderID</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.CloseOrders-2620"><a href="#-2620"><span class="linenos">2620</span></a>
</span><span id="TinkoffBrokerServer.CloseOrders-2621"><a href="#-2621"><span class="linenos">2621</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.CloseOrders-2622"><a href="#-2622"><span class="linenos">2622</span></a>                        <span class="k">continue</span>
</span></pre></div>


            <div class="docstring"><p>Cancel order or list of orders by its <code>orderId</code> or <code>stopOrderId</code>.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>orderIDs</strong>:  list of integers with <code>orderId</code> or <code>stopOrderId</code>.</li>
<li><strong>allOrdersIDs</strong>:  pre-received lists of all active pending orders.
                 This avoids unnecessary downloading data from the server.</li>
<li><strong>allStopOrdersIDs</strong>:  pre-received lists of all active stop orders.</li>
</ul>
</div>


                            </div>
                            <div id="TinkoffBrokerServer.CloseAllOrders" class="classattr">
                                        <input id="TinkoffBrokerServer.CloseAllOrders-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">CloseAllOrders</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="TinkoffBrokerServer.CloseAllOrders-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.CloseAllOrders"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TinkoffBrokerServer.CloseAllOrders-2624"><a href="#-2624"><span class="linenos">2624</span></a>    <span class="k">def</span> <span class="nf">CloseAllOrders</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.CloseAllOrders-2625"><a href="#-2625"><span class="linenos">2625</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.CloseAllOrders-2626"><a href="#-2626"><span class="linenos">2626</span></a><span class="sd">        Gets a list of open pending and stop orders and cancel it all.</span>
</span><span id="TinkoffBrokerServer.CloseAllOrders-2627"><a href="#-2627"><span class="linenos">2627</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.CloseAllOrders-2628"><a href="#-2628"><span class="linenos">2628</span></a>        <span class="n">rawOrders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RequestPendingOrders</span><span class="p">()</span>
</span><span id="TinkoffBrokerServer.CloseAllOrders-2629"><a href="#-2629"><span class="linenos">2629</span></a>        <span class="n">allOrdersIDs</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;orderId&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">rawOrders</span><span class="p">]</span>  <span class="c1"># all pending orders ID</span>
</span><span id="TinkoffBrokerServer.CloseAllOrders-2630"><a href="#-2630"><span class="linenos">2630</span></a>        <span class="n">lenOrders</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">allOrdersIDs</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.CloseAllOrders-2631"><a href="#-2631"><span class="linenos">2631</span></a>
</span><span id="TinkoffBrokerServer.CloseAllOrders-2632"><a href="#-2632"><span class="linenos">2632</span></a>        <span class="n">rawStopOrders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RequestStopOrders</span><span class="p">()</span>
</span><span id="TinkoffBrokerServer.CloseAllOrders-2633"><a href="#-2633"><span class="linenos">2633</span></a>        <span class="n">allStopOrdersIDs</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;stopOrderId&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">rawStopOrders</span><span class="p">]</span>  <span class="c1"># all stop orders ID</span>
</span><span id="TinkoffBrokerServer.CloseAllOrders-2634"><a href="#-2634"><span class="linenos">2634</span></a>        <span class="n">lenSOrders</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">allStopOrdersIDs</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.CloseAllOrders-2635"><a href="#-2635"><span class="linenos">2635</span></a>
</span><span id="TinkoffBrokerServer.CloseAllOrders-2636"><a href="#-2636"><span class="linenos">2636</span></a>        <span class="k">if</span> <span class="n">lenOrders</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">lenSOrders</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.CloseAllOrders-2637"><a href="#-2637"><span class="linenos">2637</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Found: [</span><span class="si">{}</span><span class="s2">] opened pending and [</span><span class="si">{}</span><span class="s2">] stop orders. Let&#39;s trying to cancel it all. Wait, please...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lenOrders</span><span class="p">,</span> <span class="n">lenSOrders</span><span class="p">))</span>
</span><span id="TinkoffBrokerServer.CloseAllOrders-2638"><a href="#-2638"><span class="linenos">2638</span></a>
</span><span id="TinkoffBrokerServer.CloseAllOrders-2639"><a href="#-2639"><span class="linenos">2639</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">CloseOrders</span><span class="p">(</span><span class="n">allOrdersIDs</span> <span class="o">+</span> <span class="n">allStopOrdersIDs</span><span class="p">,</span> <span class="n">allOrdersIDs</span><span class="p">,</span> <span class="n">allStopOrdersIDs</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.CloseAllOrders-2640"><a href="#-2640"><span class="linenos">2640</span></a>
</span><span id="TinkoffBrokerServer.CloseAllOrders-2641"><a href="#-2641"><span class="linenos">2641</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.CloseAllOrders-2642"><a href="#-2642"><span class="linenos">2642</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Orders not found, nothing to cancel.&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Gets a list of open pending and stop orders and cancel it all.</p>
</div>


                            </div>
                            <div id="TinkoffBrokerServer.CloseAll" class="classattr">
                                        <input id="TinkoffBrokerServer.CloseAll-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">CloseAll</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="o">*</span><span class="n">args</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="TinkoffBrokerServer.CloseAll-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.CloseAll"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TinkoffBrokerServer.CloseAll-2644"><a href="#-2644"><span class="linenos">2644</span></a>    <span class="k">def</span> <span class="nf">CloseAll</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.CloseAll-2645"><a href="#-2645"><span class="linenos">2645</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.CloseAll-2646"><a href="#-2646"><span class="linenos">2646</span></a><span class="sd">        Close all available (not blocked) opened trades and orders.</span>
</span><span id="TinkoffBrokerServer.CloseAll-2647"><a href="#-2647"><span class="linenos">2647</span></a>
</span><span id="TinkoffBrokerServer.CloseAll-2648"><a href="#-2648"><span class="linenos">2648</span></a><span class="sd">        Also you can select one or more keywords case insensitive:</span>
</span><span id="TinkoffBrokerServer.CloseAll-2649"><a href="#-2649"><span class="linenos">2649</span></a><span class="sd">        `orders`, `shares`, `bonds`, `etfs` and `futures` from `TKS_INSTRUMENTS` enum to specify trades type.</span>
</span><span id="TinkoffBrokerServer.CloseAll-2650"><a href="#-2650"><span class="linenos">2650</span></a>
</span><span id="TinkoffBrokerServer.CloseAll-2651"><a href="#-2651"><span class="linenos">2651</span></a><span class="sd">        Currency positions you must closes manually using buy or sell operations, `CloseTrades()` or `CloseAllTrades()` methods.</span>
</span><span id="TinkoffBrokerServer.CloseAll-2652"><a href="#-2652"><span class="linenos">2652</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.CloseAll-2653"><a href="#-2653"><span class="linenos">2653</span></a>        <span class="n">overview</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Overview</span><span class="p">(</span><span class="n">showStatistics</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># get all open trades info</span>
</span><span id="TinkoffBrokerServer.CloseAll-2654"><a href="#-2654"><span class="linenos">2654</span></a>
</span><span id="TinkoffBrokerServer.CloseAll-2655"><a href="#-2655"><span class="linenos">2655</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.CloseAll-2656"><a href="#-2656"><span class="linenos">2656</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Closing all available (not blocked) opened trades and orders. Currency positions you must closes manually using buy or sell operations! Wait, please...&quot;</span><span class="p">)</span>
</span><span id="TinkoffBrokerServer.CloseAll-2657"><a href="#-2657"><span class="linenos">2657</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">CloseAllOrders</span><span class="p">()</span>  <span class="c1"># close all pending and stop orders</span>
</span><span id="TinkoffBrokerServer.CloseAll-2658"><a href="#-2658"><span class="linenos">2658</span></a>
</span><span id="TinkoffBrokerServer.CloseAll-2659"><a href="#-2659"><span class="linenos">2659</span></a>            <span class="k">for</span> <span class="n">iType</span> <span class="ow">in</span> <span class="n">TKS_INSTRUMENTS</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.CloseAll-2660"><a href="#-2660"><span class="linenos">2660</span></a>                <span class="k">if</span> <span class="n">iType</span> <span class="o">!=</span> <span class="s2">&quot;Currencies&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.CloseAll-2661"><a href="#-2661"><span class="linenos">2661</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">CloseAllTrades</span><span class="p">(</span><span class="n">iType</span><span class="p">,</span> <span class="n">overview</span><span class="p">)</span>  <span class="c1"># close all positions of instruments with same type without currencies</span>
</span><span id="TinkoffBrokerServer.CloseAll-2662"><a href="#-2662"><span class="linenos">2662</span></a>
</span><span id="TinkoffBrokerServer.CloseAll-2663"><a href="#-2663"><span class="linenos">2663</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.CloseAll-2664"><a href="#-2664"><span class="linenos">2664</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Closing all available </span><span class="si">{}</span><span class="s2">. Currency positions you must closes manually using buy or sell operations! Wait, please...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)))</span>
</span><span id="TinkoffBrokerServer.CloseAll-2665"><a href="#-2665"><span class="linenos">2665</span></a>            <span class="n">lowerArgs</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>
</span><span id="TinkoffBrokerServer.CloseAll-2666"><a href="#-2666"><span class="linenos">2666</span></a>
</span><span id="TinkoffBrokerServer.CloseAll-2667"><a href="#-2667"><span class="linenos">2667</span></a>            <span class="k">if</span> <span class="s2">&quot;orders&quot;</span> <span class="ow">in</span> <span class="n">lowerArgs</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.CloseAll-2668"><a href="#-2668"><span class="linenos">2668</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">CloseAllOrders</span><span class="p">()</span>  <span class="c1"># close all pending and stop orders</span>
</span><span id="TinkoffBrokerServer.CloseAll-2669"><a href="#-2669"><span class="linenos">2669</span></a>
</span><span id="TinkoffBrokerServer.CloseAll-2670"><a href="#-2670"><span class="linenos">2670</span></a>            <span class="k">for</span> <span class="n">iType</span> <span class="ow">in</span> <span class="n">TKS_INSTRUMENTS</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.CloseAll-2671"><a href="#-2671"><span class="linenos">2671</span></a>                <span class="k">if</span> <span class="n">iType</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">lowerArgs</span> <span class="ow">and</span> <span class="n">iType</span> <span class="o">!=</span> <span class="s2">&quot;Currencies&quot;</span><span class="p">:</span>
</span><span id="TinkoffBrokerServer.CloseAll-2672"><a href="#-2672"><span class="linenos">2672</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">CloseAllTrades</span><span class="p">(</span><span class="n">iType</span><span class="p">,</span> <span class="n">overview</span><span class="p">)</span>  <span class="c1"># close all positions of instruments with same type without currencies</span>
</span></pre></div>


            <div class="docstring"><p>Close all available (not blocked) opened trades and orders.</p>

<p>Also you can select one or more keywords case insensitive:
<code>orders</code>, <code>shares</code>, <code>bonds</code>, <code>etfs</code> and <code>futures</code> from <code>TKS_INSTRUMENTS</code> enum to specify trades type.</p>

<p>Currency positions you must closes manually using buy or sell operations, <code><a href="#TinkoffBrokerServer.CloseTrades">CloseTrades()</a></code> or <code><a href="#TinkoffBrokerServer.CloseAllTrades">CloseAllTrades()</a></code> methods.</p>
</div>


                            </div>
                            <div id="TinkoffBrokerServer.ParseOrderParameters" class="classattr">
                                        <input id="TinkoffBrokerServer.ParseOrderParameters-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">ParseOrderParameters</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">operation</span>, </span><span class="param"><span class="o">**</span><span class="n">inputParameters</span></span>)</span>

                <label class="view-source-button" for="TinkoffBrokerServer.ParseOrderParameters-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TinkoffBrokerServer.ParseOrderParameters"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TinkoffBrokerServer.ParseOrderParameters-2674"><a href="#-2674"><span class="linenos">2674</span></a>    <span class="nd">@staticmethod</span>
</span><span id="TinkoffBrokerServer.ParseOrderParameters-2675"><a href="#-2675"><span class="linenos">2675</span></a>    <span class="k">def</span> <span class="nf">ParseOrderParameters</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="o">**</span><span class="n">inputParameters</span><span class="p">):</span>
</span><span id="TinkoffBrokerServer.ParseOrderParameters-2676"><a href="#-2676"><span class="linenos">2676</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.ParseOrderParameters-2677"><a href="#-2677"><span class="linenos">2677</span></a><span class="sd">        Parse input dictionary of strings with order parameters and return dictionary with parameters to open all orders.</span>
</span><span id="TinkoffBrokerServer.ParseOrderParameters-2678"><a href="#-2678"><span class="linenos">2678</span></a>
</span><span id="TinkoffBrokerServer.ParseOrderParameters-2679"><a href="#-2679"><span class="linenos">2679</span></a><span class="sd">        :param operation: string &quot;Buy&quot; or &quot;Sell&quot;.</span>
</span><span id="TinkoffBrokerServer.ParseOrderParameters-2680"><a href="#-2680"><span class="linenos">2680</span></a><span class="sd">        :param inputParameters: this is dict of strings that looks like this</span>
</span><span id="TinkoffBrokerServer.ParseOrderParameters-2681"><a href="#-2681"><span class="linenos">2681</span></a><span class="sd">               `{&quot;lots&quot;: &quot;L_int,...&quot;, &quot;prices&quot;: &quot;P_float,...&quot;}` where</span>
</span><span id="TinkoffBrokerServer.ParseOrderParameters-2682"><a href="#-2682"><span class="linenos">2682</span></a><span class="sd">               &quot;lots&quot; key: one or more lot values (integer numbers) to open with every limit-order</span>
</span><span id="TinkoffBrokerServer.ParseOrderParameters-2683"><a href="#-2683"><span class="linenos">2683</span></a><span class="sd">               &quot;prices&quot; key: one or more prices to open limit-orders</span>
</span><span id="TinkoffBrokerServer.ParseOrderParameters-2684"><a href="#-2684"><span class="linenos">2684</span></a><span class="sd">               Counts of values in lots and prices lists must be equals!</span>
</span><span id="TinkoffBrokerServer.ParseOrderParameters-2685"><a href="#-2685"><span class="linenos">2685</span></a><span class="sd">        :return: list of dictionaries with all lots and prices to open orders that looks like this `[{&quot;lot&quot;: lots_1, &quot;price&quot;: price_1}, {...}, ...]`</span>
</span><span id="TinkoffBrokerServer.ParseOrderParameters-2686"><a href="#-2686"><span class="linenos">2686</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TinkoffBrokerServer.ParseOrderParameters-2687"><a href="#-2687"><span class="linenos">2687</span></a>        <span class="c1"># TODO: update order grid work with api v2</span>
</span><span id="TinkoffBrokerServer.ParseOrderParameters-2688"><a href="#-2688"><span class="linenos">2688</span></a>        <span class="k">pass</span>
</span></pre></div>


            <div class="docstring"><p>Parse input dictionary of strings with order parameters and return dictionary with parameters to open all orders.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>operation</strong>:  string "Buy" or "Sell".</li>
<li><strong>inputParameters</strong>:  this is dict of strings that looks like this
   <code>{"lots": "L_int,...", "prices": "P_float,..."}</code> where
   "lots" key: one or more lot values (integer numbers) to open with every limit-order
   "prices" key: one or more prices to open limit-orders
   Counts of values in lots and prices lists must be equals!</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>list of dictionaries with all lots and prices to open orders that looks like this <code>[{"lot": lots_1, "price": price_1}, {...}, ...]</code></p>
</blockquote>
</div>


                            </div>
                </section>
                <section id="Args">
                            <input id="Args-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Args</span>:

                <label class="view-source-button" for="Args-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Args"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Args-2720"><a href="#-2720"><span class="linenos">2720</span></a><span class="k">class</span> <span class="nc">Args</span><span class="p">:</span>
</span><span id="Args-2721"><a href="#-2721"><span class="linenos">2721</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Args-2722"><a href="#-2722"><span class="linenos">2722</span></a><span class="sd">    If `Main()` function is imported as module, then this class used to convert arguments from **kwargs as object.</span>
</span><span id="Args-2723"><a href="#-2723"><span class="linenos">2723</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Args-2724"><a href="#-2724"><span class="linenos">2724</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="Args-2725"><a href="#-2725"><span class="linenos">2725</span></a>        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="Args-2726"><a href="#-2726"><span class="linenos">2726</span></a>
</span><span id="Args-2727"><a href="#-2727"><span class="linenos">2727</span></a>    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
</span><span id="Args-2728"><a href="#-2728"><span class="linenos">2728</span></a>        <span class="k">return</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>If <code><a href="#Main">Main()</a></code> function is imported as module, then this class used to convert arguments from **kwargs as object.</p>
</div>


                            <div id="Args.__init__" class="classattr">
                                        <input id="Args.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Args</span><span class="signature pdoc-code condensed">(<span class="param"><span class="o">**</span><span class="n">kwargs</span></span>)</span>

                <label class="view-source-button" for="Args.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Args.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Args.__init__-2724"><a href="#-2724"><span class="linenos">2724</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="Args.__init__-2725"><a href="#-2725"><span class="linenos">2725</span></a>        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                </section>
                <section id="ParseArgs">
                            <input id="ParseArgs-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">ParseArgs</span><span class="signature pdoc-code condensed">()</span>

                <label class="view-source-button" for="ParseArgs-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ParseArgs"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ParseArgs-2731"><a href="#-2731"><span class="linenos">2731</span></a><span class="k">def</span> <span class="nf">ParseArgs</span><span class="p">():</span>
</span><span id="ParseArgs-2732"><a href="#-2732"><span class="linenos">2732</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="ParseArgs-2733"><a href="#-2733"><span class="linenos">2733</span></a><span class="sd">    Function get and parse command line keys. See examples: https://tim55667757.github.io/TKSBrokerAPI/</span>
</span><span id="ParseArgs-2734"><a href="#-2734"><span class="linenos">2734</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="ParseArgs-2735"><a href="#-2735"><span class="linenos">2735</span></a>    <span class="n">parser</span> <span class="o">=</span> <span class="n">ArgumentParser</span><span class="p">()</span>  <span class="c1"># command-line string parser</span>
</span><span id="ParseArgs-2736"><a href="#-2736"><span class="linenos">2736</span></a>
</span><span id="ParseArgs-2737"><a href="#-2737"><span class="linenos">2737</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;TKSBrokerAPI is a python API to work with some methods of Tinkoff Open API using REST protocol. It can view history, orders and market information. Also, you can open orders and trades. See examples: https://tim55667757.github.io/TKSBrokerAPI/#Usage-examples&quot;</span>
</span><span id="ParseArgs-2738"><a href="#-2738"><span class="linenos">2738</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">usage</span> <span class="o">=</span> <span class="s2">&quot;python TKSBrokerAPI.py [some options] [one command]&quot;</span>
</span><span id="ParseArgs-2739"><a href="#-2739"><span class="linenos">2739</span></a>
</span><span id="ParseArgs-2740"><a href="#-2740"><span class="linenos">2740</span></a>    <span class="c1"># --- options:</span>
</span><span id="ParseArgs-2741"><a href="#-2741"><span class="linenos">2741</span></a>
</span><span id="ParseArgs-2742"><a href="#-2742"><span class="linenos">2742</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--token&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Option: Tinkoff service&#39;s api key. If not set then used environment variable `TKS_API_TOKEN`. See how to use: https://tinkoff.github.io/investAPI/token/&quot;</span><span class="p">)</span>
</span><span id="ParseArgs-2743"><a href="#-2743"><span class="linenos">2743</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--account-id&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Option: string with an user numeric account ID in Tinkoff Broker. It can be found in any broker&#39;s reports (see the contract number). Also, this variable can be set from environment variable `TKS_ACCOUNT_ID`.&quot;</span><span class="p">)</span>
</span><span id="ParseArgs-2744"><a href="#-2744"><span class="linenos">2744</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--ticker&quot;</span><span class="p">,</span> <span class="s2">&quot;-t&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Option: instrument&#39;s ticker, e.g. `IBM`, `YNDX`, `GOOGL` etc. Use alias for `USD000UTSTOM` simple as `USD`, `EUR_RUB__TOM` as `EUR`.&quot;</span><span class="p">)</span>
</span><span id="ParseArgs-2745"><a href="#-2745"><span class="linenos">2745</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--figi&quot;</span><span class="p">,</span> <span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Option: instrument&#39;s FIGI, e.g. `BBG006L8G4H1` (for `YNDX`).&quot;</span><span class="p">)</span>
</span><span id="ParseArgs-2746"><a href="#-2746"><span class="linenos">2746</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--depth&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Option: Depth of Market (DOM) can be &gt;=1, 1 by default.&quot;</span><span class="p">)</span>
</span><span id="ParseArgs-2747"><a href="#-2747"><span class="linenos">2747</span></a>
</span><span id="ParseArgs-2748"><a href="#-2748"><span class="linenos">2748</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--output&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Option: replace default paths to output files for some commands. If None then used default files.&quot;</span><span class="p">)</span>
</span><span id="ParseArgs-2749"><a href="#-2749"><span class="linenos">2749</span></a>
</span><span id="ParseArgs-2750"><a href="#-2750"><span class="linenos">2750</span></a>    <span class="c1"># parser.add_argument(&quot;--length&quot;, type=int, default=24, help=&quot;Option: how many last candles returns for history. Used only with --history key.&quot;)</span>
</span><span id="ParseArgs-2751"><a href="#-2751"><span class="linenos">2751</span></a>    <span class="c1"># parser.add_argument(&quot;--interval&quot;, type=str, default=&quot;60&quot;, help=&quot;Option: available values are 1min, 2min, 3min, 5min, 10min, 15min, 30min, hour, day, week, month. Used only with --history key. This is time period used in &#39;interval&#39; api parameter. Default: --interval=60 that means 60 min for every history candles.&quot;)</span>
</span><span id="ParseArgs-2752"><a href="#-2752"><span class="linenos">2752</span></a>    <span class="c1"># parser.add_argument(&quot;--only-missing&quot;, action=&quot;store_true&quot;, default=False, help=&quot;Option: if history file define by --output key then add only last missing candles, do not request all history length. False by default.&quot;)</span>
</span><span id="ParseArgs-2753"><a href="#-2753"><span class="linenos">2753</span></a>
</span><span id="ParseArgs-2754"><a href="#-2754"><span class="linenos">2754</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--debug-level&quot;</span><span class="p">,</span> <span class="s2">&quot;--verbosity&quot;</span><span class="p">,</span> <span class="s2">&quot;-v&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Option: showing STDOUT messages of minimal debug level, e.g. 10 = DEBUG, 20 = INFO, 30 = WARNING, 40 = ERROR, 50 = CRITICAL. INFO (20) by default.&quot;</span><span class="p">)</span>
</span><span id="ParseArgs-2755"><a href="#-2755"><span class="linenos">2755</span></a>
</span><span id="ParseArgs-2756"><a href="#-2756"><span class="linenos">2756</span></a>    <span class="c1"># --- commands:</span>
</span><span id="ParseArgs-2757"><a href="#-2757"><span class="linenos">2757</span></a>
</span><span id="ParseArgs-2758"><a href="#-2758"><span class="linenos">2758</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--list&quot;</span><span class="p">,</span> <span class="s2">&quot;-l&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Action: get and print all available instruments and some information from broker server. Also, you can define --output key to save list of instruments to file, default: instruments.md.&quot;</span><span class="p">)</span>
</span><span id="ParseArgs-2759"><a href="#-2759"><span class="linenos">2759</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--info&quot;</span><span class="p">,</span> <span class="s2">&quot;-i&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Action: get information from broker server about instrument by it&#39;s ticker or FIGI. `--ticker` key or `--figi` key must be defined!&quot;</span><span class="p">)</span>
</span><span id="ParseArgs-2760"><a href="#-2760"><span class="linenos">2760</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--price&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Action: show actual price list for current instrument. Also, you can use --depth key. `--ticker` key or `--figi` key must be defined!&quot;</span><span class="p">)</span>
</span><span id="ParseArgs-2761"><a href="#-2761"><span class="linenos">2761</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--prices&quot;</span><span class="p">,</span> <span class="s2">&quot;-p&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Action: get and print current prices for list of given instruments (by it&#39;s tickers or by FIGIs. WARNING! This is too long operation if you request a lot of instruments! Also, you can define --output key to save list of prices to file, default: prices.md.&quot;</span><span class="p">)</span>
</span><span id="ParseArgs-2762"><a href="#-2762"><span class="linenos">2762</span></a>
</span><span id="ParseArgs-2763"><a href="#-2763"><span class="linenos">2763</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--overview&quot;</span><span class="p">,</span> <span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Action: show all open positions, orders and some statistics. Also, you can define --output key to save this information to file, default: overview.md.&quot;</span><span class="p">)</span>
</span><span id="ParseArgs-2764"><a href="#-2764"><span class="linenos">2764</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--deals&quot;</span><span class="p">,</span> <span class="s2">&quot;-d&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Action: show all deals between two given dates. Start day may be an integer number: -1, -2, -3 days ago. Also, you can use keywords: `today`, `yesterday` (-1), `week` (-7), `month` (-30), `year` (-365). Dates format must be: `</span><span class="si">%%</span><span class="s2">Y-</span><span class="si">%%</span><span class="s2">m-</span><span class="si">%%</span><span class="s2">d`, e.g. 2020-02-03. Also, you can define `--output` key to save all deals to file, default: report.md.&quot;</span><span class="p">)</span>
</span><span id="ParseArgs-2765"><a href="#-2765"><span class="linenos">2765</span></a>    <span class="c1"># parser.add_argument(&quot;--history&quot;, action=&quot;store_true&quot;, help=&quot;Action: get last (--length) history candles from past to current time with (--interval) values. Also, you can define --output key to save history candles to .csv-file.&quot;)</span>
</span><span id="ParseArgs-2766"><a href="#-2766"><span class="linenos">2766</span></a>
</span><span id="ParseArgs-2767"><a href="#-2767"><span class="linenos">2767</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--trade&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Action: universal action to open market position for defined ticker or FIGI. You must specify 1-5 parameters: [direction `Buy` or `Sell`] [lots, &gt;= 1] [take profit, &gt;= 0] [stop loss, &gt;= 0] [expiration date for TP/SL orders, Undefined|`</span><span class="si">%%</span><span class="s2">Y-</span><span class="si">%%</span><span class="s2">m-</span><span class="si">%%</span><span class="s2">d </span><span class="si">%%</span><span class="s2">H:</span><span class="si">%%</span><span class="s2">M:</span><span class="si">%%</span><span class="s2">S`]. See examples in readme.&quot;</span><span class="p">)</span>
</span><span id="ParseArgs-2768"><a href="#-2768"><span class="linenos">2768</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--buy&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Action: immediately open BUY market position at the current price for defined ticker or FIGI. You must specify 0-4 parameters: [lots, &gt;= 1] [take profit, &gt;= 0] [stop loss, &gt;= 0] [expiration date for TP/SL orders, Undefined|`</span><span class="si">%%</span><span class="s2">Y-</span><span class="si">%%</span><span class="s2">m-</span><span class="si">%%</span><span class="s2">d </span><span class="si">%%</span><span class="s2">H:</span><span class="si">%%</span><span class="s2">M:</span><span class="si">%%</span><span class="s2">S`].&quot;</span><span class="p">)</span>
</span><span id="ParseArgs-2769"><a href="#-2769"><span class="linenos">2769</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--sell&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Action: immediately open SELL market position at the current price for defined ticker or FIGI. You must specify 0-4 parameters: [lots, &gt;= 1] [take profit, &gt;= 0] [stop loss, &gt;= 0] [expiration date for TP/SL orders, Undefined|`</span><span class="si">%%</span><span class="s2">Y-</span><span class="si">%%</span><span class="s2">m-</span><span class="si">%%</span><span class="s2">d </span><span class="si">%%</span><span class="s2">H:</span><span class="si">%%</span><span class="s2">M:</span><span class="si">%%</span><span class="s2">S`].&quot;</span><span class="p">)</span>
</span><span id="ParseArgs-2770"><a href="#-2770"><span class="linenos">2770</span></a>
</span><span id="ParseArgs-2771"><a href="#-2771"><span class="linenos">2771</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--order&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Action: universal action to open limit or stop-order in any directions. You must specify 4-7 parameters: [direction `Buy` or `Sell`] [order type `Limit` or `Stop`] [lots] [target price] [maybe for stop-order: [limit price, &gt;= 0] [stop type, Limit|SL|TP] [expiration date, Undefined|`</span><span class="si">%%</span><span class="s2">Y-</span><span class="si">%%</span><span class="s2">m-</span><span class="si">%%</span><span class="s2">d </span><span class="si">%%</span><span class="s2">H:</span><span class="si">%%</span><span class="s2">M:</span><span class="si">%%</span><span class="s2">S`]]. See examples in readme.&quot;</span><span class="p">)</span>
</span><span id="ParseArgs-2772"><a href="#-2772"><span class="linenos">2772</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--buy-limit&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Action: open pending BUY limit-order (below current price). You must specify only 2 parameters: [lots] [target price] to open BUY limit-order. If you try to create `Buy` limit-order above current price then broker immediately open `Buy` market order, such as if you do simple `--buy` operation!&quot;</span><span class="p">)</span>
</span><span id="ParseArgs-2773"><a href="#-2773"><span class="linenos">2773</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--sell-limit&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Action: open pending SELL limit-order (above current price). You must specify only 2 parameters: [lots] [target price] to open SELL limit-order. If you try to create `Sell` limit-order below current price then broker immediately open `Sell` market order, such as if you do simple `--sell` operation!&quot;</span><span class="p">)</span>
</span><span id="ParseArgs-2774"><a href="#-2774"><span class="linenos">2774</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--buy-stop&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Action: open BUY stop-order. You must specify at least 2 parameters: [lots] [target price] to open BUY stop-order. In additional you can specify 3 parameters for stop-order: [limit price, &gt;= 0] [stop type, Limit|SL|TP] [expiration date, Undefined|`</span><span class="si">%%</span><span class="s2">Y-</span><span class="si">%%</span><span class="s2">m-</span><span class="si">%%</span><span class="s2">d </span><span class="si">%%</span><span class="s2">H:</span><span class="si">%%</span><span class="s2">M:</span><span class="si">%%</span><span class="s2">S`]. When current price will go up or down to target price value then broker opens a limit order. Stop loss order always executed by market price.&quot;</span><span class="p">)</span>
</span><span id="ParseArgs-2775"><a href="#-2775"><span class="linenos">2775</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--sell-stop&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Action: open SELL stop-order. You must specify at least 2 parameters: [lots] [target price] to open SELL stop-order. In additional you can specify 3 parameters for stop-order: [limit price, &gt;= 0] [stop type, Limit|SL|TP] [expiration date, Undefined|`</span><span class="si">%%</span><span class="s2">Y-</span><span class="si">%%</span><span class="s2">m-</span><span class="si">%%</span><span class="s2">d </span><span class="si">%%</span><span class="s2">H:</span><span class="si">%%</span><span class="s2">M:</span><span class="si">%%</span><span class="s2">S`]. When current price will go up or down to target price value then broker opens a limit order. Stop loss order always executed by market price.&quot;</span><span class="p">)</span>
</span><span id="ParseArgs-2776"><a href="#-2776"><span class="linenos">2776</span></a>    <span class="c1"># parser.add_argument(&quot;--buy-limit-order-grid&quot;, type=str, nargs=&quot;*&quot;, help=&quot;Action: open grid of pending BUY limit-orders (below current price). Parameters format: l(ots)=[L_int,...] p(rices)=[P_float,...]. Counts of values in lots and prices lists must be equals!&quot;)</span>
</span><span id="ParseArgs-2777"><a href="#-2777"><span class="linenos">2777</span></a>    <span class="c1"># parser.add_argument(&quot;--sell-limit-order-grid&quot;, type=str, nargs=&quot;*&quot;, help=&quot;Action: open grid of pending SELL limit-orders (above current price). Parameters format: l(ots)=[L_int,...] p(rices)=[P_float,...]. Counts of values in lots and prices lists must be equals!&quot;)</span>
</span><span id="ParseArgs-2778"><a href="#-2778"><span class="linenos">2778</span></a>
</span><span id="ParseArgs-2779"><a href="#-2779"><span class="linenos">2779</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--close-order&quot;</span><span class="p">,</span> <span class="s2">&quot;--cancel-order&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Action: close only one order by it&#39;s `orderId` or `stopOrderId`. You can find out the meaning of these IDs using the key `--overview`&quot;</span><span class="p">)</span>
</span><span id="ParseArgs-2780"><a href="#-2780"><span class="linenos">2780</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--close-orders&quot;</span><span class="p">,</span> <span class="s2">&quot;--cancel-orders&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Action: close one or list of orders by it&#39;s `orderId` or `stopOrderId`. You can find out the meaning of these IDs using the key `--overview`&quot;</span><span class="p">)</span>
</span><span id="ParseArgs-2781"><a href="#-2781"><span class="linenos">2781</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--close-trade&quot;</span><span class="p">,</span> <span class="s2">&quot;--cancel-trade&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Action: close only one position for instrument defined by `--ticker` key, including for currencies tickers.&quot;</span><span class="p">)</span>
</span><span id="ParseArgs-2782"><a href="#-2782"><span class="linenos">2782</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--close-trades&quot;</span><span class="p">,</span> <span class="s2">&quot;--cancel-trades&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Action: close positions for list of tickers, including for currencies tickers.&quot;</span><span class="p">)</span>
</span><span id="ParseArgs-2783"><a href="#-2783"><span class="linenos">2783</span></a>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--close-all&quot;</span><span class="p">,</span> <span class="s2">&quot;--cancel-all&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Action: close all available (not blocked) opened trades and orders, excluding for currencies. Also you can select one or more keywords case insensitive to specify trades type: `orders`, `shares`, `bonds`, `etfs` and `futures`, but not `currencies`. Currency positions you must closes manually using `--buy`, `--sell`, `--close-trade` or `--close-trades` operations.&quot;</span><span class="p">)</span>
</span><span id="ParseArgs-2784"><a href="#-2784"><span class="linenos">2784</span></a>
</span><span id="ParseArgs-2785"><a href="#-2785"><span class="linenos">2785</span></a>    <span class="n">cmdArgs</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</span><span id="ParseArgs-2786"><a href="#-2786"><span class="linenos">2786</span></a>    <span class="k">return</span> <span class="n">cmdArgs</span>
</span></pre></div>


            <div class="docstring"><p>Function get and parse command line keys. See examples: <a href="https://tim55667757.github.io/TKSBrokerAPI/">https://tim55667757.github.io/TKSBrokerAPI/</a></p>
</div>


                </section>
                <section id="Main">
                            <input id="Main-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">Main</span><span class="signature pdoc-code condensed">(<span class="param"><span class="o">**</span><span class="n">kwargs</span></span>)</span>

                <label class="view-source-button" for="Main-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Main"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Main-2789"><a href="#-2789"><span class="linenos">2789</span></a><span class="k">def</span> <span class="nf">Main</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="Main-2790"><a href="#-2790"><span class="linenos">2790</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Main-2791"><a href="#-2791"><span class="linenos">2791</span></a><span class="sd">    Main function for work with Tinkoff Open API service. It realize simple logic: get a lot of options and execute one command.</span>
</span><span id="Main-2792"><a href="#-2792"><span class="linenos">2792</span></a>
</span><span id="Main-2793"><a href="#-2793"><span class="linenos">2793</span></a><span class="sd">    See examples: https://tim55667757.github.io/TKSBrokerAPI/</span>
</span><span id="Main-2794"><a href="#-2794"><span class="linenos">2794</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Main-2795"><a href="#-2795"><span class="linenos">2795</span></a>    <span class="n">args</span> <span class="o">=</span> <span class="n">Args</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">if</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="n">ParseArgs</span><span class="p">()</span>  <span class="c1"># get and parse command-line parameters or use **kwarg parameters</span>
</span><span id="Main-2796"><a href="#-2796"><span class="linenos">2796</span></a>
</span><span id="Main-2797"><a href="#-2797"><span class="linenos">2797</span></a>    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">debug_level</span><span class="p">:</span>
</span><span id="Main-2798"><a href="#-2798"><span class="linenos">2798</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># always debug level by default</span>
</span><span id="Main-2799"><a href="#-2799"><span class="linenos">2799</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">handlers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">debug_level</span>  <span class="c1"># level for STDOUT</span>
</span><span id="Main-2800"><a href="#-2800"><span class="linenos">2800</span></a>
</span><span id="Main-2801"><a href="#-2801"><span class="linenos">2801</span></a>    <span class="n">exitCode</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Main-2802"><a href="#-2802"><span class="linenos">2802</span></a>    <span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tzutc</span><span class="p">())</span>
</span><span id="Main-2803"><a href="#-2803"><span class="linenos">2803</span></a>    <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TKSBrokerAPI module started at: [</span><span class="si">{}</span><span class="s2">] (UTC), it is [</span><span class="si">{}</span><span class="s2">] local time&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="Main-2804"><a href="#-2804"><span class="linenos">2804</span></a>        <span class="n">start</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">),</span>
</span><span id="Main-2805"><a href="#-2805"><span class="linenos">2805</span></a>        <span class="n">start</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">tzlocal</span><span class="p">())</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">),</span>
</span><span id="Main-2806"><a href="#-2806"><span class="linenos">2806</span></a>    <span class="p">))</span>
</span><span id="Main-2807"><a href="#-2807"><span class="linenos">2807</span></a>
</span><span id="Main-2808"><a href="#-2808"><span class="linenos">2808</span></a>    <span class="n">instruments</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;instruments&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="kc">None</span>  <span class="c1"># try to decrease requests to server count if class init many times</span>
</span><span id="Main-2809"><a href="#-2809"><span class="linenos">2809</span></a>    <span class="n">server</span> <span class="o">=</span> <span class="n">TinkoffBrokerServer</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="n">iList</span><span class="o">=</span><span class="n">instruments</span><span class="p">)</span>  <span class="c1"># Init class for trading with Tinkoff Broker</span>
</span><span id="Main-2810"><a href="#-2810"><span class="linenos">2810</span></a>
</span><span id="Main-2811"><a href="#-2811"><span class="linenos">2811</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="Main-2812"><a href="#-2812"><span class="linenos">2812</span></a>        <span class="c1"># --- set some options:</span>
</span><span id="Main-2813"><a href="#-2813"><span class="linenos">2813</span></a>
</span><span id="Main-2814"><a href="#-2814"><span class="linenos">2814</span></a>        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">account_id</span><span class="p">:</span>
</span><span id="Main-2815"><a href="#-2815"><span class="linenos">2815</span></a>            <span class="n">server</span><span class="o">.</span><span class="n">accountId</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">account_id</span>
</span><span id="Main-2816"><a href="#-2816"><span class="linenos">2816</span></a>
</span><span id="Main-2817"><a href="#-2817"><span class="linenos">2817</span></a>        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">ticker</span><span class="p">:</span>
</span><span id="Main-2818"><a href="#-2818"><span class="linenos">2818</span></a>            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">ticker</span> <span class="ow">in</span> <span class="n">server</span><span class="o">.</span><span class="n">aliasesKeys</span><span class="p">:</span>
</span><span id="Main-2819"><a href="#-2819"><span class="linenos">2819</span></a>                <span class="n">server</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">aliases</span><span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">ticker</span><span class="p">]</span>  <span class="c1"># Replace some tickers with it&#39;s aliases</span>
</span><span id="Main-2820"><a href="#-2820"><span class="linenos">2820</span></a>
</span><span id="Main-2821"><a href="#-2821"><span class="linenos">2821</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Main-2822"><a href="#-2822"><span class="linenos">2822</span></a>                <span class="n">server</span><span class="o">.</span><span class="n">ticker</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">ticker</span>
</span><span id="Main-2823"><a href="#-2823"><span class="linenos">2823</span></a>
</span><span id="Main-2824"><a href="#-2824"><span class="linenos">2824</span></a>        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">figi</span><span class="p">:</span>
</span><span id="Main-2825"><a href="#-2825"><span class="linenos">2825</span></a>            <span class="n">server</span><span class="o">.</span><span class="n">figi</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">figi</span>
</span><span id="Main-2826"><a href="#-2826"><span class="linenos">2826</span></a>
</span><span id="Main-2827"><a href="#-2827"><span class="linenos">2827</span></a>        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">depth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Main-2828"><a href="#-2828"><span class="linenos">2828</span></a>            <span class="n">server</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">depth</span>
</span><span id="Main-2829"><a href="#-2829"><span class="linenos">2829</span></a>
</span><span id="Main-2830"><a href="#-2830"><span class="linenos">2830</span></a>        <span class="c1"># if args.length is not None:</span>
</span><span id="Main-2831"><a href="#-2831"><span class="linenos">2831</span></a>        <span class="c1">#     server.historyLength = args.length</span>
</span><span id="Main-2832"><a href="#-2832"><span class="linenos">2832</span></a>        <span class="c1">#</span>
</span><span id="Main-2833"><a href="#-2833"><span class="linenos">2833</span></a>        <span class="c1"># if args.interval is not None:</span>
</span><span id="Main-2834"><a href="#-2834"><span class="linenos">2834</span></a>        <span class="c1">#     server.historyInterval = args.interval</span>
</span><span id="Main-2835"><a href="#-2835"><span class="linenos">2835</span></a>
</span><span id="Main-2836"><a href="#-2836"><span class="linenos">2836</span></a>        <span class="c1"># --- do one of commands:</span>
</span><span id="Main-2837"><a href="#-2837"><span class="linenos">2837</span></a>
</span><span id="Main-2838"><a href="#-2838"><span class="linenos">2838</span></a>        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">info</span><span class="p">:</span>
</span><span id="Main-2839"><a href="#-2839"><span class="linenos">2839</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">ticker</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">figi</span><span class="p">):</span>
</span><span id="Main-2840"><a href="#-2840"><span class="linenos">2840</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;`--ticker` key or `--figi` key is required for this operation!&quot;</span><span class="p">)</span>
</span><span id="Main-2841"><a href="#-2841"><span class="linenos">2841</span></a>
</span><span id="Main-2842"><a href="#-2842"><span class="linenos">2842</span></a>            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">ticker</span><span class="p">:</span>
</span><span id="Main-2843"><a href="#-2843"><span class="linenos">2843</span></a>                <span class="n">server</span><span class="o">.</span><span class="n">SearchByTicker</span><span class="p">(</span><span class="n">requestPrice</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">showInfo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># show info and current prices by ticker name</span>
</span><span id="Main-2844"><a href="#-2844"><span class="linenos">2844</span></a>
</span><span id="Main-2845"><a href="#-2845"><span class="linenos">2845</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Main-2846"><a href="#-2846"><span class="linenos">2846</span></a>                <span class="n">server</span><span class="o">.</span><span class="n">SearchByFIGI</span><span class="p">(</span><span class="n">requestPrice</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">showInfo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># show info and current prices by FIGI id</span>
</span><span id="Main-2847"><a href="#-2847"><span class="linenos">2847</span></a>
</span><span id="Main-2848"><a href="#-2848"><span class="linenos">2848</span></a>        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">list</span><span class="p">:</span>
</span><span id="Main-2849"><a href="#-2849"><span class="linenos">2849</span></a>            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Main-2850"><a href="#-2850"><span class="linenos">2850</span></a>                <span class="n">server</span><span class="o">.</span><span class="n">instrumentsFile</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">output</span>
</span><span id="Main-2851"><a href="#-2851"><span class="linenos">2851</span></a>
</span><span id="Main-2852"><a href="#-2852"><span class="linenos">2852</span></a>            <span class="n">server</span><span class="o">.</span><span class="n">ShowInstrumentsInfo</span><span class="p">(</span><span class="n">showInstruments</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Main-2853"><a href="#-2853"><span class="linenos">2853</span></a>
</span><span id="Main-2854"><a href="#-2854"><span class="linenos">2854</span></a>        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">price</span><span class="p">:</span>
</span><span id="Main-2855"><a href="#-2855"><span class="linenos">2855</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">ticker</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">figi</span><span class="p">):</span>
</span><span id="Main-2856"><a href="#-2856"><span class="linenos">2856</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;`--ticker` key or `--figi` key is required for this operation!&quot;</span><span class="p">)</span>
</span><span id="Main-2857"><a href="#-2857"><span class="linenos">2857</span></a>
</span><span id="Main-2858"><a href="#-2858"><span class="linenos">2858</span></a>            <span class="n">server</span><span class="o">.</span><span class="n">GetCurrentPrices</span><span class="p">(</span><span class="n">showPrice</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Main-2859"><a href="#-2859"><span class="linenos">2859</span></a>
</span><span id="Main-2860"><a href="#-2860"><span class="linenos">2860</span></a>        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">prices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Main-2861"><a href="#-2861"><span class="linenos">2861</span></a>            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Main-2862"><a href="#-2862"><span class="linenos">2862</span></a>                <span class="n">server</span><span class="o">.</span><span class="n">pricesFile</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">output</span>
</span><span id="Main-2863"><a href="#-2863"><span class="linenos">2863</span></a>
</span><span id="Main-2864"><a href="#-2864"><span class="linenos">2864</span></a>            <span class="n">server</span><span class="o">.</span><span class="n">GetListOfPrices</span><span class="p">(</span><span class="n">instruments</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">prices</span><span class="p">,</span> <span class="n">showPrices</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># WARNING: too long wait for a lot of instruments prices</span>
</span><span id="Main-2865"><a href="#-2865"><span class="linenos">2865</span></a>
</span><span id="Main-2866"><a href="#-2866"><span class="linenos">2866</span></a>        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">overview</span><span class="p">:</span>
</span><span id="Main-2867"><a href="#-2867"><span class="linenos">2867</span></a>            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Main-2868"><a href="#-2868"><span class="linenos">2868</span></a>                <span class="n">server</span><span class="o">.</span><span class="n">overviewFile</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">output</span>
</span><span id="Main-2869"><a href="#-2869"><span class="linenos">2869</span></a>
</span><span id="Main-2870"><a href="#-2870"><span class="linenos">2870</span></a>            <span class="n">server</span><span class="o">.</span><span class="n">Overview</span><span class="p">(</span><span class="n">showStatistics</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Main-2871"><a href="#-2871"><span class="linenos">2871</span></a>
</span><span id="Main-2872"><a href="#-2872"><span class="linenos">2872</span></a>        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">deals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Main-2873"><a href="#-2873"><span class="linenos">2873</span></a>            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Main-2874"><a href="#-2874"><span class="linenos">2874</span></a>                <span class="n">server</span><span class="o">.</span><span class="n">reportFile</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">output</span>
</span><span id="Main-2875"><a href="#-2875"><span class="linenos">2875</span></a>
</span><span id="Main-2876"><a href="#-2876"><span class="linenos">2876</span></a>            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">deals</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="Main-2877"><a href="#-2877"><span class="linenos">2877</span></a>                <span class="n">server</span><span class="o">.</span><span class="n">Deals</span><span class="p">(</span>
</span><span id="Main-2878"><a href="#-2878"><span class="linenos">2878</span></a>                    <span class="n">start</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">deals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">deals</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Main-2879"><a href="#-2879"><span class="linenos">2879</span></a>                    <span class="n">end</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">deals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">deals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Main-2880"><a href="#-2880"><span class="linenos">2880</span></a>                    <span class="n">printDeals</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Main-2881"><a href="#-2881"><span class="linenos">2881</span></a>                <span class="p">)</span>
</span><span id="Main-2882"><a href="#-2882"><span class="linenos">2882</span></a>
</span><span id="Main-2883"><a href="#-2883"><span class="linenos">2883</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Main-2884"><a href="#-2884"><span class="linenos">2884</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;You must specify 0-2 parameters: [DATE_START] [DATE_END]&quot;</span><span class="p">)</span>
</span><span id="Main-2885"><a href="#-2885"><span class="linenos">2885</span></a>
</span><span id="Main-2886"><a href="#-2886"><span class="linenos">2886</span></a>        <span class="c1"># TODO: implement history download and view</span>
</span><span id="Main-2887"><a href="#-2887"><span class="linenos">2887</span></a>        <span class="c1"># elif args.history:</span>
</span><span id="Main-2888"><a href="#-2888"><span class="linenos">2888</span></a>        <span class="c1">#     if args.output is not None:</span>
</span><span id="Main-2889"><a href="#-2889"><span class="linenos">2889</span></a>        <span class="c1">#         server.historyFile = args.output</span>
</span><span id="Main-2890"><a href="#-2890"><span class="linenos">2890</span></a>        <span class="c1">#</span>
</span><span id="Main-2891"><a href="#-2891"><span class="linenos">2891</span></a>        <span class="c1">#     server.History(onlyMissing=args.only_missing)</span>
</span><span id="Main-2892"><a href="#-2892"><span class="linenos">2892</span></a>
</span><span id="Main-2893"><a href="#-2893"><span class="linenos">2893</span></a>        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">trade</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Main-2894"><a href="#-2894"><span class="linenos">2894</span></a>            <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">trade</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="Main-2895"><a href="#-2895"><span class="linenos">2895</span></a>                <span class="n">server</span><span class="o">.</span><span class="n">Trade</span><span class="p">(</span>
</span><span id="Main-2896"><a href="#-2896"><span class="linenos">2896</span></a>                    <span class="n">operation</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">trade</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="Main-2897"><a href="#-2897"><span class="linenos">2897</span></a>                    <span class="n">lots</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">trade</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">trade</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="Main-2898"><a href="#-2898"><span class="linenos">2898</span></a>                    <span class="n">tp</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">trade</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">trade</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="k">else</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="Main-2899"><a href="#-2899"><span class="linenos">2899</span></a>                    <span class="n">sl</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">trade</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">trade</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="k">else</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="Main-2900"><a href="#-2900"><span class="linenos">2900</span></a>                    <span class="n">expDate</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">trade</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">trade</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span> <span class="k">else</span> <span class="s2">&quot;Undefined&quot;</span><span class="p">,</span>
</span><span id="Main-2901"><a href="#-2901"><span class="linenos">2901</span></a>                <span class="p">)</span>
</span><span id="Main-2902"><a href="#-2902"><span class="linenos">2902</span></a>
</span><span id="Main-2903"><a href="#-2903"><span class="linenos">2903</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Main-2904"><a href="#-2904"><span class="linenos">2904</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;You must specify 1-5 parameters to open trade: [direction `Buy` or `Sell`] [lots, &gt;= 1] [take profit, &gt;= 0] [stop loss, &gt;= 0] [expiration date for TP/SL orders, Undefined|`%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S`]. See: `python TKSBrokerAPI.py --help`&quot;</span><span class="p">)</span>
</span><span id="Main-2905"><a href="#-2905"><span class="linenos">2905</span></a>
</span><span id="Main-2906"><a href="#-2906"><span class="linenos">2906</span></a>        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">buy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Main-2907"><a href="#-2907"><span class="linenos">2907</span></a>            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">buy</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="Main-2908"><a href="#-2908"><span class="linenos">2908</span></a>                <span class="n">server</span><span class="o">.</span><span class="n">Buy</span><span class="p">(</span>
</span><span id="Main-2909"><a href="#-2909"><span class="linenos">2909</span></a>                    <span class="n">lots</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">buy</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">buy</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="Main-2910"><a href="#-2910"><span class="linenos">2910</span></a>                    <span class="n">tp</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">buy</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">buy</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="k">else</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="Main-2911"><a href="#-2911"><span class="linenos">2911</span></a>                    <span class="n">sl</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">buy</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">buy</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="k">else</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="Main-2912"><a href="#-2912"><span class="linenos">2912</span></a>                    <span class="n">expDate</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">buy</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">buy</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span> <span class="k">else</span> <span class="s2">&quot;Undefined&quot;</span><span class="p">,</span>
</span><span id="Main-2913"><a href="#-2913"><span class="linenos">2913</span></a>                <span class="p">)</span>
</span><span id="Main-2914"><a href="#-2914"><span class="linenos">2914</span></a>
</span><span id="Main-2915"><a href="#-2915"><span class="linenos">2915</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Main-2916"><a href="#-2916"><span class="linenos">2916</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;You must specify 0-4 parameters to open buy position: [lots, &gt;= 1] [take profit, &gt;= 0] [stop loss, &gt;= 0] [expiration date for TP/SL orders, Undefined|`%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S`]. See: `python TKSBrokerAPI.py --help`&quot;</span><span class="p">)</span>
</span><span id="Main-2917"><a href="#-2917"><span class="linenos">2917</span></a>
</span><span id="Main-2918"><a href="#-2918"><span class="linenos">2918</span></a>        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">sell</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Main-2919"><a href="#-2919"><span class="linenos">2919</span></a>            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sell</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="Main-2920"><a href="#-2920"><span class="linenos">2920</span></a>                <span class="n">server</span><span class="o">.</span><span class="n">Sell</span><span class="p">(</span>
</span><span id="Main-2921"><a href="#-2921"><span class="linenos">2921</span></a>                    <span class="n">lots</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sell</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sell</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="Main-2922"><a href="#-2922"><span class="linenos">2922</span></a>                    <span class="n">tp</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sell</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sell</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="k">else</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="Main-2923"><a href="#-2923"><span class="linenos">2923</span></a>                    <span class="n">sl</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sell</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sell</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="k">else</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="Main-2924"><a href="#-2924"><span class="linenos">2924</span></a>                    <span class="n">expDate</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">sell</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sell</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span> <span class="k">else</span> <span class="s2">&quot;Undefined&quot;</span><span class="p">,</span>
</span><span id="Main-2925"><a href="#-2925"><span class="linenos">2925</span></a>                <span class="p">)</span>
</span><span id="Main-2926"><a href="#-2926"><span class="linenos">2926</span></a>
</span><span id="Main-2927"><a href="#-2927"><span class="linenos">2927</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Main-2928"><a href="#-2928"><span class="linenos">2928</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;You must specify 0-4 parameters to open sell position: [lots, &gt;= 1] [take profit, &gt;= 0] [stop loss, &gt;= 0] [expiration date for TP/SL orders, Undefined|`%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S`]. See: `python TKSBrokerAPI.py --help`&quot;</span><span class="p">)</span>
</span><span id="Main-2929"><a href="#-2929"><span class="linenos">2929</span></a>
</span><span id="Main-2930"><a href="#-2930"><span class="linenos">2930</span></a>        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">order</span><span class="p">:</span>
</span><span id="Main-2931"><a href="#-2931"><span class="linenos">2931</span></a>            <span class="k">if</span> <span class="mi">4</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">order</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">:</span>
</span><span id="Main-2932"><a href="#-2932"><span class="linenos">2932</span></a>                <span class="n">server</span><span class="o">.</span><span class="n">Order</span><span class="p">(</span>
</span><span id="Main-2933"><a href="#-2933"><span class="linenos">2933</span></a>                    <span class="n">operation</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">order</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="Main-2934"><a href="#-2934"><span class="linenos">2934</span></a>                    <span class="n">orderType</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">order</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="Main-2935"><a href="#-2935"><span class="linenos">2935</span></a>                    <span class="n">lots</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">order</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
</span><span id="Main-2936"><a href="#-2936"><span class="linenos">2936</span></a>                    <span class="n">targetPrice</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">order</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
</span><span id="Main-2937"><a href="#-2937"><span class="linenos">2937</span></a>                    <span class="n">limitPrice</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">order</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">order</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">5</span> <span class="k">else</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="Main-2938"><a href="#-2938"><span class="linenos">2938</span></a>                    <span class="n">stopType</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">order</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">order</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">6</span> <span class="k">else</span> <span class="s2">&quot;Limit&quot;</span><span class="p">,</span>
</span><span id="Main-2939"><a href="#-2939"><span class="linenos">2939</span></a>                    <span class="n">expDate</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">order</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">order</span><span class="p">)</span> <span class="o">==</span> <span class="mi">7</span> <span class="k">else</span> <span class="s2">&quot;Undefined&quot;</span><span class="p">,</span>
</span><span id="Main-2940"><a href="#-2940"><span class="linenos">2940</span></a>                <span class="p">)</span>
</span><span id="Main-2941"><a href="#-2941"><span class="linenos">2941</span></a>
</span><span id="Main-2942"><a href="#-2942"><span class="linenos">2942</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Main-2943"><a href="#-2943"><span class="linenos">2943</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;You must specify 4-7 parameters to open order: [direction `Buy` or `Sell`] [order type `Limit` or `Stop`] [lots] [target price] [maybe for stop-order: [limit price, &gt;= 0] [stop type, Limit|SL|TP] [expiration date, Undefined|`%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S`]]. See: `python TKSBrokerAPI.py --help`&quot;</span><span class="p">)</span>
</span><span id="Main-2944"><a href="#-2944"><span class="linenos">2944</span></a>
</span><span id="Main-2945"><a href="#-2945"><span class="linenos">2945</span></a>        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">buy_limit</span><span class="p">:</span>
</span><span id="Main-2946"><a href="#-2946"><span class="linenos">2946</span></a>            <span class="n">server</span><span class="o">.</span><span class="n">BuyLimit</span><span class="p">(</span><span class="n">lots</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">buy_limit</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">targetPrice</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">buy_limit</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Main-2947"><a href="#-2947"><span class="linenos">2947</span></a>
</span><span id="Main-2948"><a href="#-2948"><span class="linenos">2948</span></a>        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">sell_limit</span><span class="p">:</span>
</span><span id="Main-2949"><a href="#-2949"><span class="linenos">2949</span></a>            <span class="n">server</span><span class="o">.</span><span class="n">SellLimit</span><span class="p">(</span><span class="n">lots</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sell_limit</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">targetPrice</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">sell_limit</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Main-2950"><a href="#-2950"><span class="linenos">2950</span></a>
</span><span id="Main-2951"><a href="#-2951"><span class="linenos">2951</span></a>        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">buy_stop</span><span class="p">:</span>
</span><span id="Main-2952"><a href="#-2952"><span class="linenos">2952</span></a>            <span class="k">if</span> <span class="mi">2</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">buy_stop</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">:</span>
</span><span id="Main-2953"><a href="#-2953"><span class="linenos">2953</span></a>                <span class="n">server</span><span class="o">.</span><span class="n">BuyStop</span><span class="p">(</span>
</span><span id="Main-2954"><a href="#-2954"><span class="linenos">2954</span></a>                    <span class="n">lots</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">buy_stop</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="Main-2955"><a href="#-2955"><span class="linenos">2955</span></a>                    <span class="n">targetPrice</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">buy_stop</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="Main-2956"><a href="#-2956"><span class="linenos">2956</span></a>                    <span class="n">limitPrice</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">buy_stop</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">buy_stop</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="k">else</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="Main-2957"><a href="#-2957"><span class="linenos">2957</span></a>                    <span class="n">stopType</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">buy_stop</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">buy_stop</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="k">else</span> <span class="s2">&quot;Limit&quot;</span><span class="p">,</span>
</span><span id="Main-2958"><a href="#-2958"><span class="linenos">2958</span></a>                    <span class="n">expDate</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">buy_stop</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">buy_stop</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span> <span class="k">else</span> <span class="s2">&quot;Undefined&quot;</span><span class="p">,</span>
</span><span id="Main-2959"><a href="#-2959"><span class="linenos">2959</span></a>                <span class="p">)</span>
</span><span id="Main-2960"><a href="#-2960"><span class="linenos">2960</span></a>
</span><span id="Main-2961"><a href="#-2961"><span class="linenos">2961</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Main-2962"><a href="#-2962"><span class="linenos">2962</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;You must specify 2-5 parameters for buy stop-order: [lots] [target price] [limit price, &gt;= 0] [stop type, Limit|SL|TP] [expiration date, Undefined|`%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S`]. See: `python TKSBrokerAPI.py --help`&quot;</span><span class="p">)</span>
</span><span id="Main-2963"><a href="#-2963"><span class="linenos">2963</span></a>
</span><span id="Main-2964"><a href="#-2964"><span class="linenos">2964</span></a>        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">sell_stop</span><span class="p">:</span>
</span><span id="Main-2965"><a href="#-2965"><span class="linenos">2965</span></a>            <span class="k">if</span> <span class="mi">2</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sell_stop</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">:</span>
</span><span id="Main-2966"><a href="#-2966"><span class="linenos">2966</span></a>                <span class="n">server</span><span class="o">.</span><span class="n">SellStop</span><span class="p">(</span>
</span><span id="Main-2967"><a href="#-2967"><span class="linenos">2967</span></a>                    <span class="n">lots</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sell_stop</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="Main-2968"><a href="#-2968"><span class="linenos">2968</span></a>                    <span class="n">targetPrice</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sell_stop</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="Main-2969"><a href="#-2969"><span class="linenos">2969</span></a>                    <span class="n">limitPrice</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sell_stop</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sell_stop</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="k">else</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="Main-2970"><a href="#-2970"><span class="linenos">2970</span></a>                    <span class="n">stopType</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">sell_stop</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sell_stop</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="k">else</span> <span class="s2">&quot;Limit&quot;</span><span class="p">,</span>
</span><span id="Main-2971"><a href="#-2971"><span class="linenos">2971</span></a>                    <span class="n">expDate</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">sell_stop</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sell_stop</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span> <span class="k">else</span> <span class="s2">&quot;Undefined&quot;</span><span class="p">,</span>
</span><span id="Main-2972"><a href="#-2972"><span class="linenos">2972</span></a>                <span class="p">)</span>
</span><span id="Main-2973"><a href="#-2973"><span class="linenos">2973</span></a>
</span><span id="Main-2974"><a href="#-2974"><span class="linenos">2974</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Main-2975"><a href="#-2975"><span class="linenos">2975</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;You must specify 2-5 parameters for sell stop-order: [lots] [target price] [limit price, &gt;= 0] [stop type, Limit|SL|TP] [expiration date, Undefined|`%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S`]. See: python TKSBrokerAPI.py --help&quot;</span><span class="p">)</span>
</span><span id="Main-2976"><a href="#-2976"><span class="linenos">2976</span></a>
</span><span id="Main-2977"><a href="#-2977"><span class="linenos">2977</span></a>        <span class="c1"># elif args.buy_order_grid is not None:</span>
</span><span id="Main-2978"><a href="#-2978"><span class="linenos">2978</span></a>        <span class="c1">#     # TODO: update order grid work with api v2</span>
</span><span id="Main-2979"><a href="#-2979"><span class="linenos">2979</span></a>        <span class="c1">#     if len(args.buy_order_grid) == 2:</span>
</span><span id="Main-2980"><a href="#-2980"><span class="linenos">2980</span></a>        <span class="c1">#         orderParams = server.ParseOrderParameters(operation=&quot;Buy&quot;, **dict(kw.split(&#39;=&#39;) for kw in args.buy_order_grid))</span>
</span><span id="Main-2981"><a href="#-2981"><span class="linenos">2981</span></a>        <span class="c1">#</span>
</span><span id="Main-2982"><a href="#-2982"><span class="linenos">2982</span></a>        <span class="c1">#         for order in orderParams:</span>
</span><span id="Main-2983"><a href="#-2983"><span class="linenos">2983</span></a>        <span class="c1">#             server.Order(operation=&quot;Buy&quot;, lots=order[&quot;lot&quot;], price=order[&quot;price&quot;])</span>
</span><span id="Main-2984"><a href="#-2984"><span class="linenos">2984</span></a>        <span class="c1">#</span>
</span><span id="Main-2985"><a href="#-2985"><span class="linenos">2985</span></a>        <span class="c1">#     else:</span>
</span><span id="Main-2986"><a href="#-2986"><span class="linenos">2986</span></a>        <span class="c1">#         uLogger.error(&quot;To open grid of pending BUY limit-orders (below current price) you must specified 2 parameters: l(ots)=[L_int,...] p(rices)=[P_float,...]. See: `python TKSBrokerAPI.py --help`&quot;)</span>
</span><span id="Main-2987"><a href="#-2987"><span class="linenos">2987</span></a>        <span class="c1">#</span>
</span><span id="Main-2988"><a href="#-2988"><span class="linenos">2988</span></a>        <span class="c1"># elif args.sell_order_grid is not None:</span>
</span><span id="Main-2989"><a href="#-2989"><span class="linenos">2989</span></a>        <span class="c1">#     # TODO: update order grid work with api v2</span>
</span><span id="Main-2990"><a href="#-2990"><span class="linenos">2990</span></a>        <span class="c1">#     if len(args.sell_order_grid) &gt;= 2:</span>
</span><span id="Main-2991"><a href="#-2991"><span class="linenos">2991</span></a>        <span class="c1">#         orderParams = server.ParseOrderParameters(operation=&quot;Sell&quot;, **dict(kw.split(&#39;=&#39;) for kw in args.sell_order_grid))</span>
</span><span id="Main-2992"><a href="#-2992"><span class="linenos">2992</span></a>        <span class="c1">#</span>
</span><span id="Main-2993"><a href="#-2993"><span class="linenos">2993</span></a>        <span class="c1">#         for order in orderParams:</span>
</span><span id="Main-2994"><a href="#-2994"><span class="linenos">2994</span></a>        <span class="c1">#             server.Order(operation=&quot;Sell&quot;, lots=order[&quot;lot&quot;], price=order[&quot;price&quot;])</span>
</span><span id="Main-2995"><a href="#-2995"><span class="linenos">2995</span></a>        <span class="c1">#</span>
</span><span id="Main-2996"><a href="#-2996"><span class="linenos">2996</span></a>        <span class="c1">#     else:</span>
</span><span id="Main-2997"><a href="#-2997"><span class="linenos">2997</span></a>        <span class="c1">#         uLogger.error(&quot;To open grid of pending SELL limit-orders (above current price) you must specified 2 parameters: l(ots)=[L_int,...] p(rices)=[P_float,...]. See: `python TKSBrokerAPI.py --help`&quot;)</span>
</span><span id="Main-2998"><a href="#-2998"><span class="linenos">2998</span></a>
</span><span id="Main-2999"><a href="#-2999"><span class="linenos">2999</span></a>        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">close_order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Main-3000"><a href="#-3000"><span class="linenos">3000</span></a>            <span class="n">server</span><span class="o">.</span><span class="n">CloseOrders</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">close_order</span><span class="p">)</span>  <span class="c1"># close only one order</span>
</span><span id="Main-3001"><a href="#-3001"><span class="linenos">3001</span></a>
</span><span id="Main-3002"><a href="#-3002"><span class="linenos">3002</span></a>        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">close_orders</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Main-3003"><a href="#-3003"><span class="linenos">3003</span></a>            <span class="n">server</span><span class="o">.</span><span class="n">CloseOrders</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">close_orders</span><span class="p">)</span>  <span class="c1"># close list of orders</span>
</span><span id="Main-3004"><a href="#-3004"><span class="linenos">3004</span></a>
</span><span id="Main-3005"><a href="#-3005"><span class="linenos">3005</span></a>        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">close_trade</span><span class="p">:</span>
</span><span id="Main-3006"><a href="#-3006"><span class="linenos">3006</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">ticker</span><span class="p">:</span>
</span><span id="Main-3007"><a href="#-3007"><span class="linenos">3007</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;`--ticker` key is required for this operation!&quot;</span><span class="p">)</span>
</span><span id="Main-3008"><a href="#-3008"><span class="linenos">3008</span></a>
</span><span id="Main-3009"><a href="#-3009"><span class="linenos">3009</span></a>            <span class="n">server</span><span class="o">.</span><span class="n">CloseTrades</span><span class="p">([</span><span class="n">args</span><span class="o">.</span><span class="n">ticker</span><span class="p">])</span>  <span class="c1"># close only one trade</span>
</span><span id="Main-3010"><a href="#-3010"><span class="linenos">3010</span></a>
</span><span id="Main-3011"><a href="#-3011"><span class="linenos">3011</span></a>        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">close_trades</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Main-3012"><a href="#-3012"><span class="linenos">3012</span></a>            <span class="n">server</span><span class="o">.</span><span class="n">CloseTrades</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">close_trades</span><span class="p">)</span>  <span class="c1"># close trades for list of tickers</span>
</span><span id="Main-3013"><a href="#-3013"><span class="linenos">3013</span></a>
</span><span id="Main-3014"><a href="#-3014"><span class="linenos">3014</span></a>        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">close_all</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Main-3015"><a href="#-3015"><span class="linenos">3015</span></a>            <span class="n">server</span><span class="o">.</span><span class="n">CloseAll</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="o">.</span><span class="n">close_all</span><span class="p">)</span>
</span><span id="Main-3016"><a href="#-3016"><span class="linenos">3016</span></a>
</span><span id="Main-3017"><a href="#-3017"><span class="linenos">3017</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Main-3018"><a href="#-3018"><span class="linenos">3018</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;There is no command to execute! One of the possible commands must be selected. See: `python TKSBrokerAPI.py --help`&quot;</span><span class="p">)</span>
</span><span id="Main-3019"><a href="#-3019"><span class="linenos">3019</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;There is no command to execute!&quot;</span><span class="p">)</span>
</span><span id="Main-3020"><a href="#-3020"><span class="linenos">3020</span></a>
</span><span id="Main-3021"><a href="#-3021"><span class="linenos">3021</span></a>    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="Main-3022"><a href="#-3022"><span class="linenos">3022</span></a>        <span class="n">exc</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Main-3023"><a href="#-3023"><span class="linenos">3023</span></a>
</span><span id="Main-3024"><a href="#-3024"><span class="linenos">3024</span></a>        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">exc</span><span class="p">:</span>
</span><span id="Main-3025"><a href="#-3025"><span class="linenos">3025</span></a>            <span class="k">if</span> <span class="n">line</span><span class="p">:</span>
</span><span id="Main-3026"><a href="#-3026"><span class="linenos">3026</span></a>                <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span id="Main-3027"><a href="#-3027"><span class="linenos">3027</span></a>
</span><span id="Main-3028"><a href="#-3028"><span class="linenos">3028</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Unknown error occurred, open a ticket for this issue, please! https://github.com/Tim55667757/TKSBrokerAPI/issues&quot;</span><span class="p">)</span>
</span><span id="Main-3029"><a href="#-3029"><span class="linenos">3029</span></a>        <span class="n">exitCode</span> <span class="o">=</span> <span class="mi">255</span>  <span class="c1"># unknown error occurred, must be open a ticket for this issue</span>
</span><span id="Main-3030"><a href="#-3030"><span class="linenos">3030</span></a>
</span><span id="Main-3031"><a href="#-3031"><span class="linenos">3031</span></a>    <span class="k">finally</span><span class="p">:</span>
</span><span id="Main-3032"><a href="#-3032"><span class="linenos">3032</span></a>        <span class="n">finish</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tzutc</span><span class="p">())</span>
</span><span id="Main-3033"><a href="#-3033"><span class="linenos">3033</span></a>
</span><span id="Main-3034"><a href="#-3034"><span class="linenos">3034</span></a>        <span class="k">if</span> <span class="n">exitCode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Main-3035"><a href="#-3035"><span class="linenos">3035</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;All operations with Tinkoff Server using Open API are finished success (summary code is 0).&quot;</span><span class="p">)</span>
</span><span id="Main-3036"><a href="#-3036"><span class="linenos">3036</span></a>
</span><span id="Main-3037"><a href="#-3037"><span class="linenos">3037</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Main-3038"><a href="#-3038"><span class="linenos">3038</span></a>            <span class="n">uLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;TKSBrokerAPI module returns an error! See full debug log with key in run command `--debug-level 10`. Summary code: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exitCode</span><span class="p">))</span>
</span><span id="Main-3039"><a href="#-3039"><span class="linenos">3039</span></a>
</span><span id="Main-3040"><a href="#-3040"><span class="linenos">3040</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TKSBrokerAPI module work duration: [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">finish</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
</span><span id="Main-3041"><a href="#-3041"><span class="linenos">3041</span></a>        <span class="n">uLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TKSBrokerAPI module finished: [</span><span class="si">{}</span><span class="s2">] (UTC), it is [</span><span class="si">{}</span><span class="s2">] local time&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="Main-3042"><a href="#-3042"><span class="linenos">3042</span></a>            <span class="n">finish</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">),</span>
</span><span id="Main-3043"><a href="#-3043"><span class="linenos">3043</span></a>            <span class="n">finish</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">tzlocal</span><span class="p">())</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">),</span>
</span><span id="Main-3044"><a href="#-3044"><span class="linenos">3044</span></a>        <span class="p">))</span>
</span><span id="Main-3045"><a href="#-3045"><span class="linenos">3045</span></a>
</span><span id="Main-3046"><a href="#-3046"><span class="linenos">3046</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">:</span>
</span><span id="Main-3047"><a href="#-3047"><span class="linenos">3047</span></a>            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">exitCode</span><span class="p">)</span>
</span><span id="Main-3048"><a href="#-3048"><span class="linenos">3048</span></a>
</span><span id="Main-3049"><a href="#-3049"><span class="linenos">3049</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Main-3050"><a href="#-3050"><span class="linenos">3050</span></a>            <span class="k">return</span> <span class="n">exitCode</span>
</span></pre></div>


            <div class="docstring"><p>Main function for work with Tinkoff Open API service. It realize simple logic: get a lot of options and execute one command.</p>

<p>See examples: <a href="https://tim55667757.github.io/TKSBrokerAPI/">https://tim55667757.github.io/TKSBrokerAPI/</a></p>
</div>


                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.type) {
                    case "function":
                        heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span><span class="signature">${doc.signature}:</span>`;
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value">${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.type}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>